---
ID: "a7c18272-823d-4404-a81b-c13887877b2c"
Parent: "a3bcd026-175e-4bb0-97ea-101533dd6443"
Template: "962b53c4-f93b-4df9-9821-415c867b8903"
Path: "/sitecore/media library/Themes/AFL-Global/AFL-Oceania/AFL-Oceania/Scripts/1-1-script"
SharedFields:
- ID: "06d5295c-ed2f-4a54-9bf2-26228d113318"
  Hint: __Icon
  Value: "-/media/6C7065213A0A4380A40D996EC5D3F95B.ashx?h=16&thn=1&w=16"
- ID: "40e50ed9-ba07-4702-992e-a912738d32dc"
  Hint: Blob
  BlobID: "e91df950-4a4f-4a8d-af7e-74969a91b19a"
  Value: LyohDQogKiBqUXVlcnkgSmF2YVNjcmlwdCBMaWJyYXJ5IHYzLjYuMA0KICogaHR0cHM6Ly9qcXVlcnkuY29tLw0KICoNCiAqIEluY2x1ZGVzIFNpenpsZS5qcw0KICogaHR0cHM6Ly9zaXp6bGVqcy5jb20vDQogKg0KICogQ29weXJpZ2h0IE9wZW5KUyBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMNCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZQ0KICogaHR0cHM6Ly9qcXVlcnkub3JnL2xpY2Vuc2UNCiAqDQogKiBEYXRlOiAyMDIxLTAzLTAyVDE3OjA4Wg0KICovDQooIGZ1bmN0aW9uKCBnbG9iYWwsIGZhY3RvcnkgKSB7DQoNCgkidXNlIHN0cmljdCI7DQoNCglpZiAoIHR5cGVvZiBtb2R1bGUgPT09ICJvYmplY3QiICYmIHR5cGVvZiBtb2R1bGUuZXhwb3J0cyA9PT0gIm9iamVjdCIgKSB7DQoNCgkJLy8gRm9yIENvbW1vbkpTIGFuZCBDb21tb25KUy1saWtlIGVudmlyb25tZW50cyB3aGVyZSBhIHByb3BlciBgd2luZG93YA0KCQkvLyBpcyBwcmVzZW50LCBleGVjdXRlIHRoZSBmYWN0b3J5IGFuZCBnZXQgalF1ZXJ5Lg0KCQkvLyBGb3IgZW52aXJvbm1lbnRzIHRoYXQgZG8gbm90IGhhdmUgYSBgd2luZG93YCB3aXRoIGEgYGRvY3VtZW50YA0KCQkvLyAoc3VjaCBhcyBOb2RlLmpzKSwgZXhwb3NlIGEgZmFjdG9yeSBhcyBtb2R1bGUuZXhwb3J0cy4NCgkJLy8gVGhpcyBhY2NlbnR1YXRlcyB0aGUgbmVlZCBmb3IgdGhlIGNyZWF0aW9uIG9mIGEgcmVhbCBgd2luZG93YC4NCgkJLy8gZS5nLiB2YXIgalF1ZXJ5ID0gcmVxdWlyZSgianF1ZXJ5Iikod2luZG93KTsNCgkJLy8gU2VlIHRpY2tldCAjMTQ1NDkgZm9yIG1vcmUgaW5mby4NCgkJbW9kdWxlLmV4cG9ydHMgPSBnbG9iYWwuZG9jdW1lbnQgPw0KCQkJZmFjdG9yeSggZ2xvYmFsLCB0cnVlICkgOg0KCQkJZnVuY3Rpb24oIHcgKSB7DQoJCQkJaWYgKCAhdy5kb2N1bWVudCApIHsNCgkJCQkJdGhyb3cgbmV3IEVycm9yKCAialF1ZXJ5IHJlcXVpcmVzIGEgd2luZG93IHdpdGggYSBkb2N1bWVudCIgKTsNCgkJCQl9DQoJCQkJcmV0dXJuIGZhY3RvcnkoIHcgKTsNCgkJCX07DQoJfSBlbHNlIHsNCgkJZmFjdG9yeSggZ2xvYmFsICk7DQoJfQ0KDQovLyBQYXNzIHRoaXMgaWYgd2luZG93IGlzIG5vdCBkZWZpbmVkIHlldA0KfSApKCB0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiA/IHdpbmRvdyA6IHRoaXMsIGZ1bmN0aW9uKCB3aW5kb3csIG5vR2xvYmFsICkgew0KDQovLyBFZGdlIDw9IDEyIC0gMTMrLCBGaXJlZm94IDw9MTggLSA0NSssIElFIDEwIC0gMTEsIFNhZmFyaSA1LjEgLSA5KywgaU9TIDYgLSA5LjENCi8vIHRocm93IGV4Y2VwdGlvbnMgd2hlbiBub24tc3RyaWN0IGNvZGUgKGUuZy4sIEFTUC5ORVQgNC41KSBhY2Nlc3NlcyBzdHJpY3QgbW9kZQ0KLy8gYXJndW1lbnRzLmNhbGxlZS5jYWxsZXIgKHRyYWMtMTMzMzUpLiBCdXQgYXMgb2YgalF1ZXJ5IDMuMCAoMjAxNiksIHN0cmljdCBtb2RlIHNob3VsZCBiZSBjb21tb24NCi8vIGVub3VnaCB0aGF0IGFsbCBzdWNoIGF0dGVtcHRzIGFyZSBndWFyZGVkIGluIGEgdHJ5IGJsb2NrLg0KInVzZSBzdHJpY3QiOw0KDQp2YXIgYXJyID0gW107DQoNCnZhciBnZXRQcm90byA9IE9iamVjdC5nZXRQcm90b3R5cGVPZjsNCg0KdmFyIHNsaWNlID0gYXJyLnNsaWNlOw0KDQp2YXIgZmxhdCA9IGFyci5mbGF0ID8gZnVuY3Rpb24oIGFycmF5ICkgew0KCXJldHVybiBhcnIuZmxhdC5jYWxsKCBhcnJheSApOw0KfSA6IGZ1bmN0aW9uKCBhcnJheSApIHsNCglyZXR1cm4gYXJyLmNvbmNhdC5hcHBseSggW10sIGFycmF5ICk7DQp9Ow0KDQoNCnZhciBwdXNoID0gYXJyLnB1c2g7DQoNCnZhciBpbmRleE9mID0gYXJyLmluZGV4T2Y7DQoNCnZhciBjbGFzczJ0eXBlID0ge307DQoNCnZhciB0b1N0cmluZyA9IGNsYXNzMnR5cGUudG9TdHJpbmc7DQoNCnZhciBoYXNPd24gPSBjbGFzczJ0eXBlLmhhc093blByb3BlcnR5Ow0KDQp2YXIgZm5Ub1N0cmluZyA9IGhhc093bi50b1N0cmluZzsNCg0KdmFyIE9iamVjdEZ1bmN0aW9uU3RyaW5nID0gZm5Ub1N0cmluZy5jYWxsKCBPYmplY3QgKTsNCg0KdmFyIHN1cHBvcnQgPSB7fTsNCg0KdmFyIGlzRnVuY3Rpb24gPSBmdW5jdGlvbiBpc0Z1bmN0aW9uKCBvYmogKSB7DQoNCgkJLy8gU3VwcG9ydDogQ2hyb21lIDw9NTcsIEZpcmVmb3ggPD01Mg0KCQkvLyBJbiBzb21lIGJyb3dzZXJzLCB0eXBlb2YgcmV0dXJucyAiZnVuY3Rpb24iIGZvciBIVE1MIDxvYmplY3Q+IGVsZW1lbnRzDQoJCS8vIChpLmUuLCBgdHlwZW9mIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJvYmplY3QiICkgPT09ICJmdW5jdGlvbiJgKS4NCgkJLy8gV2UgZG9uJ3Qgd2FudCB0byBjbGFzc2lmeSAqYW55KiBET00gbm9kZSBhcyBhIGZ1bmN0aW9uLg0KCQkvLyBTdXBwb3J0OiBRdFdlYiA8PTMuOC41LCBXZWJLaXQgPD01MzQuMzQsIHdraHRtbHRvcGRmIHRvb2wgPD0wLjEyLjUNCgkJLy8gUGx1cyBmb3Igb2xkIFdlYktpdCwgdHlwZW9mIHJldHVybnMgImZ1bmN0aW9uIiBmb3IgSFRNTCBjb2xsZWN0aW9ucw0KCQkvLyAoZS5nLiwgYHR5cGVvZiBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgiZGl2IikgPT09ICJmdW5jdGlvbiJgKS4gKGdoLTQ3NTYpDQoJCXJldHVybiB0eXBlb2Ygb2JqID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBvYmoubm9kZVR5cGUgIT09ICJudW1iZXIiICYmDQoJCQl0eXBlb2Ygb2JqLml0ZW0gIT09ICJmdW5jdGlvbiI7DQoJfTsNCg0KDQp2YXIgaXNXaW5kb3cgPSBmdW5jdGlvbiBpc1dpbmRvdyggb2JqICkgew0KCQlyZXR1cm4gb2JqICE9IG51bGwgJiYgb2JqID09PSBvYmoud2luZG93Ow0KCX07DQoNCg0KdmFyIGRvY3VtZW50ID0gd2luZG93LmRvY3VtZW50Ow0KDQoNCg0KCXZhciBwcmVzZXJ2ZWRTY3JpcHRBdHRyaWJ1dGVzID0gew0KCQl0eXBlOiB0cnVlLA0KCQlzcmM6IHRydWUsDQoJCW5vbmNlOiB0cnVlLA0KCQlub01vZHVsZTogdHJ1ZQ0KCX07DQoNCglmdW5jdGlvbiBET01FdmFsKCBjb2RlLCBub2RlLCBkb2MgKSB7DQoJCWRvYyA9IGRvYyB8fCBkb2N1bWVudDsNCg0KCQl2YXIgaSwgdmFsLA0KCQkJc2NyaXB0ID0gZG9jLmNyZWF0ZUVsZW1lbnQoICJzY3JpcHQiICk7DQoNCgkJc2NyaXB0LnRleHQgPSBjb2RlOw0KCQlpZiAoIG5vZGUgKSB7DQoJCQlmb3IgKCBpIGluIHByZXNlcnZlZFNjcmlwdEF0dHJpYnV0ZXMgKSB7DQoNCgkJCQkvLyBTdXBwb3J0OiBGaXJlZm94IDY0KywgRWRnZSAxOCsNCgkJCQkvLyBTb21lIGJyb3dzZXJzIGRvbid0IHN1cHBvcnQgdGhlICJub25jZSIgcHJvcGVydHkgb24gc2NyaXB0cy4NCgkJCQkvLyBPbiB0aGUgb3RoZXIgaGFuZCwganVzdCB1c2luZyBgZ2V0QXR0cmlidXRlYCBpcyBub3QgZW5vdWdoIGFzDQoJCQkJLy8gdGhlIGBub25jZWAgYXR0cmlidXRlIGlzIHJlc2V0IHRvIGFuIGVtcHR5IHN0cmluZyB3aGVuZXZlciBpdA0KCQkJCS8vIGJlY29tZXMgYnJvd3NpbmctY29udGV4dCBjb25uZWN0ZWQuDQoJCQkJLy8gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS93aGF0d2cvaHRtbC9pc3N1ZXMvMjM2OQ0KCQkJCS8vIFNlZSBodHRwczovL2h0bWwuc3BlYy53aGF0d2cub3JnLyNub25jZS1hdHRyaWJ1dGVzDQoJCQkJLy8gVGhlIGBub2RlLmdldEF0dHJpYnV0ZWAgY2hlY2sgd2FzIGFkZGVkIGZvciB0aGUgc2FrZSBvZg0KCQkJCS8vIGBqUXVlcnkuZ2xvYmFsRXZhbGAgc28gdGhhdCBpdCBjYW4gZmFrZSBhIG5vbmNlLWNvbnRhaW5pbmcgbm9kZQ0KCQkJCS8vIHZpYSBhbiBvYmplY3QuDQoJCQkJdmFsID0gbm9kZVsgaSBdIHx8IG5vZGUuZ2V0QXR0cmlidXRlICYmIG5vZGUuZ2V0QXR0cmlidXRlKCBpICk7DQoJCQkJaWYgKCB2YWwgKSB7DQoJCQkJCXNjcmlwdC5zZXRBdHRyaWJ1dGUoIGksIHZhbCApOw0KCQkJCX0NCgkJCX0NCgkJfQ0KCQlkb2MuaGVhZC5hcHBlbmRDaGlsZCggc2NyaXB0ICkucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCggc2NyaXB0ICk7DQoJfQ0KDQoNCmZ1bmN0aW9uIHRvVHlwZSggb2JqICkgew0KCWlmICggb2JqID09IG51bGwgKSB7DQoJCXJldHVybiBvYmogKyAiIjsNCgl9DQoNCgkvLyBTdXBwb3J0OiBBbmRyb2lkIDw9Mi4zIG9ubHkgKGZ1bmN0aW9uaXNoIFJlZ0V4cCkNCglyZXR1cm4gdHlwZW9mIG9iaiA9PT0gIm9iamVjdCIgfHwgdHlwZW9mIG9iaiA9PT0gImZ1bmN0aW9uIiA/DQoJCWNsYXNzMnR5cGVbIHRvU3RyaW5nLmNhbGwoIG9iaiApIF0gfHwgIm9iamVjdCIgOg0KCQl0eXBlb2Ygb2JqOw0KfQ0KLyogZ2xvYmFsIFN5bWJvbCAqLw0KLy8gRGVmaW5pbmcgdGhpcyBnbG9iYWwgaW4gLmVzbGludHJjLmpzb24gd291bGQgY3JlYXRlIGEgZGFuZ2VyIG9mIHVzaW5nIHRoZSBnbG9iYWwNCi8vIHVuZ3VhcmRlZCBpbiBhbm90aGVyIHBsYWNlLCBpdCBzZWVtcyBzYWZlciB0byBkZWZpbmUgZ2xvYmFsIG9ubHkgZm9yIHRoaXMgbW9kdWxlDQoNCg0KDQp2YXINCgl2ZXJzaW9uID0gIjMuNi4wIiwNCg0KCS8vIERlZmluZSBhIGxvY2FsIGNvcHkgb2YgalF1ZXJ5DQoJalF1ZXJ5ID0gZnVuY3Rpb24oIHNlbGVjdG9yLCBjb250ZXh0ICkgew0KDQoJCS8vIFRoZSBqUXVlcnkgb2JqZWN0IGlzIGFjdHVhbGx5IGp1c3QgdGhlIGluaXQgY29uc3RydWN0b3IgJ2VuaGFuY2VkJw0KCQkvLyBOZWVkIGluaXQgaWYgalF1ZXJ5IGlzIGNhbGxlZCAoanVzdCBhbGxvdyBlcnJvciB0byBiZSB0aHJvd24gaWYgbm90IGluY2x1ZGVkKQ0KCQlyZXR1cm4gbmV3IGpRdWVyeS5mbi5pbml0KCBzZWxlY3RvciwgY29udGV4dCApOw0KCX07DQoNCmpRdWVyeS5mbiA9IGpRdWVyeS5wcm90b3R5cGUgPSB7DQoNCgkvLyBUaGUgY3VycmVudCB2ZXJzaW9uIG9mIGpRdWVyeSBiZWluZyB1c2VkDQoJanF1ZXJ5OiB2ZXJzaW9uLA0KDQoJY29uc3RydWN0b3I6IGpRdWVyeSwNCg0KCS8vIFRoZSBkZWZhdWx0IGxlbmd0aCBvZiBhIGpRdWVyeSBvYmplY3QgaXMgMA0KCWxlbmd0aDogMCwNCg0KCXRvQXJyYXk6IGZ1bmN0aW9uKCkgew0KCQlyZXR1cm4gc2xpY2UuY2FsbCggdGhpcyApOw0KCX0sDQoNCgkvLyBHZXQgdGhlIE50aCBlbGVtZW50IGluIHRoZSBtYXRjaGVkIGVsZW1lbnQgc2V0IE9SDQoJLy8gR2V0IHRoZSB3aG9sZSBtYXRjaGVkIGVsZW1lbnQgc2V0IGFzIGEgY2xlYW4gYXJyYXkNCglnZXQ6IGZ1bmN0aW9uKCBudW0gKSB7DQoNCgkJLy8gUmV0dXJuIGFsbCB0aGUgZWxlbWVudHMgaW4gYSBjbGVhbiBhcnJheQ0KCQlpZiAoIG51bSA9PSBudWxsICkgew0KCQkJcmV0dXJuIHNsaWNlLmNhbGwoIHRoaXMgKTsNCgkJfQ0KDQoJCS8vIFJldHVybiBqdXN0IHRoZSBvbmUgZWxlbWVudCBmcm9tIHRoZSBzZXQNCgkJcmV0dXJuIG51bSA8IDAgPyB0aGlzWyBudW0gKyB0aGlzLmxlbmd0aCBdIDogdGhpc1sgbnVtIF07DQoJfSwNCg0KCS8vIFRha2UgYW4gYXJyYXkgb2YgZWxlbWVudHMgYW5kIHB1c2ggaXQgb250byB0aGUgc3RhY2sNCgkvLyAocmV0dXJuaW5nIHRoZSBuZXcgbWF0Y2hlZCBlbGVtZW50IHNldCkNCglwdXNoU3RhY2s6IGZ1bmN0aW9uKCBlbGVtcyApIHsNCg0KCQkvLyBCdWlsZCBhIG5ldyBqUXVlcnkgbWF0Y2hlZCBlbGVtZW50IHNldA0KCQl2YXIgcmV0ID0galF1ZXJ5Lm1lcmdlKCB0aGlzLmNvbnN0cnVjdG9yKCksIGVsZW1zICk7DQoNCgkJLy8gQWRkIHRoZSBvbGQgb2JqZWN0IG9udG8gdGhlIHN0YWNrIChhcyBhIHJlZmVyZW5jZSkNCgkJcmV0LnByZXZPYmplY3QgPSB0aGlzOw0KDQoJCS8vIFJldHVybiB0aGUgbmV3bHktZm9ybWVkIGVsZW1lbnQgc2V0DQoJCXJldHVybiByZXQ7DQoJfSwNCg0KCS8vIEV4ZWN1dGUgYSBjYWxsYmFjayBmb3IgZXZlcnkgZWxlbWVudCBpbiB0aGUgbWF0Y2hlZCBzZXQuDQoJZWFjaDogZnVuY3Rpb24oIGNhbGxiYWNrICkgew0KCQlyZXR1cm4galF1ZXJ5LmVhY2goIHRoaXMsIGNhbGxiYWNrICk7DQoJfSwNCg0KCW1hcDogZnVuY3Rpb24oIGNhbGxiYWNrICkgew0KCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIGpRdWVyeS5tYXAoIHRoaXMsIGZ1bmN0aW9uKCBlbGVtLCBpICkgew0KCQkJcmV0dXJuIGNhbGxiYWNrLmNhbGwoIGVsZW0sIGksIGVsZW0gKTsNCgkJfSApICk7DQoJfSwNCg0KCXNsaWNlOiBmdW5jdGlvbigpIHsNCgkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCBzbGljZS5hcHBseSggdGhpcywgYXJndW1lbnRzICkgKTsNCgl9LA0KDQoJZmlyc3Q6IGZ1bmN0aW9uKCkgew0KCQlyZXR1cm4gdGhpcy5lcSggMCApOw0KCX0sDQoNCglsYXN0OiBmdW5jdGlvbigpIHsNCgkJcmV0dXJuIHRoaXMuZXEoIC0xICk7DQoJfSwNCg0KCWV2ZW46IGZ1bmN0aW9uKCkgew0KCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIGpRdWVyeS5ncmVwKCB0aGlzLCBmdW5jdGlvbiggX2VsZW0sIGkgKSB7DQoJCQlyZXR1cm4gKCBpICsgMSApICUgMjsNCgkJfSApICk7DQoJfSwNCg0KCW9kZDogZnVuY3Rpb24oKSB7DQoJCXJldHVybiB0aGlzLnB1c2hTdGFjayggalF1ZXJ5LmdyZXAoIHRoaXMsIGZ1bmN0aW9uKCBfZWxlbSwgaSApIHsNCgkJCXJldHVybiBpICUgMjsNCgkJfSApICk7DQoJfSwNCg0KCWVxOiBmdW5jdGlvbiggaSApIHsNCgkJdmFyIGxlbiA9IHRoaXMubGVuZ3RoLA0KCQkJaiA9ICtpICsgKCBpIDwgMCA/IGxlbiA6IDAgKTsNCgkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCBqID49IDAgJiYgaiA8IGxlbiA/IFsgdGhpc1sgaiBdIF0gOiBbXSApOw0KCX0sDQoNCgllbmQ6IGZ1bmN0aW9uKCkgew0KCQlyZXR1cm4gdGhpcy5wcmV2T2JqZWN0IHx8IHRoaXMuY29uc3RydWN0b3IoKTsNCgl9LA0KDQoJLy8gRm9yIGludGVybmFsIHVzZSBvbmx5Lg0KCS8vIEJlaGF2ZXMgbGlrZSBhbiBBcnJheSdzIG1ldGhvZCwgbm90IGxpa2UgYSBqUXVlcnkgbWV0aG9kLg0KCXB1c2g6IHB1c2gsDQoJc29ydDogYXJyLnNvcnQsDQoJc3BsaWNlOiBhcnIuc3BsaWNlDQp9Ow0KDQpqUXVlcnkuZXh0ZW5kID0galF1ZXJ5LmZuLmV4dGVuZCA9IGZ1bmN0aW9uKCkgew0KCXZhciBvcHRpb25zLCBuYW1lLCBzcmMsIGNvcHksIGNvcHlJc0FycmF5LCBjbG9uZSwNCgkJdGFyZ2V0ID0gYXJndW1lbnRzWyAwIF0gfHwge30sDQoJCWkgPSAxLA0KCQlsZW5ndGggPSBhcmd1bWVudHMubGVuZ3RoLA0KCQlkZWVwID0gZmFsc2U7DQoNCgkvLyBIYW5kbGUgYSBkZWVwIGNvcHkgc2l0dWF0aW9uDQoJaWYgKCB0eXBlb2YgdGFyZ2V0ID09PSAiYm9vbGVhbiIgKSB7DQoJCWRlZXAgPSB0YXJnZXQ7DQoNCgkJLy8gU2tpcCB0aGUgYm9vbGVhbiBhbmQgdGhlIHRhcmdldA0KCQl0YXJnZXQgPSBhcmd1bWVudHNbIGkgXSB8fCB7fTsNCgkJaSsrOw0KCX0NCg0KCS8vIEhhbmRsZSBjYXNlIHdoZW4gdGFyZ2V0IGlzIGEgc3RyaW5nIG9yIHNvbWV0aGluZyAocG9zc2libGUgaW4gZGVlcCBjb3B5KQ0KCWlmICggdHlwZW9mIHRhcmdldCAhPT0gIm9iamVjdCIgJiYgIWlzRnVuY3Rpb24oIHRhcmdldCApICkgew0KCQl0YXJnZXQgPSB7fTsNCgl9DQoNCgkvLyBFeHRlbmQgalF1ZXJ5IGl0c2VsZiBpZiBvbmx5IG9uZSBhcmd1bWVudCBpcyBwYXNzZWQNCglpZiAoIGkgPT09IGxlbmd0aCApIHsNCgkJdGFyZ2V0ID0gdGhpczsNCgkJaS0tOw0KCX0NCg0KCWZvciAoIDsgaSA8IGxlbmd0aDsgaSsrICkgew0KDQoJCS8vIE9ubHkgZGVhbCB3aXRoIG5vbi1udWxsL3VuZGVmaW5lZCB2YWx1ZXMNCgkJaWYgKCAoIG9wdGlvbnMgPSBhcmd1bWVudHNbIGkgXSApICE9IG51bGwgKSB7DQoNCgkJCS8vIEV4dGVuZCB0aGUgYmFzZSBvYmplY3QNCgkJCWZvciAoIG5hbWUgaW4gb3B0aW9ucyApIHsNCgkJCQljb3B5ID0gb3B0aW9uc1sgbmFtZSBdOw0KDQoJCQkJLy8gUHJldmVudCBPYmplY3QucHJvdG90eXBlIHBvbGx1dGlvbg0KCQkJCS8vIFByZXZlbnQgbmV2ZXItZW5kaW5nIGxvb3ANCgkJCQlpZiAoIG5hbWUgPT09ICJfX3Byb3RvX18iIHx8IHRhcmdldCA9PT0gY29weSApIHsNCgkJCQkJY29udGludWU7DQoJCQkJfQ0KDQoJCQkJLy8gUmVjdXJzZSBpZiB3ZSdyZSBtZXJnaW5nIHBsYWluIG9iamVjdHMgb3IgYXJyYXlzDQoJCQkJaWYgKCBkZWVwICYmIGNvcHkgJiYgKCBqUXVlcnkuaXNQbGFpbk9iamVjdCggY29weSApIHx8DQoJCQkJCSggY29weUlzQXJyYXkgPSBBcnJheS5pc0FycmF5KCBjb3B5ICkgKSApICkgew0KCQkJCQlzcmMgPSB0YXJnZXRbIG5hbWUgXTsNCg0KCQkJCQkvLyBFbnN1cmUgcHJvcGVyIHR5cGUgZm9yIHRoZSBzb3VyY2UgdmFsdWUNCgkJCQkJaWYgKCBjb3B5SXNBcnJheSAmJiAhQXJyYXkuaXNBcnJheSggc3JjICkgKSB7DQoJCQkJCQljbG9uZSA9IFtdOw0KCQkJCQl9IGVsc2UgaWYgKCAhY29weUlzQXJyYXkgJiYgIWpRdWVyeS5pc1BsYWluT2JqZWN0KCBzcmMgKSApIHsNCgkJCQkJCWNsb25lID0ge307DQoJCQkJCX0gZWxzZSB7DQoJCQkJCQljbG9uZSA9IHNyYzsNCgkJCQkJfQ0KCQkJCQljb3B5SXNBcnJheSA9IGZhbHNlOw0KDQoJCQkJCS8vIE5ldmVyIG1vdmUgb3JpZ2luYWwgb2JqZWN0cywgY2xvbmUgdGhlbQ0KCQkJCQl0YXJnZXRbIG5hbWUgXSA9IGpRdWVyeS5leHRlbmQoIGRlZXAsIGNsb25lLCBjb3B5ICk7DQoNCgkJCQkvLyBEb24ndCBicmluZyBpbiB1bmRlZmluZWQgdmFsdWVzDQoJCQkJfSBlbHNlIGlmICggY29weSAhPT0gdW5kZWZpbmVkICkgew0KCQkJCQl0YXJnZXRbIG5hbWUgXSA9IGNvcHk7DQoJCQkJfQ0KCQkJfQ0KCQl9DQoJfQ0KDQoJLy8gUmV0dXJuIHRoZSBtb2RpZmllZCBvYmplY3QNCglyZXR1cm4gdGFyZ2V0Ow0KfTsNCg0KalF1ZXJ5LmV4dGVuZCggew0KDQoJLy8gVW5pcXVlIGZvciBlYWNoIGNvcHkgb2YgalF1ZXJ5IG9uIHRoZSBwYWdlDQoJZXhwYW5kbzogImpRdWVyeSIgKyAoIHZlcnNpb24gKyBNYXRoLnJhbmRvbSgpICkucmVwbGFjZSggL1xEL2csICIiICksDQoNCgkvLyBBc3N1bWUgalF1ZXJ5IGlzIHJlYWR5IHdpdGhvdXQgdGhlIHJlYWR5IG1vZHVsZQ0KCWlzUmVhZHk6IHRydWUsDQoNCgllcnJvcjogZnVuY3Rpb24oIG1zZyApIHsNCgkJdGhyb3cgbmV3IEVycm9yKCBtc2cgKTsNCgl9LA0KDQoJbm9vcDogZnVuY3Rpb24oKSB7fSwNCg0KCWlzUGxhaW5PYmplY3Q6IGZ1bmN0aW9uKCBvYmogKSB7DQoJCXZhciBwcm90bywgQ3RvcjsNCg0KCQkvLyBEZXRlY3Qgb2J2aW91cyBuZWdhdGl2ZXMNCgkJLy8gVXNlIHRvU3RyaW5nIGluc3RlYWQgb2YgalF1ZXJ5LnR5cGUgdG8gY2F0Y2ggaG9zdCBvYmplY3RzDQoJCWlmICggIW9iaiB8fCB0b1N0cmluZy5jYWxsKCBvYmogKSAhPT0gIltvYmplY3QgT2JqZWN0XSIgKSB7DQoJCQlyZXR1cm4gZmFsc2U7DQoJCX0NCg0KCQlwcm90byA9IGdldFByb3RvKCBvYmogKTsNCg0KCQkvLyBPYmplY3RzIHdpdGggbm8gcHJvdG90eXBlIChlLmcuLCBgT2JqZWN0LmNyZWF0ZSggbnVsbCApYCkgYXJlIHBsYWluDQoJCWlmICggIXByb3RvICkgew0KCQkJcmV0dXJuIHRydWU7DQoJCX0NCg0KCQkvLyBPYmplY3RzIHdpdGggcHJvdG90eXBlIGFyZSBwbGFpbiBpZmYgdGhleSB3ZXJlIGNvbnN0cnVjdGVkIGJ5IGEgZ2xvYmFsIE9iamVjdCBmdW5jdGlvbg0KCQlDdG9yID0gaGFzT3duLmNhbGwoIHByb3RvLCAiY29uc3RydWN0b3IiICkgJiYgcHJvdG8uY29uc3RydWN0b3I7DQoJCXJldHVybiB0eXBlb2YgQ3RvciA9PT0gImZ1bmN0aW9uIiAmJiBmblRvU3RyaW5nLmNhbGwoIEN0b3IgKSA9PT0gT2JqZWN0RnVuY3Rpb25TdHJpbmc7DQoJfSwNCg0KCWlzRW1wdHlPYmplY3Q6IGZ1bmN0aW9uKCBvYmogKSB7DQoJCXZhciBuYW1lOw0KDQoJCWZvciAoIG5hbWUgaW4gb2JqICkgew0KCQkJcmV0dXJuIGZhbHNlOw0KCQl9DQoJCXJldHVybiB0cnVlOw0KCX0sDQoNCgkvLyBFdmFsdWF0ZXMgYSBzY3JpcHQgaW4gYSBwcm92aWRlZCBjb250ZXh0OyBmYWxscyBiYWNrIHRvIHRoZSBnbG9iYWwgb25lDQoJLy8gaWYgbm90IHNwZWNpZmllZC4NCglnbG9iYWxFdmFsOiBmdW5jdGlvbiggY29kZSwgb3B0aW9ucywgZG9jICkgew0KCQlET01FdmFsKCBjb2RlLCB7IG5vbmNlOiBvcHRpb25zICYmIG9wdGlvbnMubm9uY2UgfSwgZG9jICk7DQoJfSwNCg0KCWVhY2g6IGZ1bmN0aW9uKCBvYmosIGNhbGxiYWNrICkgew0KCQl2YXIgbGVuZ3RoLCBpID0gMDsNCg0KCQlpZiAoIGlzQXJyYXlMaWtlKCBvYmogKSApIHsNCgkJCWxlbmd0aCA9IG9iai5sZW5ndGg7DQoJCQlmb3IgKCA7IGkgPCBsZW5ndGg7IGkrKyApIHsNCgkJCQlpZiAoIGNhbGxiYWNrLmNhbGwoIG9ialsgaSBdLCBpLCBvYmpbIGkgXSApID09PSBmYWxzZSApIHsNCgkJCQkJYnJlYWs7DQoJCQkJfQ0KCQkJfQ0KCQl9IGVsc2Ugew0KCQkJZm9yICggaSBpbiBvYmogKSB7DQoJCQkJaWYgKCBjYWxsYmFjay5jYWxsKCBvYmpbIGkgXSwgaSwgb2JqWyBpIF0gKSA9PT0gZmFsc2UgKSB7DQoJCQkJCWJyZWFrOw0KCQkJCX0NCgkJCX0NCgkJfQ0KDQoJCXJldHVybiBvYmo7DQoJfSwNCg0KCS8vIHJlc3VsdHMgaXMgZm9yIGludGVybmFsIHVzYWdlIG9ubHkNCgltYWtlQXJyYXk6IGZ1bmN0aW9uKCBhcnIsIHJlc3VsdHMgKSB7DQoJCXZhciByZXQgPSByZXN1bHRzIHx8IFtdOw0KDQoJCWlmICggYXJyICE9IG51bGwgKSB7DQoJCQlpZiAoIGlzQXJyYXlMaWtlKCBPYmplY3QoIGFyciApICkgKSB7DQoJCQkJalF1ZXJ5Lm1lcmdlKCByZXQsDQoJCQkJCXR5cGVvZiBhcnIgPT09ICJzdHJpbmciID8NCgkJCQkJCVsgYXJyIF0gOiBhcnINCgkJCQkpOw0KCQkJfSBlbHNlIHsNCgkJCQlwdXNoLmNhbGwoIHJldCwgYXJyICk7DQoJCQl9DQoJCX0NCg0KCQlyZXR1cm4gcmV0Ow0KCX0sDQoNCglpbkFycmF5OiBmdW5jdGlvbiggZWxlbSwgYXJyLCBpICkgew0KCQlyZXR1cm4gYXJyID09IG51bGwgPyAtMSA6IGluZGV4T2YuY2FsbCggYXJyLCBlbGVtLCBpICk7DQoJfSwNCg0KCS8vIFN1cHBvcnQ6IEFuZHJvaWQgPD00LjAgb25seSwgUGhhbnRvbUpTIDEgb25seQ0KCS8vIHB1c2guYXBwbHkoXywgYXJyYXlsaWtlKSB0aHJvd3Mgb24gYW5jaWVudCBXZWJLaXQNCgltZXJnZTogZnVuY3Rpb24oIGZpcnN0LCBzZWNvbmQgKSB7DQoJCXZhciBsZW4gPSArc2Vjb25kLmxlbmd0aCwNCgkJCWogPSAwLA0KCQkJaSA9IGZpcnN0Lmxlbmd0aDsNCg0KCQlmb3IgKCA7IGogPCBsZW47IGorKyApIHsNCgkJCWZpcnN0WyBpKysgXSA9IHNlY29uZFsgaiBdOw0KCQl9DQoNCgkJZmlyc3QubGVuZ3RoID0gaTsNCg0KCQlyZXR1cm4gZmlyc3Q7DQoJfSwNCg0KCWdyZXA6IGZ1bmN0aW9uKCBlbGVtcywgY2FsbGJhY2ssIGludmVydCApIHsNCgkJdmFyIGNhbGxiYWNrSW52ZXJzZSwNCgkJCW1hdGNoZXMgPSBbXSwNCgkJCWkgPSAwLA0KCQkJbGVuZ3RoID0gZWxlbXMubGVuZ3RoLA0KCQkJY2FsbGJhY2tFeHBlY3QgPSAhaW52ZXJ0Ow0KDQoJCS8vIEdvIHRocm91Z2ggdGhlIGFycmF5LCBvbmx5IHNhdmluZyB0aGUgaXRlbXMNCgkJLy8gdGhhdCBwYXNzIHRoZSB2YWxpZGF0b3IgZnVuY3Rpb24NCgkJZm9yICggOyBpIDwgbGVuZ3RoOyBpKysgKSB7DQoJCQljYWxsYmFja0ludmVyc2UgPSAhY2FsbGJhY2soIGVsZW1zWyBpIF0sIGkgKTsNCgkJCWlmICggY2FsbGJhY2tJbnZlcnNlICE9PSBjYWxsYmFja0V4cGVjdCApIHsNCgkJCQltYXRjaGVzLnB1c2goIGVsZW1zWyBpIF0gKTsNCgkJCX0NCgkJfQ0KDQoJCXJldHVybiBtYXRjaGVzOw0KCX0sDQoNCgkvLyBhcmcgaXMgZm9yIGludGVybmFsIHVzYWdlIG9ubHkNCgltYXA6IGZ1bmN0aW9uKCBlbGVtcywgY2FsbGJhY2ssIGFyZyApIHsNCgkJdmFyIGxlbmd0aCwgdmFsdWUsDQoJCQlpID0gMCwNCgkJCXJldCA9IFtdOw0KDQoJCS8vIEdvIHRocm91Z2ggdGhlIGFycmF5LCB0cmFuc2xhdGluZyBlYWNoIG9mIHRoZSBpdGVtcyB0byB0aGVpciBuZXcgdmFsdWVzDQoJCWlmICggaXNBcnJheUxpa2UoIGVsZW1zICkgKSB7DQoJCQlsZW5ndGggPSBlbGVtcy5sZW5ndGg7DQoJCQlmb3IgKCA7IGkgPCBsZW5ndGg7IGkrKyApIHsNCgkJCQl2YWx1ZSA9IGNhbGxiYWNrKCBlbGVtc1sgaSBdLCBpLCBhcmcgKTsNCg0KCQkJCWlmICggdmFsdWUgIT0gbnVsbCApIHsNCgkJCQkJcmV0LnB1c2goIHZhbHVlICk7DQoJCQkJfQ0KCQkJfQ0KDQoJCS8vIEdvIHRocm91Z2ggZXZlcnkga2V5IG9uIHRoZSBvYmplY3QsDQoJCX0gZWxzZSB7DQoJCQlmb3IgKCBpIGluIGVsZW1zICkgew0KCQkJCXZhbHVlID0gY2FsbGJhY2soIGVsZW1zWyBpIF0sIGksIGFyZyApOw0KDQoJCQkJaWYgKCB2YWx1ZSAhPSBudWxsICkgew0KCQkJCQlyZXQucHVzaCggdmFsdWUgKTsNCgkJCQl9DQoJCQl9DQoJCX0NCg0KCQkvLyBGbGF0dGVuIGFueSBuZXN0ZWQgYXJyYXlzDQoJCXJldHVybiBmbGF0KCByZXQgKTsNCgl9LA0KDQoJLy8gQSBnbG9iYWwgR1VJRCBjb3VudGVyIGZvciBvYmplY3RzDQoJZ3VpZDogMSwNCg0KCS8vIGpRdWVyeS5zdXBwb3J0IGlzIG5vdCB1c2VkIGluIENvcmUgYnV0IG90aGVyIHByb2plY3RzIGF0dGFjaCB0aGVpcg0KCS8vIHByb3BlcnRpZXMgdG8gaXQgc28gaXQgbmVlZHMgdG8gZXhpc3QuDQoJc3VwcG9ydDogc3VwcG9ydA0KfSApOw0KDQppZiAoIHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgKSB7DQoJalF1ZXJ5LmZuWyBTeW1ib2wuaXRlcmF0b3IgXSA9IGFyclsgU3ltYm9sLml0ZXJhdG9yIF07DQp9DQoNCi8vIFBvcHVsYXRlIHRoZSBjbGFzczJ0eXBlIG1hcA0KalF1ZXJ5LmVhY2goICJCb29sZWFuIE51bWJlciBTdHJpbmcgRnVuY3Rpb24gQXJyYXkgRGF0ZSBSZWdFeHAgT2JqZWN0IEVycm9yIFN5bWJvbCIuc3BsaXQoICIgIiApLA0KCWZ1bmN0aW9uKCBfaSwgbmFtZSApIHsNCgkJY2xhc3MydHlwZVsgIltvYmplY3QgIiArIG5hbWUgKyAiXSIgXSA9IG5hbWUudG9Mb3dlckNhc2UoKTsNCgl9ICk7DQoNCmZ1bmN0aW9uIGlzQXJyYXlMaWtlKCBvYmogKSB7DQoNCgkvLyBTdXBwb3J0OiByZWFsIGlPUyA4LjIgb25seSAobm90IHJlcHJvZHVjaWJsZSBpbiBzaW11bGF0b3IpDQoJLy8gYGluYCBjaGVjayB1c2VkIHRvIHByZXZlbnQgSklUIGVycm9yIChnaC0yMTQ1KQ0KCS8vIGhhc093biBpc24ndCB1c2VkIGhlcmUgZHVlIHRvIGZhbHNlIG5lZ2F0aXZlcw0KCS8vIHJlZ2FyZGluZyBOb2RlbGlzdCBsZW5ndGggaW4gSUUNCgl2YXIgbGVuZ3RoID0gISFvYmogJiYgImxlbmd0aCIgaW4gb2JqICYmIG9iai5sZW5ndGgsDQoJCXR5cGUgPSB0b1R5cGUoIG9iaiApOw0KDQoJaWYgKCBpc0Z1bmN0aW9uKCBvYmogKSB8fCBpc1dpbmRvdyggb2JqICkgKSB7DQoJCXJldHVybiBmYWxzZTsNCgl9DQoNCglyZXR1cm4gdHlwZSA9PT0gImFycmF5IiB8fCBsZW5ndGggPT09IDAgfHwNCgkJdHlwZW9mIGxlbmd0aCA9PT0gIm51bWJlciIgJiYgbGVuZ3RoID4gMCAmJiAoIGxlbmd0aCAtIDEgKSBpbiBvYmo7DQp9DQp2YXIgU2l6emxlID0NCi8qIQ0KICogU2l6emxlIENTUyBTZWxlY3RvciBFbmdpbmUgdjIuMy42DQogKiBodHRwczovL3NpenpsZWpzLmNvbS8NCiAqDQogKiBDb3B5cmlnaHQgSlMgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzDQogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UNCiAqIGh0dHBzOi8vanMuZm91bmRhdGlvbi8NCiAqDQogKiBEYXRlOiAyMDIxLTAyLTE2DQogKi8NCiggZnVuY3Rpb24oIHdpbmRvdyApIHsNCnZhciBpLA0KCXN1cHBvcnQsDQoJRXhwciwNCglnZXRUZXh0LA0KCWlzWE1MLA0KCXRva2VuaXplLA0KCWNvbXBpbGUsDQoJc2VsZWN0LA0KCW91dGVybW9zdENvbnRleHQsDQoJc29ydElucHV0LA0KCWhhc0R1cGxpY2F0ZSwNCg0KCS8vIExvY2FsIGRvY3VtZW50IHZhcnMNCglzZXREb2N1bWVudCwNCglkb2N1bWVudCwNCglkb2NFbGVtLA0KCWRvY3VtZW50SXNIVE1MLA0KCXJidWdneVFTQSwNCglyYnVnZ3lNYXRjaGVzLA0KCW1hdGNoZXMsDQoJY29udGFpbnMsDQoNCgkvLyBJbnN0YW5jZS1zcGVjaWZpYyBkYXRhDQoJZXhwYW5kbyA9ICJzaXp6bGUiICsgMSAqIG5ldyBEYXRlKCksDQoJcHJlZmVycmVkRG9jID0gd2luZG93LmRvY3VtZW50LA0KCWRpcnJ1bnMgPSAwLA0KCWRvbmUgPSAwLA0KCWNsYXNzQ2FjaGUgPSBjcmVhdGVDYWNoZSgpLA0KCXRva2VuQ2FjaGUgPSBjcmVhdGVDYWNoZSgpLA0KCWNvbXBpbGVyQ2FjaGUgPSBjcmVhdGVDYWNoZSgpLA0KCW5vbm5hdGl2ZVNlbGVjdG9yQ2FjaGUgPSBjcmVhdGVDYWNoZSgpLA0KCXNvcnRPcmRlciA9IGZ1bmN0aW9uKCBhLCBiICkgew0KCQlpZiAoIGEgPT09IGIgKSB7DQoJCQloYXNEdXBsaWNhdGUgPSB0cnVlOw0KCQl9DQoJCXJldHVybiAwOw0KCX0sDQoNCgkvLyBJbnN0YW5jZSBtZXRob2RzDQoJaGFzT3duID0gKCB7fSApLmhhc093blByb3BlcnR5LA0KCWFyciA9IFtdLA0KCXBvcCA9IGFyci5wb3AsDQoJcHVzaE5hdGl2ZSA9IGFyci5wdXNoLA0KCXB1c2ggPSBhcnIucHVzaCwNCglzbGljZSA9IGFyci5zbGljZSwNCg0KCS8vIFVzZSBhIHN0cmlwcGVkLWRvd24gaW5kZXhPZiBhcyBpdCdzIGZhc3RlciB0aGFuIG5hdGl2ZQ0KCS8vIGh0dHBzOi8vanNwZXJmLmNvbS90aG9yLWluZGV4b2YtdnMtZm9yLzUNCglpbmRleE9mID0gZnVuY3Rpb24oIGxpc3QsIGVsZW0gKSB7DQoJCXZhciBpID0gMCwNCgkJCWxlbiA9IGxpc3QubGVuZ3RoOw0KCQlmb3IgKCA7IGkgPCBsZW47IGkrKyApIHsNCgkJCWlmICggbGlzdFsgaSBdID09PSBlbGVtICkgew0KCQkJCXJldHVybiBpOw0KCQkJfQ0KCQl9DQoJCXJldHVybiAtMTsNCgl9LA0KDQoJYm9vbGVhbnMgPSAiY2hlY2tlZHxzZWxlY3RlZHxhc3luY3xhdXRvZm9jdXN8YXV0b3BsYXl8Y29udHJvbHN8ZGVmZXJ8ZGlzYWJsZWR8aGlkZGVufCIgKw0KCQkiaXNtYXB8bG9vcHxtdWx0aXBsZXxvcGVufHJlYWRvbmx5fHJlcXVpcmVkfHNjb3BlZCIsDQoNCgkvLyBSZWd1bGFyIGV4cHJlc3Npb25zDQoNCgkvLyBodHRwOi8vd3d3LnczLm9yZy9UUi9jc3MzLXNlbGVjdG9ycy8jd2hpdGVzcGFjZQ0KCXdoaXRlc3BhY2UgPSAiW1xceDIwXFx0XFxyXFxuXFxmXSIsDQoNCgkvLyBodHRwczovL3d3dy53My5vcmcvVFIvY3NzLXN5bnRheC0zLyNpZGVudC10b2tlbi1kaWFncmFtDQoJaWRlbnRpZmllciA9ICIoPzpcXFxcW1xcZGEtZkEtRl17MSw2fSIgKyB3aGl0ZXNwYWNlICsNCgkJIj98XFxcXFteXFxyXFxuXFxmXXxbXFx3LV18W15cMC1cXHg3Zl0pKyIsDQoNCgkvLyBBdHRyaWJ1dGUgc2VsZWN0b3JzOiBodHRwOi8vd3d3LnczLm9yZy9UUi9zZWxlY3RvcnMvI2F0dHJpYnV0ZS1zZWxlY3RvcnMNCglhdHRyaWJ1dGVzID0gIlxcWyIgKyB3aGl0ZXNwYWNlICsgIiooIiArIGlkZW50aWZpZXIgKyAiKSg/OiIgKyB3aGl0ZXNwYWNlICsNCg0KCQkvLyBPcGVyYXRvciAoY2FwdHVyZSAyKQ0KCQkiKihbKl4kfCF+XT89KSIgKyB3aGl0ZXNwYWNlICsNCg0KCQkvLyAiQXR0cmlidXRlIHZhbHVlcyBtdXN0IGJlIENTUyBpZGVudGlmaWVycyBbY2FwdHVyZSA1XQ0KCQkvLyBvciBzdHJpbmdzIFtjYXB0dXJlIDMgb3IgY2FwdHVyZSA0XSINCgkJIiooPzonKCg/OlxcXFwufFteXFxcXCddKSopJ3xcIigoPzpcXFxcLnxbXlxcXFxcIl0pKilcInwoIiArIGlkZW50aWZpZXIgKyAiKSl8KSIgKw0KCQl3aGl0ZXNwYWNlICsgIipcXF0iLA0KDQoJcHNldWRvcyA9ICI6KCIgKyBpZGVudGlmaWVyICsgIikoPzpcXCgoIiArDQoNCgkJLy8gVG8gcmVkdWNlIHRoZSBudW1iZXIgb2Ygc2VsZWN0b3JzIG5lZWRpbmcgdG9rZW5pemUgaW4gdGhlIHByZUZpbHRlciwgcHJlZmVyIGFyZ3VtZW50czoNCgkJLy8gMS4gcXVvdGVkIChjYXB0dXJlIDM7IGNhcHR1cmUgNCBvciBjYXB0dXJlIDUpDQoJCSIoJygoPzpcXFxcLnxbXlxcXFwnXSkqKSd8XCIoKD86XFxcXC58W15cXFxcXCJdKSopXCIpfCIgKw0KDQoJCS8vIDIuIHNpbXBsZSAoY2FwdHVyZSA2KQ0KCQkiKCg/OlxcXFwufFteXFxcXCgpW1xcXV18IiArIGF0dHJpYnV0ZXMgKyAiKSopfCIgKw0KDQoJCS8vIDMuIGFueXRoaW5nIGVsc2UgKGNhcHR1cmUgMikNCgkJIi4qIiArDQoJCSIpXFwpfCkiLA0KDQoJLy8gTGVhZGluZyBhbmQgbm9uLWVzY2FwZWQgdHJhaWxpbmcgd2hpdGVzcGFjZSwgY2FwdHVyaW5nIHNvbWUgbm9uLXdoaXRlc3BhY2UgY2hhcmFjdGVycyBwcmVjZWRpbmcgdGhlIGxhdHRlcg0KCXJ3aGl0ZXNwYWNlID0gbmV3IFJlZ0V4cCggd2hpdGVzcGFjZSArICIrIiwgImciICksDQoJcnRyaW0gPSBuZXcgUmVnRXhwKCAiXiIgKyB3aGl0ZXNwYWNlICsgIit8KCg/Ol58W15cXFxcXSkoPzpcXFxcLikqKSIgKw0KCQl3aGl0ZXNwYWNlICsgIiskIiwgImciICksDQoNCglyY29tbWEgPSBuZXcgUmVnRXhwKCAiXiIgKyB3aGl0ZXNwYWNlICsgIiosIiArIHdoaXRlc3BhY2UgKyAiKiIgKSwNCglyY29tYmluYXRvcnMgPSBuZXcgUmVnRXhwKCAiXiIgKyB3aGl0ZXNwYWNlICsgIiooWz4rfl18IiArIHdoaXRlc3BhY2UgKyAiKSIgKyB3aGl0ZXNwYWNlICsNCgkJIioiICksDQoJcmRlc2NlbmQgPSBuZXcgUmVnRXhwKCB3aGl0ZXNwYWNlICsgInw+IiApLA0KDQoJcnBzZXVkbyA9IG5ldyBSZWdFeHAoIHBzZXVkb3MgKSwNCglyaWRlbnRpZmllciA9IG5ldyBSZWdFeHAoICJeIiArIGlkZW50aWZpZXIgKyAiJCIgKSwNCg0KCW1hdGNoRXhwciA9IHsNCgkJIklEIjogbmV3IFJlZ0V4cCggIl4jKCIgKyBpZGVudGlmaWVyICsgIikiICksDQoJCSJDTEFTUyI6IG5ldyBSZWdFeHAoICJeXFwuKCIgKyBpZGVudGlmaWVyICsgIikiICksDQoJCSJUQUciOiBuZXcgUmVnRXhwKCAiXigiICsgaWRlbnRpZmllciArICJ8WypdKSIgKSwNCgkJIkFUVFIiOiBuZXcgUmVnRXhwKCAiXiIgKyBhdHRyaWJ1dGVzICksDQoJCSJQU0VVRE8iOiBuZXcgUmVnRXhwKCAiXiIgKyBwc2V1ZG9zICksDQoJCSJDSElMRCI6IG5ldyBSZWdFeHAoICJeOihvbmx5fGZpcnN0fGxhc3R8bnRofG50aC1sYXN0KS0oY2hpbGR8b2YtdHlwZSkoPzpcXCgiICsNCgkJCXdoaXRlc3BhY2UgKyAiKihldmVufG9kZHwoKFsrLV18KShcXGQqKW58KSIgKyB3aGl0ZXNwYWNlICsgIiooPzooWystXXwpIiArDQoJCQl3aGl0ZXNwYWNlICsgIiooXFxkKyl8KSkiICsgd2hpdGVzcGFjZSArICIqXFwpfCkiLCAiaSIgKSwNCgkJImJvb2wiOiBuZXcgUmVnRXhwKCAiXig/OiIgKyBib29sZWFucyArICIpJCIsICJpIiApLA0KDQoJCS8vIEZvciB1c2UgaW4gbGlicmFyaWVzIGltcGxlbWVudGluZyAuaXMoKQ0KCQkvLyBXZSB1c2UgdGhpcyBmb3IgUE9TIG1hdGNoaW5nIGluIGBzZWxlY3RgDQoJCSJuZWVkc0NvbnRleHQiOiBuZXcgUmVnRXhwKCAiXiIgKyB3aGl0ZXNwYWNlICsNCgkJCSIqWz4rfl18OihldmVufG9kZHxlcXxndHxsdHxudGh8Zmlyc3R8bGFzdCkoPzpcXCgiICsgd2hpdGVzcGFjZSArDQoJCQkiKigoPzotXFxkKT9cXGQqKSIgKyB3aGl0ZXNwYWNlICsgIipcXCl8KSg/PVteLV18JCkiLCAiaSIgKQ0KCX0sDQoNCglyaHRtbCA9IC9IVE1MJC9pLA0KCXJpbnB1dHMgPSAvXig/OmlucHV0fHNlbGVjdHx0ZXh0YXJlYXxidXR0b24pJC9pLA0KCXJoZWFkZXIgPSAvXmhcZCQvaSwNCg0KCXJuYXRpdmUgPSAvXltee10rXHtccypcW25hdGl2ZSBcdy8sDQoNCgkvLyBFYXNpbHktcGFyc2VhYmxlL3JldHJpZXZhYmxlIElEIG9yIFRBRyBvciBDTEFTUyBzZWxlY3RvcnMNCglycXVpY2tFeHByID0gL14oPzojKFtcdy1dKyl8KFx3Kyl8XC4oW1x3LV0rKSkkLywNCg0KCXJzaWJsaW5nID0gL1srfl0vLA0KDQoJLy8gQ1NTIGVzY2FwZXMNCgkvLyBodHRwOi8vd3d3LnczLm9yZy9UUi9DU1MyMS9zeW5kYXRhLmh0bWwjZXNjYXBlZC1jaGFyYWN0ZXJzDQoJcnVuZXNjYXBlID0gbmV3IFJlZ0V4cCggIlxcXFxbXFxkYS1mQS1GXXsxLDZ9IiArIHdoaXRlc3BhY2UgKyAiP3xcXFxcKFteXFxyXFxuXFxmXSkiLCAiZyIgKSwNCglmdW5lc2NhcGUgPSBmdW5jdGlvbiggZXNjYXBlLCBub25IZXggKSB7DQoJCXZhciBoaWdoID0gIjB4IiArIGVzY2FwZS5zbGljZSggMSApIC0gMHgxMDAwMDsNCg0KCQlyZXR1cm4gbm9uSGV4ID8NCg0KCQkJLy8gU3RyaXAgdGhlIGJhY2tzbGFzaCBwcmVmaXggZnJvbSBhIG5vbi1oZXggZXNjYXBlIHNlcXVlbmNlDQoJCQlub25IZXggOg0KDQoJCQkvLyBSZXBsYWNlIGEgaGV4YWRlY2ltYWwgZXNjYXBlIHNlcXVlbmNlIHdpdGggdGhlIGVuY29kZWQgVW5pY29kZSBjb2RlIHBvaW50DQoJCQkvLyBTdXBwb3J0OiBJRSA8PTExKw0KCQkJLy8gRm9yIHZhbHVlcyBvdXRzaWRlIHRoZSBCYXNpYyBNdWx0aWxpbmd1YWwgUGxhbmUgKEJNUCksIG1hbnVhbGx5IGNvbnN0cnVjdCBhDQoJCQkvLyBzdXJyb2dhdGUgcGFpcg0KCQkJaGlnaCA8IDAgPw0KCQkJCVN0cmluZy5mcm9tQ2hhckNvZGUoIGhpZ2ggKyAweDEwMDAwICkgOg0KCQkJCVN0cmluZy5mcm9tQ2hhckNvZGUoIGhpZ2ggPj4gMTAgfCAweEQ4MDAsIGhpZ2ggJiAweDNGRiB8IDB4REMwMCApOw0KCX0sDQoNCgkvLyBDU1Mgc3RyaW5nL2lkZW50aWZpZXIgc2VyaWFsaXphdGlvbg0KCS8vIGh0dHBzOi8vZHJhZnRzLmNzc3dnLm9yZy9jc3NvbS8jY29tbW9uLXNlcmlhbGl6aW5nLWlkaW9tcw0KCXJjc3Nlc2NhcGUgPSAvKFtcMC1ceDFmXHg3Zl18Xi0/XGQpfF4tJHxbXlwwLVx4MWZceDdmLVx1RkZGRlx3LV0vZywNCglmY3NzZXNjYXBlID0gZnVuY3Rpb24oIGNoLCBhc0NvZGVQb2ludCApIHsNCgkJaWYgKCBhc0NvZGVQb2ludCApIHsNCg0KCQkJLy8gVSswMDAwIE5VTEwgYmVjb21lcyBVK0ZGRkQgUkVQTEFDRU1FTlQgQ0hBUkFDVEVSDQoJCQlpZiAoIGNoID09PSAiXDAiICkgew0KCQkJCXJldHVybiAiXHVGRkZEIjsNCgkJCX0NCg0KCQkJLy8gQ29udHJvbCBjaGFyYWN0ZXJzIGFuZCAoZGVwZW5kZW50IHVwb24gcG9zaXRpb24pIG51bWJlcnMgZ2V0IGVzY2FwZWQgYXMgY29kZSBwb2ludHMNCgkJCXJldHVybiBjaC5zbGljZSggMCwgLTEgKSArICJcXCIgKw0KCQkJCWNoLmNoYXJDb2RlQXQoIGNoLmxlbmd0aCAtIDEgKS50b1N0cmluZyggMTYgKSArICIgIjsNCgkJfQ0KDQoJCS8vIE90aGVyIHBvdGVudGlhbGx5LXNwZWNpYWwgQVNDSUkgY2hhcmFjdGVycyBnZXQgYmFja3NsYXNoLWVzY2FwZWQNCgkJcmV0dXJuICJcXCIgKyBjaDsNCgl9LA0KDQoJLy8gVXNlZCBmb3IgaWZyYW1lcw0KCS8vIFNlZSBzZXREb2N1bWVudCgpDQoJLy8gUmVtb3ZpbmcgdGhlIGZ1bmN0aW9uIHdyYXBwZXIgY2F1c2VzIGEgIlBlcm1pc3Npb24gRGVuaWVkIg0KCS8vIGVycm9yIGluIElFDQoJdW5sb2FkSGFuZGxlciA9IGZ1bmN0aW9uKCkgew0KCQlzZXREb2N1bWVudCgpOw0KCX0sDQoNCglpbkRpc2FibGVkRmllbGRzZXQgPSBhZGRDb21iaW5hdG9yKA0KCQlmdW5jdGlvbiggZWxlbSApIHsNCgkJCXJldHVybiBlbGVtLmRpc2FibGVkID09PSB0cnVlICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gImZpZWxkc2V0IjsNCgkJfSwNCgkJeyBkaXI6ICJwYXJlbnROb2RlIiwgbmV4dDogImxlZ2VuZCIgfQ0KCSk7DQoNCi8vIE9wdGltaXplIGZvciBwdXNoLmFwcGx5KCBfLCBOb2RlTGlzdCApDQp0cnkgew0KCXB1c2guYXBwbHkoDQoJCSggYXJyID0gc2xpY2UuY2FsbCggcHJlZmVycmVkRG9jLmNoaWxkTm9kZXMgKSApLA0KCQlwcmVmZXJyZWREb2MuY2hpbGROb2Rlcw0KCSk7DQoNCgkvLyBTdXBwb3J0OiBBbmRyb2lkPDQuMA0KCS8vIERldGVjdCBzaWxlbnRseSBmYWlsaW5nIHB1c2guYXBwbHkNCgkvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdW51c2VkLWV4cHJlc3Npb25zDQoJYXJyWyBwcmVmZXJyZWREb2MuY2hpbGROb2Rlcy5sZW5ndGggXS5ub2RlVHlwZTsNCn0gY2F0Y2ggKCBlICkgew0KCXB1c2ggPSB7IGFwcGx5OiBhcnIubGVuZ3RoID8NCg0KCQkvLyBMZXZlcmFnZSBzbGljZSBpZiBwb3NzaWJsZQ0KCQlmdW5jdGlvbiggdGFyZ2V0LCBlbHMgKSB7DQoJCQlwdXNoTmF0aXZlLmFwcGx5KCB0YXJnZXQsIHNsaWNlLmNhbGwoIGVscyApICk7DQoJCX0gOg0KDQoJCS8vIFN1cHBvcnQ6IElFPDkNCgkJLy8gT3RoZXJ3aXNlIGFwcGVuZCBkaXJlY3RseQ0KCQlmdW5jdGlvbiggdGFyZ2V0LCBlbHMgKSB7DQoJCQl2YXIgaiA9IHRhcmdldC5sZW5ndGgsDQoJCQkJaSA9IDA7DQoNCgkJCS8vIENhbid0IHRydXN0IE5vZGVMaXN0Lmxlbmd0aA0KCQkJd2hpbGUgKCAoIHRhcmdldFsgaisrIF0gPSBlbHNbIGkrKyBdICkgKSB7fQ0KCQkJdGFyZ2V0Lmxlbmd0aCA9IGogLSAxOw0KCQl9DQoJfTsNCn0NCg0KZnVuY3Rpb24gU2l6emxlKCBzZWxlY3RvciwgY29udGV4dCwgcmVzdWx0cywgc2VlZCApIHsNCgl2YXIgbSwgaSwgZWxlbSwgbmlkLCBtYXRjaCwgZ3JvdXBzLCBuZXdTZWxlY3RvciwNCgkJbmV3Q29udGV4dCA9IGNvbnRleHQgJiYgY29udGV4dC5vd25lckRvY3VtZW50LA0KDQoJCS8vIG5vZGVUeXBlIGRlZmF1bHRzIHRvIDksIHNpbmNlIGNvbnRleHQgZGVmYXVsdHMgdG8gZG9jdW1lbnQNCgkJbm9kZVR5cGUgPSBjb250ZXh0ID8gY29udGV4dC5ub2RlVHlwZSA6IDk7DQoNCglyZXN1bHRzID0gcmVzdWx0cyB8fCBbXTsNCg0KCS8vIFJldHVybiBlYXJseSBmcm9tIGNhbGxzIHdpdGggaW52YWxpZCBzZWxlY3RvciBvciBjb250ZXh0DQoJaWYgKCB0eXBlb2Ygc2VsZWN0b3IgIT09ICJzdHJpbmciIHx8ICFzZWxlY3RvciB8fA0KCQlub2RlVHlwZSAhPT0gMSAmJiBub2RlVHlwZSAhPT0gOSAmJiBub2RlVHlwZSAhPT0gMTEgKSB7DQoNCgkJcmV0dXJuIHJlc3VsdHM7DQoJfQ0KDQoJLy8gVHJ5IHRvIHNob3J0Y3V0IGZpbmQgb3BlcmF0aW9ucyAoYXMgb3Bwb3NlZCB0byBmaWx0ZXJzKSBpbiBIVE1MIGRvY3VtZW50cw0KCWlmICggIXNlZWQgKSB7DQoJCXNldERvY3VtZW50KCBjb250ZXh0ICk7DQoJCWNvbnRleHQgPSBjb250ZXh0IHx8IGRvY3VtZW50Ow0KDQoJCWlmICggZG9jdW1lbnRJc0hUTUwgKSB7DQoNCgkJCS8vIElmIHRoZSBzZWxlY3RvciBpcyBzdWZmaWNpZW50bHkgc2ltcGxlLCB0cnkgdXNpbmcgYSAiZ2V0KkJ5KiIgRE9NIG1ldGhvZA0KCQkJLy8gKGV4Y2VwdGluZyBEb2N1bWVudEZyYWdtZW50IGNvbnRleHQsIHdoZXJlIHRoZSBtZXRob2RzIGRvbid0IGV4aXN0KQ0KCQkJaWYgKCBub2RlVHlwZSAhPT0gMTEgJiYgKCBtYXRjaCA9IHJxdWlja0V4cHIuZXhlYyggc2VsZWN0b3IgKSApICkgew0KDQoJCQkJLy8gSUQgc2VsZWN0b3INCgkJCQlpZiAoICggbSA9IG1hdGNoWyAxIF0gKSApIHsNCg0KCQkJCQkvLyBEb2N1bWVudCBjb250ZXh0DQoJCQkJCWlmICggbm9kZVR5cGUgPT09IDkgKSB7DQoJCQkJCQlpZiAoICggZWxlbSA9IGNvbnRleHQuZ2V0RWxlbWVudEJ5SWQoIG0gKSApICkgew0KDQoJCQkJCQkJLy8gU3VwcG9ydDogSUUsIE9wZXJhLCBXZWJraXQNCgkJCQkJCQkvLyBUT0RPOiBpZGVudGlmeSB2ZXJzaW9ucw0KCQkJCQkJCS8vIGdldEVsZW1lbnRCeUlkIGNhbiBtYXRjaCBlbGVtZW50cyBieSBuYW1lIGluc3RlYWQgb2YgSUQNCgkJCQkJCQlpZiAoIGVsZW0uaWQgPT09IG0gKSB7DQoJCQkJCQkJCXJlc3VsdHMucHVzaCggZWxlbSApOw0KCQkJCQkJCQlyZXR1cm4gcmVzdWx0czsNCgkJCQkJCQl9DQoJCQkJCQl9IGVsc2Ugew0KCQkJCQkJCXJldHVybiByZXN1bHRzOw0KCQkJCQkJfQ0KDQoJCQkJCS8vIEVsZW1lbnQgY29udGV4dA0KCQkJCQl9IGVsc2Ugew0KDQoJCQkJCQkvLyBTdXBwb3J0OiBJRSwgT3BlcmEsIFdlYmtpdA0KCQkJCQkJLy8gVE9ETzogaWRlbnRpZnkgdmVyc2lvbnMNCgkJCQkJCS8vIGdldEVsZW1lbnRCeUlkIGNhbiBtYXRjaCBlbGVtZW50cyBieSBuYW1lIGluc3RlYWQgb2YgSUQNCgkJCQkJCWlmICggbmV3Q29udGV4dCAmJiAoIGVsZW0gPSBuZXdDb250ZXh0LmdldEVsZW1lbnRCeUlkKCBtICkgKSAmJg0KCQkJCQkJCWNvbnRhaW5zKCBjb250ZXh0LCBlbGVtICkgJiYNCgkJCQkJCQllbGVtLmlkID09PSBtICkgew0KDQoJCQkJCQkJcmVzdWx0cy5wdXNoKCBlbGVtICk7DQoJCQkJCQkJcmV0dXJuIHJlc3VsdHM7DQoJCQkJCQl9DQoJCQkJCX0NCg0KCQkJCS8vIFR5cGUgc2VsZWN0b3INCgkJCQl9IGVsc2UgaWYgKCBtYXRjaFsgMiBdICkgew0KCQkJCQlwdXNoLmFwcGx5KCByZXN1bHRzLCBjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lKCBzZWxlY3RvciApICk7DQoJCQkJCXJldHVybiByZXN1bHRzOw0KDQoJCQkJLy8gQ2xhc3Mgc2VsZWN0b3INCgkJCQl9IGVsc2UgaWYgKCAoIG0gPSBtYXRjaFsgMyBdICkgJiYgc3VwcG9ydC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lICYmDQoJCQkJCWNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSApIHsNCg0KCQkJCQlwdXNoLmFwcGx5KCByZXN1bHRzLCBjb250ZXh0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoIG0gKSApOw0KCQkJCQlyZXR1cm4gcmVzdWx0czsNCgkJCQl9DQoJCQl9DQoNCgkJCS8vIFRha2UgYWR2YW50YWdlIG9mIHF1ZXJ5U2VsZWN0b3JBbGwNCgkJCWlmICggc3VwcG9ydC5xc2EgJiYNCgkJCQkhbm9ubmF0aXZlU2VsZWN0b3JDYWNoZVsgc2VsZWN0b3IgKyAiICIgXSAmJg0KCQkJCSggIXJidWdneVFTQSB8fCAhcmJ1Z2d5UVNBLnRlc3QoIHNlbGVjdG9yICkgKSAmJg0KDQoJCQkJLy8gU3VwcG9ydDogSUUgOCBvbmx5DQoJCQkJLy8gRXhjbHVkZSBvYmplY3QgZWxlbWVudHMNCgkJCQkoIG5vZGVUeXBlICE9PSAxIHx8IGNvbnRleHQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSAhPT0gIm9iamVjdCIgKSApIHsNCg0KCQkJCW5ld1NlbGVjdG9yID0gc2VsZWN0b3I7DQoJCQkJbmV3Q29udGV4dCA9IGNvbnRleHQ7DQoNCgkJCQkvLyBxU0EgY29uc2lkZXJzIGVsZW1lbnRzIG91dHNpZGUgYSBzY29waW5nIHJvb3Qgd2hlbiBldmFsdWF0aW5nIGNoaWxkIG9yDQoJCQkJLy8gZGVzY2VuZGFudCBjb21iaW5hdG9ycywgd2hpY2ggaXMgbm90IHdoYXQgd2Ugd2FudC4NCgkJCQkvLyBJbiBzdWNoIGNhc2VzLCB3ZSB3b3JrIGFyb3VuZCB0aGUgYmVoYXZpb3IgYnkgcHJlZml4aW5nIGV2ZXJ5IHNlbGVjdG9yIGluIHRoZQ0KCQkJCS8vIGxpc3Qgd2l0aCBhbiBJRCBzZWxlY3RvciByZWZlcmVuY2luZyB0aGUgc2NvcGUgY29udGV4dC4NCgkJCQkvLyBUaGUgdGVjaG5pcXVlIGhhcyB0byBiZSB1c2VkIGFzIHdlbGwgd2hlbiBhIGxlYWRpbmcgY29tYmluYXRvciBpcyB1c2VkDQoJCQkJLy8gYXMgc3VjaCBzZWxlY3RvcnMgYXJlIG5vdCByZWNvZ25pemVkIGJ5IHF1ZXJ5U2VsZWN0b3JBbGwuDQoJCQkJLy8gVGhhbmtzIHRvIEFuZHJldyBEdXBvbnQgZm9yIHRoaXMgdGVjaG5pcXVlLg0KCQkJCWlmICggbm9kZVR5cGUgPT09IDEgJiYNCgkJCQkJKCByZGVzY2VuZC50ZXN0KCBzZWxlY3RvciApIHx8IHJjb21iaW5hdG9ycy50ZXN0KCBzZWxlY3RvciApICkgKSB7DQoNCgkJCQkJLy8gRXhwYW5kIGNvbnRleHQgZm9yIHNpYmxpbmcgc2VsZWN0b3JzDQoJCQkJCW5ld0NvbnRleHQgPSByc2libGluZy50ZXN0KCBzZWxlY3RvciApICYmIHRlc3RDb250ZXh0KCBjb250ZXh0LnBhcmVudE5vZGUgKSB8fA0KCQkJCQkJY29udGV4dDsNCg0KCQkJCQkvLyBXZSBjYW4gdXNlIDpzY29wZSBpbnN0ZWFkIG9mIHRoZSBJRCBoYWNrIGlmIHRoZSBicm93c2VyDQoJCQkJCS8vIHN1cHBvcnRzIGl0ICYgaWYgd2UncmUgbm90IGNoYW5naW5nIHRoZSBjb250ZXh0Lg0KCQkJCQlpZiAoIG5ld0NvbnRleHQgIT09IGNvbnRleHQgfHwgIXN1cHBvcnQuc2NvcGUgKSB7DQoNCgkJCQkJCS8vIENhcHR1cmUgdGhlIGNvbnRleHQgSUQsIHNldHRpbmcgaXQgZmlyc3QgaWYgbmVjZXNzYXJ5DQoJCQkJCQlpZiAoICggbmlkID0gY29udGV4dC5nZXRBdHRyaWJ1dGUoICJpZCIgKSApICkgew0KCQkJCQkJCW5pZCA9IG5pZC5yZXBsYWNlKCByY3NzZXNjYXBlLCBmY3NzZXNjYXBlICk7DQoJCQkJCQl9IGVsc2Ugew0KCQkJCQkJCWNvbnRleHQuc2V0QXR0cmlidXRlKCAiaWQiLCAoIG5pZCA9IGV4cGFuZG8gKSApOw0KCQkJCQkJfQ0KCQkJCQl9DQoNCgkJCQkJLy8gUHJlZml4IGV2ZXJ5IHNlbGVjdG9yIGluIHRoZSBsaXN0DQoJCQkJCWdyb3VwcyA9IHRva2VuaXplKCBzZWxlY3RvciApOw0KCQkJCQlpID0gZ3JvdXBzLmxlbmd0aDsNCgkJCQkJd2hpbGUgKCBpLS0gKSB7DQoJCQkJCQlncm91cHNbIGkgXSA9ICggbmlkID8gIiMiICsgbmlkIDogIjpzY29wZSIgKSArICIgIiArDQoJCQkJCQkJdG9TZWxlY3RvciggZ3JvdXBzWyBpIF0gKTsNCgkJCQkJfQ0KCQkJCQluZXdTZWxlY3RvciA9IGdyb3Vwcy5qb2luKCAiLCIgKTsNCgkJCQl9DQoNCgkJCQl0cnkgew0KCQkJCQlwdXNoLmFwcGx5KCByZXN1bHRzLA0KCQkJCQkJbmV3Q29udGV4dC5xdWVyeVNlbGVjdG9yQWxsKCBuZXdTZWxlY3RvciApDQoJCQkJCSk7DQoJCQkJCXJldHVybiByZXN1bHRzOw0KCQkJCX0gY2F0Y2ggKCBxc2FFcnJvciApIHsNCgkJCQkJbm9ubmF0aXZlU2VsZWN0b3JDYWNoZSggc2VsZWN0b3IsIHRydWUgKTsNCgkJCQl9IGZpbmFsbHkgew0KCQkJCQlpZiAoIG5pZCA9PT0gZXhwYW5kbyApIHsNCgkJCQkJCWNvbnRleHQucmVtb3ZlQXR0cmlidXRlKCAiaWQiICk7DQoJCQkJCX0NCgkJCQl9DQoJCQl9DQoJCX0NCgl9DQoNCgkvLyBBbGwgb3RoZXJzDQoJcmV0dXJuIHNlbGVjdCggc2VsZWN0b3IucmVwbGFjZSggcnRyaW0sICIkMSIgKSwgY29udGV4dCwgcmVzdWx0cywgc2VlZCApOw0KfQ0KDQovKioNCiAqIENyZWF0ZSBrZXktdmFsdWUgY2FjaGVzIG9mIGxpbWl0ZWQgc2l6ZQ0KICogQHJldHVybnMge2Z1bmN0aW9uKHN0cmluZywgb2JqZWN0KX0gUmV0dXJucyB0aGUgT2JqZWN0IGRhdGEgYWZ0ZXIgc3RvcmluZyBpdCBvbiBpdHNlbGYgd2l0aA0KICoJcHJvcGVydHkgbmFtZSB0aGUgKHNwYWNlLXN1ZmZpeGVkKSBzdHJpbmcgYW5kIChpZiB0aGUgY2FjaGUgaXMgbGFyZ2VyIHRoYW4gRXhwci5jYWNoZUxlbmd0aCkNCiAqCWRlbGV0aW5nIHRoZSBvbGRlc3QgZW50cnkNCiAqLw0KZnVuY3Rpb24gY3JlYXRlQ2FjaGUoKSB7DQoJdmFyIGtleXMgPSBbXTsNCg0KCWZ1bmN0aW9uIGNhY2hlKCBrZXksIHZhbHVlICkgew0KDQoJCS8vIFVzZSAoa2V5ICsgIiAiKSB0byBhdm9pZCBjb2xsaXNpb24gd2l0aCBuYXRpdmUgcHJvdG90eXBlIHByb3BlcnRpZXMgKHNlZSBJc3N1ZSAjMTU3KQ0KCQlpZiAoIGtleXMucHVzaCgga2V5ICsgIiAiICkgPiBFeHByLmNhY2hlTGVuZ3RoICkgew0KDQoJCQkvLyBPbmx5IGtlZXAgdGhlIG1vc3QgcmVjZW50IGVudHJpZXMNCgkJCWRlbGV0ZSBjYWNoZVsga2V5cy5zaGlmdCgpIF07DQoJCX0NCgkJcmV0dXJuICggY2FjaGVbIGtleSArICIgIiBdID0gdmFsdWUgKTsNCgl9DQoJcmV0dXJuIGNhY2hlOw0KfQ0KDQovKioNCiAqIE1hcmsgYSBmdW5jdGlvbiBmb3Igc3BlY2lhbCB1c2UgYnkgU2l6emxlDQogKiBAcGFyYW0ge0Z1bmN0aW9ufSBmbiBUaGUgZnVuY3Rpb24gdG8gbWFyaw0KICovDQpmdW5jdGlvbiBtYXJrRnVuY3Rpb24oIGZuICkgew0KCWZuWyBleHBhbmRvIF0gPSB0cnVlOw0KCXJldHVybiBmbjsNCn0NCg0KLyoqDQogKiBTdXBwb3J0IHRlc3RpbmcgdXNpbmcgYW4gZWxlbWVudA0KICogQHBhcmFtIHtGdW5jdGlvbn0gZm4gUGFzc2VkIHRoZSBjcmVhdGVkIGVsZW1lbnQgYW5kIHJldHVybnMgYSBib29sZWFuIHJlc3VsdA0KICovDQpmdW5jdGlvbiBhc3NlcnQoIGZuICkgew0KCXZhciBlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJmaWVsZHNldCIgKTsNCg0KCXRyeSB7DQoJCXJldHVybiAhIWZuKCBlbCApOw0KCX0gY2F0Y2ggKCBlICkgew0KCQlyZXR1cm4gZmFsc2U7DQoJfSBmaW5hbGx5IHsNCg0KCQkvLyBSZW1vdmUgZnJvbSBpdHMgcGFyZW50IGJ5IGRlZmF1bHQNCgkJaWYgKCBlbC5wYXJlbnROb2RlICkgew0KCQkJZWwucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCggZWwgKTsNCgkJfQ0KDQoJCS8vIHJlbGVhc2UgbWVtb3J5IGluIElFDQoJCWVsID0gbnVsbDsNCgl9DQp9DQoNCi8qKg0KICogQWRkcyB0aGUgc2FtZSBoYW5kbGVyIGZvciBhbGwgb2YgdGhlIHNwZWNpZmllZCBhdHRycw0KICogQHBhcmFtIHtTdHJpbmd9IGF0dHJzIFBpcGUtc2VwYXJhdGVkIGxpc3Qgb2YgYXR0cmlidXRlcw0KICogQHBhcmFtIHtGdW5jdGlvbn0gaGFuZGxlciBUaGUgbWV0aG9kIHRoYXQgd2lsbCBiZSBhcHBsaWVkDQogKi8NCmZ1bmN0aW9uIGFkZEhhbmRsZSggYXR0cnMsIGhhbmRsZXIgKSB7DQoJdmFyIGFyciA9IGF0dHJzLnNwbGl0KCAifCIgKSwNCgkJaSA9IGFyci5sZW5ndGg7DQoNCgl3aGlsZSAoIGktLSApIHsNCgkJRXhwci5hdHRySGFuZGxlWyBhcnJbIGkgXSBdID0gaGFuZGxlcjsNCgl9DQp9DQoNCi8qKg0KICogQ2hlY2tzIGRvY3VtZW50IG9yZGVyIG9mIHR3byBzaWJsaW5ncw0KICogQHBhcmFtIHtFbGVtZW50fSBhDQogKiBAcGFyYW0ge0VsZW1lbnR9IGINCiAqIEByZXR1cm5zIHtOdW1iZXJ9IFJldHVybnMgbGVzcyB0aGFuIDAgaWYgYSBwcmVjZWRlcyBiLCBncmVhdGVyIHRoYW4gMCBpZiBhIGZvbGxvd3MgYg0KICovDQpmdW5jdGlvbiBzaWJsaW5nQ2hlY2soIGEsIGIgKSB7DQoJdmFyIGN1ciA9IGIgJiYgYSwNCgkJZGlmZiA9IGN1ciAmJiBhLm5vZGVUeXBlID09PSAxICYmIGIubm9kZVR5cGUgPT09IDEgJiYNCgkJCWEuc291cmNlSW5kZXggLSBiLnNvdXJjZUluZGV4Ow0KDQoJLy8gVXNlIElFIHNvdXJjZUluZGV4IGlmIGF2YWlsYWJsZSBvbiBib3RoIG5vZGVzDQoJaWYgKCBkaWZmICkgew0KCQlyZXR1cm4gZGlmZjsNCgl9DQoNCgkvLyBDaGVjayBpZiBiIGZvbGxvd3MgYQ0KCWlmICggY3VyICkgew0KCQl3aGlsZSAoICggY3VyID0gY3VyLm5leHRTaWJsaW5nICkgKSB7DQoJCQlpZiAoIGN1ciA9PT0gYiApIHsNCgkJCQlyZXR1cm4gLTE7DQoJCQl9DQoJCX0NCgl9DQoNCglyZXR1cm4gYSA/IDEgOiAtMTsNCn0NCg0KLyoqDQogKiBSZXR1cm5zIGEgZnVuY3Rpb24gdG8gdXNlIGluIHBzZXVkb3MgZm9yIGlucHV0IHR5cGVzDQogKiBAcGFyYW0ge1N0cmluZ30gdHlwZQ0KICovDQpmdW5jdGlvbiBjcmVhdGVJbnB1dFBzZXVkbyggdHlwZSApIHsNCglyZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7DQoJCXZhciBuYW1lID0gZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOw0KCQlyZXR1cm4gbmFtZSA9PT0gImlucHV0IiAmJiBlbGVtLnR5cGUgPT09IHR5cGU7DQoJfTsNCn0NCg0KLyoqDQogKiBSZXR1cm5zIGEgZnVuY3Rpb24gdG8gdXNlIGluIHBzZXVkb3MgZm9yIGJ1dHRvbnMNCiAqIEBwYXJhbSB7U3RyaW5nfSB0eXBlDQogKi8NCmZ1bmN0aW9uIGNyZWF0ZUJ1dHRvblBzZXVkbyggdHlwZSApIHsNCglyZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7DQoJCXZhciBuYW1lID0gZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOw0KCQlyZXR1cm4gKCBuYW1lID09PSAiaW5wdXQiIHx8IG5hbWUgPT09ICJidXR0b24iICkgJiYgZWxlbS50eXBlID09PSB0eXBlOw0KCX07DQp9DQoNCi8qKg0KICogUmV0dXJucyBhIGZ1bmN0aW9uIHRvIHVzZSBpbiBwc2V1ZG9zIGZvciA6ZW5hYmxlZC86ZGlzYWJsZWQNCiAqIEBwYXJhbSB7Qm9vbGVhbn0gZGlzYWJsZWQgdHJ1ZSBmb3IgOmRpc2FibGVkOyBmYWxzZSBmb3IgOmVuYWJsZWQNCiAqLw0KZnVuY3Rpb24gY3JlYXRlRGlzYWJsZWRQc2V1ZG8oIGRpc2FibGVkICkgew0KDQoJLy8gS25vd24gOmRpc2FibGVkIGZhbHNlIHBvc2l0aXZlczogZmllbGRzZXRbZGlzYWJsZWRdID4gbGVnZW5kOm50aC1vZi10eXBlKG4rMikgOmNhbi1kaXNhYmxlDQoJcmV0dXJuIGZ1bmN0aW9uKCBlbGVtICkgew0KDQoJCS8vIE9ubHkgY2VydGFpbiBlbGVtZW50cyBjYW4gbWF0Y2ggOmVuYWJsZWQgb3IgOmRpc2FibGVkDQoJCS8vIGh0dHBzOi8vaHRtbC5zcGVjLndoYXR3Zy5vcmcvbXVsdGlwYWdlL3NjcmlwdGluZy5odG1sI3NlbGVjdG9yLWVuYWJsZWQNCgkJLy8gaHR0cHM6Ly9odG1sLnNwZWMud2hhdHdnLm9yZy9tdWx0aXBhZ2Uvc2NyaXB0aW5nLmh0bWwjc2VsZWN0b3ItZGlzYWJsZWQNCgkJaWYgKCAiZm9ybSIgaW4gZWxlbSApIHsNCg0KCQkJLy8gQ2hlY2sgZm9yIGluaGVyaXRlZCBkaXNhYmxlZG5lc3Mgb24gcmVsZXZhbnQgbm9uLWRpc2FibGVkIGVsZW1lbnRzOg0KCQkJLy8gKiBsaXN0ZWQgZm9ybS1hc3NvY2lhdGVkIGVsZW1lbnRzIGluIGEgZGlzYWJsZWQgZmllbGRzZXQNCgkJCS8vICAgaHR0cHM6Ly9odG1sLnNwZWMud2hhdHdnLm9yZy9tdWx0aXBhZ2UvZm9ybXMuaHRtbCNjYXRlZ29yeS1saXN0ZWQNCgkJCS8vICAgaHR0cHM6Ly9odG1sLnNwZWMud2hhdHdnLm9yZy9tdWx0aXBhZ2UvZm9ybXMuaHRtbCNjb25jZXB0LWZlLWRpc2FibGVkDQoJCQkvLyAqIG9wdGlvbiBlbGVtZW50cyBpbiBhIGRpc2FibGVkIG9wdGdyb3VwDQoJCQkvLyAgIGh0dHBzOi8vaHRtbC5zcGVjLndoYXR3Zy5vcmcvbXVsdGlwYWdlL2Zvcm1zLmh0bWwjY29uY2VwdC1vcHRpb24tZGlzYWJsZWQNCgkJCS8vIEFsbCBzdWNoIGVsZW1lbnRzIGhhdmUgYSAiZm9ybSIgcHJvcGVydHkuDQoJCQlpZiAoIGVsZW0ucGFyZW50Tm9kZSAmJiBlbGVtLmRpc2FibGVkID09PSBmYWxzZSApIHsNCg0KCQkJCS8vIE9wdGlvbiBlbGVtZW50cyBkZWZlciB0byBhIHBhcmVudCBvcHRncm91cCBpZiBwcmVzZW50DQoJCQkJaWYgKCAibGFiZWwiIGluIGVsZW0gKSB7DQoJCQkJCWlmICggImxhYmVsIiBpbiBlbGVtLnBhcmVudE5vZGUgKSB7DQoJCQkJCQlyZXR1cm4gZWxlbS5wYXJlbnROb2RlLmRpc2FibGVkID09PSBkaXNhYmxlZDsNCgkJCQkJfSBlbHNlIHsNCgkJCQkJCXJldHVybiBlbGVtLmRpc2FibGVkID09PSBkaXNhYmxlZDsNCgkJCQkJfQ0KCQkJCX0NCg0KCQkJCS8vIFN1cHBvcnQ6IElFIDYgLSAxMQ0KCQkJCS8vIFVzZSB0aGUgaXNEaXNhYmxlZCBzaG9ydGN1dCBwcm9wZXJ0eSB0byBjaGVjayBmb3IgZGlzYWJsZWQgZmllbGRzZXQgYW5jZXN0b3JzDQoJCQkJcmV0dXJuIGVsZW0uaXNEaXNhYmxlZCA9PT0gZGlzYWJsZWQgfHwNCg0KCQkJCQkvLyBXaGVyZSB0aGVyZSBpcyBubyBpc0Rpc2FibGVkLCBjaGVjayBtYW51YWxseQ0KCQkJCQkvKiBqc2hpbnQgLVcwMTggKi8NCgkJCQkJZWxlbS5pc0Rpc2FibGVkICE9PSAhZGlzYWJsZWQgJiYNCgkJCQkJaW5EaXNhYmxlZEZpZWxkc2V0KCBlbGVtICkgPT09IGRpc2FibGVkOw0KCQkJfQ0KDQoJCQlyZXR1cm4gZWxlbS5kaXNhYmxlZCA9PT0gZGlzYWJsZWQ7DQoNCgkJLy8gVHJ5IHRvIHdpbm5vdyBvdXQgZWxlbWVudHMgdGhhdCBjYW4ndCBiZSBkaXNhYmxlZCBiZWZvcmUgdHJ1c3RpbmcgdGhlIGRpc2FibGVkIHByb3BlcnR5Lg0KCQkvLyBTb21lIHZpY3RpbXMgZ2V0IGNhdWdodCBpbiBvdXIgbmV0IChsYWJlbCwgbGVnZW5kLCBtZW51LCB0cmFjayksIGJ1dCBpdCBzaG91bGRuJ3QNCgkJLy8gZXZlbiBleGlzdCBvbiB0aGVtLCBsZXQgYWxvbmUgaGF2ZSBhIGJvb2xlYW4gdmFsdWUuDQoJCX0gZWxzZSBpZiAoICJsYWJlbCIgaW4gZWxlbSApIHsNCgkJCXJldHVybiBlbGVtLmRpc2FibGVkID09PSBkaXNhYmxlZDsNCgkJfQ0KDQoJCS8vIFJlbWFpbmluZyBlbGVtZW50cyBhcmUgbmVpdGhlciA6ZW5hYmxlZCBub3IgOmRpc2FibGVkDQoJCXJldHVybiBmYWxzZTsNCgl9Ow0KfQ0KDQovKioNCiAqIFJldHVybnMgYSBmdW5jdGlvbiB0byB1c2UgaW4gcHNldWRvcyBmb3IgcG9zaXRpb25hbHMNCiAqIEBwYXJhbSB7RnVuY3Rpb259IGZuDQogKi8NCmZ1bmN0aW9uIGNyZWF0ZVBvc2l0aW9uYWxQc2V1ZG8oIGZuICkgew0KCXJldHVybiBtYXJrRnVuY3Rpb24oIGZ1bmN0aW9uKCBhcmd1bWVudCApIHsNCgkJYXJndW1lbnQgPSArYXJndW1lbnQ7DQoJCXJldHVybiBtYXJrRnVuY3Rpb24oIGZ1bmN0aW9uKCBzZWVkLCBtYXRjaGVzICkgew0KCQkJdmFyIGosDQoJCQkJbWF0Y2hJbmRleGVzID0gZm4oIFtdLCBzZWVkLmxlbmd0aCwgYXJndW1lbnQgKSwNCgkJCQlpID0gbWF0Y2hJbmRleGVzLmxlbmd0aDsNCg0KCQkJLy8gTWF0Y2ggZWxlbWVudHMgZm91bmQgYXQgdGhlIHNwZWNpZmllZCBpbmRleGVzDQoJCQl3aGlsZSAoIGktLSApIHsNCgkJCQlpZiAoIHNlZWRbICggaiA9IG1hdGNoSW5kZXhlc1sgaSBdICkgXSApIHsNCgkJCQkJc2VlZFsgaiBdID0gISggbWF0Y2hlc1sgaiBdID0gc2VlZFsgaiBdICk7DQoJCQkJfQ0KCQkJfQ0KCQl9ICk7DQoJfSApOw0KfQ0KDQovKioNCiAqIENoZWNrcyBhIG5vZGUgZm9yIHZhbGlkaXR5IGFzIGEgU2l6emxlIGNvbnRleHQNCiAqIEBwYXJhbSB7RWxlbWVudHxPYmplY3Q9fSBjb250ZXh0DQogKiBAcmV0dXJucyB7RWxlbWVudHxPYmplY3R8Qm9vbGVhbn0gVGhlIGlucHV0IG5vZGUgaWYgYWNjZXB0YWJsZSwgb3RoZXJ3aXNlIGEgZmFsc3kgdmFsdWUNCiAqLw0KZnVuY3Rpb24gdGVzdENvbnRleHQoIGNvbnRleHQgKSB7DQoJcmV0dXJuIGNvbnRleHQgJiYgdHlwZW9mIGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUgIT09ICJ1bmRlZmluZWQiICYmIGNvbnRleHQ7DQp9DQoNCi8vIEV4cG9zZSBzdXBwb3J0IHZhcnMgZm9yIGNvbnZlbmllbmNlDQpzdXBwb3J0ID0gU2l6emxlLnN1cHBvcnQgPSB7fTsNCg0KLyoqDQogKiBEZXRlY3RzIFhNTCBub2Rlcw0KICogQHBhcmFtIHtFbGVtZW50fE9iamVjdH0gZWxlbSBBbiBlbGVtZW50IG9yIGEgZG9jdW1lbnQNCiAqIEByZXR1cm5zIHtCb29sZWFufSBUcnVlIGlmZiBlbGVtIGlzIGEgbm9uLUhUTUwgWE1MIG5vZGUNCiAqLw0KaXNYTUwgPSBTaXp6bGUuaXNYTUwgPSBmdW5jdGlvbiggZWxlbSApIHsNCgl2YXIgbmFtZXNwYWNlID0gZWxlbSAmJiBlbGVtLm5hbWVzcGFjZVVSSSwNCgkJZG9jRWxlbSA9IGVsZW0gJiYgKCBlbGVtLm93bmVyRG9jdW1lbnQgfHwgZWxlbSApLmRvY3VtZW50RWxlbWVudDsNCg0KCS8vIFN1cHBvcnQ6IElFIDw9OA0KCS8vIEFzc3VtZSBIVE1MIHdoZW4gZG9jdW1lbnRFbGVtZW50IGRvZXNuJ3QgeWV0IGV4aXN0LCBzdWNoIGFzIGluc2lkZSBsb2FkaW5nIGlmcmFtZXMNCgkvLyBodHRwczovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvNDgzMw0KCXJldHVybiAhcmh0bWwudGVzdCggbmFtZXNwYWNlIHx8IGRvY0VsZW0gJiYgZG9jRWxlbS5ub2RlTmFtZSB8fCAiSFRNTCIgKTsNCn07DQoNCi8qKg0KICogU2V0cyBkb2N1bWVudC1yZWxhdGVkIHZhcmlhYmxlcyBvbmNlIGJhc2VkIG9uIHRoZSBjdXJyZW50IGRvY3VtZW50DQogKiBAcGFyYW0ge0VsZW1lbnR8T2JqZWN0fSBbZG9jXSBBbiBlbGVtZW50IG9yIGRvY3VtZW50IG9iamVjdCB0byB1c2UgdG8gc2V0IHRoZSBkb2N1bWVudA0KICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyB0aGUgY3VycmVudCBkb2N1bWVudA0KICovDQpzZXREb2N1bWVudCA9IFNpenpsZS5zZXREb2N1bWVudCA9IGZ1bmN0aW9uKCBub2RlICkgew0KCXZhciBoYXNDb21wYXJlLCBzdWJXaW5kb3csDQoJCWRvYyA9IG5vZGUgPyBub2RlLm93bmVyRG9jdW1lbnQgfHwgbm9kZSA6IHByZWZlcnJlZERvYzsNCg0KCS8vIFJldHVybiBlYXJseSBpZiBkb2MgaXMgaW52YWxpZCBvciBhbHJlYWR5IHNlbGVjdGVkDQoJLy8gU3VwcG9ydDogSUUgMTErLCBFZGdlIDE3IC0gMTgrDQoJLy8gSUUvRWRnZSBzb21ldGltZXMgdGhyb3cgYSAiUGVybWlzc2lvbiBkZW5pZWQiIGVycm9yIHdoZW4gc3RyaWN0LWNvbXBhcmluZw0KCS8vIHR3byBkb2N1bWVudHM7IHNoYWxsb3cgY29tcGFyaXNvbnMgd29yay4NCgkvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgZXFlcWVxDQoJaWYgKCBkb2MgPT0gZG9jdW1lbnQgfHwgZG9jLm5vZGVUeXBlICE9PSA5IHx8ICFkb2MuZG9jdW1lbnRFbGVtZW50ICkgew0KCQlyZXR1cm4gZG9jdW1lbnQ7DQoJfQ0KDQoJLy8gVXBkYXRlIGdsb2JhbCB2YXJpYWJsZXMNCglkb2N1bWVudCA9IGRvYzsNCglkb2NFbGVtID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50Ow0KCWRvY3VtZW50SXNIVE1MID0gIWlzWE1MKCBkb2N1bWVudCApOw0KDQoJLy8gU3VwcG9ydDogSUUgOSAtIDExKywgRWRnZSAxMiAtIDE4Kw0KCS8vIEFjY2Vzc2luZyBpZnJhbWUgZG9jdW1lbnRzIGFmdGVyIHVubG9hZCB0aHJvd3MgInBlcm1pc3Npb24gZGVuaWVkIiBlcnJvcnMgKGpRdWVyeSAjMTM5MzYpDQoJLy8gU3VwcG9ydDogSUUgMTErLCBFZGdlIDE3IC0gMTgrDQoJLy8gSUUvRWRnZSBzb21ldGltZXMgdGhyb3cgYSAiUGVybWlzc2lvbiBkZW5pZWQiIGVycm9yIHdoZW4gc3RyaWN0LWNvbXBhcmluZw0KCS8vIHR3byBkb2N1bWVudHM7IHNoYWxsb3cgY29tcGFyaXNvbnMgd29yay4NCgkvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgZXFlcWVxDQoJaWYgKCBwcmVmZXJyZWREb2MgIT0gZG9jdW1lbnQgJiYNCgkJKCBzdWJXaW5kb3cgPSBkb2N1bWVudC5kZWZhdWx0VmlldyApICYmIHN1YldpbmRvdy50b3AgIT09IHN1YldpbmRvdyApIHsNCg0KCQkvLyBTdXBwb3J0OiBJRSAxMSwgRWRnZQ0KCQlpZiAoIHN1YldpbmRvdy5hZGRFdmVudExpc3RlbmVyICkgew0KCQkJc3ViV2luZG93LmFkZEV2ZW50TGlzdGVuZXIoICJ1bmxvYWQiLCB1bmxvYWRIYW5kbGVyLCBmYWxzZSApOw0KDQoJCS8vIFN1cHBvcnQ6IElFIDkgLSAxMCBvbmx5DQoJCX0gZWxzZSBpZiAoIHN1YldpbmRvdy5hdHRhY2hFdmVudCApIHsNCgkJCXN1YldpbmRvdy5hdHRhY2hFdmVudCggIm9udW5sb2FkIiwgdW5sb2FkSGFuZGxlciApOw0KCQl9DQoJfQ0KDQoJLy8gU3VwcG9ydDogSUUgOCAtIDExKywgRWRnZSAxMiAtIDE4KywgQ2hyb21lIDw9MTYgLSAyNSBvbmx5LCBGaXJlZm94IDw9My42IC0gMzEgb25seSwNCgkvLyBTYWZhcmkgNCAtIDUgb25seSwgT3BlcmEgPD0xMS42IC0gMTIueCBvbmx5DQoJLy8gSUUvRWRnZSAmIG9sZGVyIGJyb3dzZXJzIGRvbid0IHN1cHBvcnQgdGhlIDpzY29wZSBwc2V1ZG8tY2xhc3MuDQoJLy8gU3VwcG9ydDogU2FmYXJpIDYuMCBvbmx5DQoJLy8gU2FmYXJpIDYuMCBzdXBwb3J0cyA6c2NvcGUgYnV0IGl0J3MgYW4gYWxpYXMgb2YgOnJvb3QgdGhlcmUuDQoJc3VwcG9ydC5zY29wZSA9IGFzc2VydCggZnVuY3Rpb24oIGVsICkgew0KCQlkb2NFbGVtLmFwcGVuZENoaWxkKCBlbCApLmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApICk7DQoJCXJldHVybiB0eXBlb2YgZWwucXVlcnlTZWxlY3RvckFsbCAhPT0gInVuZGVmaW5lZCIgJiYNCgkJCSFlbC5xdWVyeVNlbGVjdG9yQWxsKCAiOnNjb3BlIGZpZWxkc2V0IGRpdiIgKS5sZW5ndGg7DQoJfSApOw0KDQoJLyogQXR0cmlidXRlcw0KCS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gKi8NCg0KCS8vIFN1cHBvcnQ6IElFPDgNCgkvLyBWZXJpZnkgdGhhdCBnZXRBdHRyaWJ1dGUgcmVhbGx5IHJldHVybnMgYXR0cmlidXRlcyBhbmQgbm90IHByb3BlcnRpZXMNCgkvLyAoZXhjZXB0aW5nIElFOCBib29sZWFucykNCglzdXBwb3J0LmF0dHJpYnV0ZXMgPSBhc3NlcnQoIGZ1bmN0aW9uKCBlbCApIHsNCgkJZWwuY2xhc3NOYW1lID0gImkiOw0KCQlyZXR1cm4gIWVsLmdldEF0dHJpYnV0ZSggImNsYXNzTmFtZSIgKTsNCgl9ICk7DQoNCgkvKiBnZXRFbGVtZW50KHMpQnkqDQoJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAqLw0KDQoJLy8gQ2hlY2sgaWYgZ2V0RWxlbWVudHNCeVRhZ05hbWUoIioiKSByZXR1cm5zIG9ubHkgZWxlbWVudHMNCglzdXBwb3J0LmdldEVsZW1lbnRzQnlUYWdOYW1lID0gYXNzZXJ0KCBmdW5jdGlvbiggZWwgKSB7DQoJCWVsLmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVDb21tZW50KCAiIiApICk7DQoJCXJldHVybiAhZWwuZ2V0RWxlbWVudHNCeVRhZ05hbWUoICIqIiApLmxlbmd0aDsNCgl9ICk7DQoNCgkvLyBTdXBwb3J0OiBJRTw5DQoJc3VwcG9ydC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lID0gcm5hdGl2ZS50ZXN0KCBkb2N1bWVudC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lICk7DQoNCgkvLyBTdXBwb3J0OiBJRTwxMA0KCS8vIENoZWNrIGlmIGdldEVsZW1lbnRCeUlkIHJldHVybnMgZWxlbWVudHMgYnkgbmFtZQ0KCS8vIFRoZSBicm9rZW4gZ2V0RWxlbWVudEJ5SWQgbWV0aG9kcyBkb24ndCBwaWNrIHVwIHByb2dyYW1tYXRpY2FsbHktc2V0IG5hbWVzLA0KCS8vIHNvIHVzZSBhIHJvdW5kYWJvdXQgZ2V0RWxlbWVudHNCeU5hbWUgdGVzdA0KCXN1cHBvcnQuZ2V0QnlJZCA9IGFzc2VydCggZnVuY3Rpb24oIGVsICkgew0KCQlkb2NFbGVtLmFwcGVuZENoaWxkKCBlbCApLmlkID0gZXhwYW5kbzsNCgkJcmV0dXJuICFkb2N1bWVudC5nZXRFbGVtZW50c0J5TmFtZSB8fCAhZG9jdW1lbnQuZ2V0RWxlbWVudHNCeU5hbWUoIGV4cGFuZG8gKS5sZW5ndGg7DQoJfSApOw0KDQoJLy8gSUQgZmlsdGVyIGFuZCBmaW5kDQoJaWYgKCBzdXBwb3J0LmdldEJ5SWQgKSB7DQoJCUV4cHIuZmlsdGVyWyAiSUQiIF0gPSBmdW5jdGlvbiggaWQgKSB7DQoJCQl2YXIgYXR0cklkID0gaWQucmVwbGFjZSggcnVuZXNjYXBlLCBmdW5lc2NhcGUgKTsNCgkJCXJldHVybiBmdW5jdGlvbiggZWxlbSApIHsNCgkJCQlyZXR1cm4gZWxlbS5nZXRBdHRyaWJ1dGUoICJpZCIgKSA9PT0gYXR0cklkOw0KCQkJfTsNCgkJfTsNCgkJRXhwci5maW5kWyAiSUQiIF0gPSBmdW5jdGlvbiggaWQsIGNvbnRleHQgKSB7DQoJCQlpZiAoIHR5cGVvZiBjb250ZXh0LmdldEVsZW1lbnRCeUlkICE9PSAidW5kZWZpbmVkIiAmJiBkb2N1bWVudElzSFRNTCApIHsNCgkJCQl2YXIgZWxlbSA9IGNvbnRleHQuZ2V0RWxlbWVudEJ5SWQoIGlkICk7DQoJCQkJcmV0dXJuIGVsZW0gPyBbIGVsZW0gXSA6IFtdOw0KCQkJfQ0KCQl9Ow0KCX0gZWxzZSB7DQoJCUV4cHIuZmlsdGVyWyAiSUQiIF0gPSAgZnVuY3Rpb24oIGlkICkgew0KCQkJdmFyIGF0dHJJZCA9IGlkLnJlcGxhY2UoIHJ1bmVzY2FwZSwgZnVuZXNjYXBlICk7DQoJCQlyZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7DQoJCQkJdmFyIG5vZGUgPSB0eXBlb2YgZWxlbS5nZXRBdHRyaWJ1dGVOb2RlICE9PSAidW5kZWZpbmVkIiAmJg0KCQkJCQllbGVtLmdldEF0dHJpYnV0ZU5vZGUoICJpZCIgKTsNCgkJCQlyZXR1cm4gbm9kZSAmJiBub2RlLnZhbHVlID09PSBhdHRySWQ7DQoJCQl9Ow0KCQl9Ow0KDQoJCS8vIFN1cHBvcnQ6IElFIDYgLSA3IG9ubHkNCgkJLy8gZ2V0RWxlbWVudEJ5SWQgaXMgbm90IHJlbGlhYmxlIGFzIGEgZmluZCBzaG9ydGN1dA0KCQlFeHByLmZpbmRbICJJRCIgXSA9IGZ1bmN0aW9uKCBpZCwgY29udGV4dCApIHsNCgkJCWlmICggdHlwZW9mIGNvbnRleHQuZ2V0RWxlbWVudEJ5SWQgIT09ICJ1bmRlZmluZWQiICYmIGRvY3VtZW50SXNIVE1MICkgew0KCQkJCXZhciBub2RlLCBpLCBlbGVtcywNCgkJCQkJZWxlbSA9IGNvbnRleHQuZ2V0RWxlbWVudEJ5SWQoIGlkICk7DQoNCgkJCQlpZiAoIGVsZW0gKSB7DQoNCgkJCQkJLy8gVmVyaWZ5IHRoZSBpZCBhdHRyaWJ1dGUNCgkJCQkJbm9kZSA9IGVsZW0uZ2V0QXR0cmlidXRlTm9kZSggImlkIiApOw0KCQkJCQlpZiAoIG5vZGUgJiYgbm9kZS52YWx1ZSA9PT0gaWQgKSB7DQoJCQkJCQlyZXR1cm4gWyBlbGVtIF07DQoJCQkJCX0NCg0KCQkJCQkvLyBGYWxsIGJhY2sgb24gZ2V0RWxlbWVudHNCeU5hbWUNCgkJCQkJZWxlbXMgPSBjb250ZXh0LmdldEVsZW1lbnRzQnlOYW1lKCBpZCApOw0KCQkJCQlpID0gMDsNCgkJCQkJd2hpbGUgKCAoIGVsZW0gPSBlbGVtc1sgaSsrIF0gKSApIHsNCgkJCQkJCW5vZGUgPSBlbGVtLmdldEF0dHJpYnV0ZU5vZGUoICJpZCIgKTsNCgkJCQkJCWlmICggbm9kZSAmJiBub2RlLnZhbHVlID09PSBpZCApIHsNCgkJCQkJCQlyZXR1cm4gWyBlbGVtIF07DQoJCQkJCQl9DQoJCQkJCX0NCgkJCQl9DQoNCgkJCQlyZXR1cm4gW107DQoJCQl9DQoJCX07DQoJfQ0KDQoJLy8gVGFnDQoJRXhwci5maW5kWyAiVEFHIiBdID0gc3VwcG9ydC5nZXRFbGVtZW50c0J5VGFnTmFtZSA/DQoJCWZ1bmN0aW9uKCB0YWcsIGNvbnRleHQgKSB7DQoJCQlpZiAoIHR5cGVvZiBjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lICE9PSAidW5kZWZpbmVkIiApIHsNCgkJCQlyZXR1cm4gY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSggdGFnICk7DQoNCgkJCS8vIERvY3VtZW50RnJhZ21lbnQgbm9kZXMgZG9uJ3QgaGF2ZSBnRUJUTg0KCQkJfSBlbHNlIGlmICggc3VwcG9ydC5xc2EgKSB7DQoJCQkJcmV0dXJuIGNvbnRleHQucXVlcnlTZWxlY3RvckFsbCggdGFnICk7DQoJCQl9DQoJCX0gOg0KDQoJCWZ1bmN0aW9uKCB0YWcsIGNvbnRleHQgKSB7DQoJCQl2YXIgZWxlbSwNCgkJCQl0bXAgPSBbXSwNCgkJCQlpID0gMCwNCg0KCQkJCS8vIEJ5IGhhcHB5IGNvaW5jaWRlbmNlLCBhIChicm9rZW4pIGdFQlROIGFwcGVhcnMgb24gRG9jdW1lbnRGcmFnbWVudCBub2RlcyB0b28NCgkJCQlyZXN1bHRzID0gY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSggdGFnICk7DQoNCgkJCS8vIEZpbHRlciBvdXQgcG9zc2libGUgY29tbWVudHMNCgkJCWlmICggdGFnID09PSAiKiIgKSB7DQoJCQkJd2hpbGUgKCAoIGVsZW0gPSByZXN1bHRzWyBpKysgXSApICkgew0KCQkJCQlpZiAoIGVsZW0ubm9kZVR5cGUgPT09IDEgKSB7DQoJCQkJCQl0bXAucHVzaCggZWxlbSApOw0KCQkJCQl9DQoJCQkJfQ0KDQoJCQkJcmV0dXJuIHRtcDsNCgkJCX0NCgkJCXJldHVybiByZXN1bHRzOw0KCQl9Ow0KDQoJLy8gQ2xhc3MNCglFeHByLmZpbmRbICJDTEFTUyIgXSA9IHN1cHBvcnQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSAmJiBmdW5jdGlvbiggY2xhc3NOYW1lLCBjb250ZXh0ICkgew0KCQlpZiAoIHR5cGVvZiBjb250ZXh0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUgIT09ICJ1bmRlZmluZWQiICYmIGRvY3VtZW50SXNIVE1MICkgew0KCQkJcmV0dXJuIGNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSggY2xhc3NOYW1lICk7DQoJCX0NCgl9Ow0KDQoJLyogUVNBL21hdGNoZXNTZWxlY3Rvcg0KCS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gKi8NCg0KCS8vIFFTQSBhbmQgbWF0Y2hlc1NlbGVjdG9yIHN1cHBvcnQNCg0KCS8vIG1hdGNoZXNTZWxlY3Rvcig6YWN0aXZlKSByZXBvcnRzIGZhbHNlIHdoZW4gdHJ1ZSAoSUU5L09wZXJhIDExLjUpDQoJcmJ1Z2d5TWF0Y2hlcyA9IFtdOw0KDQoJLy8gcVNhKDpmb2N1cykgcmVwb3J0cyBmYWxzZSB3aGVuIHRydWUgKENocm9tZSAyMSkNCgkvLyBXZSBhbGxvdyB0aGlzIGJlY2F1c2Ugb2YgYSBidWcgaW4gSUU4LzkgdGhhdCB0aHJvd3MgYW4gZXJyb3INCgkvLyB3aGVuZXZlciBgZG9jdW1lbnQuYWN0aXZlRWxlbWVudGAgaXMgYWNjZXNzZWQgb24gYW4gaWZyYW1lDQoJLy8gU28sIHdlIGFsbG93IDpmb2N1cyB0byBwYXNzIHRocm91Z2ggUVNBIGFsbCB0aGUgdGltZSB0byBhdm9pZCB0aGUgSUUgZXJyb3INCgkvLyBTZWUgaHR0cHM6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0LzEzMzc4DQoJcmJ1Z2d5UVNBID0gW107DQoNCglpZiAoICggc3VwcG9ydC5xc2EgPSBybmF0aXZlLnRlc3QoIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwgKSApICkgew0KDQoJCS8vIEJ1aWxkIFFTQSByZWdleA0KCQkvLyBSZWdleCBzdHJhdGVneSBhZG9wdGVkIGZyb20gRGllZ28gUGVyaW5pDQoJCWFzc2VydCggZnVuY3Rpb24oIGVsICkgew0KDQoJCQl2YXIgaW5wdXQ7DQoNCgkJCS8vIFNlbGVjdCBpcyBzZXQgdG8gZW1wdHkgc3RyaW5nIG9uIHB1cnBvc2UNCgkJCS8vIFRoaXMgaXMgdG8gdGVzdCBJRSdzIHRyZWF0bWVudCBvZiBub3QgZXhwbGljaXRseQ0KCQkJLy8gc2V0dGluZyBhIGJvb2xlYW4gY29udGVudCBhdHRyaWJ1dGUsDQoJCQkvLyBzaW5jZSBpdHMgcHJlc2VuY2Ugc2hvdWxkIGJlIGVub3VnaA0KCQkJLy8gaHR0cHM6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0LzEyMzU5DQoJCQlkb2NFbGVtLmFwcGVuZENoaWxkKCBlbCApLmlubmVySFRNTCA9ICI8YSBpZD0nIiArIGV4cGFuZG8gKyAiJz48L2E+IiArDQoJCQkJIjxzZWxlY3QgaWQ9JyIgKyBleHBhbmRvICsgIi1cclxcJyBtc2FsbG93Y2FwdHVyZT0nJz4iICsNCgkJCQkiPG9wdGlvbiBzZWxlY3RlZD0nJz48L29wdGlvbj48L3NlbGVjdD4iOw0KDQoJCQkvLyBTdXBwb3J0OiBJRTgsIE9wZXJhIDExLTEyLjE2DQoJCQkvLyBOb3RoaW5nIHNob3VsZCBiZSBzZWxlY3RlZCB3aGVuIGVtcHR5IHN0cmluZ3MgZm9sbG93IF49IG9yICQ9IG9yICo9DQoJCQkvLyBUaGUgdGVzdCBhdHRyaWJ1dGUgbXVzdCBiZSB1bmtub3duIGluIE9wZXJhIGJ1dCAic2FmZSIgZm9yIFdpblJUDQoJCQkvLyBodHRwczovL21zZG4ubWljcm9zb2Z0LmNvbS9lbi11cy9saWJyYXJ5L2llL2hoNDY1Mzg4LmFzcHgjYXR0cmlidXRlX3NlY3Rpb24NCgkJCWlmICggZWwucXVlcnlTZWxlY3RvckFsbCggIlttc2FsbG93Y2FwdHVyZV49JyddIiApLmxlbmd0aCApIHsNCgkJCQlyYnVnZ3lRU0EucHVzaCggIlsqXiRdPSIgKyB3aGl0ZXNwYWNlICsgIiooPzonJ3xcIlwiKSIgKTsNCgkJCX0NCg0KCQkJLy8gU3VwcG9ydDogSUU4DQoJCQkvLyBCb29sZWFuIGF0dHJpYnV0ZXMgYW5kICJ2YWx1ZSIgYXJlIG5vdCB0cmVhdGVkIGNvcnJlY3RseQ0KCQkJaWYgKCAhZWwucXVlcnlTZWxlY3RvckFsbCggIltzZWxlY3RlZF0iICkubGVuZ3RoICkgew0KCQkJCXJidWdneVFTQS5wdXNoKCAiXFxbIiArIHdoaXRlc3BhY2UgKyAiKig/OnZhbHVlfCIgKyBib29sZWFucyArICIpIiApOw0KCQkJfQ0KDQoJCQkvLyBTdXBwb3J0OiBDaHJvbWU8MjksIEFuZHJvaWQ8NC40LCBTYWZhcmk8Ny4wKywgaU9TPDcuMCssIFBoYW50b21KUzwxLjkuOCsNCgkJCWlmICggIWVsLnF1ZXJ5U2VsZWN0b3JBbGwoICJbaWR+PSIgKyBleHBhbmRvICsgIi1dIiApLmxlbmd0aCApIHsNCgkJCQlyYnVnZ3lRU0EucHVzaCggIn49IiApOw0KCQkJfQ0KDQoJCQkvLyBTdXBwb3J0OiBJRSAxMSssIEVkZ2UgMTUgLSAxOCsNCgkJCS8vIElFIDExL0VkZ2UgZG9uJ3QgZmluZCBlbGVtZW50cyBvbiBhIGBbbmFtZT0nJ11gIHF1ZXJ5IGluIHNvbWUgY2FzZXMuDQoJCQkvLyBBZGRpbmcgYSB0ZW1wb3JhcnkgYXR0cmlidXRlIHRvIHRoZSBkb2N1bWVudCBiZWZvcmUgdGhlIHNlbGVjdGlvbiB3b3Jrcw0KCQkJLy8gYXJvdW5kIHRoZSBpc3N1ZS4NCgkJCS8vIEludGVyZXN0aW5nbHksIElFIDEwICYgb2xkZXIgZG9uJ3Qgc2VlbSB0byBoYXZlIHRoZSBpc3N1ZS4NCgkJCWlucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImlucHV0IiApOw0KCQkJaW5wdXQuc2V0QXR0cmlidXRlKCAibmFtZSIsICIiICk7DQoJCQllbC5hcHBlbmRDaGlsZCggaW5wdXQgKTsNCgkJCWlmICggIWVsLnF1ZXJ5U2VsZWN0b3JBbGwoICJbbmFtZT0nJ10iICkubGVuZ3RoICkgew0KCQkJCXJidWdneVFTQS5wdXNoKCAiXFxbIiArIHdoaXRlc3BhY2UgKyAiKm5hbWUiICsgd2hpdGVzcGFjZSArICIqPSIgKw0KCQkJCQl3aGl0ZXNwYWNlICsgIiooPzonJ3xcIlwiKSIgKTsNCgkJCX0NCg0KCQkJLy8gV2Via2l0L09wZXJhIC0gOmNoZWNrZWQgc2hvdWxkIHJldHVybiBzZWxlY3RlZCBvcHRpb24gZWxlbWVudHMNCgkJCS8vIGh0dHA6Ly93d3cudzMub3JnL1RSLzIwMTEvUkVDLWNzczMtc2VsZWN0b3JzLTIwMTEwOTI5LyNjaGVja2VkDQoJCQkvLyBJRTggdGhyb3dzIGVycm9yIGhlcmUgYW5kIHdpbGwgbm90IHNlZSBsYXRlciB0ZXN0cw0KCQkJaWYgKCAhZWwucXVlcnlTZWxlY3RvckFsbCggIjpjaGVja2VkIiApLmxlbmd0aCApIHsNCgkJCQlyYnVnZ3lRU0EucHVzaCggIjpjaGVja2VkIiApOw0KCQkJfQ0KDQoJCQkvLyBTdXBwb3J0OiBTYWZhcmkgOCssIGlPUyA4Kw0KCQkJLy8gaHR0cHM6Ly9idWdzLndlYmtpdC5vcmcvc2hvd19idWcuY2dpP2lkPTEzNjg1MQ0KCQkJLy8gSW4tcGFnZSBgc2VsZWN0b3IjaWQgc2libGluZy1jb21iaW5hdG9yIHNlbGVjdG9yYCBmYWlscw0KCQkJaWYgKCAhZWwucXVlcnlTZWxlY3RvckFsbCggImEjIiArIGV4cGFuZG8gKyAiKyoiICkubGVuZ3RoICkgew0KCQkJCXJidWdneVFTQS5wdXNoKCAiLiMuK1srfl0iICk7DQoJCQl9DQoNCgkJCS8vIFN1cHBvcnQ6IEZpcmVmb3ggPD0zLjYgLSA1IG9ubHkNCgkJCS8vIE9sZCBGaXJlZm94IGRvZXNuJ3QgdGhyb3cgb24gYSBiYWRseS1lc2NhcGVkIGlkZW50aWZpZXIuDQoJCQllbC5xdWVyeVNlbGVjdG9yQWxsKCAiXFxcZiIgKTsNCgkJCXJidWdneVFTQS5wdXNoKCAiW1xcclxcblxcZl0iICk7DQoJCX0gKTsNCg0KCQlhc3NlcnQoIGZ1bmN0aW9uKCBlbCApIHsNCgkJCWVsLmlubmVySFRNTCA9ICI8YSBocmVmPScnIGRpc2FibGVkPSdkaXNhYmxlZCc+PC9hPiIgKw0KCQkJCSI8c2VsZWN0IGRpc2FibGVkPSdkaXNhYmxlZCc+PG9wdGlvbi8+PC9zZWxlY3Q+IjsNCg0KCQkJLy8gU3VwcG9ydDogV2luZG93cyA4IE5hdGl2ZSBBcHBzDQoJCQkvLyBUaGUgdHlwZSBhbmQgbmFtZSBhdHRyaWJ1dGVzIGFyZSByZXN0cmljdGVkIGR1cmluZyAuaW5uZXJIVE1MIGFzc2lnbm1lbnQNCgkJCXZhciBpbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJpbnB1dCIgKTsNCgkJCWlucHV0LnNldEF0dHJpYnV0ZSggInR5cGUiLCAiaGlkZGVuIiApOw0KCQkJZWwuYXBwZW5kQ2hpbGQoIGlucHV0ICkuc2V0QXR0cmlidXRlKCAibmFtZSIsICJEIiApOw0KDQoJCQkvLyBTdXBwb3J0OiBJRTgNCgkJCS8vIEVuZm9yY2UgY2FzZS1zZW5zaXRpdml0eSBvZiBuYW1lIGF0dHJpYnV0ZQ0KCQkJaWYgKCBlbC5xdWVyeVNlbGVjdG9yQWxsKCAiW25hbWU9ZF0iICkubGVuZ3RoICkgew0KCQkJCXJidWdneVFTQS5wdXNoKCAibmFtZSIgKyB3aGl0ZXNwYWNlICsgIipbKl4kfCF+XT89IiApOw0KCQkJfQ0KDQoJCQkvLyBGRiAzLjUgLSA6ZW5hYmxlZC86ZGlzYWJsZWQgYW5kIGhpZGRlbiBlbGVtZW50cyAoaGlkZGVuIGVsZW1lbnRzIGFyZSBzdGlsbCBlbmFibGVkKQ0KCQkJLy8gSUU4IHRocm93cyBlcnJvciBoZXJlIGFuZCB3aWxsIG5vdCBzZWUgbGF0ZXIgdGVzdHMNCgkJCWlmICggZWwucXVlcnlTZWxlY3RvckFsbCggIjplbmFibGVkIiApLmxlbmd0aCAhPT0gMiApIHsNCgkJCQlyYnVnZ3lRU0EucHVzaCggIjplbmFibGVkIiwgIjpkaXNhYmxlZCIgKTsNCgkJCX0NCg0KCQkJLy8gU3VwcG9ydDogSUU5LTExKw0KCQkJLy8gSUUncyA6ZGlzYWJsZWQgc2VsZWN0b3IgZG9lcyBub3QgcGljayB1cCB0aGUgY2hpbGRyZW4gb2YgZGlzYWJsZWQgZmllbGRzZXRzDQoJCQlkb2NFbGVtLmFwcGVuZENoaWxkKCBlbCApLmRpc2FibGVkID0gdHJ1ZTsNCgkJCWlmICggZWwucXVlcnlTZWxlY3RvckFsbCggIjpkaXNhYmxlZCIgKS5sZW5ndGggIT09IDIgKSB7DQoJCQkJcmJ1Z2d5UVNBLnB1c2goICI6ZW5hYmxlZCIsICI6ZGlzYWJsZWQiICk7DQoJCQl9DQoNCgkJCS8vIFN1cHBvcnQ6IE9wZXJhIDEwIC0gMTEgb25seQ0KCQkJLy8gT3BlcmEgMTAtMTEgZG9lcyBub3QgdGhyb3cgb24gcG9zdC1jb21tYSBpbnZhbGlkIHBzZXVkb3MNCgkJCWVsLnF1ZXJ5U2VsZWN0b3JBbGwoICIqLDp4IiApOw0KCQkJcmJ1Z2d5UVNBLnB1c2goICIsLio6IiApOw0KCQl9ICk7DQoJfQ0KDQoJaWYgKCAoIHN1cHBvcnQubWF0Y2hlc1NlbGVjdG9yID0gcm5hdGl2ZS50ZXN0KCAoIG1hdGNoZXMgPSBkb2NFbGVtLm1hdGNoZXMgfHwNCgkJZG9jRWxlbS53ZWJraXRNYXRjaGVzU2VsZWN0b3IgfHwNCgkJZG9jRWxlbS5tb3pNYXRjaGVzU2VsZWN0b3IgfHwNCgkJZG9jRWxlbS5vTWF0Y2hlc1NlbGVjdG9yIHx8DQoJCWRvY0VsZW0ubXNNYXRjaGVzU2VsZWN0b3IgKSApICkgKSB7DQoNCgkJYXNzZXJ0KCBmdW5jdGlvbiggZWwgKSB7DQoNCgkJCS8vIENoZWNrIHRvIHNlZSBpZiBpdCdzIHBvc3NpYmxlIHRvIGRvIG1hdGNoZXNTZWxlY3Rvcg0KCQkJLy8gb24gYSBkaXNjb25uZWN0ZWQgbm9kZSAoSUUgOSkNCgkJCXN1cHBvcnQuZGlzY29ubmVjdGVkTWF0Y2ggPSBtYXRjaGVzLmNhbGwoIGVsLCAiKiIgKTsNCg0KCQkJLy8gVGhpcyBzaG91bGQgZmFpbCB3aXRoIGFuIGV4Y2VwdGlvbg0KCQkJLy8gR2Vja28gZG9lcyBub3QgZXJyb3IsIHJldHVybnMgZmFsc2UgaW5zdGVhZA0KCQkJbWF0Y2hlcy5jYWxsKCBlbCwgIltzIT0nJ106eCIgKTsNCgkJCXJidWdneU1hdGNoZXMucHVzaCggIiE9IiwgcHNldWRvcyApOw0KCQl9ICk7DQoJfQ0KDQoJcmJ1Z2d5UVNBID0gcmJ1Z2d5UVNBLmxlbmd0aCAmJiBuZXcgUmVnRXhwKCByYnVnZ3lRU0Euam9pbiggInwiICkgKTsNCglyYnVnZ3lNYXRjaGVzID0gcmJ1Z2d5TWF0Y2hlcy5sZW5ndGggJiYgbmV3IFJlZ0V4cCggcmJ1Z2d5TWF0Y2hlcy5qb2luKCAifCIgKSApOw0KDQoJLyogQ29udGFpbnMNCgktLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tICovDQoJaGFzQ29tcGFyZSA9IHJuYXRpdmUudGVzdCggZG9jRWxlbS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiApOw0KDQoJLy8gRWxlbWVudCBjb250YWlucyBhbm90aGVyDQoJLy8gUHVycG9zZWZ1bGx5IHNlbGYtZXhjbHVzaXZlDQoJLy8gQXMgaW4sIGFuIGVsZW1lbnQgZG9lcyBub3QgY29udGFpbiBpdHNlbGYNCgljb250YWlucyA9IGhhc0NvbXBhcmUgfHwgcm5hdGl2ZS50ZXN0KCBkb2NFbGVtLmNvbnRhaW5zICkgPw0KCQlmdW5jdGlvbiggYSwgYiApIHsNCgkJCXZhciBhZG93biA9IGEubm9kZVR5cGUgPT09IDkgPyBhLmRvY3VtZW50RWxlbWVudCA6IGEsDQoJCQkJYnVwID0gYiAmJiBiLnBhcmVudE5vZGU7DQoJCQlyZXR1cm4gYSA9PT0gYnVwIHx8ICEhKCBidXAgJiYgYnVwLm5vZGVUeXBlID09PSAxICYmICgNCgkJCQlhZG93bi5jb250YWlucyA/DQoJCQkJCWFkb3duLmNvbnRhaW5zKCBidXAgKSA6DQoJCQkJCWEuY29tcGFyZURvY3VtZW50UG9zaXRpb24gJiYgYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiggYnVwICkgJiAxNg0KCQkJKSApOw0KCQl9IDoNCgkJZnVuY3Rpb24oIGEsIGIgKSB7DQoJCQlpZiAoIGIgKSB7DQoJCQkJd2hpbGUgKCAoIGIgPSBiLnBhcmVudE5vZGUgKSApIHsNCgkJCQkJaWYgKCBiID09PSBhICkgew0KCQkJCQkJcmV0dXJuIHRydWU7DQoJCQkJCX0NCgkJCQl9DQoJCQl9DQoJCQlyZXR1cm4gZmFsc2U7DQoJCX07DQoNCgkvKiBTb3J0aW5nDQoJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAqLw0KDQoJLy8gRG9jdW1lbnQgb3JkZXIgc29ydGluZw0KCXNvcnRPcmRlciA9IGhhc0NvbXBhcmUgPw0KCWZ1bmN0aW9uKCBhLCBiICkgew0KDQoJCS8vIEZsYWcgZm9yIGR1cGxpY2F0ZSByZW1vdmFsDQoJCWlmICggYSA9PT0gYiApIHsNCgkJCWhhc0R1cGxpY2F0ZSA9IHRydWU7DQoJCQlyZXR1cm4gMDsNCgkJfQ0KDQoJCS8vIFNvcnQgb24gbWV0aG9kIGV4aXN0ZW5jZSBpZiBvbmx5IG9uZSBpbnB1dCBoYXMgY29tcGFyZURvY3VtZW50UG9zaXRpb24NCgkJdmFyIGNvbXBhcmUgPSAhYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiAtICFiLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uOw0KCQlpZiAoIGNvbXBhcmUgKSB7DQoJCQlyZXR1cm4gY29tcGFyZTsNCgkJfQ0KDQoJCS8vIENhbGN1bGF0ZSBwb3NpdGlvbiBpZiBib3RoIGlucHV0cyBiZWxvbmcgdG8gdGhlIHNhbWUgZG9jdW1lbnQNCgkJLy8gU3VwcG9ydDogSUUgMTErLCBFZGdlIDE3IC0gMTgrDQoJCS8vIElFL0VkZ2Ugc29tZXRpbWVzIHRocm93IGEgIlBlcm1pc3Npb24gZGVuaWVkIiBlcnJvciB3aGVuIHN0cmljdC1jb21wYXJpbmcNCgkJLy8gdHdvIGRvY3VtZW50czsgc2hhbGxvdyBjb21wYXJpc29ucyB3b3JrLg0KCQkvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgZXFlcWVxDQoJCWNvbXBhcmUgPSAoIGEub3duZXJEb2N1bWVudCB8fCBhICkgPT0gKCBiLm93bmVyRG9jdW1lbnQgfHwgYiApID8NCgkJCWEuY29tcGFyZURvY3VtZW50UG9zaXRpb24oIGIgKSA6DQoNCgkJCS8vIE90aGVyd2lzZSB3ZSBrbm93IHRoZXkgYXJlIGRpc2Nvbm5lY3RlZA0KCQkJMTsNCg0KCQkvLyBEaXNjb25uZWN0ZWQgbm9kZXMNCgkJaWYgKCBjb21wYXJlICYgMSB8fA0KCQkJKCAhc3VwcG9ydC5zb3J0RGV0YWNoZWQgJiYgYi5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiggYSApID09PSBjb21wYXJlICkgKSB7DQoNCgkJCS8vIENob29zZSB0aGUgZmlyc3QgZWxlbWVudCB0aGF0IGlzIHJlbGF0ZWQgdG8gb3VyIHByZWZlcnJlZCBkb2N1bWVudA0KCQkJLy8gU3VwcG9ydDogSUUgMTErLCBFZGdlIDE3IC0gMTgrDQoJCQkvLyBJRS9FZGdlIHNvbWV0aW1lcyB0aHJvdyBhICJQZXJtaXNzaW9uIGRlbmllZCIgZXJyb3Igd2hlbiBzdHJpY3QtY29tcGFyaW5nDQoJCQkvLyB0d28gZG9jdW1lbnRzOyBzaGFsbG93IGNvbXBhcmlzb25zIHdvcmsuDQoJCQkvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgZXFlcWVxDQoJCQlpZiAoIGEgPT0gZG9jdW1lbnQgfHwgYS5vd25lckRvY3VtZW50ID09IHByZWZlcnJlZERvYyAmJg0KCQkJCWNvbnRhaW5zKCBwcmVmZXJyZWREb2MsIGEgKSApIHsNCgkJCQlyZXR1cm4gLTE7DQoJCQl9DQoNCgkJCS8vIFN1cHBvcnQ6IElFIDExKywgRWRnZSAxNyAtIDE4Kw0KCQkJLy8gSUUvRWRnZSBzb21ldGltZXMgdGhyb3cgYSAiUGVybWlzc2lvbiBkZW5pZWQiIGVycm9yIHdoZW4gc3RyaWN0LWNvbXBhcmluZw0KCQkJLy8gdHdvIGRvY3VtZW50czsgc2hhbGxvdyBjb21wYXJpc29ucyB3b3JrLg0KCQkJLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGVxZXFlcQ0KCQkJaWYgKCBiID09IGRvY3VtZW50IHx8IGIub3duZXJEb2N1bWVudCA9PSBwcmVmZXJyZWREb2MgJiYNCgkJCQljb250YWlucyggcHJlZmVycmVkRG9jLCBiICkgKSB7DQoJCQkJcmV0dXJuIDE7DQoJCQl9DQoNCgkJCS8vIE1haW50YWluIG9yaWdpbmFsIG9yZGVyDQoJCQlyZXR1cm4gc29ydElucHV0ID8NCgkJCQkoIGluZGV4T2YoIHNvcnRJbnB1dCwgYSApIC0gaW5kZXhPZiggc29ydElucHV0LCBiICkgKSA6DQoJCQkJMDsNCgkJfQ0KDQoJCXJldHVybiBjb21wYXJlICYgNCA/IC0xIDogMTsNCgl9IDoNCglmdW5jdGlvbiggYSwgYiApIHsNCg0KCQkvLyBFeGl0IGVhcmx5IGlmIHRoZSBub2RlcyBhcmUgaWRlbnRpY2FsDQoJCWlmICggYSA9PT0gYiApIHsNCgkJCWhhc0R1cGxpY2F0ZSA9IHRydWU7DQoJCQlyZXR1cm4gMDsNCgkJfQ0KDQoJCXZhciBjdXIsDQoJCQlpID0gMCwNCgkJCWF1cCA9IGEucGFyZW50Tm9kZSwNCgkJCWJ1cCA9IGIucGFyZW50Tm9kZSwNCgkJCWFwID0gWyBhIF0sDQoJCQlicCA9IFsgYiBdOw0KDQoJCS8vIFBhcmVudGxlc3Mgbm9kZXMgYXJlIGVpdGhlciBkb2N1bWVudHMgb3IgZGlzY29ubmVjdGVkDQoJCWlmICggIWF1cCB8fCAhYnVwICkgew0KDQoJCQkvLyBTdXBwb3J0OiBJRSAxMSssIEVkZ2UgMTcgLSAxOCsNCgkJCS8vIElFL0VkZ2Ugc29tZXRpbWVzIHRocm93IGEgIlBlcm1pc3Npb24gZGVuaWVkIiBlcnJvciB3aGVuIHN0cmljdC1jb21wYXJpbmcNCgkJCS8vIHR3byBkb2N1bWVudHM7IHNoYWxsb3cgY29tcGFyaXNvbnMgd29yay4NCgkJCS8qIGVzbGludC1kaXNhYmxlIGVxZXFlcSAqLw0KCQkJcmV0dXJuIGEgPT0gZG9jdW1lbnQgPyAtMSA6DQoJCQkJYiA9PSBkb2N1bWVudCA/IDEgOg0KCQkJCS8qIGVzbGludC1lbmFibGUgZXFlcWVxICovDQoJCQkJYXVwID8gLTEgOg0KCQkJCWJ1cCA/IDEgOg0KCQkJCXNvcnRJbnB1dCA/DQoJCQkJKCBpbmRleE9mKCBzb3J0SW5wdXQsIGEgKSAtIGluZGV4T2YoIHNvcnRJbnB1dCwgYiApICkgOg0KCQkJCTA7DQoNCgkJLy8gSWYgdGhlIG5vZGVzIGFyZSBzaWJsaW5ncywgd2UgY2FuIGRvIGEgcXVpY2sgY2hlY2sNCgkJfSBlbHNlIGlmICggYXVwID09PSBidXAgKSB7DQoJCQlyZXR1cm4gc2libGluZ0NoZWNrKCBhLCBiICk7DQoJCX0NCg0KCQkvLyBPdGhlcndpc2Ugd2UgbmVlZCBmdWxsIGxpc3RzIG9mIHRoZWlyIGFuY2VzdG9ycyBmb3IgY29tcGFyaXNvbg0KCQljdXIgPSBhOw0KCQl3aGlsZSAoICggY3VyID0gY3VyLnBhcmVudE5vZGUgKSApIHsNCgkJCWFwLnVuc2hpZnQoIGN1ciApOw0KCQl9DQoJCWN1ciA9IGI7DQoJCXdoaWxlICggKCBjdXIgPSBjdXIucGFyZW50Tm9kZSApICkgew0KCQkJYnAudW5zaGlmdCggY3VyICk7DQoJCX0NCg0KCQkvLyBXYWxrIGRvd24gdGhlIHRyZWUgbG9va2luZyBmb3IgYSBkaXNjcmVwYW5jeQ0KCQl3aGlsZSAoIGFwWyBpIF0gPT09IGJwWyBpIF0gKSB7DQoJCQlpKys7DQoJCX0NCg0KCQlyZXR1cm4gaSA/DQoNCgkJCS8vIERvIGEgc2libGluZyBjaGVjayBpZiB0aGUgbm9kZXMgaGF2ZSBhIGNvbW1vbiBhbmNlc3Rvcg0KCQkJc2libGluZ0NoZWNrKCBhcFsgaSBdLCBicFsgaSBdICkgOg0KDQoJCQkvLyBPdGhlcndpc2Ugbm9kZXMgaW4gb3VyIGRvY3VtZW50IHNvcnQgZmlyc3QNCgkJCS8vIFN1cHBvcnQ6IElFIDExKywgRWRnZSAxNyAtIDE4Kw0KCQkJLy8gSUUvRWRnZSBzb21ldGltZXMgdGhyb3cgYSAiUGVybWlzc2lvbiBkZW5pZWQiIGVycm9yIHdoZW4gc3RyaWN0LWNvbXBhcmluZw0KCQkJLy8gdHdvIGRvY3VtZW50czsgc2hhbGxvdyBjb21wYXJpc29ucyB3b3JrLg0KCQkJLyogZXNsaW50LWRpc2FibGUgZXFlcWVxICovDQoJCQlhcFsgaSBdID09IHByZWZlcnJlZERvYyA/IC0xIDoNCgkJCWJwWyBpIF0gPT0gcHJlZmVycmVkRG9jID8gMSA6DQoJCQkvKiBlc2xpbnQtZW5hYmxlIGVxZXFlcSAqLw0KCQkJMDsNCgl9Ow0KDQoJcmV0dXJuIGRvY3VtZW50Ow0KfTsNCg0KU2l6emxlLm1hdGNoZXMgPSBmdW5jdGlvbiggZXhwciwgZWxlbWVudHMgKSB7DQoJcmV0dXJuIFNpenpsZSggZXhwciwgbnVsbCwgbnVsbCwgZWxlbWVudHMgKTsNCn07DQoNClNpenpsZS5tYXRjaGVzU2VsZWN0b3IgPSBmdW5jdGlvbiggZWxlbSwgZXhwciApIHsNCglzZXREb2N1bWVudCggZWxlbSApOw0KDQoJaWYgKCBzdXBwb3J0Lm1hdGNoZXNTZWxlY3RvciAmJiBkb2N1bWVudElzSFRNTCAmJg0KCQkhbm9ubmF0aXZlU2VsZWN0b3JDYWNoZVsgZXhwciArICIgIiBdICYmDQoJCSggIXJidWdneU1hdGNoZXMgfHwgIXJidWdneU1hdGNoZXMudGVzdCggZXhwciApICkgJiYNCgkJKCAhcmJ1Z2d5UVNBICAgICB8fCAhcmJ1Z2d5UVNBLnRlc3QoIGV4cHIgKSApICkgew0KDQoJCXRyeSB7DQoJCQl2YXIgcmV0ID0gbWF0Y2hlcy5jYWxsKCBlbGVtLCBleHByICk7DQoNCgkJCS8vIElFIDkncyBtYXRjaGVzU2VsZWN0b3IgcmV0dXJucyBmYWxzZSBvbiBkaXNjb25uZWN0ZWQgbm9kZXMNCgkJCWlmICggcmV0IHx8IHN1cHBvcnQuZGlzY29ubmVjdGVkTWF0Y2ggfHwNCg0KCQkJCS8vIEFzIHdlbGwsIGRpc2Nvbm5lY3RlZCBub2RlcyBhcmUgc2FpZCB0byBiZSBpbiBhIGRvY3VtZW50DQoJCQkJLy8gZnJhZ21lbnQgaW4gSUUgOQ0KCQkJCWVsZW0uZG9jdW1lbnQgJiYgZWxlbS5kb2N1bWVudC5ub2RlVHlwZSAhPT0gMTEgKSB7DQoJCQkJcmV0dXJuIHJldDsNCgkJCX0NCgkJfSBjYXRjaCAoIGUgKSB7DQoJCQlub25uYXRpdmVTZWxlY3RvckNhY2hlKCBleHByLCB0cnVlICk7DQoJCX0NCgl9DQoNCglyZXR1cm4gU2l6emxlKCBleHByLCBkb2N1bWVudCwgbnVsbCwgWyBlbGVtIF0gKS5sZW5ndGggPiAwOw0KfTsNCg0KU2l6emxlLmNvbnRhaW5zID0gZnVuY3Rpb24oIGNvbnRleHQsIGVsZW0gKSB7DQoNCgkvLyBTZXQgZG9jdW1lbnQgdmFycyBpZiBuZWVkZWQNCgkvLyBTdXBwb3J0OiBJRSAxMSssIEVkZ2UgMTcgLSAxOCsNCgkvLyBJRS9FZGdlIHNvbWV0aW1lcyB0aHJvdyBhICJQZXJtaXNzaW9uIGRlbmllZCIgZXJyb3Igd2hlbiBzdHJpY3QtY29tcGFyaW5nDQoJLy8gdHdvIGRvY3VtZW50czsgc2hhbGxvdyBjb21wYXJpc29ucyB3b3JrLg0KCS8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBlcWVxZXENCglpZiAoICggY29udGV4dC5vd25lckRvY3VtZW50IHx8IGNvbnRleHQgKSAhPSBkb2N1bWVudCApIHsNCgkJc2V0RG9jdW1lbnQoIGNvbnRleHQgKTsNCgl9DQoJcmV0dXJuIGNvbnRhaW5zKCBjb250ZXh0LCBlbGVtICk7DQp9Ow0KDQpTaXp6bGUuYXR0ciA9IGZ1bmN0aW9uKCBlbGVtLCBuYW1lICkgew0KDQoJLy8gU2V0IGRvY3VtZW50IHZhcnMgaWYgbmVlZGVkDQoJLy8gU3VwcG9ydDogSUUgMTErLCBFZGdlIDE3IC0gMTgrDQoJLy8gSUUvRWRnZSBzb21ldGltZXMgdGhyb3cgYSAiUGVybWlzc2lvbiBkZW5pZWQiIGVycm9yIHdoZW4gc3RyaWN0LWNvbXBhcmluZw0KCS8vIHR3byBkb2N1bWVudHM7IHNoYWxsb3cgY29tcGFyaXNvbnMgd29yay4NCgkvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgZXFlcWVxDQoJaWYgKCAoIGVsZW0ub3duZXJEb2N1bWVudCB8fCBlbGVtICkgIT0gZG9jdW1lbnQgKSB7DQoJCXNldERvY3VtZW50KCBlbGVtICk7DQoJfQ0KDQoJdmFyIGZuID0gRXhwci5hdHRySGFuZGxlWyBuYW1lLnRvTG93ZXJDYXNlKCkgXSwNCg0KCQkvLyBEb24ndCBnZXQgZm9vbGVkIGJ5IE9iamVjdC5wcm90b3R5cGUgcHJvcGVydGllcyAoalF1ZXJ5ICMxMzgwNykNCgkJdmFsID0gZm4gJiYgaGFzT3duLmNhbGwoIEV4cHIuYXR0ckhhbmRsZSwgbmFtZS50b0xvd2VyQ2FzZSgpICkgPw0KCQkJZm4oIGVsZW0sIG5hbWUsICFkb2N1bWVudElzSFRNTCApIDoNCgkJCXVuZGVmaW5lZDsNCg0KCXJldHVybiB2YWwgIT09IHVuZGVmaW5lZCA/DQoJCXZhbCA6DQoJCXN1cHBvcnQuYXR0cmlidXRlcyB8fCAhZG9jdW1lbnRJc0hUTUwgPw0KCQkJZWxlbS5nZXRBdHRyaWJ1dGUoIG5hbWUgKSA6DQoJCQkoIHZhbCA9IGVsZW0uZ2V0QXR0cmlidXRlTm9kZSggbmFtZSApICkgJiYgdmFsLnNwZWNpZmllZCA/DQoJCQkJdmFsLnZhbHVlIDoNCgkJCQludWxsOw0KfTsNCg0KU2l6emxlLmVzY2FwZSA9IGZ1bmN0aW9uKCBzZWwgKSB7DQoJcmV0dXJuICggc2VsICsgIiIgKS5yZXBsYWNlKCByY3NzZXNjYXBlLCBmY3NzZXNjYXBlICk7DQp9Ow0KDQpTaXp6bGUuZXJyb3IgPSBmdW5jdGlvbiggbXNnICkgew0KCXRocm93IG5ldyBFcnJvciggIlN5bnRheCBlcnJvciwgdW5yZWNvZ25pemVkIGV4cHJlc3Npb246ICIgKyBtc2cgKTsNCn07DQoNCi8qKg0KICogRG9jdW1lbnQgc29ydGluZyBhbmQgcmVtb3ZpbmcgZHVwbGljYXRlcw0KICogQHBhcmFtIHtBcnJheUxpa2V9IHJlc3VsdHMNCiAqLw0KU2l6emxlLnVuaXF1ZVNvcnQgPSBmdW5jdGlvbiggcmVzdWx0cyApIHsNCgl2YXIgZWxlbSwNCgkJZHVwbGljYXRlcyA9IFtdLA0KCQlqID0gMCwNCgkJaSA9IDA7DQoNCgkvLyBVbmxlc3Mgd2UgKmtub3cqIHdlIGNhbiBkZXRlY3QgZHVwbGljYXRlcywgYXNzdW1lIHRoZWlyIHByZXNlbmNlDQoJaGFzRHVwbGljYXRlID0gIXN1cHBvcnQuZGV0ZWN0RHVwbGljYXRlczsNCglzb3J0SW5wdXQgPSAhc3VwcG9ydC5zb3J0U3RhYmxlICYmIHJlc3VsdHMuc2xpY2UoIDAgKTsNCglyZXN1bHRzLnNvcnQoIHNvcnRPcmRlciApOw0KDQoJaWYgKCBoYXNEdXBsaWNhdGUgKSB7DQoJCXdoaWxlICggKCBlbGVtID0gcmVzdWx0c1sgaSsrIF0gKSApIHsNCgkJCWlmICggZWxlbSA9PT0gcmVzdWx0c1sgaSBdICkgew0KCQkJCWogPSBkdXBsaWNhdGVzLnB1c2goIGkgKTsNCgkJCX0NCgkJfQ0KCQl3aGlsZSAoIGotLSApIHsNCgkJCXJlc3VsdHMuc3BsaWNlKCBkdXBsaWNhdGVzWyBqIF0sIDEgKTsNCgkJfQ0KCX0NCg0KCS8vIENsZWFyIGlucHV0IGFmdGVyIHNvcnRpbmcgdG8gcmVsZWFzZSBvYmplY3RzDQoJLy8gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvc2l6emxlL3B1bGwvMjI1DQoJc29ydElucHV0ID0gbnVsbDsNCg0KCXJldHVybiByZXN1bHRzOw0KfTsNCg0KLyoqDQogKiBVdGlsaXR5IGZ1bmN0aW9uIGZvciByZXRyaWV2aW5nIHRoZSB0ZXh0IHZhbHVlIG9mIGFuIGFycmF5IG9mIERPTSBub2Rlcw0KICogQHBhcmFtIHtBcnJheXxFbGVtZW50fSBlbGVtDQogKi8NCmdldFRleHQgPSBTaXp6bGUuZ2V0VGV4dCA9IGZ1bmN0aW9uKCBlbGVtICkgew0KCXZhciBub2RlLA0KCQlyZXQgPSAiIiwNCgkJaSA9IDAsDQoJCW5vZGVUeXBlID0gZWxlbS5ub2RlVHlwZTsNCg0KCWlmICggIW5vZGVUeXBlICkgew0KDQoJCS8vIElmIG5vIG5vZGVUeXBlLCB0aGlzIGlzIGV4cGVjdGVkIHRvIGJlIGFuIGFycmF5DQoJCXdoaWxlICggKCBub2RlID0gZWxlbVsgaSsrIF0gKSApIHsNCg0KCQkJLy8gRG8gbm90IHRyYXZlcnNlIGNvbW1lbnQgbm9kZXMNCgkJCXJldCArPSBnZXRUZXh0KCBub2RlICk7DQoJCX0NCgl9IGVsc2UgaWYgKCBub2RlVHlwZSA9PT0gMSB8fCBub2RlVHlwZSA9PT0gOSB8fCBub2RlVHlwZSA9PT0gMTEgKSB7DQoNCgkJLy8gVXNlIHRleHRDb250ZW50IGZvciBlbGVtZW50cw0KCQkvLyBpbm5lclRleHQgdXNhZ2UgcmVtb3ZlZCBmb3IgY29uc2lzdGVuY3kgb2YgbmV3IGxpbmVzIChqUXVlcnkgIzExMTUzKQ0KCQlpZiAoIHR5cGVvZiBlbGVtLnRleHRDb250ZW50ID09PSAic3RyaW5nIiApIHsNCgkJCXJldHVybiBlbGVtLnRleHRDb250ZW50Ow0KCQl9IGVsc2Ugew0KDQoJCQkvLyBUcmF2ZXJzZSBpdHMgY2hpbGRyZW4NCgkJCWZvciAoIGVsZW0gPSBlbGVtLmZpcnN0Q2hpbGQ7IGVsZW07IGVsZW0gPSBlbGVtLm5leHRTaWJsaW5nICkgew0KCQkJCXJldCArPSBnZXRUZXh0KCBlbGVtICk7DQoJCQl9DQoJCX0NCgl9IGVsc2UgaWYgKCBub2RlVHlwZSA9PT0gMyB8fCBub2RlVHlwZSA9PT0gNCApIHsNCgkJcmV0dXJuIGVsZW0ubm9kZVZhbHVlOw0KCX0NCg0KCS8vIERvIG5vdCBpbmNsdWRlIGNvbW1lbnQgb3IgcHJvY2Vzc2luZyBpbnN0cnVjdGlvbiBub2Rlcw0KDQoJcmV0dXJuIHJldDsNCn07DQoNCkV4cHIgPSBTaXp6bGUuc2VsZWN0b3JzID0gew0KDQoJLy8gQ2FuIGJlIGFkanVzdGVkIGJ5IHRoZSB1c2VyDQoJY2FjaGVMZW5ndGg6IDUwLA0KDQoJY3JlYXRlUHNldWRvOiBtYXJrRnVuY3Rpb24sDQoNCgltYXRjaDogbWF0Y2hFeHByLA0KDQoJYXR0ckhhbmRsZToge30sDQoNCglmaW5kOiB7fSwNCg0KCXJlbGF0aXZlOiB7DQoJCSI+IjogeyBkaXI6ICJwYXJlbnROb2RlIiwgZmlyc3Q6IHRydWUgfSwNCgkJIiAiOiB7IGRpcjogInBhcmVudE5vZGUiIH0sDQoJCSIrIjogeyBkaXI6ICJwcmV2aW91c1NpYmxpbmciLCBmaXJzdDogdHJ1ZSB9LA0KCQkifiI6IHsgZGlyOiAicHJldmlvdXNTaWJsaW5nIiB9DQoJfSwNCg0KCXByZUZpbHRlcjogew0KCQkiQVRUUiI6IGZ1bmN0aW9uKCBtYXRjaCApIHsNCgkJCW1hdGNoWyAxIF0gPSBtYXRjaFsgMSBdLnJlcGxhY2UoIHJ1bmVzY2FwZSwgZnVuZXNjYXBlICk7DQoNCgkJCS8vIE1vdmUgdGhlIGdpdmVuIHZhbHVlIHRvIG1hdGNoWzNdIHdoZXRoZXIgcXVvdGVkIG9yIHVucXVvdGVkDQoJCQltYXRjaFsgMyBdID0gKCBtYXRjaFsgMyBdIHx8IG1hdGNoWyA0IF0gfHwNCgkJCQltYXRjaFsgNSBdIHx8ICIiICkucmVwbGFjZSggcnVuZXNjYXBlLCBmdW5lc2NhcGUgKTsNCg0KCQkJaWYgKCBtYXRjaFsgMiBdID09PSAifj0iICkgew0KCQkJCW1hdGNoWyAzIF0gPSAiICIgKyBtYXRjaFsgMyBdICsgIiAiOw0KCQkJfQ0KDQoJCQlyZXR1cm4gbWF0Y2guc2xpY2UoIDAsIDQgKTsNCgkJfSwNCg0KCQkiQ0hJTEQiOiBmdW5jdGlvbiggbWF0Y2ggKSB7DQoNCgkJCS8qIG1hdGNoZXMgZnJvbSBtYXRjaEV4cHJbIkNISUxEIl0NCgkJCQkxIHR5cGUgKG9ubHl8bnRofC4uLikNCgkJCQkyIHdoYXQgKGNoaWxkfG9mLXR5cGUpDQoJCQkJMyBhcmd1bWVudCAoZXZlbnxvZGR8XGQqfFxkKm4oWystXVxkKyk/fC4uLikNCgkJCQk0IHhuLWNvbXBvbmVudCBvZiB4bit5IGFyZ3VtZW50IChbKy1dP1xkKm58KQ0KCQkJCTUgc2lnbiBvZiB4bi1jb21wb25lbnQNCgkJCQk2IHggb2YgeG4tY29tcG9uZW50DQoJCQkJNyBzaWduIG9mIHktY29tcG9uZW50DQoJCQkJOCB5IG9mIHktY29tcG9uZW50DQoJCQkqLw0KCQkJbWF0Y2hbIDEgXSA9IG1hdGNoWyAxIF0udG9Mb3dlckNhc2UoKTsNCg0KCQkJaWYgKCBtYXRjaFsgMSBdLnNsaWNlKCAwLCAzICkgPT09ICJudGgiICkgew0KDQoJCQkJLy8gbnRoLSogcmVxdWlyZXMgYXJndW1lbnQNCgkJCQlpZiAoICFtYXRjaFsgMyBdICkgew0KCQkJCQlTaXp6bGUuZXJyb3IoIG1hdGNoWyAwIF0gKTsNCgkJCQl9DQoNCgkJCQkvLyBudW1lcmljIHggYW5kIHkgcGFyYW1ldGVycyBmb3IgRXhwci5maWx0ZXIuQ0hJTEQNCgkJCQkvLyByZW1lbWJlciB0aGF0IGZhbHNlL3RydWUgY2FzdCByZXNwZWN0aXZlbHkgdG8gMC8xDQoJCQkJbWF0Y2hbIDQgXSA9ICsoIG1hdGNoWyA0IF0gPw0KCQkJCQltYXRjaFsgNSBdICsgKCBtYXRjaFsgNiBdIHx8IDEgKSA6DQoJCQkJCTIgKiAoIG1hdGNoWyAzIF0gPT09ICJldmVuIiB8fCBtYXRjaFsgMyBdID09PSAib2RkIiApICk7DQoJCQkJbWF0Y2hbIDUgXSA9ICsoICggbWF0Y2hbIDcgXSArIG1hdGNoWyA4IF0gKSB8fCBtYXRjaFsgMyBdID09PSAib2RkIiApOw0KDQoJCQkJLy8gb3RoZXIgdHlwZXMgcHJvaGliaXQgYXJndW1lbnRzDQoJCQl9IGVsc2UgaWYgKCBtYXRjaFsgMyBdICkgew0KCQkJCVNpenpsZS5lcnJvciggbWF0Y2hbIDAgXSApOw0KCQkJfQ0KDQoJCQlyZXR1cm4gbWF0Y2g7DQoJCX0sDQoNCgkJIlBTRVVETyI6IGZ1bmN0aW9uKCBtYXRjaCApIHsNCgkJCXZhciBleGNlc3MsDQoJCQkJdW5xdW90ZWQgPSAhbWF0Y2hbIDYgXSAmJiBtYXRjaFsgMiBdOw0KDQoJCQlpZiAoIG1hdGNoRXhwclsgIkNISUxEIiBdLnRlc3QoIG1hdGNoWyAwIF0gKSApIHsNCgkJCQlyZXR1cm4gbnVsbDsNCgkJCX0NCg0KCQkJLy8gQWNjZXB0IHF1b3RlZCBhcmd1bWVudHMgYXMtaXMNCgkJCWlmICggbWF0Y2hbIDMgXSApIHsNCgkJCQltYXRjaFsgMiBdID0gbWF0Y2hbIDQgXSB8fCBtYXRjaFsgNSBdIHx8ICIiOw0KDQoJCQkvLyBTdHJpcCBleGNlc3MgY2hhcmFjdGVycyBmcm9tIHVucXVvdGVkIGFyZ3VtZW50cw0KCQkJfSBlbHNlIGlmICggdW5xdW90ZWQgJiYgcnBzZXVkby50ZXN0KCB1bnF1b3RlZCApICYmDQoNCgkJCQkvLyBHZXQgZXhjZXNzIGZyb20gdG9rZW5pemUgKHJlY3Vyc2l2ZWx5KQ0KCQkJCSggZXhjZXNzID0gdG9rZW5pemUoIHVucXVvdGVkLCB0cnVlICkgKSAmJg0KDQoJCQkJLy8gYWR2YW5jZSB0byB0aGUgbmV4dCBjbG9zaW5nIHBhcmVudGhlc2lzDQoJCQkJKCBleGNlc3MgPSB1bnF1b3RlZC5pbmRleE9mKCAiKSIsIHVucXVvdGVkLmxlbmd0aCAtIGV4Y2VzcyApIC0gdW5xdW90ZWQubGVuZ3RoICkgKSB7DQoNCgkJCQkvLyBleGNlc3MgaXMgYSBuZWdhdGl2ZSBpbmRleA0KCQkJCW1hdGNoWyAwIF0gPSBtYXRjaFsgMCBdLnNsaWNlKCAwLCBleGNlc3MgKTsNCgkJCQltYXRjaFsgMiBdID0gdW5xdW90ZWQuc2xpY2UoIDAsIGV4Y2VzcyApOw0KCQkJfQ0KDQoJCQkvLyBSZXR1cm4gb25seSBjYXB0dXJlcyBuZWVkZWQgYnkgdGhlIHBzZXVkbyBmaWx0ZXIgbWV0aG9kICh0eXBlIGFuZCBhcmd1bWVudCkNCgkJCXJldHVybiBtYXRjaC5zbGljZSggMCwgMyApOw0KCQl9DQoJfSwNCg0KCWZpbHRlcjogew0KDQoJCSJUQUciOiBmdW5jdGlvbiggbm9kZU5hbWVTZWxlY3RvciApIHsNCgkJCXZhciBub2RlTmFtZSA9IG5vZGVOYW1lU2VsZWN0b3IucmVwbGFjZSggcnVuZXNjYXBlLCBmdW5lc2NhcGUgKS50b0xvd2VyQ2FzZSgpOw0KCQkJcmV0dXJuIG5vZGVOYW1lU2VsZWN0b3IgPT09ICIqIiA/DQoJCQkJZnVuY3Rpb24oKSB7DQoJCQkJCXJldHVybiB0cnVlOw0KCQkJCX0gOg0KCQkJCWZ1bmN0aW9uKCBlbGVtICkgew0KCQkJCQlyZXR1cm4gZWxlbS5ub2RlTmFtZSAmJiBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09IG5vZGVOYW1lOw0KCQkJCX07DQoJCX0sDQoNCgkJIkNMQVNTIjogZnVuY3Rpb24oIGNsYXNzTmFtZSApIHsNCgkJCXZhciBwYXR0ZXJuID0gY2xhc3NDYWNoZVsgY2xhc3NOYW1lICsgIiAiIF07DQoNCgkJCXJldHVybiBwYXR0ZXJuIHx8DQoJCQkJKCBwYXR0ZXJuID0gbmV3IFJlZ0V4cCggIihefCIgKyB3aGl0ZXNwYWNlICsNCgkJCQkJIikiICsgY2xhc3NOYW1lICsgIigiICsgd2hpdGVzcGFjZSArICJ8JCkiICkgKSAmJiBjbGFzc0NhY2hlKA0KCQkJCQkJY2xhc3NOYW1lLCBmdW5jdGlvbiggZWxlbSApIHsNCgkJCQkJCQlyZXR1cm4gcGF0dGVybi50ZXN0KA0KCQkJCQkJCQl0eXBlb2YgZWxlbS5jbGFzc05hbWUgPT09ICJzdHJpbmciICYmIGVsZW0uY2xhc3NOYW1lIHx8DQoJCQkJCQkJCXR5cGVvZiBlbGVtLmdldEF0dHJpYnV0ZSAhPT0gInVuZGVmaW5lZCIgJiYNCgkJCQkJCQkJCWVsZW0uZ2V0QXR0cmlidXRlKCAiY2xhc3MiICkgfHwNCgkJCQkJCQkJIiINCgkJCQkJCQkpOw0KCQkJCX0gKTsNCgkJfSwNCg0KCQkiQVRUUiI6IGZ1bmN0aW9uKCBuYW1lLCBvcGVyYXRvciwgY2hlY2sgKSB7DQoJCQlyZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7DQoJCQkJdmFyIHJlc3VsdCA9IFNpenpsZS5hdHRyKCBlbGVtLCBuYW1lICk7DQoNCgkJCQlpZiAoIHJlc3VsdCA9PSBudWxsICkgew0KCQkJCQlyZXR1cm4gb3BlcmF0b3IgPT09ICIhPSI7DQoJCQkJfQ0KCQkJCWlmICggIW9wZXJhdG9yICkgew0KCQkJCQlyZXR1cm4gdHJ1ZTsNCgkJCQl9DQoNCgkJCQlyZXN1bHQgKz0gIiI7DQoNCgkJCQkvKiBlc2xpbnQtZGlzYWJsZSBtYXgtbGVuICovDQoNCgkJCQlyZXR1cm4gb3BlcmF0b3IgPT09ICI9IiA/IHJlc3VsdCA9PT0gY2hlY2sgOg0KCQkJCQlvcGVyYXRvciA9PT0gIiE9IiA/IHJlc3VsdCAhPT0gY2hlY2sgOg0KCQkJCQlvcGVyYXRvciA9PT0gIl49IiA/IGNoZWNrICYmIHJlc3VsdC5pbmRleE9mKCBjaGVjayApID09PSAwIDoNCgkJCQkJb3BlcmF0b3IgPT09ICIqPSIgPyBjaGVjayAmJiByZXN1bHQuaW5kZXhPZiggY2hlY2sgKSA+IC0xIDoNCgkJCQkJb3BlcmF0b3IgPT09ICIkPSIgPyBjaGVjayAmJiByZXN1bHQuc2xpY2UoIC1jaGVjay5sZW5ndGggKSA9PT0gY2hlY2sgOg0KCQkJCQlvcGVyYXRvciA9PT0gIn49IiA/ICggIiAiICsgcmVzdWx0LnJlcGxhY2UoIHJ3aGl0ZXNwYWNlLCAiICIgKSArICIgIiApLmluZGV4T2YoIGNoZWNrICkgPiAtMSA6DQoJCQkJCW9wZXJhdG9yID09PSAifD0iID8gcmVzdWx0ID09PSBjaGVjayB8fCByZXN1bHQuc2xpY2UoIDAsIGNoZWNrLmxlbmd0aCArIDEgKSA9PT0gY2hlY2sgKyAiLSIgOg0KCQkJCQlmYWxzZTsNCgkJCQkvKiBlc2xpbnQtZW5hYmxlIG1heC1sZW4gKi8NCg0KCQkJfTsNCgkJfSwNCg0KCQkiQ0hJTEQiOiBmdW5jdGlvbiggdHlwZSwgd2hhdCwgX2FyZ3VtZW50LCBmaXJzdCwgbGFzdCApIHsNCgkJCXZhciBzaW1wbGUgPSB0eXBlLnNsaWNlKCAwLCAzICkgIT09ICJudGgiLA0KCQkJCWZvcndhcmQgPSB0eXBlLnNsaWNlKCAtNCApICE9PSAibGFzdCIsDQoJCQkJb2ZUeXBlID0gd2hhdCA9PT0gIm9mLXR5cGUiOw0KDQoJCQlyZXR1cm4gZmlyc3QgPT09IDEgJiYgbGFzdCA9PT0gMCA/DQoNCgkJCQkvLyBTaG9ydGN1dCBmb3IgOm50aC0qKG4pDQoJCQkJZnVuY3Rpb24oIGVsZW0gKSB7DQoJCQkJCXJldHVybiAhIWVsZW0ucGFyZW50Tm9kZTsNCgkJCQl9IDoNCg0KCQkJCWZ1bmN0aW9uKCBlbGVtLCBfY29udGV4dCwgeG1sICkgew0KCQkJCQl2YXIgY2FjaGUsIHVuaXF1ZUNhY2hlLCBvdXRlckNhY2hlLCBub2RlLCBub2RlSW5kZXgsIHN0YXJ0LA0KCQkJCQkJZGlyID0gc2ltcGxlICE9PSBmb3J3YXJkID8gIm5leHRTaWJsaW5nIiA6ICJwcmV2aW91c1NpYmxpbmciLA0KCQkJCQkJcGFyZW50ID0gZWxlbS5wYXJlbnROb2RlLA0KCQkJCQkJbmFtZSA9IG9mVHlwZSAmJiBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCksDQoJCQkJCQl1c2VDYWNoZSA9ICF4bWwgJiYgIW9mVHlwZSwNCgkJCQkJCWRpZmYgPSBmYWxzZTsNCg0KCQkJCQlpZiAoIHBhcmVudCApIHsNCg0KCQkJCQkJLy8gOihmaXJzdHxsYXN0fG9ubHkpLShjaGlsZHxvZi10eXBlKQ0KCQkJCQkJaWYgKCBzaW1wbGUgKSB7DQoJCQkJCQkJd2hpbGUgKCBkaXIgKSB7DQoJCQkJCQkJCW5vZGUgPSBlbGVtOw0KCQkJCQkJCQl3aGlsZSAoICggbm9kZSA9IG5vZGVbIGRpciBdICkgKSB7DQoJCQkJCQkJCQlpZiAoIG9mVHlwZSA/DQoJCQkJCQkJCQkJbm9kZS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSBuYW1lIDoNCgkJCQkJCQkJCQlub2RlLm5vZGVUeXBlID09PSAxICkgew0KDQoJCQkJCQkJCQkJcmV0dXJuIGZhbHNlOw0KCQkJCQkJCQkJfQ0KCQkJCQkJCQl9DQoNCgkJCQkJCQkJLy8gUmV2ZXJzZSBkaXJlY3Rpb24gZm9yIDpvbmx5LSogKGlmIHdlIGhhdmVuJ3QgeWV0IGRvbmUgc28pDQoJCQkJCQkJCXN0YXJ0ID0gZGlyID0gdHlwZSA9PT0gIm9ubHkiICYmICFzdGFydCAmJiAibmV4dFNpYmxpbmciOw0KCQkJCQkJCX0NCgkJCQkJCQlyZXR1cm4gdHJ1ZTsNCgkJCQkJCX0NCg0KCQkJCQkJc3RhcnQgPSBbIGZvcndhcmQgPyBwYXJlbnQuZmlyc3RDaGlsZCA6IHBhcmVudC5sYXN0Q2hpbGQgXTsNCg0KCQkJCQkJLy8gbm9uLXhtbCA6bnRoLWNoaWxkKC4uLikgc3RvcmVzIGNhY2hlIGRhdGEgb24gYHBhcmVudGANCgkJCQkJCWlmICggZm9yd2FyZCAmJiB1c2VDYWNoZSApIHsNCg0KCQkJCQkJCS8vIFNlZWsgYGVsZW1gIGZyb20gYSBwcmV2aW91c2x5LWNhY2hlZCBpbmRleA0KDQoJCQkJCQkJLy8gLi4uaW4gYSBnemlwLWZyaWVuZGx5IHdheQ0KCQkJCQkJCW5vZGUgPSBwYXJlbnQ7DQoJCQkJCQkJb3V0ZXJDYWNoZSA9IG5vZGVbIGV4cGFuZG8gXSB8fCAoIG5vZGVbIGV4cGFuZG8gXSA9IHt9ICk7DQoNCgkJCQkJCQkvLyBTdXBwb3J0OiBJRSA8OSBvbmx5DQoJCQkJCQkJLy8gRGVmZW5kIGFnYWluc3QgY2xvbmVkIGF0dHJvcGVydGllcyAoalF1ZXJ5IGdoLTE3MDkpDQoJCQkJCQkJdW5pcXVlQ2FjaGUgPSBvdXRlckNhY2hlWyBub2RlLnVuaXF1ZUlEIF0gfHwNCgkJCQkJCQkJKCBvdXRlckNhY2hlWyBub2RlLnVuaXF1ZUlEIF0gPSB7fSApOw0KDQoJCQkJCQkJY2FjaGUgPSB1bmlxdWVDYWNoZVsgdHlwZSBdIHx8IFtdOw0KCQkJCQkJCW5vZGVJbmRleCA9IGNhY2hlWyAwIF0gPT09IGRpcnJ1bnMgJiYgY2FjaGVbIDEgXTsNCgkJCQkJCQlkaWZmID0gbm9kZUluZGV4ICYmIGNhY2hlWyAyIF07DQoJCQkJCQkJbm9kZSA9IG5vZGVJbmRleCAmJiBwYXJlbnQuY2hpbGROb2Rlc1sgbm9kZUluZGV4IF07DQoNCgkJCQkJCQl3aGlsZSAoICggbm9kZSA9ICsrbm9kZUluZGV4ICYmIG5vZGUgJiYgbm9kZVsgZGlyIF0gfHwNCg0KCQkJCQkJCQkvLyBGYWxsYmFjayB0byBzZWVraW5nIGBlbGVtYCBmcm9tIHRoZSBzdGFydA0KCQkJCQkJCQkoIGRpZmYgPSBub2RlSW5kZXggPSAwICkgfHwgc3RhcnQucG9wKCkgKSApIHsNCg0KCQkJCQkJCQkvLyBXaGVuIGZvdW5kLCBjYWNoZSBpbmRleGVzIG9uIGBwYXJlbnRgIGFuZCBicmVhaw0KCQkJCQkJCQlpZiAoIG5vZGUubm9kZVR5cGUgPT09IDEgJiYgKytkaWZmICYmIG5vZGUgPT09IGVsZW0gKSB7DQoJCQkJCQkJCQl1bmlxdWVDYWNoZVsgdHlwZSBdID0gWyBkaXJydW5zLCBub2RlSW5kZXgsIGRpZmYgXTsNCgkJCQkJCQkJCWJyZWFrOw0KCQkJCQkJCQl9DQoJCQkJCQkJfQ0KDQoJCQkJCQl9IGVsc2Ugew0KDQoJCQkJCQkJLy8gVXNlIHByZXZpb3VzbHktY2FjaGVkIGVsZW1lbnQgaW5kZXggaWYgYXZhaWxhYmxlDQoJCQkJCQkJaWYgKCB1c2VDYWNoZSApIHsNCg0KCQkJCQkJCQkvLyAuLi5pbiBhIGd6aXAtZnJpZW5kbHkgd2F5DQoJCQkJCQkJCW5vZGUgPSBlbGVtOw0KCQkJCQkJCQlvdXRlckNhY2hlID0gbm9kZVsgZXhwYW5kbyBdIHx8ICggbm9kZVsgZXhwYW5kbyBdID0ge30gKTsNCg0KCQkJCQkJCQkvLyBTdXBwb3J0OiBJRSA8OSBvbmx5DQoJCQkJCQkJCS8vIERlZmVuZCBhZ2FpbnN0IGNsb25lZCBhdHRyb3BlcnRpZXMgKGpRdWVyeSBnaC0xNzA5KQ0KCQkJCQkJCQl1bmlxdWVDYWNoZSA9IG91dGVyQ2FjaGVbIG5vZGUudW5pcXVlSUQgXSB8fA0KCQkJCQkJCQkJKCBvdXRlckNhY2hlWyBub2RlLnVuaXF1ZUlEIF0gPSB7fSApOw0KDQoJCQkJCQkJCWNhY2hlID0gdW5pcXVlQ2FjaGVbIHR5cGUgXSB8fCBbXTsNCgkJCQkJCQkJbm9kZUluZGV4ID0gY2FjaGVbIDAgXSA9PT0gZGlycnVucyAmJiBjYWNoZVsgMSBdOw0KCQkJCQkJCQlkaWZmID0gbm9kZUluZGV4Ow0KCQkJCQkJCX0NCg0KCQkJCQkJCS8vIHhtbCA6bnRoLWNoaWxkKC4uLikNCgkJCQkJCQkvLyBvciA6bnRoLWxhc3QtY2hpbGQoLi4uKSBvciA6bnRoKC1sYXN0KT8tb2YtdHlwZSguLi4pDQoJCQkJCQkJaWYgKCBkaWZmID09PSBmYWxzZSApIHsNCg0KCQkJCQkJCQkvLyBVc2UgdGhlIHNhbWUgbG9vcCBhcyBhYm92ZSB0byBzZWVrIGBlbGVtYCBmcm9tIHRoZSBzdGFydA0KCQkJCQkJCQl3aGlsZSAoICggbm9kZSA9ICsrbm9kZUluZGV4ICYmIG5vZGUgJiYgbm9kZVsgZGlyIF0gfHwNCgkJCQkJCQkJCSggZGlmZiA9IG5vZGVJbmRleCA9IDAgKSB8fCBzdGFydC5wb3AoKSApICkgew0KDQoJCQkJCQkJCQlpZiAoICggb2ZUeXBlID8NCgkJCQkJCQkJCQlub2RlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09IG5hbWUgOg0KCQkJCQkJCQkJCW5vZGUubm9kZVR5cGUgPT09IDEgKSAmJg0KCQkJCQkJCQkJCSsrZGlmZiApIHsNCg0KCQkJCQkJCQkJCS8vIENhY2hlIHRoZSBpbmRleCBvZiBlYWNoIGVuY291bnRlcmVkIGVsZW1lbnQNCgkJCQkJCQkJCQlpZiAoIHVzZUNhY2hlICkgew0KCQkJCQkJCQkJCQlvdXRlckNhY2hlID0gbm9kZVsgZXhwYW5kbyBdIHx8DQoJCQkJCQkJCQkJCQkoIG5vZGVbIGV4cGFuZG8gXSA9IHt9ICk7DQoNCgkJCQkJCQkJCQkJLy8gU3VwcG9ydDogSUUgPDkgb25seQ0KCQkJCQkJCQkJCQkvLyBEZWZlbmQgYWdhaW5zdCBjbG9uZWQgYXR0cm9wZXJ0aWVzIChqUXVlcnkgZ2gtMTcwOSkNCgkJCQkJCQkJCQkJdW5pcXVlQ2FjaGUgPSBvdXRlckNhY2hlWyBub2RlLnVuaXF1ZUlEIF0gfHwNCgkJCQkJCQkJCQkJCSggb3V0ZXJDYWNoZVsgbm9kZS51bmlxdWVJRCBdID0ge30gKTsNCg0KCQkJCQkJCQkJCQl1bmlxdWVDYWNoZVsgdHlwZSBdID0gWyBkaXJydW5zLCBkaWZmIF07DQoJCQkJCQkJCQkJfQ0KDQoJCQkJCQkJCQkJaWYgKCBub2RlID09PSBlbGVtICkgew0KCQkJCQkJCQkJCQlicmVhazsNCgkJCQkJCQkJCQl9DQoJCQkJCQkJCQl9DQoJCQkJCQkJCX0NCgkJCQkJCQl9DQoJCQkJCQl9DQoNCgkJCQkJCS8vIEluY29ycG9yYXRlIHRoZSBvZmZzZXQsIHRoZW4gY2hlY2sgYWdhaW5zdCBjeWNsZSBzaXplDQoJCQkJCQlkaWZmIC09IGxhc3Q7DQoJCQkJCQlyZXR1cm4gZGlmZiA9PT0gZmlyc3QgfHwgKCBkaWZmICUgZmlyc3QgPT09IDAgJiYgZGlmZiAvIGZpcnN0ID49IDAgKTsNCgkJCQkJfQ0KCQkJCX07DQoJCX0sDQoNCgkJIlBTRVVETyI6IGZ1bmN0aW9uKCBwc2V1ZG8sIGFyZ3VtZW50ICkgew0KDQoJCQkvLyBwc2V1ZG8tY2xhc3MgbmFtZXMgYXJlIGNhc2UtaW5zZW5zaXRpdmUNCgkJCS8vIGh0dHA6Ly93d3cudzMub3JnL1RSL3NlbGVjdG9ycy8jcHNldWRvLWNsYXNzZXMNCgkJCS8vIFByaW9yaXRpemUgYnkgY2FzZSBzZW5zaXRpdml0eSBpbiBjYXNlIGN1c3RvbSBwc2V1ZG9zIGFyZSBhZGRlZCB3aXRoIHVwcGVyY2FzZSBsZXR0ZXJzDQoJCQkvLyBSZW1lbWJlciB0aGF0IHNldEZpbHRlcnMgaW5oZXJpdHMgZnJvbSBwc2V1ZG9zDQoJCQl2YXIgYXJncywNCgkJCQlmbiA9IEV4cHIucHNldWRvc1sgcHNldWRvIF0gfHwgRXhwci5zZXRGaWx0ZXJzWyBwc2V1ZG8udG9Mb3dlckNhc2UoKSBdIHx8DQoJCQkJCVNpenpsZS5lcnJvciggInVuc3VwcG9ydGVkIHBzZXVkbzogIiArIHBzZXVkbyApOw0KDQoJCQkvLyBUaGUgdXNlciBtYXkgdXNlIGNyZWF0ZVBzZXVkbyB0byBpbmRpY2F0ZSB0aGF0DQoJCQkvLyBhcmd1bWVudHMgYXJlIG5lZWRlZCB0byBjcmVhdGUgdGhlIGZpbHRlciBmdW5jdGlvbg0KCQkJLy8ganVzdCBhcyBTaXp6bGUgZG9lcw0KCQkJaWYgKCBmblsgZXhwYW5kbyBdICkgew0KCQkJCXJldHVybiBmbiggYXJndW1lbnQgKTsNCgkJCX0NCg0KCQkJLy8gQnV0IG1haW50YWluIHN1cHBvcnQgZm9yIG9sZCBzaWduYXR1cmVzDQoJCQlpZiAoIGZuLmxlbmd0aCA+IDEgKSB7DQoJCQkJYXJncyA9IFsgcHNldWRvLCBwc2V1ZG8sICIiLCBhcmd1bWVudCBdOw0KCQkJCXJldHVybiBFeHByLnNldEZpbHRlcnMuaGFzT3duUHJvcGVydHkoIHBzZXVkby50b0xvd2VyQ2FzZSgpICkgPw0KCQkJCQltYXJrRnVuY3Rpb24oIGZ1bmN0aW9uKCBzZWVkLCBtYXRjaGVzICkgew0KCQkJCQkJdmFyIGlkeCwNCgkJCQkJCQltYXRjaGVkID0gZm4oIHNlZWQsIGFyZ3VtZW50ICksDQoJCQkJCQkJaSA9IG1hdGNoZWQubGVuZ3RoOw0KCQkJCQkJd2hpbGUgKCBpLS0gKSB7DQoJCQkJCQkJaWR4ID0gaW5kZXhPZiggc2VlZCwgbWF0Y2hlZFsgaSBdICk7DQoJCQkJCQkJc2VlZFsgaWR4IF0gPSAhKCBtYXRjaGVzWyBpZHggXSA9IG1hdGNoZWRbIGkgXSApOw0KCQkJCQkJfQ0KCQkJCQl9ICkgOg0KCQkJCQlmdW5jdGlvbiggZWxlbSApIHsNCgkJCQkJCXJldHVybiBmbiggZWxlbSwgMCwgYXJncyApOw0KCQkJCQl9Ow0KCQkJfQ0KDQoJCQlyZXR1cm4gZm47DQoJCX0NCgl9LA0KDQoJcHNldWRvczogew0KDQoJCS8vIFBvdGVudGlhbGx5IGNvbXBsZXggcHNldWRvcw0KCQkibm90IjogbWFya0Z1bmN0aW9uKCBmdW5jdGlvbiggc2VsZWN0b3IgKSB7DQoNCgkJCS8vIFRyaW0gdGhlIHNlbGVjdG9yIHBhc3NlZCB0byBjb21waWxlDQoJCQkvLyB0byBhdm9pZCB0cmVhdGluZyBsZWFkaW5nIGFuZCB0cmFpbGluZw0KCQkJLy8gc3BhY2VzIGFzIGNvbWJpbmF0b3JzDQoJCQl2YXIgaW5wdXQgPSBbXSwNCgkJCQlyZXN1bHRzID0gW10sDQoJCQkJbWF0Y2hlciA9IGNvbXBpbGUoIHNlbGVjdG9yLnJlcGxhY2UoIHJ0cmltLCAiJDEiICkgKTsNCg0KCQkJcmV0dXJuIG1hdGNoZXJbIGV4cGFuZG8gXSA/DQoJCQkJbWFya0Z1bmN0aW9uKCBmdW5jdGlvbiggc2VlZCwgbWF0Y2hlcywgX2NvbnRleHQsIHhtbCApIHsNCgkJCQkJdmFyIGVsZW0sDQoJCQkJCQl1bm1hdGNoZWQgPSBtYXRjaGVyKCBzZWVkLCBudWxsLCB4bWwsIFtdICksDQoJCQkJCQlpID0gc2VlZC5sZW5ndGg7DQoNCgkJCQkJLy8gTWF0Y2ggZWxlbWVudHMgdW5tYXRjaGVkIGJ5IGBtYXRjaGVyYA0KCQkJCQl3aGlsZSAoIGktLSApIHsNCgkJCQkJCWlmICggKCBlbGVtID0gdW5tYXRjaGVkWyBpIF0gKSApIHsNCgkJCQkJCQlzZWVkWyBpIF0gPSAhKCBtYXRjaGVzWyBpIF0gPSBlbGVtICk7DQoJCQkJCQl9DQoJCQkJCX0NCgkJCQl9ICkgOg0KCQkJCWZ1bmN0aW9uKCBlbGVtLCBfY29udGV4dCwgeG1sICkgew0KCQkJCQlpbnB1dFsgMCBdID0gZWxlbTsNCgkJCQkJbWF0Y2hlciggaW5wdXQsIG51bGwsIHhtbCwgcmVzdWx0cyApOw0KDQoJCQkJCS8vIERvbid0IGtlZXAgdGhlIGVsZW1lbnQgKGlzc3VlICMyOTkpDQoJCQkJCWlucHV0WyAwIF0gPSBudWxsOw0KCQkJCQlyZXR1cm4gIXJlc3VsdHMucG9wKCk7DQoJCQkJfTsNCgkJfSApLA0KDQoJCSJoYXMiOiBtYXJrRnVuY3Rpb24oIGZ1bmN0aW9uKCBzZWxlY3RvciApIHsNCgkJCXJldHVybiBmdW5jdGlvbiggZWxlbSApIHsNCgkJCQlyZXR1cm4gU2l6emxlKCBzZWxlY3RvciwgZWxlbSApLmxlbmd0aCA+IDA7DQoJCQl9Ow0KCQl9ICksDQoNCgkJImNvbnRhaW5zIjogbWFya0Z1bmN0aW9uKCBmdW5jdGlvbiggdGV4dCApIHsNCgkJCXRleHQgPSB0ZXh0LnJlcGxhY2UoIHJ1bmVzY2FwZSwgZnVuZXNjYXBlICk7DQoJCQlyZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7DQoJCQkJcmV0dXJuICggZWxlbS50ZXh0Q29udGVudCB8fCBnZXRUZXh0KCBlbGVtICkgKS5pbmRleE9mKCB0ZXh0ICkgPiAtMTsNCgkJCX07DQoJCX0gKSwNCg0KCQkvLyAiV2hldGhlciBhbiBlbGVtZW50IGlzIHJlcHJlc2VudGVkIGJ5IGEgOmxhbmcoKSBzZWxlY3Rvcg0KCQkvLyBpcyBiYXNlZCBzb2xlbHkgb24gdGhlIGVsZW1lbnQncyBsYW5ndWFnZSB2YWx1ZQ0KCQkvLyBiZWluZyBlcXVhbCB0byB0aGUgaWRlbnRpZmllciBDLA0KCQkvLyBvciBiZWdpbm5pbmcgd2l0aCB0aGUgaWRlbnRpZmllciBDIGltbWVkaWF0ZWx5IGZvbGxvd2VkIGJ5ICItIi4NCgkJLy8gVGhlIG1hdGNoaW5nIG9mIEMgYWdhaW5zdCB0aGUgZWxlbWVudCdzIGxhbmd1YWdlIHZhbHVlIGlzIHBlcmZvcm1lZCBjYXNlLWluc2Vuc2l0aXZlbHkuDQoJCS8vIFRoZSBpZGVudGlmaWVyIEMgZG9lcyBub3QgaGF2ZSB0byBiZSBhIHZhbGlkIGxhbmd1YWdlIG5hbWUuIg0KCQkvLyBodHRwOi8vd3d3LnczLm9yZy9UUi9zZWxlY3RvcnMvI2xhbmctcHNldWRvDQoJCSJsYW5nIjogbWFya0Z1bmN0aW9uKCBmdW5jdGlvbiggbGFuZyApIHsNCg0KCQkJLy8gbGFuZyB2YWx1ZSBtdXN0IGJlIGEgdmFsaWQgaWRlbnRpZmllcg0KCQkJaWYgKCAhcmlkZW50aWZpZXIudGVzdCggbGFuZyB8fCAiIiApICkgew0KCQkJCVNpenpsZS5lcnJvciggInVuc3VwcG9ydGVkIGxhbmc6ICIgKyBsYW5nICk7DQoJCQl9DQoJCQlsYW5nID0gbGFuZy5yZXBsYWNlKCBydW5lc2NhcGUsIGZ1bmVzY2FwZSApLnRvTG93ZXJDYXNlKCk7DQoJCQlyZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7DQoJCQkJdmFyIGVsZW1MYW5nOw0KCQkJCWRvIHsNCgkJCQkJaWYgKCAoIGVsZW1MYW5nID0gZG9jdW1lbnRJc0hUTUwgPw0KCQkJCQkJZWxlbS5sYW5nIDoNCgkJCQkJCWVsZW0uZ2V0QXR0cmlidXRlKCAieG1sOmxhbmciICkgfHwgZWxlbS5nZXRBdHRyaWJ1dGUoICJsYW5nIiApICkgKSB7DQoNCgkJCQkJCWVsZW1MYW5nID0gZWxlbUxhbmcudG9Mb3dlckNhc2UoKTsNCgkJCQkJCXJldHVybiBlbGVtTGFuZyA9PT0gbGFuZyB8fCBlbGVtTGFuZy5pbmRleE9mKCBsYW5nICsgIi0iICkgPT09IDA7DQoJCQkJCX0NCgkJCQl9IHdoaWxlICggKCBlbGVtID0gZWxlbS5wYXJlbnROb2RlICkgJiYgZWxlbS5ub2RlVHlwZSA9PT0gMSApOw0KCQkJCXJldHVybiBmYWxzZTsNCgkJCX07DQoJCX0gKSwNCg0KCQkvLyBNaXNjZWxsYW5lb3VzDQoJCSJ0YXJnZXQiOiBmdW5jdGlvbiggZWxlbSApIHsNCgkJCXZhciBoYXNoID0gd2luZG93LmxvY2F0aW9uICYmIHdpbmRvdy5sb2NhdGlvbi5oYXNoOw0KCQkJcmV0dXJuIGhhc2ggJiYgaGFzaC5zbGljZSggMSApID09PSBlbGVtLmlkOw0KCQl9LA0KDQoJCSJyb290IjogZnVuY3Rpb24oIGVsZW0gKSB7DQoJCQlyZXR1cm4gZWxlbSA9PT0gZG9jRWxlbTsNCgkJfSwNCg0KCQkiZm9jdXMiOiBmdW5jdGlvbiggZWxlbSApIHsNCgkJCXJldHVybiBlbGVtID09PSBkb2N1bWVudC5hY3RpdmVFbGVtZW50ICYmDQoJCQkJKCAhZG9jdW1lbnQuaGFzRm9jdXMgfHwgZG9jdW1lbnQuaGFzRm9jdXMoKSApICYmDQoJCQkJISEoIGVsZW0udHlwZSB8fCBlbGVtLmhyZWYgfHwgfmVsZW0udGFiSW5kZXggKTsNCgkJfSwNCg0KCQkvLyBCb29sZWFuIHByb3BlcnRpZXMNCgkJImVuYWJsZWQiOiBjcmVhdGVEaXNhYmxlZFBzZXVkbyggZmFsc2UgKSwNCgkJImRpc2FibGVkIjogY3JlYXRlRGlzYWJsZWRQc2V1ZG8oIHRydWUgKSwNCg0KCQkiY2hlY2tlZCI6IGZ1bmN0aW9uKCBlbGVtICkgew0KDQoJCQkvLyBJbiBDU1MzLCA6Y2hlY2tlZCBzaG91bGQgcmV0dXJuIGJvdGggY2hlY2tlZCBhbmQgc2VsZWN0ZWQgZWxlbWVudHMNCgkJCS8vIGh0dHA6Ly93d3cudzMub3JnL1RSLzIwMTEvUkVDLWNzczMtc2VsZWN0b3JzLTIwMTEwOTI5LyNjaGVja2VkDQoJCQl2YXIgbm9kZU5hbWUgPSBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7DQoJCQlyZXR1cm4gKCBub2RlTmFtZSA9PT0gImlucHV0IiAmJiAhIWVsZW0uY2hlY2tlZCApIHx8DQoJCQkJKCBub2RlTmFtZSA9PT0gIm9wdGlvbiIgJiYgISFlbGVtLnNlbGVjdGVkICk7DQoJCX0sDQoNCgkJInNlbGVjdGVkIjogZnVuY3Rpb24oIGVsZW0gKSB7DQoNCgkJCS8vIEFjY2Vzc2luZyB0aGlzIHByb3BlcnR5IG1ha2VzIHNlbGVjdGVkLWJ5LWRlZmF1bHQNCgkJCS8vIG9wdGlvbnMgaW4gU2FmYXJpIHdvcmsgcHJvcGVybHkNCgkJCWlmICggZWxlbS5wYXJlbnROb2RlICkgew0KCQkJCS8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby11bnVzZWQtZXhwcmVzc2lvbnMNCgkJCQllbGVtLnBhcmVudE5vZGUuc2VsZWN0ZWRJbmRleDsNCgkJCX0NCg0KCQkJcmV0dXJuIGVsZW0uc2VsZWN0ZWQgPT09IHRydWU7DQoJCX0sDQoNCgkJLy8gQ29udGVudHMNCgkJImVtcHR5IjogZnVuY3Rpb24oIGVsZW0gKSB7DQoNCgkJCS8vIGh0dHA6Ly93d3cudzMub3JnL1RSL3NlbGVjdG9ycy8jZW1wdHktcHNldWRvDQoJCQkvLyA6ZW1wdHkgaXMgbmVnYXRlZCBieSBlbGVtZW50ICgxKSBvciBjb250ZW50IG5vZGVzICh0ZXh0OiAzOyBjZGF0YTogNDsgZW50aXR5IHJlZjogNSksDQoJCQkvLyAgIGJ1dCBub3QgYnkgb3RoZXJzIChjb21tZW50OiA4OyBwcm9jZXNzaW5nIGluc3RydWN0aW9uOiA3OyBldGMuKQ0KCQkJLy8gbm9kZVR5cGUgPCA2IHdvcmtzIGJlY2F1c2UgYXR0cmlidXRlcyAoMikgZG8gbm90IGFwcGVhciBhcyBjaGlsZHJlbg0KCQkJZm9yICggZWxlbSA9IGVsZW0uZmlyc3RDaGlsZDsgZWxlbTsgZWxlbSA9IGVsZW0ubmV4dFNpYmxpbmcgKSB7DQoJCQkJaWYgKCBlbGVtLm5vZGVUeXBlIDwgNiApIHsNCgkJCQkJcmV0dXJuIGZhbHNlOw0KCQkJCX0NCgkJCX0NCgkJCXJldHVybiB0cnVlOw0KCQl9LA0KDQoJCSJwYXJlbnQiOiBmdW5jdGlvbiggZWxlbSApIHsNCgkJCXJldHVybiAhRXhwci5wc2V1ZG9zWyAiZW1wdHkiIF0oIGVsZW0gKTsNCgkJfSwNCg0KCQkvLyBFbGVtZW50L2lucHV0IHR5cGVzDQoJCSJoZWFkZXIiOiBmdW5jdGlvbiggZWxlbSApIHsNCgkJCXJldHVybiByaGVhZGVyLnRlc3QoIGVsZW0ubm9kZU5hbWUgKTsNCgkJfSwNCg0KCQkiaW5wdXQiOiBmdW5jdGlvbiggZWxlbSApIHsNCgkJCXJldHVybiByaW5wdXRzLnRlc3QoIGVsZW0ubm9kZU5hbWUgKTsNCgkJfSwNCg0KCQkiYnV0dG9uIjogZnVuY3Rpb24oIGVsZW0gKSB7DQoJCQl2YXIgbmFtZSA9IGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsNCgkJCXJldHVybiBuYW1lID09PSAiaW5wdXQiICYmIGVsZW0udHlwZSA9PT0gImJ1dHRvbiIgfHwgbmFtZSA9PT0gImJ1dHRvbiI7DQoJCX0sDQoNCgkJInRleHQiOiBmdW5jdGlvbiggZWxlbSApIHsNCgkJCXZhciBhdHRyOw0KCQkJcmV0dXJuIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gImlucHV0IiAmJg0KCQkJCWVsZW0udHlwZSA9PT0gInRleHQiICYmDQoNCgkJCQkvLyBTdXBwb3J0OiBJRTw4DQoJCQkJLy8gTmV3IEhUTUw1IGF0dHJpYnV0ZSB2YWx1ZXMgKGUuZy4sICJzZWFyY2giKSBhcHBlYXIgd2l0aCBlbGVtLnR5cGUgPT09ICJ0ZXh0Ig0KCQkJCSggKCBhdHRyID0gZWxlbS5nZXRBdHRyaWJ1dGUoICJ0eXBlIiApICkgPT0gbnVsbCB8fA0KCQkJCQlhdHRyLnRvTG93ZXJDYXNlKCkgPT09ICJ0ZXh0IiApOw0KCQl9LA0KDQoJCS8vIFBvc2l0aW9uLWluLWNvbGxlY3Rpb24NCgkJImZpcnN0IjogY3JlYXRlUG9zaXRpb25hbFBzZXVkbyggZnVuY3Rpb24oKSB7DQoJCQlyZXR1cm4gWyAwIF07DQoJCX0gKSwNCg0KCQkibGFzdCI6IGNyZWF0ZVBvc2l0aW9uYWxQc2V1ZG8oIGZ1bmN0aW9uKCBfbWF0Y2hJbmRleGVzLCBsZW5ndGggKSB7DQoJCQlyZXR1cm4gWyBsZW5ndGggLSAxIF07DQoJCX0gKSwNCg0KCQkiZXEiOiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKCBmdW5jdGlvbiggX21hdGNoSW5kZXhlcywgbGVuZ3RoLCBhcmd1bWVudCApIHsNCgkJCXJldHVybiBbIGFyZ3VtZW50IDwgMCA/IGFyZ3VtZW50ICsgbGVuZ3RoIDogYXJndW1lbnQgXTsNCgkJfSApLA0KDQoJCSJldmVuIjogY3JlYXRlUG9zaXRpb25hbFBzZXVkbyggZnVuY3Rpb24oIG1hdGNoSW5kZXhlcywgbGVuZ3RoICkgew0KCQkJdmFyIGkgPSAwOw0KCQkJZm9yICggOyBpIDwgbGVuZ3RoOyBpICs9IDIgKSB7DQoJCQkJbWF0Y2hJbmRleGVzLnB1c2goIGkgKTsNCgkJCX0NCgkJCXJldHVybiBtYXRjaEluZGV4ZXM7DQoJCX0gKSwNCg0KCQkib2RkIjogY3JlYXRlUG9zaXRpb25hbFBzZXVkbyggZnVuY3Rpb24oIG1hdGNoSW5kZXhlcywgbGVuZ3RoICkgew0KCQkJdmFyIGkgPSAxOw0KCQkJZm9yICggOyBpIDwgbGVuZ3RoOyBpICs9IDIgKSB7DQoJCQkJbWF0Y2hJbmRleGVzLnB1c2goIGkgKTsNCgkJCX0NCgkJCXJldHVybiBtYXRjaEluZGV4ZXM7DQoJCX0gKSwNCg0KCQkibHQiOiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKCBmdW5jdGlvbiggbWF0Y2hJbmRleGVzLCBsZW5ndGgsIGFyZ3VtZW50ICkgew0KCQkJdmFyIGkgPSBhcmd1bWVudCA8IDAgPw0KCQkJCWFyZ3VtZW50ICsgbGVuZ3RoIDoNCgkJCQlhcmd1bWVudCA+IGxlbmd0aCA/DQoJCQkJCWxlbmd0aCA6DQoJCQkJCWFyZ3VtZW50Ow0KCQkJZm9yICggOyAtLWkgPj0gMDsgKSB7DQoJCQkJbWF0Y2hJbmRleGVzLnB1c2goIGkgKTsNCgkJCX0NCgkJCXJldHVybiBtYXRjaEluZGV4ZXM7DQoJCX0gKSwNCg0KCQkiZ3QiOiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKCBmdW5jdGlvbiggbWF0Y2hJbmRleGVzLCBsZW5ndGgsIGFyZ3VtZW50ICkgew0KCQkJdmFyIGkgPSBhcmd1bWVudCA8IDAgPyBhcmd1bWVudCArIGxlbmd0aCA6IGFyZ3VtZW50Ow0KCQkJZm9yICggOyArK2kgPCBsZW5ndGg7ICkgew0KCQkJCW1hdGNoSW5kZXhlcy5wdXNoKCBpICk7DQoJCQl9DQoJCQlyZXR1cm4gbWF0Y2hJbmRleGVzOw0KCQl9ICkNCgl9DQp9Ow0KDQpFeHByLnBzZXVkb3NbICJudGgiIF0gPSBFeHByLnBzZXVkb3NbICJlcSIgXTsNCg0KLy8gQWRkIGJ1dHRvbi9pbnB1dCB0eXBlIHBzZXVkb3MNCmZvciAoIGkgaW4geyByYWRpbzogdHJ1ZSwgY2hlY2tib3g6IHRydWUsIGZpbGU6IHRydWUsIHBhc3N3b3JkOiB0cnVlLCBpbWFnZTogdHJ1ZSB9ICkgew0KCUV4cHIucHNldWRvc1sgaSBdID0gY3JlYXRlSW5wdXRQc2V1ZG8oIGkgKTsNCn0NCmZvciAoIGkgaW4geyBzdWJtaXQ6IHRydWUsIHJlc2V0OiB0cnVlIH0gKSB7DQoJRXhwci5wc2V1ZG9zWyBpIF0gPSBjcmVhdGVCdXR0b25Qc2V1ZG8oIGkgKTsNCn0NCg0KLy8gRWFzeSBBUEkgZm9yIGNyZWF0aW5nIG5ldyBzZXRGaWx0ZXJzDQpmdW5jdGlvbiBzZXRGaWx0ZXJzKCkge30NCnNldEZpbHRlcnMucHJvdG90eXBlID0gRXhwci5maWx0ZXJzID0gRXhwci5wc2V1ZG9zOw0KRXhwci5zZXRGaWx0ZXJzID0gbmV3IHNldEZpbHRlcnMoKTsNCg0KdG9rZW5pemUgPSBTaXp6bGUudG9rZW5pemUgPSBmdW5jdGlvbiggc2VsZWN0b3IsIHBhcnNlT25seSApIHsNCgl2YXIgbWF0Y2hlZCwgbWF0Y2gsIHRva2VucywgdHlwZSwNCgkJc29GYXIsIGdyb3VwcywgcHJlRmlsdGVycywNCgkJY2FjaGVkID0gdG9rZW5DYWNoZVsgc2VsZWN0b3IgKyAiICIgXTsNCg0KCWlmICggY2FjaGVkICkgew0KCQlyZXR1cm4gcGFyc2VPbmx5ID8gMCA6IGNhY2hlZC5zbGljZSggMCApOw0KCX0NCg0KCXNvRmFyID0gc2VsZWN0b3I7DQoJZ3JvdXBzID0gW107DQoJcHJlRmlsdGVycyA9IEV4cHIucHJlRmlsdGVyOw0KDQoJd2hpbGUgKCBzb0ZhciApIHsNCg0KCQkvLyBDb21tYSBhbmQgZmlyc3QgcnVuDQoJCWlmICggIW1hdGNoZWQgfHwgKCBtYXRjaCA9IHJjb21tYS5leGVjKCBzb0ZhciApICkgKSB7DQoJCQlpZiAoIG1hdGNoICkgew0KDQoJCQkJLy8gRG9uJ3QgY29uc3VtZSB0cmFpbGluZyBjb21tYXMgYXMgdmFsaWQNCgkJCQlzb0ZhciA9IHNvRmFyLnNsaWNlKCBtYXRjaFsgMCBdLmxlbmd0aCApIHx8IHNvRmFyOw0KCQkJfQ0KCQkJZ3JvdXBzLnB1c2goICggdG9rZW5zID0gW10gKSApOw0KCQl9DQoNCgkJbWF0Y2hlZCA9IGZhbHNlOw0KDQoJCS8vIENvbWJpbmF0b3JzDQoJCWlmICggKCBtYXRjaCA9IHJjb21iaW5hdG9ycy5leGVjKCBzb0ZhciApICkgKSB7DQoJCQltYXRjaGVkID0gbWF0Y2guc2hpZnQoKTsNCgkJCXRva2Vucy5wdXNoKCB7DQoJCQkJdmFsdWU6IG1hdGNoZWQsDQoNCgkJCQkvLyBDYXN0IGRlc2NlbmRhbnQgY29tYmluYXRvcnMgdG8gc3BhY2UNCgkJCQl0eXBlOiBtYXRjaFsgMCBdLnJlcGxhY2UoIHJ0cmltLCAiICIgKQ0KCQkJfSApOw0KCQkJc29GYXIgPSBzb0Zhci5zbGljZSggbWF0Y2hlZC5sZW5ndGggKTsNCgkJfQ0KDQoJCS8vIEZpbHRlcnMNCgkJZm9yICggdHlwZSBpbiBFeHByLmZpbHRlciApIHsNCgkJCWlmICggKCBtYXRjaCA9IG1hdGNoRXhwclsgdHlwZSBdLmV4ZWMoIHNvRmFyICkgKSAmJiAoICFwcmVGaWx0ZXJzWyB0eXBlIF0gfHwNCgkJCQkoIG1hdGNoID0gcHJlRmlsdGVyc1sgdHlwZSBdKCBtYXRjaCApICkgKSApIHsNCgkJCQltYXRjaGVkID0gbWF0Y2guc2hpZnQoKTsNCgkJCQl0b2tlbnMucHVzaCggew0KCQkJCQl2YWx1ZTogbWF0Y2hlZCwNCgkJCQkJdHlwZTogdHlwZSwNCgkJCQkJbWF0Y2hlczogbWF0Y2gNCgkJCQl9ICk7DQoJCQkJc29GYXIgPSBzb0Zhci5zbGljZSggbWF0Y2hlZC5sZW5ndGggKTsNCgkJCX0NCgkJfQ0KDQoJCWlmICggIW1hdGNoZWQgKSB7DQoJCQlicmVhazsNCgkJfQ0KCX0NCg0KCS8vIFJldHVybiB0aGUgbGVuZ3RoIG9mIHRoZSBpbnZhbGlkIGV4Y2Vzcw0KCS8vIGlmIHdlJ3JlIGp1c3QgcGFyc2luZw0KCS8vIE90aGVyd2lzZSwgdGhyb3cgYW4gZXJyb3Igb3IgcmV0dXJuIHRva2Vucw0KCXJldHVybiBwYXJzZU9ubHkgPw0KCQlzb0Zhci5sZW5ndGggOg0KCQlzb0ZhciA/DQoJCQlTaXp6bGUuZXJyb3IoIHNlbGVjdG9yICkgOg0KDQoJCQkvLyBDYWNoZSB0aGUgdG9rZW5zDQoJCQl0b2tlbkNhY2hlKCBzZWxlY3RvciwgZ3JvdXBzICkuc2xpY2UoIDAgKTsNCn07DQoNCmZ1bmN0aW9uIHRvU2VsZWN0b3IoIHRva2VucyApIHsNCgl2YXIgaSA9IDAsDQoJCWxlbiA9IHRva2Vucy5sZW5ndGgsDQoJCXNlbGVjdG9yID0gIiI7DQoJZm9yICggOyBpIDwgbGVuOyBpKysgKSB7DQoJCXNlbGVjdG9yICs9IHRva2Vuc1sgaSBdLnZhbHVlOw0KCX0NCglyZXR1cm4gc2VsZWN0b3I7DQp9DQoNCmZ1bmN0aW9uIGFkZENvbWJpbmF0b3IoIG1hdGNoZXIsIGNvbWJpbmF0b3IsIGJhc2UgKSB7DQoJdmFyIGRpciA9IGNvbWJpbmF0b3IuZGlyLA0KCQlza2lwID0gY29tYmluYXRvci5uZXh0LA0KCQlrZXkgPSBza2lwIHx8IGRpciwNCgkJY2hlY2tOb25FbGVtZW50cyA9IGJhc2UgJiYga2V5ID09PSAicGFyZW50Tm9kZSIsDQoJCWRvbmVOYW1lID0gZG9uZSsrOw0KDQoJcmV0dXJuIGNvbWJpbmF0b3IuZmlyc3QgPw0KDQoJCS8vIENoZWNrIGFnYWluc3QgY2xvc2VzdCBhbmNlc3Rvci9wcmVjZWRpbmcgZWxlbWVudA0KCQlmdW5jdGlvbiggZWxlbSwgY29udGV4dCwgeG1sICkgew0KCQkJd2hpbGUgKCAoIGVsZW0gPSBlbGVtWyBkaXIgXSApICkgew0KCQkJCWlmICggZWxlbS5ub2RlVHlwZSA9PT0gMSB8fCBjaGVja05vbkVsZW1lbnRzICkgew0KCQkJCQlyZXR1cm4gbWF0Y2hlciggZWxlbSwgY29udGV4dCwgeG1sICk7DQoJCQkJfQ0KCQkJfQ0KCQkJcmV0dXJuIGZhbHNlOw0KCQl9IDoNCg0KCQkvLyBDaGVjayBhZ2FpbnN0IGFsbCBhbmNlc3Rvci9wcmVjZWRpbmcgZWxlbWVudHMNCgkJZnVuY3Rpb24oIGVsZW0sIGNvbnRleHQsIHhtbCApIHsNCgkJCXZhciBvbGRDYWNoZSwgdW5pcXVlQ2FjaGUsIG91dGVyQ2FjaGUsDQoJCQkJbmV3Q2FjaGUgPSBbIGRpcnJ1bnMsIGRvbmVOYW1lIF07DQoNCgkJCS8vIFdlIGNhbid0IHNldCBhcmJpdHJhcnkgZGF0YSBvbiBYTUwgbm9kZXMsIHNvIHRoZXkgZG9uJ3QgYmVuZWZpdCBmcm9tIGNvbWJpbmF0b3IgY2FjaGluZw0KCQkJaWYgKCB4bWwgKSB7DQoJCQkJd2hpbGUgKCAoIGVsZW0gPSBlbGVtWyBkaXIgXSApICkgew0KCQkJCQlpZiAoIGVsZW0ubm9kZVR5cGUgPT09IDEgfHwgY2hlY2tOb25FbGVtZW50cyApIHsNCgkJCQkJCWlmICggbWF0Y2hlciggZWxlbSwgY29udGV4dCwgeG1sICkgKSB7DQoJCQkJCQkJcmV0dXJuIHRydWU7DQoJCQkJCQl9DQoJCQkJCX0NCgkJCQl9DQoJCQl9IGVsc2Ugew0KCQkJCXdoaWxlICggKCBlbGVtID0gZWxlbVsgZGlyIF0gKSApIHsNCgkJCQkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxIHx8IGNoZWNrTm9uRWxlbWVudHMgKSB7DQoJCQkJCQlvdXRlckNhY2hlID0gZWxlbVsgZXhwYW5kbyBdIHx8ICggZWxlbVsgZXhwYW5kbyBdID0ge30gKTsNCg0KCQkJCQkJLy8gU3VwcG9ydDogSUUgPDkgb25seQ0KCQkJCQkJLy8gRGVmZW5kIGFnYWluc3QgY2xvbmVkIGF0dHJvcGVydGllcyAoalF1ZXJ5IGdoLTE3MDkpDQoJCQkJCQl1bmlxdWVDYWNoZSA9IG91dGVyQ2FjaGVbIGVsZW0udW5pcXVlSUQgXSB8fA0KCQkJCQkJCSggb3V0ZXJDYWNoZVsgZWxlbS51bmlxdWVJRCBdID0ge30gKTsNCg0KCQkJCQkJaWYgKCBza2lwICYmIHNraXAgPT09IGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSApIHsNCgkJCQkJCQllbGVtID0gZWxlbVsgZGlyIF0gfHwgZWxlbTsNCgkJCQkJCX0gZWxzZSBpZiAoICggb2xkQ2FjaGUgPSB1bmlxdWVDYWNoZVsga2V5IF0gKSAmJg0KCQkJCQkJCW9sZENhY2hlWyAwIF0gPT09IGRpcnJ1bnMgJiYgb2xkQ2FjaGVbIDEgXSA9PT0gZG9uZU5hbWUgKSB7DQoNCgkJCQkJCQkvLyBBc3NpZ24gdG8gbmV3Q2FjaGUgc28gcmVzdWx0cyBiYWNrLXByb3BhZ2F0ZSB0byBwcmV2aW91cyBlbGVtZW50cw0KCQkJCQkJCXJldHVybiAoIG5ld0NhY2hlWyAyIF0gPSBvbGRDYWNoZVsgMiBdICk7DQoJCQkJCQl9IGVsc2Ugew0KDQoJCQkJCQkJLy8gUmV1c2UgbmV3Y2FjaGUgc28gcmVzdWx0cyBiYWNrLXByb3BhZ2F0ZSB0byBwcmV2aW91cyBlbGVtZW50cw0KCQkJCQkJCXVuaXF1ZUNhY2hlWyBrZXkgXSA9IG5ld0NhY2hlOw0KDQoJCQkJCQkJLy8gQSBtYXRjaCBtZWFucyB3ZSdyZSBkb25lOyBhIGZhaWwgbWVhbnMgd2UgaGF2ZSB0byBrZWVwIGNoZWNraW5nDQoJCQkJCQkJaWYgKCAoIG5ld0NhY2hlWyAyIF0gPSBtYXRjaGVyKCBlbGVtLCBjb250ZXh0LCB4bWwgKSApICkgew0KCQkJCQkJCQlyZXR1cm4gdHJ1ZTsNCgkJCQkJCQl9DQoJCQkJCQl9DQoJCQkJCX0NCgkJCQl9DQoJCQl9DQoJCQlyZXR1cm4gZmFsc2U7DQoJCX07DQp9DQoNCmZ1bmN0aW9uIGVsZW1lbnRNYXRjaGVyKCBtYXRjaGVycyApIHsNCglyZXR1cm4gbWF0Y2hlcnMubGVuZ3RoID4gMSA/DQoJCWZ1bmN0aW9uKCBlbGVtLCBjb250ZXh0LCB4bWwgKSB7DQoJCQl2YXIgaSA9IG1hdGNoZXJzLmxlbmd0aDsNCgkJCXdoaWxlICggaS0tICkgew0KCQkJCWlmICggIW1hdGNoZXJzWyBpIF0oIGVsZW0sIGNvbnRleHQsIHhtbCApICkgew0KCQkJCQlyZXR1cm4gZmFsc2U7DQoJCQkJfQ0KCQkJfQ0KCQkJcmV0dXJuIHRydWU7DQoJCX0gOg0KCQltYXRjaGVyc1sgMCBdOw0KfQ0KDQpmdW5jdGlvbiBtdWx0aXBsZUNvbnRleHRzKCBzZWxlY3RvciwgY29udGV4dHMsIHJlc3VsdHMgKSB7DQoJdmFyIGkgPSAwLA0KCQlsZW4gPSBjb250ZXh0cy5sZW5ndGg7DQoJZm9yICggOyBpIDwgbGVuOyBpKysgKSB7DQoJCVNpenpsZSggc2VsZWN0b3IsIGNvbnRleHRzWyBpIF0sIHJlc3VsdHMgKTsNCgl9DQoJcmV0dXJuIHJlc3VsdHM7DQp9DQoNCmZ1bmN0aW9uIGNvbmRlbnNlKCB1bm1hdGNoZWQsIG1hcCwgZmlsdGVyLCBjb250ZXh0LCB4bWwgKSB7DQoJdmFyIGVsZW0sDQoJCW5ld1VubWF0Y2hlZCA9IFtdLA0KCQlpID0gMCwNCgkJbGVuID0gdW5tYXRjaGVkLmxlbmd0aCwNCgkJbWFwcGVkID0gbWFwICE9IG51bGw7DQoNCglmb3IgKCA7IGkgPCBsZW47IGkrKyApIHsNCgkJaWYgKCAoIGVsZW0gPSB1bm1hdGNoZWRbIGkgXSApICkgew0KCQkJaWYgKCAhZmlsdGVyIHx8IGZpbHRlciggZWxlbSwgY29udGV4dCwgeG1sICkgKSB7DQoJCQkJbmV3VW5tYXRjaGVkLnB1c2goIGVsZW0gKTsNCgkJCQlpZiAoIG1hcHBlZCApIHsNCgkJCQkJbWFwLnB1c2goIGkgKTsNCgkJCQl9DQoJCQl9DQoJCX0NCgl9DQoNCglyZXR1cm4gbmV3VW5tYXRjaGVkOw0KfQ0KDQpmdW5jdGlvbiBzZXRNYXRjaGVyKCBwcmVGaWx0ZXIsIHNlbGVjdG9yLCBtYXRjaGVyLCBwb3N0RmlsdGVyLCBwb3N0RmluZGVyLCBwb3N0U2VsZWN0b3IgKSB7DQoJaWYgKCBwb3N0RmlsdGVyICYmICFwb3N0RmlsdGVyWyBleHBhbmRvIF0gKSB7DQoJCXBvc3RGaWx0ZXIgPSBzZXRNYXRjaGVyKCBwb3N0RmlsdGVyICk7DQoJfQ0KCWlmICggcG9zdEZpbmRlciAmJiAhcG9zdEZpbmRlclsgZXhwYW5kbyBdICkgew0KCQlwb3N0RmluZGVyID0gc2V0TWF0Y2hlciggcG9zdEZpbmRlciwgcG9zdFNlbGVjdG9yICk7DQoJfQ0KCXJldHVybiBtYXJrRnVuY3Rpb24oIGZ1bmN0aW9uKCBzZWVkLCByZXN1bHRzLCBjb250ZXh0LCB4bWwgKSB7DQoJCXZhciB0ZW1wLCBpLCBlbGVtLA0KCQkJcHJlTWFwID0gW10sDQoJCQlwb3N0TWFwID0gW10sDQoJCQlwcmVleGlzdGluZyA9IHJlc3VsdHMubGVuZ3RoLA0KDQoJCQkvLyBHZXQgaW5pdGlhbCBlbGVtZW50cyBmcm9tIHNlZWQgb3IgY29udGV4dA0KCQkJZWxlbXMgPSBzZWVkIHx8IG11bHRpcGxlQ29udGV4dHMoDQoJCQkJc2VsZWN0b3IgfHwgIioiLA0KCQkJCWNvbnRleHQubm9kZVR5cGUgPyBbIGNvbnRleHQgXSA6IGNvbnRleHQsDQoJCQkJW10NCgkJCSksDQoNCgkJCS8vIFByZWZpbHRlciB0byBnZXQgbWF0Y2hlciBpbnB1dCwgcHJlc2VydmluZyBhIG1hcCBmb3Igc2VlZC1yZXN1bHRzIHN5bmNocm9uaXphdGlvbg0KCQkJbWF0Y2hlckluID0gcHJlRmlsdGVyICYmICggc2VlZCB8fCAhc2VsZWN0b3IgKSA/DQoJCQkJY29uZGVuc2UoIGVsZW1zLCBwcmVNYXAsIHByZUZpbHRlciwgY29udGV4dCwgeG1sICkgOg0KCQkJCWVsZW1zLA0KDQoJCQltYXRjaGVyT3V0ID0gbWF0Y2hlciA/DQoNCgkJCQkvLyBJZiB3ZSBoYXZlIGEgcG9zdEZpbmRlciwgb3IgZmlsdGVyZWQgc2VlZCwgb3Igbm9uLXNlZWQgcG9zdEZpbHRlciBvciBwcmVleGlzdGluZyByZXN1bHRzLA0KCQkJCXBvc3RGaW5kZXIgfHwgKCBzZWVkID8gcHJlRmlsdGVyIDogcHJlZXhpc3RpbmcgfHwgcG9zdEZpbHRlciApID8NCg0KCQkJCQkvLyAuLi5pbnRlcm1lZGlhdGUgcHJvY2Vzc2luZyBpcyBuZWNlc3NhcnkNCgkJCQkJW10gOg0KDQoJCQkJCS8vIC4uLm90aGVyd2lzZSB1c2UgcmVzdWx0cyBkaXJlY3RseQ0KCQkJCQlyZXN1bHRzIDoNCgkJCQltYXRjaGVySW47DQoNCgkJLy8gRmluZCBwcmltYXJ5IG1hdGNoZXMNCgkJaWYgKCBtYXRjaGVyICkgew0KCQkJbWF0Y2hlciggbWF0Y2hlckluLCBtYXRjaGVyT3V0LCBjb250ZXh0LCB4bWwgKTsNCgkJfQ0KDQoJCS8vIEFwcGx5IHBvc3RGaWx0ZXINCgkJaWYgKCBwb3N0RmlsdGVyICkgew0KCQkJdGVtcCA9IGNvbmRlbnNlKCBtYXRjaGVyT3V0LCBwb3N0TWFwICk7DQoJCQlwb3N0RmlsdGVyKCB0ZW1wLCBbXSwgY29udGV4dCwgeG1sICk7DQoNCgkJCS8vIFVuLW1hdGNoIGZhaWxpbmcgZWxlbWVudHMgYnkgbW92aW5nIHRoZW0gYmFjayB0byBtYXRjaGVySW4NCgkJCWkgPSB0ZW1wLmxlbmd0aDsNCgkJCXdoaWxlICggaS0tICkgew0KCQkJCWlmICggKCBlbGVtID0gdGVtcFsgaSBdICkgKSB7DQoJCQkJCW1hdGNoZXJPdXRbIHBvc3RNYXBbIGkgXSBdID0gISggbWF0Y2hlckluWyBwb3N0TWFwWyBpIF0gXSA9IGVsZW0gKTsNCgkJCQl9DQoJCQl9DQoJCX0NCg0KCQlpZiAoIHNlZWQgKSB7DQoJCQlpZiAoIHBvc3RGaW5kZXIgfHwgcHJlRmlsdGVyICkgew0KCQkJCWlmICggcG9zdEZpbmRlciApIHsNCg0KCQkJCQkvLyBHZXQgdGhlIGZpbmFsIG1hdGNoZXJPdXQgYnkgY29uZGVuc2luZyB0aGlzIGludGVybWVkaWF0ZSBpbnRvIHBvc3RGaW5kZXIgY29udGV4dHMNCgkJCQkJdGVtcCA9IFtdOw0KCQkJCQlpID0gbWF0Y2hlck91dC5sZW5ndGg7DQoJCQkJCXdoaWxlICggaS0tICkgew0KCQkJCQkJaWYgKCAoIGVsZW0gPSBtYXRjaGVyT3V0WyBpIF0gKSApIHsNCg0KCQkJCQkJCS8vIFJlc3RvcmUgbWF0Y2hlckluIHNpbmNlIGVsZW0gaXMgbm90IHlldCBhIGZpbmFsIG1hdGNoDQoJCQkJCQkJdGVtcC5wdXNoKCAoIG1hdGNoZXJJblsgaSBdID0gZWxlbSApICk7DQoJCQkJCQl9DQoJCQkJCX0NCgkJCQkJcG9zdEZpbmRlciggbnVsbCwgKCBtYXRjaGVyT3V0ID0gW10gKSwgdGVtcCwgeG1sICk7DQoJCQkJfQ0KDQoJCQkJLy8gTW92ZSBtYXRjaGVkIGVsZW1lbnRzIGZyb20gc2VlZCB0byByZXN1bHRzIHRvIGtlZXAgdGhlbSBzeW5jaHJvbml6ZWQNCgkJCQlpID0gbWF0Y2hlck91dC5sZW5ndGg7DQoJCQkJd2hpbGUgKCBpLS0gKSB7DQoJCQkJCWlmICggKCBlbGVtID0gbWF0Y2hlck91dFsgaSBdICkgJiYNCgkJCQkJCSggdGVtcCA9IHBvc3RGaW5kZXIgPyBpbmRleE9mKCBzZWVkLCBlbGVtICkgOiBwcmVNYXBbIGkgXSApID4gLTEgKSB7DQoNCgkJCQkJCXNlZWRbIHRlbXAgXSA9ICEoIHJlc3VsdHNbIHRlbXAgXSA9IGVsZW0gKTsNCgkJCQkJfQ0KCQkJCX0NCgkJCX0NCg0KCQkvLyBBZGQgZWxlbWVudHMgdG8gcmVzdWx0cywgdGhyb3VnaCBwb3N0RmluZGVyIGlmIGRlZmluZWQNCgkJfSBlbHNlIHsNCgkJCW1hdGNoZXJPdXQgPSBjb25kZW5zZSgNCgkJCQltYXRjaGVyT3V0ID09PSByZXN1bHRzID8NCgkJCQkJbWF0Y2hlck91dC5zcGxpY2UoIHByZWV4aXN0aW5nLCBtYXRjaGVyT3V0Lmxlbmd0aCApIDoNCgkJCQkJbWF0Y2hlck91dA0KCQkJKTsNCgkJCWlmICggcG9zdEZpbmRlciApIHsNCgkJCQlwb3N0RmluZGVyKCBudWxsLCByZXN1bHRzLCBtYXRjaGVyT3V0LCB4bWwgKTsNCgkJCX0gZWxzZSB7DQoJCQkJcHVzaC5hcHBseSggcmVzdWx0cywgbWF0Y2hlck91dCApOw0KCQkJfQ0KCQl9DQoJfSApOw0KfQ0KDQpmdW5jdGlvbiBtYXRjaGVyRnJvbVRva2VucyggdG9rZW5zICkgew0KCXZhciBjaGVja0NvbnRleHQsIG1hdGNoZXIsIGosDQoJCWxlbiA9IHRva2Vucy5sZW5ndGgsDQoJCWxlYWRpbmdSZWxhdGl2ZSA9IEV4cHIucmVsYXRpdmVbIHRva2Vuc1sgMCBdLnR5cGUgXSwNCgkJaW1wbGljaXRSZWxhdGl2ZSA9IGxlYWRpbmdSZWxhdGl2ZSB8fCBFeHByLnJlbGF0aXZlWyAiICIgXSwNCgkJaSA9IGxlYWRpbmdSZWxhdGl2ZSA/IDEgOiAwLA0KDQoJCS8vIFRoZSBmb3VuZGF0aW9uYWwgbWF0Y2hlciBlbnN1cmVzIHRoYXQgZWxlbWVudHMgYXJlIHJlYWNoYWJsZSBmcm9tIHRvcC1sZXZlbCBjb250ZXh0KHMpDQoJCW1hdGNoQ29udGV4dCA9IGFkZENvbWJpbmF0b3IoIGZ1bmN0aW9uKCBlbGVtICkgew0KCQkJcmV0dXJuIGVsZW0gPT09IGNoZWNrQ29udGV4dDsNCgkJfSwgaW1wbGljaXRSZWxhdGl2ZSwgdHJ1ZSApLA0KCQltYXRjaEFueUNvbnRleHQgPSBhZGRDb21iaW5hdG9yKCBmdW5jdGlvbiggZWxlbSApIHsNCgkJCXJldHVybiBpbmRleE9mKCBjaGVja0NvbnRleHQsIGVsZW0gKSA+IC0xOw0KCQl9LCBpbXBsaWNpdFJlbGF0aXZlLCB0cnVlICksDQoJCW1hdGNoZXJzID0gWyBmdW5jdGlvbiggZWxlbSwgY29udGV4dCwgeG1sICkgew0KCQkJdmFyIHJldCA9ICggIWxlYWRpbmdSZWxhdGl2ZSAmJiAoIHhtbCB8fCBjb250ZXh0ICE9PSBvdXRlcm1vc3RDb250ZXh0ICkgKSB8fCAoDQoJCQkJKCBjaGVja0NvbnRleHQgPSBjb250ZXh0ICkubm9kZVR5cGUgPw0KCQkJCQltYXRjaENvbnRleHQoIGVsZW0sIGNvbnRleHQsIHhtbCApIDoNCgkJCQkJbWF0Y2hBbnlDb250ZXh0KCBlbGVtLCBjb250ZXh0LCB4bWwgKSApOw0KDQoJCQkvLyBBdm9pZCBoYW5naW5nIG9udG8gZWxlbWVudCAoaXNzdWUgIzI5OSkNCgkJCWNoZWNrQ29udGV4dCA9IG51bGw7DQoJCQlyZXR1cm4gcmV0Ow0KCQl9IF07DQoNCglmb3IgKCA7IGkgPCBsZW47IGkrKyApIHsNCgkJaWYgKCAoIG1hdGNoZXIgPSBFeHByLnJlbGF0aXZlWyB0b2tlbnNbIGkgXS50eXBlIF0gKSApIHsNCgkJCW1hdGNoZXJzID0gWyBhZGRDb21iaW5hdG9yKCBlbGVtZW50TWF0Y2hlciggbWF0Y2hlcnMgKSwgbWF0Y2hlciApIF07DQoJCX0gZWxzZSB7DQoJCQltYXRjaGVyID0gRXhwci5maWx0ZXJbIHRva2Vuc1sgaSBdLnR5cGUgXS5hcHBseSggbnVsbCwgdG9rZW5zWyBpIF0ubWF0Y2hlcyApOw0KDQoJCQkvLyBSZXR1cm4gc3BlY2lhbCB1cG9uIHNlZWluZyBhIHBvc2l0aW9uYWwgbWF0Y2hlcg0KCQkJaWYgKCBtYXRjaGVyWyBleHBhbmRvIF0gKSB7DQoNCgkJCQkvLyBGaW5kIHRoZSBuZXh0IHJlbGF0aXZlIG9wZXJhdG9yIChpZiBhbnkpIGZvciBwcm9wZXIgaGFuZGxpbmcNCgkJCQlqID0gKytpOw0KCQkJCWZvciAoIDsgaiA8IGxlbjsgaisrICkgew0KCQkJCQlpZiAoIEV4cHIucmVsYXRpdmVbIHRva2Vuc1sgaiBdLnR5cGUgXSApIHsNCgkJCQkJCWJyZWFrOw0KCQkJCQl9DQoJCQkJfQ0KCQkJCXJldHVybiBzZXRNYXRjaGVyKA0KCQkJCQlpID4gMSAmJiBlbGVtZW50TWF0Y2hlciggbWF0Y2hlcnMgKSwNCgkJCQkJaSA+IDEgJiYgdG9TZWxlY3RvcigNCg0KCQkJCQkvLyBJZiB0aGUgcHJlY2VkaW5nIHRva2VuIHdhcyBhIGRlc2NlbmRhbnQgY29tYmluYXRvciwgaW5zZXJ0IGFuIGltcGxpY2l0IGFueS1lbGVtZW50IGAqYA0KCQkJCQl0b2tlbnMNCgkJCQkJCS5zbGljZSggMCwgaSAtIDEgKQ0KCQkJCQkJLmNvbmNhdCggeyB2YWx1ZTogdG9rZW5zWyBpIC0gMiBdLnR5cGUgPT09ICIgIiA/ICIqIiA6ICIiIH0gKQ0KCQkJCQkpLnJlcGxhY2UoIHJ0cmltLCAiJDEiICksDQoJCQkJCW1hdGNoZXIsDQoJCQkJCWkgPCBqICYmIG1hdGNoZXJGcm9tVG9rZW5zKCB0b2tlbnMuc2xpY2UoIGksIGogKSApLA0KCQkJCQlqIDwgbGVuICYmIG1hdGNoZXJGcm9tVG9rZW5zKCAoIHRva2VucyA9IHRva2Vucy5zbGljZSggaiApICkgKSwNCgkJCQkJaiA8IGxlbiAmJiB0b1NlbGVjdG9yKCB0b2tlbnMgKQ0KCQkJCSk7DQoJCQl9DQoJCQltYXRjaGVycy5wdXNoKCBtYXRjaGVyICk7DQoJCX0NCgl9DQoNCglyZXR1cm4gZWxlbWVudE1hdGNoZXIoIG1hdGNoZXJzICk7DQp9DQoNCmZ1bmN0aW9uIG1hdGNoZXJGcm9tR3JvdXBNYXRjaGVycyggZWxlbWVudE1hdGNoZXJzLCBzZXRNYXRjaGVycyApIHsNCgl2YXIgYnlTZXQgPSBzZXRNYXRjaGVycy5sZW5ndGggPiAwLA0KCQlieUVsZW1lbnQgPSBlbGVtZW50TWF0Y2hlcnMubGVuZ3RoID4gMCwNCgkJc3VwZXJNYXRjaGVyID0gZnVuY3Rpb24oIHNlZWQsIGNvbnRleHQsIHhtbCwgcmVzdWx0cywgb3V0ZXJtb3N0ICkgew0KCQkJdmFyIGVsZW0sIGosIG1hdGNoZXIsDQoJCQkJbWF0Y2hlZENvdW50ID0gMCwNCgkJCQlpID0gIjAiLA0KCQkJCXVubWF0Y2hlZCA9IHNlZWQgJiYgW10sDQoJCQkJc2V0TWF0Y2hlZCA9IFtdLA0KCQkJCWNvbnRleHRCYWNrdXAgPSBvdXRlcm1vc3RDb250ZXh0LA0KDQoJCQkJLy8gV2UgbXVzdCBhbHdheXMgaGF2ZSBlaXRoZXIgc2VlZCBlbGVtZW50cyBvciBvdXRlcm1vc3QgY29udGV4dA0KCQkJCWVsZW1zID0gc2VlZCB8fCBieUVsZW1lbnQgJiYgRXhwci5maW5kWyAiVEFHIiBdKCAiKiIsIG91dGVybW9zdCApLA0KDQoJCQkJLy8gVXNlIGludGVnZXIgZGlycnVucyBpZmYgdGhpcyBpcyB0aGUgb3V0ZXJtb3N0IG1hdGNoZXINCgkJCQlkaXJydW5zVW5pcXVlID0gKCBkaXJydW5zICs9IGNvbnRleHRCYWNrdXAgPT0gbnVsbCA/IDEgOiBNYXRoLnJhbmRvbSgpIHx8IDAuMSApLA0KCQkJCWxlbiA9IGVsZW1zLmxlbmd0aDsNCg0KCQkJaWYgKCBvdXRlcm1vc3QgKSB7DQoNCgkJCQkvLyBTdXBwb3J0OiBJRSAxMSssIEVkZ2UgMTcgLSAxOCsNCgkJCQkvLyBJRS9FZGdlIHNvbWV0aW1lcyB0aHJvdyBhICJQZXJtaXNzaW9uIGRlbmllZCIgZXJyb3Igd2hlbiBzdHJpY3QtY29tcGFyaW5nDQoJCQkJLy8gdHdvIGRvY3VtZW50czsgc2hhbGxvdyBjb21wYXJpc29ucyB3b3JrLg0KCQkJCS8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBlcWVxZXENCgkJCQlvdXRlcm1vc3RDb250ZXh0ID0gY29udGV4dCA9PSBkb2N1bWVudCB8fCBjb250ZXh0IHx8IG91dGVybW9zdDsNCgkJCX0NCg0KCQkJLy8gQWRkIGVsZW1lbnRzIHBhc3NpbmcgZWxlbWVudE1hdGNoZXJzIGRpcmVjdGx5IHRvIHJlc3VsdHMNCgkJCS8vIFN1cHBvcnQ6IElFPDksIFNhZmFyaQ0KCQkJLy8gVG9sZXJhdGUgTm9kZUxpc3QgcHJvcGVydGllcyAoSUU6ICJsZW5ndGgiOyBTYWZhcmk6IDxudW1iZXI+KSBtYXRjaGluZyBlbGVtZW50cyBieSBpZA0KCQkJZm9yICggOyBpICE9PSBsZW4gJiYgKCBlbGVtID0gZWxlbXNbIGkgXSApICE9IG51bGw7IGkrKyApIHsNCgkJCQlpZiAoIGJ5RWxlbWVudCAmJiBlbGVtICkgew0KCQkJCQlqID0gMDsNCg0KCQkJCQkvLyBTdXBwb3J0OiBJRSAxMSssIEVkZ2UgMTcgLSAxOCsNCgkJCQkJLy8gSUUvRWRnZSBzb21ldGltZXMgdGhyb3cgYSAiUGVybWlzc2lvbiBkZW5pZWQiIGVycm9yIHdoZW4gc3RyaWN0LWNvbXBhcmluZw0KCQkJCQkvLyB0d28gZG9jdW1lbnRzOyBzaGFsbG93IGNvbXBhcmlzb25zIHdvcmsuDQoJCQkJCS8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBlcWVxZXENCgkJCQkJaWYgKCAhY29udGV4dCAmJiBlbGVtLm93bmVyRG9jdW1lbnQgIT0gZG9jdW1lbnQgKSB7DQoJCQkJCQlzZXREb2N1bWVudCggZWxlbSApOw0KCQkJCQkJeG1sID0gIWRvY3VtZW50SXNIVE1MOw0KCQkJCQl9DQoJCQkJCXdoaWxlICggKCBtYXRjaGVyID0gZWxlbWVudE1hdGNoZXJzWyBqKysgXSApICkgew0KCQkJCQkJaWYgKCBtYXRjaGVyKCBlbGVtLCBjb250ZXh0IHx8IGRvY3VtZW50LCB4bWwgKSApIHsNCgkJCQkJCQlyZXN1bHRzLnB1c2goIGVsZW0gKTsNCgkJCQkJCQlicmVhazsNCgkJCQkJCX0NCgkJCQkJfQ0KCQkJCQlpZiAoIG91dGVybW9zdCApIHsNCgkJCQkJCWRpcnJ1bnMgPSBkaXJydW5zVW5pcXVlOw0KCQkJCQl9DQoJCQkJfQ0KDQoJCQkJLy8gVHJhY2sgdW5tYXRjaGVkIGVsZW1lbnRzIGZvciBzZXQgZmlsdGVycw0KCQkJCWlmICggYnlTZXQgKSB7DQoNCgkJCQkJLy8gVGhleSB3aWxsIGhhdmUgZ29uZSB0aHJvdWdoIGFsbCBwb3NzaWJsZSBtYXRjaGVycw0KCQkJCQlpZiAoICggZWxlbSA9ICFtYXRjaGVyICYmIGVsZW0gKSApIHsNCgkJCQkJCW1hdGNoZWRDb3VudC0tOw0KCQkJCQl9DQoNCgkJCQkJLy8gTGVuZ3RoZW4gdGhlIGFycmF5IGZvciBldmVyeSBlbGVtZW50LCBtYXRjaGVkIG9yIG5vdA0KCQkJCQlpZiAoIHNlZWQgKSB7DQoJCQkJCQl1bm1hdGNoZWQucHVzaCggZWxlbSApOw0KCQkJCQl9DQoJCQkJfQ0KCQkJfQ0KDQoJCQkvLyBgaWAgaXMgbm93IHRoZSBjb3VudCBvZiBlbGVtZW50cyB2aXNpdGVkIGFib3ZlLCBhbmQgYWRkaW5nIGl0IHRvIGBtYXRjaGVkQ291bnRgDQoJCQkvLyBtYWtlcyB0aGUgbGF0dGVyIG5vbm5lZ2F0aXZlLg0KCQkJbWF0Y2hlZENvdW50ICs9IGk7DQoNCgkJCS8vIEFwcGx5IHNldCBmaWx0ZXJzIHRvIHVubWF0Y2hlZCBlbGVtZW50cw0KCQkJLy8gTk9URTogVGhpcyBjYW4gYmUgc2tpcHBlZCBpZiB0aGVyZSBhcmUgbm8gdW5tYXRjaGVkIGVsZW1lbnRzIChpLmUuLCBgbWF0Y2hlZENvdW50YA0KCQkJLy8gZXF1YWxzIGBpYCksIHVubGVzcyB3ZSBkaWRuJ3QgdmlzaXQgX2FueV8gZWxlbWVudHMgaW4gdGhlIGFib3ZlIGxvb3AgYmVjYXVzZSB3ZSBoYXZlDQoJCQkvLyBubyBlbGVtZW50IG1hdGNoZXJzIGFuZCBubyBzZWVkLg0KCQkJLy8gSW5jcmVtZW50aW5nIGFuIGluaXRpYWxseS1zdHJpbmcgIjAiIGBpYCBhbGxvd3MgYGlgIHRvIHJlbWFpbiBhIHN0cmluZyBvbmx5IGluIHRoYXQNCgkJCS8vIGNhc2UsIHdoaWNoIHdpbGwgcmVzdWx0IGluIGEgIjAwIiBgbWF0Y2hlZENvdW50YCB0aGF0IGRpZmZlcnMgZnJvbSBgaWAgYnV0IGlzIGFsc28NCgkJCS8vIG51bWVyaWNhbGx5IHplcm8uDQoJCQlpZiAoIGJ5U2V0ICYmIGkgIT09IG1hdGNoZWRDb3VudCApIHsNCgkJCQlqID0gMDsNCgkJCQl3aGlsZSAoICggbWF0Y2hlciA9IHNldE1hdGNoZXJzWyBqKysgXSApICkgew0KCQkJCQltYXRjaGVyKCB1bm1hdGNoZWQsIHNldE1hdGNoZWQsIGNvbnRleHQsIHhtbCApOw0KCQkJCX0NCg0KCQkJCWlmICggc2VlZCApIHsNCg0KCQkJCQkvLyBSZWludGVncmF0ZSBlbGVtZW50IG1hdGNoZXMgdG8gZWxpbWluYXRlIHRoZSBuZWVkIGZvciBzb3J0aW5nDQoJCQkJCWlmICggbWF0Y2hlZENvdW50ID4gMCApIHsNCgkJCQkJCXdoaWxlICggaS0tICkgew0KCQkJCQkJCWlmICggISggdW5tYXRjaGVkWyBpIF0gfHwgc2V0TWF0Y2hlZFsgaSBdICkgKSB7DQoJCQkJCQkJCXNldE1hdGNoZWRbIGkgXSA9IHBvcC5jYWxsKCByZXN1bHRzICk7DQoJCQkJCQkJfQ0KCQkJCQkJfQ0KCQkJCQl9DQoNCgkJCQkJLy8gRGlzY2FyZCBpbmRleCBwbGFjZWhvbGRlciB2YWx1ZXMgdG8gZ2V0IG9ubHkgYWN0dWFsIG1hdGNoZXMNCgkJCQkJc2V0TWF0Y2hlZCA9IGNvbmRlbnNlKCBzZXRNYXRjaGVkICk7DQoJCQkJfQ0KDQoJCQkJLy8gQWRkIG1hdGNoZXMgdG8gcmVzdWx0cw0KCQkJCXB1c2guYXBwbHkoIHJlc3VsdHMsIHNldE1hdGNoZWQgKTsNCg0KCQkJCS8vIFNlZWRsZXNzIHNldCBtYXRjaGVzIHN1Y2NlZWRpbmcgbXVsdGlwbGUgc3VjY2Vzc2Z1bCBtYXRjaGVycyBzdGlwdWxhdGUgc29ydGluZw0KCQkJCWlmICggb3V0ZXJtb3N0ICYmICFzZWVkICYmIHNldE1hdGNoZWQubGVuZ3RoID4gMCAmJg0KCQkJCQkoIG1hdGNoZWRDb3VudCArIHNldE1hdGNoZXJzLmxlbmd0aCApID4gMSApIHsNCg0KCQkJCQlTaXp6bGUudW5pcXVlU29ydCggcmVzdWx0cyApOw0KCQkJCX0NCgkJCX0NCg0KCQkJLy8gT3ZlcnJpZGUgbWFuaXB1bGF0aW9uIG9mIGdsb2JhbHMgYnkgbmVzdGVkIG1hdGNoZXJzDQoJCQlpZiAoIG91dGVybW9zdCApIHsNCgkJCQlkaXJydW5zID0gZGlycnVuc1VuaXF1ZTsNCgkJCQlvdXRlcm1vc3RDb250ZXh0ID0gY29udGV4dEJhY2t1cDsNCgkJCX0NCg0KCQkJcmV0dXJuIHVubWF0Y2hlZDsNCgkJfTsNCg0KCXJldHVybiBieVNldCA/DQoJCW1hcmtGdW5jdGlvbiggc3VwZXJNYXRjaGVyICkgOg0KCQlzdXBlck1hdGNoZXI7DQp9DQoNCmNvbXBpbGUgPSBTaXp6bGUuY29tcGlsZSA9IGZ1bmN0aW9uKCBzZWxlY3RvciwgbWF0Y2ggLyogSW50ZXJuYWwgVXNlIE9ubHkgKi8gKSB7DQoJdmFyIGksDQoJCXNldE1hdGNoZXJzID0gW10sDQoJCWVsZW1lbnRNYXRjaGVycyA9IFtdLA0KCQljYWNoZWQgPSBjb21waWxlckNhY2hlWyBzZWxlY3RvciArICIgIiBdOw0KDQoJaWYgKCAhY2FjaGVkICkgew0KDQoJCS8vIEdlbmVyYXRlIGEgZnVuY3Rpb24gb2YgcmVjdXJzaXZlIGZ1bmN0aW9ucyB0aGF0IGNhbiBiZSB1c2VkIHRvIGNoZWNrIGVhY2ggZWxlbWVudA0KCQlpZiAoICFtYXRjaCApIHsNCgkJCW1hdGNoID0gdG9rZW5pemUoIHNlbGVjdG9yICk7DQoJCX0NCgkJaSA9IG1hdGNoLmxlbmd0aDsNCgkJd2hpbGUgKCBpLS0gKSB7DQoJCQljYWNoZWQgPSBtYXRjaGVyRnJvbVRva2VucyggbWF0Y2hbIGkgXSApOw0KCQkJaWYgKCBjYWNoZWRbIGV4cGFuZG8gXSApIHsNCgkJCQlzZXRNYXRjaGVycy5wdXNoKCBjYWNoZWQgKTsNCgkJCX0gZWxzZSB7DQoJCQkJZWxlbWVudE1hdGNoZXJzLnB1c2goIGNhY2hlZCApOw0KCQkJfQ0KCQl9DQoNCgkJLy8gQ2FjaGUgdGhlIGNvbXBpbGVkIGZ1bmN0aW9uDQoJCWNhY2hlZCA9IGNvbXBpbGVyQ2FjaGUoDQoJCQlzZWxlY3RvciwNCgkJCW1hdGNoZXJGcm9tR3JvdXBNYXRjaGVycyggZWxlbWVudE1hdGNoZXJzLCBzZXRNYXRjaGVycyApDQoJCSk7DQoNCgkJLy8gU2F2ZSBzZWxlY3RvciBhbmQgdG9rZW5pemF0aW9uDQoJCWNhY2hlZC5zZWxlY3RvciA9IHNlbGVjdG9yOw0KCX0NCglyZXR1cm4gY2FjaGVkOw0KfTsNCg0KLyoqDQogKiBBIGxvdy1sZXZlbCBzZWxlY3Rpb24gZnVuY3Rpb24gdGhhdCB3b3JrcyB3aXRoIFNpenpsZSdzIGNvbXBpbGVkDQogKiAgc2VsZWN0b3IgZnVuY3Rpb25zDQogKiBAcGFyYW0ge1N0cmluZ3xGdW5jdGlvbn0gc2VsZWN0b3IgQSBzZWxlY3RvciBvciBhIHByZS1jb21waWxlZA0KICogIHNlbGVjdG9yIGZ1bmN0aW9uIGJ1aWx0IHdpdGggU2l6emxlLmNvbXBpbGUNCiAqIEBwYXJhbSB7RWxlbWVudH0gY29udGV4dA0KICogQHBhcmFtIHtBcnJheX0gW3Jlc3VsdHNdDQogKiBAcGFyYW0ge0FycmF5fSBbc2VlZF0gQSBzZXQgb2YgZWxlbWVudHMgdG8gbWF0Y2ggYWdhaW5zdA0KICovDQpzZWxlY3QgPSBTaXp6bGUuc2VsZWN0ID0gZnVuY3Rpb24oIHNlbGVjdG9yLCBjb250ZXh0LCByZXN1bHRzLCBzZWVkICkgew0KCXZhciBpLCB0b2tlbnMsIHRva2VuLCB0eXBlLCBmaW5kLA0KCQljb21waWxlZCA9IHR5cGVvZiBzZWxlY3RvciA9PT0gImZ1bmN0aW9uIiAmJiBzZWxlY3RvciwNCgkJbWF0Y2ggPSAhc2VlZCAmJiB0b2tlbml6ZSggKCBzZWxlY3RvciA9IGNvbXBpbGVkLnNlbGVjdG9yIHx8IHNlbGVjdG9yICkgKTsNCg0KCXJlc3VsdHMgPSByZXN1bHRzIHx8IFtdOw0KDQoJLy8gVHJ5IHRvIG1pbmltaXplIG9wZXJhdGlvbnMgaWYgdGhlcmUgaXMgb25seSBvbmUgc2VsZWN0b3IgaW4gdGhlIGxpc3QgYW5kIG5vIHNlZWQNCgkvLyAodGhlIGxhdHRlciBvZiB3aGljaCBndWFyYW50ZWVzIHVzIGNvbnRleHQpDQoJaWYgKCBtYXRjaC5sZW5ndGggPT09IDEgKSB7DQoNCgkJLy8gUmVkdWNlIGNvbnRleHQgaWYgdGhlIGxlYWRpbmcgY29tcG91bmQgc2VsZWN0b3IgaXMgYW4gSUQNCgkJdG9rZW5zID0gbWF0Y2hbIDAgXSA9IG1hdGNoWyAwIF0uc2xpY2UoIDAgKTsNCgkJaWYgKCB0b2tlbnMubGVuZ3RoID4gMiAmJiAoIHRva2VuID0gdG9rZW5zWyAwIF0gKS50eXBlID09PSAiSUQiICYmDQoJCQljb250ZXh0Lm5vZGVUeXBlID09PSA5ICYmIGRvY3VtZW50SXNIVE1MICYmIEV4cHIucmVsYXRpdmVbIHRva2Vuc1sgMSBdLnR5cGUgXSApIHsNCg0KCQkJY29udGV4dCA9ICggRXhwci5maW5kWyAiSUQiIF0oIHRva2VuLm1hdGNoZXNbIDAgXQ0KCQkJCS5yZXBsYWNlKCBydW5lc2NhcGUsIGZ1bmVzY2FwZSApLCBjb250ZXh0ICkgfHwgW10gKVsgMCBdOw0KCQkJaWYgKCAhY29udGV4dCApIHsNCgkJCQlyZXR1cm4gcmVzdWx0czsNCg0KCQkJLy8gUHJlY29tcGlsZWQgbWF0Y2hlcnMgd2lsbCBzdGlsbCB2ZXJpZnkgYW5jZXN0cnksIHNvIHN0ZXAgdXAgYSBsZXZlbA0KCQkJfSBlbHNlIGlmICggY29tcGlsZWQgKSB7DQoJCQkJY29udGV4dCA9IGNvbnRleHQucGFyZW50Tm9kZTsNCgkJCX0NCg0KCQkJc2VsZWN0b3IgPSBzZWxlY3Rvci5zbGljZSggdG9rZW5zLnNoaWZ0KCkudmFsdWUubGVuZ3RoICk7DQoJCX0NCg0KCQkvLyBGZXRjaCBhIHNlZWQgc2V0IGZvciByaWdodC10by1sZWZ0IG1hdGNoaW5nDQoJCWkgPSBtYXRjaEV4cHJbICJuZWVkc0NvbnRleHQiIF0udGVzdCggc2VsZWN0b3IgKSA/IDAgOiB0b2tlbnMubGVuZ3RoOw0KCQl3aGlsZSAoIGktLSApIHsNCgkJCXRva2VuID0gdG9rZW5zWyBpIF07DQoNCgkJCS8vIEFib3J0IGlmIHdlIGhpdCBhIGNvbWJpbmF0b3INCgkJCWlmICggRXhwci5yZWxhdGl2ZVsgKCB0eXBlID0gdG9rZW4udHlwZSApIF0gKSB7DQoJCQkJYnJlYWs7DQoJCQl9DQoJCQlpZiAoICggZmluZCA9IEV4cHIuZmluZFsgdHlwZSBdICkgKSB7DQoNCgkJCQkvLyBTZWFyY2gsIGV4cGFuZGluZyBjb250ZXh0IGZvciBsZWFkaW5nIHNpYmxpbmcgY29tYmluYXRvcnMNCgkJCQlpZiAoICggc2VlZCA9IGZpbmQoDQoJCQkJCXRva2VuLm1hdGNoZXNbIDAgXS5yZXBsYWNlKCBydW5lc2NhcGUsIGZ1bmVzY2FwZSApLA0KCQkJCQlyc2libGluZy50ZXN0KCB0b2tlbnNbIDAgXS50eXBlICkgJiYgdGVzdENvbnRleHQoIGNvbnRleHQucGFyZW50Tm9kZSApIHx8DQoJCQkJCQljb250ZXh0DQoJCQkJKSApICkgew0KDQoJCQkJCS8vIElmIHNlZWQgaXMgZW1wdHkgb3Igbm8gdG9rZW5zIHJlbWFpbiwgd2UgY2FuIHJldHVybiBlYXJseQ0KCQkJCQl0b2tlbnMuc3BsaWNlKCBpLCAxICk7DQoJCQkJCXNlbGVjdG9yID0gc2VlZC5sZW5ndGggJiYgdG9TZWxlY3RvciggdG9rZW5zICk7DQoJCQkJCWlmICggIXNlbGVjdG9yICkgew0KCQkJCQkJcHVzaC5hcHBseSggcmVzdWx0cywgc2VlZCApOw0KCQkJCQkJcmV0dXJuIHJlc3VsdHM7DQoJCQkJCX0NCg0KCQkJCQlicmVhazsNCgkJCQl9DQoJCQl9DQoJCX0NCgl9DQoNCgkvLyBDb21waWxlIGFuZCBleGVjdXRlIGEgZmlsdGVyaW5nIGZ1bmN0aW9uIGlmIG9uZSBpcyBub3QgcHJvdmlkZWQNCgkvLyBQcm92aWRlIGBtYXRjaGAgdG8gYXZvaWQgcmV0b2tlbml6YXRpb24gaWYgd2UgbW9kaWZpZWQgdGhlIHNlbGVjdG9yIGFib3ZlDQoJKCBjb21waWxlZCB8fCBjb21waWxlKCBzZWxlY3RvciwgbWF0Y2ggKSApKA0KCQlzZWVkLA0KCQljb250ZXh0LA0KCQkhZG9jdW1lbnRJc0hUTUwsDQoJCXJlc3VsdHMsDQoJCSFjb250ZXh0IHx8IHJzaWJsaW5nLnRlc3QoIHNlbGVjdG9yICkgJiYgdGVzdENvbnRleHQoIGNvbnRleHQucGFyZW50Tm9kZSApIHx8IGNvbnRleHQNCgkpOw0KCXJldHVybiByZXN1bHRzOw0KfTsNCg0KLy8gT25lLXRpbWUgYXNzaWdubWVudHMNCg0KLy8gU29ydCBzdGFiaWxpdHkNCnN1cHBvcnQuc29ydFN0YWJsZSA9IGV4cGFuZG8uc3BsaXQoICIiICkuc29ydCggc29ydE9yZGVyICkuam9pbiggIiIgKSA9PT0gZXhwYW5kbzsNCg0KLy8gU3VwcG9ydDogQ2hyb21lIDE0LTM1Kw0KLy8gQWx3YXlzIGFzc3VtZSBkdXBsaWNhdGVzIGlmIHRoZXkgYXJlbid0IHBhc3NlZCB0byB0aGUgY29tcGFyaXNvbiBmdW5jdGlvbg0Kc3VwcG9ydC5kZXRlY3REdXBsaWNhdGVzID0gISFoYXNEdXBsaWNhdGU7DQoNCi8vIEluaXRpYWxpemUgYWdhaW5zdCB0aGUgZGVmYXVsdCBkb2N1bWVudA0Kc2V0RG9jdW1lbnQoKTsNCg0KLy8gU3VwcG9ydDogV2Via2l0PDUzNy4zMiAtIFNhZmFyaSA2LjAuMy9DaHJvbWUgMjUgKGZpeGVkIGluIENocm9tZSAyNykNCi8vIERldGFjaGVkIG5vZGVzIGNvbmZvdW5kaW5nbHkgZm9sbG93ICplYWNoIG90aGVyKg0Kc3VwcG9ydC5zb3J0RGV0YWNoZWQgPSBhc3NlcnQoIGZ1bmN0aW9uKCBlbCApIHsNCg0KCS8vIFNob3VsZCByZXR1cm4gMSwgYnV0IHJldHVybnMgNCAoZm9sbG93aW5nKQ0KCXJldHVybiBlbC5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiggZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImZpZWxkc2V0IiApICkgJiAxOw0KfSApOw0KDQovLyBTdXBwb3J0OiBJRTw4DQovLyBQcmV2ZW50IGF0dHJpYnV0ZS9wcm9wZXJ0eSAiaW50ZXJwb2xhdGlvbiINCi8vIGh0dHBzOi8vbXNkbi5taWNyb3NvZnQuY29tL2VuLXVzL2xpYnJhcnkvbXM1MzY0MjklMjhWUy44NSUyOS5hc3B4DQppZiAoICFhc3NlcnQoIGZ1bmN0aW9uKCBlbCApIHsNCgllbC5pbm5lckhUTUwgPSAiPGEgaHJlZj0nIyc+PC9hPiI7DQoJcmV0dXJuIGVsLmZpcnN0Q2hpbGQuZ2V0QXR0cmlidXRlKCAiaHJlZiIgKSA9PT0gIiMiOw0KfSApICkgew0KCWFkZEhhbmRsZSggInR5cGV8aHJlZnxoZWlnaHR8d2lkdGgiLCBmdW5jdGlvbiggZWxlbSwgbmFtZSwgaXNYTUwgKSB7DQoJCWlmICggIWlzWE1MICkgew0KCQkJcmV0dXJuIGVsZW0uZ2V0QXR0cmlidXRlKCBuYW1lLCBuYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJ0eXBlIiA/IDEgOiAyICk7DQoJCX0NCgl9ICk7DQp9DQoNCi8vIFN1cHBvcnQ6IElFPDkNCi8vIFVzZSBkZWZhdWx0VmFsdWUgaW4gcGxhY2Ugb2YgZ2V0QXR0cmlidXRlKCJ2YWx1ZSIpDQppZiAoICFzdXBwb3J0LmF0dHJpYnV0ZXMgfHwgIWFzc2VydCggZnVuY3Rpb24oIGVsICkgew0KCWVsLmlubmVySFRNTCA9ICI8aW5wdXQvPiI7DQoJZWwuZmlyc3RDaGlsZC5zZXRBdHRyaWJ1dGUoICJ2YWx1ZSIsICIiICk7DQoJcmV0dXJuIGVsLmZpcnN0Q2hpbGQuZ2V0QXR0cmlidXRlKCAidmFsdWUiICkgPT09ICIiOw0KfSApICkgew0KCWFkZEhhbmRsZSggInZhbHVlIiwgZnVuY3Rpb24oIGVsZW0sIF9uYW1lLCBpc1hNTCApIHsNCgkJaWYgKCAhaXNYTUwgJiYgZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSAiaW5wdXQiICkgew0KCQkJcmV0dXJuIGVsZW0uZGVmYXVsdFZhbHVlOw0KCQl9DQoJfSApOw0KfQ0KDQovLyBTdXBwb3J0OiBJRTw5DQovLyBVc2UgZ2V0QXR0cmlidXRlTm9kZSB0byBmZXRjaCBib29sZWFucyB3aGVuIGdldEF0dHJpYnV0ZSBsaWVzDQppZiAoICFhc3NlcnQoIGZ1bmN0aW9uKCBlbCApIHsNCglyZXR1cm4gZWwuZ2V0QXR0cmlidXRlKCAiZGlzYWJsZWQiICkgPT0gbnVsbDsNCn0gKSApIHsNCglhZGRIYW5kbGUoIGJvb2xlYW5zLCBmdW5jdGlvbiggZWxlbSwgbmFtZSwgaXNYTUwgKSB7DQoJCXZhciB2YWw7DQoJCWlmICggIWlzWE1MICkgew0KCQkJcmV0dXJuIGVsZW1bIG5hbWUgXSA9PT0gdHJ1ZSA/IG5hbWUudG9Mb3dlckNhc2UoKSA6DQoJCQkJKCB2YWwgPSBlbGVtLmdldEF0dHJpYnV0ZU5vZGUoIG5hbWUgKSApICYmIHZhbC5zcGVjaWZpZWQgPw0KCQkJCQl2YWwudmFsdWUgOg0KCQkJCQludWxsOw0KCQl9DQoJfSApOw0KfQ0KDQpyZXR1cm4gU2l6emxlOw0KDQp9ICkoIHdpbmRvdyApOw0KDQoNCg0KalF1ZXJ5LmZpbmQgPSBTaXp6bGU7DQpqUXVlcnkuZXhwciA9IFNpenpsZS5zZWxlY3RvcnM7DQoNCi8vIERlcHJlY2F0ZWQNCmpRdWVyeS5leHByWyAiOiIgXSA9IGpRdWVyeS5leHByLnBzZXVkb3M7DQpqUXVlcnkudW5pcXVlU29ydCA9IGpRdWVyeS51bmlxdWUgPSBTaXp6bGUudW5pcXVlU29ydDsNCmpRdWVyeS50ZXh0ID0gU2l6emxlLmdldFRleHQ7DQpqUXVlcnkuaXNYTUxEb2MgPSBTaXp6bGUuaXNYTUw7DQpqUXVlcnkuY29udGFpbnMgPSBTaXp6bGUuY29udGFpbnM7DQpqUXVlcnkuZXNjYXBlU2VsZWN0b3IgPSBTaXp6bGUuZXNjYXBlOw0KDQoNCg0KDQp2YXIgZGlyID0gZnVuY3Rpb24oIGVsZW0sIGRpciwgdW50aWwgKSB7DQoJdmFyIG1hdGNoZWQgPSBbXSwNCgkJdHJ1bmNhdGUgPSB1bnRpbCAhPT0gdW5kZWZpbmVkOw0KDQoJd2hpbGUgKCAoIGVsZW0gPSBlbGVtWyBkaXIgXSApICYmIGVsZW0ubm9kZVR5cGUgIT09IDkgKSB7DQoJCWlmICggZWxlbS5ub2RlVHlwZSA9PT0gMSApIHsNCgkJCWlmICggdHJ1bmNhdGUgJiYgalF1ZXJ5KCBlbGVtICkuaXMoIHVudGlsICkgKSB7DQoJCQkJYnJlYWs7DQoJCQl9DQoJCQltYXRjaGVkLnB1c2goIGVsZW0gKTsNCgkJfQ0KCX0NCglyZXR1cm4gbWF0Y2hlZDsNCn07DQoNCg0KdmFyIHNpYmxpbmdzID0gZnVuY3Rpb24oIG4sIGVsZW0gKSB7DQoJdmFyIG1hdGNoZWQgPSBbXTsNCg0KCWZvciAoIDsgbjsgbiA9IG4ubmV4dFNpYmxpbmcgKSB7DQoJCWlmICggbi5ub2RlVHlwZSA9PT0gMSAmJiBuICE9PSBlbGVtICkgew0KCQkJbWF0Y2hlZC5wdXNoKCBuICk7DQoJCX0NCgl9DQoNCglyZXR1cm4gbWF0Y2hlZDsNCn07DQoNCg0KdmFyIHJuZWVkc0NvbnRleHQgPSBqUXVlcnkuZXhwci5tYXRjaC5uZWVkc0NvbnRleHQ7DQoNCg0KDQpmdW5jdGlvbiBub2RlTmFtZSggZWxlbSwgbmFtZSApIHsNCg0KCXJldHVybiBlbGVtLm5vZGVOYW1lICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gbmFtZS50b0xvd2VyQ2FzZSgpOw0KDQp9DQp2YXIgcnNpbmdsZVRhZyA9ICggL148KFthLXpdW15cL1wwPjpceDIwXHRcclxuXGZdKilbXHgyMFx0XHJcblxmXSpcLz8+KD86PFwvXDE+fCkkL2kgKTsNCg0KDQoNCi8vIEltcGxlbWVudCB0aGUgaWRlbnRpY2FsIGZ1bmN0aW9uYWxpdHkgZm9yIGZpbHRlciBhbmQgbm90DQpmdW5jdGlvbiB3aW5ub3coIGVsZW1lbnRzLCBxdWFsaWZpZXIsIG5vdCApIHsNCglpZiAoIGlzRnVuY3Rpb24oIHF1YWxpZmllciApICkgew0KCQlyZXR1cm4galF1ZXJ5LmdyZXAoIGVsZW1lbnRzLCBmdW5jdGlvbiggZWxlbSwgaSApIHsNCgkJCXJldHVybiAhIXF1YWxpZmllci5jYWxsKCBlbGVtLCBpLCBlbGVtICkgIT09IG5vdDsNCgkJfSApOw0KCX0NCg0KCS8vIFNpbmdsZSBlbGVtZW50DQoJaWYgKCBxdWFsaWZpZXIubm9kZVR5cGUgKSB7DQoJCXJldHVybiBqUXVlcnkuZ3JlcCggZWxlbWVudHMsIGZ1bmN0aW9uKCBlbGVtICkgew0KCQkJcmV0dXJuICggZWxlbSA9PT0gcXVhbGlmaWVyICkgIT09IG5vdDsNCgkJfSApOw0KCX0NCg0KCS8vIEFycmF5bGlrZSBvZiBlbGVtZW50cyAoalF1ZXJ5LCBhcmd1bWVudHMsIEFycmF5KQ0KCWlmICggdHlwZW9mIHF1YWxpZmllciAhPT0gInN0cmluZyIgKSB7DQoJCXJldHVybiBqUXVlcnkuZ3JlcCggZWxlbWVudHMsIGZ1bmN0aW9uKCBlbGVtICkgew0KCQkJcmV0dXJuICggaW5kZXhPZi5jYWxsKCBxdWFsaWZpZXIsIGVsZW0gKSA+IC0xICkgIT09IG5vdDsNCgkJfSApOw0KCX0NCg0KCS8vIEZpbHRlcmVkIGRpcmVjdGx5IGZvciBib3RoIHNpbXBsZSBhbmQgY29tcGxleCBzZWxlY3RvcnMNCglyZXR1cm4galF1ZXJ5LmZpbHRlciggcXVhbGlmaWVyLCBlbGVtZW50cywgbm90ICk7DQp9DQoNCmpRdWVyeS5maWx0ZXIgPSBmdW5jdGlvbiggZXhwciwgZWxlbXMsIG5vdCApIHsNCgl2YXIgZWxlbSA9IGVsZW1zWyAwIF07DQoNCglpZiAoIG5vdCApIHsNCgkJZXhwciA9ICI6bm90KCIgKyBleHByICsgIikiOw0KCX0NCg0KCWlmICggZWxlbXMubGVuZ3RoID09PSAxICYmIGVsZW0ubm9kZVR5cGUgPT09IDEgKSB7DQoJCXJldHVybiBqUXVlcnkuZmluZC5tYXRjaGVzU2VsZWN0b3IoIGVsZW0sIGV4cHIgKSA/IFsgZWxlbSBdIDogW107DQoJfQ0KDQoJcmV0dXJuIGpRdWVyeS5maW5kLm1hdGNoZXMoIGV4cHIsIGpRdWVyeS5ncmVwKCBlbGVtcywgZnVuY3Rpb24oIGVsZW0gKSB7DQoJCXJldHVybiBlbGVtLm5vZGVUeXBlID09PSAxOw0KCX0gKSApOw0KfTsNCg0KalF1ZXJ5LmZuLmV4dGVuZCggew0KCWZpbmQ6IGZ1bmN0aW9uKCBzZWxlY3RvciApIHsNCgkJdmFyIGksIHJldCwNCgkJCWxlbiA9IHRoaXMubGVuZ3RoLA0KCQkJc2VsZiA9IHRoaXM7DQoNCgkJaWYgKCB0eXBlb2Ygc2VsZWN0b3IgIT09ICJzdHJpbmciICkgew0KCQkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCBqUXVlcnkoIHNlbGVjdG9yICkuZmlsdGVyKCBmdW5jdGlvbigpIHsNCgkJCQlmb3IgKCBpID0gMDsgaSA8IGxlbjsgaSsrICkgew0KCQkJCQlpZiAoIGpRdWVyeS5jb250YWlucyggc2VsZlsgaSBdLCB0aGlzICkgKSB7DQoJCQkJCQlyZXR1cm4gdHJ1ZTsNCgkJCQkJfQ0KCQkJCX0NCgkJCX0gKSApOw0KCQl9DQoNCgkJcmV0ID0gdGhpcy5wdXNoU3RhY2soIFtdICk7DQoNCgkJZm9yICggaSA9IDA7IGkgPCBsZW47IGkrKyApIHsNCgkJCWpRdWVyeS5maW5kKCBzZWxlY3Rvciwgc2VsZlsgaSBdLCByZXQgKTsNCgkJfQ0KDQoJCXJldHVybiBsZW4gPiAxID8galF1ZXJ5LnVuaXF1ZVNvcnQoIHJldCApIDogcmV0Ow0KCX0sDQoJZmlsdGVyOiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7DQoJCXJldHVybiB0aGlzLnB1c2hTdGFjayggd2lubm93KCB0aGlzLCBzZWxlY3RvciB8fCBbXSwgZmFsc2UgKSApOw0KCX0sDQoJbm90OiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7DQoJCXJldHVybiB0aGlzLnB1c2hTdGFjayggd2lubm93KCB0aGlzLCBzZWxlY3RvciB8fCBbXSwgdHJ1ZSApICk7DQoJfSwNCglpczogZnVuY3Rpb24oIHNlbGVjdG9yICkgew0KCQlyZXR1cm4gISF3aW5ub3coDQoJCQl0aGlzLA0KDQoJCQkvLyBJZiB0aGlzIGlzIGEgcG9zaXRpb25hbC9yZWxhdGl2ZSBzZWxlY3RvciwgY2hlY2sgbWVtYmVyc2hpcCBpbiB0aGUgcmV0dXJuZWQgc2V0DQoJCQkvLyBzbyAkKCJwOmZpcnN0IikuaXMoInA6bGFzdCIpIHdvbid0IHJldHVybiB0cnVlIGZvciBhIGRvYyB3aXRoIHR3byAicCIuDQoJCQl0eXBlb2Ygc2VsZWN0b3IgPT09ICJzdHJpbmciICYmIHJuZWVkc0NvbnRleHQudGVzdCggc2VsZWN0b3IgKSA/DQoJCQkJalF1ZXJ5KCBzZWxlY3RvciApIDoNCgkJCQlzZWxlY3RvciB8fCBbXSwNCgkJCWZhbHNlDQoJCSkubGVuZ3RoOw0KCX0NCn0gKTsNCg0KDQovLyBJbml0aWFsaXplIGEgalF1ZXJ5IG9iamVjdA0KDQoNCi8vIEEgY2VudHJhbCByZWZlcmVuY2UgdG8gdGhlIHJvb3QgalF1ZXJ5KGRvY3VtZW50KQ0KdmFyIHJvb3RqUXVlcnksDQoNCgkvLyBBIHNpbXBsZSB3YXkgdG8gY2hlY2sgZm9yIEhUTUwgc3RyaW5ncw0KCS8vIFByaW9yaXRpemUgI2lkIG92ZXIgPHRhZz4gdG8gYXZvaWQgWFNTIHZpYSBsb2NhdGlvbi5oYXNoICgjOTUyMSkNCgkvLyBTdHJpY3QgSFRNTCByZWNvZ25pdGlvbiAoIzExMjkwOiBtdXN0IHN0YXJ0IHdpdGggPCkNCgkvLyBTaG9ydGN1dCBzaW1wbGUgI2lkIGNhc2UgZm9yIHNwZWVkDQoJcnF1aWNrRXhwciA9IC9eKD86XHMqKDxbXHdcV10rPilbXj5dKnwjKFtcdy1dKykpJC8sDQoNCglpbml0ID0galF1ZXJ5LmZuLmluaXQgPSBmdW5jdGlvbiggc2VsZWN0b3IsIGNvbnRleHQsIHJvb3QgKSB7DQoJCXZhciBtYXRjaCwgZWxlbTsNCg0KCQkvLyBIQU5ETEU6ICQoIiIpLCAkKG51bGwpLCAkKHVuZGVmaW5lZCksICQoZmFsc2UpDQoJCWlmICggIXNlbGVjdG9yICkgew0KCQkJcmV0dXJuIHRoaXM7DQoJCX0NCg0KCQkvLyBNZXRob2QgaW5pdCgpIGFjY2VwdHMgYW4gYWx0ZXJuYXRlIHJvb3RqUXVlcnkNCgkJLy8gc28gbWlncmF0ZSBjYW4gc3VwcG9ydCBqUXVlcnkuc3ViIChnaC0yMTAxKQ0KCQlyb290ID0gcm9vdCB8fCByb290alF1ZXJ5Ow0KDQoJCS8vIEhhbmRsZSBIVE1MIHN0cmluZ3MNCgkJaWYgKCB0eXBlb2Ygc2VsZWN0b3IgPT09ICJzdHJpbmciICkgew0KCQkJaWYgKCBzZWxlY3RvclsgMCBdID09PSAiPCIgJiYNCgkJCQlzZWxlY3Rvclsgc2VsZWN0b3IubGVuZ3RoIC0gMSBdID09PSAiPiIgJiYNCgkJCQlzZWxlY3Rvci5sZW5ndGggPj0gMyApIHsNCg0KCQkJCS8vIEFzc3VtZSB0aGF0IHN0cmluZ3MgdGhhdCBzdGFydCBhbmQgZW5kIHdpdGggPD4gYXJlIEhUTUwgYW5kIHNraXAgdGhlIHJlZ2V4IGNoZWNrDQoJCQkJbWF0Y2ggPSBbIG51bGwsIHNlbGVjdG9yLCBudWxsIF07DQoNCgkJCX0gZWxzZSB7DQoJCQkJbWF0Y2ggPSBycXVpY2tFeHByLmV4ZWMoIHNlbGVjdG9yICk7DQoJCQl9DQoNCgkJCS8vIE1hdGNoIGh0bWwgb3IgbWFrZSBzdXJlIG5vIGNvbnRleHQgaXMgc3BlY2lmaWVkIGZvciAjaWQNCgkJCWlmICggbWF0Y2ggJiYgKCBtYXRjaFsgMSBdIHx8ICFjb250ZXh0ICkgKSB7DQoNCgkJCQkvLyBIQU5ETEU6ICQoaHRtbCkgLT4gJChhcnJheSkNCgkJCQlpZiAoIG1hdGNoWyAxIF0gKSB7DQoJCQkJCWNvbnRleHQgPSBjb250ZXh0IGluc3RhbmNlb2YgalF1ZXJ5ID8gY29udGV4dFsgMCBdIDogY29udGV4dDsNCg0KCQkJCQkvLyBPcHRpb24gdG8gcnVuIHNjcmlwdHMgaXMgdHJ1ZSBmb3IgYmFjay1jb21wYXQNCgkJCQkJLy8gSW50ZW50aW9uYWxseSBsZXQgdGhlIGVycm9yIGJlIHRocm93biBpZiBwYXJzZUhUTUwgaXMgbm90IHByZXNlbnQNCgkJCQkJalF1ZXJ5Lm1lcmdlKCB0aGlzLCBqUXVlcnkucGFyc2VIVE1MKA0KCQkJCQkJbWF0Y2hbIDEgXSwNCgkJCQkJCWNvbnRleHQgJiYgY29udGV4dC5ub2RlVHlwZSA/IGNvbnRleHQub3duZXJEb2N1bWVudCB8fCBjb250ZXh0IDogZG9jdW1lbnQsDQoJCQkJCQl0cnVlDQoJCQkJCSkgKTsNCg0KCQkJCQkvLyBIQU5ETEU6ICQoaHRtbCwgcHJvcHMpDQoJCQkJCWlmICggcnNpbmdsZVRhZy50ZXN0KCBtYXRjaFsgMSBdICkgJiYgalF1ZXJ5LmlzUGxhaW5PYmplY3QoIGNvbnRleHQgKSApIHsNCgkJCQkJCWZvciAoIG1hdGNoIGluIGNvbnRleHQgKSB7DQoNCgkJCQkJCQkvLyBQcm9wZXJ0aWVzIG9mIGNvbnRleHQgYXJlIGNhbGxlZCBhcyBtZXRob2RzIGlmIHBvc3NpYmxlDQoJCQkJCQkJaWYgKCBpc0Z1bmN0aW9uKCB0aGlzWyBtYXRjaCBdICkgKSB7DQoJCQkJCQkJCXRoaXNbIG1hdGNoIF0oIGNvbnRleHRbIG1hdGNoIF0gKTsNCg0KCQkJCQkJCS8vIC4uLmFuZCBvdGhlcndpc2Ugc2V0IGFzIGF0dHJpYnV0ZXMNCgkJCQkJCQl9IGVsc2Ugew0KCQkJCQkJCQl0aGlzLmF0dHIoIG1hdGNoLCBjb250ZXh0WyBtYXRjaCBdICk7DQoJCQkJCQkJfQ0KCQkJCQkJfQ0KCQkJCQl9DQoNCgkJCQkJcmV0dXJuIHRoaXM7DQoNCgkJCQkvLyBIQU5ETEU6ICQoI2lkKQ0KCQkJCX0gZWxzZSB7DQoJCQkJCWVsZW0gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCggbWF0Y2hbIDIgXSApOw0KDQoJCQkJCWlmICggZWxlbSApIHsNCg0KCQkJCQkJLy8gSW5qZWN0IHRoZSBlbGVtZW50IGRpcmVjdGx5IGludG8gdGhlIGpRdWVyeSBvYmplY3QNCgkJCQkJCXRoaXNbIDAgXSA9IGVsZW07DQoJCQkJCQl0aGlzLmxlbmd0aCA9IDE7DQoJCQkJCX0NCgkJCQkJcmV0dXJuIHRoaXM7DQoJCQkJfQ0KDQoJCQkvLyBIQU5ETEU6ICQoZXhwciwgJCguLi4pKQ0KCQkJfSBlbHNlIGlmICggIWNvbnRleHQgfHwgY29udGV4dC5qcXVlcnkgKSB7DQoJCQkJcmV0dXJuICggY29udGV4dCB8fCByb290ICkuZmluZCggc2VsZWN0b3IgKTsNCg0KCQkJLy8gSEFORExFOiAkKGV4cHIsIGNvbnRleHQpDQoJCQkvLyAod2hpY2ggaXMganVzdCBlcXVpdmFsZW50IHRvOiAkKGNvbnRleHQpLmZpbmQoZXhwcikNCgkJCX0gZWxzZSB7DQoJCQkJcmV0dXJuIHRoaXMuY29uc3RydWN0b3IoIGNvbnRleHQgKS5maW5kKCBzZWxlY3RvciApOw0KCQkJfQ0KDQoJCS8vIEhBTkRMRTogJChET01FbGVtZW50KQ0KCQl9IGVsc2UgaWYgKCBzZWxlY3Rvci5ub2RlVHlwZSApIHsNCgkJCXRoaXNbIDAgXSA9IHNlbGVjdG9yOw0KCQkJdGhpcy5sZW5ndGggPSAxOw0KCQkJcmV0dXJuIHRoaXM7DQoNCgkJLy8gSEFORExFOiAkKGZ1bmN0aW9uKQ0KCQkvLyBTaG9ydGN1dCBmb3IgZG9jdW1lbnQgcmVhZHkNCgkJfSBlbHNlIGlmICggaXNGdW5jdGlvbiggc2VsZWN0b3IgKSApIHsNCgkJCXJldHVybiByb290LnJlYWR5ICE9PSB1bmRlZmluZWQgPw0KCQkJCXJvb3QucmVhZHkoIHNlbGVjdG9yICkgOg0KDQoJCQkJLy8gRXhlY3V0ZSBpbW1lZGlhdGVseSBpZiByZWFkeSBpcyBub3QgcHJlc2VudA0KCQkJCXNlbGVjdG9yKCBqUXVlcnkgKTsNCgkJfQ0KDQoJCXJldHVybiBqUXVlcnkubWFrZUFycmF5KCBzZWxlY3RvciwgdGhpcyApOw0KCX07DQoNCi8vIEdpdmUgdGhlIGluaXQgZnVuY3Rpb24gdGhlIGpRdWVyeSBwcm90b3R5cGUgZm9yIGxhdGVyIGluc3RhbnRpYXRpb24NCmluaXQucHJvdG90eXBlID0galF1ZXJ5LmZuOw0KDQovLyBJbml0aWFsaXplIGNlbnRyYWwgcmVmZXJlbmNlDQpyb290alF1ZXJ5ID0galF1ZXJ5KCBkb2N1bWVudCApOw0KDQoNCnZhciBycGFyZW50c3ByZXYgPSAvXig/OnBhcmVudHN8cHJldig/OlVudGlsfEFsbCkpLywNCg0KCS8vIE1ldGhvZHMgZ3VhcmFudGVlZCB0byBwcm9kdWNlIGEgdW5pcXVlIHNldCB3aGVuIHN0YXJ0aW5nIGZyb20gYSB1bmlxdWUgc2V0DQoJZ3VhcmFudGVlZFVuaXF1ZSA9IHsNCgkJY2hpbGRyZW46IHRydWUsDQoJCWNvbnRlbnRzOiB0cnVlLA0KCQluZXh0OiB0cnVlLA0KCQlwcmV2OiB0cnVlDQoJfTsNCg0KalF1ZXJ5LmZuLmV4dGVuZCggew0KCWhhczogZnVuY3Rpb24oIHRhcmdldCApIHsNCgkJdmFyIHRhcmdldHMgPSBqUXVlcnkoIHRhcmdldCwgdGhpcyApLA0KCQkJbCA9IHRhcmdldHMubGVuZ3RoOw0KDQoJCXJldHVybiB0aGlzLmZpbHRlciggZnVuY3Rpb24oKSB7DQoJCQl2YXIgaSA9IDA7DQoJCQlmb3IgKCA7IGkgPCBsOyBpKysgKSB7DQoJCQkJaWYgKCBqUXVlcnkuY29udGFpbnMoIHRoaXMsIHRhcmdldHNbIGkgXSApICkgew0KCQkJCQlyZXR1cm4gdHJ1ZTsNCgkJCQl9DQoJCQl9DQoJCX0gKTsNCgl9LA0KDQoJY2xvc2VzdDogZnVuY3Rpb24oIHNlbGVjdG9ycywgY29udGV4dCApIHsNCgkJdmFyIGN1ciwNCgkJCWkgPSAwLA0KCQkJbCA9IHRoaXMubGVuZ3RoLA0KCQkJbWF0Y2hlZCA9IFtdLA0KCQkJdGFyZ2V0cyA9IHR5cGVvZiBzZWxlY3RvcnMgIT09ICJzdHJpbmciICYmIGpRdWVyeSggc2VsZWN0b3JzICk7DQoNCgkJLy8gUG9zaXRpb25hbCBzZWxlY3RvcnMgbmV2ZXIgbWF0Y2gsIHNpbmNlIHRoZXJlJ3Mgbm8gX3NlbGVjdGlvbl8gY29udGV4dA0KCQlpZiAoICFybmVlZHNDb250ZXh0LnRlc3QoIHNlbGVjdG9ycyApICkgew0KCQkJZm9yICggOyBpIDwgbDsgaSsrICkgew0KCQkJCWZvciAoIGN1ciA9IHRoaXNbIGkgXTsgY3VyICYmIGN1ciAhPT0gY29udGV4dDsgY3VyID0gY3VyLnBhcmVudE5vZGUgKSB7DQoNCgkJCQkJLy8gQWx3YXlzIHNraXAgZG9jdW1lbnQgZnJhZ21lbnRzDQoJCQkJCWlmICggY3VyLm5vZGVUeXBlIDwgMTEgJiYgKCB0YXJnZXRzID8NCgkJCQkJCXRhcmdldHMuaW5kZXgoIGN1ciApID4gLTEgOg0KDQoJCQkJCQkvLyBEb24ndCBwYXNzIG5vbi1lbGVtZW50cyB0byBTaXp6bGUNCgkJCQkJCWN1ci5ub2RlVHlwZSA9PT0gMSAmJg0KCQkJCQkJCWpRdWVyeS5maW5kLm1hdGNoZXNTZWxlY3RvciggY3VyLCBzZWxlY3RvcnMgKSApICkgew0KDQoJCQkJCQltYXRjaGVkLnB1c2goIGN1ciApOw0KCQkJCQkJYnJlYWs7DQoJCQkJCX0NCgkJCQl9DQoJCQl9DQoJCX0NCg0KCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIG1hdGNoZWQubGVuZ3RoID4gMSA/IGpRdWVyeS51bmlxdWVTb3J0KCBtYXRjaGVkICkgOiBtYXRjaGVkICk7DQoJfSwNCg0KCS8vIERldGVybWluZSB0aGUgcG9zaXRpb24gb2YgYW4gZWxlbWVudCB3aXRoaW4gdGhlIHNldA0KCWluZGV4OiBmdW5jdGlvbiggZWxlbSApIHsNCg0KCQkvLyBObyBhcmd1bWVudCwgcmV0dXJuIGluZGV4IGluIHBhcmVudA0KCQlpZiAoICFlbGVtICkgew0KCQkJcmV0dXJuICggdGhpc1sgMCBdICYmIHRoaXNbIDAgXS5wYXJlbnROb2RlICkgPyB0aGlzLmZpcnN0KCkucHJldkFsbCgpLmxlbmd0aCA6IC0xOw0KCQl9DQoNCgkJLy8gSW5kZXggaW4gc2VsZWN0b3INCgkJaWYgKCB0eXBlb2YgZWxlbSA9PT0gInN0cmluZyIgKSB7DQoJCQlyZXR1cm4gaW5kZXhPZi5jYWxsKCBqUXVlcnkoIGVsZW0gKSwgdGhpc1sgMCBdICk7DQoJCX0NCg0KCQkvLyBMb2NhdGUgdGhlIHBvc2l0aW9uIG9mIHRoZSBkZXNpcmVkIGVsZW1lbnQNCgkJcmV0dXJuIGluZGV4T2YuY2FsbCggdGhpcywNCg0KCQkJLy8gSWYgaXQgcmVjZWl2ZXMgYSBqUXVlcnkgb2JqZWN0LCB0aGUgZmlyc3QgZWxlbWVudCBpcyB1c2VkDQoJCQllbGVtLmpxdWVyeSA/IGVsZW1bIDAgXSA6IGVsZW0NCgkJKTsNCgl9LA0KDQoJYWRkOiBmdW5jdGlvbiggc2VsZWN0b3IsIGNvbnRleHQgKSB7DQoJCXJldHVybiB0aGlzLnB1c2hTdGFjaygNCgkJCWpRdWVyeS51bmlxdWVTb3J0KA0KCQkJCWpRdWVyeS5tZXJnZSggdGhpcy5nZXQoKSwgalF1ZXJ5KCBzZWxlY3RvciwgY29udGV4dCApICkNCgkJCSkNCgkJKTsNCgl9LA0KDQoJYWRkQmFjazogZnVuY3Rpb24oIHNlbGVjdG9yICkgew0KCQlyZXR1cm4gdGhpcy5hZGQoIHNlbGVjdG9yID09IG51bGwgPw0KCQkJdGhpcy5wcmV2T2JqZWN0IDogdGhpcy5wcmV2T2JqZWN0LmZpbHRlciggc2VsZWN0b3IgKQ0KCQkpOw0KCX0NCn0gKTsNCg0KZnVuY3Rpb24gc2libGluZyggY3VyLCBkaXIgKSB7DQoJd2hpbGUgKCAoIGN1ciA9IGN1clsgZGlyIF0gKSAmJiBjdXIubm9kZVR5cGUgIT09IDEgKSB7fQ0KCXJldHVybiBjdXI7DQp9DQoNCmpRdWVyeS5lYWNoKCB7DQoJcGFyZW50OiBmdW5jdGlvbiggZWxlbSApIHsNCgkJdmFyIHBhcmVudCA9IGVsZW0ucGFyZW50Tm9kZTsNCgkJcmV0dXJuIHBhcmVudCAmJiBwYXJlbnQubm9kZVR5cGUgIT09IDExID8gcGFyZW50IDogbnVsbDsNCgl9LA0KCXBhcmVudHM6IGZ1bmN0aW9uKCBlbGVtICkgew0KCQlyZXR1cm4gZGlyKCBlbGVtLCAicGFyZW50Tm9kZSIgKTsNCgl9LA0KCXBhcmVudHNVbnRpbDogZnVuY3Rpb24oIGVsZW0sIF9pLCB1bnRpbCApIHsNCgkJcmV0dXJuIGRpciggZWxlbSwgInBhcmVudE5vZGUiLCB1bnRpbCApOw0KCX0sDQoJbmV4dDogZnVuY3Rpb24oIGVsZW0gKSB7DQoJCXJldHVybiBzaWJsaW5nKCBlbGVtLCAibmV4dFNpYmxpbmciICk7DQoJfSwNCglwcmV2OiBmdW5jdGlvbiggZWxlbSApIHsNCgkJcmV0dXJuIHNpYmxpbmcoIGVsZW0sICJwcmV2aW91c1NpYmxpbmciICk7DQoJfSwNCgluZXh0QWxsOiBmdW5jdGlvbiggZWxlbSApIHsNCgkJcmV0dXJuIGRpciggZWxlbSwgIm5leHRTaWJsaW5nIiApOw0KCX0sDQoJcHJldkFsbDogZnVuY3Rpb24oIGVsZW0gKSB7DQoJCXJldHVybiBkaXIoIGVsZW0sICJwcmV2aW91c1NpYmxpbmciICk7DQoJfSwNCgluZXh0VW50aWw6IGZ1bmN0aW9uKCBlbGVtLCBfaSwgdW50aWwgKSB7DQoJCXJldHVybiBkaXIoIGVsZW0sICJuZXh0U2libGluZyIsIHVudGlsICk7DQoJfSwNCglwcmV2VW50aWw6IGZ1bmN0aW9uKCBlbGVtLCBfaSwgdW50aWwgKSB7DQoJCXJldHVybiBkaXIoIGVsZW0sICJwcmV2aW91c1NpYmxpbmciLCB1bnRpbCApOw0KCX0sDQoJc2libGluZ3M6IGZ1bmN0aW9uKCBlbGVtICkgew0KCQlyZXR1cm4gc2libGluZ3MoICggZWxlbS5wYXJlbnROb2RlIHx8IHt9ICkuZmlyc3RDaGlsZCwgZWxlbSApOw0KCX0sDQoJY2hpbGRyZW46IGZ1bmN0aW9uKCBlbGVtICkgew0KCQlyZXR1cm4gc2libGluZ3MoIGVsZW0uZmlyc3RDaGlsZCApOw0KCX0sDQoJY29udGVudHM6IGZ1bmN0aW9uKCBlbGVtICkgew0KCQlpZiAoIGVsZW0uY29udGVudERvY3VtZW50ICE9IG51bGwgJiYNCg0KCQkJLy8gU3VwcG9ydDogSUUgMTErDQoJCQkvLyA8b2JqZWN0PiBlbGVtZW50cyB3aXRoIG5vIGBkYXRhYCBhdHRyaWJ1dGUgaGFzIGFuIG9iamVjdA0KCQkJLy8gYGNvbnRlbnREb2N1bWVudGAgd2l0aCBhIGBudWxsYCBwcm90b3R5cGUuDQoJCQlnZXRQcm90byggZWxlbS5jb250ZW50RG9jdW1lbnQgKSApIHsNCg0KCQkJcmV0dXJuIGVsZW0uY29udGVudERvY3VtZW50Ow0KCQl9DQoNCgkJLy8gU3VwcG9ydDogSUUgOSAtIDExIG9ubHksIGlPUyA3IG9ubHksIEFuZHJvaWQgQnJvd3NlciA8PTQuMyBvbmx5DQoJCS8vIFRyZWF0IHRoZSB0ZW1wbGF0ZSBlbGVtZW50IGFzIGEgcmVndWxhciBvbmUgaW4gYnJvd3NlcnMgdGhhdA0KCQkvLyBkb24ndCBzdXBwb3J0IGl0Lg0KCQlpZiAoIG5vZGVOYW1lKCBlbGVtLCAidGVtcGxhdGUiICkgKSB7DQoJCQllbGVtID0gZWxlbS5jb250ZW50IHx8IGVsZW07DQoJCX0NCg0KCQlyZXR1cm4galF1ZXJ5Lm1lcmdlKCBbXSwgZWxlbS5jaGlsZE5vZGVzICk7DQoJfQ0KfSwgZnVuY3Rpb24oIG5hbWUsIGZuICkgew0KCWpRdWVyeS5mblsgbmFtZSBdID0gZnVuY3Rpb24oIHVudGlsLCBzZWxlY3RvciApIHsNCgkJdmFyIG1hdGNoZWQgPSBqUXVlcnkubWFwKCB0aGlzLCBmbiwgdW50aWwgKTsNCg0KCQlpZiAoIG5hbWUuc2xpY2UoIC01ICkgIT09ICJVbnRpbCIgKSB7DQoJCQlzZWxlY3RvciA9IHVudGlsOw0KCQl9DQoNCgkJaWYgKCBzZWxlY3RvciAmJiB0eXBlb2Ygc2VsZWN0b3IgPT09ICJzdHJpbmciICkgew0KCQkJbWF0Y2hlZCA9IGpRdWVyeS5maWx0ZXIoIHNlbGVjdG9yLCBtYXRjaGVkICk7DQoJCX0NCg0KCQlpZiAoIHRoaXMubGVuZ3RoID4gMSApIHsNCg0KCQkJLy8gUmVtb3ZlIGR1cGxpY2F0ZXMNCgkJCWlmICggIWd1YXJhbnRlZWRVbmlxdWVbIG5hbWUgXSApIHsNCgkJCQlqUXVlcnkudW5pcXVlU29ydCggbWF0Y2hlZCApOw0KCQkJfQ0KDQoJCQkvLyBSZXZlcnNlIG9yZGVyIGZvciBwYXJlbnRzKiBhbmQgcHJldi1kZXJpdmF0aXZlcw0KCQkJaWYgKCBycGFyZW50c3ByZXYudGVzdCggbmFtZSApICkgew0KCQkJCW1hdGNoZWQucmV2ZXJzZSgpOw0KCQkJfQ0KCQl9DQoNCgkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCBtYXRjaGVkICk7DQoJfTsNCn0gKTsNCnZhciBybm90aHRtbHdoaXRlID0gKCAvW15ceDIwXHRcclxuXGZdKy9nICk7DQoNCg0KDQovLyBDb252ZXJ0IFN0cmluZy1mb3JtYXR0ZWQgb3B0aW9ucyBpbnRvIE9iamVjdC1mb3JtYXR0ZWQgb25lcw0KZnVuY3Rpb24gY3JlYXRlT3B0aW9ucyggb3B0aW9ucyApIHsNCgl2YXIgb2JqZWN0ID0ge307DQoJalF1ZXJ5LmVhY2goIG9wdGlvbnMubWF0Y2goIHJub3RodG1sd2hpdGUgKSB8fCBbXSwgZnVuY3Rpb24oIF8sIGZsYWcgKSB7DQoJCW9iamVjdFsgZmxhZyBdID0gdHJ1ZTsNCgl9ICk7DQoJcmV0dXJuIG9iamVjdDsNCn0NCg0KLyoNCiAqIENyZWF0ZSBhIGNhbGxiYWNrIGxpc3QgdXNpbmcgdGhlIGZvbGxvd2luZyBwYXJhbWV0ZXJzOg0KICoNCiAqCW9wdGlvbnM6IGFuIG9wdGlvbmFsIGxpc3Qgb2Ygc3BhY2Utc2VwYXJhdGVkIG9wdGlvbnMgdGhhdCB3aWxsIGNoYW5nZSBob3cNCiAqCQkJdGhlIGNhbGxiYWNrIGxpc3QgYmVoYXZlcyBvciBhIG1vcmUgdHJhZGl0aW9uYWwgb3B0aW9uIG9iamVjdA0KICoNCiAqIEJ5IGRlZmF1bHQgYSBjYWxsYmFjayBsaXN0IHdpbGwgYWN0IGxpa2UgYW4gZXZlbnQgY2FsbGJhY2sgbGlzdCBhbmQgY2FuIGJlDQogKiAiZmlyZWQiIG11bHRpcGxlIHRpbWVzLg0KICoNCiAqIFBvc3NpYmxlIG9wdGlvbnM6DQogKg0KICoJb25jZToJCQl3aWxsIGVuc3VyZSB0aGUgY2FsbGJhY2sgbGlzdCBjYW4gb25seSBiZSBmaXJlZCBvbmNlIChsaWtlIGEgRGVmZXJyZWQpDQogKg0KICoJbWVtb3J5OgkJCXdpbGwga2VlcCB0cmFjayBvZiBwcmV2aW91cyB2YWx1ZXMgYW5kIHdpbGwgY2FsbCBhbnkgY2FsbGJhY2sgYWRkZWQNCiAqCQkJCQlhZnRlciB0aGUgbGlzdCBoYXMgYmVlbiBmaXJlZCByaWdodCBhd2F5IHdpdGggdGhlIGxhdGVzdCAibWVtb3JpemVkIg0KICoJCQkJCXZhbHVlcyAobGlrZSBhIERlZmVycmVkKQ0KICoNCiAqCXVuaXF1ZToJCQl3aWxsIGVuc3VyZSBhIGNhbGxiYWNrIGNhbiBvbmx5IGJlIGFkZGVkIG9uY2UgKG5vIGR1cGxpY2F0ZSBpbiB0aGUgbGlzdCkNCiAqDQogKglzdG9wT25GYWxzZToJaW50ZXJydXB0IGNhbGxpbmdzIHdoZW4gYSBjYWxsYmFjayByZXR1cm5zIGZhbHNlDQogKg0KICovDQpqUXVlcnkuQ2FsbGJhY2tzID0gZnVuY3Rpb24oIG9wdGlvbnMgKSB7DQoNCgkvLyBDb252ZXJ0IG9wdGlvbnMgZnJvbSBTdHJpbmctZm9ybWF0dGVkIHRvIE9iamVjdC1mb3JtYXR0ZWQgaWYgbmVlZGVkDQoJLy8gKHdlIGNoZWNrIGluIGNhY2hlIGZpcnN0KQ0KCW9wdGlvbnMgPSB0eXBlb2Ygb3B0aW9ucyA9PT0gInN0cmluZyIgPw0KCQljcmVhdGVPcHRpb25zKCBvcHRpb25zICkgOg0KCQlqUXVlcnkuZXh0ZW5kKCB7fSwgb3B0aW9ucyApOw0KDQoJdmFyIC8vIEZsYWcgdG8ga25vdyBpZiBsaXN0IGlzIGN1cnJlbnRseSBmaXJpbmcNCgkJZmlyaW5nLA0KDQoJCS8vIExhc3QgZmlyZSB2YWx1ZSBmb3Igbm9uLWZvcmdldHRhYmxlIGxpc3RzDQoJCW1lbW9yeSwNCg0KCQkvLyBGbGFnIHRvIGtub3cgaWYgbGlzdCB3YXMgYWxyZWFkeSBmaXJlZA0KCQlmaXJlZCwNCg0KCQkvLyBGbGFnIHRvIHByZXZlbnQgZmlyaW5nDQoJCWxvY2tlZCwNCg0KCQkvLyBBY3R1YWwgY2FsbGJhY2sgbGlzdA0KCQlsaXN0ID0gW10sDQoNCgkJLy8gUXVldWUgb2YgZXhlY3V0aW9uIGRhdGEgZm9yIHJlcGVhdGFibGUgbGlzdHMNCgkJcXVldWUgPSBbXSwNCg0KCQkvLyBJbmRleCBvZiBjdXJyZW50bHkgZmlyaW5nIGNhbGxiYWNrIChtb2RpZmllZCBieSBhZGQvcmVtb3ZlIGFzIG5lZWRlZCkNCgkJZmlyaW5nSW5kZXggPSAtMSwNCg0KCQkvLyBGaXJlIGNhbGxiYWNrcw0KCQlmaXJlID0gZnVuY3Rpb24oKSB7DQoNCgkJCS8vIEVuZm9yY2Ugc2luZ2xlLWZpcmluZw0KCQkJbG9ja2VkID0gbG9ja2VkIHx8IG9wdGlvbnMub25jZTsNCg0KCQkJLy8gRXhlY3V0ZSBjYWxsYmFja3MgZm9yIGFsbCBwZW5kaW5nIGV4ZWN1dGlvbnMsDQoJCQkvLyByZXNwZWN0aW5nIGZpcmluZ0luZGV4IG92ZXJyaWRlcyBhbmQgcnVudGltZSBjaGFuZ2VzDQoJCQlmaXJlZCA9IGZpcmluZyA9IHRydWU7DQoJCQlmb3IgKCA7IHF1ZXVlLmxlbmd0aDsgZmlyaW5nSW5kZXggPSAtMSApIHsNCgkJCQltZW1vcnkgPSBxdWV1ZS5zaGlmdCgpOw0KCQkJCXdoaWxlICggKytmaXJpbmdJbmRleCA8IGxpc3QubGVuZ3RoICkgew0KDQoJCQkJCS8vIFJ1biBjYWxsYmFjayBhbmQgY2hlY2sgZm9yIGVhcmx5IHRlcm1pbmF0aW9uDQoJCQkJCWlmICggbGlzdFsgZmlyaW5nSW5kZXggXS5hcHBseSggbWVtb3J5WyAwIF0sIG1lbW9yeVsgMSBdICkgPT09IGZhbHNlICYmDQoJCQkJCQlvcHRpb25zLnN0b3BPbkZhbHNlICkgew0KDQoJCQkJCQkvLyBKdW1wIHRvIGVuZCBhbmQgZm9yZ2V0IHRoZSBkYXRhIHNvIC5hZGQgZG9lc24ndCByZS1maXJlDQoJCQkJCQlmaXJpbmdJbmRleCA9IGxpc3QubGVuZ3RoOw0KCQkJCQkJbWVtb3J5ID0gZmFsc2U7DQoJCQkJCX0NCgkJCQl9DQoJCQl9DQoNCgkJCS8vIEZvcmdldCB0aGUgZGF0YSBpZiB3ZSdyZSBkb25lIHdpdGggaXQNCgkJCWlmICggIW9wdGlvbnMubWVtb3J5ICkgew0KCQkJCW1lbW9yeSA9IGZhbHNlOw0KCQkJfQ0KDQoJCQlmaXJpbmcgPSBmYWxzZTsNCg0KCQkJLy8gQ2xlYW4gdXAgaWYgd2UncmUgZG9uZSBmaXJpbmcgZm9yIGdvb2QNCgkJCWlmICggbG9ja2VkICkgew0KDQoJCQkJLy8gS2VlcCBhbiBlbXB0eSBsaXN0IGlmIHdlIGhhdmUgZGF0YSBmb3IgZnV0dXJlIGFkZCBjYWxscw0KCQkJCWlmICggbWVtb3J5ICkgew0KCQkJCQlsaXN0ID0gW107DQoNCgkJCQkvLyBPdGhlcndpc2UsIHRoaXMgb2JqZWN0IGlzIHNwZW50DQoJCQkJfSBlbHNlIHsNCgkJCQkJbGlzdCA9ICIiOw0KCQkJCX0NCgkJCX0NCgkJfSwNCg0KCQkvLyBBY3R1YWwgQ2FsbGJhY2tzIG9iamVjdA0KCQlzZWxmID0gew0KDQoJCQkvLyBBZGQgYSBjYWxsYmFjayBvciBhIGNvbGxlY3Rpb24gb2YgY2FsbGJhY2tzIHRvIHRoZSBsaXN0DQoJCQlhZGQ6IGZ1bmN0aW9uKCkgew0KCQkJCWlmICggbGlzdCApIHsNCg0KCQkJCQkvLyBJZiB3ZSBoYXZlIG1lbW9yeSBmcm9tIGEgcGFzdCBydW4sIHdlIHNob3VsZCBmaXJlIGFmdGVyIGFkZGluZw0KCQkJCQlpZiAoIG1lbW9yeSAmJiAhZmlyaW5nICkgew0KCQkJCQkJZmlyaW5nSW5kZXggPSBsaXN0Lmxlbmd0aCAtIDE7DQoJCQkJCQlxdWV1ZS5wdXNoKCBtZW1vcnkgKTsNCgkJCQkJfQ0KDQoJCQkJCSggZnVuY3Rpb24gYWRkKCBhcmdzICkgew0KCQkJCQkJalF1ZXJ5LmVhY2goIGFyZ3MsIGZ1bmN0aW9uKCBfLCBhcmcgKSB7DQoJCQkJCQkJaWYgKCBpc0Z1bmN0aW9uKCBhcmcgKSApIHsNCgkJCQkJCQkJaWYgKCAhb3B0aW9ucy51bmlxdWUgfHwgIXNlbGYuaGFzKCBhcmcgKSApIHsNCgkJCQkJCQkJCWxpc3QucHVzaCggYXJnICk7DQoJCQkJCQkJCX0NCgkJCQkJCQl9IGVsc2UgaWYgKCBhcmcgJiYgYXJnLmxlbmd0aCAmJiB0b1R5cGUoIGFyZyApICE9PSAic3RyaW5nIiApIHsNCg0KCQkJCQkJCQkvLyBJbnNwZWN0IHJlY3Vyc2l2ZWx5DQoJCQkJCQkJCWFkZCggYXJnICk7DQoJCQkJCQkJfQ0KCQkJCQkJfSApOw0KCQkJCQl9ICkoIGFyZ3VtZW50cyApOw0KDQoJCQkJCWlmICggbWVtb3J5ICYmICFmaXJpbmcgKSB7DQoJCQkJCQlmaXJlKCk7DQoJCQkJCX0NCgkJCQl9DQoJCQkJcmV0dXJuIHRoaXM7DQoJCQl9LA0KDQoJCQkvLyBSZW1vdmUgYSBjYWxsYmFjayBmcm9tIHRoZSBsaXN0DQoJCQlyZW1vdmU6IGZ1bmN0aW9uKCkgew0KCQkJCWpRdWVyeS5lYWNoKCBhcmd1bWVudHMsIGZ1bmN0aW9uKCBfLCBhcmcgKSB7DQoJCQkJCXZhciBpbmRleDsNCgkJCQkJd2hpbGUgKCAoIGluZGV4ID0galF1ZXJ5LmluQXJyYXkoIGFyZywgbGlzdCwgaW5kZXggKSApID4gLTEgKSB7DQoJCQkJCQlsaXN0LnNwbGljZSggaW5kZXgsIDEgKTsNCg0KCQkJCQkJLy8gSGFuZGxlIGZpcmluZyBpbmRleGVzDQoJCQkJCQlpZiAoIGluZGV4IDw9IGZpcmluZ0luZGV4ICkgew0KCQkJCQkJCWZpcmluZ0luZGV4LS07DQoJCQkJCQl9DQoJCQkJCX0NCgkJCQl9ICk7DQoJCQkJcmV0dXJuIHRoaXM7DQoJCQl9LA0KDQoJCQkvLyBDaGVjayBpZiBhIGdpdmVuIGNhbGxiYWNrIGlzIGluIHRoZSBsaXN0Lg0KCQkJLy8gSWYgbm8gYXJndW1lbnQgaXMgZ2l2ZW4sIHJldHVybiB3aGV0aGVyIG9yIG5vdCBsaXN0IGhhcyBjYWxsYmFja3MgYXR0YWNoZWQuDQoJCQloYXM6IGZ1bmN0aW9uKCBmbiApIHsNCgkJCQlyZXR1cm4gZm4gPw0KCQkJCQlqUXVlcnkuaW5BcnJheSggZm4sIGxpc3QgKSA+IC0xIDoNCgkJCQkJbGlzdC5sZW5ndGggPiAwOw0KCQkJfSwNCg0KCQkJLy8gUmVtb3ZlIGFsbCBjYWxsYmFja3MgZnJvbSB0aGUgbGlzdA0KCQkJZW1wdHk6IGZ1bmN0aW9uKCkgew0KCQkJCWlmICggbGlzdCApIHsNCgkJCQkJbGlzdCA9IFtdOw0KCQkJCX0NCgkJCQlyZXR1cm4gdGhpczsNCgkJCX0sDQoNCgkJCS8vIERpc2FibGUgLmZpcmUgYW5kIC5hZGQNCgkJCS8vIEFib3J0IGFueSBjdXJyZW50L3BlbmRpbmcgZXhlY3V0aW9ucw0KCQkJLy8gQ2xlYXIgYWxsIGNhbGxiYWNrcyBhbmQgdmFsdWVzDQoJCQlkaXNhYmxlOiBmdW5jdGlvbigpIHsNCgkJCQlsb2NrZWQgPSBxdWV1ZSA9IFtdOw0KCQkJCWxpc3QgPSBtZW1vcnkgPSAiIjsNCgkJCQlyZXR1cm4gdGhpczsNCgkJCX0sDQoJCQlkaXNhYmxlZDogZnVuY3Rpb24oKSB7DQoJCQkJcmV0dXJuICFsaXN0Ow0KCQkJfSwNCg0KCQkJLy8gRGlzYWJsZSAuZmlyZQ0KCQkJLy8gQWxzbyBkaXNhYmxlIC5hZGQgdW5sZXNzIHdlIGhhdmUgbWVtb3J5IChzaW5jZSBpdCB3b3VsZCBoYXZlIG5vIGVmZmVjdCkNCgkJCS8vIEFib3J0IGFueSBwZW5kaW5nIGV4ZWN1dGlvbnMNCgkJCWxvY2s6IGZ1bmN0aW9uKCkgew0KCQkJCWxvY2tlZCA9IHF1ZXVlID0gW107DQoJCQkJaWYgKCAhbWVtb3J5ICYmICFmaXJpbmcgKSB7DQoJCQkJCWxpc3QgPSBtZW1vcnkgPSAiIjsNCgkJCQl9DQoJCQkJcmV0dXJuIHRoaXM7DQoJCQl9LA0KCQkJbG9ja2VkOiBmdW5jdGlvbigpIHsNCgkJCQlyZXR1cm4gISFsb2NrZWQ7DQoJCQl9LA0KDQoJCQkvLyBDYWxsIGFsbCBjYWxsYmFja3Mgd2l0aCB0aGUgZ2l2ZW4gY29udGV4dCBhbmQgYXJndW1lbnRzDQoJCQlmaXJlV2l0aDogZnVuY3Rpb24oIGNvbnRleHQsIGFyZ3MgKSB7DQoJCQkJaWYgKCAhbG9ja2VkICkgew0KCQkJCQlhcmdzID0gYXJncyB8fCBbXTsNCgkJCQkJYXJncyA9IFsgY29udGV4dCwgYXJncy5zbGljZSA/IGFyZ3Muc2xpY2UoKSA6IGFyZ3MgXTsNCgkJCQkJcXVldWUucHVzaCggYXJncyApOw0KCQkJCQlpZiAoICFmaXJpbmcgKSB7DQoJCQkJCQlmaXJlKCk7DQoJCQkJCX0NCgkJCQl9DQoJCQkJcmV0dXJuIHRoaXM7DQoJCQl9LA0KDQoJCQkvLyBDYWxsIGFsbCB0aGUgY2FsbGJhY2tzIHdpdGggdGhlIGdpdmVuIGFyZ3VtZW50cw0KCQkJZmlyZTogZnVuY3Rpb24oKSB7DQoJCQkJc2VsZi5maXJlV2l0aCggdGhpcywgYXJndW1lbnRzICk7DQoJCQkJcmV0dXJuIHRoaXM7DQoJCQl9LA0KDQoJCQkvLyBUbyBrbm93IGlmIHRoZSBjYWxsYmFja3MgaGF2ZSBhbHJlYWR5IGJlZW4gY2FsbGVkIGF0IGxlYXN0IG9uY2UNCgkJCWZpcmVkOiBmdW5jdGlvbigpIHsNCgkJCQlyZXR1cm4gISFmaXJlZDsNCgkJCX0NCgkJfTsNCg0KCXJldHVybiBzZWxmOw0KfTsNCg0KDQpmdW5jdGlvbiBJZGVudGl0eSggdiApIHsNCglyZXR1cm4gdjsNCn0NCmZ1bmN0aW9uIFRocm93ZXIoIGV4ICkgew0KCXRocm93IGV4Ow0KfQ0KDQpmdW5jdGlvbiBhZG9wdFZhbHVlKCB2YWx1ZSwgcmVzb2x2ZSwgcmVqZWN0LCBub1ZhbHVlICkgew0KCXZhciBtZXRob2Q7DQoNCgl0cnkgew0KDQoJCS8vIENoZWNrIGZvciBwcm9taXNlIGFzcGVjdCBmaXJzdCB0byBwcml2aWxlZ2Ugc3luY2hyb25vdXMgYmVoYXZpb3INCgkJaWYgKCB2YWx1ZSAmJiBpc0Z1bmN0aW9uKCAoIG1ldGhvZCA9IHZhbHVlLnByb21pc2UgKSApICkgew0KCQkJbWV0aG9kLmNhbGwoIHZhbHVlICkuZG9uZSggcmVzb2x2ZSApLmZhaWwoIHJlamVjdCApOw0KDQoJCS8vIE90aGVyIHRoZW5hYmxlcw0KCQl9IGVsc2UgaWYgKCB2YWx1ZSAmJiBpc0Z1bmN0aW9uKCAoIG1ldGhvZCA9IHZhbHVlLnRoZW4gKSApICkgew0KCQkJbWV0aG9kLmNhbGwoIHZhbHVlLCByZXNvbHZlLCByZWplY3QgKTsNCg0KCQkvLyBPdGhlciBub24tdGhlbmFibGVzDQoJCX0gZWxzZSB7DQoNCgkJCS8vIENvbnRyb2wgYHJlc29sdmVgIGFyZ3VtZW50cyBieSBsZXR0aW5nIEFycmF5I3NsaWNlIGNhc3QgYm9vbGVhbiBgbm9WYWx1ZWAgdG8gaW50ZWdlcjoNCgkJCS8vICogZmFsc2U6IFsgdmFsdWUgXS5zbGljZSggMCApID0+IHJlc29sdmUoIHZhbHVlICkNCgkJCS8vICogdHJ1ZTogWyB2YWx1ZSBdLnNsaWNlKCAxICkgPT4gcmVzb2x2ZSgpDQoJCQlyZXNvbHZlLmFwcGx5KCB1bmRlZmluZWQsIFsgdmFsdWUgXS5zbGljZSggbm9WYWx1ZSApICk7DQoJCX0NCg0KCS8vIEZvciBQcm9taXNlcy9BKywgY29udmVydCBleGNlcHRpb25zIGludG8gcmVqZWN0aW9ucw0KCS8vIFNpbmNlIGpRdWVyeS53aGVuIGRvZXNuJ3QgdW53cmFwIHRoZW5hYmxlcywgd2UgY2FuIHNraXAgdGhlIGV4dHJhIGNoZWNrcyBhcHBlYXJpbmcgaW4NCgkvLyBEZWZlcnJlZCN0aGVuIHRvIGNvbmRpdGlvbmFsbHkgc3VwcHJlc3MgcmVqZWN0aW9uLg0KCX0gY2F0Y2ggKCB2YWx1ZSApIHsNCg0KCQkvLyBTdXBwb3J0OiBBbmRyb2lkIDQuMCBvbmx5DQoJCS8vIFN0cmljdCBtb2RlIGZ1bmN0aW9ucyBpbnZva2VkIHdpdGhvdXQgLmNhbGwvLmFwcGx5IGdldCBnbG9iYWwtb2JqZWN0IGNvbnRleHQNCgkJcmVqZWN0LmFwcGx5KCB1bmRlZmluZWQsIFsgdmFsdWUgXSApOw0KCX0NCn0NCg0KalF1ZXJ5LmV4dGVuZCggew0KDQoJRGVmZXJyZWQ6IGZ1bmN0aW9uKCBmdW5jICkgew0KCQl2YXIgdHVwbGVzID0gWw0KDQoJCQkJLy8gYWN0aW9uLCBhZGQgbGlzdGVuZXIsIGNhbGxiYWNrcywNCgkJCQkvLyAuLi4gLnRoZW4gaGFuZGxlcnMsIGFyZ3VtZW50IGluZGV4LCBbZmluYWwgc3RhdGVdDQoJCQkJWyAibm90aWZ5IiwgInByb2dyZXNzIiwgalF1ZXJ5LkNhbGxiYWNrcyggIm1lbW9yeSIgKSwNCgkJCQkJalF1ZXJ5LkNhbGxiYWNrcyggIm1lbW9yeSIgKSwgMiBdLA0KCQkJCVsgInJlc29sdmUiLCAiZG9uZSIsIGpRdWVyeS5DYWxsYmFja3MoICJvbmNlIG1lbW9yeSIgKSwNCgkJCQkJalF1ZXJ5LkNhbGxiYWNrcyggIm9uY2UgbWVtb3J5IiApLCAwLCAicmVzb2x2ZWQiIF0sDQoJCQkJWyAicmVqZWN0IiwgImZhaWwiLCBqUXVlcnkuQ2FsbGJhY2tzKCAib25jZSBtZW1vcnkiICksDQoJCQkJCWpRdWVyeS5DYWxsYmFja3MoICJvbmNlIG1lbW9yeSIgKSwgMSwgInJlamVjdGVkIiBdDQoJCQldLA0KCQkJc3RhdGUgPSAicGVuZGluZyIsDQoJCQlwcm9taXNlID0gew0KCQkJCXN0YXRlOiBmdW5jdGlvbigpIHsNCgkJCQkJcmV0dXJuIHN0YXRlOw0KCQkJCX0sDQoJCQkJYWx3YXlzOiBmdW5jdGlvbigpIHsNCgkJCQkJZGVmZXJyZWQuZG9uZSggYXJndW1lbnRzICkuZmFpbCggYXJndW1lbnRzICk7DQoJCQkJCXJldHVybiB0aGlzOw0KCQkJCX0sDQoJCQkJImNhdGNoIjogZnVuY3Rpb24oIGZuICkgew0KCQkJCQlyZXR1cm4gcHJvbWlzZS50aGVuKCBudWxsLCBmbiApOw0KCQkJCX0sDQoNCgkJCQkvLyBLZWVwIHBpcGUgZm9yIGJhY2stY29tcGF0DQoJCQkJcGlwZTogZnVuY3Rpb24oIC8qIGZuRG9uZSwgZm5GYWlsLCBmblByb2dyZXNzICovICkgew0KCQkJCQl2YXIgZm5zID0gYXJndW1lbnRzOw0KDQoJCQkJCXJldHVybiBqUXVlcnkuRGVmZXJyZWQoIGZ1bmN0aW9uKCBuZXdEZWZlciApIHsNCgkJCQkJCWpRdWVyeS5lYWNoKCB0dXBsZXMsIGZ1bmN0aW9uKCBfaSwgdHVwbGUgKSB7DQoNCgkJCQkJCQkvLyBNYXAgdHVwbGVzIChwcm9ncmVzcywgZG9uZSwgZmFpbCkgdG8gYXJndW1lbnRzIChkb25lLCBmYWlsLCBwcm9ncmVzcykNCgkJCQkJCQl2YXIgZm4gPSBpc0Z1bmN0aW9uKCBmbnNbIHR1cGxlWyA0IF0gXSApICYmIGZuc1sgdHVwbGVbIDQgXSBdOw0KDQoJCQkJCQkJLy8gZGVmZXJyZWQucHJvZ3Jlc3MoZnVuY3Rpb24oKSB7IGJpbmQgdG8gbmV3RGVmZXIgb3IgbmV3RGVmZXIubm90aWZ5IH0pDQoJCQkJCQkJLy8gZGVmZXJyZWQuZG9uZShmdW5jdGlvbigpIHsgYmluZCB0byBuZXdEZWZlciBvciBuZXdEZWZlci5yZXNvbHZlIH0pDQoJCQkJCQkJLy8gZGVmZXJyZWQuZmFpbChmdW5jdGlvbigpIHsgYmluZCB0byBuZXdEZWZlciBvciBuZXdEZWZlci5yZWplY3QgfSkNCgkJCQkJCQlkZWZlcnJlZFsgdHVwbGVbIDEgXSBdKCBmdW5jdGlvbigpIHsNCgkJCQkJCQkJdmFyIHJldHVybmVkID0gZm4gJiYgZm4uYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOw0KCQkJCQkJCQlpZiAoIHJldHVybmVkICYmIGlzRnVuY3Rpb24oIHJldHVybmVkLnByb21pc2UgKSApIHsNCgkJCQkJCQkJCXJldHVybmVkLnByb21pc2UoKQ0KCQkJCQkJCQkJCS5wcm9ncmVzcyggbmV3RGVmZXIubm90aWZ5ICkNCgkJCQkJCQkJCQkuZG9uZSggbmV3RGVmZXIucmVzb2x2ZSApDQoJCQkJCQkJCQkJLmZhaWwoIG5ld0RlZmVyLnJlamVjdCApOw0KCQkJCQkJCQl9IGVsc2Ugew0KCQkJCQkJCQkJbmV3RGVmZXJbIHR1cGxlWyAwIF0gKyAiV2l0aCIgXSgNCgkJCQkJCQkJCQl0aGlzLA0KCQkJCQkJCQkJCWZuID8gWyByZXR1cm5lZCBdIDogYXJndW1lbnRzDQoJCQkJCQkJCQkpOw0KCQkJCQkJCQl9DQoJCQkJCQkJfSApOw0KCQkJCQkJfSApOw0KCQkJCQkJZm5zID0gbnVsbDsNCgkJCQkJfSApLnByb21pc2UoKTsNCgkJCQl9LA0KCQkJCXRoZW46IGZ1bmN0aW9uKCBvbkZ1bGZpbGxlZCwgb25SZWplY3RlZCwgb25Qcm9ncmVzcyApIHsNCgkJCQkJdmFyIG1heERlcHRoID0gMDsNCgkJCQkJZnVuY3Rpb24gcmVzb2x2ZSggZGVwdGgsIGRlZmVycmVkLCBoYW5kbGVyLCBzcGVjaWFsICkgew0KCQkJCQkJcmV0dXJuIGZ1bmN0aW9uKCkgew0KCQkJCQkJCXZhciB0aGF0ID0gdGhpcywNCgkJCQkJCQkJYXJncyA9IGFyZ3VtZW50cywNCgkJCQkJCQkJbWlnaHRUaHJvdyA9IGZ1bmN0aW9uKCkgew0KCQkJCQkJCQkJdmFyIHJldHVybmVkLCB0aGVuOw0KDQoJCQkJCQkJCQkvLyBTdXBwb3J0OiBQcm9taXNlcy9BKyBzZWN0aW9uIDIuMy4zLjMuMw0KCQkJCQkJCQkJLy8gaHR0cHM6Ly9wcm9taXNlc2FwbHVzLmNvbS8jcG9pbnQtNTkNCgkJCQkJCQkJCS8vIElnbm9yZSBkb3VibGUtcmVzb2x1dGlvbiBhdHRlbXB0cw0KCQkJCQkJCQkJaWYgKCBkZXB0aCA8IG1heERlcHRoICkgew0KCQkJCQkJCQkJCXJldHVybjsNCgkJCQkJCQkJCX0NCg0KCQkJCQkJCQkJcmV0dXJuZWQgPSBoYW5kbGVyLmFwcGx5KCB0aGF0LCBhcmdzICk7DQoNCgkJCQkJCQkJCS8vIFN1cHBvcnQ6IFByb21pc2VzL0ErIHNlY3Rpb24gMi4zLjENCgkJCQkJCQkJCS8vIGh0dHBzOi8vcHJvbWlzZXNhcGx1cy5jb20vI3BvaW50LTQ4DQoJCQkJCQkJCQlpZiAoIHJldHVybmVkID09PSBkZWZlcnJlZC5wcm9taXNlKCkgKSB7DQoJCQkJCQkJCQkJdGhyb3cgbmV3IFR5cGVFcnJvciggIlRoZW5hYmxlIHNlbGYtcmVzb2x1dGlvbiIgKTsNCgkJCQkJCQkJCX0NCg0KCQkJCQkJCQkJLy8gU3VwcG9ydDogUHJvbWlzZXMvQSsgc2VjdGlvbnMgMi4zLjMuMSwgMy41DQoJCQkJCQkJCQkvLyBodHRwczovL3Byb21pc2VzYXBsdXMuY29tLyNwb2ludC01NA0KCQkJCQkJCQkJLy8gaHR0cHM6Ly9wcm9taXNlc2FwbHVzLmNvbS8jcG9pbnQtNzUNCgkJCQkJCQkJCS8vIFJldHJpZXZlIGB0aGVuYCBvbmx5IG9uY2UNCgkJCQkJCQkJCXRoZW4gPSByZXR1cm5lZCAmJg0KDQoJCQkJCQkJCQkJLy8gU3VwcG9ydDogUHJvbWlzZXMvQSsgc2VjdGlvbiAyLjMuNA0KCQkJCQkJCQkJCS8vIGh0dHBzOi8vcHJvbWlzZXNhcGx1cy5jb20vI3BvaW50LTY0DQoJCQkJCQkJCQkJLy8gT25seSBjaGVjayBvYmplY3RzIGFuZCBmdW5jdGlvbnMgZm9yIHRoZW5hYmlsaXR5DQoJCQkJCQkJCQkJKCB0eXBlb2YgcmV0dXJuZWQgPT09ICJvYmplY3QiIHx8DQoJCQkJCQkJCQkJCXR5cGVvZiByZXR1cm5lZCA9PT0gImZ1bmN0aW9uIiApICYmDQoJCQkJCQkJCQkJcmV0dXJuZWQudGhlbjsNCg0KCQkJCQkJCQkJLy8gSGFuZGxlIGEgcmV0dXJuZWQgdGhlbmFibGUNCgkJCQkJCQkJCWlmICggaXNGdW5jdGlvbiggdGhlbiApICkgew0KDQoJCQkJCQkJCQkJLy8gU3BlY2lhbCBwcm9jZXNzb3JzIChub3RpZnkpIGp1c3Qgd2FpdCBmb3IgcmVzb2x1dGlvbg0KCQkJCQkJCQkJCWlmICggc3BlY2lhbCApIHsNCgkJCQkJCQkJCQkJdGhlbi5jYWxsKA0KCQkJCQkJCQkJCQkJcmV0dXJuZWQsDQoJCQkJCQkJCQkJCQlyZXNvbHZlKCBtYXhEZXB0aCwgZGVmZXJyZWQsIElkZW50aXR5LCBzcGVjaWFsICksDQoJCQkJCQkJCQkJCQlyZXNvbHZlKCBtYXhEZXB0aCwgZGVmZXJyZWQsIFRocm93ZXIsIHNwZWNpYWwgKQ0KCQkJCQkJCQkJCQkpOw0KDQoJCQkJCQkJCQkJLy8gTm9ybWFsIHByb2Nlc3NvcnMgKHJlc29sdmUpIGFsc28gaG9vayBpbnRvIHByb2dyZXNzDQoJCQkJCQkJCQkJfSBlbHNlIHsNCg0KCQkJCQkJCQkJCQkvLyAuLi5hbmQgZGlzcmVnYXJkIG9sZGVyIHJlc29sdXRpb24gdmFsdWVzDQoJCQkJCQkJCQkJCW1heERlcHRoKys7DQoNCgkJCQkJCQkJCQkJdGhlbi5jYWxsKA0KCQkJCQkJCQkJCQkJcmV0dXJuZWQsDQoJCQkJCQkJCQkJCQlyZXNvbHZlKCBtYXhEZXB0aCwgZGVmZXJyZWQsIElkZW50aXR5LCBzcGVjaWFsICksDQoJCQkJCQkJCQkJCQlyZXNvbHZlKCBtYXhEZXB0aCwgZGVmZXJyZWQsIFRocm93ZXIsIHNwZWNpYWwgKSwNCgkJCQkJCQkJCQkJCXJlc29sdmUoIG1heERlcHRoLCBkZWZlcnJlZCwgSWRlbnRpdHksDQoJCQkJCQkJCQkJCQkJZGVmZXJyZWQubm90aWZ5V2l0aCApDQoJCQkJCQkJCQkJCSk7DQoJCQkJCQkJCQkJfQ0KDQoJCQkJCQkJCQkvLyBIYW5kbGUgYWxsIG90aGVyIHJldHVybmVkIHZhbHVlcw0KCQkJCQkJCQkJfSBlbHNlIHsNCg0KCQkJCQkJCQkJCS8vIE9ubHkgc3Vic3RpdHV0ZSBoYW5kbGVycyBwYXNzIG9uIGNvbnRleHQNCgkJCQkJCQkJCQkvLyBhbmQgbXVsdGlwbGUgdmFsdWVzIChub24tc3BlYyBiZWhhdmlvcikNCgkJCQkJCQkJCQlpZiAoIGhhbmRsZXIgIT09IElkZW50aXR5ICkgew0KCQkJCQkJCQkJCQl0aGF0ID0gdW5kZWZpbmVkOw0KCQkJCQkJCQkJCQlhcmdzID0gWyByZXR1cm5lZCBdOw0KCQkJCQkJCQkJCX0NCg0KCQkJCQkJCQkJCS8vIFByb2Nlc3MgdGhlIHZhbHVlKHMpDQoJCQkJCQkJCQkJLy8gRGVmYXVsdCBwcm9jZXNzIGlzIHJlc29sdmUNCgkJCQkJCQkJCQkoIHNwZWNpYWwgfHwgZGVmZXJyZWQucmVzb2x2ZVdpdGggKSggdGhhdCwgYXJncyApOw0KCQkJCQkJCQkJfQ0KCQkJCQkJCQl9LA0KDQoJCQkJCQkJCS8vIE9ubHkgbm9ybWFsIHByb2Nlc3NvcnMgKHJlc29sdmUpIGNhdGNoIGFuZCByZWplY3QgZXhjZXB0aW9ucw0KCQkJCQkJCQlwcm9jZXNzID0gc3BlY2lhbCA/DQoJCQkJCQkJCQltaWdodFRocm93IDoNCgkJCQkJCQkJCWZ1bmN0aW9uKCkgew0KCQkJCQkJCQkJCXRyeSB7DQoJCQkJCQkJCQkJCW1pZ2h0VGhyb3coKTsNCgkJCQkJCQkJCQl9IGNhdGNoICggZSApIHsNCg0KCQkJCQkJCQkJCQlpZiAoIGpRdWVyeS5EZWZlcnJlZC5leGNlcHRpb25Ib29rICkgew0KCQkJCQkJCQkJCQkJalF1ZXJ5LkRlZmVycmVkLmV4Y2VwdGlvbkhvb2soIGUsDQoJCQkJCQkJCQkJCQkJcHJvY2Vzcy5zdGFja1RyYWNlICk7DQoJCQkJCQkJCQkJCX0NCg0KCQkJCQkJCQkJCQkvLyBTdXBwb3J0OiBQcm9taXNlcy9BKyBzZWN0aW9uIDIuMy4zLjMuNC4xDQoJCQkJCQkJCQkJCS8vIGh0dHBzOi8vcHJvbWlzZXNhcGx1cy5jb20vI3BvaW50LTYxDQoJCQkJCQkJCQkJCS8vIElnbm9yZSBwb3N0LXJlc29sdXRpb24gZXhjZXB0aW9ucw0KCQkJCQkJCQkJCQlpZiAoIGRlcHRoICsgMSA+PSBtYXhEZXB0aCApIHsNCg0KCQkJCQkJCQkJCQkJLy8gT25seSBzdWJzdGl0dXRlIGhhbmRsZXJzIHBhc3Mgb24gY29udGV4dA0KCQkJCQkJCQkJCQkJLy8gYW5kIG11bHRpcGxlIHZhbHVlcyAobm9uLXNwZWMgYmVoYXZpb3IpDQoJCQkJCQkJCQkJCQlpZiAoIGhhbmRsZXIgIT09IFRocm93ZXIgKSB7DQoJCQkJCQkJCQkJCQkJdGhhdCA9IHVuZGVmaW5lZDsNCgkJCQkJCQkJCQkJCQlhcmdzID0gWyBlIF07DQoJCQkJCQkJCQkJCQl9DQoNCgkJCQkJCQkJCQkJCWRlZmVycmVkLnJlamVjdFdpdGgoIHRoYXQsIGFyZ3MgKTsNCgkJCQkJCQkJCQkJfQ0KCQkJCQkJCQkJCX0NCgkJCQkJCQkJCX07DQoNCgkJCQkJCQkvLyBTdXBwb3J0OiBQcm9taXNlcy9BKyBzZWN0aW9uIDIuMy4zLjMuMQ0KCQkJCQkJCS8vIGh0dHBzOi8vcHJvbWlzZXNhcGx1cy5jb20vI3BvaW50LTU3DQoJCQkJCQkJLy8gUmUtcmVzb2x2ZSBwcm9taXNlcyBpbW1lZGlhdGVseSB0byBkb2RnZSBmYWxzZSByZWplY3Rpb24gZnJvbQ0KCQkJCQkJCS8vIHN1YnNlcXVlbnQgZXJyb3JzDQoJCQkJCQkJaWYgKCBkZXB0aCApIHsNCgkJCQkJCQkJcHJvY2VzcygpOw0KCQkJCQkJCX0gZWxzZSB7DQoNCgkJCQkJCQkJLy8gQ2FsbCBhbiBvcHRpb25hbCBob29rIHRvIHJlY29yZCB0aGUgc3RhY2ssIGluIGNhc2Ugb2YgZXhjZXB0aW9uDQoJCQkJCQkJCS8vIHNpbmNlIGl0J3Mgb3RoZXJ3aXNlIGxvc3Qgd2hlbiBleGVjdXRpb24gZ29lcyBhc3luYw0KCQkJCQkJCQlpZiAoIGpRdWVyeS5EZWZlcnJlZC5nZXRTdGFja0hvb2sgKSB7DQoJCQkJCQkJCQlwcm9jZXNzLnN0YWNrVHJhY2UgPSBqUXVlcnkuRGVmZXJyZWQuZ2V0U3RhY2tIb29rKCk7DQoJCQkJCQkJCX0NCgkJCQkJCQkJd2luZG93LnNldFRpbWVvdXQoIHByb2Nlc3MgKTsNCgkJCQkJCQl9DQoJCQkJCQl9Ow0KCQkJCQl9DQoNCgkJCQkJcmV0dXJuIGpRdWVyeS5EZWZlcnJlZCggZnVuY3Rpb24oIG5ld0RlZmVyICkgew0KDQoJCQkJCQkvLyBwcm9ncmVzc19oYW5kbGVycy5hZGQoIC4uLiApDQoJCQkJCQl0dXBsZXNbIDAgXVsgMyBdLmFkZCgNCgkJCQkJCQlyZXNvbHZlKA0KCQkJCQkJCQkwLA0KCQkJCQkJCQluZXdEZWZlciwNCgkJCQkJCQkJaXNGdW5jdGlvbiggb25Qcm9ncmVzcyApID8NCgkJCQkJCQkJCW9uUHJvZ3Jlc3MgOg0KCQkJCQkJCQkJSWRlbnRpdHksDQoJCQkJCQkJCW5ld0RlZmVyLm5vdGlmeVdpdGgNCgkJCQkJCQkpDQoJCQkJCQkpOw0KDQoJCQkJCQkvLyBmdWxmaWxsZWRfaGFuZGxlcnMuYWRkKCAuLi4gKQ0KCQkJCQkJdHVwbGVzWyAxIF1bIDMgXS5hZGQoDQoJCQkJCQkJcmVzb2x2ZSgNCgkJCQkJCQkJMCwNCgkJCQkJCQkJbmV3RGVmZXIsDQoJCQkJCQkJCWlzRnVuY3Rpb24oIG9uRnVsZmlsbGVkICkgPw0KCQkJCQkJCQkJb25GdWxmaWxsZWQgOg0KCQkJCQkJCQkJSWRlbnRpdHkNCgkJCQkJCQkpDQoJCQkJCQkpOw0KDQoJCQkJCQkvLyByZWplY3RlZF9oYW5kbGVycy5hZGQoIC4uLiApDQoJCQkJCQl0dXBsZXNbIDIgXVsgMyBdLmFkZCgNCgkJCQkJCQlyZXNvbHZlKA0KCQkJCQkJCQkwLA0KCQkJCQkJCQluZXdEZWZlciwNCgkJCQkJCQkJaXNGdW5jdGlvbiggb25SZWplY3RlZCApID8NCgkJCQkJCQkJCW9uUmVqZWN0ZWQgOg0KCQkJCQkJCQkJVGhyb3dlcg0KCQkJCQkJCSkNCgkJCQkJCSk7DQoJCQkJCX0gKS5wcm9taXNlKCk7DQoJCQkJfSwNCg0KCQkJCS8vIEdldCBhIHByb21pc2UgZm9yIHRoaXMgZGVmZXJyZWQNCgkJCQkvLyBJZiBvYmogaXMgcHJvdmlkZWQsIHRoZSBwcm9taXNlIGFzcGVjdCBpcyBhZGRlZCB0byB0aGUgb2JqZWN0DQoJCQkJcHJvbWlzZTogZnVuY3Rpb24oIG9iaiApIHsNCgkJCQkJcmV0dXJuIG9iaiAhPSBudWxsID8galF1ZXJ5LmV4dGVuZCggb2JqLCBwcm9taXNlICkgOiBwcm9taXNlOw0KCQkJCX0NCgkJCX0sDQoJCQlkZWZlcnJlZCA9IHt9Ow0KDQoJCS8vIEFkZCBsaXN0LXNwZWNpZmljIG1ldGhvZHMNCgkJalF1ZXJ5LmVhY2goIHR1cGxlcywgZnVuY3Rpb24oIGksIHR1cGxlICkgew0KCQkJdmFyIGxpc3QgPSB0dXBsZVsgMiBdLA0KCQkJCXN0YXRlU3RyaW5nID0gdHVwbGVbIDUgXTsNCg0KCQkJLy8gcHJvbWlzZS5wcm9ncmVzcyA9IGxpc3QuYWRkDQoJCQkvLyBwcm9taXNlLmRvbmUgPSBsaXN0LmFkZA0KCQkJLy8gcHJvbWlzZS5mYWlsID0gbGlzdC5hZGQNCgkJCXByb21pc2VbIHR1cGxlWyAxIF0gXSA9IGxpc3QuYWRkOw0KDQoJCQkvLyBIYW5kbGUgc3RhdGUNCgkJCWlmICggc3RhdGVTdHJpbmcgKSB7DQoJCQkJbGlzdC5hZGQoDQoJCQkJCWZ1bmN0aW9uKCkgew0KDQoJCQkJCQkvLyBzdGF0ZSA9ICJyZXNvbHZlZCIgKGkuZS4sIGZ1bGZpbGxlZCkNCgkJCQkJCS8vIHN0YXRlID0gInJlamVjdGVkIg0KCQkJCQkJc3RhdGUgPSBzdGF0ZVN0cmluZzsNCgkJCQkJfSwNCg0KCQkJCQkvLyByZWplY3RlZF9jYWxsYmFja3MuZGlzYWJsZQ0KCQkJCQkvLyBmdWxmaWxsZWRfY2FsbGJhY2tzLmRpc2FibGUNCgkJCQkJdHVwbGVzWyAzIC0gaSBdWyAyIF0uZGlzYWJsZSwNCg0KCQkJCQkvLyByZWplY3RlZF9oYW5kbGVycy5kaXNhYmxlDQoJCQkJCS8vIGZ1bGZpbGxlZF9oYW5kbGVycy5kaXNhYmxlDQoJCQkJCXR1cGxlc1sgMyAtIGkgXVsgMyBdLmRpc2FibGUsDQoNCgkJCQkJLy8gcHJvZ3Jlc3NfY2FsbGJhY2tzLmxvY2sNCgkJCQkJdHVwbGVzWyAwIF1bIDIgXS5sb2NrLA0KDQoJCQkJCS8vIHByb2dyZXNzX2hhbmRsZXJzLmxvY2sNCgkJCQkJdHVwbGVzWyAwIF1bIDMgXS5sb2NrDQoJCQkJKTsNCgkJCX0NCg0KCQkJLy8gcHJvZ3Jlc3NfaGFuZGxlcnMuZmlyZQ0KCQkJLy8gZnVsZmlsbGVkX2hhbmRsZXJzLmZpcmUNCgkJCS8vIHJlamVjdGVkX2hhbmRsZXJzLmZpcmUNCgkJCWxpc3QuYWRkKCB0dXBsZVsgMyBdLmZpcmUgKTsNCg0KCQkJLy8gZGVmZXJyZWQubm90aWZ5ID0gZnVuY3Rpb24oKSB7IGRlZmVycmVkLm5vdGlmeVdpdGgoLi4uKSB9DQoJCQkvLyBkZWZlcnJlZC5yZXNvbHZlID0gZnVuY3Rpb24oKSB7IGRlZmVycmVkLnJlc29sdmVXaXRoKC4uLikgfQ0KCQkJLy8gZGVmZXJyZWQucmVqZWN0ID0gZnVuY3Rpb24oKSB7IGRlZmVycmVkLnJlamVjdFdpdGgoLi4uKSB9DQoJCQlkZWZlcnJlZFsgdHVwbGVbIDAgXSBdID0gZnVuY3Rpb24oKSB7DQoJCQkJZGVmZXJyZWRbIHR1cGxlWyAwIF0gKyAiV2l0aCIgXSggdGhpcyA9PT0gZGVmZXJyZWQgPyB1bmRlZmluZWQgOiB0aGlzLCBhcmd1bWVudHMgKTsNCgkJCQlyZXR1cm4gdGhpczsNCgkJCX07DQoNCgkJCS8vIGRlZmVycmVkLm5vdGlmeVdpdGggPSBsaXN0LmZpcmVXaXRoDQoJCQkvLyBkZWZlcnJlZC5yZXNvbHZlV2l0aCA9IGxpc3QuZmlyZVdpdGgNCgkJCS8vIGRlZmVycmVkLnJlamVjdFdpdGggPSBsaXN0LmZpcmVXaXRoDQoJCQlkZWZlcnJlZFsgdHVwbGVbIDAgXSArICJXaXRoIiBdID0gbGlzdC5maXJlV2l0aDsNCgkJfSApOw0KDQoJCS8vIE1ha2UgdGhlIGRlZmVycmVkIGEgcHJvbWlzZQ0KCQlwcm9taXNlLnByb21pc2UoIGRlZmVycmVkICk7DQoNCgkJLy8gQ2FsbCBnaXZlbiBmdW5jIGlmIGFueQ0KCQlpZiAoIGZ1bmMgKSB7DQoJCQlmdW5jLmNhbGwoIGRlZmVycmVkLCBkZWZlcnJlZCApOw0KCQl9DQoNCgkJLy8gQWxsIGRvbmUhDQoJCXJldHVybiBkZWZlcnJlZDsNCgl9LA0KDQoJLy8gRGVmZXJyZWQgaGVscGVyDQoJd2hlbjogZnVuY3Rpb24oIHNpbmdsZVZhbHVlICkgew0KCQl2YXINCg0KCQkJLy8gY291bnQgb2YgdW5jb21wbGV0ZWQgc3Vib3JkaW5hdGVzDQoJCQlyZW1haW5pbmcgPSBhcmd1bWVudHMubGVuZ3RoLA0KDQoJCQkvLyBjb3VudCBvZiB1bnByb2Nlc3NlZCBhcmd1bWVudHMNCgkJCWkgPSByZW1haW5pbmcsDQoNCgkJCS8vIHN1Ym9yZGluYXRlIGZ1bGZpbGxtZW50IGRhdGENCgkJCXJlc29sdmVDb250ZXh0cyA9IEFycmF5KCBpICksDQoJCQlyZXNvbHZlVmFsdWVzID0gc2xpY2UuY2FsbCggYXJndW1lbnRzICksDQoNCgkJCS8vIHRoZSBwcmltYXJ5IERlZmVycmVkDQoJCQlwcmltYXJ5ID0galF1ZXJ5LkRlZmVycmVkKCksDQoNCgkJCS8vIHN1Ym9yZGluYXRlIGNhbGxiYWNrIGZhY3RvcnkNCgkJCXVwZGF0ZUZ1bmMgPSBmdW5jdGlvbiggaSApIHsNCgkJCQlyZXR1cm4gZnVuY3Rpb24oIHZhbHVlICkgew0KCQkJCQlyZXNvbHZlQ29udGV4dHNbIGkgXSA9IHRoaXM7DQoJCQkJCXJlc29sdmVWYWx1ZXNbIGkgXSA9IGFyZ3VtZW50cy5sZW5ndGggPiAxID8gc2xpY2UuY2FsbCggYXJndW1lbnRzICkgOiB2YWx1ZTsNCgkJCQkJaWYgKCAhKCAtLXJlbWFpbmluZyApICkgew0KCQkJCQkJcHJpbWFyeS5yZXNvbHZlV2l0aCggcmVzb2x2ZUNvbnRleHRzLCByZXNvbHZlVmFsdWVzICk7DQoJCQkJCX0NCgkJCQl9Ow0KCQkJfTsNCg0KCQkvLyBTaW5nbGUtIGFuZCBlbXB0eSBhcmd1bWVudHMgYXJlIGFkb3B0ZWQgbGlrZSBQcm9taXNlLnJlc29sdmUNCgkJaWYgKCByZW1haW5pbmcgPD0gMSApIHsNCgkJCWFkb3B0VmFsdWUoIHNpbmdsZVZhbHVlLCBwcmltYXJ5LmRvbmUoIHVwZGF0ZUZ1bmMoIGkgKSApLnJlc29sdmUsIHByaW1hcnkucmVqZWN0LA0KCQkJCSFyZW1haW5pbmcgKTsNCg0KCQkJLy8gVXNlIC50aGVuKCkgdG8gdW53cmFwIHNlY29uZGFyeSB0aGVuYWJsZXMgKGNmLiBnaC0zMDAwKQ0KCQkJaWYgKCBwcmltYXJ5LnN0YXRlKCkgPT09ICJwZW5kaW5nIiB8fA0KCQkJCWlzRnVuY3Rpb24oIHJlc29sdmVWYWx1ZXNbIGkgXSAmJiByZXNvbHZlVmFsdWVzWyBpIF0udGhlbiApICkgew0KDQoJCQkJcmV0dXJuIHByaW1hcnkudGhlbigpOw0KCQkJfQ0KCQl9DQoNCgkJLy8gTXVsdGlwbGUgYXJndW1lbnRzIGFyZSBhZ2dyZWdhdGVkIGxpa2UgUHJvbWlzZS5hbGwgYXJyYXkgZWxlbWVudHMNCgkJd2hpbGUgKCBpLS0gKSB7DQoJCQlhZG9wdFZhbHVlKCByZXNvbHZlVmFsdWVzWyBpIF0sIHVwZGF0ZUZ1bmMoIGkgKSwgcHJpbWFyeS5yZWplY3QgKTsNCgkJfQ0KDQoJCXJldHVybiBwcmltYXJ5LnByb21pc2UoKTsNCgl9DQp9ICk7DQoNCg0KLy8gVGhlc2UgdXN1YWxseSBpbmRpY2F0ZSBhIHByb2dyYW1tZXIgbWlzdGFrZSBkdXJpbmcgZGV2ZWxvcG1lbnQsDQovLyB3YXJuIGFib3V0IHRoZW0gQVNBUCByYXRoZXIgdGhhbiBzd2FsbG93aW5nIHRoZW0gYnkgZGVmYXVsdC4NCnZhciByZXJyb3JOYW1lcyA9IC9eKEV2YWx8SW50ZXJuYWx8UmFuZ2V8UmVmZXJlbmNlfFN5bnRheHxUeXBlfFVSSSlFcnJvciQvOw0KDQpqUXVlcnkuRGVmZXJyZWQuZXhjZXB0aW9uSG9vayA9IGZ1bmN0aW9uKCBlcnJvciwgc3RhY2sgKSB7DQoNCgkvLyBTdXBwb3J0OiBJRSA4IC0gOSBvbmx5DQoJLy8gQ29uc29sZSBleGlzdHMgd2hlbiBkZXYgdG9vbHMgYXJlIG9wZW4sIHdoaWNoIGNhbiBoYXBwZW4gYXQgYW55IHRpbWUNCglpZiAoIHdpbmRvdy5jb25zb2xlICYmIHdpbmRvdy5jb25zb2xlLndhcm4gJiYgZXJyb3IgJiYgcmVycm9yTmFtZXMudGVzdCggZXJyb3IubmFtZSApICkgew0KCQl3aW5kb3cuY29uc29sZS53YXJuKCAialF1ZXJ5LkRlZmVycmVkIGV4Y2VwdGlvbjogIiArIGVycm9yLm1lc3NhZ2UsIGVycm9yLnN0YWNrLCBzdGFjayApOw0KCX0NCn07DQoNCg0KDQoNCmpRdWVyeS5yZWFkeUV4Y2VwdGlvbiA9IGZ1bmN0aW9uKCBlcnJvciApIHsNCgl3aW5kb3cuc2V0VGltZW91dCggZnVuY3Rpb24oKSB7DQoJCXRocm93IGVycm9yOw0KCX0gKTsNCn07DQoNCg0KDQoNCi8vIFRoZSBkZWZlcnJlZCB1c2VkIG9uIERPTSByZWFkeQ0KdmFyIHJlYWR5TGlzdCA9IGpRdWVyeS5EZWZlcnJlZCgpOw0KDQpqUXVlcnkuZm4ucmVhZHkgPSBmdW5jdGlvbiggZm4gKSB7DQoNCglyZWFkeUxpc3QNCgkJLnRoZW4oIGZuICkNCg0KCQkvLyBXcmFwIGpRdWVyeS5yZWFkeUV4Y2VwdGlvbiBpbiBhIGZ1bmN0aW9uIHNvIHRoYXQgdGhlIGxvb2t1cA0KCQkvLyBoYXBwZW5zIGF0IHRoZSB0aW1lIG9mIGVycm9yIGhhbmRsaW5nIGluc3RlYWQgb2YgY2FsbGJhY2sNCgkJLy8gcmVnaXN0cmF0aW9uLg0KCQkuY2F0Y2goIGZ1bmN0aW9uKCBlcnJvciApIHsNCgkJCWpRdWVyeS5yZWFkeUV4Y2VwdGlvbiggZXJyb3IgKTsNCgkJfSApOw0KDQoJcmV0dXJuIHRoaXM7DQp9Ow0KDQpqUXVlcnkuZXh0ZW5kKCB7DQoNCgkvLyBJcyB0aGUgRE9NIHJlYWR5IHRvIGJlIHVzZWQ/IFNldCB0byB0cnVlIG9uY2UgaXQgb2NjdXJzLg0KCWlzUmVhZHk6IGZhbHNlLA0KDQoJLy8gQSBjb3VudGVyIHRvIHRyYWNrIGhvdyBtYW55IGl0ZW1zIHRvIHdhaXQgZm9yIGJlZm9yZQ0KCS8vIHRoZSByZWFkeSBldmVudCBmaXJlcy4gU2VlICM2NzgxDQoJcmVhZHlXYWl0OiAxLA0KDQoJLy8gSGFuZGxlIHdoZW4gdGhlIERPTSBpcyByZWFkeQ0KCXJlYWR5OiBmdW5jdGlvbiggd2FpdCApIHsNCg0KCQkvLyBBYm9ydCBpZiB0aGVyZSBhcmUgcGVuZGluZyBob2xkcyBvciB3ZSdyZSBhbHJlYWR5IHJlYWR5DQoJCWlmICggd2FpdCA9PT0gdHJ1ZSA/IC0talF1ZXJ5LnJlYWR5V2FpdCA6IGpRdWVyeS5pc1JlYWR5ICkgew0KCQkJcmV0dXJuOw0KCQl9DQoNCgkJLy8gUmVtZW1iZXIgdGhhdCB0aGUgRE9NIGlzIHJlYWR5DQoJCWpRdWVyeS5pc1JlYWR5ID0gdHJ1ZTsNCg0KCQkvLyBJZiBhIG5vcm1hbCBET00gUmVhZHkgZXZlbnQgZmlyZWQsIGRlY3JlbWVudCwgYW5kIHdhaXQgaWYgbmVlZCBiZQ0KCQlpZiAoIHdhaXQgIT09IHRydWUgJiYgLS1qUXVlcnkucmVhZHlXYWl0ID4gMCApIHsNCgkJCXJldHVybjsNCgkJfQ0KDQoJCS8vIElmIHRoZXJlIGFyZSBmdW5jdGlvbnMgYm91bmQsIHRvIGV4ZWN1dGUNCgkJcmVhZHlMaXN0LnJlc29sdmVXaXRoKCBkb2N1bWVudCwgWyBqUXVlcnkgXSApOw0KCX0NCn0gKTsNCg0KalF1ZXJ5LnJlYWR5LnRoZW4gPSByZWFkeUxpc3QudGhlbjsNCg0KLy8gVGhlIHJlYWR5IGV2ZW50IGhhbmRsZXIgYW5kIHNlbGYgY2xlYW51cCBtZXRob2QNCmZ1bmN0aW9uIGNvbXBsZXRlZCgpIHsNCglkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCAiRE9NQ29udGVudExvYWRlZCIsIGNvbXBsZXRlZCApOw0KCXdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCAibG9hZCIsIGNvbXBsZXRlZCApOw0KCWpRdWVyeS5yZWFkeSgpOw0KfQ0KDQovLyBDYXRjaCBjYXNlcyB3aGVyZSAkKGRvY3VtZW50KS5yZWFkeSgpIGlzIGNhbGxlZA0KLy8gYWZ0ZXIgdGhlIGJyb3dzZXIgZXZlbnQgaGFzIGFscmVhZHkgb2NjdXJyZWQuDQovLyBTdXBwb3J0OiBJRSA8PTkgLSAxMCBvbmx5DQovLyBPbGRlciBJRSBzb21ldGltZXMgc2lnbmFscyAiaW50ZXJhY3RpdmUiIHRvbyBzb29uDQppZiAoIGRvY3VtZW50LnJlYWR5U3RhdGUgPT09ICJjb21wbGV0ZSIgfHwNCgkoIGRvY3VtZW50LnJlYWR5U3RhdGUgIT09ICJsb2FkaW5nIiAmJiAhZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmRvU2Nyb2xsICkgKSB7DQoNCgkvLyBIYW5kbGUgaXQgYXN5bmNocm9ub3VzbHkgdG8gYWxsb3cgc2NyaXB0cyB0aGUgb3Bwb3J0dW5pdHkgdG8gZGVsYXkgcmVhZHkNCgl3aW5kb3cuc2V0VGltZW91dCggalF1ZXJ5LnJlYWR5ICk7DQoNCn0gZWxzZSB7DQoNCgkvLyBVc2UgdGhlIGhhbmR5IGV2ZW50IGNhbGxiYWNrDQoJZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lciggIkRPTUNvbnRlbnRMb2FkZWQiLCBjb21wbGV0ZWQgKTsNCg0KCS8vIEEgZmFsbGJhY2sgdG8gd2luZG93Lm9ubG9hZCwgdGhhdCB3aWxsIGFsd2F5cyB3b3JrDQoJd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoICJsb2FkIiwgY29tcGxldGVkICk7DQp9DQoNCg0KDQoNCi8vIE11bHRpZnVuY3Rpb25hbCBtZXRob2QgdG8gZ2V0IGFuZCBzZXQgdmFsdWVzIG9mIGEgY29sbGVjdGlvbg0KLy8gVGhlIHZhbHVlL3MgY2FuIG9wdGlvbmFsbHkgYmUgZXhlY3V0ZWQgaWYgaXQncyBhIGZ1bmN0aW9uDQp2YXIgYWNjZXNzID0gZnVuY3Rpb24oIGVsZW1zLCBmbiwga2V5LCB2YWx1ZSwgY2hhaW5hYmxlLCBlbXB0eUdldCwgcmF3ICkgew0KCXZhciBpID0gMCwNCgkJbGVuID0gZWxlbXMubGVuZ3RoLA0KCQlidWxrID0ga2V5ID09IG51bGw7DQoNCgkvLyBTZXRzIG1hbnkgdmFsdWVzDQoJaWYgKCB0b1R5cGUoIGtleSApID09PSAib2JqZWN0IiApIHsNCgkJY2hhaW5hYmxlID0gdHJ1ZTsNCgkJZm9yICggaSBpbiBrZXkgKSB7DQoJCQlhY2Nlc3MoIGVsZW1zLCBmbiwgaSwga2V5WyBpIF0sIHRydWUsIGVtcHR5R2V0LCByYXcgKTsNCgkJfQ0KDQoJLy8gU2V0cyBvbmUgdmFsdWUNCgl9IGVsc2UgaWYgKCB2YWx1ZSAhPT0gdW5kZWZpbmVkICkgew0KCQljaGFpbmFibGUgPSB0cnVlOw0KDQoJCWlmICggIWlzRnVuY3Rpb24oIHZhbHVlICkgKSB7DQoJCQlyYXcgPSB0cnVlOw0KCQl9DQoNCgkJaWYgKCBidWxrICkgew0KDQoJCQkvLyBCdWxrIG9wZXJhdGlvbnMgcnVuIGFnYWluc3QgdGhlIGVudGlyZSBzZXQNCgkJCWlmICggcmF3ICkgew0KCQkJCWZuLmNhbGwoIGVsZW1zLCB2YWx1ZSApOw0KCQkJCWZuID0gbnVsbDsNCg0KCQkJLy8gLi4uZXhjZXB0IHdoZW4gZXhlY3V0aW5nIGZ1bmN0aW9uIHZhbHVlcw0KCQkJfSBlbHNlIHsNCgkJCQlidWxrID0gZm47DQoJCQkJZm4gPSBmdW5jdGlvbiggZWxlbSwgX2tleSwgdmFsdWUgKSB7DQoJCQkJCXJldHVybiBidWxrLmNhbGwoIGpRdWVyeSggZWxlbSApLCB2YWx1ZSApOw0KCQkJCX07DQoJCQl9DQoJCX0NCg0KCQlpZiAoIGZuICkgew0KCQkJZm9yICggOyBpIDwgbGVuOyBpKysgKSB7DQoJCQkJZm4oDQoJCQkJCWVsZW1zWyBpIF0sIGtleSwgcmF3ID8NCgkJCQkJCXZhbHVlIDoNCgkJCQkJCXZhbHVlLmNhbGwoIGVsZW1zWyBpIF0sIGksIGZuKCBlbGVtc1sgaSBdLCBrZXkgKSApDQoJCQkJKTsNCgkJCX0NCgkJfQ0KCX0NCg0KCWlmICggY2hhaW5hYmxlICkgew0KCQlyZXR1cm4gZWxlbXM7DQoJfQ0KDQoJLy8gR2V0cw0KCWlmICggYnVsayApIHsNCgkJcmV0dXJuIGZuLmNhbGwoIGVsZW1zICk7DQoJfQ0KDQoJcmV0dXJuIGxlbiA/IGZuKCBlbGVtc1sgMCBdLCBrZXkgKSA6IGVtcHR5R2V0Ow0KfTsNCg0KDQovLyBNYXRjaGVzIGRhc2hlZCBzdHJpbmcgZm9yIGNhbWVsaXppbmcNCnZhciBybXNQcmVmaXggPSAvXi1tcy0vLA0KCXJkYXNoQWxwaGEgPSAvLShbYS16XSkvZzsNCg0KLy8gVXNlZCBieSBjYW1lbENhc2UgYXMgY2FsbGJhY2sgdG8gcmVwbGFjZSgpDQpmdW5jdGlvbiBmY2FtZWxDYXNlKCBfYWxsLCBsZXR0ZXIgKSB7DQoJcmV0dXJuIGxldHRlci50b1VwcGVyQ2FzZSgpOw0KfQ0KDQovLyBDb252ZXJ0IGRhc2hlZCB0byBjYW1lbENhc2U7IHVzZWQgYnkgdGhlIGNzcyBhbmQgZGF0YSBtb2R1bGVzDQovLyBTdXBwb3J0OiBJRSA8PTkgLSAxMSwgRWRnZSAxMiAtIDE1DQovLyBNaWNyb3NvZnQgZm9yZ290IHRvIGh1bXAgdGhlaXIgdmVuZG9yIHByZWZpeCAoIzk1NzIpDQpmdW5jdGlvbiBjYW1lbENhc2UoIHN0cmluZyApIHsNCglyZXR1cm4gc3RyaW5nLnJlcGxhY2UoIHJtc1ByZWZpeCwgIm1zLSIgKS5yZXBsYWNlKCByZGFzaEFscGhhLCBmY2FtZWxDYXNlICk7DQp9DQp2YXIgYWNjZXB0RGF0YSA9IGZ1bmN0aW9uKCBvd25lciApIHsNCg0KCS8vIEFjY2VwdHMgb25seToNCgkvLyAgLSBOb2RlDQoJLy8gICAgLSBOb2RlLkVMRU1FTlRfTk9ERQ0KCS8vICAgIC0gTm9kZS5ET0NVTUVOVF9OT0RFDQoJLy8gIC0gT2JqZWN0DQoJLy8gICAgLSBBbnkNCglyZXR1cm4gb3duZXIubm9kZVR5cGUgPT09IDEgfHwgb3duZXIubm9kZVR5cGUgPT09IDkgfHwgISggK293bmVyLm5vZGVUeXBlICk7DQp9Ow0KDQoNCg0KDQpmdW5jdGlvbiBEYXRhKCkgew0KCXRoaXMuZXhwYW5kbyA9IGpRdWVyeS5leHBhbmRvICsgRGF0YS51aWQrKzsNCn0NCg0KRGF0YS51aWQgPSAxOw0KDQpEYXRhLnByb3RvdHlwZSA9IHsNCg0KCWNhY2hlOiBmdW5jdGlvbiggb3duZXIgKSB7DQoNCgkJLy8gQ2hlY2sgaWYgdGhlIG93bmVyIG9iamVjdCBhbHJlYWR5IGhhcyBhIGNhY2hlDQoJCXZhciB2YWx1ZSA9IG93bmVyWyB0aGlzLmV4cGFuZG8gXTsNCg0KCQkvLyBJZiBub3QsIGNyZWF0ZSBvbmUNCgkJaWYgKCAhdmFsdWUgKSB7DQoJCQl2YWx1ZSA9IHt9Ow0KDQoJCQkvLyBXZSBjYW4gYWNjZXB0IGRhdGEgZm9yIG5vbi1lbGVtZW50IG5vZGVzIGluIG1vZGVybiBicm93c2VycywNCgkJCS8vIGJ1dCB3ZSBzaG91bGQgbm90LCBzZWUgIzgzMzUuDQoJCQkvLyBBbHdheXMgcmV0dXJuIGFuIGVtcHR5IG9iamVjdC4NCgkJCWlmICggYWNjZXB0RGF0YSggb3duZXIgKSApIHsNCg0KCQkJCS8vIElmIGl0IGlzIGEgbm9kZSB1bmxpa2VseSB0byBiZSBzdHJpbmdpZnktZWQgb3IgbG9vcGVkIG92ZXINCgkJCQkvLyB1c2UgcGxhaW4gYXNzaWdubWVudA0KCQkJCWlmICggb3duZXIubm9kZVR5cGUgKSB7DQoJCQkJCW93bmVyWyB0aGlzLmV4cGFuZG8gXSA9IHZhbHVlOw0KDQoJCQkJLy8gT3RoZXJ3aXNlIHNlY3VyZSBpdCBpbiBhIG5vbi1lbnVtZXJhYmxlIHByb3BlcnR5DQoJCQkJLy8gY29uZmlndXJhYmxlIG11c3QgYmUgdHJ1ZSB0byBhbGxvdyB0aGUgcHJvcGVydHkgdG8gYmUNCgkJCQkvLyBkZWxldGVkIHdoZW4gZGF0YSBpcyByZW1vdmVkDQoJCQkJfSBlbHNlIHsNCgkJCQkJT2JqZWN0LmRlZmluZVByb3BlcnR5KCBvd25lciwgdGhpcy5leHBhbmRvLCB7DQoJCQkJCQl2YWx1ZTogdmFsdWUsDQoJCQkJCQljb25maWd1cmFibGU6IHRydWUNCgkJCQkJfSApOw0KCQkJCX0NCgkJCX0NCgkJfQ0KDQoJCXJldHVybiB2YWx1ZTsNCgl9LA0KCXNldDogZnVuY3Rpb24oIG93bmVyLCBkYXRhLCB2YWx1ZSApIHsNCgkJdmFyIHByb3AsDQoJCQljYWNoZSA9IHRoaXMuY2FjaGUoIG93bmVyICk7DQoNCgkJLy8gSGFuZGxlOiBbIG93bmVyLCBrZXksIHZhbHVlIF0gYXJncw0KCQkvLyBBbHdheXMgdXNlIGNhbWVsQ2FzZSBrZXkgKGdoLTIyNTcpDQoJCWlmICggdHlwZW9mIGRhdGEgPT09ICJzdHJpbmciICkgew0KCQkJY2FjaGVbIGNhbWVsQ2FzZSggZGF0YSApIF0gPSB2YWx1ZTsNCg0KCQkvLyBIYW5kbGU6IFsgb3duZXIsIHsgcHJvcGVydGllcyB9IF0gYXJncw0KCQl9IGVsc2Ugew0KDQoJCQkvLyBDb3B5IHRoZSBwcm9wZXJ0aWVzIG9uZS1ieS1vbmUgdG8gdGhlIGNhY2hlIG9iamVjdA0KCQkJZm9yICggcHJvcCBpbiBkYXRhICkgew0KCQkJCWNhY2hlWyBjYW1lbENhc2UoIHByb3AgKSBdID0gZGF0YVsgcHJvcCBdOw0KCQkJfQ0KCQl9DQoJCXJldHVybiBjYWNoZTsNCgl9LA0KCWdldDogZnVuY3Rpb24oIG93bmVyLCBrZXkgKSB7DQoJCXJldHVybiBrZXkgPT09IHVuZGVmaW5lZCA/DQoJCQl0aGlzLmNhY2hlKCBvd25lciApIDoNCg0KCQkJLy8gQWx3YXlzIHVzZSBjYW1lbENhc2Uga2V5IChnaC0yMjU3KQ0KCQkJb3duZXJbIHRoaXMuZXhwYW5kbyBdICYmIG93bmVyWyB0aGlzLmV4cGFuZG8gXVsgY2FtZWxDYXNlKCBrZXkgKSBdOw0KCX0sDQoJYWNjZXNzOiBmdW5jdGlvbiggb3duZXIsIGtleSwgdmFsdWUgKSB7DQoNCgkJLy8gSW4gY2FzZXMgd2hlcmUgZWl0aGVyOg0KCQkvLw0KCQkvLyAgIDEuIE5vIGtleSB3YXMgc3BlY2lmaWVkDQoJCS8vICAgMi4gQSBzdHJpbmcga2V5IHdhcyBzcGVjaWZpZWQsIGJ1dCBubyB2YWx1ZSBwcm92aWRlZA0KCQkvLw0KCQkvLyBUYWtlIHRoZSAicmVhZCIgcGF0aCBhbmQgYWxsb3cgdGhlIGdldCBtZXRob2QgdG8gZGV0ZXJtaW5lDQoJCS8vIHdoaWNoIHZhbHVlIHRvIHJldHVybiwgcmVzcGVjdGl2ZWx5IGVpdGhlcjoNCgkJLy8NCgkJLy8gICAxLiBUaGUgZW50aXJlIGNhY2hlIG9iamVjdA0KCQkvLyAgIDIuIFRoZSBkYXRhIHN0b3JlZCBhdCB0aGUga2V5DQoJCS8vDQoJCWlmICgga2V5ID09PSB1bmRlZmluZWQgfHwNCgkJCQkoICgga2V5ICYmIHR5cGVvZiBrZXkgPT09ICJzdHJpbmciICkgJiYgdmFsdWUgPT09IHVuZGVmaW5lZCApICkgew0KDQoJCQlyZXR1cm4gdGhpcy5nZXQoIG93bmVyLCBrZXkgKTsNCgkJfQ0KDQoJCS8vIFdoZW4gdGhlIGtleSBpcyBub3QgYSBzdHJpbmcsIG9yIGJvdGggYSBrZXkgYW5kIHZhbHVlDQoJCS8vIGFyZSBzcGVjaWZpZWQsIHNldCBvciBleHRlbmQgKGV4aXN0aW5nIG9iamVjdHMpIHdpdGggZWl0aGVyOg0KCQkvLw0KCQkvLyAgIDEuIEFuIG9iamVjdCBvZiBwcm9wZXJ0aWVzDQoJCS8vICAgMi4gQSBrZXkgYW5kIHZhbHVlDQoJCS8vDQoJCXRoaXMuc2V0KCBvd25lciwga2V5LCB2YWx1ZSApOw0KDQoJCS8vIFNpbmNlIHRoZSAic2V0IiBwYXRoIGNhbiBoYXZlIHR3byBwb3NzaWJsZSBlbnRyeSBwb2ludHMNCgkJLy8gcmV0dXJuIHRoZSBleHBlY3RlZCBkYXRhIGJhc2VkIG9uIHdoaWNoIHBhdGggd2FzIHRha2VuWypdDQoJCXJldHVybiB2YWx1ZSAhPT0gdW5kZWZpbmVkID8gdmFsdWUgOiBrZXk7DQoJfSwNCglyZW1vdmU6IGZ1bmN0aW9uKCBvd25lciwga2V5ICkgew0KCQl2YXIgaSwNCgkJCWNhY2hlID0gb3duZXJbIHRoaXMuZXhwYW5kbyBdOw0KDQoJCWlmICggY2FjaGUgPT09IHVuZGVmaW5lZCApIHsNCgkJCXJldHVybjsNCgkJfQ0KDQoJCWlmICgga2V5ICE9PSB1bmRlZmluZWQgKSB7DQoNCgkJCS8vIFN1cHBvcnQgYXJyYXkgb3Igc3BhY2Ugc2VwYXJhdGVkIHN0cmluZyBvZiBrZXlzDQoJCQlpZiAoIEFycmF5LmlzQXJyYXkoIGtleSApICkgew0KDQoJCQkJLy8gSWYga2V5IGlzIGFuIGFycmF5IG9mIGtleXMuLi4NCgkJCQkvLyBXZSBhbHdheXMgc2V0IGNhbWVsQ2FzZSBrZXlzLCBzbyByZW1vdmUgdGhhdC4NCgkJCQlrZXkgPSBrZXkubWFwKCBjYW1lbENhc2UgKTsNCgkJCX0gZWxzZSB7DQoJCQkJa2V5ID0gY2FtZWxDYXNlKCBrZXkgKTsNCg0KCQkJCS8vIElmIGEga2V5IHdpdGggdGhlIHNwYWNlcyBleGlzdHMsIHVzZSBpdC4NCgkJCQkvLyBPdGhlcndpc2UsIGNyZWF0ZSBhbiBhcnJheSBieSBtYXRjaGluZyBub24td2hpdGVzcGFjZQ0KCQkJCWtleSA9IGtleSBpbiBjYWNoZSA/DQoJCQkJCVsga2V5IF0gOg0KCQkJCQkoIGtleS5tYXRjaCggcm5vdGh0bWx3aGl0ZSApIHx8IFtdICk7DQoJCQl9DQoNCgkJCWkgPSBrZXkubGVuZ3RoOw0KDQoJCQl3aGlsZSAoIGktLSApIHsNCgkJCQlkZWxldGUgY2FjaGVbIGtleVsgaSBdIF07DQoJCQl9DQoJCX0NCg0KCQkvLyBSZW1vdmUgdGhlIGV4cGFuZG8gaWYgdGhlcmUncyBubyBtb3JlIGRhdGENCgkJaWYgKCBrZXkgPT09IHVuZGVmaW5lZCB8fCBqUXVlcnkuaXNFbXB0eU9iamVjdCggY2FjaGUgKSApIHsNCg0KCQkJLy8gU3VwcG9ydDogQ2hyb21lIDw9MzUgLSA0NQ0KCQkJLy8gV2Via2l0ICYgQmxpbmsgcGVyZm9ybWFuY2Ugc3VmZmVycyB3aGVuIGRlbGV0aW5nIHByb3BlcnRpZXMNCgkJCS8vIGZyb20gRE9NIG5vZGVzLCBzbyBzZXQgdG8gdW5kZWZpbmVkIGluc3RlYWQNCgkJCS8vIGh0dHBzOi8vYnVncy5jaHJvbWl1bS5vcmcvcC9jaHJvbWl1bS9pc3N1ZXMvZGV0YWlsP2lkPTM3ODYwNyAoYnVnIHJlc3RyaWN0ZWQpDQoJCQlpZiAoIG93bmVyLm5vZGVUeXBlICkgew0KCQkJCW93bmVyWyB0aGlzLmV4cGFuZG8gXSA9IHVuZGVmaW5lZDsNCgkJCX0gZWxzZSB7DQoJCQkJZGVsZXRlIG93bmVyWyB0aGlzLmV4cGFuZG8gXTsNCgkJCX0NCgkJfQ0KCX0sDQoJaGFzRGF0YTogZnVuY3Rpb24oIG93bmVyICkgew0KCQl2YXIgY2FjaGUgPSBvd25lclsgdGhpcy5leHBhbmRvIF07DQoJCXJldHVybiBjYWNoZSAhPT0gdW5kZWZpbmVkICYmICFqUXVlcnkuaXNFbXB0eU9iamVjdCggY2FjaGUgKTsNCgl9DQp9Ow0KdmFyIGRhdGFQcml2ID0gbmV3IERhdGEoKTsNCg0KdmFyIGRhdGFVc2VyID0gbmV3IERhdGEoKTsNCg0KDQoNCi8vCUltcGxlbWVudGF0aW9uIFN1bW1hcnkNCi8vDQovLwkxLiBFbmZvcmNlIEFQSSBzdXJmYWNlIGFuZCBzZW1hbnRpYyBjb21wYXRpYmlsaXR5IHdpdGggMS45LnggYnJhbmNoDQovLwkyLiBJbXByb3ZlIHRoZSBtb2R1bGUncyBtYWludGFpbmFiaWxpdHkgYnkgcmVkdWNpbmcgdGhlIHN0b3JhZ2UNCi8vCQlwYXRocyB0byBhIHNpbmdsZSBtZWNoYW5pc20uDQovLwkzLiBVc2UgdGhlIHNhbWUgc2luZ2xlIG1lY2hhbmlzbSB0byBzdXBwb3J0ICJwcml2YXRlIiBhbmQgInVzZXIiIGRhdGEuDQovLwk0LiBfTmV2ZXJfIGV4cG9zZSAicHJpdmF0ZSIgZGF0YSB0byB1c2VyIGNvZGUgKFRPRE86IERyb3AgX2RhdGEsIF9yZW1vdmVEYXRhKQ0KLy8JNS4gQXZvaWQgZXhwb3NpbmcgaW1wbGVtZW50YXRpb24gZGV0YWlscyBvbiB1c2VyIG9iamVjdHMgKGVnLiBleHBhbmRvIHByb3BlcnRpZXMpDQovLwk2LiBQcm92aWRlIGEgY2xlYXIgcGF0aCBmb3IgaW1wbGVtZW50YXRpb24gdXBncmFkZSB0byBXZWFrTWFwIGluIDIwMTQNCg0KdmFyIHJicmFjZSA9IC9eKD86XHtbXHdcV10qXH18XFtbXHdcV10qXF0pJC8sDQoJcm11bHRpRGFzaCA9IC9bQS1aXS9nOw0KDQpmdW5jdGlvbiBnZXREYXRhKCBkYXRhICkgew0KCWlmICggZGF0YSA9PT0gInRydWUiICkgew0KCQlyZXR1cm4gdHJ1ZTsNCgl9DQoNCglpZiAoIGRhdGEgPT09ICJmYWxzZSIgKSB7DQoJCXJldHVybiBmYWxzZTsNCgl9DQoNCglpZiAoIGRhdGEgPT09ICJudWxsIiApIHsNCgkJcmV0dXJuIG51bGw7DQoJfQ0KDQoJLy8gT25seSBjb252ZXJ0IHRvIGEgbnVtYmVyIGlmIGl0IGRvZXNuJ3QgY2hhbmdlIHRoZSBzdHJpbmcNCglpZiAoIGRhdGEgPT09ICtkYXRhICsgIiIgKSB7DQoJCXJldHVybiArZGF0YTsNCgl9DQoNCglpZiAoIHJicmFjZS50ZXN0KCBkYXRhICkgKSB7DQoJCXJldHVybiBKU09OLnBhcnNlKCBkYXRhICk7DQoJfQ0KDQoJcmV0dXJuIGRhdGE7DQp9DQoNCmZ1bmN0aW9uIGRhdGFBdHRyKCBlbGVtLCBrZXksIGRhdGEgKSB7DQoJdmFyIG5hbWU7DQoNCgkvLyBJZiBub3RoaW5nIHdhcyBmb3VuZCBpbnRlcm5hbGx5LCB0cnkgdG8gZmV0Y2ggYW55DQoJLy8gZGF0YSBmcm9tIHRoZSBIVE1MNSBkYXRhLSogYXR0cmlidXRlDQoJaWYgKCBkYXRhID09PSB1bmRlZmluZWQgJiYgZWxlbS5ub2RlVHlwZSA9PT0gMSApIHsNCgkJbmFtZSA9ICJkYXRhLSIgKyBrZXkucmVwbGFjZSggcm11bHRpRGFzaCwgIi0kJiIgKS50b0xvd2VyQ2FzZSgpOw0KCQlkYXRhID0gZWxlbS5nZXRBdHRyaWJ1dGUoIG5hbWUgKTsNCg0KCQlpZiAoIHR5cGVvZiBkYXRhID09PSAic3RyaW5nIiApIHsNCgkJCXRyeSB7DQoJCQkJZGF0YSA9IGdldERhdGEoIGRhdGEgKTsNCgkJCX0gY2F0Y2ggKCBlICkge30NCg0KCQkJLy8gTWFrZSBzdXJlIHdlIHNldCB0aGUgZGF0YSBzbyBpdCBpc24ndCBjaGFuZ2VkIGxhdGVyDQoJCQlkYXRhVXNlci5zZXQoIGVsZW0sIGtleSwgZGF0YSApOw0KCQl9IGVsc2Ugew0KCQkJZGF0YSA9IHVuZGVmaW5lZDsNCgkJfQ0KCX0NCglyZXR1cm4gZGF0YTsNCn0NCg0KalF1ZXJ5LmV4dGVuZCggew0KCWhhc0RhdGE6IGZ1bmN0aW9uKCBlbGVtICkgew0KCQlyZXR1cm4gZGF0YVVzZXIuaGFzRGF0YSggZWxlbSApIHx8IGRhdGFQcml2Lmhhc0RhdGEoIGVsZW0gKTsNCgl9LA0KDQoJZGF0YTogZnVuY3Rpb24oIGVsZW0sIG5hbWUsIGRhdGEgKSB7DQoJCXJldHVybiBkYXRhVXNlci5hY2Nlc3MoIGVsZW0sIG5hbWUsIGRhdGEgKTsNCgl9LA0KDQoJcmVtb3ZlRGF0YTogZnVuY3Rpb24oIGVsZW0sIG5hbWUgKSB7DQoJCWRhdGFVc2VyLnJlbW92ZSggZWxlbSwgbmFtZSApOw0KCX0sDQoNCgkvLyBUT0RPOiBOb3cgdGhhdCBhbGwgY2FsbHMgdG8gX2RhdGEgYW5kIF9yZW1vdmVEYXRhIGhhdmUgYmVlbiByZXBsYWNlZA0KCS8vIHdpdGggZGlyZWN0IGNhbGxzIHRvIGRhdGFQcml2IG1ldGhvZHMsIHRoZXNlIGNhbiBiZSBkZXByZWNhdGVkLg0KCV9kYXRhOiBmdW5jdGlvbiggZWxlbSwgbmFtZSwgZGF0YSApIHsNCgkJcmV0dXJuIGRhdGFQcml2LmFjY2VzcyggZWxlbSwgbmFtZSwgZGF0YSApOw0KCX0sDQoNCglfcmVtb3ZlRGF0YTogZnVuY3Rpb24oIGVsZW0sIG5hbWUgKSB7DQoJCWRhdGFQcml2LnJlbW92ZSggZWxlbSwgbmFtZSApOw0KCX0NCn0gKTsNCg0KalF1ZXJ5LmZuLmV4dGVuZCggew0KCWRhdGE6IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgew0KCQl2YXIgaSwgbmFtZSwgZGF0YSwNCgkJCWVsZW0gPSB0aGlzWyAwIF0sDQoJCQlhdHRycyA9IGVsZW0gJiYgZWxlbS5hdHRyaWJ1dGVzOw0KDQoJCS8vIEdldHMgYWxsIHZhbHVlcw0KCQlpZiAoIGtleSA9PT0gdW5kZWZpbmVkICkgew0KCQkJaWYgKCB0aGlzLmxlbmd0aCApIHsNCgkJCQlkYXRhID0gZGF0YVVzZXIuZ2V0KCBlbGVtICk7DQoNCgkJCQlpZiAoIGVsZW0ubm9kZVR5cGUgPT09IDEgJiYgIWRhdGFQcml2LmdldCggZWxlbSwgImhhc0RhdGFBdHRycyIgKSApIHsNCgkJCQkJaSA9IGF0dHJzLmxlbmd0aDsNCgkJCQkJd2hpbGUgKCBpLS0gKSB7DQoNCgkJCQkJCS8vIFN1cHBvcnQ6IElFIDExIG9ubHkNCgkJCQkJCS8vIFRoZSBhdHRycyBlbGVtZW50cyBjYW4gYmUgbnVsbCAoIzE0ODk0KQ0KCQkJCQkJaWYgKCBhdHRyc1sgaSBdICkgew0KCQkJCQkJCW5hbWUgPSBhdHRyc1sgaSBdLm5hbWU7DQoJCQkJCQkJaWYgKCBuYW1lLmluZGV4T2YoICJkYXRhLSIgKSA9PT0gMCApIHsNCgkJCQkJCQkJbmFtZSA9IGNhbWVsQ2FzZSggbmFtZS5zbGljZSggNSApICk7DQoJCQkJCQkJCWRhdGFBdHRyKCBlbGVtLCBuYW1lLCBkYXRhWyBuYW1lIF0gKTsNCgkJCQkJCQl9DQoJCQkJCQl9DQoJCQkJCX0NCgkJCQkJZGF0YVByaXYuc2V0KCBlbGVtLCAiaGFzRGF0YUF0dHJzIiwgdHJ1ZSApOw0KCQkJCX0NCgkJCX0NCg0KCQkJcmV0dXJuIGRhdGE7DQoJCX0NCg0KCQkvLyBTZXRzIG11bHRpcGxlIHZhbHVlcw0KCQlpZiAoIHR5cGVvZiBrZXkgPT09ICJvYmplY3QiICkgew0KCQkJcmV0dXJuIHRoaXMuZWFjaCggZnVuY3Rpb24oKSB7DQoJCQkJZGF0YVVzZXIuc2V0KCB0aGlzLCBrZXkgKTsNCgkJCX0gKTsNCgkJfQ0KDQoJCXJldHVybiBhY2Nlc3MoIHRoaXMsIGZ1bmN0aW9uKCB2YWx1ZSApIHsNCgkJCXZhciBkYXRhOw0KDQoJCQkvLyBUaGUgY2FsbGluZyBqUXVlcnkgb2JqZWN0IChlbGVtZW50IG1hdGNoZXMpIGlzIG5vdCBlbXB0eQ0KCQkJLy8gKGFuZCB0aGVyZWZvcmUgaGFzIGFuIGVsZW1lbnQgYXBwZWFycyBhdCB0aGlzWyAwIF0pIGFuZCB0aGUNCgkJCS8vIGB2YWx1ZWAgcGFyYW1ldGVyIHdhcyBub3QgdW5kZWZpbmVkLiBBbiBlbXB0eSBqUXVlcnkgb2JqZWN0DQoJCQkvLyB3aWxsIHJlc3VsdCBpbiBgdW5kZWZpbmVkYCBmb3IgZWxlbSA9IHRoaXNbIDAgXSB3aGljaCB3aWxsDQoJCQkvLyB0aHJvdyBhbiBleGNlcHRpb24gaWYgYW4gYXR0ZW1wdCB0byByZWFkIGEgZGF0YSBjYWNoZSBpcyBtYWRlLg0KCQkJaWYgKCBlbGVtICYmIHZhbHVlID09PSB1bmRlZmluZWQgKSB7DQoNCgkJCQkvLyBBdHRlbXB0IHRvIGdldCBkYXRhIGZyb20gdGhlIGNhY2hlDQoJCQkJLy8gVGhlIGtleSB3aWxsIGFsd2F5cyBiZSBjYW1lbENhc2VkIGluIERhdGENCgkJCQlkYXRhID0gZGF0YVVzZXIuZ2V0KCBlbGVtLCBrZXkgKTsNCgkJCQlpZiAoIGRhdGEgIT09IHVuZGVmaW5lZCApIHsNCgkJCQkJcmV0dXJuIGRhdGE7DQoJCQkJfQ0KDQoJCQkJLy8gQXR0ZW1wdCB0byAiZGlzY292ZXIiIHRoZSBkYXRhIGluDQoJCQkJLy8gSFRNTDUgY3VzdG9tIGRhdGEtKiBhdHRycw0KCQkJCWRhdGEgPSBkYXRhQXR0ciggZWxlbSwga2V5ICk7DQoJCQkJaWYgKCBkYXRhICE9PSB1bmRlZmluZWQgKSB7DQoJCQkJCXJldHVybiBkYXRhOw0KCQkJCX0NCg0KCQkJCS8vIFdlIHRyaWVkIHJlYWxseSBoYXJkLCBidXQgdGhlIGRhdGEgZG9lc24ndCBleGlzdC4NCgkJCQlyZXR1cm47DQoJCQl9DQoNCgkJCS8vIFNldCB0aGUgZGF0YS4uLg0KCQkJdGhpcy5lYWNoKCBmdW5jdGlvbigpIHsNCg0KCQkJCS8vIFdlIGFsd2F5cyBzdG9yZSB0aGUgY2FtZWxDYXNlZCBrZXkNCgkJCQlkYXRhVXNlci5zZXQoIHRoaXMsIGtleSwgdmFsdWUgKTsNCgkJCX0gKTsNCgkJfSwgbnVsbCwgdmFsdWUsIGFyZ3VtZW50cy5sZW5ndGggPiAxLCBudWxsLCB0cnVlICk7DQoJfSwNCg0KCXJlbW92ZURhdGE6IGZ1bmN0aW9uKCBrZXkgKSB7DQoJCXJldHVybiB0aGlzLmVhY2goIGZ1bmN0aW9uKCkgew0KCQkJZGF0YVVzZXIucmVtb3ZlKCB0aGlzLCBrZXkgKTsNCgkJfSApOw0KCX0NCn0gKTsNCg0KDQpqUXVlcnkuZXh0ZW5kKCB7DQoJcXVldWU6IGZ1bmN0aW9uKCBlbGVtLCB0eXBlLCBkYXRhICkgew0KCQl2YXIgcXVldWU7DQoNCgkJaWYgKCBlbGVtICkgew0KCQkJdHlwZSA9ICggdHlwZSB8fCAiZngiICkgKyAicXVldWUiOw0KCQkJcXVldWUgPSBkYXRhUHJpdi5nZXQoIGVsZW0sIHR5cGUgKTsNCg0KCQkJLy8gU3BlZWQgdXAgZGVxdWV1ZSBieSBnZXR0aW5nIG91dCBxdWlja2x5IGlmIHRoaXMgaXMganVzdCBhIGxvb2t1cA0KCQkJaWYgKCBkYXRhICkgew0KCQkJCWlmICggIXF1ZXVlIHx8IEFycmF5LmlzQXJyYXkoIGRhdGEgKSApIHsNCgkJCQkJcXVldWUgPSBkYXRhUHJpdi5hY2Nlc3MoIGVsZW0sIHR5cGUsIGpRdWVyeS5tYWtlQXJyYXkoIGRhdGEgKSApOw0KCQkJCX0gZWxzZSB7DQoJCQkJCXF1ZXVlLnB1c2goIGRhdGEgKTsNCgkJCQl9DQoJCQl9DQoJCQlyZXR1cm4gcXVldWUgfHwgW107DQoJCX0NCgl9LA0KDQoJZGVxdWV1ZTogZnVuY3Rpb24oIGVsZW0sIHR5cGUgKSB7DQoJCXR5cGUgPSB0eXBlIHx8ICJmeCI7DQoNCgkJdmFyIHF1ZXVlID0galF1ZXJ5LnF1ZXVlKCBlbGVtLCB0eXBlICksDQoJCQlzdGFydExlbmd0aCA9IHF1ZXVlLmxlbmd0aCwNCgkJCWZuID0gcXVldWUuc2hpZnQoKSwNCgkJCWhvb2tzID0galF1ZXJ5Ll9xdWV1ZUhvb2tzKCBlbGVtLCB0eXBlICksDQoJCQluZXh0ID0gZnVuY3Rpb24oKSB7DQoJCQkJalF1ZXJ5LmRlcXVldWUoIGVsZW0sIHR5cGUgKTsNCgkJCX07DQoNCgkJLy8gSWYgdGhlIGZ4IHF1ZXVlIGlzIGRlcXVldWVkLCBhbHdheXMgcmVtb3ZlIHRoZSBwcm9ncmVzcyBzZW50aW5lbA0KCQlpZiAoIGZuID09PSAiaW5wcm9ncmVzcyIgKSB7DQoJCQlmbiA9IHF1ZXVlLnNoaWZ0KCk7DQoJCQlzdGFydExlbmd0aC0tOw0KCQl9DQoNCgkJaWYgKCBmbiApIHsNCg0KCQkJLy8gQWRkIGEgcHJvZ3Jlc3Mgc2VudGluZWwgdG8gcHJldmVudCB0aGUgZnggcXVldWUgZnJvbSBiZWluZw0KCQkJLy8gYXV0b21hdGljYWxseSBkZXF1ZXVlZA0KCQkJaWYgKCB0eXBlID09PSAiZngiICkgew0KCQkJCXF1ZXVlLnVuc2hpZnQoICJpbnByb2dyZXNzIiApOw0KCQkJfQ0KDQoJCQkvLyBDbGVhciB1cCB0aGUgbGFzdCBxdWV1ZSBzdG9wIGZ1bmN0aW9uDQoJCQlkZWxldGUgaG9va3Muc3RvcDsNCgkJCWZuLmNhbGwoIGVsZW0sIG5leHQsIGhvb2tzICk7DQoJCX0NCg0KCQlpZiAoICFzdGFydExlbmd0aCAmJiBob29rcyApIHsNCgkJCWhvb2tzLmVtcHR5LmZpcmUoKTsNCgkJfQ0KCX0sDQoNCgkvLyBOb3QgcHVibGljIC0gZ2VuZXJhdGUgYSBxdWV1ZUhvb2tzIG9iamVjdCwgb3IgcmV0dXJuIHRoZSBjdXJyZW50IG9uZQ0KCV9xdWV1ZUhvb2tzOiBmdW5jdGlvbiggZWxlbSwgdHlwZSApIHsNCgkJdmFyIGtleSA9IHR5cGUgKyAicXVldWVIb29rcyI7DQoJCXJldHVybiBkYXRhUHJpdi5nZXQoIGVsZW0sIGtleSApIHx8IGRhdGFQcml2LmFjY2VzcyggZWxlbSwga2V5LCB7DQoJCQllbXB0eTogalF1ZXJ5LkNhbGxiYWNrcyggIm9uY2UgbWVtb3J5IiApLmFkZCggZnVuY3Rpb24oKSB7DQoJCQkJZGF0YVByaXYucmVtb3ZlKCBlbGVtLCBbIHR5cGUgKyAicXVldWUiLCBrZXkgXSApOw0KCQkJfSApDQoJCX0gKTsNCgl9DQp9ICk7DQoNCmpRdWVyeS5mbi5leHRlbmQoIHsNCglxdWV1ZTogZnVuY3Rpb24oIHR5cGUsIGRhdGEgKSB7DQoJCXZhciBzZXR0ZXIgPSAyOw0KDQoJCWlmICggdHlwZW9mIHR5cGUgIT09ICJzdHJpbmciICkgew0KCQkJZGF0YSA9IHR5cGU7DQoJCQl0eXBlID0gImZ4IjsNCgkJCXNldHRlci0tOw0KCQl9DQoNCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoIDwgc2V0dGVyICkgew0KCQkJcmV0dXJuIGpRdWVyeS5xdWV1ZSggdGhpc1sgMCBdLCB0eXBlICk7DQoJCX0NCg0KCQlyZXR1cm4gZGF0YSA9PT0gdW5kZWZpbmVkID8NCgkJCXRoaXMgOg0KCQkJdGhpcy5lYWNoKCBmdW5jdGlvbigpIHsNCgkJCQl2YXIgcXVldWUgPSBqUXVlcnkucXVldWUoIHRoaXMsIHR5cGUsIGRhdGEgKTsNCg0KCQkJCS8vIEVuc3VyZSBhIGhvb2tzIGZvciB0aGlzIHF1ZXVlDQoJCQkJalF1ZXJ5Ll9xdWV1ZUhvb2tzKCB0aGlzLCB0eXBlICk7DQoNCgkJCQlpZiAoIHR5cGUgPT09ICJmeCIgJiYgcXVldWVbIDAgXSAhPT0gImlucHJvZ3Jlc3MiICkgew0KCQkJCQlqUXVlcnkuZGVxdWV1ZSggdGhpcywgdHlwZSApOw0KCQkJCX0NCgkJCX0gKTsNCgl9LA0KCWRlcXVldWU6IGZ1bmN0aW9uKCB0eXBlICkgew0KCQlyZXR1cm4gdGhpcy5lYWNoKCBmdW5jdGlvbigpIHsNCgkJCWpRdWVyeS5kZXF1ZXVlKCB0aGlzLCB0eXBlICk7DQoJCX0gKTsNCgl9LA0KCWNsZWFyUXVldWU6IGZ1bmN0aW9uKCB0eXBlICkgew0KCQlyZXR1cm4gdGhpcy5xdWV1ZSggdHlwZSB8fCAiZngiLCBbXSApOw0KCX0sDQoNCgkvLyBHZXQgYSBwcm9taXNlIHJlc29sdmVkIHdoZW4gcXVldWVzIG9mIGEgY2VydGFpbiB0eXBlDQoJLy8gYXJlIGVtcHRpZWQgKGZ4IGlzIHRoZSB0eXBlIGJ5IGRlZmF1bHQpDQoJcHJvbWlzZTogZnVuY3Rpb24oIHR5cGUsIG9iaiApIHsNCgkJdmFyIHRtcCwNCgkJCWNvdW50ID0gMSwNCgkJCWRlZmVyID0galF1ZXJ5LkRlZmVycmVkKCksDQoJCQllbGVtZW50cyA9IHRoaXMsDQoJCQlpID0gdGhpcy5sZW5ndGgsDQoJCQlyZXNvbHZlID0gZnVuY3Rpb24oKSB7DQoJCQkJaWYgKCAhKCAtLWNvdW50ICkgKSB7DQoJCQkJCWRlZmVyLnJlc29sdmVXaXRoKCBlbGVtZW50cywgWyBlbGVtZW50cyBdICk7DQoJCQkJfQ0KCQkJfTsNCg0KCQlpZiAoIHR5cGVvZiB0eXBlICE9PSAic3RyaW5nIiApIHsNCgkJCW9iaiA9IHR5cGU7DQoJCQl0eXBlID0gdW5kZWZpbmVkOw0KCQl9DQoJCXR5cGUgPSB0eXBlIHx8ICJmeCI7DQoNCgkJd2hpbGUgKCBpLS0gKSB7DQoJCQl0bXAgPSBkYXRhUHJpdi5nZXQoIGVsZW1lbnRzWyBpIF0sIHR5cGUgKyAicXVldWVIb29rcyIgKTsNCgkJCWlmICggdG1wICYmIHRtcC5lbXB0eSApIHsNCgkJCQljb3VudCsrOw0KCQkJCXRtcC5lbXB0eS5hZGQoIHJlc29sdmUgKTsNCgkJCX0NCgkJfQ0KCQlyZXNvbHZlKCk7DQoJCXJldHVybiBkZWZlci5wcm9taXNlKCBvYmogKTsNCgl9DQp9ICk7DQp2YXIgcG51bSA9ICggL1srLV0/KD86XGQqXC58KVxkKyg/OltlRV1bKy1dP1xkK3wpLyApLnNvdXJjZTsNCg0KdmFyIHJjc3NOdW0gPSBuZXcgUmVnRXhwKCAiXig/OihbKy1dKT18KSgiICsgcG51bSArICIpKFthLXolXSopJCIsICJpIiApOw0KDQoNCnZhciBjc3NFeHBhbmQgPSBbICJUb3AiLCAiUmlnaHQiLCAiQm90dG9tIiwgIkxlZnQiIF07DQoNCnZhciBkb2N1bWVudEVsZW1lbnQgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQ7DQoNCg0KDQoJdmFyIGlzQXR0YWNoZWQgPSBmdW5jdGlvbiggZWxlbSApIHsNCgkJCXJldHVybiBqUXVlcnkuY29udGFpbnMoIGVsZW0ub3duZXJEb2N1bWVudCwgZWxlbSApOw0KCQl9LA0KCQljb21wb3NlZCA9IHsgY29tcG9zZWQ6IHRydWUgfTsNCg0KCS8vIFN1cHBvcnQ6IElFIDkgLSAxMSssIEVkZ2UgMTIgLSAxOCssIGlPUyAxMC4wIC0gMTAuMiBvbmx5DQoJLy8gQ2hlY2sgYXR0YWNobWVudCBhY3Jvc3Mgc2hhZG93IERPTSBib3VuZGFyaWVzIHdoZW4gcG9zc2libGUgKGdoLTM1MDQpDQoJLy8gU3VwcG9ydDogaU9TIDEwLjAtMTAuMiBvbmx5DQoJLy8gRWFybHkgaU9TIDEwIHZlcnNpb25zIHN1cHBvcnQgYGF0dGFjaFNoYWRvd2AgYnV0IG5vdCBgZ2V0Um9vdE5vZGVgLA0KCS8vIGxlYWRpbmcgdG8gZXJyb3JzLiBXZSBuZWVkIHRvIGNoZWNrIGZvciBgZ2V0Um9vdE5vZGVgLg0KCWlmICggZG9jdW1lbnRFbGVtZW50LmdldFJvb3ROb2RlICkgew0KCQlpc0F0dGFjaGVkID0gZnVuY3Rpb24oIGVsZW0gKSB7DQoJCQlyZXR1cm4galF1ZXJ5LmNvbnRhaW5zKCBlbGVtLm93bmVyRG9jdW1lbnQsIGVsZW0gKSB8fA0KCQkJCWVsZW0uZ2V0Um9vdE5vZGUoIGNvbXBvc2VkICkgPT09IGVsZW0ub3duZXJEb2N1bWVudDsNCgkJfTsNCgl9DQp2YXIgaXNIaWRkZW5XaXRoaW5UcmVlID0gZnVuY3Rpb24oIGVsZW0sIGVsICkgew0KDQoJCS8vIGlzSGlkZGVuV2l0aGluVHJlZSBtaWdodCBiZSBjYWxsZWQgZnJvbSBqUXVlcnkjZmlsdGVyIGZ1bmN0aW9uOw0KCQkvLyBpbiB0aGF0IGNhc2UsIGVsZW1lbnQgd2lsbCBiZSBzZWNvbmQgYXJndW1lbnQNCgkJZWxlbSA9IGVsIHx8IGVsZW07DQoNCgkJLy8gSW5saW5lIHN0eWxlIHRydW1wcyBhbGwNCgkJcmV0dXJuIGVsZW0uc3R5bGUuZGlzcGxheSA9PT0gIm5vbmUiIHx8DQoJCQllbGVtLnN0eWxlLmRpc3BsYXkgPT09ICIiICYmDQoNCgkJCS8vIE90aGVyd2lzZSwgY2hlY2sgY29tcHV0ZWQgc3R5bGUNCgkJCS8vIFN1cHBvcnQ6IEZpcmVmb3ggPD00MyAtIDQ1DQoJCQkvLyBEaXNjb25uZWN0ZWQgZWxlbWVudHMgY2FuIGhhdmUgY29tcHV0ZWQgZGlzcGxheTogbm9uZSwgc28gZmlyc3QgY29uZmlybSB0aGF0IGVsZW0gaXMNCgkJCS8vIGluIHRoZSBkb2N1bWVudC4NCgkJCWlzQXR0YWNoZWQoIGVsZW0gKSAmJg0KDQoJCQlqUXVlcnkuY3NzKCBlbGVtLCAiZGlzcGxheSIgKSA9PT0gIm5vbmUiOw0KCX07DQoNCg0KDQpmdW5jdGlvbiBhZGp1c3RDU1MoIGVsZW0sIHByb3AsIHZhbHVlUGFydHMsIHR3ZWVuICkgew0KCXZhciBhZGp1c3RlZCwgc2NhbGUsDQoJCW1heEl0ZXJhdGlvbnMgPSAyMCwNCgkJY3VycmVudFZhbHVlID0gdHdlZW4gPw0KCQkJZnVuY3Rpb24oKSB7DQoJCQkJcmV0dXJuIHR3ZWVuLmN1cigpOw0KCQkJfSA6DQoJCQlmdW5jdGlvbigpIHsNCgkJCQlyZXR1cm4galF1ZXJ5LmNzcyggZWxlbSwgcHJvcCwgIiIgKTsNCgkJCX0sDQoJCWluaXRpYWwgPSBjdXJyZW50VmFsdWUoKSwNCgkJdW5pdCA9IHZhbHVlUGFydHMgJiYgdmFsdWVQYXJ0c1sgMyBdIHx8ICggalF1ZXJ5LmNzc051bWJlclsgcHJvcCBdID8gIiIgOiAicHgiICksDQoNCgkJLy8gU3RhcnRpbmcgdmFsdWUgY29tcHV0YXRpb24gaXMgcmVxdWlyZWQgZm9yIHBvdGVudGlhbCB1bml0IG1pc21hdGNoZXMNCgkJaW5pdGlhbEluVW5pdCA9IGVsZW0ubm9kZVR5cGUgJiYNCgkJCSggalF1ZXJ5LmNzc051bWJlclsgcHJvcCBdIHx8IHVuaXQgIT09ICJweCIgJiYgK2luaXRpYWwgKSAmJg0KCQkJcmNzc051bS5leGVjKCBqUXVlcnkuY3NzKCBlbGVtLCBwcm9wICkgKTsNCg0KCWlmICggaW5pdGlhbEluVW5pdCAmJiBpbml0aWFsSW5Vbml0WyAzIF0gIT09IHVuaXQgKSB7DQoNCgkJLy8gU3VwcG9ydDogRmlyZWZveCA8PTU0DQoJCS8vIEhhbHZlIHRoZSBpdGVyYXRpb24gdGFyZ2V0IHZhbHVlIHRvIHByZXZlbnQgaW50ZXJmZXJlbmNlIGZyb20gQ1NTIHVwcGVyIGJvdW5kcyAoZ2gtMjE0NCkNCgkJaW5pdGlhbCA9IGluaXRpYWwgLyAyOw0KDQoJCS8vIFRydXN0IHVuaXRzIHJlcG9ydGVkIGJ5IGpRdWVyeS5jc3MNCgkJdW5pdCA9IHVuaXQgfHwgaW5pdGlhbEluVW5pdFsgMyBdOw0KDQoJCS8vIEl0ZXJhdGl2ZWx5IGFwcHJveGltYXRlIGZyb20gYSBub256ZXJvIHN0YXJ0aW5nIHBvaW50DQoJCWluaXRpYWxJblVuaXQgPSAraW5pdGlhbCB8fCAxOw0KDQoJCXdoaWxlICggbWF4SXRlcmF0aW9ucy0tICkgew0KDQoJCQkvLyBFdmFsdWF0ZSBhbmQgdXBkYXRlIG91ciBiZXN0IGd1ZXNzIChkb3VibGluZyBndWVzc2VzIHRoYXQgemVybyBvdXQpLg0KCQkJLy8gRmluaXNoIGlmIHRoZSBzY2FsZSBlcXVhbHMgb3IgY3Jvc3NlcyAxIChtYWtpbmcgdGhlIG9sZCpuZXcgcHJvZHVjdCBub24tcG9zaXRpdmUpLg0KCQkJalF1ZXJ5LnN0eWxlKCBlbGVtLCBwcm9wLCBpbml0aWFsSW5Vbml0ICsgdW5pdCApOw0KCQkJaWYgKCAoIDEgLSBzY2FsZSApICogKCAxIC0gKCBzY2FsZSA9IGN1cnJlbnRWYWx1ZSgpIC8gaW5pdGlhbCB8fCAwLjUgKSApIDw9IDAgKSB7DQoJCQkJbWF4SXRlcmF0aW9ucyA9IDA7DQoJCQl9DQoJCQlpbml0aWFsSW5Vbml0ID0gaW5pdGlhbEluVW5pdCAvIHNjYWxlOw0KDQoJCX0NCg0KCQlpbml0aWFsSW5Vbml0ID0gaW5pdGlhbEluVW5pdCAqIDI7DQoJCWpRdWVyeS5zdHlsZSggZWxlbSwgcHJvcCwgaW5pdGlhbEluVW5pdCArIHVuaXQgKTsNCg0KCQkvLyBNYWtlIHN1cmUgd2UgdXBkYXRlIHRoZSB0d2VlbiBwcm9wZXJ0aWVzIGxhdGVyIG9uDQoJCXZhbHVlUGFydHMgPSB2YWx1ZVBhcnRzIHx8IFtdOw0KCX0NCg0KCWlmICggdmFsdWVQYXJ0cyApIHsNCgkJaW5pdGlhbEluVW5pdCA9ICtpbml0aWFsSW5Vbml0IHx8ICtpbml0aWFsIHx8IDA7DQoNCgkJLy8gQXBwbHkgcmVsYXRpdmUgb2Zmc2V0ICgrPS8tPSkgaWYgc3BlY2lmaWVkDQoJCWFkanVzdGVkID0gdmFsdWVQYXJ0c1sgMSBdID8NCgkJCWluaXRpYWxJblVuaXQgKyAoIHZhbHVlUGFydHNbIDEgXSArIDEgKSAqIHZhbHVlUGFydHNbIDIgXSA6DQoJCQkrdmFsdWVQYXJ0c1sgMiBdOw0KCQlpZiAoIHR3ZWVuICkgew0KCQkJdHdlZW4udW5pdCA9IHVuaXQ7DQoJCQl0d2Vlbi5zdGFydCA9IGluaXRpYWxJblVuaXQ7DQoJCQl0d2Vlbi5lbmQgPSBhZGp1c3RlZDsNCgkJfQ0KCX0NCglyZXR1cm4gYWRqdXN0ZWQ7DQp9DQoNCg0KdmFyIGRlZmF1bHREaXNwbGF5TWFwID0ge307DQoNCmZ1bmN0aW9uIGdldERlZmF1bHREaXNwbGF5KCBlbGVtICkgew0KCXZhciB0ZW1wLA0KCQlkb2MgPSBlbGVtLm93bmVyRG9jdW1lbnQsDQoJCW5vZGVOYW1lID0gZWxlbS5ub2RlTmFtZSwNCgkJZGlzcGxheSA9IGRlZmF1bHREaXNwbGF5TWFwWyBub2RlTmFtZSBdOw0KDQoJaWYgKCBkaXNwbGF5ICkgew0KCQlyZXR1cm4gZGlzcGxheTsNCgl9DQoNCgl0ZW1wID0gZG9jLmJvZHkuYXBwZW5kQ2hpbGQoIGRvYy5jcmVhdGVFbGVtZW50KCBub2RlTmFtZSApICk7DQoJZGlzcGxheSA9IGpRdWVyeS5jc3MoIHRlbXAsICJkaXNwbGF5IiApOw0KDQoJdGVtcC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKCB0ZW1wICk7DQoNCglpZiAoIGRpc3BsYXkgPT09ICJub25lIiApIHsNCgkJZGlzcGxheSA9ICJibG9jayI7DQoJfQ0KCWRlZmF1bHREaXNwbGF5TWFwWyBub2RlTmFtZSBdID0gZGlzcGxheTsNCg0KCXJldHVybiBkaXNwbGF5Ow0KfQ0KDQpmdW5jdGlvbiBzaG93SGlkZSggZWxlbWVudHMsIHNob3cgKSB7DQoJdmFyIGRpc3BsYXksIGVsZW0sDQoJCXZhbHVlcyA9IFtdLA0KCQlpbmRleCA9IDAsDQoJCWxlbmd0aCA9IGVsZW1lbnRzLmxlbmd0aDsNCg0KCS8vIERldGVybWluZSBuZXcgZGlzcGxheSB2YWx1ZSBmb3IgZWxlbWVudHMgdGhhdCBuZWVkIHRvIGNoYW5nZQ0KCWZvciAoIDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KysgKSB7DQoJCWVsZW0gPSBlbGVtZW50c1sgaW5kZXggXTsNCgkJaWYgKCAhZWxlbS5zdHlsZSApIHsNCgkJCWNvbnRpbnVlOw0KCQl9DQoNCgkJZGlzcGxheSA9IGVsZW0uc3R5bGUuZGlzcGxheTsNCgkJaWYgKCBzaG93ICkgew0KDQoJCQkvLyBTaW5jZSB3ZSBmb3JjZSB2aXNpYmlsaXR5IHVwb24gY2FzY2FkZS1oaWRkZW4gZWxlbWVudHMsIGFuIGltbWVkaWF0ZSAoYW5kIHNsb3cpDQoJCQkvLyBjaGVjayBpcyByZXF1aXJlZCBpbiB0aGlzIGZpcnN0IGxvb3AgdW5sZXNzIHdlIGhhdmUgYSBub25lbXB0eSBkaXNwbGF5IHZhbHVlIChlaXRoZXINCgkJCS8vIGlubGluZSBvciBhYm91dC10by1iZS1yZXN0b3JlZCkNCgkJCWlmICggZGlzcGxheSA9PT0gIm5vbmUiICkgew0KCQkJCXZhbHVlc1sgaW5kZXggXSA9IGRhdGFQcml2LmdldCggZWxlbSwgImRpc3BsYXkiICkgfHwgbnVsbDsNCgkJCQlpZiAoICF2YWx1ZXNbIGluZGV4IF0gKSB7DQoJCQkJCWVsZW0uc3R5bGUuZGlzcGxheSA9ICIiOw0KCQkJCX0NCgkJCX0NCgkJCWlmICggZWxlbS5zdHlsZS5kaXNwbGF5ID09PSAiIiAmJiBpc0hpZGRlbldpdGhpblRyZWUoIGVsZW0gKSApIHsNCgkJCQl2YWx1ZXNbIGluZGV4IF0gPSBnZXREZWZhdWx0RGlzcGxheSggZWxlbSApOw0KCQkJfQ0KCQl9IGVsc2Ugew0KCQkJaWYgKCBkaXNwbGF5ICE9PSAibm9uZSIgKSB7DQoJCQkJdmFsdWVzWyBpbmRleCBdID0gIm5vbmUiOw0KDQoJCQkJLy8gUmVtZW1iZXIgd2hhdCB3ZSdyZSBvdmVyd3JpdGluZw0KCQkJCWRhdGFQcml2LnNldCggZWxlbSwgImRpc3BsYXkiLCBkaXNwbGF5ICk7DQoJCQl9DQoJCX0NCgl9DQoNCgkvLyBTZXQgdGhlIGRpc3BsYXkgb2YgdGhlIGVsZW1lbnRzIGluIGEgc2Vjb25kIGxvb3AgdG8gYXZvaWQgY29uc3RhbnQgcmVmbG93DQoJZm9yICggaW5kZXggPSAwOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKyApIHsNCgkJaWYgKCB2YWx1ZXNbIGluZGV4IF0gIT0gbnVsbCApIHsNCgkJCWVsZW1lbnRzWyBpbmRleCBdLnN0eWxlLmRpc3BsYXkgPSB2YWx1ZXNbIGluZGV4IF07DQoJCX0NCgl9DQoNCglyZXR1cm4gZWxlbWVudHM7DQp9DQoNCmpRdWVyeS5mbi5leHRlbmQoIHsNCglzaG93OiBmdW5jdGlvbigpIHsNCgkJcmV0dXJuIHNob3dIaWRlKCB0aGlzLCB0cnVlICk7DQoJfSwNCgloaWRlOiBmdW5jdGlvbigpIHsNCgkJcmV0dXJuIHNob3dIaWRlKCB0aGlzICk7DQoJfSwNCgl0b2dnbGU6IGZ1bmN0aW9uKCBzdGF0ZSApIHsNCgkJaWYgKCB0eXBlb2Ygc3RhdGUgPT09ICJib29sZWFuIiApIHsNCgkJCXJldHVybiBzdGF0ZSA/IHRoaXMuc2hvdygpIDogdGhpcy5oaWRlKCk7DQoJCX0NCg0KCQlyZXR1cm4gdGhpcy5lYWNoKCBmdW5jdGlvbigpIHsNCgkJCWlmICggaXNIaWRkZW5XaXRoaW5UcmVlKCB0aGlzICkgKSB7DQoJCQkJalF1ZXJ5KCB0aGlzICkuc2hvdygpOw0KCQkJfSBlbHNlIHsNCgkJCQlqUXVlcnkoIHRoaXMgKS5oaWRlKCk7DQoJCQl9DQoJCX0gKTsNCgl9DQp9ICk7DQp2YXIgcmNoZWNrYWJsZVR5cGUgPSAoIC9eKD86Y2hlY2tib3h8cmFkaW8pJC9pICk7DQoNCnZhciBydGFnTmFtZSA9ICggLzwoW2Etel1bXlwvXDA+XHgyMFx0XHJcblxmXSopL2kgKTsNCg0KdmFyIHJzY3JpcHRUeXBlID0gKCAvXiR8Xm1vZHVsZSR8XC8oPzpqYXZhfGVjbWEpc2NyaXB0L2kgKTsNCg0KDQoNCiggZnVuY3Rpb24oKSB7DQoJdmFyIGZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpLA0KCQlkaXYgPSBmcmFnbWVudC5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKSApLA0KCQlpbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJpbnB1dCIgKTsNCg0KCS8vIFN1cHBvcnQ6IEFuZHJvaWQgNC4wIC0gNC4zIG9ubHkNCgkvLyBDaGVjayBzdGF0ZSBsb3N0IGlmIHRoZSBuYW1lIGlzIHNldCAoIzExMjE3KQ0KCS8vIFN1cHBvcnQ6IFdpbmRvd3MgV2ViIEFwcHMgKFdXQSkNCgkvLyBgbmFtZWAgYW5kIGB0eXBlYCBtdXN0IHVzZSAuc2V0QXR0cmlidXRlIGZvciBXV0EgKCMxNDkwMSkNCglpbnB1dC5zZXRBdHRyaWJ1dGUoICJ0eXBlIiwgInJhZGlvIiApOw0KCWlucHV0LnNldEF0dHJpYnV0ZSggImNoZWNrZWQiLCAiY2hlY2tlZCIgKTsNCglpbnB1dC5zZXRBdHRyaWJ1dGUoICJuYW1lIiwgInQiICk7DQoNCglkaXYuYXBwZW5kQ2hpbGQoIGlucHV0ICk7DQoNCgkvLyBTdXBwb3J0OiBBbmRyb2lkIDw9NC4xIG9ubHkNCgkvLyBPbGRlciBXZWJLaXQgZG9lc24ndCBjbG9uZSBjaGVja2VkIHN0YXRlIGNvcnJlY3RseSBpbiBmcmFnbWVudHMNCglzdXBwb3J0LmNoZWNrQ2xvbmUgPSBkaXYuY2xvbmVOb2RlKCB0cnVlICkuY2xvbmVOb2RlKCB0cnVlICkubGFzdENoaWxkLmNoZWNrZWQ7DQoNCgkvLyBTdXBwb3J0OiBJRSA8PTExIG9ubHkNCgkvLyBNYWtlIHN1cmUgdGV4dGFyZWEgKGFuZCBjaGVja2JveCkgZGVmYXVsdFZhbHVlIGlzIHByb3Blcmx5IGNsb25lZA0KCWRpdi5pbm5lckhUTUwgPSAiPHRleHRhcmVhPng8L3RleHRhcmVhPiI7DQoJc3VwcG9ydC5ub0Nsb25lQ2hlY2tlZCA9ICEhZGl2LmNsb25lTm9kZSggdHJ1ZSApLmxhc3RDaGlsZC5kZWZhdWx0VmFsdWU7DQoNCgkvLyBTdXBwb3J0OiBJRSA8PTkgb25seQ0KCS8vIElFIDw9OSByZXBsYWNlcyA8b3B0aW9uPiB0YWdzIHdpdGggdGhlaXIgY29udGVudHMgd2hlbiBpbnNlcnRlZCBvdXRzaWRlIG9mDQoJLy8gdGhlIHNlbGVjdCBlbGVtZW50Lg0KCWRpdi5pbm5lckhUTUwgPSAiPG9wdGlvbj48L29wdGlvbj4iOw0KCXN1cHBvcnQub3B0aW9uID0gISFkaXYubGFzdENoaWxkOw0KfSApKCk7DQoNCg0KLy8gV2UgaGF2ZSB0byBjbG9zZSB0aGVzZSB0YWdzIHRvIHN1cHBvcnQgWEhUTUwgKCMxMzIwMCkNCnZhciB3cmFwTWFwID0gew0KDQoJLy8gWEhUTUwgcGFyc2VycyBkbyBub3QgbWFnaWNhbGx5IGluc2VydCBlbGVtZW50cyBpbiB0aGUNCgkvLyBzYW1lIHdheSB0aGF0IHRhZyBzb3VwIHBhcnNlcnMgZG8uIFNvIHdlIGNhbm5vdCBzaG9ydGVuDQoJLy8gdGhpcyBieSBvbWl0dGluZyA8dGJvZHk+IG9yIG90aGVyIHJlcXVpcmVkIGVsZW1lbnRzLg0KCXRoZWFkOiBbIDEsICI8dGFibGU+IiwgIjwvdGFibGU+IiBdLA0KCWNvbDogWyAyLCAiPHRhYmxlPjxjb2xncm91cD4iLCAiPC9jb2xncm91cD48L3RhYmxlPiIgXSwNCgl0cjogWyAyLCAiPHRhYmxlPjx0Ym9keT4iLCAiPC90Ym9keT48L3RhYmxlPiIgXSwNCgl0ZDogWyAzLCAiPHRhYmxlPjx0Ym9keT48dHI+IiwgIjwvdHI+PC90Ym9keT48L3RhYmxlPiIgXSwNCg0KCV9kZWZhdWx0OiBbIDAsICIiLCAiIiBdDQp9Ow0KDQp3cmFwTWFwLnRib2R5ID0gd3JhcE1hcC50Zm9vdCA9IHdyYXBNYXAuY29sZ3JvdXAgPSB3cmFwTWFwLmNhcHRpb24gPSB3cmFwTWFwLnRoZWFkOw0Kd3JhcE1hcC50aCA9IHdyYXBNYXAudGQ7DQoNCi8vIFN1cHBvcnQ6IElFIDw9OSBvbmx5DQppZiAoICFzdXBwb3J0Lm9wdGlvbiApIHsNCgl3cmFwTWFwLm9wdGdyb3VwID0gd3JhcE1hcC5vcHRpb24gPSBbIDEsICI8c2VsZWN0IG11bHRpcGxlPSdtdWx0aXBsZSc+IiwgIjwvc2VsZWN0PiIgXTsNCn0NCg0KDQpmdW5jdGlvbiBnZXRBbGwoIGNvbnRleHQsIHRhZyApIHsNCg0KCS8vIFN1cHBvcnQ6IElFIDw9OSAtIDExIG9ubHkNCgkvLyBVc2UgdHlwZW9mIHRvIGF2b2lkIHplcm8tYXJndW1lbnQgbWV0aG9kIGludm9jYXRpb24gb24gaG9zdCBvYmplY3RzICgjMTUxNTEpDQoJdmFyIHJldDsNCg0KCWlmICggdHlwZW9mIGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUgIT09ICJ1bmRlZmluZWQiICkgew0KCQlyZXQgPSBjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lKCB0YWcgfHwgIioiICk7DQoNCgl9IGVsc2UgaWYgKCB0eXBlb2YgY29udGV4dC5xdWVyeVNlbGVjdG9yQWxsICE9PSAidW5kZWZpbmVkIiApIHsNCgkJcmV0ID0gY29udGV4dC5xdWVyeVNlbGVjdG9yQWxsKCB0YWcgfHwgIioiICk7DQoNCgl9IGVsc2Ugew0KCQlyZXQgPSBbXTsNCgl9DQoNCglpZiAoIHRhZyA9PT0gdW5kZWZpbmVkIHx8IHRhZyAmJiBub2RlTmFtZSggY29udGV4dCwgdGFnICkgKSB7DQoJCXJldHVybiBqUXVlcnkubWVyZ2UoIFsgY29udGV4dCBdLCByZXQgKTsNCgl9DQoNCglyZXR1cm4gcmV0Ow0KfQ0KDQoNCi8vIE1hcmsgc2NyaXB0cyBhcyBoYXZpbmcgYWxyZWFkeSBiZWVuIGV2YWx1YXRlZA0KZnVuY3Rpb24gc2V0R2xvYmFsRXZhbCggZWxlbXMsIHJlZkVsZW1lbnRzICkgew0KCXZhciBpID0gMCwNCgkJbCA9IGVsZW1zLmxlbmd0aDsNCg0KCWZvciAoIDsgaSA8IGw7IGkrKyApIHsNCgkJZGF0YVByaXYuc2V0KA0KCQkJZWxlbXNbIGkgXSwNCgkJCSJnbG9iYWxFdmFsIiwNCgkJCSFyZWZFbGVtZW50cyB8fCBkYXRhUHJpdi5nZXQoIHJlZkVsZW1lbnRzWyBpIF0sICJnbG9iYWxFdmFsIiApDQoJCSk7DQoJfQ0KfQ0KDQoNCnZhciByaHRtbCA9IC88fCYjP1x3KzsvOw0KDQpmdW5jdGlvbiBidWlsZEZyYWdtZW50KCBlbGVtcywgY29udGV4dCwgc2NyaXB0cywgc2VsZWN0aW9uLCBpZ25vcmVkICkgew0KCXZhciBlbGVtLCB0bXAsIHRhZywgd3JhcCwgYXR0YWNoZWQsIGosDQoJCWZyYWdtZW50ID0gY29udGV4dC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCksDQoJCW5vZGVzID0gW10sDQoJCWkgPSAwLA0KCQlsID0gZWxlbXMubGVuZ3RoOw0KDQoJZm9yICggOyBpIDwgbDsgaSsrICkgew0KCQllbGVtID0gZWxlbXNbIGkgXTsNCg0KCQlpZiAoIGVsZW0gfHwgZWxlbSA9PT0gMCApIHsNCg0KCQkJLy8gQWRkIG5vZGVzIGRpcmVjdGx5DQoJCQlpZiAoIHRvVHlwZSggZWxlbSApID09PSAib2JqZWN0IiApIHsNCg0KCQkJCS8vIFN1cHBvcnQ6IEFuZHJvaWQgPD00LjAgb25seSwgUGhhbnRvbUpTIDEgb25seQ0KCQkJCS8vIHB1c2guYXBwbHkoXywgYXJyYXlsaWtlKSB0aHJvd3Mgb24gYW5jaWVudCBXZWJLaXQNCgkJCQlqUXVlcnkubWVyZ2UoIG5vZGVzLCBlbGVtLm5vZGVUeXBlID8gWyBlbGVtIF0gOiBlbGVtICk7DQoNCgkJCS8vIENvbnZlcnQgbm9uLWh0bWwgaW50byBhIHRleHQgbm9kZQ0KCQkJfSBlbHNlIGlmICggIXJodG1sLnRlc3QoIGVsZW0gKSApIHsNCgkJCQlub2Rlcy5wdXNoKCBjb250ZXh0LmNyZWF0ZVRleHROb2RlKCBlbGVtICkgKTsNCg0KCQkJLy8gQ29udmVydCBodG1sIGludG8gRE9NIG5vZGVzDQoJCQl9IGVsc2Ugew0KCQkJCXRtcCA9IHRtcCB8fCBmcmFnbWVudC5hcHBlbmRDaGlsZCggY29udGV4dC5jcmVhdGVFbGVtZW50KCAiZGl2IiApICk7DQoNCgkJCQkvLyBEZXNlcmlhbGl6ZSBhIHN0YW5kYXJkIHJlcHJlc2VudGF0aW9uDQoJCQkJdGFnID0gKCBydGFnTmFtZS5leGVjKCBlbGVtICkgfHwgWyAiIiwgIiIgXSApWyAxIF0udG9Mb3dlckNhc2UoKTsNCgkJCQl3cmFwID0gd3JhcE1hcFsgdGFnIF0gfHwgd3JhcE1hcC5fZGVmYXVsdDsNCgkJCQl0bXAuaW5uZXJIVE1MID0gd3JhcFsgMSBdICsgalF1ZXJ5Lmh0bWxQcmVmaWx0ZXIoIGVsZW0gKSArIHdyYXBbIDIgXTsNCg0KCQkJCS8vIERlc2NlbmQgdGhyb3VnaCB3cmFwcGVycyB0byB0aGUgcmlnaHQgY29udGVudA0KCQkJCWogPSB3cmFwWyAwIF07DQoJCQkJd2hpbGUgKCBqLS0gKSB7DQoJCQkJCXRtcCA9IHRtcC5sYXN0Q2hpbGQ7DQoJCQkJfQ0KDQoJCQkJLy8gU3VwcG9ydDogQW5kcm9pZCA8PTQuMCBvbmx5LCBQaGFudG9tSlMgMSBvbmx5DQoJCQkJLy8gcHVzaC5hcHBseShfLCBhcnJheWxpa2UpIHRocm93cyBvbiBhbmNpZW50IFdlYktpdA0KCQkJCWpRdWVyeS5tZXJnZSggbm9kZXMsIHRtcC5jaGlsZE5vZGVzICk7DQoNCgkJCQkvLyBSZW1lbWJlciB0aGUgdG9wLWxldmVsIGNvbnRhaW5lcg0KCQkJCXRtcCA9IGZyYWdtZW50LmZpcnN0Q2hpbGQ7DQoNCgkJCQkvLyBFbnN1cmUgdGhlIGNyZWF0ZWQgbm9kZXMgYXJlIG9ycGhhbmVkICgjMTIzOTIpDQoJCQkJdG1wLnRleHRDb250ZW50ID0gIiI7DQoJCQl9DQoJCX0NCgl9DQoNCgkvLyBSZW1vdmUgd3JhcHBlciBmcm9tIGZyYWdtZW50DQoJZnJhZ21lbnQudGV4dENvbnRlbnQgPSAiIjsNCg0KCWkgPSAwOw0KCXdoaWxlICggKCBlbGVtID0gbm9kZXNbIGkrKyBdICkgKSB7DQoNCgkJLy8gU2tpcCBlbGVtZW50cyBhbHJlYWR5IGluIHRoZSBjb250ZXh0IGNvbGxlY3Rpb24gKHRyYWMtNDA4NykNCgkJaWYgKCBzZWxlY3Rpb24gJiYgalF1ZXJ5LmluQXJyYXkoIGVsZW0sIHNlbGVjdGlvbiApID4gLTEgKSB7DQoJCQlpZiAoIGlnbm9yZWQgKSB7DQoJCQkJaWdub3JlZC5wdXNoKCBlbGVtICk7DQoJCQl9DQoJCQljb250aW51ZTsNCgkJfQ0KDQoJCWF0dGFjaGVkID0gaXNBdHRhY2hlZCggZWxlbSApOw0KDQoJCS8vIEFwcGVuZCB0byBmcmFnbWVudA0KCQl0bXAgPSBnZXRBbGwoIGZyYWdtZW50LmFwcGVuZENoaWxkKCBlbGVtICksICJzY3JpcHQiICk7DQoNCgkJLy8gUHJlc2VydmUgc2NyaXB0IGV2YWx1YXRpb24gaGlzdG9yeQ0KCQlpZiAoIGF0dGFjaGVkICkgew0KCQkJc2V0R2xvYmFsRXZhbCggdG1wICk7DQoJCX0NCg0KCQkvLyBDYXB0dXJlIGV4ZWN1dGFibGVzDQoJCWlmICggc2NyaXB0cyApIHsNCgkJCWogPSAwOw0KCQkJd2hpbGUgKCAoIGVsZW0gPSB0bXBbIGorKyBdICkgKSB7DQoJCQkJaWYgKCByc2NyaXB0VHlwZS50ZXN0KCBlbGVtLnR5cGUgfHwgIiIgKSApIHsNCgkJCQkJc2NyaXB0cy5wdXNoKCBlbGVtICk7DQoJCQkJfQ0KCQkJfQ0KCQl9DQoJfQ0KDQoJcmV0dXJuIGZyYWdtZW50Ow0KfQ0KDQoNCnZhciBydHlwZW5hbWVzcGFjZSA9IC9eKFteLl0qKSg/OlwuKC4rKXwpLzsNCg0KZnVuY3Rpb24gcmV0dXJuVHJ1ZSgpIHsNCglyZXR1cm4gdHJ1ZTsNCn0NCg0KZnVuY3Rpb24gcmV0dXJuRmFsc2UoKSB7DQoJcmV0dXJuIGZhbHNlOw0KfQ0KDQovLyBTdXBwb3J0OiBJRSA8PTkgLSAxMSsNCi8vIGZvY3VzKCkgYW5kIGJsdXIoKSBhcmUgYXN5bmNocm9ub3VzLCBleGNlcHQgd2hlbiB0aGV5IGFyZSBuby1vcC4NCi8vIFNvIGV4cGVjdCBmb2N1cyB0byBiZSBzeW5jaHJvbm91cyB3aGVuIHRoZSBlbGVtZW50IGlzIGFscmVhZHkgYWN0aXZlLA0KLy8gYW5kIGJsdXIgdG8gYmUgc3luY2hyb25vdXMgd2hlbiB0aGUgZWxlbWVudCBpcyBub3QgYWxyZWFkeSBhY3RpdmUuDQovLyAoZm9jdXMgYW5kIGJsdXIgYXJlIGFsd2F5cyBzeW5jaHJvbm91cyBpbiBvdGhlciBzdXBwb3J0ZWQgYnJvd3NlcnMsDQovLyB0aGlzIGp1c3QgZGVmaW5lcyB3aGVuIHdlIGNhbiBjb3VudCBvbiBpdCkuDQpmdW5jdGlvbiBleHBlY3RTeW5jKCBlbGVtLCB0eXBlICkgew0KCXJldHVybiAoIGVsZW0gPT09IHNhZmVBY3RpdmVFbGVtZW50KCkgKSA9PT0gKCB0eXBlID09PSAiZm9jdXMiICk7DQp9DQoNCi8vIFN1cHBvcnQ6IElFIDw9OSBvbmx5DQovLyBBY2Nlc3NpbmcgZG9jdW1lbnQuYWN0aXZlRWxlbWVudCBjYW4gdGhyb3cgdW5leHBlY3RlZGx5DQovLyBodHRwczovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvMTMzOTMNCmZ1bmN0aW9uIHNhZmVBY3RpdmVFbGVtZW50KCkgew0KCXRyeSB7DQoJCXJldHVybiBkb2N1bWVudC5hY3RpdmVFbGVtZW50Ow0KCX0gY2F0Y2ggKCBlcnIgKSB7IH0NCn0NCg0KZnVuY3Rpb24gb24oIGVsZW0sIHR5cGVzLCBzZWxlY3RvciwgZGF0YSwgZm4sIG9uZSApIHsNCgl2YXIgb3JpZ0ZuLCB0eXBlOw0KDQoJLy8gVHlwZXMgY2FuIGJlIGEgbWFwIG9mIHR5cGVzL2hhbmRsZXJzDQoJaWYgKCB0eXBlb2YgdHlwZXMgPT09ICJvYmplY3QiICkgew0KDQoJCS8vICggdHlwZXMtT2JqZWN0LCBzZWxlY3RvciwgZGF0YSApDQoJCWlmICggdHlwZW9mIHNlbGVjdG9yICE9PSAic3RyaW5nIiApIHsNCg0KCQkJLy8gKCB0eXBlcy1PYmplY3QsIGRhdGEgKQ0KCQkJZGF0YSA9IGRhdGEgfHwgc2VsZWN0b3I7DQoJCQlzZWxlY3RvciA9IHVuZGVmaW5lZDsNCgkJfQ0KCQlmb3IgKCB0eXBlIGluIHR5cGVzICkgew0KCQkJb24oIGVsZW0sIHR5cGUsIHNlbGVjdG9yLCBkYXRhLCB0eXBlc1sgdHlwZSBdLCBvbmUgKTsNCgkJfQ0KCQlyZXR1cm4gZWxlbTsNCgl9DQoNCglpZiAoIGRhdGEgPT0gbnVsbCAmJiBmbiA9PSBudWxsICkgew0KDQoJCS8vICggdHlwZXMsIGZuICkNCgkJZm4gPSBzZWxlY3RvcjsNCgkJZGF0YSA9IHNlbGVjdG9yID0gdW5kZWZpbmVkOw0KCX0gZWxzZSBpZiAoIGZuID09IG51bGwgKSB7DQoJCWlmICggdHlwZW9mIHNlbGVjdG9yID09PSAic3RyaW5nIiApIHsNCg0KCQkJLy8gKCB0eXBlcywgc2VsZWN0b3IsIGZuICkNCgkJCWZuID0gZGF0YTsNCgkJCWRhdGEgPSB1bmRlZmluZWQ7DQoJCX0gZWxzZSB7DQoNCgkJCS8vICggdHlwZXMsIGRhdGEsIGZuICkNCgkJCWZuID0gZGF0YTsNCgkJCWRhdGEgPSBzZWxlY3RvcjsNCgkJCXNlbGVjdG9yID0gdW5kZWZpbmVkOw0KCQl9DQoJfQ0KCWlmICggZm4gPT09IGZhbHNlICkgew0KCQlmbiA9IHJldHVybkZhbHNlOw0KCX0gZWxzZSBpZiAoICFmbiApIHsNCgkJcmV0dXJuIGVsZW07DQoJfQ0KDQoJaWYgKCBvbmUgPT09IDEgKSB7DQoJCW9yaWdGbiA9IGZuOw0KCQlmbiA9IGZ1bmN0aW9uKCBldmVudCApIHsNCg0KCQkJLy8gQ2FuIHVzZSBhbiBlbXB0eSBzZXQsIHNpbmNlIGV2ZW50IGNvbnRhaW5zIHRoZSBpbmZvDQoJCQlqUXVlcnkoKS5vZmYoIGV2ZW50ICk7DQoJCQlyZXR1cm4gb3JpZ0ZuLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsNCgkJfTsNCg0KCQkvLyBVc2Ugc2FtZSBndWlkIHNvIGNhbGxlciBjYW4gcmVtb3ZlIHVzaW5nIG9yaWdGbg0KCQlmbi5ndWlkID0gb3JpZ0ZuLmd1aWQgfHwgKCBvcmlnRm4uZ3VpZCA9IGpRdWVyeS5ndWlkKysgKTsNCgl9DQoJcmV0dXJuIGVsZW0uZWFjaCggZnVuY3Rpb24oKSB7DQoJCWpRdWVyeS5ldmVudC5hZGQoIHRoaXMsIHR5cGVzLCBmbiwgZGF0YSwgc2VsZWN0b3IgKTsNCgl9ICk7DQp9DQoNCi8qDQogKiBIZWxwZXIgZnVuY3Rpb25zIGZvciBtYW5hZ2luZyBldmVudHMgLS0gbm90IHBhcnQgb2YgdGhlIHB1YmxpYyBpbnRlcmZhY2UuDQogKiBQcm9wcyB0byBEZWFuIEVkd2FyZHMnIGFkZEV2ZW50IGxpYnJhcnkgZm9yIG1hbnkgb2YgdGhlIGlkZWFzLg0KICovDQpqUXVlcnkuZXZlbnQgPSB7DQoNCglnbG9iYWw6IHt9LA0KDQoJYWRkOiBmdW5jdGlvbiggZWxlbSwgdHlwZXMsIGhhbmRsZXIsIGRhdGEsIHNlbGVjdG9yICkgew0KDQoJCXZhciBoYW5kbGVPYmpJbiwgZXZlbnRIYW5kbGUsIHRtcCwNCgkJCWV2ZW50cywgdCwgaGFuZGxlT2JqLA0KCQkJc3BlY2lhbCwgaGFuZGxlcnMsIHR5cGUsIG5hbWVzcGFjZXMsIG9yaWdUeXBlLA0KCQkJZWxlbURhdGEgPSBkYXRhUHJpdi5nZXQoIGVsZW0gKTsNCg0KCQkvLyBPbmx5IGF0dGFjaCBldmVudHMgdG8gb2JqZWN0cyB0aGF0IGFjY2VwdCBkYXRhDQoJCWlmICggIWFjY2VwdERhdGEoIGVsZW0gKSApIHsNCgkJCXJldHVybjsNCgkJfQ0KDQoJCS8vIENhbGxlciBjYW4gcGFzcyBpbiBhbiBvYmplY3Qgb2YgY3VzdG9tIGRhdGEgaW4gbGlldSBvZiB0aGUgaGFuZGxlcg0KCQlpZiAoIGhhbmRsZXIuaGFuZGxlciApIHsNCgkJCWhhbmRsZU9iakluID0gaGFuZGxlcjsNCgkJCWhhbmRsZXIgPSBoYW5kbGVPYmpJbi5oYW5kbGVyOw0KCQkJc2VsZWN0b3IgPSBoYW5kbGVPYmpJbi5zZWxlY3RvcjsNCgkJfQ0KDQoJCS8vIEVuc3VyZSB0aGF0IGludmFsaWQgc2VsZWN0b3JzIHRocm93IGV4Y2VwdGlvbnMgYXQgYXR0YWNoIHRpbWUNCgkJLy8gRXZhbHVhdGUgYWdhaW5zdCBkb2N1bWVudEVsZW1lbnQgaW4gY2FzZSBlbGVtIGlzIGEgbm9uLWVsZW1lbnQgbm9kZSAoZS5nLiwgZG9jdW1lbnQpDQoJCWlmICggc2VsZWN0b3IgKSB7DQoJCQlqUXVlcnkuZmluZC5tYXRjaGVzU2VsZWN0b3IoIGRvY3VtZW50RWxlbWVudCwgc2VsZWN0b3IgKTsNCgkJfQ0KDQoJCS8vIE1ha2Ugc3VyZSB0aGF0IHRoZSBoYW5kbGVyIGhhcyBhIHVuaXF1ZSBJRCwgdXNlZCB0byBmaW5kL3JlbW92ZSBpdCBsYXRlcg0KCQlpZiAoICFoYW5kbGVyLmd1aWQgKSB7DQoJCQloYW5kbGVyLmd1aWQgPSBqUXVlcnkuZ3VpZCsrOw0KCQl9DQoNCgkJLy8gSW5pdCB0aGUgZWxlbWVudCdzIGV2ZW50IHN0cnVjdHVyZSBhbmQgbWFpbiBoYW5kbGVyLCBpZiB0aGlzIGlzIHRoZSBmaXJzdA0KCQlpZiAoICEoIGV2ZW50cyA9IGVsZW1EYXRhLmV2ZW50cyApICkgew0KCQkJZXZlbnRzID0gZWxlbURhdGEuZXZlbnRzID0gT2JqZWN0LmNyZWF0ZSggbnVsbCApOw0KCQl9DQoJCWlmICggISggZXZlbnRIYW5kbGUgPSBlbGVtRGF0YS5oYW5kbGUgKSApIHsNCgkJCWV2ZW50SGFuZGxlID0gZWxlbURhdGEuaGFuZGxlID0gZnVuY3Rpb24oIGUgKSB7DQoNCgkJCQkvLyBEaXNjYXJkIHRoZSBzZWNvbmQgZXZlbnQgb2YgYSBqUXVlcnkuZXZlbnQudHJpZ2dlcigpIGFuZA0KCQkJCS8vIHdoZW4gYW4gZXZlbnQgaXMgY2FsbGVkIGFmdGVyIGEgcGFnZSBoYXMgdW5sb2FkZWQNCgkJCQlyZXR1cm4gdHlwZW9mIGpRdWVyeSAhPT0gInVuZGVmaW5lZCIgJiYgalF1ZXJ5LmV2ZW50LnRyaWdnZXJlZCAhPT0gZS50eXBlID8NCgkJCQkJalF1ZXJ5LmV2ZW50LmRpc3BhdGNoLmFwcGx5KCBlbGVtLCBhcmd1bWVudHMgKSA6IHVuZGVmaW5lZDsNCgkJCX07DQoJCX0NCg0KCQkvLyBIYW5kbGUgbXVsdGlwbGUgZXZlbnRzIHNlcGFyYXRlZCBieSBhIHNwYWNlDQoJCXR5cGVzID0gKCB0eXBlcyB8fCAiIiApLm1hdGNoKCBybm90aHRtbHdoaXRlICkgfHwgWyAiIiBdOw0KCQl0ID0gdHlwZXMubGVuZ3RoOw0KCQl3aGlsZSAoIHQtLSApIHsNCgkJCXRtcCA9IHJ0eXBlbmFtZXNwYWNlLmV4ZWMoIHR5cGVzWyB0IF0gKSB8fCBbXTsNCgkJCXR5cGUgPSBvcmlnVHlwZSA9IHRtcFsgMSBdOw0KCQkJbmFtZXNwYWNlcyA9ICggdG1wWyAyIF0gfHwgIiIgKS5zcGxpdCggIi4iICkuc29ydCgpOw0KDQoJCQkvLyBUaGVyZSAqbXVzdCogYmUgYSB0eXBlLCBubyBhdHRhY2hpbmcgbmFtZXNwYWNlLW9ubHkgaGFuZGxlcnMNCgkJCWlmICggIXR5cGUgKSB7DQoJCQkJY29udGludWU7DQoJCQl9DQoNCgkJCS8vIElmIGV2ZW50IGNoYW5nZXMgaXRzIHR5cGUsIHVzZSB0aGUgc3BlY2lhbCBldmVudCBoYW5kbGVycyBmb3IgdGhlIGNoYW5nZWQgdHlwZQ0KCQkJc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsWyB0eXBlIF0gfHwge307DQoNCgkJCS8vIElmIHNlbGVjdG9yIGRlZmluZWQsIGRldGVybWluZSBzcGVjaWFsIGV2ZW50IGFwaSB0eXBlLCBvdGhlcndpc2UgZ2l2ZW4gdHlwZQ0KCQkJdHlwZSA9ICggc2VsZWN0b3IgPyBzcGVjaWFsLmRlbGVnYXRlVHlwZSA6IHNwZWNpYWwuYmluZFR5cGUgKSB8fCB0eXBlOw0KDQoJCQkvLyBVcGRhdGUgc3BlY2lhbCBiYXNlZCBvbiBuZXdseSByZXNldCB0eXBlDQoJCQlzcGVjaWFsID0galF1ZXJ5LmV2ZW50LnNwZWNpYWxbIHR5cGUgXSB8fCB7fTsNCg0KCQkJLy8gaGFuZGxlT2JqIGlzIHBhc3NlZCB0byBhbGwgZXZlbnQgaGFuZGxlcnMNCgkJCWhhbmRsZU9iaiA9IGpRdWVyeS5leHRlbmQoIHsNCgkJCQl0eXBlOiB0eXBlLA0KCQkJCW9yaWdUeXBlOiBvcmlnVHlwZSwNCgkJCQlkYXRhOiBkYXRhLA0KCQkJCWhhbmRsZXI6IGhhbmRsZXIsDQoJCQkJZ3VpZDogaGFuZGxlci5ndWlkLA0KCQkJCXNlbGVjdG9yOiBzZWxlY3RvciwNCgkJCQluZWVkc0NvbnRleHQ6IHNlbGVjdG9yICYmIGpRdWVyeS5leHByLm1hdGNoLm5lZWRzQ29udGV4dC50ZXN0KCBzZWxlY3RvciApLA0KCQkJCW5hbWVzcGFjZTogbmFtZXNwYWNlcy5qb2luKCAiLiIgKQ0KCQkJfSwgaGFuZGxlT2JqSW4gKTsNCg0KCQkJLy8gSW5pdCB0aGUgZXZlbnQgaGFuZGxlciBxdWV1ZSBpZiB3ZSdyZSB0aGUgZmlyc3QNCgkJCWlmICggISggaGFuZGxlcnMgPSBldmVudHNbIHR5cGUgXSApICkgew0KCQkJCWhhbmRsZXJzID0gZXZlbnRzWyB0eXBlIF0gPSBbXTsNCgkJCQloYW5kbGVycy5kZWxlZ2F0ZUNvdW50ID0gMDsNCg0KCQkJCS8vIE9ubHkgdXNlIGFkZEV2ZW50TGlzdGVuZXIgaWYgdGhlIHNwZWNpYWwgZXZlbnRzIGhhbmRsZXIgcmV0dXJucyBmYWxzZQ0KCQkJCWlmICggIXNwZWNpYWwuc2V0dXAgfHwNCgkJCQkJc3BlY2lhbC5zZXR1cC5jYWxsKCBlbGVtLCBkYXRhLCBuYW1lc3BhY2VzLCBldmVudEhhbmRsZSApID09PSBmYWxzZSApIHsNCg0KCQkJCQlpZiAoIGVsZW0uYWRkRXZlbnRMaXN0ZW5lciApIHsNCgkJCQkJCWVsZW0uYWRkRXZlbnRMaXN0ZW5lciggdHlwZSwgZXZlbnRIYW5kbGUgKTsNCgkJCQkJfQ0KCQkJCX0NCgkJCX0NCg0KCQkJaWYgKCBzcGVjaWFsLmFkZCApIHsNCgkJCQlzcGVjaWFsLmFkZC5jYWxsKCBlbGVtLCBoYW5kbGVPYmogKTsNCg0KCQkJCWlmICggIWhhbmRsZU9iai5oYW5kbGVyLmd1aWQgKSB7DQoJCQkJCWhhbmRsZU9iai5oYW5kbGVyLmd1aWQgPSBoYW5kbGVyLmd1aWQ7DQoJCQkJfQ0KCQkJfQ0KDQoJCQkvLyBBZGQgdG8gdGhlIGVsZW1lbnQncyBoYW5kbGVyIGxpc3QsIGRlbGVnYXRlcyBpbiBmcm9udA0KCQkJaWYgKCBzZWxlY3RvciApIHsNCgkJCQloYW5kbGVycy5zcGxpY2UoIGhhbmRsZXJzLmRlbGVnYXRlQ291bnQrKywgMCwgaGFuZGxlT2JqICk7DQoJCQl9IGVsc2Ugew0KCQkJCWhhbmRsZXJzLnB1c2goIGhhbmRsZU9iaiApOw0KCQkJfQ0KDQoJCQkvLyBLZWVwIHRyYWNrIG9mIHdoaWNoIGV2ZW50cyBoYXZlIGV2ZXIgYmVlbiB1c2VkLCBmb3IgZXZlbnQgb3B0aW1pemF0aW9uDQoJCQlqUXVlcnkuZXZlbnQuZ2xvYmFsWyB0eXBlIF0gPSB0cnVlOw0KCQl9DQoNCgl9LA0KDQoJLy8gRGV0YWNoIGFuIGV2ZW50IG9yIHNldCBvZiBldmVudHMgZnJvbSBhbiBlbGVtZW50DQoJcmVtb3ZlOiBmdW5jdGlvbiggZWxlbSwgdHlwZXMsIGhhbmRsZXIsIHNlbGVjdG9yLCBtYXBwZWRUeXBlcyApIHsNCg0KCQl2YXIgaiwgb3JpZ0NvdW50LCB0bXAsDQoJCQlldmVudHMsIHQsIGhhbmRsZU9iaiwNCgkJCXNwZWNpYWwsIGhhbmRsZXJzLCB0eXBlLCBuYW1lc3BhY2VzLCBvcmlnVHlwZSwNCgkJCWVsZW1EYXRhID0gZGF0YVByaXYuaGFzRGF0YSggZWxlbSApICYmIGRhdGFQcml2LmdldCggZWxlbSApOw0KDQoJCWlmICggIWVsZW1EYXRhIHx8ICEoIGV2ZW50cyA9IGVsZW1EYXRhLmV2ZW50cyApICkgew0KCQkJcmV0dXJuOw0KCQl9DQoNCgkJLy8gT25jZSBmb3IgZWFjaCB0eXBlLm5hbWVzcGFjZSBpbiB0eXBlczsgdHlwZSBtYXkgYmUgb21pdHRlZA0KCQl0eXBlcyA9ICggdHlwZXMgfHwgIiIgKS5tYXRjaCggcm5vdGh0bWx3aGl0ZSApIHx8IFsgIiIgXTsNCgkJdCA9IHR5cGVzLmxlbmd0aDsNCgkJd2hpbGUgKCB0LS0gKSB7DQoJCQl0bXAgPSBydHlwZW5hbWVzcGFjZS5leGVjKCB0eXBlc1sgdCBdICkgfHwgW107DQoJCQl0eXBlID0gb3JpZ1R5cGUgPSB0bXBbIDEgXTsNCgkJCW5hbWVzcGFjZXMgPSAoIHRtcFsgMiBdIHx8ICIiICkuc3BsaXQoICIuIiApLnNvcnQoKTsNCg0KCQkJLy8gVW5iaW5kIGFsbCBldmVudHMgKG9uIHRoaXMgbmFtZXNwYWNlLCBpZiBwcm92aWRlZCkgZm9yIHRoZSBlbGVtZW50DQoJCQlpZiAoICF0eXBlICkgew0KCQkJCWZvciAoIHR5cGUgaW4gZXZlbnRzICkgew0KCQkJCQlqUXVlcnkuZXZlbnQucmVtb3ZlKCBlbGVtLCB0eXBlICsgdHlwZXNbIHQgXSwgaGFuZGxlciwgc2VsZWN0b3IsIHRydWUgKTsNCgkJCQl9DQoJCQkJY29udGludWU7DQoJCQl9DQoNCgkJCXNwZWNpYWwgPSBqUXVlcnkuZXZlbnQuc3BlY2lhbFsgdHlwZSBdIHx8IHt9Ow0KCQkJdHlwZSA9ICggc2VsZWN0b3IgPyBzcGVjaWFsLmRlbGVnYXRlVHlwZSA6IHNwZWNpYWwuYmluZFR5cGUgKSB8fCB0eXBlOw0KCQkJaGFuZGxlcnMgPSBldmVudHNbIHR5cGUgXSB8fCBbXTsNCgkJCXRtcCA9IHRtcFsgMiBdICYmDQoJCQkJbmV3IFJlZ0V4cCggIihefFxcLikiICsgbmFtZXNwYWNlcy5qb2luKCAiXFwuKD86LipcXC58KSIgKSArICIoXFwufCQpIiApOw0KDQoJCQkvLyBSZW1vdmUgbWF0Y2hpbmcgZXZlbnRzDQoJCQlvcmlnQ291bnQgPSBqID0gaGFuZGxlcnMubGVuZ3RoOw0KCQkJd2hpbGUgKCBqLS0gKSB7DQoJCQkJaGFuZGxlT2JqID0gaGFuZGxlcnNbIGogXTsNCg0KCQkJCWlmICggKCBtYXBwZWRUeXBlcyB8fCBvcmlnVHlwZSA9PT0gaGFuZGxlT2JqLm9yaWdUeXBlICkgJiYNCgkJCQkJKCAhaGFuZGxlciB8fCBoYW5kbGVyLmd1aWQgPT09IGhhbmRsZU9iai5ndWlkICkgJiYNCgkJCQkJKCAhdG1wIHx8IHRtcC50ZXN0KCBoYW5kbGVPYmoubmFtZXNwYWNlICkgKSAmJg0KCQkJCQkoICFzZWxlY3RvciB8fCBzZWxlY3RvciA9PT0gaGFuZGxlT2JqLnNlbGVjdG9yIHx8DQoJCQkJCQlzZWxlY3RvciA9PT0gIioqIiAmJiBoYW5kbGVPYmouc2VsZWN0b3IgKSApIHsNCgkJCQkJaGFuZGxlcnMuc3BsaWNlKCBqLCAxICk7DQoNCgkJCQkJaWYgKCBoYW5kbGVPYmouc2VsZWN0b3IgKSB7DQoJCQkJCQloYW5kbGVycy5kZWxlZ2F0ZUNvdW50LS07DQoJCQkJCX0NCgkJCQkJaWYgKCBzcGVjaWFsLnJlbW92ZSApIHsNCgkJCQkJCXNwZWNpYWwucmVtb3ZlLmNhbGwoIGVsZW0sIGhhbmRsZU9iaiApOw0KCQkJCQl9DQoJCQkJfQ0KCQkJfQ0KDQoJCQkvLyBSZW1vdmUgZ2VuZXJpYyBldmVudCBoYW5kbGVyIGlmIHdlIHJlbW92ZWQgc29tZXRoaW5nIGFuZCBubyBtb3JlIGhhbmRsZXJzIGV4aXN0DQoJCQkvLyAoYXZvaWRzIHBvdGVudGlhbCBmb3IgZW5kbGVzcyByZWN1cnNpb24gZHVyaW5nIHJlbW92YWwgb2Ygc3BlY2lhbCBldmVudCBoYW5kbGVycykNCgkJCWlmICggb3JpZ0NvdW50ICYmICFoYW5kbGVycy5sZW5ndGggKSB7DQoJCQkJaWYgKCAhc3BlY2lhbC50ZWFyZG93biB8fA0KCQkJCQlzcGVjaWFsLnRlYXJkb3duLmNhbGwoIGVsZW0sIG5hbWVzcGFjZXMsIGVsZW1EYXRhLmhhbmRsZSApID09PSBmYWxzZSApIHsNCg0KCQkJCQlqUXVlcnkucmVtb3ZlRXZlbnQoIGVsZW0sIHR5cGUsIGVsZW1EYXRhLmhhbmRsZSApOw0KCQkJCX0NCg0KCQkJCWRlbGV0ZSBldmVudHNbIHR5cGUgXTsNCgkJCX0NCgkJfQ0KDQoJCS8vIFJlbW92ZSBkYXRhIGFuZCB0aGUgZXhwYW5kbyBpZiBpdCdzIG5vIGxvbmdlciB1c2VkDQoJCWlmICggalF1ZXJ5LmlzRW1wdHlPYmplY3QoIGV2ZW50cyApICkgew0KCQkJZGF0YVByaXYucmVtb3ZlKCBlbGVtLCAiaGFuZGxlIGV2ZW50cyIgKTsNCgkJfQ0KCX0sDQoNCglkaXNwYXRjaDogZnVuY3Rpb24oIG5hdGl2ZUV2ZW50ICkgew0KDQoJCXZhciBpLCBqLCByZXQsIG1hdGNoZWQsIGhhbmRsZU9iaiwgaGFuZGxlclF1ZXVlLA0KCQkJYXJncyA9IG5ldyBBcnJheSggYXJndW1lbnRzLmxlbmd0aCApLA0KDQoJCQkvLyBNYWtlIGEgd3JpdGFibGUgalF1ZXJ5LkV2ZW50IGZyb20gdGhlIG5hdGl2ZSBldmVudCBvYmplY3QNCgkJCWV2ZW50ID0galF1ZXJ5LmV2ZW50LmZpeCggbmF0aXZlRXZlbnQgKSwNCg0KCQkJaGFuZGxlcnMgPSAoDQoJCQkJZGF0YVByaXYuZ2V0KCB0aGlzLCAiZXZlbnRzIiApIHx8IE9iamVjdC5jcmVhdGUoIG51bGwgKQ0KCQkJKVsgZXZlbnQudHlwZSBdIHx8IFtdLA0KCQkJc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsWyBldmVudC50eXBlIF0gfHwge307DQoNCgkJLy8gVXNlIHRoZSBmaXgtZWQgalF1ZXJ5LkV2ZW50IHJhdGhlciB0aGFuIHRoZSAocmVhZC1vbmx5KSBuYXRpdmUgZXZlbnQNCgkJYXJnc1sgMCBdID0gZXZlbnQ7DQoNCgkJZm9yICggaSA9IDE7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKysgKSB7DQoJCQlhcmdzWyBpIF0gPSBhcmd1bWVudHNbIGkgXTsNCgkJfQ0KDQoJCWV2ZW50LmRlbGVnYXRlVGFyZ2V0ID0gdGhpczsNCg0KCQkvLyBDYWxsIHRoZSBwcmVEaXNwYXRjaCBob29rIGZvciB0aGUgbWFwcGVkIHR5cGUsIGFuZCBsZXQgaXQgYmFpbCBpZiBkZXNpcmVkDQoJCWlmICggc3BlY2lhbC5wcmVEaXNwYXRjaCAmJiBzcGVjaWFsLnByZURpc3BhdGNoLmNhbGwoIHRoaXMsIGV2ZW50ICkgPT09IGZhbHNlICkgew0KCQkJcmV0dXJuOw0KCQl9DQoNCgkJLy8gRGV0ZXJtaW5lIGhhbmRsZXJzDQoJCWhhbmRsZXJRdWV1ZSA9IGpRdWVyeS5ldmVudC5oYW5kbGVycy5jYWxsKCB0aGlzLCBldmVudCwgaGFuZGxlcnMgKTsNCg0KCQkvLyBSdW4gZGVsZWdhdGVzIGZpcnN0OyB0aGV5IG1heSB3YW50IHRvIHN0b3AgcHJvcGFnYXRpb24gYmVuZWF0aCB1cw0KCQlpID0gMDsNCgkJd2hpbGUgKCAoIG1hdGNoZWQgPSBoYW5kbGVyUXVldWVbIGkrKyBdICkgJiYgIWV2ZW50LmlzUHJvcGFnYXRpb25TdG9wcGVkKCkgKSB7DQoJCQlldmVudC5jdXJyZW50VGFyZ2V0ID0gbWF0Y2hlZC5lbGVtOw0KDQoJCQlqID0gMDsNCgkJCXdoaWxlICggKCBoYW5kbGVPYmogPSBtYXRjaGVkLmhhbmRsZXJzWyBqKysgXSApICYmDQoJCQkJIWV2ZW50LmlzSW1tZWRpYXRlUHJvcGFnYXRpb25TdG9wcGVkKCkgKSB7DQoNCgkJCQkvLyBJZiB0aGUgZXZlbnQgaXMgbmFtZXNwYWNlZCwgdGhlbiBlYWNoIGhhbmRsZXIgaXMgb25seSBpbnZva2VkIGlmIGl0IGlzDQoJCQkJLy8gc3BlY2lhbGx5IHVuaXZlcnNhbCBvciBpdHMgbmFtZXNwYWNlcyBhcmUgYSBzdXBlcnNldCBvZiB0aGUgZXZlbnQncy4NCgkJCQlpZiAoICFldmVudC5ybmFtZXNwYWNlIHx8IGhhbmRsZU9iai5uYW1lc3BhY2UgPT09IGZhbHNlIHx8DQoJCQkJCWV2ZW50LnJuYW1lc3BhY2UudGVzdCggaGFuZGxlT2JqLm5hbWVzcGFjZSApICkgew0KDQoJCQkJCWV2ZW50LmhhbmRsZU9iaiA9IGhhbmRsZU9iajsNCgkJCQkJZXZlbnQuZGF0YSA9IGhhbmRsZU9iai5kYXRhOw0KDQoJCQkJCXJldCA9ICggKCBqUXVlcnkuZXZlbnQuc3BlY2lhbFsgaGFuZGxlT2JqLm9yaWdUeXBlIF0gfHwge30gKS5oYW5kbGUgfHwNCgkJCQkJCWhhbmRsZU9iai5oYW5kbGVyICkuYXBwbHkoIG1hdGNoZWQuZWxlbSwgYXJncyApOw0KDQoJCQkJCWlmICggcmV0ICE9PSB1bmRlZmluZWQgKSB7DQoJCQkJCQlpZiAoICggZXZlbnQucmVzdWx0ID0gcmV0ICkgPT09IGZhbHNlICkgew0KCQkJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7DQoJCQkJCQkJZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7DQoJCQkJCQl9DQoJCQkJCX0NCgkJCQl9DQoJCQl9DQoJCX0NCg0KCQkvLyBDYWxsIHRoZSBwb3N0RGlzcGF0Y2ggaG9vayBmb3IgdGhlIG1hcHBlZCB0eXBlDQoJCWlmICggc3BlY2lhbC5wb3N0RGlzcGF0Y2ggKSB7DQoJCQlzcGVjaWFsLnBvc3REaXNwYXRjaC5jYWxsKCB0aGlzLCBldmVudCApOw0KCQl9DQoNCgkJcmV0dXJuIGV2ZW50LnJlc3VsdDsNCgl9LA0KDQoJaGFuZGxlcnM6IGZ1bmN0aW9uKCBldmVudCwgaGFuZGxlcnMgKSB7DQoJCXZhciBpLCBoYW5kbGVPYmosIHNlbCwgbWF0Y2hlZEhhbmRsZXJzLCBtYXRjaGVkU2VsZWN0b3JzLA0KCQkJaGFuZGxlclF1ZXVlID0gW10sDQoJCQlkZWxlZ2F0ZUNvdW50ID0gaGFuZGxlcnMuZGVsZWdhdGVDb3VudCwNCgkJCWN1ciA9IGV2ZW50LnRhcmdldDsNCg0KCQkvLyBGaW5kIGRlbGVnYXRlIGhhbmRsZXJzDQoJCWlmICggZGVsZWdhdGVDb3VudCAmJg0KDQoJCQkvLyBTdXBwb3J0OiBJRSA8PTkNCgkJCS8vIEJsYWNrLWhvbGUgU1ZHIDx1c2U+IGluc3RhbmNlIHRyZWVzICh0cmFjLTEzMTgwKQ0KCQkJY3VyLm5vZGVUeXBlICYmDQoNCgkJCS8vIFN1cHBvcnQ6IEZpcmVmb3ggPD00Mg0KCQkJLy8gU3VwcHJlc3Mgc3BlYy12aW9sYXRpbmcgY2xpY2tzIGluZGljYXRpbmcgYSBub24tcHJpbWFyeSBwb2ludGVyIGJ1dHRvbiAodHJhYy0zODYxKQ0KCQkJLy8gaHR0cHM6Ly93d3cudzMub3JnL1RSL0RPTS1MZXZlbC0zLUV2ZW50cy8jZXZlbnQtdHlwZS1jbGljaw0KCQkJLy8gU3VwcG9ydDogSUUgMTEgb25seQ0KCQkJLy8gLi4uYnV0IG5vdCBhcnJvdyBrZXkgImNsaWNrcyIgb2YgcmFkaW8gaW5wdXRzLCB3aGljaCBjYW4gaGF2ZSBgYnV0dG9uYCAtMSAoZ2gtMjM0MykNCgkJCSEoIGV2ZW50LnR5cGUgPT09ICJjbGljayIgJiYgZXZlbnQuYnV0dG9uID49IDEgKSApIHsNCg0KCQkJZm9yICggOyBjdXIgIT09IHRoaXM7IGN1ciA9IGN1ci5wYXJlbnROb2RlIHx8IHRoaXMgKSB7DQoNCgkJCQkvLyBEb24ndCBjaGVjayBub24tZWxlbWVudHMgKCMxMzIwOCkNCgkJCQkvLyBEb24ndCBwcm9jZXNzIGNsaWNrcyBvbiBkaXNhYmxlZCBlbGVtZW50cyAoIzY5MTEsICM4MTY1LCAjMTEzODIsICMxMTc2NCkNCgkJCQlpZiAoIGN1ci5ub2RlVHlwZSA9PT0gMSAmJiAhKCBldmVudC50eXBlID09PSAiY2xpY2siICYmIGN1ci5kaXNhYmxlZCA9PT0gdHJ1ZSApICkgew0KCQkJCQltYXRjaGVkSGFuZGxlcnMgPSBbXTsNCgkJCQkJbWF0Y2hlZFNlbGVjdG9ycyA9IHt9Ow0KCQkJCQlmb3IgKCBpID0gMDsgaSA8IGRlbGVnYXRlQ291bnQ7IGkrKyApIHsNCgkJCQkJCWhhbmRsZU9iaiA9IGhhbmRsZXJzWyBpIF07DQoNCgkJCQkJCS8vIERvbid0IGNvbmZsaWN0IHdpdGggT2JqZWN0LnByb3RvdHlwZSBwcm9wZXJ0aWVzICgjMTMyMDMpDQoJCQkJCQlzZWwgPSBoYW5kbGVPYmouc2VsZWN0b3IgKyAiICI7DQoNCgkJCQkJCWlmICggbWF0Y2hlZFNlbGVjdG9yc1sgc2VsIF0gPT09IHVuZGVmaW5lZCApIHsNCgkJCQkJCQltYXRjaGVkU2VsZWN0b3JzWyBzZWwgXSA9IGhhbmRsZU9iai5uZWVkc0NvbnRleHQgPw0KCQkJCQkJCQlqUXVlcnkoIHNlbCwgdGhpcyApLmluZGV4KCBjdXIgKSA+IC0xIDoNCgkJCQkJCQkJalF1ZXJ5LmZpbmQoIHNlbCwgdGhpcywgbnVsbCwgWyBjdXIgXSApLmxlbmd0aDsNCgkJCQkJCX0NCgkJCQkJCWlmICggbWF0Y2hlZFNlbGVjdG9yc1sgc2VsIF0gKSB7DQoJCQkJCQkJbWF0Y2hlZEhhbmRsZXJzLnB1c2goIGhhbmRsZU9iaiApOw0KCQkJCQkJfQ0KCQkJCQl9DQoJCQkJCWlmICggbWF0Y2hlZEhhbmRsZXJzLmxlbmd0aCApIHsNCgkJCQkJCWhhbmRsZXJRdWV1ZS5wdXNoKCB7IGVsZW06IGN1ciwgaGFuZGxlcnM6IG1hdGNoZWRIYW5kbGVycyB9ICk7DQoJCQkJCX0NCgkJCQl9DQoJCQl9DQoJCX0NCg0KCQkvLyBBZGQgdGhlIHJlbWFpbmluZyAoZGlyZWN0bHktYm91bmQpIGhhbmRsZXJzDQoJCWN1ciA9IHRoaXM7DQoJCWlmICggZGVsZWdhdGVDb3VudCA8IGhhbmRsZXJzLmxlbmd0aCApIHsNCgkJCWhhbmRsZXJRdWV1ZS5wdXNoKCB7IGVsZW06IGN1ciwgaGFuZGxlcnM6IGhhbmRsZXJzLnNsaWNlKCBkZWxlZ2F0ZUNvdW50ICkgfSApOw0KCQl9DQoNCgkJcmV0dXJuIGhhbmRsZXJRdWV1ZTsNCgl9LA0KDQoJYWRkUHJvcDogZnVuY3Rpb24oIG5hbWUsIGhvb2sgKSB7DQoJCU9iamVjdC5kZWZpbmVQcm9wZXJ0eSggalF1ZXJ5LkV2ZW50LnByb3RvdHlwZSwgbmFtZSwgew0KCQkJZW51bWVyYWJsZTogdHJ1ZSwNCgkJCWNvbmZpZ3VyYWJsZTogdHJ1ZSwNCg0KCQkJZ2V0OiBpc0Z1bmN0aW9uKCBob29rICkgPw0KCQkJCWZ1bmN0aW9uKCkgew0KCQkJCQlpZiAoIHRoaXMub3JpZ2luYWxFdmVudCApIHsNCgkJCQkJCXJldHVybiBob29rKCB0aGlzLm9yaWdpbmFsRXZlbnQgKTsNCgkJCQkJfQ0KCQkJCX0gOg0KCQkJCWZ1bmN0aW9uKCkgew0KCQkJCQlpZiAoIHRoaXMub3JpZ2luYWxFdmVudCApIHsNCgkJCQkJCXJldHVybiB0aGlzLm9yaWdpbmFsRXZlbnRbIG5hbWUgXTsNCgkJCQkJfQ0KCQkJCX0sDQoNCgkJCXNldDogZnVuY3Rpb24oIHZhbHVlICkgew0KCQkJCU9iamVjdC5kZWZpbmVQcm9wZXJ0eSggdGhpcywgbmFtZSwgew0KCQkJCQllbnVtZXJhYmxlOiB0cnVlLA0KCQkJCQljb25maWd1cmFibGU6IHRydWUsDQoJCQkJCXdyaXRhYmxlOiB0cnVlLA0KCQkJCQl2YWx1ZTogdmFsdWUNCgkJCQl9ICk7DQoJCQl9DQoJCX0gKTsNCgl9LA0KDQoJZml4OiBmdW5jdGlvbiggb3JpZ2luYWxFdmVudCApIHsNCgkJcmV0dXJuIG9yaWdpbmFsRXZlbnRbIGpRdWVyeS5leHBhbmRvIF0gPw0KCQkJb3JpZ2luYWxFdmVudCA6DQoJCQluZXcgalF1ZXJ5LkV2ZW50KCBvcmlnaW5hbEV2ZW50ICk7DQoJfSwNCg0KCXNwZWNpYWw6IHsNCgkJbG9hZDogew0KDQoJCQkvLyBQcmV2ZW50IHRyaWdnZXJlZCBpbWFnZS5sb2FkIGV2ZW50cyBmcm9tIGJ1YmJsaW5nIHRvIHdpbmRvdy5sb2FkDQoJCQlub0J1YmJsZTogdHJ1ZQ0KCQl9LA0KCQljbGljazogew0KDQoJCQkvLyBVdGlsaXplIG5hdGl2ZSBldmVudCB0byBlbnN1cmUgY29ycmVjdCBzdGF0ZSBmb3IgY2hlY2thYmxlIGlucHV0cw0KCQkJc2V0dXA6IGZ1bmN0aW9uKCBkYXRhICkgew0KDQoJCQkJLy8gRm9yIG11dHVhbCBjb21wcmVzc2liaWxpdHkgd2l0aCBfZGVmYXVsdCwgcmVwbGFjZSBgdGhpc2AgYWNjZXNzIHdpdGggYSBsb2NhbCB2YXIuDQoJCQkJLy8gYHx8IGRhdGFgIGlzIGRlYWQgY29kZSBtZWFudCBvbmx5IHRvIHByZXNlcnZlIHRoZSB2YXJpYWJsZSB0aHJvdWdoIG1pbmlmaWNhdGlvbi4NCgkJCQl2YXIgZWwgPSB0aGlzIHx8IGRhdGE7DQoNCgkJCQkvLyBDbGFpbSB0aGUgZmlyc3QgaGFuZGxlcg0KCQkJCWlmICggcmNoZWNrYWJsZVR5cGUudGVzdCggZWwudHlwZSApICYmDQoJCQkJCWVsLmNsaWNrICYmIG5vZGVOYW1lKCBlbCwgImlucHV0IiApICkgew0KDQoJCQkJCS8vIGRhdGFQcml2LnNldCggZWwsICJjbGljayIsIC4uLiApDQoJCQkJCWxldmVyYWdlTmF0aXZlKCBlbCwgImNsaWNrIiwgcmV0dXJuVHJ1ZSApOw0KCQkJCX0NCg0KCQkJCS8vIFJldHVybiBmYWxzZSB0byBhbGxvdyBub3JtYWwgcHJvY2Vzc2luZyBpbiB0aGUgY2FsbGVyDQoJCQkJcmV0dXJuIGZhbHNlOw0KCQkJfSwNCgkJCXRyaWdnZXI6IGZ1bmN0aW9uKCBkYXRhICkgew0KDQoJCQkJLy8gRm9yIG11dHVhbCBjb21wcmVzc2liaWxpdHkgd2l0aCBfZGVmYXVsdCwgcmVwbGFjZSBgdGhpc2AgYWNjZXNzIHdpdGggYSBsb2NhbCB2YXIuDQoJCQkJLy8gYHx8IGRhdGFgIGlzIGRlYWQgY29kZSBtZWFudCBvbmx5IHRvIHByZXNlcnZlIHRoZSB2YXJpYWJsZSB0aHJvdWdoIG1pbmlmaWNhdGlvbi4NCgkJCQl2YXIgZWwgPSB0aGlzIHx8IGRhdGE7DQoNCgkJCQkvLyBGb3JjZSBzZXR1cCBiZWZvcmUgdHJpZ2dlcmluZyBhIGNsaWNrDQoJCQkJaWYgKCByY2hlY2thYmxlVHlwZS50ZXN0KCBlbC50eXBlICkgJiYNCgkJCQkJZWwuY2xpY2sgJiYgbm9kZU5hbWUoIGVsLCAiaW5wdXQiICkgKSB7DQoNCgkJCQkJbGV2ZXJhZ2VOYXRpdmUoIGVsLCAiY2xpY2siICk7DQoJCQkJfQ0KDQoJCQkJLy8gUmV0dXJuIG5vbi1mYWxzZSB0byBhbGxvdyBub3JtYWwgZXZlbnQtcGF0aCBwcm9wYWdhdGlvbg0KCQkJCXJldHVybiB0cnVlOw0KCQkJfSwNCg0KCQkJLy8gRm9yIGNyb3NzLWJyb3dzZXIgY29uc2lzdGVuY3ksIHN1cHByZXNzIG5hdGl2ZSAuY2xpY2soKSBvbiBsaW5rcw0KCQkJLy8gQWxzbyBwcmV2ZW50IGl0IGlmIHdlJ3JlIGN1cnJlbnRseSBpbnNpZGUgYSBsZXZlcmFnZWQgbmF0aXZlLWV2ZW50IHN0YWNrDQoJCQlfZGVmYXVsdDogZnVuY3Rpb24oIGV2ZW50ICkgew0KCQkJCXZhciB0YXJnZXQgPSBldmVudC50YXJnZXQ7DQoJCQkJcmV0dXJuIHJjaGVja2FibGVUeXBlLnRlc3QoIHRhcmdldC50eXBlICkgJiYNCgkJCQkJdGFyZ2V0LmNsaWNrICYmIG5vZGVOYW1lKCB0YXJnZXQsICJpbnB1dCIgKSAmJg0KCQkJCQlkYXRhUHJpdi5nZXQoIHRhcmdldCwgImNsaWNrIiApIHx8DQoJCQkJCW5vZGVOYW1lKCB0YXJnZXQsICJhIiApOw0KCQkJfQ0KCQl9LA0KDQoJCWJlZm9yZXVubG9hZDogew0KCQkJcG9zdERpc3BhdGNoOiBmdW5jdGlvbiggZXZlbnQgKSB7DQoNCgkJCQkvLyBTdXBwb3J0OiBGaXJlZm94IDIwKw0KCQkJCS8vIEZpcmVmb3ggZG9lc24ndCBhbGVydCBpZiB0aGUgcmV0dXJuVmFsdWUgZmllbGQgaXMgbm90IHNldC4NCgkJCQlpZiAoIGV2ZW50LnJlc3VsdCAhPT0gdW5kZWZpbmVkICYmIGV2ZW50Lm9yaWdpbmFsRXZlbnQgKSB7DQoJCQkJCWV2ZW50Lm9yaWdpbmFsRXZlbnQucmV0dXJuVmFsdWUgPSBldmVudC5yZXN1bHQ7DQoJCQkJfQ0KCQkJfQ0KCQl9DQoJfQ0KfTsNCg0KLy8gRW5zdXJlIHRoZSBwcmVzZW5jZSBvZiBhbiBldmVudCBsaXN0ZW5lciB0aGF0IGhhbmRsZXMgbWFudWFsbHktdHJpZ2dlcmVkDQovLyBzeW50aGV0aWMgZXZlbnRzIGJ5IGludGVycnVwdGluZyBwcm9ncmVzcyB1bnRpbCByZWludm9rZWQgaW4gcmVzcG9uc2UgdG8NCi8vICpuYXRpdmUqIGV2ZW50cyB0aGF0IGl0IGZpcmVzIGRpcmVjdGx5LCBlbnN1cmluZyB0aGF0IHN0YXRlIGNoYW5nZXMgaGF2ZQ0KLy8gYWxyZWFkeSBvY2N1cnJlZCBiZWZvcmUgb3RoZXIgbGlzdGVuZXJzIGFyZSBpbnZva2VkLg0KZnVuY3Rpb24gbGV2ZXJhZ2VOYXRpdmUoIGVsLCB0eXBlLCBleHBlY3RTeW5jICkgew0KDQoJLy8gTWlzc2luZyBleHBlY3RTeW5jIGluZGljYXRlcyBhIHRyaWdnZXIgY2FsbCwgd2hpY2ggbXVzdCBmb3JjZSBzZXR1cCB0aHJvdWdoIGpRdWVyeS5ldmVudC5hZGQNCglpZiAoICFleHBlY3RTeW5jICkgew0KCQlpZiAoIGRhdGFQcml2LmdldCggZWwsIHR5cGUgKSA9PT0gdW5kZWZpbmVkICkgew0KCQkJalF1ZXJ5LmV2ZW50LmFkZCggZWwsIHR5cGUsIHJldHVyblRydWUgKTsNCgkJfQ0KCQlyZXR1cm47DQoJfQ0KDQoJLy8gUmVnaXN0ZXIgdGhlIGNvbnRyb2xsZXIgYXMgYSBzcGVjaWFsIHVuaXZlcnNhbCBoYW5kbGVyIGZvciBhbGwgZXZlbnQgbmFtZXNwYWNlcw0KCWRhdGFQcml2LnNldCggZWwsIHR5cGUsIGZhbHNlICk7DQoJalF1ZXJ5LmV2ZW50LmFkZCggZWwsIHR5cGUsIHsNCgkJbmFtZXNwYWNlOiBmYWxzZSwNCgkJaGFuZGxlcjogZnVuY3Rpb24oIGV2ZW50ICkgew0KCQkJdmFyIG5vdEFzeW5jLCByZXN1bHQsDQoJCQkJc2F2ZWQgPSBkYXRhUHJpdi5nZXQoIHRoaXMsIHR5cGUgKTsNCg0KCQkJaWYgKCAoIGV2ZW50LmlzVHJpZ2dlciAmIDEgKSAmJiB0aGlzWyB0eXBlIF0gKSB7DQoNCgkJCQkvLyBJbnRlcnJ1cHQgcHJvY2Vzc2luZyBvZiB0aGUgb3V0ZXIgc3ludGhldGljIC50cmlnZ2VyKCllZCBldmVudA0KCQkJCS8vIFNhdmVkIGRhdGEgc2hvdWxkIGJlIGZhbHNlIGluIHN1Y2ggY2FzZXMsIGJ1dCBtaWdodCBiZSBhIGxlZnRvdmVyIGNhcHR1cmUgb2JqZWN0DQoJCQkJLy8gZnJvbSBhbiBhc3luYyBuYXRpdmUgaGFuZGxlciAoZ2gtNDM1MCkNCgkJCQlpZiAoICFzYXZlZC5sZW5ndGggKSB7DQoNCgkJCQkJLy8gU3RvcmUgYXJndW1lbnRzIGZvciB1c2Ugd2hlbiBoYW5kbGluZyB0aGUgaW5uZXIgbmF0aXZlIGV2ZW50DQoJCQkJCS8vIFRoZXJlIHdpbGwgYWx3YXlzIGJlIGF0IGxlYXN0IG9uZSBhcmd1bWVudCAoYW4gZXZlbnQgb2JqZWN0KSwgc28gdGhpcyBhcnJheQ0KCQkJCQkvLyB3aWxsIG5vdCBiZSBjb25mdXNlZCB3aXRoIGEgbGVmdG92ZXIgY2FwdHVyZSBvYmplY3QuDQoJCQkJCXNhdmVkID0gc2xpY2UuY2FsbCggYXJndW1lbnRzICk7DQoJCQkJCWRhdGFQcml2LnNldCggdGhpcywgdHlwZSwgc2F2ZWQgKTsNCg0KCQkJCQkvLyBUcmlnZ2VyIHRoZSBuYXRpdmUgZXZlbnQgYW5kIGNhcHR1cmUgaXRzIHJlc3VsdA0KCQkJCQkvLyBTdXBwb3J0OiBJRSA8PTkgLSAxMSsNCgkJCQkJLy8gZm9jdXMoKSBhbmQgYmx1cigpIGFyZSBhc3luY2hyb25vdXMNCgkJCQkJbm90QXN5bmMgPSBleHBlY3RTeW5jKCB0aGlzLCB0eXBlICk7DQoJCQkJCXRoaXNbIHR5cGUgXSgpOw0KCQkJCQlyZXN1bHQgPSBkYXRhUHJpdi5nZXQoIHRoaXMsIHR5cGUgKTsNCgkJCQkJaWYgKCBzYXZlZCAhPT0gcmVzdWx0IHx8IG5vdEFzeW5jICkgew0KCQkJCQkJZGF0YVByaXYuc2V0KCB0aGlzLCB0eXBlLCBmYWxzZSApOw0KCQkJCQl9IGVsc2Ugew0KCQkJCQkJcmVzdWx0ID0ge307DQoJCQkJCX0NCgkJCQkJaWYgKCBzYXZlZCAhPT0gcmVzdWx0ICkgew0KDQoJCQkJCQkvLyBDYW5jZWwgdGhlIG91dGVyIHN5bnRoZXRpYyBldmVudA0KCQkJCQkJZXZlbnQuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7DQoJCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOw0KDQoJCQkJCQkvLyBTdXBwb3J0OiBDaHJvbWUgODYrDQoJCQkJCQkvLyBJbiBDaHJvbWUsIGlmIGFuIGVsZW1lbnQgaGF2aW5nIGEgZm9jdXNvdXQgaGFuZGxlciBpcyBibHVycmVkIGJ5DQoJCQkJCQkvLyBjbGlja2luZyBvdXRzaWRlIG9mIGl0LCBpdCBpbnZva2VzIHRoZSBoYW5kbGVyIHN5bmNocm9ub3VzbHkuIElmDQoJCQkJCQkvLyB0aGF0IGhhbmRsZXIgY2FsbHMgYC5yZW1vdmUoKWAgb24gdGhlIGVsZW1lbnQsIHRoZSBkYXRhIGlzIGNsZWFyZWQsDQoJCQkJCQkvLyBsZWF2aW5nIGByZXN1bHRgIHVuZGVmaW5lZC4gV2UgbmVlZCB0byBndWFyZCBhZ2FpbnN0IHRoaXMuDQoJCQkJCQlyZXR1cm4gcmVzdWx0ICYmIHJlc3VsdC52YWx1ZTsNCgkJCQkJfQ0KDQoJCQkJLy8gSWYgdGhpcyBpcyBhbiBpbm5lciBzeW50aGV0aWMgZXZlbnQgZm9yIGFuIGV2ZW50IHdpdGggYSBidWJibGluZyBzdXJyb2dhdGUNCgkJCQkvLyAoZm9jdXMgb3IgYmx1ciksIGFzc3VtZSB0aGF0IHRoZSBzdXJyb2dhdGUgYWxyZWFkeSBwcm9wYWdhdGVkIGZyb20gdHJpZ2dlcmluZyB0aGUNCgkJCQkvLyBuYXRpdmUgZXZlbnQgYW5kIHByZXZlbnQgdGhhdCBmcm9tIGhhcHBlbmluZyBhZ2FpbiBoZXJlLg0KCQkJCS8vIFRoaXMgdGVjaG5pY2FsbHkgZ2V0cyB0aGUgb3JkZXJpbmcgd3Jvbmcgdy5yLnQuIHRvIGAudHJpZ2dlcigpYCAoaW4gd2hpY2ggdGhlDQoJCQkJLy8gYnViYmxpbmcgc3Vycm9nYXRlIHByb3BhZ2F0ZXMgKmFmdGVyKiB0aGUgbm9uLWJ1YmJsaW5nIGJhc2UpLCBidXQgdGhhdCBzZWVtcw0KCQkJCS8vIGxlc3MgYmFkIHRoYW4gZHVwbGljYXRpb24uDQoJCQkJfSBlbHNlIGlmICggKCBqUXVlcnkuZXZlbnQuc3BlY2lhbFsgdHlwZSBdIHx8IHt9ICkuZGVsZWdhdGVUeXBlICkgew0KCQkJCQlldmVudC5zdG9wUHJvcGFnYXRpb24oKTsNCgkJCQl9DQoNCgkJCS8vIElmIHRoaXMgaXMgYSBuYXRpdmUgZXZlbnQgdHJpZ2dlcmVkIGFib3ZlLCBldmVyeXRoaW5nIGlzIG5vdyBpbiBvcmRlcg0KCQkJLy8gRmlyZSBhbiBpbm5lciBzeW50aGV0aWMgZXZlbnQgd2l0aCB0aGUgb3JpZ2luYWwgYXJndW1lbnRzDQoJCQl9IGVsc2UgaWYgKCBzYXZlZC5sZW5ndGggKSB7DQoNCgkJCQkvLyAuLi5hbmQgY2FwdHVyZSB0aGUgcmVzdWx0DQoJCQkJZGF0YVByaXYuc2V0KCB0aGlzLCB0eXBlLCB7DQoJCQkJCXZhbHVlOiBqUXVlcnkuZXZlbnQudHJpZ2dlcigNCg0KCQkJCQkJLy8gU3VwcG9ydDogSUUgPD05IC0gMTErDQoJCQkJCQkvLyBFeHRlbmQgd2l0aCB0aGUgcHJvdG90eXBlIHRvIHJlc2V0IHRoZSBhYm92ZSBzdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKQ0KCQkJCQkJalF1ZXJ5LmV4dGVuZCggc2F2ZWRbIDAgXSwgalF1ZXJ5LkV2ZW50LnByb3RvdHlwZSApLA0KCQkJCQkJc2F2ZWQuc2xpY2UoIDEgKSwNCgkJCQkJCXRoaXMNCgkJCQkJKQ0KCQkJCX0gKTsNCg0KCQkJCS8vIEFib3J0IGhhbmRsaW5nIG9mIHRoZSBuYXRpdmUgZXZlbnQNCgkJCQlldmVudC5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsNCgkJCX0NCgkJfQ0KCX0gKTsNCn0NCg0KalF1ZXJ5LnJlbW92ZUV2ZW50ID0gZnVuY3Rpb24oIGVsZW0sIHR5cGUsIGhhbmRsZSApIHsNCg0KCS8vIFRoaXMgImlmIiBpcyBuZWVkZWQgZm9yIHBsYWluIG9iamVjdHMNCglpZiAoIGVsZW0ucmVtb3ZlRXZlbnRMaXN0ZW5lciApIHsNCgkJZWxlbS5yZW1vdmVFdmVudExpc3RlbmVyKCB0eXBlLCBoYW5kbGUgKTsNCgl9DQp9Ow0KDQpqUXVlcnkuRXZlbnQgPSBmdW5jdGlvbiggc3JjLCBwcm9wcyApIHsNCg0KCS8vIEFsbG93IGluc3RhbnRpYXRpb24gd2l0aG91dCB0aGUgJ25ldycga2V5d29yZA0KCWlmICggISggdGhpcyBpbnN0YW5jZW9mIGpRdWVyeS5FdmVudCApICkgew0KCQlyZXR1cm4gbmV3IGpRdWVyeS5FdmVudCggc3JjLCBwcm9wcyApOw0KCX0NCg0KCS8vIEV2ZW50IG9iamVjdA0KCWlmICggc3JjICYmIHNyYy50eXBlICkgew0KCQl0aGlzLm9yaWdpbmFsRXZlbnQgPSBzcmM7DQoJCXRoaXMudHlwZSA9IHNyYy50eXBlOw0KDQoJCS8vIEV2ZW50cyBidWJibGluZyB1cCB0aGUgZG9jdW1lbnQgbWF5IGhhdmUgYmVlbiBtYXJrZWQgYXMgcHJldmVudGVkDQoJCS8vIGJ5IGEgaGFuZGxlciBsb3dlciBkb3duIHRoZSB0cmVlOyByZWZsZWN0IHRoZSBjb3JyZWN0IHZhbHVlLg0KCQl0aGlzLmlzRGVmYXVsdFByZXZlbnRlZCA9IHNyYy5kZWZhdWx0UHJldmVudGVkIHx8DQoJCQkJc3JjLmRlZmF1bHRQcmV2ZW50ZWQgPT09IHVuZGVmaW5lZCAmJg0KDQoJCQkJLy8gU3VwcG9ydDogQW5kcm9pZCA8PTIuMyBvbmx5DQoJCQkJc3JjLnJldHVyblZhbHVlID09PSBmYWxzZSA/DQoJCQlyZXR1cm5UcnVlIDoNCgkJCXJldHVybkZhbHNlOw0KDQoJCS8vIENyZWF0ZSB0YXJnZXQgcHJvcGVydGllcw0KCQkvLyBTdXBwb3J0OiBTYWZhcmkgPD02IC0gNyBvbmx5DQoJCS8vIFRhcmdldCBzaG91bGQgbm90IGJlIGEgdGV4dCBub2RlICgjNTA0LCAjMTMxNDMpDQoJCXRoaXMudGFyZ2V0ID0gKCBzcmMudGFyZ2V0ICYmIHNyYy50YXJnZXQubm9kZVR5cGUgPT09IDMgKSA/DQoJCQlzcmMudGFyZ2V0LnBhcmVudE5vZGUgOg0KCQkJc3JjLnRhcmdldDsNCg0KCQl0aGlzLmN1cnJlbnRUYXJnZXQgPSBzcmMuY3VycmVudFRhcmdldDsNCgkJdGhpcy5yZWxhdGVkVGFyZ2V0ID0gc3JjLnJlbGF0ZWRUYXJnZXQ7DQoNCgkvLyBFdmVudCB0eXBlDQoJfSBlbHNlIHsNCgkJdGhpcy50eXBlID0gc3JjOw0KCX0NCg0KCS8vIFB1dCBleHBsaWNpdGx5IHByb3ZpZGVkIHByb3BlcnRpZXMgb250byB0aGUgZXZlbnQgb2JqZWN0DQoJaWYgKCBwcm9wcyApIHsNCgkJalF1ZXJ5LmV4dGVuZCggdGhpcywgcHJvcHMgKTsNCgl9DQoNCgkvLyBDcmVhdGUgYSB0aW1lc3RhbXAgaWYgaW5jb21pbmcgZXZlbnQgZG9lc24ndCBoYXZlIG9uZQ0KCXRoaXMudGltZVN0YW1wID0gc3JjICYmIHNyYy50aW1lU3RhbXAgfHwgRGF0ZS5ub3coKTsNCg0KCS8vIE1hcmsgaXQgYXMgZml4ZWQNCgl0aGlzWyBqUXVlcnkuZXhwYW5kbyBdID0gdHJ1ZTsNCn07DQoNCi8vIGpRdWVyeS5FdmVudCBpcyBiYXNlZCBvbiBET00zIEV2ZW50cyBhcyBzcGVjaWZpZWQgYnkgdGhlIEVDTUFTY3JpcHQgTGFuZ3VhZ2UgQmluZGluZw0KLy8gaHR0cHM6Ly93d3cudzMub3JnL1RSLzIwMDMvV0QtRE9NLUxldmVsLTMtRXZlbnRzLTIwMDMwMzMxL2VjbWEtc2NyaXB0LWJpbmRpbmcuaHRtbA0KalF1ZXJ5LkV2ZW50LnByb3RvdHlwZSA9IHsNCgljb25zdHJ1Y3RvcjogalF1ZXJ5LkV2ZW50LA0KCWlzRGVmYXVsdFByZXZlbnRlZDogcmV0dXJuRmFsc2UsDQoJaXNQcm9wYWdhdGlvblN0b3BwZWQ6IHJldHVybkZhbHNlLA0KCWlzSW1tZWRpYXRlUHJvcGFnYXRpb25TdG9wcGVkOiByZXR1cm5GYWxzZSwNCglpc1NpbXVsYXRlZDogZmFsc2UsDQoNCglwcmV2ZW50RGVmYXVsdDogZnVuY3Rpb24oKSB7DQoJCXZhciBlID0gdGhpcy5vcmlnaW5hbEV2ZW50Ow0KDQoJCXRoaXMuaXNEZWZhdWx0UHJldmVudGVkID0gcmV0dXJuVHJ1ZTsNCg0KCQlpZiAoIGUgJiYgIXRoaXMuaXNTaW11bGF0ZWQgKSB7DQoJCQllLnByZXZlbnREZWZhdWx0KCk7DQoJCX0NCgl9LA0KCXN0b3BQcm9wYWdhdGlvbjogZnVuY3Rpb24oKSB7DQoJCXZhciBlID0gdGhpcy5vcmlnaW5hbEV2ZW50Ow0KDQoJCXRoaXMuaXNQcm9wYWdhdGlvblN0b3BwZWQgPSByZXR1cm5UcnVlOw0KDQoJCWlmICggZSAmJiAhdGhpcy5pc1NpbXVsYXRlZCApIHsNCgkJCWUuc3RvcFByb3BhZ2F0aW9uKCk7DQoJCX0NCgl9LA0KCXN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbjogZnVuY3Rpb24oKSB7DQoJCXZhciBlID0gdGhpcy5vcmlnaW5hbEV2ZW50Ow0KDQoJCXRoaXMuaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQgPSByZXR1cm5UcnVlOw0KDQoJCWlmICggZSAmJiAhdGhpcy5pc1NpbXVsYXRlZCApIHsNCgkJCWUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7DQoJCX0NCg0KCQl0aGlzLnN0b3BQcm9wYWdhdGlvbigpOw0KCX0NCn07DQoNCi8vIEluY2x1ZGVzIGFsbCBjb21tb24gZXZlbnQgcHJvcHMgaW5jbHVkaW5nIEtleUV2ZW50IGFuZCBNb3VzZUV2ZW50IHNwZWNpZmljIHByb3BzDQpqUXVlcnkuZWFjaCggew0KCWFsdEtleTogdHJ1ZSwNCglidWJibGVzOiB0cnVlLA0KCWNhbmNlbGFibGU6IHRydWUsDQoJY2hhbmdlZFRvdWNoZXM6IHRydWUsDQoJY3RybEtleTogdHJ1ZSwNCglkZXRhaWw6IHRydWUsDQoJZXZlbnRQaGFzZTogdHJ1ZSwNCgltZXRhS2V5OiB0cnVlLA0KCXBhZ2VYOiB0cnVlLA0KCXBhZ2VZOiB0cnVlLA0KCXNoaWZ0S2V5OiB0cnVlLA0KCXZpZXc6IHRydWUsDQoJImNoYXIiOiB0cnVlLA0KCWNvZGU6IHRydWUsDQoJY2hhckNvZGU6IHRydWUsDQoJa2V5OiB0cnVlLA0KCWtleUNvZGU6IHRydWUsDQoJYnV0dG9uOiB0cnVlLA0KCWJ1dHRvbnM6IHRydWUsDQoJY2xpZW50WDogdHJ1ZSwNCgljbGllbnRZOiB0cnVlLA0KCW9mZnNldFg6IHRydWUsDQoJb2Zmc2V0WTogdHJ1ZSwNCglwb2ludGVySWQ6IHRydWUsDQoJcG9pbnRlclR5cGU6IHRydWUsDQoJc2NyZWVuWDogdHJ1ZSwNCglzY3JlZW5ZOiB0cnVlLA0KCXRhcmdldFRvdWNoZXM6IHRydWUsDQoJdG9FbGVtZW50OiB0cnVlLA0KCXRvdWNoZXM6IHRydWUsDQoJd2hpY2g6IHRydWUNCn0sIGpRdWVyeS5ldmVudC5hZGRQcm9wICk7DQoNCmpRdWVyeS5lYWNoKCB7IGZvY3VzOiAiZm9jdXNpbiIsIGJsdXI6ICJmb2N1c291dCIgfSwgZnVuY3Rpb24oIHR5cGUsIGRlbGVnYXRlVHlwZSApIHsNCglqUXVlcnkuZXZlbnQuc3BlY2lhbFsgdHlwZSBdID0gew0KDQoJCS8vIFV0aWxpemUgbmF0aXZlIGV2ZW50IGlmIHBvc3NpYmxlIHNvIGJsdXIvZm9jdXMgc2VxdWVuY2UgaXMgY29ycmVjdA0KCQlzZXR1cDogZnVuY3Rpb24oKSB7DQoNCgkJCS8vIENsYWltIHRoZSBmaXJzdCBoYW5kbGVyDQoJCQkvLyBkYXRhUHJpdi5zZXQoIHRoaXMsICJmb2N1cyIsIC4uLiApDQoJCQkvLyBkYXRhUHJpdi5zZXQoIHRoaXMsICJibHVyIiwgLi4uICkNCgkJCWxldmVyYWdlTmF0aXZlKCB0aGlzLCB0eXBlLCBleHBlY3RTeW5jICk7DQoNCgkJCS8vIFJldHVybiBmYWxzZSB0byBhbGxvdyBub3JtYWwgcHJvY2Vzc2luZyBpbiB0aGUgY2FsbGVyDQoJCQlyZXR1cm4gZmFsc2U7DQoJCX0sDQoJCXRyaWdnZXI6IGZ1bmN0aW9uKCkgew0KDQoJCQkvLyBGb3JjZSBzZXR1cCBiZWZvcmUgdHJpZ2dlcg0KCQkJbGV2ZXJhZ2VOYXRpdmUoIHRoaXMsIHR5cGUgKTsNCg0KCQkJLy8gUmV0dXJuIG5vbi1mYWxzZSB0byBhbGxvdyBub3JtYWwgZXZlbnQtcGF0aCBwcm9wYWdhdGlvbg0KCQkJcmV0dXJuIHRydWU7DQoJCX0sDQoNCgkJLy8gU3VwcHJlc3MgbmF0aXZlIGZvY3VzIG9yIGJsdXIgYXMgaXQncyBhbHJlYWR5IGJlaW5nIGZpcmVkDQoJCS8vIGluIGxldmVyYWdlTmF0aXZlLg0KCQlfZGVmYXVsdDogZnVuY3Rpb24oKSB7DQoJCQlyZXR1cm4gdHJ1ZTsNCgkJfSwNCg0KCQlkZWxlZ2F0ZVR5cGU6IGRlbGVnYXRlVHlwZQ0KCX07DQp9ICk7DQoNCi8vIENyZWF0ZSBtb3VzZWVudGVyL2xlYXZlIGV2ZW50cyB1c2luZyBtb3VzZW92ZXIvb3V0IGFuZCBldmVudC10aW1lIGNoZWNrcw0KLy8gc28gdGhhdCBldmVudCBkZWxlZ2F0aW9uIHdvcmtzIGluIGpRdWVyeS4NCi8vIERvIHRoZSBzYW1lIGZvciBwb2ludGVyZW50ZXIvcG9pbnRlcmxlYXZlIGFuZCBwb2ludGVyb3Zlci9wb2ludGVyb3V0DQovLw0KLy8gU3VwcG9ydDogU2FmYXJpIDcgb25seQ0KLy8gU2FmYXJpIHNlbmRzIG1vdXNlZW50ZXIgdG9vIG9mdGVuOyBzZWU6DQovLyBodHRwczovL2J1Z3MuY2hyb21pdW0ub3JnL3AvY2hyb21pdW0vaXNzdWVzL2RldGFpbD9pZD00NzAyNTgNCi8vIGZvciB0aGUgZGVzY3JpcHRpb24gb2YgdGhlIGJ1ZyAoaXQgZXhpc3RlZCBpbiBvbGRlciBDaHJvbWUgdmVyc2lvbnMgYXMgd2VsbCkuDQpqUXVlcnkuZWFjaCggew0KCW1vdXNlZW50ZXI6ICJtb3VzZW92ZXIiLA0KCW1vdXNlbGVhdmU6ICJtb3VzZW91dCIsDQoJcG9pbnRlcmVudGVyOiAicG9pbnRlcm92ZXIiLA0KCXBvaW50ZXJsZWF2ZTogInBvaW50ZXJvdXQiDQp9LCBmdW5jdGlvbiggb3JpZywgZml4ICkgew0KCWpRdWVyeS5ldmVudC5zcGVjaWFsWyBvcmlnIF0gPSB7DQoJCWRlbGVnYXRlVHlwZTogZml4LA0KCQliaW5kVHlwZTogZml4LA0KDQoJCWhhbmRsZTogZnVuY3Rpb24oIGV2ZW50ICkgew0KCQkJdmFyIHJldCwNCgkJCQl0YXJnZXQgPSB0aGlzLA0KCQkJCXJlbGF0ZWQgPSBldmVudC5yZWxhdGVkVGFyZ2V0LA0KCQkJCWhhbmRsZU9iaiA9IGV2ZW50LmhhbmRsZU9iajsNCg0KCQkJLy8gRm9yIG1vdXNlZW50ZXIvbGVhdmUgY2FsbCB0aGUgaGFuZGxlciBpZiByZWxhdGVkIGlzIG91dHNpZGUgdGhlIHRhcmdldC4NCgkJCS8vIE5COiBObyByZWxhdGVkVGFyZ2V0IGlmIHRoZSBtb3VzZSBsZWZ0L2VudGVyZWQgdGhlIGJyb3dzZXIgd2luZG93DQoJCQlpZiAoICFyZWxhdGVkIHx8ICggcmVsYXRlZCAhPT0gdGFyZ2V0ICYmICFqUXVlcnkuY29udGFpbnMoIHRhcmdldCwgcmVsYXRlZCApICkgKSB7DQoJCQkJZXZlbnQudHlwZSA9IGhhbmRsZU9iai5vcmlnVHlwZTsNCgkJCQlyZXQgPSBoYW5kbGVPYmouaGFuZGxlci5hcHBseSggdGhpcywgYXJndW1lbnRzICk7DQoJCQkJZXZlbnQudHlwZSA9IGZpeDsNCgkJCX0NCgkJCXJldHVybiByZXQ7DQoJCX0NCgl9Ow0KfSApOw0KDQpqUXVlcnkuZm4uZXh0ZW5kKCB7DQoNCglvbjogZnVuY3Rpb24oIHR5cGVzLCBzZWxlY3RvciwgZGF0YSwgZm4gKSB7DQoJCXJldHVybiBvbiggdGhpcywgdHlwZXMsIHNlbGVjdG9yLCBkYXRhLCBmbiApOw0KCX0sDQoJb25lOiBmdW5jdGlvbiggdHlwZXMsIHNlbGVjdG9yLCBkYXRhLCBmbiApIHsNCgkJcmV0dXJuIG9uKCB0aGlzLCB0eXBlcywgc2VsZWN0b3IsIGRhdGEsIGZuLCAxICk7DQoJfSwNCglvZmY6IGZ1bmN0aW9uKCB0eXBlcywgc2VsZWN0b3IsIGZuICkgew0KCQl2YXIgaGFuZGxlT2JqLCB0eXBlOw0KCQlpZiAoIHR5cGVzICYmIHR5cGVzLnByZXZlbnREZWZhdWx0ICYmIHR5cGVzLmhhbmRsZU9iaiApIHsNCg0KCQkJLy8gKCBldmVudCApICBkaXNwYXRjaGVkIGpRdWVyeS5FdmVudA0KCQkJaGFuZGxlT2JqID0gdHlwZXMuaGFuZGxlT2JqOw0KCQkJalF1ZXJ5KCB0eXBlcy5kZWxlZ2F0ZVRhcmdldCApLm9mZigNCgkJCQloYW5kbGVPYmoubmFtZXNwYWNlID8NCgkJCQkJaGFuZGxlT2JqLm9yaWdUeXBlICsgIi4iICsgaGFuZGxlT2JqLm5hbWVzcGFjZSA6DQoJCQkJCWhhbmRsZU9iai5vcmlnVHlwZSwNCgkJCQloYW5kbGVPYmouc2VsZWN0b3IsDQoJCQkJaGFuZGxlT2JqLmhhbmRsZXINCgkJCSk7DQoJCQlyZXR1cm4gdGhpczsNCgkJfQ0KCQlpZiAoIHR5cGVvZiB0eXBlcyA9PT0gIm9iamVjdCIgKSB7DQoNCgkJCS8vICggdHlwZXMtb2JqZWN0IFssIHNlbGVjdG9yXSApDQoJCQlmb3IgKCB0eXBlIGluIHR5cGVzICkgew0KCQkJCXRoaXMub2ZmKCB0eXBlLCBzZWxlY3RvciwgdHlwZXNbIHR5cGUgXSApOw0KCQkJfQ0KCQkJcmV0dXJuIHRoaXM7DQoJCX0NCgkJaWYgKCBzZWxlY3RvciA9PT0gZmFsc2UgfHwgdHlwZW9mIHNlbGVjdG9yID09PSAiZnVuY3Rpb24iICkgew0KDQoJCQkvLyAoIHR5cGVzIFssIGZuXSApDQoJCQlmbiA9IHNlbGVjdG9yOw0KCQkJc2VsZWN0b3IgPSB1bmRlZmluZWQ7DQoJCX0NCgkJaWYgKCBmbiA9PT0gZmFsc2UgKSB7DQoJCQlmbiA9IHJldHVybkZhbHNlOw0KCQl9DQoJCXJldHVybiB0aGlzLmVhY2goIGZ1bmN0aW9uKCkgew0KCQkJalF1ZXJ5LmV2ZW50LnJlbW92ZSggdGhpcywgdHlwZXMsIGZuLCBzZWxlY3RvciApOw0KCQl9ICk7DQoJfQ0KfSApOw0KDQoNCnZhcg0KDQoJLy8gU3VwcG9ydDogSUUgPD0xMCAtIDExLCBFZGdlIDEyIC0gMTMgb25seQ0KCS8vIEluIElFL0VkZ2UgdXNpbmcgcmVnZXggZ3JvdXBzIGhlcmUgY2F1c2VzIHNldmVyZSBzbG93ZG93bnMuDQoJLy8gU2VlIGh0dHBzOi8vY29ubmVjdC5taWNyb3NvZnQuY29tL0lFL2ZlZWRiYWNrL2RldGFpbHMvMTczNjUxMi8NCglybm9Jbm5lcmh0bWwgPSAvPHNjcmlwdHw8c3R5bGV8PGxpbmsvaSwNCg0KCS8vIGNoZWNrZWQ9ImNoZWNrZWQiIG9yIGNoZWNrZWQNCglyY2hlY2tlZCA9IC9jaGVja2VkXHMqKD86W149XXw9XHMqLmNoZWNrZWQuKS9pLA0KCXJjbGVhblNjcmlwdCA9IC9eXHMqPCEoPzpcW0NEQVRBXFt8LS0pfCg/OlxdXF18LS0pPlxzKiQvZzsNCg0KLy8gUHJlZmVyIGEgdGJvZHkgb3ZlciBpdHMgcGFyZW50IHRhYmxlIGZvciBjb250YWluaW5nIG5ldyByb3dzDQpmdW5jdGlvbiBtYW5pcHVsYXRpb25UYXJnZXQoIGVsZW0sIGNvbnRlbnQgKSB7DQoJaWYgKCBub2RlTmFtZSggZWxlbSwgInRhYmxlIiApICYmDQoJCW5vZGVOYW1lKCBjb250ZW50Lm5vZGVUeXBlICE9PSAxMSA/IGNvbnRlbnQgOiBjb250ZW50LmZpcnN0Q2hpbGQsICJ0ciIgKSApIHsNCg0KCQlyZXR1cm4galF1ZXJ5KCBlbGVtICkuY2hpbGRyZW4oICJ0Ym9keSIgKVsgMCBdIHx8IGVsZW07DQoJfQ0KDQoJcmV0dXJuIGVsZW07DQp9DQoNCi8vIFJlcGxhY2UvcmVzdG9yZSB0aGUgdHlwZSBhdHRyaWJ1dGUgb2Ygc2NyaXB0IGVsZW1lbnRzIGZvciBzYWZlIERPTSBtYW5pcHVsYXRpb24NCmZ1bmN0aW9uIGRpc2FibGVTY3JpcHQoIGVsZW0gKSB7DQoJZWxlbS50eXBlID0gKCBlbGVtLmdldEF0dHJpYnV0ZSggInR5cGUiICkgIT09IG51bGwgKSArICIvIiArIGVsZW0udHlwZTsNCglyZXR1cm4gZWxlbTsNCn0NCmZ1bmN0aW9uIHJlc3RvcmVTY3JpcHQoIGVsZW0gKSB7DQoJaWYgKCAoIGVsZW0udHlwZSB8fCAiIiApLnNsaWNlKCAwLCA1ICkgPT09ICJ0cnVlLyIgKSB7DQoJCWVsZW0udHlwZSA9IGVsZW0udHlwZS5zbGljZSggNSApOw0KCX0gZWxzZSB7DQoJCWVsZW0ucmVtb3ZlQXR0cmlidXRlKCAidHlwZSIgKTsNCgl9DQoNCglyZXR1cm4gZWxlbTsNCn0NCg0KZnVuY3Rpb24gY2xvbmVDb3B5RXZlbnQoIHNyYywgZGVzdCApIHsNCgl2YXIgaSwgbCwgdHlwZSwgcGRhdGFPbGQsIHVkYXRhT2xkLCB1ZGF0YUN1ciwgZXZlbnRzOw0KDQoJaWYgKCBkZXN0Lm5vZGVUeXBlICE9PSAxICkgew0KCQlyZXR1cm47DQoJfQ0KDQoJLy8gMS4gQ29weSBwcml2YXRlIGRhdGE6IGV2ZW50cywgaGFuZGxlcnMsIGV0Yy4NCglpZiAoIGRhdGFQcml2Lmhhc0RhdGEoIHNyYyApICkgew0KCQlwZGF0YU9sZCA9IGRhdGFQcml2LmdldCggc3JjICk7DQoJCWV2ZW50cyA9IHBkYXRhT2xkLmV2ZW50czsNCg0KCQlpZiAoIGV2ZW50cyApIHsNCgkJCWRhdGFQcml2LnJlbW92ZSggZGVzdCwgImhhbmRsZSBldmVudHMiICk7DQoNCgkJCWZvciAoIHR5cGUgaW4gZXZlbnRzICkgew0KCQkJCWZvciAoIGkgPSAwLCBsID0gZXZlbnRzWyB0eXBlIF0ubGVuZ3RoOyBpIDwgbDsgaSsrICkgew0KCQkJCQlqUXVlcnkuZXZlbnQuYWRkKCBkZXN0LCB0eXBlLCBldmVudHNbIHR5cGUgXVsgaSBdICk7DQoJCQkJfQ0KCQkJfQ0KCQl9DQoJfQ0KDQoJLy8gMi4gQ29weSB1c2VyIGRhdGENCglpZiAoIGRhdGFVc2VyLmhhc0RhdGEoIHNyYyApICkgew0KCQl1ZGF0YU9sZCA9IGRhdGFVc2VyLmFjY2Vzcyggc3JjICk7DQoJCXVkYXRhQ3VyID0galF1ZXJ5LmV4dGVuZCgge30sIHVkYXRhT2xkICk7DQoNCgkJZGF0YVVzZXIuc2V0KCBkZXN0LCB1ZGF0YUN1ciApOw0KCX0NCn0NCg0KLy8gRml4IElFIGJ1Z3MsIHNlZSBzdXBwb3J0IHRlc3RzDQpmdW5jdGlvbiBmaXhJbnB1dCggc3JjLCBkZXN0ICkgew0KCXZhciBub2RlTmFtZSA9IGRlc3Qubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsNCg0KCS8vIEZhaWxzIHRvIHBlcnNpc3QgdGhlIGNoZWNrZWQgc3RhdGUgb2YgYSBjbG9uZWQgY2hlY2tib3ggb3IgcmFkaW8gYnV0dG9uLg0KCWlmICggbm9kZU5hbWUgPT09ICJpbnB1dCIgJiYgcmNoZWNrYWJsZVR5cGUudGVzdCggc3JjLnR5cGUgKSApIHsNCgkJZGVzdC5jaGVja2VkID0gc3JjLmNoZWNrZWQ7DQoNCgkvLyBGYWlscyB0byByZXR1cm4gdGhlIHNlbGVjdGVkIG9wdGlvbiB0byB0aGUgZGVmYXVsdCBzZWxlY3RlZCBzdGF0ZSB3aGVuIGNsb25pbmcgb3B0aW9ucw0KCX0gZWxzZSBpZiAoIG5vZGVOYW1lID09PSAiaW5wdXQiIHx8IG5vZGVOYW1lID09PSAidGV4dGFyZWEiICkgew0KCQlkZXN0LmRlZmF1bHRWYWx1ZSA9IHNyYy5kZWZhdWx0VmFsdWU7DQoJfQ0KfQ0KDQpmdW5jdGlvbiBkb21NYW5pcCggY29sbGVjdGlvbiwgYXJncywgY2FsbGJhY2ssIGlnbm9yZWQgKSB7DQoNCgkvLyBGbGF0dGVuIGFueSBuZXN0ZWQgYXJyYXlzDQoJYXJncyA9IGZsYXQoIGFyZ3MgKTsNCg0KCXZhciBmcmFnbWVudCwgZmlyc3QsIHNjcmlwdHMsIGhhc1NjcmlwdHMsIG5vZGUsIGRvYywNCgkJaSA9IDAsDQoJCWwgPSBjb2xsZWN0aW9uLmxlbmd0aCwNCgkJaU5vQ2xvbmUgPSBsIC0gMSwNCgkJdmFsdWUgPSBhcmdzWyAwIF0sDQoJCXZhbHVlSXNGdW5jdGlvbiA9IGlzRnVuY3Rpb24oIHZhbHVlICk7DQoNCgkvLyBXZSBjYW4ndCBjbG9uZU5vZGUgZnJhZ21lbnRzIHRoYXQgY29udGFpbiBjaGVja2VkLCBpbiBXZWJLaXQNCglpZiAoIHZhbHVlSXNGdW5jdGlvbiB8fA0KCQkJKCBsID4gMSAmJiB0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciICYmDQoJCQkJIXN1cHBvcnQuY2hlY2tDbG9uZSAmJiByY2hlY2tlZC50ZXN0KCB2YWx1ZSApICkgKSB7DQoJCXJldHVybiBjb2xsZWN0aW9uLmVhY2goIGZ1bmN0aW9uKCBpbmRleCApIHsNCgkJCXZhciBzZWxmID0gY29sbGVjdGlvbi5lcSggaW5kZXggKTsNCgkJCWlmICggdmFsdWVJc0Z1bmN0aW9uICkgew0KCQkJCWFyZ3NbIDAgXSA9IHZhbHVlLmNhbGwoIHRoaXMsIGluZGV4LCBzZWxmLmh0bWwoKSApOw0KCQkJfQ0KCQkJZG9tTWFuaXAoIHNlbGYsIGFyZ3MsIGNhbGxiYWNrLCBpZ25vcmVkICk7DQoJCX0gKTsNCgl9DQoNCglpZiAoIGwgKSB7DQoJCWZyYWdtZW50ID0gYnVpbGRGcmFnbWVudCggYXJncywgY29sbGVjdGlvblsgMCBdLm93bmVyRG9jdW1lbnQsIGZhbHNlLCBjb2xsZWN0aW9uLCBpZ25vcmVkICk7DQoJCWZpcnN0ID0gZnJhZ21lbnQuZmlyc3RDaGlsZDsNCg0KCQlpZiAoIGZyYWdtZW50LmNoaWxkTm9kZXMubGVuZ3RoID09PSAxICkgew0KCQkJZnJhZ21lbnQgPSBmaXJzdDsNCgkJfQ0KDQoJCS8vIFJlcXVpcmUgZWl0aGVyIG5ldyBjb250ZW50IG9yIGFuIGludGVyZXN0IGluIGlnbm9yZWQgZWxlbWVudHMgdG8gaW52b2tlIHRoZSBjYWxsYmFjaw0KCQlpZiAoIGZpcnN0IHx8IGlnbm9yZWQgKSB7DQoJCQlzY3JpcHRzID0galF1ZXJ5Lm1hcCggZ2V0QWxsKCBmcmFnbWVudCwgInNjcmlwdCIgKSwgZGlzYWJsZVNjcmlwdCApOw0KCQkJaGFzU2NyaXB0cyA9IHNjcmlwdHMubGVuZ3RoOw0KDQoJCQkvLyBVc2UgdGhlIG9yaWdpbmFsIGZyYWdtZW50IGZvciB0aGUgbGFzdCBpdGVtDQoJCQkvLyBpbnN0ZWFkIG9mIHRoZSBmaXJzdCBiZWNhdXNlIGl0IGNhbiBlbmQgdXANCgkJCS8vIGJlaW5nIGVtcHRpZWQgaW5jb3JyZWN0bHkgaW4gY2VydGFpbiBzaXR1YXRpb25zICgjODA3MCkuDQoJCQlmb3IgKCA7IGkgPCBsOyBpKysgKSB7DQoJCQkJbm9kZSA9IGZyYWdtZW50Ow0KDQoJCQkJaWYgKCBpICE9PSBpTm9DbG9uZSApIHsNCgkJCQkJbm9kZSA9IGpRdWVyeS5jbG9uZSggbm9kZSwgdHJ1ZSwgdHJ1ZSApOw0KDQoJCQkJCS8vIEtlZXAgcmVmZXJlbmNlcyB0byBjbG9uZWQgc2NyaXB0cyBmb3IgbGF0ZXIgcmVzdG9yYXRpb24NCgkJCQkJaWYgKCBoYXNTY3JpcHRzICkgew0KDQoJCQkJCQkvLyBTdXBwb3J0OiBBbmRyb2lkIDw9NC4wIG9ubHksIFBoYW50b21KUyAxIG9ubHkNCgkJCQkJCS8vIHB1c2guYXBwbHkoXywgYXJyYXlsaWtlKSB0aHJvd3Mgb24gYW5jaWVudCBXZWJLaXQNCgkJCQkJCWpRdWVyeS5tZXJnZSggc2NyaXB0cywgZ2V0QWxsKCBub2RlLCAic2NyaXB0IiApICk7DQoJCQkJCX0NCgkJCQl9DQoNCgkJCQljYWxsYmFjay5jYWxsKCBjb2xsZWN0aW9uWyBpIF0sIG5vZGUsIGkgKTsNCgkJCX0NCg0KCQkJaWYgKCBoYXNTY3JpcHRzICkgew0KCQkJCWRvYyA9IHNjcmlwdHNbIHNjcmlwdHMubGVuZ3RoIC0gMSBdLm93bmVyRG9jdW1lbnQ7DQoNCgkJCQkvLyBSZWVuYWJsZSBzY3JpcHRzDQoJCQkJalF1ZXJ5Lm1hcCggc2NyaXB0cywgcmVzdG9yZVNjcmlwdCApOw0KDQoJCQkJLy8gRXZhbHVhdGUgZXhlY3V0YWJsZSBzY3JpcHRzIG9uIGZpcnN0IGRvY3VtZW50IGluc2VydGlvbg0KCQkJCWZvciAoIGkgPSAwOyBpIDwgaGFzU2NyaXB0czsgaSsrICkgew0KCQkJCQlub2RlID0gc2NyaXB0c1sgaSBdOw0KCQkJCQlpZiAoIHJzY3JpcHRUeXBlLnRlc3QoIG5vZGUudHlwZSB8fCAiIiApICYmDQoJCQkJCQkhZGF0YVByaXYuYWNjZXNzKCBub2RlLCAiZ2xvYmFsRXZhbCIgKSAmJg0KCQkJCQkJalF1ZXJ5LmNvbnRhaW5zKCBkb2MsIG5vZGUgKSApIHsNCg0KCQkJCQkJaWYgKCBub2RlLnNyYyAmJiAoIG5vZGUudHlwZSB8fCAiIiApLnRvTG93ZXJDYXNlKCkgICE9PSAibW9kdWxlIiApIHsNCg0KCQkJCQkJCS8vIE9wdGlvbmFsIEFKQVggZGVwZW5kZW5jeSwgYnV0IHdvbid0IHJ1biBzY3JpcHRzIGlmIG5vdCBwcmVzZW50DQoJCQkJCQkJaWYgKCBqUXVlcnkuX2V2YWxVcmwgJiYgIW5vZGUubm9Nb2R1bGUgKSB7DQoJCQkJCQkJCWpRdWVyeS5fZXZhbFVybCggbm9kZS5zcmMsIHsNCgkJCQkJCQkJCW5vbmNlOiBub2RlLm5vbmNlIHx8IG5vZGUuZ2V0QXR0cmlidXRlKCAibm9uY2UiICkNCgkJCQkJCQkJfSwgZG9jICk7DQoJCQkJCQkJfQ0KCQkJCQkJfSBlbHNlIHsNCgkJCQkJCQlET01FdmFsKCBub2RlLnRleHRDb250ZW50LnJlcGxhY2UoIHJjbGVhblNjcmlwdCwgIiIgKSwgbm9kZSwgZG9jICk7DQoJCQkJCQl9DQoJCQkJCX0NCgkJCQl9DQoJCQl9DQoJCX0NCgl9DQoNCglyZXR1cm4gY29sbGVjdGlvbjsNCn0NCg0KZnVuY3Rpb24gcmVtb3ZlKCBlbGVtLCBzZWxlY3Rvciwga2VlcERhdGEgKSB7DQoJdmFyIG5vZGUsDQoJCW5vZGVzID0gc2VsZWN0b3IgPyBqUXVlcnkuZmlsdGVyKCBzZWxlY3RvciwgZWxlbSApIDogZWxlbSwNCgkJaSA9IDA7DQoNCglmb3IgKCA7ICggbm9kZSA9IG5vZGVzWyBpIF0gKSAhPSBudWxsOyBpKysgKSB7DQoJCWlmICggIWtlZXBEYXRhICYmIG5vZGUubm9kZVR5cGUgPT09IDEgKSB7DQoJCQlqUXVlcnkuY2xlYW5EYXRhKCBnZXRBbGwoIG5vZGUgKSApOw0KCQl9DQoNCgkJaWYgKCBub2RlLnBhcmVudE5vZGUgKSB7DQoJCQlpZiAoIGtlZXBEYXRhICYmIGlzQXR0YWNoZWQoIG5vZGUgKSApIHsNCgkJCQlzZXRHbG9iYWxFdmFsKCBnZXRBbGwoIG5vZGUsICJzY3JpcHQiICkgKTsNCgkJCX0NCgkJCW5vZGUucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCggbm9kZSApOw0KCQl9DQoJfQ0KDQoJcmV0dXJuIGVsZW07DQp9DQoNCmpRdWVyeS5leHRlbmQoIHsNCglodG1sUHJlZmlsdGVyOiBmdW5jdGlvbiggaHRtbCApIHsNCgkJcmV0dXJuIGh0bWw7DQoJfSwNCg0KCWNsb25lOiBmdW5jdGlvbiggZWxlbSwgZGF0YUFuZEV2ZW50cywgZGVlcERhdGFBbmRFdmVudHMgKSB7DQoJCXZhciBpLCBsLCBzcmNFbGVtZW50cywgZGVzdEVsZW1lbnRzLA0KCQkJY2xvbmUgPSBlbGVtLmNsb25lTm9kZSggdHJ1ZSApLA0KCQkJaW5QYWdlID0gaXNBdHRhY2hlZCggZWxlbSApOw0KDQoJCS8vIEZpeCBJRSBjbG9uaW5nIGlzc3Vlcw0KCQlpZiAoICFzdXBwb3J0Lm5vQ2xvbmVDaGVja2VkICYmICggZWxlbS5ub2RlVHlwZSA9PT0gMSB8fCBlbGVtLm5vZGVUeXBlID09PSAxMSApICYmDQoJCQkJIWpRdWVyeS5pc1hNTERvYyggZWxlbSApICkgew0KDQoJCQkvLyBXZSBlc2NoZXcgU2l6emxlIGhlcmUgZm9yIHBlcmZvcm1hbmNlIHJlYXNvbnM6IGh0dHBzOi8vanNwZXJmLmNvbS9nZXRhbGwtdnMtc2l6emxlLzINCgkJCWRlc3RFbGVtZW50cyA9IGdldEFsbCggY2xvbmUgKTsNCgkJCXNyY0VsZW1lbnRzID0gZ2V0QWxsKCBlbGVtICk7DQoNCgkJCWZvciAoIGkgPSAwLCBsID0gc3JjRWxlbWVudHMubGVuZ3RoOyBpIDwgbDsgaSsrICkgew0KCQkJCWZpeElucHV0KCBzcmNFbGVtZW50c1sgaSBdLCBkZXN0RWxlbWVudHNbIGkgXSApOw0KCQkJfQ0KCQl9DQoNCgkJLy8gQ29weSB0aGUgZXZlbnRzIGZyb20gdGhlIG9yaWdpbmFsIHRvIHRoZSBjbG9uZQ0KCQlpZiAoIGRhdGFBbmRFdmVudHMgKSB7DQoJCQlpZiAoIGRlZXBEYXRhQW5kRXZlbnRzICkgew0KCQkJCXNyY0VsZW1lbnRzID0gc3JjRWxlbWVudHMgfHwgZ2V0QWxsKCBlbGVtICk7DQoJCQkJZGVzdEVsZW1lbnRzID0gZGVzdEVsZW1lbnRzIHx8IGdldEFsbCggY2xvbmUgKTsNCg0KCQkJCWZvciAoIGkgPSAwLCBsID0gc3JjRWxlbWVudHMubGVuZ3RoOyBpIDwgbDsgaSsrICkgew0KCQkJCQljbG9uZUNvcHlFdmVudCggc3JjRWxlbWVudHNbIGkgXSwgZGVzdEVsZW1lbnRzWyBpIF0gKTsNCgkJCQl9DQoJCQl9IGVsc2Ugew0KCQkJCWNsb25lQ29weUV2ZW50KCBlbGVtLCBjbG9uZSApOw0KCQkJfQ0KCQl9DQoNCgkJLy8gUHJlc2VydmUgc2NyaXB0IGV2YWx1YXRpb24gaGlzdG9yeQ0KCQlkZXN0RWxlbWVudHMgPSBnZXRBbGwoIGNsb25lLCAic2NyaXB0IiApOw0KCQlpZiAoIGRlc3RFbGVtZW50cy5sZW5ndGggPiAwICkgew0KCQkJc2V0R2xvYmFsRXZhbCggZGVzdEVsZW1lbnRzLCAhaW5QYWdlICYmIGdldEFsbCggZWxlbSwgInNjcmlwdCIgKSApOw0KCQl9DQoNCgkJLy8gUmV0dXJuIHRoZSBjbG9uZWQgc2V0DQoJCXJldHVybiBjbG9uZTsNCgl9LA0KDQoJY2xlYW5EYXRhOiBmdW5jdGlvbiggZWxlbXMgKSB7DQoJCXZhciBkYXRhLCBlbGVtLCB0eXBlLA0KCQkJc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsLA0KCQkJaSA9IDA7DQoNCgkJZm9yICggOyAoIGVsZW0gPSBlbGVtc1sgaSBdICkgIT09IHVuZGVmaW5lZDsgaSsrICkgew0KCQkJaWYgKCBhY2NlcHREYXRhKCBlbGVtICkgKSB7DQoJCQkJaWYgKCAoIGRhdGEgPSBlbGVtWyBkYXRhUHJpdi5leHBhbmRvIF0gKSApIHsNCgkJCQkJaWYgKCBkYXRhLmV2ZW50cyApIHsNCgkJCQkJCWZvciAoIHR5cGUgaW4gZGF0YS5ldmVudHMgKSB7DQoJCQkJCQkJaWYgKCBzcGVjaWFsWyB0eXBlIF0gKSB7DQoJCQkJCQkJCWpRdWVyeS5ldmVudC5yZW1vdmUoIGVsZW0sIHR5cGUgKTsNCg0KCQkJCQkJCS8vIFRoaXMgaXMgYSBzaG9ydGN1dCB0byBhdm9pZCBqUXVlcnkuZXZlbnQucmVtb3ZlJ3Mgb3ZlcmhlYWQNCgkJCQkJCQl9IGVsc2Ugew0KCQkJCQkJCQlqUXVlcnkucmVtb3ZlRXZlbnQoIGVsZW0sIHR5cGUsIGRhdGEuaGFuZGxlICk7DQoJCQkJCQkJfQ0KCQkJCQkJfQ0KCQkJCQl9DQoNCgkJCQkJLy8gU3VwcG9ydDogQ2hyb21lIDw9MzUgLSA0NSsNCgkJCQkJLy8gQXNzaWduIHVuZGVmaW5lZCBpbnN0ZWFkIG9mIHVzaW5nIGRlbGV0ZSwgc2VlIERhdGEjcmVtb3ZlDQoJCQkJCWVsZW1bIGRhdGFQcml2LmV4cGFuZG8gXSA9IHVuZGVmaW5lZDsNCgkJCQl9DQoJCQkJaWYgKCBlbGVtWyBkYXRhVXNlci5leHBhbmRvIF0gKSB7DQoNCgkJCQkJLy8gU3VwcG9ydDogQ2hyb21lIDw9MzUgLSA0NSsNCgkJCQkJLy8gQXNzaWduIHVuZGVmaW5lZCBpbnN0ZWFkIG9mIHVzaW5nIGRlbGV0ZSwgc2VlIERhdGEjcmVtb3ZlDQoJCQkJCWVsZW1bIGRhdGFVc2VyLmV4cGFuZG8gXSA9IHVuZGVmaW5lZDsNCgkJCQl9DQoJCQl9DQoJCX0NCgl9DQp9ICk7DQoNCmpRdWVyeS5mbi5leHRlbmQoIHsNCglkZXRhY2g6IGZ1bmN0aW9uKCBzZWxlY3RvciApIHsNCgkJcmV0dXJuIHJlbW92ZSggdGhpcywgc2VsZWN0b3IsIHRydWUgKTsNCgl9LA0KDQoJcmVtb3ZlOiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7DQoJCXJldHVybiByZW1vdmUoIHRoaXMsIHNlbGVjdG9yICk7DQoJfSwNCg0KCXRleHQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsNCgkJcmV0dXJuIGFjY2VzcyggdGhpcywgZnVuY3Rpb24oIHZhbHVlICkgew0KCQkJcmV0dXJuIHZhbHVlID09PSB1bmRlZmluZWQgPw0KCQkJCWpRdWVyeS50ZXh0KCB0aGlzICkgOg0KCQkJCXRoaXMuZW1wdHkoKS5lYWNoKCBmdW5jdGlvbigpIHsNCgkJCQkJaWYgKCB0aGlzLm5vZGVUeXBlID09PSAxIHx8IHRoaXMubm9kZVR5cGUgPT09IDExIHx8IHRoaXMubm9kZVR5cGUgPT09IDkgKSB7DQoJCQkJCQl0aGlzLnRleHRDb250ZW50ID0gdmFsdWU7DQoJCQkJCX0NCgkJCQl9ICk7DQoJCX0sIG51bGwsIHZhbHVlLCBhcmd1bWVudHMubGVuZ3RoICk7DQoJfSwNCg0KCWFwcGVuZDogZnVuY3Rpb24oKSB7DQoJCXJldHVybiBkb21NYW5pcCggdGhpcywgYXJndW1lbnRzLCBmdW5jdGlvbiggZWxlbSApIHsNCgkJCWlmICggdGhpcy5ub2RlVHlwZSA9PT0gMSB8fCB0aGlzLm5vZGVUeXBlID09PSAxMSB8fCB0aGlzLm5vZGVUeXBlID09PSA5ICkgew0KCQkJCXZhciB0YXJnZXQgPSBtYW5pcHVsYXRpb25UYXJnZXQoIHRoaXMsIGVsZW0gKTsNCgkJCQl0YXJnZXQuYXBwZW5kQ2hpbGQoIGVsZW0gKTsNCgkJCX0NCgkJfSApOw0KCX0sDQoNCglwcmVwZW5kOiBmdW5jdGlvbigpIHsNCgkJcmV0dXJuIGRvbU1hbmlwKCB0aGlzLCBhcmd1bWVudHMsIGZ1bmN0aW9uKCBlbGVtICkgew0KCQkJaWYgKCB0aGlzLm5vZGVUeXBlID09PSAxIHx8IHRoaXMubm9kZVR5cGUgPT09IDExIHx8IHRoaXMubm9kZVR5cGUgPT09IDkgKSB7DQoJCQkJdmFyIHRhcmdldCA9IG1hbmlwdWxhdGlvblRhcmdldCggdGhpcywgZWxlbSApOw0KCQkJCXRhcmdldC5pbnNlcnRCZWZvcmUoIGVsZW0sIHRhcmdldC5maXJzdENoaWxkICk7DQoJCQl9DQoJCX0gKTsNCgl9LA0KDQoJYmVmb3JlOiBmdW5jdGlvbigpIHsNCgkJcmV0dXJuIGRvbU1hbmlwKCB0aGlzLCBhcmd1bWVudHMsIGZ1bmN0aW9uKCBlbGVtICkgew0KCQkJaWYgKCB0aGlzLnBhcmVudE5vZGUgKSB7DQoJCQkJdGhpcy5wYXJlbnROb2RlLmluc2VydEJlZm9yZSggZWxlbSwgdGhpcyApOw0KCQkJfQ0KCQl9ICk7DQoJfSwNCg0KCWFmdGVyOiBmdW5jdGlvbigpIHsNCgkJcmV0dXJuIGRvbU1hbmlwKCB0aGlzLCBhcmd1bWVudHMsIGZ1bmN0aW9uKCBlbGVtICkgew0KCQkJaWYgKCB0aGlzLnBhcmVudE5vZGUgKSB7DQoJCQkJdGhpcy5wYXJlbnROb2RlLmluc2VydEJlZm9yZSggZWxlbSwgdGhpcy5uZXh0U2libGluZyApOw0KCQkJfQ0KCQl9ICk7DQoJfSwNCg0KCWVtcHR5OiBmdW5jdGlvbigpIHsNCgkJdmFyIGVsZW0sDQoJCQlpID0gMDsNCg0KCQlmb3IgKCA7ICggZWxlbSA9IHRoaXNbIGkgXSApICE9IG51bGw7IGkrKyApIHsNCgkJCWlmICggZWxlbS5ub2RlVHlwZSA9PT0gMSApIHsNCg0KCQkJCS8vIFByZXZlbnQgbWVtb3J5IGxlYWtzDQoJCQkJalF1ZXJ5LmNsZWFuRGF0YSggZ2V0QWxsKCBlbGVtLCBmYWxzZSApICk7DQoNCgkJCQkvLyBSZW1vdmUgYW55IHJlbWFpbmluZyBub2Rlcw0KCQkJCWVsZW0udGV4dENvbnRlbnQgPSAiIjsNCgkJCX0NCgkJfQ0KDQoJCXJldHVybiB0aGlzOw0KCX0sDQoNCgljbG9uZTogZnVuY3Rpb24oIGRhdGFBbmRFdmVudHMsIGRlZXBEYXRhQW5kRXZlbnRzICkgew0KCQlkYXRhQW5kRXZlbnRzID0gZGF0YUFuZEV2ZW50cyA9PSBudWxsID8gZmFsc2UgOiBkYXRhQW5kRXZlbnRzOw0KCQlkZWVwRGF0YUFuZEV2ZW50cyA9IGRlZXBEYXRhQW5kRXZlbnRzID09IG51bGwgPyBkYXRhQW5kRXZlbnRzIDogZGVlcERhdGFBbmRFdmVudHM7DQoNCgkJcmV0dXJuIHRoaXMubWFwKCBmdW5jdGlvbigpIHsNCgkJCXJldHVybiBqUXVlcnkuY2xvbmUoIHRoaXMsIGRhdGFBbmRFdmVudHMsIGRlZXBEYXRhQW5kRXZlbnRzICk7DQoJCX0gKTsNCgl9LA0KDQoJaHRtbDogZnVuY3Rpb24oIHZhbHVlICkgew0KCQlyZXR1cm4gYWNjZXNzKCB0aGlzLCBmdW5jdGlvbiggdmFsdWUgKSB7DQoJCQl2YXIgZWxlbSA9IHRoaXNbIDAgXSB8fCB7fSwNCgkJCQlpID0gMCwNCgkJCQlsID0gdGhpcy5sZW5ndGg7DQoNCgkJCWlmICggdmFsdWUgPT09IHVuZGVmaW5lZCAmJiBlbGVtLm5vZGVUeXBlID09PSAxICkgew0KCQkJCXJldHVybiBlbGVtLmlubmVySFRNTDsNCgkJCX0NCg0KCQkJLy8gU2VlIGlmIHdlIGNhbiB0YWtlIGEgc2hvcnRjdXQgYW5kIGp1c3QgdXNlIGlubmVySFRNTA0KCQkJaWYgKCB0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciICYmICFybm9Jbm5lcmh0bWwudGVzdCggdmFsdWUgKSAmJg0KCQkJCSF3cmFwTWFwWyAoIHJ0YWdOYW1lLmV4ZWMoIHZhbHVlICkgfHwgWyAiIiwgIiIgXSApWyAxIF0udG9Mb3dlckNhc2UoKSBdICkgew0KDQoJCQkJdmFsdWUgPSBqUXVlcnkuaHRtbFByZWZpbHRlciggdmFsdWUgKTsNCg0KCQkJCXRyeSB7DQoJCQkJCWZvciAoIDsgaSA8IGw7IGkrKyApIHsNCgkJCQkJCWVsZW0gPSB0aGlzWyBpIF0gfHwge307DQoNCgkJCQkJCS8vIFJlbW92ZSBlbGVtZW50IG5vZGVzIGFuZCBwcmV2ZW50IG1lbW9yeSBsZWFrcw0KCQkJCQkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxICkgew0KCQkJCQkJCWpRdWVyeS5jbGVhbkRhdGEoIGdldEFsbCggZWxlbSwgZmFsc2UgKSApOw0KCQkJCQkJCWVsZW0uaW5uZXJIVE1MID0gdmFsdWU7DQoJCQkJCQl9DQoJCQkJCX0NCg0KCQkJCQllbGVtID0gMDsNCg0KCQkJCS8vIElmIHVzaW5nIGlubmVySFRNTCB0aHJvd3MgYW4gZXhjZXB0aW9uLCB1c2UgdGhlIGZhbGxiYWNrIG1ldGhvZA0KCQkJCX0gY2F0Y2ggKCBlICkge30NCgkJCX0NCg0KCQkJaWYgKCBlbGVtICkgew0KCQkJCXRoaXMuZW1wdHkoKS5hcHBlbmQoIHZhbHVlICk7DQoJCQl9DQoJCX0sIG51bGwsIHZhbHVlLCBhcmd1bWVudHMubGVuZ3RoICk7DQoJfSwNCg0KCXJlcGxhY2VXaXRoOiBmdW5jdGlvbigpIHsNCgkJdmFyIGlnbm9yZWQgPSBbXTsNCg0KCQkvLyBNYWtlIHRoZSBjaGFuZ2VzLCByZXBsYWNpbmcgZWFjaCBub24taWdub3JlZCBjb250ZXh0IGVsZW1lbnQgd2l0aCB0aGUgbmV3IGNvbnRlbnQNCgkJcmV0dXJuIGRvbU1hbmlwKCB0aGlzLCBhcmd1bWVudHMsIGZ1bmN0aW9uKCBlbGVtICkgew0KCQkJdmFyIHBhcmVudCA9IHRoaXMucGFyZW50Tm9kZTsNCg0KCQkJaWYgKCBqUXVlcnkuaW5BcnJheSggdGhpcywgaWdub3JlZCApIDwgMCApIHsNCgkJCQlqUXVlcnkuY2xlYW5EYXRhKCBnZXRBbGwoIHRoaXMgKSApOw0KCQkJCWlmICggcGFyZW50ICkgew0KCQkJCQlwYXJlbnQucmVwbGFjZUNoaWxkKCBlbGVtLCB0aGlzICk7DQoJCQkJfQ0KCQkJfQ0KDQoJCS8vIEZvcmNlIGNhbGxiYWNrIGludm9jYXRpb24NCgkJfSwgaWdub3JlZCApOw0KCX0NCn0gKTsNCg0KalF1ZXJ5LmVhY2goIHsNCglhcHBlbmRUbzogImFwcGVuZCIsDQoJcHJlcGVuZFRvOiAicHJlcGVuZCIsDQoJaW5zZXJ0QmVmb3JlOiAiYmVmb3JlIiwNCglpbnNlcnRBZnRlcjogImFmdGVyIiwNCglyZXBsYWNlQWxsOiAicmVwbGFjZVdpdGgiDQp9LCBmdW5jdGlvbiggbmFtZSwgb3JpZ2luYWwgKSB7DQoJalF1ZXJ5LmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggc2VsZWN0b3IgKSB7DQoJCXZhciBlbGVtcywNCgkJCXJldCA9IFtdLA0KCQkJaW5zZXJ0ID0galF1ZXJ5KCBzZWxlY3RvciApLA0KCQkJbGFzdCA9IGluc2VydC5sZW5ndGggLSAxLA0KCQkJaSA9IDA7DQoNCgkJZm9yICggOyBpIDw9IGxhc3Q7IGkrKyApIHsNCgkJCWVsZW1zID0gaSA9PT0gbGFzdCA/IHRoaXMgOiB0aGlzLmNsb25lKCB0cnVlICk7DQoJCQlqUXVlcnkoIGluc2VydFsgaSBdIClbIG9yaWdpbmFsIF0oIGVsZW1zICk7DQoNCgkJCS8vIFN1cHBvcnQ6IEFuZHJvaWQgPD00LjAgb25seSwgUGhhbnRvbUpTIDEgb25seQ0KCQkJLy8gLmdldCgpIGJlY2F1c2UgcHVzaC5hcHBseShfLCBhcnJheWxpa2UpIHRocm93cyBvbiBhbmNpZW50IFdlYktpdA0KCQkJcHVzaC5hcHBseSggcmV0LCBlbGVtcy5nZXQoKSApOw0KCQl9DQoNCgkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCByZXQgKTsNCgl9Ow0KfSApOw0KdmFyIHJudW1ub25weCA9IG5ldyBSZWdFeHAoICJeKCIgKyBwbnVtICsgIikoPyFweClbYS16JV0rJCIsICJpIiApOw0KDQp2YXIgZ2V0U3R5bGVzID0gZnVuY3Rpb24oIGVsZW0gKSB7DQoNCgkJLy8gU3VwcG9ydDogSUUgPD0xMSBvbmx5LCBGaXJlZm94IDw9MzAgKCMxNTA5OCwgIzE0MTUwKQ0KCQkvLyBJRSB0aHJvd3Mgb24gZWxlbWVudHMgY3JlYXRlZCBpbiBwb3B1cHMNCgkJLy8gRkYgbWVhbndoaWxlIHRocm93cyBvbiBmcmFtZSBlbGVtZW50cyB0aHJvdWdoICJkZWZhdWx0Vmlldy5nZXRDb21wdXRlZFN0eWxlIg0KCQl2YXIgdmlldyA9IGVsZW0ub3duZXJEb2N1bWVudC5kZWZhdWx0VmlldzsNCg0KCQlpZiAoICF2aWV3IHx8ICF2aWV3Lm9wZW5lciApIHsNCgkJCXZpZXcgPSB3aW5kb3c7DQoJCX0NCg0KCQlyZXR1cm4gdmlldy5nZXRDb21wdXRlZFN0eWxlKCBlbGVtICk7DQoJfTsNCg0KdmFyIHN3YXAgPSBmdW5jdGlvbiggZWxlbSwgb3B0aW9ucywgY2FsbGJhY2sgKSB7DQoJdmFyIHJldCwgbmFtZSwNCgkJb2xkID0ge307DQoNCgkvLyBSZW1lbWJlciB0aGUgb2xkIHZhbHVlcywgYW5kIGluc2VydCB0aGUgbmV3IG9uZXMNCglmb3IgKCBuYW1lIGluIG9wdGlvbnMgKSB7DQoJCW9sZFsgbmFtZSBdID0gZWxlbS5zdHlsZVsgbmFtZSBdOw0KCQllbGVtLnN0eWxlWyBuYW1lIF0gPSBvcHRpb25zWyBuYW1lIF07DQoJfQ0KDQoJcmV0ID0gY2FsbGJhY2suY2FsbCggZWxlbSApOw0KDQoJLy8gUmV2ZXJ0IHRoZSBvbGQgdmFsdWVzDQoJZm9yICggbmFtZSBpbiBvcHRpb25zICkgew0KCQllbGVtLnN0eWxlWyBuYW1lIF0gPSBvbGRbIG5hbWUgXTsNCgl9DQoNCglyZXR1cm4gcmV0Ow0KfTsNCg0KDQp2YXIgcmJveFN0eWxlID0gbmV3IFJlZ0V4cCggY3NzRXhwYW5kLmpvaW4oICJ8IiApLCAiaSIgKTsNCg0KDQoNCiggZnVuY3Rpb24oKSB7DQoNCgkvLyBFeGVjdXRpbmcgYm90aCBwaXhlbFBvc2l0aW9uICYgYm94U2l6aW5nUmVsaWFibGUgdGVzdHMgcmVxdWlyZSBvbmx5IG9uZSBsYXlvdXQNCgkvLyBzbyB0aGV5J3JlIGV4ZWN1dGVkIGF0IHRoZSBzYW1lIHRpbWUgdG8gc2F2ZSB0aGUgc2Vjb25kIGNvbXB1dGF0aW9uLg0KCWZ1bmN0aW9uIGNvbXB1dGVTdHlsZVRlc3RzKCkgew0KDQoJCS8vIFRoaXMgaXMgYSBzaW5nbGV0b24sIHdlIG5lZWQgdG8gZXhlY3V0ZSBpdCBvbmx5IG9uY2UNCgkJaWYgKCAhZGl2ICkgew0KCQkJcmV0dXJuOw0KCQl9DQoNCgkJY29udGFpbmVyLnN0eWxlLmNzc1RleHQgPSAicG9zaXRpb246YWJzb2x1dGU7bGVmdDotMTExMTFweDt3aWR0aDo2MHB4OyIgKw0KCQkJIm1hcmdpbi10b3A6MXB4O3BhZGRpbmc6MDtib3JkZXI6MCI7DQoJCWRpdi5zdHlsZS5jc3NUZXh0ID0NCgkJCSJwb3NpdGlvbjpyZWxhdGl2ZTtkaXNwbGF5OmJsb2NrO2JveC1zaXppbmc6Ym9yZGVyLWJveDtvdmVyZmxvdzpzY3JvbGw7IiArDQoJCQkibWFyZ2luOmF1dG87Ym9yZGVyOjFweDtwYWRkaW5nOjFweDsiICsNCgkJCSJ3aWR0aDo2MCU7dG9wOjElIjsNCgkJZG9jdW1lbnRFbGVtZW50LmFwcGVuZENoaWxkKCBjb250YWluZXIgKS5hcHBlbmRDaGlsZCggZGl2ICk7DQoNCgkJdmFyIGRpdlN0eWxlID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUoIGRpdiApOw0KCQlwaXhlbFBvc2l0aW9uVmFsID0gZGl2U3R5bGUudG9wICE9PSAiMSUiOw0KDQoJCS8vIFN1cHBvcnQ6IEFuZHJvaWQgNC4wIC0gNC4zIG9ubHksIEZpcmVmb3ggPD0zIC0gNDQNCgkJcmVsaWFibGVNYXJnaW5MZWZ0VmFsID0gcm91bmRQaXhlbE1lYXN1cmVzKCBkaXZTdHlsZS5tYXJnaW5MZWZ0ICkgPT09IDEyOw0KDQoJCS8vIFN1cHBvcnQ6IEFuZHJvaWQgNC4wIC0gNC4zIG9ubHksIFNhZmFyaSA8PTkuMSAtIDEwLjEsIGlPUyA8PTcuMCAtIDkuMw0KCQkvLyBTb21lIHN0eWxlcyBjb21lIGJhY2sgd2l0aCBwZXJjZW50YWdlIHZhbHVlcywgZXZlbiB0aG91Z2ggdGhleSBzaG91bGRuJ3QNCgkJZGl2LnN0eWxlLnJpZ2h0ID0gIjYwJSI7DQoJCXBpeGVsQm94U3R5bGVzVmFsID0gcm91bmRQaXhlbE1lYXN1cmVzKCBkaXZTdHlsZS5yaWdodCApID09PSAzNjsNCg0KCQkvLyBTdXBwb3J0OiBJRSA5IC0gMTEgb25seQ0KCQkvLyBEZXRlY3QgbWlzcmVwb3J0aW5nIG9mIGNvbnRlbnQgZGltZW5zaW9ucyBmb3IgYm94LXNpemluZzpib3JkZXItYm94IGVsZW1lbnRzDQoJCWJveFNpemluZ1JlbGlhYmxlVmFsID0gcm91bmRQaXhlbE1lYXN1cmVzKCBkaXZTdHlsZS53aWR0aCApID09PSAzNjsNCg0KCQkvLyBTdXBwb3J0OiBJRSA5IG9ubHkNCgkJLy8gRGV0ZWN0IG92ZXJmbG93OnNjcm9sbCBzY3Jld2luZXNzIChnaC0zNjk5KQ0KCQkvLyBTdXBwb3J0OiBDaHJvbWUgPD02NA0KCQkvLyBEb24ndCBnZXQgdHJpY2tlZCB3aGVuIHpvb20gYWZmZWN0cyBvZmZzZXRXaWR0aCAoZ2gtNDAyOSkNCgkJZGl2LnN0eWxlLnBvc2l0aW9uID0gImFic29sdXRlIjsNCgkJc2Nyb2xsYm94U2l6ZVZhbCA9IHJvdW5kUGl4ZWxNZWFzdXJlcyggZGl2Lm9mZnNldFdpZHRoIC8gMyApID09PSAxMjsNCg0KCQlkb2N1bWVudEVsZW1lbnQucmVtb3ZlQ2hpbGQoIGNvbnRhaW5lciApOw0KDQoJCS8vIE51bGxpZnkgdGhlIGRpdiBzbyBpdCB3b3VsZG4ndCBiZSBzdG9yZWQgaW4gdGhlIG1lbW9yeSBhbmQNCgkJLy8gaXQgd2lsbCBhbHNvIGJlIGEgc2lnbiB0aGF0IGNoZWNrcyBhbHJlYWR5IHBlcmZvcm1lZA0KCQlkaXYgPSBudWxsOw0KCX0NCg0KCWZ1bmN0aW9uIHJvdW5kUGl4ZWxNZWFzdXJlcyggbWVhc3VyZSApIHsNCgkJcmV0dXJuIE1hdGgucm91bmQoIHBhcnNlRmxvYXQoIG1lYXN1cmUgKSApOw0KCX0NCg0KCXZhciBwaXhlbFBvc2l0aW9uVmFsLCBib3hTaXppbmdSZWxpYWJsZVZhbCwgc2Nyb2xsYm94U2l6ZVZhbCwgcGl4ZWxCb3hTdHlsZXNWYWwsDQoJCXJlbGlhYmxlVHJEaW1lbnNpb25zVmFsLCByZWxpYWJsZU1hcmdpbkxlZnRWYWwsDQoJCWNvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICksDQoJCWRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7DQoNCgkvLyBGaW5pc2ggZWFybHkgaW4gbGltaXRlZCAobm9uLWJyb3dzZXIpIGVudmlyb25tZW50cw0KCWlmICggIWRpdi5zdHlsZSApIHsNCgkJcmV0dXJuOw0KCX0NCg0KCS8vIFN1cHBvcnQ6IElFIDw9OSAtIDExIG9ubHkNCgkvLyBTdHlsZSBvZiBjbG9uZWQgZWxlbWVudCBhZmZlY3RzIHNvdXJjZSBlbGVtZW50IGNsb25lZCAoIzg5MDgpDQoJZGl2LnN0eWxlLmJhY2tncm91bmRDbGlwID0gImNvbnRlbnQtYm94IjsNCglkaXYuY2xvbmVOb2RlKCB0cnVlICkuc3R5bGUuYmFja2dyb3VuZENsaXAgPSAiIjsNCglzdXBwb3J0LmNsZWFyQ2xvbmVTdHlsZSA9IGRpdi5zdHlsZS5iYWNrZ3JvdW5kQ2xpcCA9PT0gImNvbnRlbnQtYm94IjsNCg0KCWpRdWVyeS5leHRlbmQoIHN1cHBvcnQsIHsNCgkJYm94U2l6aW5nUmVsaWFibGU6IGZ1bmN0aW9uKCkgew0KCQkJY29tcHV0ZVN0eWxlVGVzdHMoKTsNCgkJCXJldHVybiBib3hTaXppbmdSZWxpYWJsZVZhbDsNCgkJfSwNCgkJcGl4ZWxCb3hTdHlsZXM6IGZ1bmN0aW9uKCkgew0KCQkJY29tcHV0ZVN0eWxlVGVzdHMoKTsNCgkJCXJldHVybiBwaXhlbEJveFN0eWxlc1ZhbDsNCgkJfSwNCgkJcGl4ZWxQb3NpdGlvbjogZnVuY3Rpb24oKSB7DQoJCQljb21wdXRlU3R5bGVUZXN0cygpOw0KCQkJcmV0dXJuIHBpeGVsUG9zaXRpb25WYWw7DQoJCX0sDQoJCXJlbGlhYmxlTWFyZ2luTGVmdDogZnVuY3Rpb24oKSB7DQoJCQljb21wdXRlU3R5bGVUZXN0cygpOw0KCQkJcmV0dXJuIHJlbGlhYmxlTWFyZ2luTGVmdFZhbDsNCgkJfSwNCgkJc2Nyb2xsYm94U2l6ZTogZnVuY3Rpb24oKSB7DQoJCQljb21wdXRlU3R5bGVUZXN0cygpOw0KCQkJcmV0dXJuIHNjcm9sbGJveFNpemVWYWw7DQoJCX0sDQoNCgkJLy8gU3VwcG9ydDogSUUgOSAtIDExKywgRWRnZSAxNSAtIDE4Kw0KCQkvLyBJRS9FZGdlIG1pc3JlcG9ydCBgZ2V0Q29tcHV0ZWRTdHlsZWAgb2YgdGFibGUgcm93cyB3aXRoIHdpZHRoL2hlaWdodA0KCQkvLyBzZXQgaW4gQ1NTIHdoaWxlIGBvZmZzZXQqYCBwcm9wZXJ0aWVzIHJlcG9ydCBjb3JyZWN0IHZhbHVlcy4NCgkJLy8gQmVoYXZpb3IgaW4gSUUgOSBpcyBtb3JlIHN1YnRsZSB0aGFuIGluIG5ld2VyIHZlcnNpb25zICYgaXQgcGFzc2VzDQoJCS8vIHNvbWUgdmVyc2lvbnMgb2YgdGhpcyB0ZXN0OyBtYWtlIHN1cmUgbm90IHRvIG1ha2UgaXQgcGFzcyB0aGVyZSENCgkJLy8NCgkJLy8gU3VwcG9ydDogRmlyZWZveCA3MCsNCgkJLy8gT25seSBGaXJlZm94IGluY2x1ZGVzIGJvcmRlciB3aWR0aHMNCgkJLy8gaW4gY29tcHV0ZWQgZGltZW5zaW9ucy4gKGdoLTQ1MjkpDQoJCXJlbGlhYmxlVHJEaW1lbnNpb25zOiBmdW5jdGlvbigpIHsNCgkJCXZhciB0YWJsZSwgdHIsIHRyQ2hpbGQsIHRyU3R5bGU7DQoJCQlpZiAoIHJlbGlhYmxlVHJEaW1lbnNpb25zVmFsID09IG51bGwgKSB7DQoJCQkJdGFibGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAidGFibGUiICk7DQoJCQkJdHIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAidHIiICk7DQoJCQkJdHJDaGlsZCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7DQoNCgkJCQl0YWJsZS5zdHlsZS5jc3NUZXh0ID0gInBvc2l0aW9uOmFic29sdXRlO2xlZnQ6LTExMTExcHg7Ym9yZGVyLWNvbGxhcHNlOnNlcGFyYXRlIjsNCgkJCQl0ci5zdHlsZS5jc3NUZXh0ID0gImJvcmRlcjoxcHggc29saWQiOw0KDQoJCQkJLy8gU3VwcG9ydDogQ2hyb21lIDg2Kw0KCQkJCS8vIEhlaWdodCBzZXQgdGhyb3VnaCBjc3NUZXh0IGRvZXMgbm90IGdldCBhcHBsaWVkLg0KCQkJCS8vIENvbXB1dGVkIGhlaWdodCB0aGVuIGNvbWVzIGJhY2sgYXMgMC4NCgkJCQl0ci5zdHlsZS5oZWlnaHQgPSAiMXB4IjsNCgkJCQl0ckNoaWxkLnN0eWxlLmhlaWdodCA9ICI5cHgiOw0KDQoJCQkJLy8gU3VwcG9ydDogQW5kcm9pZCA4IENocm9tZSA4NisNCgkJCQkvLyBJbiBvdXIgYm9keUJhY2tncm91bmQuaHRtbCBpZnJhbWUsDQoJCQkJLy8gZGlzcGxheSBmb3IgYWxsIGRpdiBlbGVtZW50cyBpcyBzZXQgdG8gImlubGluZSIsDQoJCQkJLy8gd2hpY2ggY2F1c2VzIGEgcHJvYmxlbSBvbmx5IGluIEFuZHJvaWQgOCBDaHJvbWUgODYuDQoJCQkJLy8gRW5zdXJpbmcgdGhlIGRpdiBpcyBkaXNwbGF5OiBibG9jaw0KCQkJCS8vIGdldHMgYXJvdW5kIHRoaXMgaXNzdWUuDQoJCQkJdHJDaGlsZC5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsNCg0KCQkJCWRvY3VtZW50RWxlbWVudA0KCQkJCQkuYXBwZW5kQ2hpbGQoIHRhYmxlICkNCgkJCQkJLmFwcGVuZENoaWxkKCB0ciApDQoJCQkJCS5hcHBlbmRDaGlsZCggdHJDaGlsZCApOw0KDQoJCQkJdHJTdHlsZSA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKCB0ciApOw0KCQkJCXJlbGlhYmxlVHJEaW1lbnNpb25zVmFsID0gKCBwYXJzZUludCggdHJTdHlsZS5oZWlnaHQsIDEwICkgKw0KCQkJCQlwYXJzZUludCggdHJTdHlsZS5ib3JkZXJUb3BXaWR0aCwgMTAgKSArDQoJCQkJCXBhcnNlSW50KCB0clN0eWxlLmJvcmRlckJvdHRvbVdpZHRoLCAxMCApICkgPT09IHRyLm9mZnNldEhlaWdodDsNCg0KCQkJCWRvY3VtZW50RWxlbWVudC5yZW1vdmVDaGlsZCggdGFibGUgKTsNCgkJCX0NCgkJCXJldHVybiByZWxpYWJsZVRyRGltZW5zaW9uc1ZhbDsNCgkJfQ0KCX0gKTsNCn0gKSgpOw0KDQoNCmZ1bmN0aW9uIGN1ckNTUyggZWxlbSwgbmFtZSwgY29tcHV0ZWQgKSB7DQoJdmFyIHdpZHRoLCBtaW5XaWR0aCwgbWF4V2lkdGgsIHJldCwNCg0KCQkvLyBTdXBwb3J0OiBGaXJlZm94IDUxKw0KCQkvLyBSZXRyaWV2aW5nIHN0eWxlIGJlZm9yZSBjb21wdXRlZCBzb21laG93DQoJCS8vIGZpeGVzIGFuIGlzc3VlIHdpdGggZ2V0dGluZyB3cm9uZyB2YWx1ZXMNCgkJLy8gb24gZGV0YWNoZWQgZWxlbWVudHMNCgkJc3R5bGUgPSBlbGVtLnN0eWxlOw0KDQoJY29tcHV0ZWQgPSBjb21wdXRlZCB8fCBnZXRTdHlsZXMoIGVsZW0gKTsNCg0KCS8vIGdldFByb3BlcnR5VmFsdWUgaXMgbmVlZGVkIGZvcjoNCgkvLyAgIC5jc3MoJ2ZpbHRlcicpIChJRSA5IG9ubHksICMxMjUzNykNCgkvLyAgIC5jc3MoJy0tY3VzdG9tUHJvcGVydHkpICgjMzE0NCkNCglpZiAoIGNvbXB1dGVkICkgew0KCQlyZXQgPSBjb21wdXRlZC5nZXRQcm9wZXJ0eVZhbHVlKCBuYW1lICkgfHwgY29tcHV0ZWRbIG5hbWUgXTsNCg0KCQlpZiAoIHJldCA9PT0gIiIgJiYgIWlzQXR0YWNoZWQoIGVsZW0gKSApIHsNCgkJCXJldCA9IGpRdWVyeS5zdHlsZSggZWxlbSwgbmFtZSApOw0KCQl9DQoNCgkJLy8gQSB0cmlidXRlIHRvIHRoZSAiYXdlc29tZSBoYWNrIGJ5IERlYW4gRWR3YXJkcyINCgkJLy8gQW5kcm9pZCBCcm93c2VyIHJldHVybnMgcGVyY2VudGFnZSBmb3Igc29tZSB2YWx1ZXMsDQoJCS8vIGJ1dCB3aWR0aCBzZWVtcyB0byBiZSByZWxpYWJseSBwaXhlbHMuDQoJCS8vIFRoaXMgaXMgYWdhaW5zdCB0aGUgQ1NTT00gZHJhZnQgc3BlYzoNCgkJLy8gaHR0cHM6Ly9kcmFmdHMuY3Nzd2cub3JnL2Nzc29tLyNyZXNvbHZlZC12YWx1ZXMNCgkJaWYgKCAhc3VwcG9ydC5waXhlbEJveFN0eWxlcygpICYmIHJudW1ub25weC50ZXN0KCByZXQgKSAmJiByYm94U3R5bGUudGVzdCggbmFtZSApICkgew0KDQoJCQkvLyBSZW1lbWJlciB0aGUgb3JpZ2luYWwgdmFsdWVzDQoJCQl3aWR0aCA9IHN0eWxlLndpZHRoOw0KCQkJbWluV2lkdGggPSBzdHlsZS5taW5XaWR0aDsNCgkJCW1heFdpZHRoID0gc3R5bGUubWF4V2lkdGg7DQoNCgkJCS8vIFB1dCBpbiB0aGUgbmV3IHZhbHVlcyB0byBnZXQgYSBjb21wdXRlZCB2YWx1ZSBvdXQNCgkJCXN0eWxlLm1pbldpZHRoID0gc3R5bGUubWF4V2lkdGggPSBzdHlsZS53aWR0aCA9IHJldDsNCgkJCXJldCA9IGNvbXB1dGVkLndpZHRoOw0KDQoJCQkvLyBSZXZlcnQgdGhlIGNoYW5nZWQgdmFsdWVzDQoJCQlzdHlsZS53aWR0aCA9IHdpZHRoOw0KCQkJc3R5bGUubWluV2lkdGggPSBtaW5XaWR0aDsNCgkJCXN0eWxlLm1heFdpZHRoID0gbWF4V2lkdGg7DQoJCX0NCgl9DQoNCglyZXR1cm4gcmV0ICE9PSB1bmRlZmluZWQgPw0KDQoJCS8vIFN1cHBvcnQ6IElFIDw9OSAtIDExIG9ubHkNCgkJLy8gSUUgcmV0dXJucyB6SW5kZXggdmFsdWUgYXMgYW4gaW50ZWdlci4NCgkJcmV0ICsgIiIgOg0KCQlyZXQ7DQp9DQoNCg0KZnVuY3Rpb24gYWRkR2V0SG9va0lmKCBjb25kaXRpb25GbiwgaG9va0ZuICkgew0KDQoJLy8gRGVmaW5lIHRoZSBob29rLCB3ZSdsbCBjaGVjayBvbiB0aGUgZmlyc3QgcnVuIGlmIGl0J3MgcmVhbGx5IG5lZWRlZC4NCglyZXR1cm4gew0KCQlnZXQ6IGZ1bmN0aW9uKCkgew0KCQkJaWYgKCBjb25kaXRpb25GbigpICkgew0KDQoJCQkJLy8gSG9vayBub3QgbmVlZGVkIChvciBpdCdzIG5vdCBwb3NzaWJsZSB0byB1c2UgaXQgZHVlDQoJCQkJLy8gdG8gbWlzc2luZyBkZXBlbmRlbmN5KSwgcmVtb3ZlIGl0Lg0KCQkJCWRlbGV0ZSB0aGlzLmdldDsNCgkJCQlyZXR1cm47DQoJCQl9DQoNCgkJCS8vIEhvb2sgbmVlZGVkOyByZWRlZmluZSBpdCBzbyB0aGF0IHRoZSBzdXBwb3J0IHRlc3QgaXMgbm90IGV4ZWN1dGVkIGFnYWluLg0KCQkJcmV0dXJuICggdGhpcy5nZXQgPSBob29rRm4gKS5hcHBseSggdGhpcywgYXJndW1lbnRzICk7DQoJCX0NCgl9Ow0KfQ0KDQoNCnZhciBjc3NQcmVmaXhlcyA9IFsgIldlYmtpdCIsICJNb3oiLCAibXMiIF0sDQoJZW1wdHlTdHlsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICkuc3R5bGUsDQoJdmVuZG9yUHJvcHMgPSB7fTsNCg0KLy8gUmV0dXJuIGEgdmVuZG9yLXByZWZpeGVkIHByb3BlcnR5IG9yIHVuZGVmaW5lZA0KZnVuY3Rpb24gdmVuZG9yUHJvcE5hbWUoIG5hbWUgKSB7DQoNCgkvLyBDaGVjayBmb3IgdmVuZG9yIHByZWZpeGVkIG5hbWVzDQoJdmFyIGNhcE5hbWUgPSBuYW1lWyAwIF0udG9VcHBlckNhc2UoKSArIG5hbWUuc2xpY2UoIDEgKSwNCgkJaSA9IGNzc1ByZWZpeGVzLmxlbmd0aDsNCg0KCXdoaWxlICggaS0tICkgew0KCQluYW1lID0gY3NzUHJlZml4ZXNbIGkgXSArIGNhcE5hbWU7DQoJCWlmICggbmFtZSBpbiBlbXB0eVN0eWxlICkgew0KCQkJcmV0dXJuIG5hbWU7DQoJCX0NCgl9DQp9DQoNCi8vIFJldHVybiBhIHBvdGVudGlhbGx5LW1hcHBlZCBqUXVlcnkuY3NzUHJvcHMgb3IgdmVuZG9yIHByZWZpeGVkIHByb3BlcnR5DQpmdW5jdGlvbiBmaW5hbFByb3BOYW1lKCBuYW1lICkgew0KCXZhciBmaW5hbCA9IGpRdWVyeS5jc3NQcm9wc1sgbmFtZSBdIHx8IHZlbmRvclByb3BzWyBuYW1lIF07DQoNCglpZiAoIGZpbmFsICkgew0KCQlyZXR1cm4gZmluYWw7DQoJfQ0KCWlmICggbmFtZSBpbiBlbXB0eVN0eWxlICkgew0KCQlyZXR1cm4gbmFtZTsNCgl9DQoJcmV0dXJuIHZlbmRvclByb3BzWyBuYW1lIF0gPSB2ZW5kb3JQcm9wTmFtZSggbmFtZSApIHx8IG5hbWU7DQp9DQoNCg0KdmFyDQoNCgkvLyBTd2FwcGFibGUgaWYgZGlzcGxheSBpcyBub25lIG9yIHN0YXJ0cyB3aXRoIHRhYmxlDQoJLy8gZXhjZXB0ICJ0YWJsZSIsICJ0YWJsZS1jZWxsIiwgb3IgInRhYmxlLWNhcHRpb24iDQoJLy8gU2VlIGhlcmUgZm9yIGRpc3BsYXkgdmFsdWVzOiBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL0NTUy9kaXNwbGF5DQoJcmRpc3BsYXlzd2FwID0gL14obm9uZXx0YWJsZSg/IS1jW2VhXSkuKykvLA0KCXJjdXN0b21Qcm9wID0gL14tLS8sDQoJY3NzU2hvdyA9IHsgcG9zaXRpb246ICJhYnNvbHV0ZSIsIHZpc2liaWxpdHk6ICJoaWRkZW4iLCBkaXNwbGF5OiAiYmxvY2siIH0sDQoJY3NzTm9ybWFsVHJhbnNmb3JtID0gew0KCQlsZXR0ZXJTcGFjaW5nOiAiMCIsDQoJCWZvbnRXZWlnaHQ6ICI0MDAiDQoJfTsNCg0KZnVuY3Rpb24gc2V0UG9zaXRpdmVOdW1iZXIoIF9lbGVtLCB2YWx1ZSwgc3VidHJhY3QgKSB7DQoNCgkvLyBBbnkgcmVsYXRpdmUgKCsvLSkgdmFsdWVzIGhhdmUgYWxyZWFkeSBiZWVuDQoJLy8gbm9ybWFsaXplZCBhdCB0aGlzIHBvaW50DQoJdmFyIG1hdGNoZXMgPSByY3NzTnVtLmV4ZWMoIHZhbHVlICk7DQoJcmV0dXJuIG1hdGNoZXMgPw0KDQoJCS8vIEd1YXJkIGFnYWluc3QgdW5kZWZpbmVkICJzdWJ0cmFjdCIsIGUuZy4sIHdoZW4gdXNlZCBhcyBpbiBjc3NIb29rcw0KCQlNYXRoLm1heCggMCwgbWF0Y2hlc1sgMiBdIC0gKCBzdWJ0cmFjdCB8fCAwICkgKSArICggbWF0Y2hlc1sgMyBdIHx8ICJweCIgKSA6DQoJCXZhbHVlOw0KfQ0KDQpmdW5jdGlvbiBib3hNb2RlbEFkanVzdG1lbnQoIGVsZW0sIGRpbWVuc2lvbiwgYm94LCBpc0JvcmRlckJveCwgc3R5bGVzLCBjb21wdXRlZFZhbCApIHsNCgl2YXIgaSA9IGRpbWVuc2lvbiA9PT0gIndpZHRoIiA/IDEgOiAwLA0KCQlleHRyYSA9IDAsDQoJCWRlbHRhID0gMDsNCg0KCS8vIEFkanVzdG1lbnQgbWF5IG5vdCBiZSBuZWNlc3NhcnkNCglpZiAoIGJveCA9PT0gKCBpc0JvcmRlckJveCA/ICJib3JkZXIiIDogImNvbnRlbnQiICkgKSB7DQoJCXJldHVybiAwOw0KCX0NCg0KCWZvciAoIDsgaSA8IDQ7IGkgKz0gMiApIHsNCg0KCQkvLyBCb3RoIGJveCBtb2RlbHMgZXhjbHVkZSBtYXJnaW4NCgkJaWYgKCBib3ggPT09ICJtYXJnaW4iICkgew0KCQkJZGVsdGEgKz0galF1ZXJ5LmNzcyggZWxlbSwgYm94ICsgY3NzRXhwYW5kWyBpIF0sIHRydWUsIHN0eWxlcyApOw0KCQl9DQoNCgkJLy8gSWYgd2UgZ2V0IGhlcmUgd2l0aCBhIGNvbnRlbnQtYm94LCB3ZSdyZSBzZWVraW5nICJwYWRkaW5nIiBvciAiYm9yZGVyIiBvciAibWFyZ2luIg0KCQlpZiAoICFpc0JvcmRlckJveCApIHsNCg0KCQkJLy8gQWRkIHBhZGRpbmcNCgkJCWRlbHRhICs9IGpRdWVyeS5jc3MoIGVsZW0sICJwYWRkaW5nIiArIGNzc0V4cGFuZFsgaSBdLCB0cnVlLCBzdHlsZXMgKTsNCg0KCQkJLy8gRm9yICJib3JkZXIiIG9yICJtYXJnaW4iLCBhZGQgYm9yZGVyDQoJCQlpZiAoIGJveCAhPT0gInBhZGRpbmciICkgew0KCQkJCWRlbHRhICs9IGpRdWVyeS5jc3MoIGVsZW0sICJib3JkZXIiICsgY3NzRXhwYW5kWyBpIF0gKyAiV2lkdGgiLCB0cnVlLCBzdHlsZXMgKTsNCg0KCQkJLy8gQnV0IHN0aWxsIGtlZXAgdHJhY2sgb2YgaXQgb3RoZXJ3aXNlDQoJCQl9IGVsc2Ugew0KCQkJCWV4dHJhICs9IGpRdWVyeS5jc3MoIGVsZW0sICJib3JkZXIiICsgY3NzRXhwYW5kWyBpIF0gKyAiV2lkdGgiLCB0cnVlLCBzdHlsZXMgKTsNCgkJCX0NCg0KCQkvLyBJZiB3ZSBnZXQgaGVyZSB3aXRoIGEgYm9yZGVyLWJveCAoY29udGVudCArIHBhZGRpbmcgKyBib3JkZXIpLCB3ZSdyZSBzZWVraW5nICJjb250ZW50IiBvcg0KCQkvLyAicGFkZGluZyIgb3IgIm1hcmdpbiINCgkJfSBlbHNlIHsNCg0KCQkJLy8gRm9yICJjb250ZW50Iiwgc3VidHJhY3QgcGFkZGluZw0KCQkJaWYgKCBib3ggPT09ICJjb250ZW50IiApIHsNCgkJCQlkZWx0YSAtPSBqUXVlcnkuY3NzKCBlbGVtLCAicGFkZGluZyIgKyBjc3NFeHBhbmRbIGkgXSwgdHJ1ZSwgc3R5bGVzICk7DQoJCQl9DQoNCgkJCS8vIEZvciAiY29udGVudCIgb3IgInBhZGRpbmciLCBzdWJ0cmFjdCBib3JkZXINCgkJCWlmICggYm94ICE9PSAibWFyZ2luIiApIHsNCgkJCQlkZWx0YSAtPSBqUXVlcnkuY3NzKCBlbGVtLCAiYm9yZGVyIiArIGNzc0V4cGFuZFsgaSBdICsgIldpZHRoIiwgdHJ1ZSwgc3R5bGVzICk7DQoJCQl9DQoJCX0NCgl9DQoNCgkvLyBBY2NvdW50IGZvciBwb3NpdGl2ZSBjb250ZW50LWJveCBzY3JvbGwgZ3V0dGVyIHdoZW4gcmVxdWVzdGVkIGJ5IHByb3ZpZGluZyBjb21wdXRlZFZhbA0KCWlmICggIWlzQm9yZGVyQm94ICYmIGNvbXB1dGVkVmFsID49IDAgKSB7DQoNCgkJLy8gb2Zmc2V0V2lkdGgvb2Zmc2V0SGVpZ2h0IGlzIGEgcm91bmRlZCBzdW0gb2YgY29udGVudCwgcGFkZGluZywgc2Nyb2xsIGd1dHRlciwgYW5kIGJvcmRlcg0KCQkvLyBBc3N1bWluZyBpbnRlZ2VyIHNjcm9sbCBndXR0ZXIsIHN1YnRyYWN0IHRoZSByZXN0IGFuZCByb3VuZCBkb3duDQoJCWRlbHRhICs9IE1hdGgubWF4KCAwLCBNYXRoLmNlaWwoDQoJCQllbGVtWyAib2Zmc2V0IiArIGRpbWVuc2lvblsgMCBdLnRvVXBwZXJDYXNlKCkgKyBkaW1lbnNpb24uc2xpY2UoIDEgKSBdIC0NCgkJCWNvbXB1dGVkVmFsIC0NCgkJCWRlbHRhIC0NCgkJCWV4dHJhIC0NCgkJCTAuNQ0KDQoJCS8vIElmIG9mZnNldFdpZHRoL29mZnNldEhlaWdodCBpcyB1bmtub3duLCB0aGVuIHdlIGNhbid0IGRldGVybWluZSBjb250ZW50LWJveCBzY3JvbGwgZ3V0dGVyDQoJCS8vIFVzZSBhbiBleHBsaWNpdCB6ZXJvIHRvIGF2b2lkIE5hTiAoZ2gtMzk2NCkNCgkJKSApIHx8IDA7DQoJfQ0KDQoJcmV0dXJuIGRlbHRhOw0KfQ0KDQpmdW5jdGlvbiBnZXRXaWR0aE9ySGVpZ2h0KCBlbGVtLCBkaW1lbnNpb24sIGV4dHJhICkgew0KDQoJLy8gU3RhcnQgd2l0aCBjb21wdXRlZCBzdHlsZQ0KCXZhciBzdHlsZXMgPSBnZXRTdHlsZXMoIGVsZW0gKSwNCg0KCQkvLyBUbyBhdm9pZCBmb3JjaW5nIGEgcmVmbG93LCBvbmx5IGZldGNoIGJveFNpemluZyBpZiB3ZSBuZWVkIGl0IChnaC00MzIyKS4NCgkJLy8gRmFrZSBjb250ZW50LWJveCB1bnRpbCB3ZSBrbm93IGl0J3MgbmVlZGVkIHRvIGtub3cgdGhlIHRydWUgdmFsdWUuDQoJCWJveFNpemluZ05lZWRlZCA9ICFzdXBwb3J0LmJveFNpemluZ1JlbGlhYmxlKCkgfHwgZXh0cmEsDQoJCWlzQm9yZGVyQm94ID0gYm94U2l6aW5nTmVlZGVkICYmDQoJCQlqUXVlcnkuY3NzKCBlbGVtLCAiYm94U2l6aW5nIiwgZmFsc2UsIHN0eWxlcyApID09PSAiYm9yZGVyLWJveCIsDQoJCXZhbHVlSXNCb3JkZXJCb3ggPSBpc0JvcmRlckJveCwNCg0KCQl2YWwgPSBjdXJDU1MoIGVsZW0sIGRpbWVuc2lvbiwgc3R5bGVzICksDQoJCW9mZnNldFByb3AgPSAib2Zmc2V0IiArIGRpbWVuc2lvblsgMCBdLnRvVXBwZXJDYXNlKCkgKyBkaW1lbnNpb24uc2xpY2UoIDEgKTsNCg0KCS8vIFN1cHBvcnQ6IEZpcmVmb3ggPD01NA0KCS8vIFJldHVybiBhIGNvbmZvdW5kaW5nIG5vbi1waXhlbCB2YWx1ZSBvciBmZWlnbiBpZ25vcmFuY2UsIGFzIGFwcHJvcHJpYXRlLg0KCWlmICggcm51bW5vbnB4LnRlc3QoIHZhbCApICkgew0KCQlpZiAoICFleHRyYSApIHsNCgkJCXJldHVybiB2YWw7DQoJCX0NCgkJdmFsID0gImF1dG8iOw0KCX0NCg0KDQoJLy8gU3VwcG9ydDogSUUgOSAtIDExIG9ubHkNCgkvLyBVc2Ugb2Zmc2V0V2lkdGgvb2Zmc2V0SGVpZ2h0IGZvciB3aGVuIGJveCBzaXppbmcgaXMgdW5yZWxpYWJsZS4NCgkvLyBJbiB0aG9zZSBjYXNlcywgdGhlIGNvbXB1dGVkIHZhbHVlIGNhbiBiZSB0cnVzdGVkIHRvIGJlIGJvcmRlci1ib3guDQoJaWYgKCAoICFzdXBwb3J0LmJveFNpemluZ1JlbGlhYmxlKCkgJiYgaXNCb3JkZXJCb3ggfHwNCg0KCQkvLyBTdXBwb3J0OiBJRSAxMCAtIDExKywgRWRnZSAxNSAtIDE4Kw0KCQkvLyBJRS9FZGdlIG1pc3JlcG9ydCBgZ2V0Q29tcHV0ZWRTdHlsZWAgb2YgdGFibGUgcm93cyB3aXRoIHdpZHRoL2hlaWdodA0KCQkvLyBzZXQgaW4gQ1NTIHdoaWxlIGBvZmZzZXQqYCBwcm9wZXJ0aWVzIHJlcG9ydCBjb3JyZWN0IHZhbHVlcy4NCgkJLy8gSW50ZXJlc3RpbmdseSwgaW4gc29tZSBjYXNlcyBJRSA5IGRvZXNuJ3Qgc3VmZmVyIGZyb20gdGhpcyBpc3N1ZS4NCgkJIXN1cHBvcnQucmVsaWFibGVUckRpbWVuc2lvbnMoKSAmJiBub2RlTmFtZSggZWxlbSwgInRyIiApIHx8DQoNCgkJLy8gRmFsbCBiYWNrIHRvIG9mZnNldFdpZHRoL29mZnNldEhlaWdodCB3aGVuIHZhbHVlIGlzICJhdXRvIg0KCQkvLyBUaGlzIGhhcHBlbnMgZm9yIGlubGluZSBlbGVtZW50cyB3aXRoIG5vIGV4cGxpY2l0IHNldHRpbmcgKGdoLTM1NzEpDQoJCXZhbCA9PT0gImF1dG8iIHx8DQoNCgkJLy8gU3VwcG9ydDogQW5kcm9pZCA8PTQuMSAtIDQuMyBvbmx5DQoJCS8vIEFsc28gdXNlIG9mZnNldFdpZHRoL29mZnNldEhlaWdodCBmb3IgbWlzcmVwb3J0ZWQgaW5saW5lIGRpbWVuc2lvbnMgKGdoLTM2MDIpDQoJCSFwYXJzZUZsb2F0KCB2YWwgKSAmJiBqUXVlcnkuY3NzKCBlbGVtLCAiZGlzcGxheSIsIGZhbHNlLCBzdHlsZXMgKSA9PT0gImlubGluZSIgKSAmJg0KDQoJCS8vIE1ha2Ugc3VyZSB0aGUgZWxlbWVudCBpcyB2aXNpYmxlICYgY29ubmVjdGVkDQoJCWVsZW0uZ2V0Q2xpZW50UmVjdHMoKS5sZW5ndGggKSB7DQoNCgkJaXNCb3JkZXJCb3ggPSBqUXVlcnkuY3NzKCBlbGVtLCAiYm94U2l6aW5nIiwgZmFsc2UsIHN0eWxlcyApID09PSAiYm9yZGVyLWJveCI7DQoNCgkJLy8gV2hlcmUgYXZhaWxhYmxlLCBvZmZzZXRXaWR0aC9vZmZzZXRIZWlnaHQgYXBwcm94aW1hdGUgYm9yZGVyIGJveCBkaW1lbnNpb25zLg0KCQkvLyBXaGVyZSBub3QgYXZhaWxhYmxlIChlLmcuLCBTVkcpLCBhc3N1bWUgdW5yZWxpYWJsZSBib3gtc2l6aW5nIGFuZCBpbnRlcnByZXQgdGhlDQoJCS8vIHJldHJpZXZlZCB2YWx1ZSBhcyBhIGNvbnRlbnQgYm94IGRpbWVuc2lvbi4NCgkJdmFsdWVJc0JvcmRlckJveCA9IG9mZnNldFByb3AgaW4gZWxlbTsNCgkJaWYgKCB2YWx1ZUlzQm9yZGVyQm94ICkgew0KCQkJdmFsID0gZWxlbVsgb2Zmc2V0UHJvcCBdOw0KCQl9DQoJfQ0KDQoJLy8gTm9ybWFsaXplICIiIGFuZCBhdXRvDQoJdmFsID0gcGFyc2VGbG9hdCggdmFsICkgfHwgMDsNCg0KCS8vIEFkanVzdCBmb3IgdGhlIGVsZW1lbnQncyBib3ggbW9kZWwNCglyZXR1cm4gKCB2YWwgKw0KCQlib3hNb2RlbEFkanVzdG1lbnQoDQoJCQllbGVtLA0KCQkJZGltZW5zaW9uLA0KCQkJZXh0cmEgfHwgKCBpc0JvcmRlckJveCA/ICJib3JkZXIiIDogImNvbnRlbnQiICksDQoJCQl2YWx1ZUlzQm9yZGVyQm94LA0KCQkJc3R5bGVzLA0KDQoJCQkvLyBQcm92aWRlIHRoZSBjdXJyZW50IGNvbXB1dGVkIHNpemUgdG8gcmVxdWVzdCBzY3JvbGwgZ3V0dGVyIGNhbGN1bGF0aW9uIChnaC0zNTg5KQ0KCQkJdmFsDQoJCSkNCgkpICsgInB4IjsNCn0NCg0KalF1ZXJ5LmV4dGVuZCggew0KDQoJLy8gQWRkIGluIHN0eWxlIHByb3BlcnR5IGhvb2tzIGZvciBvdmVycmlkaW5nIHRoZSBkZWZhdWx0DQoJLy8gYmVoYXZpb3Igb2YgZ2V0dGluZyBhbmQgc2V0dGluZyBhIHN0eWxlIHByb3BlcnR5DQoJY3NzSG9va3M6IHsNCgkJb3BhY2l0eTogew0KCQkJZ2V0OiBmdW5jdGlvbiggZWxlbSwgY29tcHV0ZWQgKSB7DQoJCQkJaWYgKCBjb21wdXRlZCApIHsNCg0KCQkJCQkvLyBXZSBzaG91bGQgYWx3YXlzIGdldCBhIG51bWJlciBiYWNrIGZyb20gb3BhY2l0eQ0KCQkJCQl2YXIgcmV0ID0gY3VyQ1NTKCBlbGVtLCAib3BhY2l0eSIgKTsNCgkJCQkJcmV0dXJuIHJldCA9PT0gIiIgPyAiMSIgOiByZXQ7DQoJCQkJfQ0KCQkJfQ0KCQl9DQoJfSwNCg0KCS8vIERvbid0IGF1dG9tYXRpY2FsbHkgYWRkICJweCIgdG8gdGhlc2UgcG9zc2libHktdW5pdGxlc3MgcHJvcGVydGllcw0KCWNzc051bWJlcjogew0KCQkiYW5pbWF0aW9uSXRlcmF0aW9uQ291bnQiOiB0cnVlLA0KCQkiY29sdW1uQ291bnQiOiB0cnVlLA0KCQkiZmlsbE9wYWNpdHkiOiB0cnVlLA0KCQkiZmxleEdyb3ciOiB0cnVlLA0KCQkiZmxleFNocmluayI6IHRydWUsDQoJCSJmb250V2VpZ2h0IjogdHJ1ZSwNCgkJImdyaWRBcmVhIjogdHJ1ZSwNCgkJImdyaWRDb2x1bW4iOiB0cnVlLA0KCQkiZ3JpZENvbHVtbkVuZCI6IHRydWUsDQoJCSJncmlkQ29sdW1uU3RhcnQiOiB0cnVlLA0KCQkiZ3JpZFJvdyI6IHRydWUsDQoJCSJncmlkUm93RW5kIjogdHJ1ZSwNCgkJImdyaWRSb3dTdGFydCI6IHRydWUsDQoJCSJsaW5lSGVpZ2h0IjogdHJ1ZSwNCgkJIm9wYWNpdHkiOiB0cnVlLA0KCQkib3JkZXIiOiB0cnVlLA0KCQkib3JwaGFucyI6IHRydWUsDQoJCSJ3aWRvd3MiOiB0cnVlLA0KCQkiekluZGV4IjogdHJ1ZSwNCgkJInpvb20iOiB0cnVlDQoJfSwNCg0KCS8vIEFkZCBpbiBwcm9wZXJ0aWVzIHdob3NlIG5hbWVzIHlvdSB3aXNoIHRvIGZpeCBiZWZvcmUNCgkvLyBzZXR0aW5nIG9yIGdldHRpbmcgdGhlIHZhbHVlDQoJY3NzUHJvcHM6IHt9LA0KDQoJLy8gR2V0IGFuZCBzZXQgdGhlIHN0eWxlIHByb3BlcnR5IG9uIGEgRE9NIE5vZGUNCglzdHlsZTogZnVuY3Rpb24oIGVsZW0sIG5hbWUsIHZhbHVlLCBleHRyYSApIHsNCg0KCQkvLyBEb24ndCBzZXQgc3R5bGVzIG9uIHRleHQgYW5kIGNvbW1lbnQgbm9kZXMNCgkJaWYgKCAhZWxlbSB8fCBlbGVtLm5vZGVUeXBlID09PSAzIHx8IGVsZW0ubm9kZVR5cGUgPT09IDggfHwgIWVsZW0uc3R5bGUgKSB7DQoJCQlyZXR1cm47DQoJCX0NCg0KCQkvLyBNYWtlIHN1cmUgdGhhdCB3ZSdyZSB3b3JraW5nIHdpdGggdGhlIHJpZ2h0IG5hbWUNCgkJdmFyIHJldCwgdHlwZSwgaG9va3MsDQoJCQlvcmlnTmFtZSA9IGNhbWVsQ2FzZSggbmFtZSApLA0KCQkJaXNDdXN0b21Qcm9wID0gcmN1c3RvbVByb3AudGVzdCggbmFtZSApLA0KCQkJc3R5bGUgPSBlbGVtLnN0eWxlOw0KDQoJCS8vIE1ha2Ugc3VyZSB0aGF0IHdlJ3JlIHdvcmtpbmcgd2l0aCB0aGUgcmlnaHQgbmFtZS4gV2UgZG9uJ3QNCgkJLy8gd2FudCB0byBxdWVyeSB0aGUgdmFsdWUgaWYgaXQgaXMgYSBDU1MgY3VzdG9tIHByb3BlcnR5DQoJCS8vIHNpbmNlIHRoZXkgYXJlIHVzZXItZGVmaW5lZC4NCgkJaWYgKCAhaXNDdXN0b21Qcm9wICkgew0KCQkJbmFtZSA9IGZpbmFsUHJvcE5hbWUoIG9yaWdOYW1lICk7DQoJCX0NCg0KCQkvLyBHZXRzIGhvb2sgZm9yIHRoZSBwcmVmaXhlZCB2ZXJzaW9uLCB0aGVuIHVucHJlZml4ZWQgdmVyc2lvbg0KCQlob29rcyA9IGpRdWVyeS5jc3NIb29rc1sgbmFtZSBdIHx8IGpRdWVyeS5jc3NIb29rc1sgb3JpZ05hbWUgXTsNCg0KCQkvLyBDaGVjayBpZiB3ZSdyZSBzZXR0aW5nIGEgdmFsdWUNCgkJaWYgKCB2YWx1ZSAhPT0gdW5kZWZpbmVkICkgew0KCQkJdHlwZSA9IHR5cGVvZiB2YWx1ZTsNCg0KCQkJLy8gQ29udmVydCAiKz0iIG9yICItPSIgdG8gcmVsYXRpdmUgbnVtYmVycyAoIzczNDUpDQoJCQlpZiAoIHR5cGUgPT09ICJzdHJpbmciICYmICggcmV0ID0gcmNzc051bS5leGVjKCB2YWx1ZSApICkgJiYgcmV0WyAxIF0gKSB7DQoJCQkJdmFsdWUgPSBhZGp1c3RDU1MoIGVsZW0sIG5hbWUsIHJldCApOw0KDQoJCQkJLy8gRml4ZXMgYnVnICM5MjM3DQoJCQkJdHlwZSA9ICJudW1iZXIiOw0KCQkJfQ0KDQoJCQkvLyBNYWtlIHN1cmUgdGhhdCBudWxsIGFuZCBOYU4gdmFsdWVzIGFyZW4ndCBzZXQgKCM3MTE2KQ0KCQkJaWYgKCB2YWx1ZSA9PSBudWxsIHx8IHZhbHVlICE9PSB2YWx1ZSApIHsNCgkJCQlyZXR1cm47DQoJCQl9DQoNCgkJCS8vIElmIGEgbnVtYmVyIHdhcyBwYXNzZWQgaW4sIGFkZCB0aGUgdW5pdCAoZXhjZXB0IGZvciBjZXJ0YWluIENTUyBwcm9wZXJ0aWVzKQ0KCQkJLy8gVGhlIGlzQ3VzdG9tUHJvcCBjaGVjayBjYW4gYmUgcmVtb3ZlZCBpbiBqUXVlcnkgNC4wIHdoZW4gd2Ugb25seSBhdXRvLWFwcGVuZA0KCQkJLy8gInB4IiB0byBhIGZldyBoYXJkY29kZWQgdmFsdWVzLg0KCQkJaWYgKCB0eXBlID09PSAibnVtYmVyIiAmJiAhaXNDdXN0b21Qcm9wICkgew0KCQkJCXZhbHVlICs9IHJldCAmJiByZXRbIDMgXSB8fCAoIGpRdWVyeS5jc3NOdW1iZXJbIG9yaWdOYW1lIF0gPyAiIiA6ICJweCIgKTsNCgkJCX0NCg0KCQkJLy8gYmFja2dyb3VuZC0qIHByb3BzIGFmZmVjdCBvcmlnaW5hbCBjbG9uZSdzIHZhbHVlcw0KCQkJaWYgKCAhc3VwcG9ydC5jbGVhckNsb25lU3R5bGUgJiYgdmFsdWUgPT09ICIiICYmIG5hbWUuaW5kZXhPZiggImJhY2tncm91bmQiICkgPT09IDAgKSB7DQoJCQkJc3R5bGVbIG5hbWUgXSA9ICJpbmhlcml0IjsNCgkJCX0NCg0KCQkJLy8gSWYgYSBob29rIHdhcyBwcm92aWRlZCwgdXNlIHRoYXQgdmFsdWUsIG90aGVyd2lzZSBqdXN0IHNldCB0aGUgc3BlY2lmaWVkIHZhbHVlDQoJCQlpZiAoICFob29rcyB8fCAhKCAic2V0IiBpbiBob29rcyApIHx8DQoJCQkJKCB2YWx1ZSA9IGhvb2tzLnNldCggZWxlbSwgdmFsdWUsIGV4dHJhICkgKSAhPT0gdW5kZWZpbmVkICkgew0KDQoJCQkJaWYgKCBpc0N1c3RvbVByb3AgKSB7DQoJCQkJCXN0eWxlLnNldFByb3BlcnR5KCBuYW1lLCB2YWx1ZSApOw0KCQkJCX0gZWxzZSB7DQoJCQkJCXN0eWxlWyBuYW1lIF0gPSB2YWx1ZTsNCgkJCQl9DQoJCQl9DQoNCgkJfSBlbHNlIHsNCg0KCQkJLy8gSWYgYSBob29rIHdhcyBwcm92aWRlZCBnZXQgdGhlIG5vbi1jb21wdXRlZCB2YWx1ZSBmcm9tIHRoZXJlDQoJCQlpZiAoIGhvb2tzICYmICJnZXQiIGluIGhvb2tzICYmDQoJCQkJKCByZXQgPSBob29rcy5nZXQoIGVsZW0sIGZhbHNlLCBleHRyYSApICkgIT09IHVuZGVmaW5lZCApIHsNCg0KCQkJCXJldHVybiByZXQ7DQoJCQl9DQoNCgkJCS8vIE90aGVyd2lzZSBqdXN0IGdldCB0aGUgdmFsdWUgZnJvbSB0aGUgc3R5bGUgb2JqZWN0DQoJCQlyZXR1cm4gc3R5bGVbIG5hbWUgXTsNCgkJfQ0KCX0sDQoNCgljc3M6IGZ1bmN0aW9uKCBlbGVtLCBuYW1lLCBleHRyYSwgc3R5bGVzICkgew0KCQl2YXIgdmFsLCBudW0sIGhvb2tzLA0KCQkJb3JpZ05hbWUgPSBjYW1lbENhc2UoIG5hbWUgKSwNCgkJCWlzQ3VzdG9tUHJvcCA9IHJjdXN0b21Qcm9wLnRlc3QoIG5hbWUgKTsNCg0KCQkvLyBNYWtlIHN1cmUgdGhhdCB3ZSdyZSB3b3JraW5nIHdpdGggdGhlIHJpZ2h0IG5hbWUuIFdlIGRvbid0DQoJCS8vIHdhbnQgdG8gbW9kaWZ5IHRoZSB2YWx1ZSBpZiBpdCBpcyBhIENTUyBjdXN0b20gcHJvcGVydHkNCgkJLy8gc2luY2UgdGhleSBhcmUgdXNlci1kZWZpbmVkLg0KCQlpZiAoICFpc0N1c3RvbVByb3AgKSB7DQoJCQluYW1lID0gZmluYWxQcm9wTmFtZSggb3JpZ05hbWUgKTsNCgkJfQ0KDQoJCS8vIFRyeSBwcmVmaXhlZCBuYW1lIGZvbGxvd2VkIGJ5IHRoZSB1bnByZWZpeGVkIG5hbWUNCgkJaG9va3MgPSBqUXVlcnkuY3NzSG9va3NbIG5hbWUgXSB8fCBqUXVlcnkuY3NzSG9va3NbIG9yaWdOYW1lIF07DQoNCgkJLy8gSWYgYSBob29rIHdhcyBwcm92aWRlZCBnZXQgdGhlIGNvbXB1dGVkIHZhbHVlIGZyb20gdGhlcmUNCgkJaWYgKCBob29rcyAmJiAiZ2V0IiBpbiBob29rcyApIHsNCgkJCXZhbCA9IGhvb2tzLmdldCggZWxlbSwgdHJ1ZSwgZXh0cmEgKTsNCgkJfQ0KDQoJCS8vIE90aGVyd2lzZSwgaWYgYSB3YXkgdG8gZ2V0IHRoZSBjb21wdXRlZCB2YWx1ZSBleGlzdHMsIHVzZSB0aGF0DQoJCWlmICggdmFsID09PSB1bmRlZmluZWQgKSB7DQoJCQl2YWwgPSBjdXJDU1MoIGVsZW0sIG5hbWUsIHN0eWxlcyApOw0KCQl9DQoNCgkJLy8gQ29udmVydCAibm9ybWFsIiB0byBjb21wdXRlZCB2YWx1ZQ0KCQlpZiAoIHZhbCA9PT0gIm5vcm1hbCIgJiYgbmFtZSBpbiBjc3NOb3JtYWxUcmFuc2Zvcm0gKSB7DQoJCQl2YWwgPSBjc3NOb3JtYWxUcmFuc2Zvcm1bIG5hbWUgXTsNCgkJfQ0KDQoJCS8vIE1ha2UgbnVtZXJpYyBpZiBmb3JjZWQgb3IgYSBxdWFsaWZpZXIgd2FzIHByb3ZpZGVkIGFuZCB2YWwgbG9va3MgbnVtZXJpYw0KCQlpZiAoIGV4dHJhID09PSAiIiB8fCBleHRyYSApIHsNCgkJCW51bSA9IHBhcnNlRmxvYXQoIHZhbCApOw0KCQkJcmV0dXJuIGV4dHJhID09PSB0cnVlIHx8IGlzRmluaXRlKCBudW0gKSA/IG51bSB8fCAwIDogdmFsOw0KCQl9DQoNCgkJcmV0dXJuIHZhbDsNCgl9DQp9ICk7DQoNCmpRdWVyeS5lYWNoKCBbICJoZWlnaHQiLCAid2lkdGgiIF0sIGZ1bmN0aW9uKCBfaSwgZGltZW5zaW9uICkgew0KCWpRdWVyeS5jc3NIb29rc1sgZGltZW5zaW9uIF0gPSB7DQoJCWdldDogZnVuY3Rpb24oIGVsZW0sIGNvbXB1dGVkLCBleHRyYSApIHsNCgkJCWlmICggY29tcHV0ZWQgKSB7DQoNCgkJCQkvLyBDZXJ0YWluIGVsZW1lbnRzIGNhbiBoYXZlIGRpbWVuc2lvbiBpbmZvIGlmIHdlIGludmlzaWJseSBzaG93IHRoZW0NCgkJCQkvLyBidXQgaXQgbXVzdCBoYXZlIGEgY3VycmVudCBkaXNwbGF5IHN0eWxlIHRoYXQgd291bGQgYmVuZWZpdA0KCQkJCXJldHVybiByZGlzcGxheXN3YXAudGVzdCggalF1ZXJ5LmNzcyggZWxlbSwgImRpc3BsYXkiICkgKSAmJg0KDQoJCQkJCS8vIFN1cHBvcnQ6IFNhZmFyaSA4Kw0KCQkJCQkvLyBUYWJsZSBjb2x1bW5zIGluIFNhZmFyaSBoYXZlIG5vbi16ZXJvIG9mZnNldFdpZHRoICYgemVybw0KCQkJCQkvLyBnZXRCb3VuZGluZ0NsaWVudFJlY3QoKS53aWR0aCB1bmxlc3MgZGlzcGxheSBpcyBjaGFuZ2VkLg0KCQkJCQkvLyBTdXBwb3J0OiBJRSA8PTExIG9ubHkNCgkJCQkJLy8gUnVubmluZyBnZXRCb3VuZGluZ0NsaWVudFJlY3Qgb24gYSBkaXNjb25uZWN0ZWQgbm9kZQ0KCQkJCQkvLyBpbiBJRSB0aHJvd3MgYW4gZXJyb3IuDQoJCQkJCSggIWVsZW0uZ2V0Q2xpZW50UmVjdHMoKS5sZW5ndGggfHwgIWVsZW0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkud2lkdGggKSA/DQoJCQkJCXN3YXAoIGVsZW0sIGNzc1Nob3csIGZ1bmN0aW9uKCkgew0KCQkJCQkJcmV0dXJuIGdldFdpZHRoT3JIZWlnaHQoIGVsZW0sIGRpbWVuc2lvbiwgZXh0cmEgKTsNCgkJCQkJfSApIDoNCgkJCQkJZ2V0V2lkdGhPckhlaWdodCggZWxlbSwgZGltZW5zaW9uLCBleHRyYSApOw0KCQkJfQ0KCQl9LA0KDQoJCXNldDogZnVuY3Rpb24oIGVsZW0sIHZhbHVlLCBleHRyYSApIHsNCgkJCXZhciBtYXRjaGVzLA0KCQkJCXN0eWxlcyA9IGdldFN0eWxlcyggZWxlbSApLA0KDQoJCQkJLy8gT25seSByZWFkIHN0eWxlcy5wb3NpdGlvbiBpZiB0aGUgdGVzdCBoYXMgYSBjaGFuY2UgdG8gZmFpbA0KCQkJCS8vIHRvIGF2b2lkIGZvcmNpbmcgYSByZWZsb3cuDQoJCQkJc2Nyb2xsYm94U2l6ZUJ1Z2d5ID0gIXN1cHBvcnQuc2Nyb2xsYm94U2l6ZSgpICYmDQoJCQkJCXN0eWxlcy5wb3NpdGlvbiA9PT0gImFic29sdXRlIiwNCg0KCQkJCS8vIFRvIGF2b2lkIGZvcmNpbmcgYSByZWZsb3csIG9ubHkgZmV0Y2ggYm94U2l6aW5nIGlmIHdlIG5lZWQgaXQgKGdoLTM5OTEpDQoJCQkJYm94U2l6aW5nTmVlZGVkID0gc2Nyb2xsYm94U2l6ZUJ1Z2d5IHx8IGV4dHJhLA0KCQkJCWlzQm9yZGVyQm94ID0gYm94U2l6aW5nTmVlZGVkICYmDQoJCQkJCWpRdWVyeS5jc3MoIGVsZW0sICJib3hTaXppbmciLCBmYWxzZSwgc3R5bGVzICkgPT09ICJib3JkZXItYm94IiwNCgkJCQlzdWJ0cmFjdCA9IGV4dHJhID8NCgkJCQkJYm94TW9kZWxBZGp1c3RtZW50KA0KCQkJCQkJZWxlbSwNCgkJCQkJCWRpbWVuc2lvbiwNCgkJCQkJCWV4dHJhLA0KCQkJCQkJaXNCb3JkZXJCb3gsDQoJCQkJCQlzdHlsZXMNCgkJCQkJKSA6DQoJCQkJCTA7DQoNCgkJCS8vIEFjY291bnQgZm9yIHVucmVsaWFibGUgYm9yZGVyLWJveCBkaW1lbnNpb25zIGJ5IGNvbXBhcmluZyBvZmZzZXQqIHRvIGNvbXB1dGVkIGFuZA0KCQkJLy8gZmFraW5nIGEgY29udGVudC1ib3ggdG8gZ2V0IGJvcmRlciBhbmQgcGFkZGluZyAoZ2gtMzY5OSkNCgkJCWlmICggaXNCb3JkZXJCb3ggJiYgc2Nyb2xsYm94U2l6ZUJ1Z2d5ICkgew0KCQkJCXN1YnRyYWN0IC09IE1hdGguY2VpbCgNCgkJCQkJZWxlbVsgIm9mZnNldCIgKyBkaW1lbnNpb25bIDAgXS50b1VwcGVyQ2FzZSgpICsgZGltZW5zaW9uLnNsaWNlKCAxICkgXSAtDQoJCQkJCXBhcnNlRmxvYXQoIHN0eWxlc1sgZGltZW5zaW9uIF0gKSAtDQoJCQkJCWJveE1vZGVsQWRqdXN0bWVudCggZWxlbSwgZGltZW5zaW9uLCAiYm9yZGVyIiwgZmFsc2UsIHN0eWxlcyApIC0NCgkJCQkJMC41DQoJCQkJKTsNCgkJCX0NCg0KCQkJLy8gQ29udmVydCB0byBwaXhlbHMgaWYgdmFsdWUgYWRqdXN0bWVudCBpcyBuZWVkZWQNCgkJCWlmICggc3VidHJhY3QgJiYgKCBtYXRjaGVzID0gcmNzc051bS5leGVjKCB2YWx1ZSApICkgJiYNCgkJCQkoIG1hdGNoZXNbIDMgXSB8fCAicHgiICkgIT09ICJweCIgKSB7DQoNCgkJCQllbGVtLnN0eWxlWyBkaW1lbnNpb24gXSA9IHZhbHVlOw0KCQkJCXZhbHVlID0galF1ZXJ5LmNzcyggZWxlbSwgZGltZW5zaW9uICk7DQoJCQl9DQoNCgkJCXJldHVybiBzZXRQb3NpdGl2ZU51bWJlciggZWxlbSwgdmFsdWUsIHN1YnRyYWN0ICk7DQoJCX0NCgl9Ow0KfSApOw0KDQpqUXVlcnkuY3NzSG9va3MubWFyZ2luTGVmdCA9IGFkZEdldEhvb2tJZiggc3VwcG9ydC5yZWxpYWJsZU1hcmdpbkxlZnQsDQoJZnVuY3Rpb24oIGVsZW0sIGNvbXB1dGVkICkgew0KCQlpZiAoIGNvbXB1dGVkICkgew0KCQkJcmV0dXJuICggcGFyc2VGbG9hdCggY3VyQ1NTKCBlbGVtLCAibWFyZ2luTGVmdCIgKSApIHx8DQoJCQkJZWxlbS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS5sZWZ0IC0NCgkJCQkJc3dhcCggZWxlbSwgeyBtYXJnaW5MZWZ0OiAwIH0sIGZ1bmN0aW9uKCkgew0KCQkJCQkJcmV0dXJuIGVsZW0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkubGVmdDsNCgkJCQkJfSApDQoJCQkpICsgInB4IjsNCgkJfQ0KCX0NCik7DQoNCi8vIFRoZXNlIGhvb2tzIGFyZSB1c2VkIGJ5IGFuaW1hdGUgdG8gZXhwYW5kIHByb3BlcnRpZXMNCmpRdWVyeS5lYWNoKCB7DQoJbWFyZ2luOiAiIiwNCglwYWRkaW5nOiAiIiwNCglib3JkZXI6ICJXaWR0aCINCn0sIGZ1bmN0aW9uKCBwcmVmaXgsIHN1ZmZpeCApIHsNCglqUXVlcnkuY3NzSG9va3NbIHByZWZpeCArIHN1ZmZpeCBdID0gew0KCQlleHBhbmQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsNCgkJCXZhciBpID0gMCwNCgkJCQlleHBhbmRlZCA9IHt9LA0KDQoJCQkJLy8gQXNzdW1lcyBhIHNpbmdsZSBudW1iZXIgaWYgbm90IGEgc3RyaW5nDQoJCQkJcGFydHMgPSB0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciID8gdmFsdWUuc3BsaXQoICIgIiApIDogWyB2YWx1ZSBdOw0KDQoJCQlmb3IgKCA7IGkgPCA0OyBpKysgKSB7DQoJCQkJZXhwYW5kZWRbIHByZWZpeCArIGNzc0V4cGFuZFsgaSBdICsgc3VmZml4IF0gPQ0KCQkJCQlwYXJ0c1sgaSBdIHx8IHBhcnRzWyBpIC0gMiBdIHx8IHBhcnRzWyAwIF07DQoJCQl9DQoNCgkJCXJldHVybiBleHBhbmRlZDsNCgkJfQ0KCX07DQoNCglpZiAoIHByZWZpeCAhPT0gIm1hcmdpbiIgKSB7DQoJCWpRdWVyeS5jc3NIb29rc1sgcHJlZml4ICsgc3VmZml4IF0uc2V0ID0gc2V0UG9zaXRpdmVOdW1iZXI7DQoJfQ0KfSApOw0KDQpqUXVlcnkuZm4uZXh0ZW5kKCB7DQoJY3NzOiBmdW5jdGlvbiggbmFtZSwgdmFsdWUgKSB7DQoJCXJldHVybiBhY2Nlc3MoIHRoaXMsIGZ1bmN0aW9uKCBlbGVtLCBuYW1lLCB2YWx1ZSApIHsNCgkJCXZhciBzdHlsZXMsIGxlbiwNCgkJCQltYXAgPSB7fSwNCgkJCQlpID0gMDsNCg0KCQkJaWYgKCBBcnJheS5pc0FycmF5KCBuYW1lICkgKSB7DQoJCQkJc3R5bGVzID0gZ2V0U3R5bGVzKCBlbGVtICk7DQoJCQkJbGVuID0gbmFtZS5sZW5ndGg7DQoNCgkJCQlmb3IgKCA7IGkgPCBsZW47IGkrKyApIHsNCgkJCQkJbWFwWyBuYW1lWyBpIF0gXSA9IGpRdWVyeS5jc3MoIGVsZW0sIG5hbWVbIGkgXSwgZmFsc2UsIHN0eWxlcyApOw0KCQkJCX0NCg0KCQkJCXJldHVybiBtYXA7DQoJCQl9DQoNCgkJCXJldHVybiB2YWx1ZSAhPT0gdW5kZWZpbmVkID8NCgkJCQlqUXVlcnkuc3R5bGUoIGVsZW0sIG5hbWUsIHZhbHVlICkgOg0KCQkJCWpRdWVyeS5jc3MoIGVsZW0sIG5hbWUgKTsNCgkJfSwgbmFtZSwgdmFsdWUsIGFyZ3VtZW50cy5sZW5ndGggPiAxICk7DQoJfQ0KfSApOw0KDQoNCmZ1bmN0aW9uIFR3ZWVuKCBlbGVtLCBvcHRpb25zLCBwcm9wLCBlbmQsIGVhc2luZyApIHsNCglyZXR1cm4gbmV3IFR3ZWVuLnByb3RvdHlwZS5pbml0KCBlbGVtLCBvcHRpb25zLCBwcm9wLCBlbmQsIGVhc2luZyApOw0KfQ0KalF1ZXJ5LlR3ZWVuID0gVHdlZW47DQoNClR3ZWVuLnByb3RvdHlwZSA9IHsNCgljb25zdHJ1Y3RvcjogVHdlZW4sDQoJaW5pdDogZnVuY3Rpb24oIGVsZW0sIG9wdGlvbnMsIHByb3AsIGVuZCwgZWFzaW5nLCB1bml0ICkgew0KCQl0aGlzLmVsZW0gPSBlbGVtOw0KCQl0aGlzLnByb3AgPSBwcm9wOw0KCQl0aGlzLmVhc2luZyA9IGVhc2luZyB8fCBqUXVlcnkuZWFzaW5nLl9kZWZhdWx0Ow0KCQl0aGlzLm9wdGlvbnMgPSBvcHRpb25zOw0KCQl0aGlzLnN0YXJ0ID0gdGhpcy5ub3cgPSB0aGlzLmN1cigpOw0KCQl0aGlzLmVuZCA9IGVuZDsNCgkJdGhpcy51bml0ID0gdW5pdCB8fCAoIGpRdWVyeS5jc3NOdW1iZXJbIHByb3AgXSA/ICIiIDogInB4IiApOw0KCX0sDQoJY3VyOiBmdW5jdGlvbigpIHsNCgkJdmFyIGhvb2tzID0gVHdlZW4ucHJvcEhvb2tzWyB0aGlzLnByb3AgXTsNCg0KCQlyZXR1cm4gaG9va3MgJiYgaG9va3MuZ2V0ID8NCgkJCWhvb2tzLmdldCggdGhpcyApIDoNCgkJCVR3ZWVuLnByb3BIb29rcy5fZGVmYXVsdC5nZXQoIHRoaXMgKTsNCgl9LA0KCXJ1bjogZnVuY3Rpb24oIHBlcmNlbnQgKSB7DQoJCXZhciBlYXNlZCwNCgkJCWhvb2tzID0gVHdlZW4ucHJvcEhvb2tzWyB0aGlzLnByb3AgXTsNCg0KCQlpZiAoIHRoaXMub3B0aW9ucy5kdXJhdGlvbiApIHsNCgkJCXRoaXMucG9zID0gZWFzZWQgPSBqUXVlcnkuZWFzaW5nWyB0aGlzLmVhc2luZyBdKA0KCQkJCXBlcmNlbnQsIHRoaXMub3B0aW9ucy5kdXJhdGlvbiAqIHBlcmNlbnQsIDAsIDEsIHRoaXMub3B0aW9ucy5kdXJhdGlvbg0KCQkJKTsNCgkJfSBlbHNlIHsNCgkJCXRoaXMucG9zID0gZWFzZWQgPSBwZXJjZW50Ow0KCQl9DQoJCXRoaXMubm93ID0gKCB0aGlzLmVuZCAtIHRoaXMuc3RhcnQgKSAqIGVhc2VkICsgdGhpcy5zdGFydDsNCg0KCQlpZiAoIHRoaXMub3B0aW9ucy5zdGVwICkgew0KCQkJdGhpcy5vcHRpb25zLnN0ZXAuY2FsbCggdGhpcy5lbGVtLCB0aGlzLm5vdywgdGhpcyApOw0KCQl9DQoNCgkJaWYgKCBob29rcyAmJiBob29rcy5zZXQgKSB7DQoJCQlob29rcy5zZXQoIHRoaXMgKTsNCgkJfSBlbHNlIHsNCgkJCVR3ZWVuLnByb3BIb29rcy5fZGVmYXVsdC5zZXQoIHRoaXMgKTsNCgkJfQ0KCQlyZXR1cm4gdGhpczsNCgl9DQp9Ow0KDQpUd2Vlbi5wcm90b3R5cGUuaW5pdC5wcm90b3R5cGUgPSBUd2Vlbi5wcm90b3R5cGU7DQoNClR3ZWVuLnByb3BIb29rcyA9IHsNCglfZGVmYXVsdDogew0KCQlnZXQ6IGZ1bmN0aW9uKCB0d2VlbiApIHsNCgkJCXZhciByZXN1bHQ7DQoNCgkJCS8vIFVzZSBhIHByb3BlcnR5IG9uIHRoZSBlbGVtZW50IGRpcmVjdGx5IHdoZW4gaXQgaXMgbm90IGEgRE9NIGVsZW1lbnQsDQoJCQkvLyBvciB3aGVuIHRoZXJlIGlzIG5vIG1hdGNoaW5nIHN0eWxlIHByb3BlcnR5IHRoYXQgZXhpc3RzLg0KCQkJaWYgKCB0d2Vlbi5lbGVtLm5vZGVUeXBlICE9PSAxIHx8DQoJCQkJdHdlZW4uZWxlbVsgdHdlZW4ucHJvcCBdICE9IG51bGwgJiYgdHdlZW4uZWxlbS5zdHlsZVsgdHdlZW4ucHJvcCBdID09IG51bGwgKSB7DQoJCQkJcmV0dXJuIHR3ZWVuLmVsZW1bIHR3ZWVuLnByb3AgXTsNCgkJCX0NCg0KCQkJLy8gUGFzc2luZyBhbiBlbXB0eSBzdHJpbmcgYXMgYSAzcmQgcGFyYW1ldGVyIHRvIC5jc3Mgd2lsbCBhdXRvbWF0aWNhbGx5DQoJCQkvLyBhdHRlbXB0IGEgcGFyc2VGbG9hdCBhbmQgZmFsbGJhY2sgdG8gYSBzdHJpbmcgaWYgdGhlIHBhcnNlIGZhaWxzLg0KCQkJLy8gU2ltcGxlIHZhbHVlcyBzdWNoIGFzICIxMHB4IiBhcmUgcGFyc2VkIHRvIEZsb2F0Ow0KCQkJLy8gY29tcGxleCB2YWx1ZXMgc3VjaCBhcyAicm90YXRlKDFyYWQpIiBhcmUgcmV0dXJuZWQgYXMtaXMuDQoJCQlyZXN1bHQgPSBqUXVlcnkuY3NzKCB0d2Vlbi5lbGVtLCB0d2Vlbi5wcm9wLCAiIiApOw0KDQoJCQkvLyBFbXB0eSBzdHJpbmdzLCBudWxsLCB1bmRlZmluZWQgYW5kICJhdXRvIiBhcmUgY29udmVydGVkIHRvIDAuDQoJCQlyZXR1cm4gIXJlc3VsdCB8fCByZXN1bHQgPT09ICJhdXRvIiA/IDAgOiByZXN1bHQ7DQoJCX0sDQoJCXNldDogZnVuY3Rpb24oIHR3ZWVuICkgew0KDQoJCQkvLyBVc2Ugc3RlcCBob29rIGZvciBiYWNrIGNvbXBhdC4NCgkJCS8vIFVzZSBjc3NIb29rIGlmIGl0cyB0aGVyZS4NCgkJCS8vIFVzZSAuc3R5bGUgaWYgYXZhaWxhYmxlIGFuZCB1c2UgcGxhaW4gcHJvcGVydGllcyB3aGVyZSBhdmFpbGFibGUuDQoJCQlpZiAoIGpRdWVyeS5meC5zdGVwWyB0d2Vlbi5wcm9wIF0gKSB7DQoJCQkJalF1ZXJ5LmZ4LnN0ZXBbIHR3ZWVuLnByb3AgXSggdHdlZW4gKTsNCgkJCX0gZWxzZSBpZiAoIHR3ZWVuLmVsZW0ubm9kZVR5cGUgPT09IDEgJiYgKA0KCQkJCWpRdWVyeS5jc3NIb29rc1sgdHdlZW4ucHJvcCBdIHx8DQoJCQkJCXR3ZWVuLmVsZW0uc3R5bGVbIGZpbmFsUHJvcE5hbWUoIHR3ZWVuLnByb3AgKSBdICE9IG51bGwgKSApIHsNCgkJCQlqUXVlcnkuc3R5bGUoIHR3ZWVuLmVsZW0sIHR3ZWVuLnByb3AsIHR3ZWVuLm5vdyArIHR3ZWVuLnVuaXQgKTsNCgkJCX0gZWxzZSB7DQoJCQkJdHdlZW4uZWxlbVsgdHdlZW4ucHJvcCBdID0gdHdlZW4ubm93Ow0KCQkJfQ0KCQl9DQoJfQ0KfTsNCg0KLy8gU3VwcG9ydDogSUUgPD05IG9ubHkNCi8vIFBhbmljIGJhc2VkIGFwcHJvYWNoIHRvIHNldHRpbmcgdGhpbmdzIG9uIGRpc2Nvbm5lY3RlZCBub2Rlcw0KVHdlZW4ucHJvcEhvb2tzLnNjcm9sbFRvcCA9IFR3ZWVuLnByb3BIb29rcy5zY3JvbGxMZWZ0ID0gew0KCXNldDogZnVuY3Rpb24oIHR3ZWVuICkgew0KCQlpZiAoIHR3ZWVuLmVsZW0ubm9kZVR5cGUgJiYgdHdlZW4uZWxlbS5wYXJlbnROb2RlICkgew0KCQkJdHdlZW4uZWxlbVsgdHdlZW4ucHJvcCBdID0gdHdlZW4ubm93Ow0KCQl9DQoJfQ0KfTsNCg0KalF1ZXJ5LmVhc2luZyA9IHsNCglsaW5lYXI6IGZ1bmN0aW9uKCBwICkgew0KCQlyZXR1cm4gcDsNCgl9LA0KCXN3aW5nOiBmdW5jdGlvbiggcCApIHsNCgkJcmV0dXJuIDAuNSAtIE1hdGguY29zKCBwICogTWF0aC5QSSApIC8gMjsNCgl9LA0KCV9kZWZhdWx0OiAic3dpbmciDQp9Ow0KDQpqUXVlcnkuZnggPSBUd2Vlbi5wcm90b3R5cGUuaW5pdDsNCg0KLy8gQmFjayBjb21wYXQgPDEuOCBleHRlbnNpb24gcG9pbnQNCmpRdWVyeS5meC5zdGVwID0ge307DQoNCg0KDQoNCnZhcg0KCWZ4Tm93LCBpblByb2dyZXNzLA0KCXJmeHR5cGVzID0gL14oPzp0b2dnbGV8c2hvd3xoaWRlKSQvLA0KCXJydW4gPSAvcXVldWVIb29rcyQvOw0KDQpmdW5jdGlvbiBzY2hlZHVsZSgpIHsNCglpZiAoIGluUHJvZ3Jlc3MgKSB7DQoJCWlmICggZG9jdW1lbnQuaGlkZGVuID09PSBmYWxzZSAmJiB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lICkgew0KCQkJd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSggc2NoZWR1bGUgKTsNCgkJfSBlbHNlIHsNCgkJCXdpbmRvdy5zZXRUaW1lb3V0KCBzY2hlZHVsZSwgalF1ZXJ5LmZ4LmludGVydmFsICk7DQoJCX0NCg0KCQlqUXVlcnkuZngudGljaygpOw0KCX0NCn0NCg0KLy8gQW5pbWF0aW9ucyBjcmVhdGVkIHN5bmNocm9ub3VzbHkgd2lsbCBydW4gc3luY2hyb25vdXNseQ0KZnVuY3Rpb24gY3JlYXRlRnhOb3coKSB7DQoJd2luZG93LnNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgew0KCQlmeE5vdyA9IHVuZGVmaW5lZDsNCgl9ICk7DQoJcmV0dXJuICggZnhOb3cgPSBEYXRlLm5vdygpICk7DQp9DQoNCi8vIEdlbmVyYXRlIHBhcmFtZXRlcnMgdG8gY3JlYXRlIGEgc3RhbmRhcmQgYW5pbWF0aW9uDQpmdW5jdGlvbiBnZW5GeCggdHlwZSwgaW5jbHVkZVdpZHRoICkgew0KCXZhciB3aGljaCwNCgkJaSA9IDAsDQoJCWF0dHJzID0geyBoZWlnaHQ6IHR5cGUgfTsNCg0KCS8vIElmIHdlIGluY2x1ZGUgd2lkdGgsIHN0ZXAgdmFsdWUgaXMgMSB0byBkbyBhbGwgY3NzRXhwYW5kIHZhbHVlcywNCgkvLyBvdGhlcndpc2Ugc3RlcCB2YWx1ZSBpcyAyIHRvIHNraXAgb3ZlciBMZWZ0IGFuZCBSaWdodA0KCWluY2x1ZGVXaWR0aCA9IGluY2x1ZGVXaWR0aCA/IDEgOiAwOw0KCWZvciAoIDsgaSA8IDQ7IGkgKz0gMiAtIGluY2x1ZGVXaWR0aCApIHsNCgkJd2hpY2ggPSBjc3NFeHBhbmRbIGkgXTsNCgkJYXR0cnNbICJtYXJnaW4iICsgd2hpY2ggXSA9IGF0dHJzWyAicGFkZGluZyIgKyB3aGljaCBdID0gdHlwZTsNCgl9DQoNCglpZiAoIGluY2x1ZGVXaWR0aCApIHsNCgkJYXR0cnMub3BhY2l0eSA9IGF0dHJzLndpZHRoID0gdHlwZTsNCgl9DQoNCglyZXR1cm4gYXR0cnM7DQp9DQoNCmZ1bmN0aW9uIGNyZWF0ZVR3ZWVuKCB2YWx1ZSwgcHJvcCwgYW5pbWF0aW9uICkgew0KCXZhciB0d2VlbiwNCgkJY29sbGVjdGlvbiA9ICggQW5pbWF0aW9uLnR3ZWVuZXJzWyBwcm9wIF0gfHwgW10gKS5jb25jYXQoIEFuaW1hdGlvbi50d2VlbmVyc1sgIioiIF0gKSwNCgkJaW5kZXggPSAwLA0KCQlsZW5ndGggPSBjb2xsZWN0aW9uLmxlbmd0aDsNCglmb3IgKCA7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrICkgew0KCQlpZiAoICggdHdlZW4gPSBjb2xsZWN0aW9uWyBpbmRleCBdLmNhbGwoIGFuaW1hdGlvbiwgcHJvcCwgdmFsdWUgKSApICkgew0KDQoJCQkvLyBXZSdyZSBkb25lIHdpdGggdGhpcyBwcm9wZXJ0eQ0KCQkJcmV0dXJuIHR3ZWVuOw0KCQl9DQoJfQ0KfQ0KDQpmdW5jdGlvbiBkZWZhdWx0UHJlZmlsdGVyKCBlbGVtLCBwcm9wcywgb3B0cyApIHsNCgl2YXIgcHJvcCwgdmFsdWUsIHRvZ2dsZSwgaG9va3MsIG9sZGZpcmUsIHByb3BUd2VlbiwgcmVzdG9yZURpc3BsYXksIGRpc3BsYXksDQoJCWlzQm94ID0gIndpZHRoIiBpbiBwcm9wcyB8fCAiaGVpZ2h0IiBpbiBwcm9wcywNCgkJYW5pbSA9IHRoaXMsDQoJCW9yaWcgPSB7fSwNCgkJc3R5bGUgPSBlbGVtLnN0eWxlLA0KCQloaWRkZW4gPSBlbGVtLm5vZGVUeXBlICYmIGlzSGlkZGVuV2l0aGluVHJlZSggZWxlbSApLA0KCQlkYXRhU2hvdyA9IGRhdGFQcml2LmdldCggZWxlbSwgImZ4c2hvdyIgKTsNCg0KCS8vIFF1ZXVlLXNraXBwaW5nIGFuaW1hdGlvbnMgaGlqYWNrIHRoZSBmeCBob29rcw0KCWlmICggIW9wdHMucXVldWUgKSB7DQoJCWhvb2tzID0galF1ZXJ5Ll9xdWV1ZUhvb2tzKCBlbGVtLCAiZngiICk7DQoJCWlmICggaG9va3MudW5xdWV1ZWQgPT0gbnVsbCApIHsNCgkJCWhvb2tzLnVucXVldWVkID0gMDsNCgkJCW9sZGZpcmUgPSBob29rcy5lbXB0eS5maXJlOw0KCQkJaG9va3MuZW1wdHkuZmlyZSA9IGZ1bmN0aW9uKCkgew0KCQkJCWlmICggIWhvb2tzLnVucXVldWVkICkgew0KCQkJCQlvbGRmaXJlKCk7DQoJCQkJfQ0KCQkJfTsNCgkJfQ0KCQlob29rcy51bnF1ZXVlZCsrOw0KDQoJCWFuaW0uYWx3YXlzKCBmdW5jdGlvbigpIHsNCg0KCQkJLy8gRW5zdXJlIHRoZSBjb21wbGV0ZSBoYW5kbGVyIGlzIGNhbGxlZCBiZWZvcmUgdGhpcyBjb21wbGV0ZXMNCgkJCWFuaW0uYWx3YXlzKCBmdW5jdGlvbigpIHsNCgkJCQlob29rcy51bnF1ZXVlZC0tOw0KCQkJCWlmICggIWpRdWVyeS5xdWV1ZSggZWxlbSwgImZ4IiApLmxlbmd0aCApIHsNCgkJCQkJaG9va3MuZW1wdHkuZmlyZSgpOw0KCQkJCX0NCgkJCX0gKTsNCgkJfSApOw0KCX0NCg0KCS8vIERldGVjdCBzaG93L2hpZGUgYW5pbWF0aW9ucw0KCWZvciAoIHByb3AgaW4gcHJvcHMgKSB7DQoJCXZhbHVlID0gcHJvcHNbIHByb3AgXTsNCgkJaWYgKCByZnh0eXBlcy50ZXN0KCB2YWx1ZSApICkgew0KCQkJZGVsZXRlIHByb3BzWyBwcm9wIF07DQoJCQl0b2dnbGUgPSB0b2dnbGUgfHwgdmFsdWUgPT09ICJ0b2dnbGUiOw0KCQkJaWYgKCB2YWx1ZSA9PT0gKCBoaWRkZW4gPyAiaGlkZSIgOiAic2hvdyIgKSApIHsNCg0KCQkJCS8vIFByZXRlbmQgdG8gYmUgaGlkZGVuIGlmIHRoaXMgaXMgYSAic2hvdyIgYW5kDQoJCQkJLy8gdGhlcmUgaXMgc3RpbGwgZGF0YSBmcm9tIGEgc3RvcHBlZCBzaG93L2hpZGUNCgkJCQlpZiAoIHZhbHVlID09PSAic2hvdyIgJiYgZGF0YVNob3cgJiYgZGF0YVNob3dbIHByb3AgXSAhPT0gdW5kZWZpbmVkICkgew0KCQkJCQloaWRkZW4gPSB0cnVlOw0KDQoJCQkJLy8gSWdub3JlIGFsbCBvdGhlciBuby1vcCBzaG93L2hpZGUgZGF0YQ0KCQkJCX0gZWxzZSB7DQoJCQkJCWNvbnRpbnVlOw0KCQkJCX0NCgkJCX0NCgkJCW9yaWdbIHByb3AgXSA9IGRhdGFTaG93ICYmIGRhdGFTaG93WyBwcm9wIF0gfHwgalF1ZXJ5LnN0eWxlKCBlbGVtLCBwcm9wICk7DQoJCX0NCgl9DQoNCgkvLyBCYWlsIG91dCBpZiB0aGlzIGlzIGEgbm8tb3AgbGlrZSAuaGlkZSgpLmhpZGUoKQ0KCXByb3BUd2VlbiA9ICFqUXVlcnkuaXNFbXB0eU9iamVjdCggcHJvcHMgKTsNCglpZiAoICFwcm9wVHdlZW4gJiYgalF1ZXJ5LmlzRW1wdHlPYmplY3QoIG9yaWcgKSApIHsNCgkJcmV0dXJuOw0KCX0NCg0KCS8vIFJlc3RyaWN0ICJvdmVyZmxvdyIgYW5kICJkaXNwbGF5IiBzdHlsZXMgZHVyaW5nIGJveCBhbmltYXRpb25zDQoJaWYgKCBpc0JveCAmJiBlbGVtLm5vZGVUeXBlID09PSAxICkgew0KDQoJCS8vIFN1cHBvcnQ6IElFIDw9OSAtIDExLCBFZGdlIDEyIC0gMTUNCgkJLy8gUmVjb3JkIGFsbCAzIG92ZXJmbG93IGF0dHJpYnV0ZXMgYmVjYXVzZSBJRSBkb2VzIG5vdCBpbmZlciB0aGUgc2hvcnRoYW5kDQoJCS8vIGZyb20gaWRlbnRpY2FsbHktdmFsdWVkIG92ZXJmbG93WCBhbmQgb3ZlcmZsb3dZIGFuZCBFZGdlIGp1c3QgbWlycm9ycw0KCQkvLyB0aGUgb3ZlcmZsb3dYIHZhbHVlIHRoZXJlLg0KCQlvcHRzLm92ZXJmbG93ID0gWyBzdHlsZS5vdmVyZmxvdywgc3R5bGUub3ZlcmZsb3dYLCBzdHlsZS5vdmVyZmxvd1kgXTsNCg0KCQkvLyBJZGVudGlmeSBhIGRpc3BsYXkgdHlwZSwgcHJlZmVycmluZyBvbGQgc2hvdy9oaWRlIGRhdGEgb3ZlciB0aGUgQ1NTIGNhc2NhZGUNCgkJcmVzdG9yZURpc3BsYXkgPSBkYXRhU2hvdyAmJiBkYXRhU2hvdy5kaXNwbGF5Ow0KCQlpZiAoIHJlc3RvcmVEaXNwbGF5ID09IG51bGwgKSB7DQoJCQlyZXN0b3JlRGlzcGxheSA9IGRhdGFQcml2LmdldCggZWxlbSwgImRpc3BsYXkiICk7DQoJCX0NCgkJZGlzcGxheSA9IGpRdWVyeS5jc3MoIGVsZW0sICJkaXNwbGF5IiApOw0KCQlpZiAoIGRpc3BsYXkgPT09ICJub25lIiApIHsNCgkJCWlmICggcmVzdG9yZURpc3BsYXkgKSB7DQoJCQkJZGlzcGxheSA9IHJlc3RvcmVEaXNwbGF5Ow0KCQkJfSBlbHNlIHsNCg0KCQkJCS8vIEdldCBub25lbXB0eSB2YWx1ZShzKSBieSB0ZW1wb3JhcmlseSBmb3JjaW5nIHZpc2liaWxpdHkNCgkJCQlzaG93SGlkZSggWyBlbGVtIF0sIHRydWUgKTsNCgkJCQlyZXN0b3JlRGlzcGxheSA9IGVsZW0uc3R5bGUuZGlzcGxheSB8fCByZXN0b3JlRGlzcGxheTsNCgkJCQlkaXNwbGF5ID0galF1ZXJ5LmNzcyggZWxlbSwgImRpc3BsYXkiICk7DQoJCQkJc2hvd0hpZGUoIFsgZWxlbSBdICk7DQoJCQl9DQoJCX0NCg0KCQkvLyBBbmltYXRlIGlubGluZSBlbGVtZW50cyBhcyBpbmxpbmUtYmxvY2sNCgkJaWYgKCBkaXNwbGF5ID09PSAiaW5saW5lIiB8fCBkaXNwbGF5ID09PSAiaW5saW5lLWJsb2NrIiAmJiByZXN0b3JlRGlzcGxheSAhPSBudWxsICkgew0KCQkJaWYgKCBqUXVlcnkuY3NzKCBlbGVtLCAiZmxvYXQiICkgPT09ICJub25lIiApIHsNCg0KCQkJCS8vIFJlc3RvcmUgdGhlIG9yaWdpbmFsIGRpc3BsYXkgdmFsdWUgYXQgdGhlIGVuZCBvZiBwdXJlIHNob3cvaGlkZSBhbmltYXRpb25zDQoJCQkJaWYgKCAhcHJvcFR3ZWVuICkgew0KCQkJCQlhbmltLmRvbmUoIGZ1bmN0aW9uKCkgew0KCQkJCQkJc3R5bGUuZGlzcGxheSA9IHJlc3RvcmVEaXNwbGF5Ow0KCQkJCQl9ICk7DQoJCQkJCWlmICggcmVzdG9yZURpc3BsYXkgPT0gbnVsbCApIHsNCgkJCQkJCWRpc3BsYXkgPSBzdHlsZS5kaXNwbGF5Ow0KCQkJCQkJcmVzdG9yZURpc3BsYXkgPSBkaXNwbGF5ID09PSAibm9uZSIgPyAiIiA6IGRpc3BsYXk7DQoJCQkJCX0NCgkJCQl9DQoJCQkJc3R5bGUuZGlzcGxheSA9ICJpbmxpbmUtYmxvY2siOw0KCQkJfQ0KCQl9DQoJfQ0KDQoJaWYgKCBvcHRzLm92ZXJmbG93ICkgew0KCQlzdHlsZS5vdmVyZmxvdyA9ICJoaWRkZW4iOw0KCQlhbmltLmFsd2F5cyggZnVuY3Rpb24oKSB7DQoJCQlzdHlsZS5vdmVyZmxvdyA9IG9wdHMub3ZlcmZsb3dbIDAgXTsNCgkJCXN0eWxlLm92ZXJmbG93WCA9IG9wdHMub3ZlcmZsb3dbIDEgXTsNCgkJCXN0eWxlLm92ZXJmbG93WSA9IG9wdHMub3ZlcmZsb3dbIDIgXTsNCgkJfSApOw0KCX0NCg0KCS8vIEltcGxlbWVudCBzaG93L2hpZGUgYW5pbWF0aW9ucw0KCXByb3BUd2VlbiA9IGZhbHNlOw0KCWZvciAoIHByb3AgaW4gb3JpZyApIHsNCg0KCQkvLyBHZW5lcmFsIHNob3cvaGlkZSBzZXR1cCBmb3IgdGhpcyBlbGVtZW50IGFuaW1hdGlvbg0KCQlpZiAoICFwcm9wVHdlZW4gKSB7DQoJCQlpZiAoIGRhdGFTaG93ICkgew0KCQkJCWlmICggImhpZGRlbiIgaW4gZGF0YVNob3cgKSB7DQoJCQkJCWhpZGRlbiA9IGRhdGFTaG93LmhpZGRlbjsNCgkJCQl9DQoJCQl9IGVsc2Ugew0KCQkJCWRhdGFTaG93ID0gZGF0YVByaXYuYWNjZXNzKCBlbGVtLCAiZnhzaG93IiwgeyBkaXNwbGF5OiByZXN0b3JlRGlzcGxheSB9ICk7DQoJCQl9DQoNCgkJCS8vIFN0b3JlIGhpZGRlbi92aXNpYmxlIGZvciB0b2dnbGUgc28gYC5zdG9wKCkudG9nZ2xlKClgICJyZXZlcnNlcyINCgkJCWlmICggdG9nZ2xlICkgew0KCQkJCWRhdGFTaG93LmhpZGRlbiA9ICFoaWRkZW47DQoJCQl9DQoNCgkJCS8vIFNob3cgZWxlbWVudHMgYmVmb3JlIGFuaW1hdGluZyB0aGVtDQoJCQlpZiAoIGhpZGRlbiApIHsNCgkJCQlzaG93SGlkZSggWyBlbGVtIF0sIHRydWUgKTsNCgkJCX0NCg0KCQkJLyogZXNsaW50LWRpc2FibGUgbm8tbG9vcC1mdW5jICovDQoNCgkJCWFuaW0uZG9uZSggZnVuY3Rpb24oKSB7DQoNCgkJCQkvKiBlc2xpbnQtZW5hYmxlIG5vLWxvb3AtZnVuYyAqLw0KDQoJCQkJLy8gVGhlIGZpbmFsIHN0ZXAgb2YgYSAiaGlkZSIgYW5pbWF0aW9uIGlzIGFjdHVhbGx5IGhpZGluZyB0aGUgZWxlbWVudA0KCQkJCWlmICggIWhpZGRlbiApIHsNCgkJCQkJc2hvd0hpZGUoIFsgZWxlbSBdICk7DQoJCQkJfQ0KCQkJCWRhdGFQcml2LnJlbW92ZSggZWxlbSwgImZ4c2hvdyIgKTsNCgkJCQlmb3IgKCBwcm9wIGluIG9yaWcgKSB7DQoJCQkJCWpRdWVyeS5zdHlsZSggZWxlbSwgcHJvcCwgb3JpZ1sgcHJvcCBdICk7DQoJCQkJfQ0KCQkJfSApOw0KCQl9DQoNCgkJLy8gUGVyLXByb3BlcnR5IHNldHVwDQoJCXByb3BUd2VlbiA9IGNyZWF0ZVR3ZWVuKCBoaWRkZW4gPyBkYXRhU2hvd1sgcHJvcCBdIDogMCwgcHJvcCwgYW5pbSApOw0KCQlpZiAoICEoIHByb3AgaW4gZGF0YVNob3cgKSApIHsNCgkJCWRhdGFTaG93WyBwcm9wIF0gPSBwcm9wVHdlZW4uc3RhcnQ7DQoJCQlpZiAoIGhpZGRlbiApIHsNCgkJCQlwcm9wVHdlZW4uZW5kID0gcHJvcFR3ZWVuLnN0YXJ0Ow0KCQkJCXByb3BUd2Vlbi5zdGFydCA9IDA7DQoJCQl9DQoJCX0NCgl9DQp9DQoNCmZ1bmN0aW9uIHByb3BGaWx0ZXIoIHByb3BzLCBzcGVjaWFsRWFzaW5nICkgew0KCXZhciBpbmRleCwgbmFtZSwgZWFzaW5nLCB2YWx1ZSwgaG9va3M7DQoNCgkvLyBjYW1lbENhc2UsIHNwZWNpYWxFYXNpbmcgYW5kIGV4cGFuZCBjc3NIb29rIHBhc3MNCglmb3IgKCBpbmRleCBpbiBwcm9wcyApIHsNCgkJbmFtZSA9IGNhbWVsQ2FzZSggaW5kZXggKTsNCgkJZWFzaW5nID0gc3BlY2lhbEVhc2luZ1sgbmFtZSBdOw0KCQl2YWx1ZSA9IHByb3BzWyBpbmRleCBdOw0KCQlpZiAoIEFycmF5LmlzQXJyYXkoIHZhbHVlICkgKSB7DQoJCQllYXNpbmcgPSB2YWx1ZVsgMSBdOw0KCQkJdmFsdWUgPSBwcm9wc1sgaW5kZXggXSA9IHZhbHVlWyAwIF07DQoJCX0NCg0KCQlpZiAoIGluZGV4ICE9PSBuYW1lICkgew0KCQkJcHJvcHNbIG5hbWUgXSA9IHZhbHVlOw0KCQkJZGVsZXRlIHByb3BzWyBpbmRleCBdOw0KCQl9DQoNCgkJaG9va3MgPSBqUXVlcnkuY3NzSG9va3NbIG5hbWUgXTsNCgkJaWYgKCBob29rcyAmJiAiZXhwYW5kIiBpbiBob29rcyApIHsNCgkJCXZhbHVlID0gaG9va3MuZXhwYW5kKCB2YWx1ZSApOw0KCQkJZGVsZXRlIHByb3BzWyBuYW1lIF07DQoNCgkJCS8vIE5vdCBxdWl0ZSAkLmV4dGVuZCwgdGhpcyB3b24ndCBvdmVyd3JpdGUgZXhpc3Rpbmcga2V5cy4NCgkJCS8vIFJldXNpbmcgJ2luZGV4JyBiZWNhdXNlIHdlIGhhdmUgdGhlIGNvcnJlY3QgIm5hbWUiDQoJCQlmb3IgKCBpbmRleCBpbiB2YWx1ZSApIHsNCgkJCQlpZiAoICEoIGluZGV4IGluIHByb3BzICkgKSB7DQoJCQkJCXByb3BzWyBpbmRleCBdID0gdmFsdWVbIGluZGV4IF07DQoJCQkJCXNwZWNpYWxFYXNpbmdbIGluZGV4IF0gPSBlYXNpbmc7DQoJCQkJfQ0KCQkJfQ0KCQl9IGVsc2Ugew0KCQkJc3BlY2lhbEVhc2luZ1sgbmFtZSBdID0gZWFzaW5nOw0KCQl9DQoJfQ0KfQ0KDQpmdW5jdGlvbiBBbmltYXRpb24oIGVsZW0sIHByb3BlcnRpZXMsIG9wdGlvbnMgKSB7DQoJdmFyIHJlc3VsdCwNCgkJc3RvcHBlZCwNCgkJaW5kZXggPSAwLA0KCQlsZW5ndGggPSBBbmltYXRpb24ucHJlZmlsdGVycy5sZW5ndGgsDQoJCWRlZmVycmVkID0galF1ZXJ5LkRlZmVycmVkKCkuYWx3YXlzKCBmdW5jdGlvbigpIHsNCg0KCQkJLy8gRG9uJ3QgbWF0Y2ggZWxlbSBpbiB0aGUgOmFuaW1hdGVkIHNlbGVjdG9yDQoJCQlkZWxldGUgdGljay5lbGVtOw0KCQl9ICksDQoJCXRpY2sgPSBmdW5jdGlvbigpIHsNCgkJCWlmICggc3RvcHBlZCApIHsNCgkJCQlyZXR1cm4gZmFsc2U7DQoJCQl9DQoJCQl2YXIgY3VycmVudFRpbWUgPSBmeE5vdyB8fCBjcmVhdGVGeE5vdygpLA0KCQkJCXJlbWFpbmluZyA9IE1hdGgubWF4KCAwLCBhbmltYXRpb24uc3RhcnRUaW1lICsgYW5pbWF0aW9uLmR1cmF0aW9uIC0gY3VycmVudFRpbWUgKSwNCg0KCQkJCS8vIFN1cHBvcnQ6IEFuZHJvaWQgMi4zIG9ubHkNCgkJCQkvLyBBcmNoYWljIGNyYXNoIGJ1ZyB3b24ndCBhbGxvdyB1cyB0byB1c2UgYDEgLSAoIDAuNSB8fCAwIClgICgjMTI0OTcpDQoJCQkJdGVtcCA9IHJlbWFpbmluZyAvIGFuaW1hdGlvbi5kdXJhdGlvbiB8fCAwLA0KCQkJCXBlcmNlbnQgPSAxIC0gdGVtcCwNCgkJCQlpbmRleCA9IDAsDQoJCQkJbGVuZ3RoID0gYW5pbWF0aW9uLnR3ZWVucy5sZW5ndGg7DQoNCgkJCWZvciAoIDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KysgKSB7DQoJCQkJYW5pbWF0aW9uLnR3ZWVuc1sgaW5kZXggXS5ydW4oIHBlcmNlbnQgKTsNCgkJCX0NCg0KCQkJZGVmZXJyZWQubm90aWZ5V2l0aCggZWxlbSwgWyBhbmltYXRpb24sIHBlcmNlbnQsIHJlbWFpbmluZyBdICk7DQoNCgkJCS8vIElmIHRoZXJlJ3MgbW9yZSB0byBkbywgeWllbGQNCgkJCWlmICggcGVyY2VudCA8IDEgJiYgbGVuZ3RoICkgew0KCQkJCXJldHVybiByZW1haW5pbmc7DQoJCQl9DQoNCgkJCS8vIElmIHRoaXMgd2FzIGFuIGVtcHR5IGFuaW1hdGlvbiwgc3ludGhlc2l6ZSBhIGZpbmFsIHByb2dyZXNzIG5vdGlmaWNhdGlvbg0KCQkJaWYgKCAhbGVuZ3RoICkgew0KCQkJCWRlZmVycmVkLm5vdGlmeVdpdGgoIGVsZW0sIFsgYW5pbWF0aW9uLCAxLCAwIF0gKTsNCgkJCX0NCg0KCQkJLy8gUmVzb2x2ZSB0aGUgYW5pbWF0aW9uIGFuZCByZXBvcnQgaXRzIGNvbmNsdXNpb24NCgkJCWRlZmVycmVkLnJlc29sdmVXaXRoKCBlbGVtLCBbIGFuaW1hdGlvbiBdICk7DQoJCQlyZXR1cm4gZmFsc2U7DQoJCX0sDQoJCWFuaW1hdGlvbiA9IGRlZmVycmVkLnByb21pc2UoIHsNCgkJCWVsZW06IGVsZW0sDQoJCQlwcm9wczogalF1ZXJ5LmV4dGVuZCgge30sIHByb3BlcnRpZXMgKSwNCgkJCW9wdHM6IGpRdWVyeS5leHRlbmQoIHRydWUsIHsNCgkJCQlzcGVjaWFsRWFzaW5nOiB7fSwNCgkJCQllYXNpbmc6IGpRdWVyeS5lYXNpbmcuX2RlZmF1bHQNCgkJCX0sIG9wdGlvbnMgKSwNCgkJCW9yaWdpbmFsUHJvcGVydGllczogcHJvcGVydGllcywNCgkJCW9yaWdpbmFsT3B0aW9uczogb3B0aW9ucywNCgkJCXN0YXJ0VGltZTogZnhOb3cgfHwgY3JlYXRlRnhOb3coKSwNCgkJCWR1cmF0aW9uOiBvcHRpb25zLmR1cmF0aW9uLA0KCQkJdHdlZW5zOiBbXSwNCgkJCWNyZWF0ZVR3ZWVuOiBmdW5jdGlvbiggcHJvcCwgZW5kICkgew0KCQkJCXZhciB0d2VlbiA9IGpRdWVyeS5Ud2VlbiggZWxlbSwgYW5pbWF0aW9uLm9wdHMsIHByb3AsIGVuZCwNCgkJCQkJYW5pbWF0aW9uLm9wdHMuc3BlY2lhbEVhc2luZ1sgcHJvcCBdIHx8IGFuaW1hdGlvbi5vcHRzLmVhc2luZyApOw0KCQkJCWFuaW1hdGlvbi50d2VlbnMucHVzaCggdHdlZW4gKTsNCgkJCQlyZXR1cm4gdHdlZW47DQoJCQl9LA0KCQkJc3RvcDogZnVuY3Rpb24oIGdvdG9FbmQgKSB7DQoJCQkJdmFyIGluZGV4ID0gMCwNCg0KCQkJCQkvLyBJZiB3ZSBhcmUgZ29pbmcgdG8gdGhlIGVuZCwgd2Ugd2FudCB0byBydW4gYWxsIHRoZSB0d2VlbnMNCgkJCQkJLy8gb3RoZXJ3aXNlIHdlIHNraXAgdGhpcyBwYXJ0DQoJCQkJCWxlbmd0aCA9IGdvdG9FbmQgPyBhbmltYXRpb24udHdlZW5zLmxlbmd0aCA6IDA7DQoJCQkJaWYgKCBzdG9wcGVkICkgew0KCQkJCQlyZXR1cm4gdGhpczsNCgkJCQl9DQoJCQkJc3RvcHBlZCA9IHRydWU7DQoJCQkJZm9yICggOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKyApIHsNCgkJCQkJYW5pbWF0aW9uLnR3ZWVuc1sgaW5kZXggXS5ydW4oIDEgKTsNCgkJCQl9DQoNCgkJCQkvLyBSZXNvbHZlIHdoZW4gd2UgcGxheWVkIHRoZSBsYXN0IGZyYW1lOyBvdGhlcndpc2UsIHJlamVjdA0KCQkJCWlmICggZ290b0VuZCApIHsNCgkJCQkJZGVmZXJyZWQubm90aWZ5V2l0aCggZWxlbSwgWyBhbmltYXRpb24sIDEsIDAgXSApOw0KCQkJCQlkZWZlcnJlZC5yZXNvbHZlV2l0aCggZWxlbSwgWyBhbmltYXRpb24sIGdvdG9FbmQgXSApOw0KCQkJCX0gZWxzZSB7DQoJCQkJCWRlZmVycmVkLnJlamVjdFdpdGgoIGVsZW0sIFsgYW5pbWF0aW9uLCBnb3RvRW5kIF0gKTsNCgkJCQl9DQoJCQkJcmV0dXJuIHRoaXM7DQoJCQl9DQoJCX0gKSwNCgkJcHJvcHMgPSBhbmltYXRpb24ucHJvcHM7DQoNCglwcm9wRmlsdGVyKCBwcm9wcywgYW5pbWF0aW9uLm9wdHMuc3BlY2lhbEVhc2luZyApOw0KDQoJZm9yICggOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKyApIHsNCgkJcmVzdWx0ID0gQW5pbWF0aW9uLnByZWZpbHRlcnNbIGluZGV4IF0uY2FsbCggYW5pbWF0aW9uLCBlbGVtLCBwcm9wcywgYW5pbWF0aW9uLm9wdHMgKTsNCgkJaWYgKCByZXN1bHQgKSB7DQoJCQlpZiAoIGlzRnVuY3Rpb24oIHJlc3VsdC5zdG9wICkgKSB7DQoJCQkJalF1ZXJ5Ll9xdWV1ZUhvb2tzKCBhbmltYXRpb24uZWxlbSwgYW5pbWF0aW9uLm9wdHMucXVldWUgKS5zdG9wID0NCgkJCQkJcmVzdWx0LnN0b3AuYmluZCggcmVzdWx0ICk7DQoJCQl9DQoJCQlyZXR1cm4gcmVzdWx0Ow0KCQl9DQoJfQ0KDQoJalF1ZXJ5Lm1hcCggcHJvcHMsIGNyZWF0ZVR3ZWVuLCBhbmltYXRpb24gKTsNCg0KCWlmICggaXNGdW5jdGlvbiggYW5pbWF0aW9uLm9wdHMuc3RhcnQgKSApIHsNCgkJYW5pbWF0aW9uLm9wdHMuc3RhcnQuY2FsbCggZWxlbSwgYW5pbWF0aW9uICk7DQoJfQ0KDQoJLy8gQXR0YWNoIGNhbGxiYWNrcyBmcm9tIG9wdGlvbnMNCglhbmltYXRpb24NCgkJLnByb2dyZXNzKCBhbmltYXRpb24ub3B0cy5wcm9ncmVzcyApDQoJCS5kb25lKCBhbmltYXRpb24ub3B0cy5kb25lLCBhbmltYXRpb24ub3B0cy5jb21wbGV0ZSApDQoJCS5mYWlsKCBhbmltYXRpb24ub3B0cy5mYWlsICkNCgkJLmFsd2F5cyggYW5pbWF0aW9uLm9wdHMuYWx3YXlzICk7DQoNCglqUXVlcnkuZngudGltZXIoDQoJCWpRdWVyeS5leHRlbmQoIHRpY2ssIHsNCgkJCWVsZW06IGVsZW0sDQoJCQlhbmltOiBhbmltYXRpb24sDQoJCQlxdWV1ZTogYW5pbWF0aW9uLm9wdHMucXVldWUNCgkJfSApDQoJKTsNCg0KCXJldHVybiBhbmltYXRpb247DQp9DQoNCmpRdWVyeS5BbmltYXRpb24gPSBqUXVlcnkuZXh0ZW5kKCBBbmltYXRpb24sIHsNCg0KCXR3ZWVuZXJzOiB7DQoJCSIqIjogWyBmdW5jdGlvbiggcHJvcCwgdmFsdWUgKSB7DQoJCQl2YXIgdHdlZW4gPSB0aGlzLmNyZWF0ZVR3ZWVuKCBwcm9wLCB2YWx1ZSApOw0KCQkJYWRqdXN0Q1NTKCB0d2Vlbi5lbGVtLCBwcm9wLCByY3NzTnVtLmV4ZWMoIHZhbHVlICksIHR3ZWVuICk7DQoJCQlyZXR1cm4gdHdlZW47DQoJCX0gXQ0KCX0sDQoNCgl0d2VlbmVyOiBmdW5jdGlvbiggcHJvcHMsIGNhbGxiYWNrICkgew0KCQlpZiAoIGlzRnVuY3Rpb24oIHByb3BzICkgKSB7DQoJCQljYWxsYmFjayA9IHByb3BzOw0KCQkJcHJvcHMgPSBbICIqIiBdOw0KCQl9IGVsc2Ugew0KCQkJcHJvcHMgPSBwcm9wcy5tYXRjaCggcm5vdGh0bWx3aGl0ZSApOw0KCQl9DQoNCgkJdmFyIHByb3AsDQoJCQlpbmRleCA9IDAsDQoJCQlsZW5ndGggPSBwcm9wcy5sZW5ndGg7DQoNCgkJZm9yICggOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKyApIHsNCgkJCXByb3AgPSBwcm9wc1sgaW5kZXggXTsNCgkJCUFuaW1hdGlvbi50d2VlbmVyc1sgcHJvcCBdID0gQW5pbWF0aW9uLnR3ZWVuZXJzWyBwcm9wIF0gfHwgW107DQoJCQlBbmltYXRpb24udHdlZW5lcnNbIHByb3AgXS51bnNoaWZ0KCBjYWxsYmFjayApOw0KCQl9DQoJfSwNCg0KCXByZWZpbHRlcnM6IFsgZGVmYXVsdFByZWZpbHRlciBdLA0KDQoJcHJlZmlsdGVyOiBmdW5jdGlvbiggY2FsbGJhY2ssIHByZXBlbmQgKSB7DQoJCWlmICggcHJlcGVuZCApIHsNCgkJCUFuaW1hdGlvbi5wcmVmaWx0ZXJzLnVuc2hpZnQoIGNhbGxiYWNrICk7DQoJCX0gZWxzZSB7DQoJCQlBbmltYXRpb24ucHJlZmlsdGVycy5wdXNoKCBjYWxsYmFjayApOw0KCQl9DQoJfQ0KfSApOw0KDQpqUXVlcnkuc3BlZWQgPSBmdW5jdGlvbiggc3BlZWQsIGVhc2luZywgZm4gKSB7DQoJdmFyIG9wdCA9IHNwZWVkICYmIHR5cGVvZiBzcGVlZCA9PT0gIm9iamVjdCIgPyBqUXVlcnkuZXh0ZW5kKCB7fSwgc3BlZWQgKSA6IHsNCgkJY29tcGxldGU6IGZuIHx8ICFmbiAmJiBlYXNpbmcgfHwNCgkJCWlzRnVuY3Rpb24oIHNwZWVkICkgJiYgc3BlZWQsDQoJCWR1cmF0aW9uOiBzcGVlZCwNCgkJZWFzaW5nOiBmbiAmJiBlYXNpbmcgfHwgZWFzaW5nICYmICFpc0Z1bmN0aW9uKCBlYXNpbmcgKSAmJiBlYXNpbmcNCgl9Ow0KDQoJLy8gR28gdG8gdGhlIGVuZCBzdGF0ZSBpZiBmeCBhcmUgb2ZmDQoJaWYgKCBqUXVlcnkuZngub2ZmICkgew0KCQlvcHQuZHVyYXRpb24gPSAwOw0KDQoJfSBlbHNlIHsNCgkJaWYgKCB0eXBlb2Ygb3B0LmR1cmF0aW9uICE9PSAibnVtYmVyIiApIHsNCgkJCWlmICggb3B0LmR1cmF0aW9uIGluIGpRdWVyeS5meC5zcGVlZHMgKSB7DQoJCQkJb3B0LmR1cmF0aW9uID0galF1ZXJ5LmZ4LnNwZWVkc1sgb3B0LmR1cmF0aW9uIF07DQoNCgkJCX0gZWxzZSB7DQoJCQkJb3B0LmR1cmF0aW9uID0galF1ZXJ5LmZ4LnNwZWVkcy5fZGVmYXVsdDsNCgkJCX0NCgkJfQ0KCX0NCg0KCS8vIE5vcm1hbGl6ZSBvcHQucXVldWUgLSB0cnVlL3VuZGVmaW5lZC9udWxsIC0+ICJmeCINCglpZiAoIG9wdC5xdWV1ZSA9PSBudWxsIHx8IG9wdC5xdWV1ZSA9PT0gdHJ1ZSApIHsNCgkJb3B0LnF1ZXVlID0gImZ4IjsNCgl9DQoNCgkvLyBRdWV1ZWluZw0KCW9wdC5vbGQgPSBvcHQuY29tcGxldGU7DQoNCglvcHQuY29tcGxldGUgPSBmdW5jdGlvbigpIHsNCgkJaWYgKCBpc0Z1bmN0aW9uKCBvcHQub2xkICkgKSB7DQoJCQlvcHQub2xkLmNhbGwoIHRoaXMgKTsNCgkJfQ0KDQoJCWlmICggb3B0LnF1ZXVlICkgew0KCQkJalF1ZXJ5LmRlcXVldWUoIHRoaXMsIG9wdC5xdWV1ZSApOw0KCQl9DQoJfTsNCg0KCXJldHVybiBvcHQ7DQp9Ow0KDQpqUXVlcnkuZm4uZXh0ZW5kKCB7DQoJZmFkZVRvOiBmdW5jdGlvbiggc3BlZWQsIHRvLCBlYXNpbmcsIGNhbGxiYWNrICkgew0KDQoJCS8vIFNob3cgYW55IGhpZGRlbiBlbGVtZW50cyBhZnRlciBzZXR0aW5nIG9wYWNpdHkgdG8gMA0KCQlyZXR1cm4gdGhpcy5maWx0ZXIoIGlzSGlkZGVuV2l0aGluVHJlZSApLmNzcyggIm9wYWNpdHkiLCAwICkuc2hvdygpDQoNCgkJCS8vIEFuaW1hdGUgdG8gdGhlIHZhbHVlIHNwZWNpZmllZA0KCQkJLmVuZCgpLmFuaW1hdGUoIHsgb3BhY2l0eTogdG8gfSwgc3BlZWQsIGVhc2luZywgY2FsbGJhY2sgKTsNCgl9LA0KCWFuaW1hdGU6IGZ1bmN0aW9uKCBwcm9wLCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayApIHsNCgkJdmFyIGVtcHR5ID0galF1ZXJ5LmlzRW1wdHlPYmplY3QoIHByb3AgKSwNCgkJCW9wdGFsbCA9IGpRdWVyeS5zcGVlZCggc3BlZWQsIGVhc2luZywgY2FsbGJhY2sgKSwNCgkJCWRvQW5pbWF0aW9uID0gZnVuY3Rpb24oKSB7DQoNCgkJCQkvLyBPcGVyYXRlIG9uIGEgY29weSBvZiBwcm9wIHNvIHBlci1wcm9wZXJ0eSBlYXNpbmcgd29uJ3QgYmUgbG9zdA0KCQkJCXZhciBhbmltID0gQW5pbWF0aW9uKCB0aGlzLCBqUXVlcnkuZXh0ZW5kKCB7fSwgcHJvcCApLCBvcHRhbGwgKTsNCg0KCQkJCS8vIEVtcHR5IGFuaW1hdGlvbnMsIG9yIGZpbmlzaGluZyByZXNvbHZlcyBpbW1lZGlhdGVseQ0KCQkJCWlmICggZW1wdHkgfHwgZGF0YVByaXYuZ2V0KCB0aGlzLCAiZmluaXNoIiApICkgew0KCQkJCQlhbmltLnN0b3AoIHRydWUgKTsNCgkJCQl9DQoJCQl9Ow0KDQoJCWRvQW5pbWF0aW9uLmZpbmlzaCA9IGRvQW5pbWF0aW9uOw0KDQoJCXJldHVybiBlbXB0eSB8fCBvcHRhbGwucXVldWUgPT09IGZhbHNlID8NCgkJCXRoaXMuZWFjaCggZG9BbmltYXRpb24gKSA6DQoJCQl0aGlzLnF1ZXVlKCBvcHRhbGwucXVldWUsIGRvQW5pbWF0aW9uICk7DQoJfSwNCglzdG9wOiBmdW5jdGlvbiggdHlwZSwgY2xlYXJRdWV1ZSwgZ290b0VuZCApIHsNCgkJdmFyIHN0b3BRdWV1ZSA9IGZ1bmN0aW9uKCBob29rcyApIHsNCgkJCXZhciBzdG9wID0gaG9va3Muc3RvcDsNCgkJCWRlbGV0ZSBob29rcy5zdG9wOw0KCQkJc3RvcCggZ290b0VuZCApOw0KCQl9Ow0KDQoJCWlmICggdHlwZW9mIHR5cGUgIT09ICJzdHJpbmciICkgew0KCQkJZ290b0VuZCA9IGNsZWFyUXVldWU7DQoJCQljbGVhclF1ZXVlID0gdHlwZTsNCgkJCXR5cGUgPSB1bmRlZmluZWQ7DQoJCX0NCgkJaWYgKCBjbGVhclF1ZXVlICkgew0KCQkJdGhpcy5xdWV1ZSggdHlwZSB8fCAiZngiLCBbXSApOw0KCQl9DQoNCgkJcmV0dXJuIHRoaXMuZWFjaCggZnVuY3Rpb24oKSB7DQoJCQl2YXIgZGVxdWV1ZSA9IHRydWUsDQoJCQkJaW5kZXggPSB0eXBlICE9IG51bGwgJiYgdHlwZSArICJxdWV1ZUhvb2tzIiwNCgkJCQl0aW1lcnMgPSBqUXVlcnkudGltZXJzLA0KCQkJCWRhdGEgPSBkYXRhUHJpdi5nZXQoIHRoaXMgKTsNCg0KCQkJaWYgKCBpbmRleCApIHsNCgkJCQlpZiAoIGRhdGFbIGluZGV4IF0gJiYgZGF0YVsgaW5kZXggXS5zdG9wICkgew0KCQkJCQlzdG9wUXVldWUoIGRhdGFbIGluZGV4IF0gKTsNCgkJCQl9DQoJCQl9IGVsc2Ugew0KCQkJCWZvciAoIGluZGV4IGluIGRhdGEgKSB7DQoJCQkJCWlmICggZGF0YVsgaW5kZXggXSAmJiBkYXRhWyBpbmRleCBdLnN0b3AgJiYgcnJ1bi50ZXN0KCBpbmRleCApICkgew0KCQkJCQkJc3RvcFF1ZXVlKCBkYXRhWyBpbmRleCBdICk7DQoJCQkJCX0NCgkJCQl9DQoJCQl9DQoNCgkJCWZvciAoIGluZGV4ID0gdGltZXJzLmxlbmd0aDsgaW5kZXgtLTsgKSB7DQoJCQkJaWYgKCB0aW1lcnNbIGluZGV4IF0uZWxlbSA9PT0gdGhpcyAmJg0KCQkJCQkoIHR5cGUgPT0gbnVsbCB8fCB0aW1lcnNbIGluZGV4IF0ucXVldWUgPT09IHR5cGUgKSApIHsNCg0KCQkJCQl0aW1lcnNbIGluZGV4IF0uYW5pbS5zdG9wKCBnb3RvRW5kICk7DQoJCQkJCWRlcXVldWUgPSBmYWxzZTsNCgkJCQkJdGltZXJzLnNwbGljZSggaW5kZXgsIDEgKTsNCgkJCQl9DQoJCQl9DQoNCgkJCS8vIFN0YXJ0IHRoZSBuZXh0IGluIHRoZSBxdWV1ZSBpZiB0aGUgbGFzdCBzdGVwIHdhc24ndCBmb3JjZWQuDQoJCQkvLyBUaW1lcnMgY3VycmVudGx5IHdpbGwgY2FsbCB0aGVpciBjb21wbGV0ZSBjYWxsYmFja3MsIHdoaWNoDQoJCQkvLyB3aWxsIGRlcXVldWUgYnV0IG9ubHkgaWYgdGhleSB3ZXJlIGdvdG9FbmQuDQoJCQlpZiAoIGRlcXVldWUgfHwgIWdvdG9FbmQgKSB7DQoJCQkJalF1ZXJ5LmRlcXVldWUoIHRoaXMsIHR5cGUgKTsNCgkJCX0NCgkJfSApOw0KCX0sDQoJZmluaXNoOiBmdW5jdGlvbiggdHlwZSApIHsNCgkJaWYgKCB0eXBlICE9PSBmYWxzZSApIHsNCgkJCXR5cGUgPSB0eXBlIHx8ICJmeCI7DQoJCX0NCgkJcmV0dXJuIHRoaXMuZWFjaCggZnVuY3Rpb24oKSB7DQoJCQl2YXIgaW5kZXgsDQoJCQkJZGF0YSA9IGRhdGFQcml2LmdldCggdGhpcyApLA0KCQkJCXF1ZXVlID0gZGF0YVsgdHlwZSArICJxdWV1ZSIgXSwNCgkJCQlob29rcyA9IGRhdGFbIHR5cGUgKyAicXVldWVIb29rcyIgXSwNCgkJCQl0aW1lcnMgPSBqUXVlcnkudGltZXJzLA0KCQkJCWxlbmd0aCA9IHF1ZXVlID8gcXVldWUubGVuZ3RoIDogMDsNCg0KCQkJLy8gRW5hYmxlIGZpbmlzaGluZyBmbGFnIG9uIHByaXZhdGUgZGF0YQ0KCQkJZGF0YS5maW5pc2ggPSB0cnVlOw0KDQoJCQkvLyBFbXB0eSB0aGUgcXVldWUgZmlyc3QNCgkJCWpRdWVyeS5xdWV1ZSggdGhpcywgdHlwZSwgW10gKTsNCg0KCQkJaWYgKCBob29rcyAmJiBob29rcy5zdG9wICkgew0KCQkJCWhvb2tzLnN0b3AuY2FsbCggdGhpcywgdHJ1ZSApOw0KCQkJfQ0KDQoJCQkvLyBMb29rIGZvciBhbnkgYWN0aXZlIGFuaW1hdGlvbnMsIGFuZCBmaW5pc2ggdGhlbQ0KCQkJZm9yICggaW5kZXggPSB0aW1lcnMubGVuZ3RoOyBpbmRleC0tOyApIHsNCgkJCQlpZiAoIHRpbWVyc1sgaW5kZXggXS5lbGVtID09PSB0aGlzICYmIHRpbWVyc1sgaW5kZXggXS5xdWV1ZSA9PT0gdHlwZSApIHsNCgkJCQkJdGltZXJzWyBpbmRleCBdLmFuaW0uc3RvcCggdHJ1ZSApOw0KCQkJCQl0aW1lcnMuc3BsaWNlKCBpbmRleCwgMSApOw0KCQkJCX0NCgkJCX0NCg0KCQkJLy8gTG9vayBmb3IgYW55IGFuaW1hdGlvbnMgaW4gdGhlIG9sZCBxdWV1ZSBhbmQgZmluaXNoIHRoZW0NCgkJCWZvciAoIGluZGV4ID0gMDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KysgKSB7DQoJCQkJaWYgKCBxdWV1ZVsgaW5kZXggXSAmJiBxdWV1ZVsgaW5kZXggXS5maW5pc2ggKSB7DQoJCQkJCXF1ZXVlWyBpbmRleCBdLmZpbmlzaC5jYWxsKCB0aGlzICk7DQoJCQkJfQ0KCQkJfQ0KDQoJCQkvLyBUdXJuIG9mZiBmaW5pc2hpbmcgZmxhZw0KCQkJZGVsZXRlIGRhdGEuZmluaXNoOw0KCQl9ICk7DQoJfQ0KfSApOw0KDQpqUXVlcnkuZWFjaCggWyAidG9nZ2xlIiwgInNob3ciLCAiaGlkZSIgXSwgZnVuY3Rpb24oIF9pLCBuYW1lICkgew0KCXZhciBjc3NGbiA9IGpRdWVyeS5mblsgbmFtZSBdOw0KCWpRdWVyeS5mblsgbmFtZSBdID0gZnVuY3Rpb24oIHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrICkgew0KCQlyZXR1cm4gc3BlZWQgPT0gbnVsbCB8fCB0eXBlb2Ygc3BlZWQgPT09ICJib29sZWFuIiA/DQoJCQljc3NGbi5hcHBseSggdGhpcywgYXJndW1lbnRzICkgOg0KCQkJdGhpcy5hbmltYXRlKCBnZW5GeCggbmFtZSwgdHJ1ZSApLCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayApOw0KCX07DQp9ICk7DQoNCi8vIEdlbmVyYXRlIHNob3J0Y3V0cyBmb3IgY3VzdG9tIGFuaW1hdGlvbnMNCmpRdWVyeS5lYWNoKCB7DQoJc2xpZGVEb3duOiBnZW5GeCggInNob3ciICksDQoJc2xpZGVVcDogZ2VuRngoICJoaWRlIiApLA0KCXNsaWRlVG9nZ2xlOiBnZW5GeCggInRvZ2dsZSIgKSwNCglmYWRlSW46IHsgb3BhY2l0eTogInNob3ciIH0sDQoJZmFkZU91dDogeyBvcGFjaXR5OiAiaGlkZSIgfSwNCglmYWRlVG9nZ2xlOiB7IG9wYWNpdHk6ICJ0b2dnbGUiIH0NCn0sIGZ1bmN0aW9uKCBuYW1lLCBwcm9wcyApIHsNCglqUXVlcnkuZm5bIG5hbWUgXSA9IGZ1bmN0aW9uKCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayApIHsNCgkJcmV0dXJuIHRoaXMuYW5pbWF0ZSggcHJvcHMsIHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrICk7DQoJfTsNCn0gKTsNCg0KalF1ZXJ5LnRpbWVycyA9IFtdOw0KalF1ZXJ5LmZ4LnRpY2sgPSBmdW5jdGlvbigpIHsNCgl2YXIgdGltZXIsDQoJCWkgPSAwLA0KCQl0aW1lcnMgPSBqUXVlcnkudGltZXJzOw0KDQoJZnhOb3cgPSBEYXRlLm5vdygpOw0KDQoJZm9yICggOyBpIDwgdGltZXJzLmxlbmd0aDsgaSsrICkgew0KCQl0aW1lciA9IHRpbWVyc1sgaSBdOw0KDQoJCS8vIFJ1biB0aGUgdGltZXIgYW5kIHNhZmVseSByZW1vdmUgaXQgd2hlbiBkb25lIChhbGxvd2luZyBmb3IgZXh0ZXJuYWwgcmVtb3ZhbCkNCgkJaWYgKCAhdGltZXIoKSAmJiB0aW1lcnNbIGkgXSA9PT0gdGltZXIgKSB7DQoJCQl0aW1lcnMuc3BsaWNlKCBpLS0sIDEgKTsNCgkJfQ0KCX0NCg0KCWlmICggIXRpbWVycy5sZW5ndGggKSB7DQoJCWpRdWVyeS5meC5zdG9wKCk7DQoJfQ0KCWZ4Tm93ID0gdW5kZWZpbmVkOw0KfTsNCg0KalF1ZXJ5LmZ4LnRpbWVyID0gZnVuY3Rpb24oIHRpbWVyICkgew0KCWpRdWVyeS50aW1lcnMucHVzaCggdGltZXIgKTsNCglqUXVlcnkuZnguc3RhcnQoKTsNCn07DQoNCmpRdWVyeS5meC5pbnRlcnZhbCA9IDEzOw0KalF1ZXJ5LmZ4LnN0YXJ0ID0gZnVuY3Rpb24oKSB7DQoJaWYgKCBpblByb2dyZXNzICkgew0KCQlyZXR1cm47DQoJfQ0KDQoJaW5Qcm9ncmVzcyA9IHRydWU7DQoJc2NoZWR1bGUoKTsNCn07DQoNCmpRdWVyeS5meC5zdG9wID0gZnVuY3Rpb24oKSB7DQoJaW5Qcm9ncmVzcyA9IG51bGw7DQp9Ow0KDQpqUXVlcnkuZnguc3BlZWRzID0gew0KCXNsb3c6IDYwMCwNCglmYXN0OiAyMDAsDQoNCgkvLyBEZWZhdWx0IHNwZWVkDQoJX2RlZmF1bHQ6IDQwMA0KfTsNCg0KDQovLyBCYXNlZCBvZmYgb2YgdGhlIHBsdWdpbiBieSBDbGludCBIZWxmZXJzLCB3aXRoIHBlcm1pc3Npb24uDQovLyBodHRwczovL3dlYi5hcmNoaXZlLm9yZy93ZWIvMjAxMDAzMjQwMTQ3NDcvaHR0cDovL2JsaW5kc2lnbmFscy5jb20vaW5kZXgucGhwLzIwMDkvMDcvanF1ZXJ5LWRlbGF5Lw0KalF1ZXJ5LmZuLmRlbGF5ID0gZnVuY3Rpb24oIHRpbWUsIHR5cGUgKSB7DQoJdGltZSA9IGpRdWVyeS5meCA/IGpRdWVyeS5meC5zcGVlZHNbIHRpbWUgXSB8fCB0aW1lIDogdGltZTsNCgl0eXBlID0gdHlwZSB8fCAiZngiOw0KDQoJcmV0dXJuIHRoaXMucXVldWUoIHR5cGUsIGZ1bmN0aW9uKCBuZXh0LCBob29rcyApIHsNCgkJdmFyIHRpbWVvdXQgPSB3aW5kb3cuc2V0VGltZW91dCggbmV4dCwgdGltZSApOw0KCQlob29rcy5zdG9wID0gZnVuY3Rpb24oKSB7DQoJCQl3aW5kb3cuY2xlYXJUaW1lb3V0KCB0aW1lb3V0ICk7DQoJCX07DQoJfSApOw0KfTsNCg0KDQooIGZ1bmN0aW9uKCkgew0KCXZhciBpbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJpbnB1dCIgKSwNCgkJc2VsZWN0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggInNlbGVjdCIgKSwNCgkJb3B0ID0gc2VsZWN0LmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAib3B0aW9uIiApICk7DQoNCglpbnB1dC50eXBlID0gImNoZWNrYm94IjsNCg0KCS8vIFN1cHBvcnQ6IEFuZHJvaWQgPD00LjMgb25seQ0KCS8vIERlZmF1bHQgdmFsdWUgZm9yIGEgY2hlY2tib3ggc2hvdWxkIGJlICJvbiINCglzdXBwb3J0LmNoZWNrT24gPSBpbnB1dC52YWx1ZSAhPT0gIiI7DQoNCgkvLyBTdXBwb3J0OiBJRSA8PTExIG9ubHkNCgkvLyBNdXN0IGFjY2VzcyBzZWxlY3RlZEluZGV4IHRvIG1ha2UgZGVmYXVsdCBvcHRpb25zIHNlbGVjdA0KCXN1cHBvcnQub3B0U2VsZWN0ZWQgPSBvcHQuc2VsZWN0ZWQ7DQoNCgkvLyBTdXBwb3J0OiBJRSA8PTExIG9ubHkNCgkvLyBBbiBpbnB1dCBsb3NlcyBpdHMgdmFsdWUgYWZ0ZXIgYmVjb21pbmcgYSByYWRpbw0KCWlucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImlucHV0IiApOw0KCWlucHV0LnZhbHVlID0gInQiOw0KCWlucHV0LnR5cGUgPSAicmFkaW8iOw0KCXN1cHBvcnQucmFkaW9WYWx1ZSA9IGlucHV0LnZhbHVlID09PSAidCI7DQp9ICkoKTsNCg0KDQp2YXIgYm9vbEhvb2ssDQoJYXR0ckhhbmRsZSA9IGpRdWVyeS5leHByLmF0dHJIYW5kbGU7DQoNCmpRdWVyeS5mbi5leHRlbmQoIHsNCglhdHRyOiBmdW5jdGlvbiggbmFtZSwgdmFsdWUgKSB7DQoJCXJldHVybiBhY2Nlc3MoIHRoaXMsIGpRdWVyeS5hdHRyLCBuYW1lLCB2YWx1ZSwgYXJndW1lbnRzLmxlbmd0aCA+IDEgKTsNCgl9LA0KDQoJcmVtb3ZlQXR0cjogZnVuY3Rpb24oIG5hbWUgKSB7DQoJCXJldHVybiB0aGlzLmVhY2goIGZ1bmN0aW9uKCkgew0KCQkJalF1ZXJ5LnJlbW92ZUF0dHIoIHRoaXMsIG5hbWUgKTsNCgkJfSApOw0KCX0NCn0gKTsNCg0KalF1ZXJ5LmV4dGVuZCggew0KCWF0dHI6IGZ1bmN0aW9uKCBlbGVtLCBuYW1lLCB2YWx1ZSApIHsNCgkJdmFyIHJldCwgaG9va3MsDQoJCQluVHlwZSA9IGVsZW0ubm9kZVR5cGU7DQoNCgkJLy8gRG9uJ3QgZ2V0L3NldCBhdHRyaWJ1dGVzIG9uIHRleHQsIGNvbW1lbnQgYW5kIGF0dHJpYnV0ZSBub2Rlcw0KCQlpZiAoIG5UeXBlID09PSAzIHx8IG5UeXBlID09PSA4IHx8IG5UeXBlID09PSAyICkgew0KCQkJcmV0dXJuOw0KCQl9DQoNCgkJLy8gRmFsbGJhY2sgdG8gcHJvcCB3aGVuIGF0dHJpYnV0ZXMgYXJlIG5vdCBzdXBwb3J0ZWQNCgkJaWYgKCB0eXBlb2YgZWxlbS5nZXRBdHRyaWJ1dGUgPT09ICJ1bmRlZmluZWQiICkgew0KCQkJcmV0dXJuIGpRdWVyeS5wcm9wKCBlbGVtLCBuYW1lLCB2YWx1ZSApOw0KCQl9DQoNCgkJLy8gQXR0cmlidXRlIGhvb2tzIGFyZSBkZXRlcm1pbmVkIGJ5IHRoZSBsb3dlcmNhc2UgdmVyc2lvbg0KCQkvLyBHcmFiIG5lY2Vzc2FyeSBob29rIGlmIG9uZSBpcyBkZWZpbmVkDQoJCWlmICggblR5cGUgIT09IDEgfHwgIWpRdWVyeS5pc1hNTERvYyggZWxlbSApICkgew0KCQkJaG9va3MgPSBqUXVlcnkuYXR0ckhvb2tzWyBuYW1lLnRvTG93ZXJDYXNlKCkgXSB8fA0KCQkJCSggalF1ZXJ5LmV4cHIubWF0Y2guYm9vbC50ZXN0KCBuYW1lICkgPyBib29sSG9vayA6IHVuZGVmaW5lZCApOw0KCQl9DQoNCgkJaWYgKCB2YWx1ZSAhPT0gdW5kZWZpbmVkICkgew0KCQkJaWYgKCB2YWx1ZSA9PT0gbnVsbCApIHsNCgkJCQlqUXVlcnkucmVtb3ZlQXR0ciggZWxlbSwgbmFtZSApOw0KCQkJCXJldHVybjsNCgkJCX0NCg0KCQkJaWYgKCBob29rcyAmJiAic2V0IiBpbiBob29rcyAmJg0KCQkJCSggcmV0ID0gaG9va3Muc2V0KCBlbGVtLCB2YWx1ZSwgbmFtZSApICkgIT09IHVuZGVmaW5lZCApIHsNCgkJCQlyZXR1cm4gcmV0Ow0KCQkJfQ0KDQoJCQllbGVtLnNldEF0dHJpYnV0ZSggbmFtZSwgdmFsdWUgKyAiIiApOw0KCQkJcmV0dXJuIHZhbHVlOw0KCQl9DQoNCgkJaWYgKCBob29rcyAmJiAiZ2V0IiBpbiBob29rcyAmJiAoIHJldCA9IGhvb2tzLmdldCggZWxlbSwgbmFtZSApICkgIT09IG51bGwgKSB7DQoJCQlyZXR1cm4gcmV0Ow0KCQl9DQoNCgkJcmV0ID0galF1ZXJ5LmZpbmQuYXR0ciggZWxlbSwgbmFtZSApOw0KDQoJCS8vIE5vbi1leGlzdGVudCBhdHRyaWJ1dGVzIHJldHVybiBudWxsLCB3ZSBub3JtYWxpemUgdG8gdW5kZWZpbmVkDQoJCXJldHVybiByZXQgPT0gbnVsbCA/IHVuZGVmaW5lZCA6IHJldDsNCgl9LA0KDQoJYXR0ckhvb2tzOiB7DQoJCXR5cGU6IHsNCgkJCXNldDogZnVuY3Rpb24oIGVsZW0sIHZhbHVlICkgew0KCQkJCWlmICggIXN1cHBvcnQucmFkaW9WYWx1ZSAmJiB2YWx1ZSA9PT0gInJhZGlvIiAmJg0KCQkJCQlub2RlTmFtZSggZWxlbSwgImlucHV0IiApICkgew0KCQkJCQl2YXIgdmFsID0gZWxlbS52YWx1ZTsNCgkJCQkJZWxlbS5zZXRBdHRyaWJ1dGUoICJ0eXBlIiwgdmFsdWUgKTsNCgkJCQkJaWYgKCB2YWwgKSB7DQoJCQkJCQllbGVtLnZhbHVlID0gdmFsOw0KCQkJCQl9DQoJCQkJCXJldHVybiB2YWx1ZTsNCgkJCQl9DQoJCQl9DQoJCX0NCgl9LA0KDQoJcmVtb3ZlQXR0cjogZnVuY3Rpb24oIGVsZW0sIHZhbHVlICkgew0KCQl2YXIgbmFtZSwNCgkJCWkgPSAwLA0KDQoJCQkvLyBBdHRyaWJ1dGUgbmFtZXMgY2FuIGNvbnRhaW4gbm9uLUhUTUwgd2hpdGVzcGFjZSBjaGFyYWN0ZXJzDQoJCQkvLyBodHRwczovL2h0bWwuc3BlYy53aGF0d2cub3JnL211bHRpcGFnZS9zeW50YXguaHRtbCNhdHRyaWJ1dGVzLTINCgkJCWF0dHJOYW1lcyA9IHZhbHVlICYmIHZhbHVlLm1hdGNoKCBybm90aHRtbHdoaXRlICk7DQoNCgkJaWYgKCBhdHRyTmFtZXMgJiYgZWxlbS5ub2RlVHlwZSA9PT0gMSApIHsNCgkJCXdoaWxlICggKCBuYW1lID0gYXR0ck5hbWVzWyBpKysgXSApICkgew0KCQkJCWVsZW0ucmVtb3ZlQXR0cmlidXRlKCBuYW1lICk7DQoJCQl9DQoJCX0NCgl9DQp9ICk7DQoNCi8vIEhvb2tzIGZvciBib29sZWFuIGF0dHJpYnV0ZXMNCmJvb2xIb29rID0gew0KCXNldDogZnVuY3Rpb24oIGVsZW0sIHZhbHVlLCBuYW1lICkgew0KCQlpZiAoIHZhbHVlID09PSBmYWxzZSApIHsNCg0KCQkJLy8gUmVtb3ZlIGJvb2xlYW4gYXR0cmlidXRlcyB3aGVuIHNldCB0byBmYWxzZQ0KCQkJalF1ZXJ5LnJlbW92ZUF0dHIoIGVsZW0sIG5hbWUgKTsNCgkJfSBlbHNlIHsNCgkJCWVsZW0uc2V0QXR0cmlidXRlKCBuYW1lLCBuYW1lICk7DQoJCX0NCgkJcmV0dXJuIG5hbWU7DQoJfQ0KfTsNCg0KalF1ZXJ5LmVhY2goIGpRdWVyeS5leHByLm1hdGNoLmJvb2wuc291cmNlLm1hdGNoKCAvXHcrL2cgKSwgZnVuY3Rpb24oIF9pLCBuYW1lICkgew0KCXZhciBnZXR0ZXIgPSBhdHRySGFuZGxlWyBuYW1lIF0gfHwgalF1ZXJ5LmZpbmQuYXR0cjsNCg0KCWF0dHJIYW5kbGVbIG5hbWUgXSA9IGZ1bmN0aW9uKCBlbGVtLCBuYW1lLCBpc1hNTCApIHsNCgkJdmFyIHJldCwgaGFuZGxlLA0KCQkJbG93ZXJjYXNlTmFtZSA9IG5hbWUudG9Mb3dlckNhc2UoKTsNCg0KCQlpZiAoICFpc1hNTCApIHsNCg0KCQkJLy8gQXZvaWQgYW4gaW5maW5pdGUgbG9vcCBieSB0ZW1wb3JhcmlseSByZW1vdmluZyB0aGlzIGZ1bmN0aW9uIGZyb20gdGhlIGdldHRlcg0KCQkJaGFuZGxlID0gYXR0ckhhbmRsZVsgbG93ZXJjYXNlTmFtZSBdOw0KCQkJYXR0ckhhbmRsZVsgbG93ZXJjYXNlTmFtZSBdID0gcmV0Ow0KCQkJcmV0ID0gZ2V0dGVyKCBlbGVtLCBuYW1lLCBpc1hNTCApICE9IG51bGwgPw0KCQkJCWxvd2VyY2FzZU5hbWUgOg0KCQkJCW51bGw7DQoJCQlhdHRySGFuZGxlWyBsb3dlcmNhc2VOYW1lIF0gPSBoYW5kbGU7DQoJCX0NCgkJcmV0dXJuIHJldDsNCgl9Ow0KfSApOw0KDQoNCg0KDQp2YXIgcmZvY3VzYWJsZSA9IC9eKD86aW5wdXR8c2VsZWN0fHRleHRhcmVhfGJ1dHRvbikkL2ksDQoJcmNsaWNrYWJsZSA9IC9eKD86YXxhcmVhKSQvaTsNCg0KalF1ZXJ5LmZuLmV4dGVuZCggew0KCXByb3A6IGZ1bmN0aW9uKCBuYW1lLCB2YWx1ZSApIHsNCgkJcmV0dXJuIGFjY2VzcyggdGhpcywgalF1ZXJ5LnByb3AsIG5hbWUsIHZhbHVlLCBhcmd1bWVudHMubGVuZ3RoID4gMSApOw0KCX0sDQoNCglyZW1vdmVQcm9wOiBmdW5jdGlvbiggbmFtZSApIHsNCgkJcmV0dXJuIHRoaXMuZWFjaCggZnVuY3Rpb24oKSB7DQoJCQlkZWxldGUgdGhpc1sgalF1ZXJ5LnByb3BGaXhbIG5hbWUgXSB8fCBuYW1lIF07DQoJCX0gKTsNCgl9DQp9ICk7DQoNCmpRdWVyeS5leHRlbmQoIHsNCglwcm9wOiBmdW5jdGlvbiggZWxlbSwgbmFtZSwgdmFsdWUgKSB7DQoJCXZhciByZXQsIGhvb2tzLA0KCQkJblR5cGUgPSBlbGVtLm5vZGVUeXBlOw0KDQoJCS8vIERvbid0IGdldC9zZXQgcHJvcGVydGllcyBvbiB0ZXh0LCBjb21tZW50IGFuZCBhdHRyaWJ1dGUgbm9kZXMNCgkJaWYgKCBuVHlwZSA9PT0gMyB8fCBuVHlwZSA9PT0gOCB8fCBuVHlwZSA9PT0gMiApIHsNCgkJCXJldHVybjsNCgkJfQ0KDQoJCWlmICggblR5cGUgIT09IDEgfHwgIWpRdWVyeS5pc1hNTERvYyggZWxlbSApICkgew0KDQoJCQkvLyBGaXggbmFtZSBhbmQgYXR0YWNoIGhvb2tzDQoJCQluYW1lID0galF1ZXJ5LnByb3BGaXhbIG5hbWUgXSB8fCBuYW1lOw0KCQkJaG9va3MgPSBqUXVlcnkucHJvcEhvb2tzWyBuYW1lIF07DQoJCX0NCg0KCQlpZiAoIHZhbHVlICE9PSB1bmRlZmluZWQgKSB7DQoJCQlpZiAoIGhvb2tzICYmICJzZXQiIGluIGhvb2tzICYmDQoJCQkJKCByZXQgPSBob29rcy5zZXQoIGVsZW0sIHZhbHVlLCBuYW1lICkgKSAhPT0gdW5kZWZpbmVkICkgew0KCQkJCXJldHVybiByZXQ7DQoJCQl9DQoNCgkJCXJldHVybiAoIGVsZW1bIG5hbWUgXSA9IHZhbHVlICk7DQoJCX0NCg0KCQlpZiAoIGhvb2tzICYmICJnZXQiIGluIGhvb2tzICYmICggcmV0ID0gaG9va3MuZ2V0KCBlbGVtLCBuYW1lICkgKSAhPT0gbnVsbCApIHsNCgkJCXJldHVybiByZXQ7DQoJCX0NCg0KCQlyZXR1cm4gZWxlbVsgbmFtZSBdOw0KCX0sDQoNCglwcm9wSG9va3M6IHsNCgkJdGFiSW5kZXg6IHsNCgkJCWdldDogZnVuY3Rpb24oIGVsZW0gKSB7DQoNCgkJCQkvLyBTdXBwb3J0OiBJRSA8PTkgLSAxMSBvbmx5DQoJCQkJLy8gZWxlbS50YWJJbmRleCBkb2Vzbid0IGFsd2F5cyByZXR1cm4gdGhlDQoJCQkJLy8gY29ycmVjdCB2YWx1ZSB3aGVuIGl0IGhhc24ndCBiZWVuIGV4cGxpY2l0bHkgc2V0DQoJCQkJLy8gaHR0cHM6Ly93ZWIuYXJjaGl2ZS5vcmcvd2ViLzIwMTQxMTE2MjMzMzQ3L2h0dHA6Ly9mbHVpZHByb2plY3Qub3JnL2Jsb2cvMjAwOC8wMS8wOS9nZXR0aW5nLXNldHRpbmctYW5kLXJlbW92aW5nLXRhYmluZGV4LXZhbHVlcy13aXRoLWphdmFzY3JpcHQvDQoJCQkJLy8gVXNlIHByb3BlciBhdHRyaWJ1dGUgcmV0cmlldmFsKCMxMjA3MikNCgkJCQl2YXIgdGFiaW5kZXggPSBqUXVlcnkuZmluZC5hdHRyKCBlbGVtLCAidGFiaW5kZXgiICk7DQoNCgkJCQlpZiAoIHRhYmluZGV4ICkgew0KCQkJCQlyZXR1cm4gcGFyc2VJbnQoIHRhYmluZGV4LCAxMCApOw0KCQkJCX0NCg0KCQkJCWlmICgNCgkJCQkJcmZvY3VzYWJsZS50ZXN0KCBlbGVtLm5vZGVOYW1lICkgfHwNCgkJCQkJcmNsaWNrYWJsZS50ZXN0KCBlbGVtLm5vZGVOYW1lICkgJiYNCgkJCQkJZWxlbS5ocmVmDQoJCQkJKSB7DQoJCQkJCXJldHVybiAwOw0KCQkJCX0NCg0KCQkJCXJldHVybiAtMTsNCgkJCX0NCgkJfQ0KCX0sDQoNCglwcm9wRml4OiB7DQoJCSJmb3IiOiAiaHRtbEZvciIsDQoJCSJjbGFzcyI6ICJjbGFzc05hbWUiDQoJfQ0KfSApOw0KDQovLyBTdXBwb3J0OiBJRSA8PTExIG9ubHkNCi8vIEFjY2Vzc2luZyB0aGUgc2VsZWN0ZWRJbmRleCBwcm9wZXJ0eQ0KLy8gZm9yY2VzIHRoZSBicm93c2VyIHRvIHJlc3BlY3Qgc2V0dGluZyBzZWxlY3RlZA0KLy8gb24gdGhlIG9wdGlvbg0KLy8gVGhlIGdldHRlciBlbnN1cmVzIGEgZGVmYXVsdCBvcHRpb24gaXMgc2VsZWN0ZWQNCi8vIHdoZW4gaW4gYW4gb3B0Z3JvdXANCi8vIGVzbGludCBydWxlICJuby11bnVzZWQtZXhwcmVzc2lvbnMiIGlzIGRpc2FibGVkIGZvciB0aGlzIGNvZGUNCi8vIHNpbmNlIGl0IGNvbnNpZGVycyBzdWNoIGFjY2Vzc2lvbnMgbm9vcA0KaWYgKCAhc3VwcG9ydC5vcHRTZWxlY3RlZCApIHsNCglqUXVlcnkucHJvcEhvb2tzLnNlbGVjdGVkID0gew0KCQlnZXQ6IGZ1bmN0aW9uKCBlbGVtICkgew0KDQoJCQkvKiBlc2xpbnQgbm8tdW51c2VkLWV4cHJlc3Npb25zOiAib2ZmIiAqLw0KDQoJCQl2YXIgcGFyZW50ID0gZWxlbS5wYXJlbnROb2RlOw0KCQkJaWYgKCBwYXJlbnQgJiYgcGFyZW50LnBhcmVudE5vZGUgKSB7DQoJCQkJcGFyZW50LnBhcmVudE5vZGUuc2VsZWN0ZWRJbmRleDsNCgkJCX0NCgkJCXJldHVybiBudWxsOw0KCQl9LA0KCQlzZXQ6IGZ1bmN0aW9uKCBlbGVtICkgew0KDQoJCQkvKiBlc2xpbnQgbm8tdW51c2VkLWV4cHJlc3Npb25zOiAib2ZmIiAqLw0KDQoJCQl2YXIgcGFyZW50ID0gZWxlbS5wYXJlbnROb2RlOw0KCQkJaWYgKCBwYXJlbnQgKSB7DQoJCQkJcGFyZW50LnNlbGVjdGVkSW5kZXg7DQoNCgkJCQlpZiAoIHBhcmVudC5wYXJlbnROb2RlICkgew0KCQkJCQlwYXJlbnQucGFyZW50Tm9kZS5zZWxlY3RlZEluZGV4Ow0KCQkJCX0NCgkJCX0NCgkJfQ0KCX07DQp9DQoNCmpRdWVyeS5lYWNoKCBbDQoJInRhYkluZGV4IiwNCgkicmVhZE9ubHkiLA0KCSJtYXhMZW5ndGgiLA0KCSJjZWxsU3BhY2luZyIsDQoJImNlbGxQYWRkaW5nIiwNCgkicm93U3BhbiIsDQoJImNvbFNwYW4iLA0KCSJ1c2VNYXAiLA0KCSJmcmFtZUJvcmRlciIsDQoJImNvbnRlbnRFZGl0YWJsZSINCl0sIGZ1bmN0aW9uKCkgew0KCWpRdWVyeS5wcm9wRml4WyB0aGlzLnRvTG93ZXJDYXNlKCkgXSA9IHRoaXM7DQp9ICk7DQoNCg0KDQoNCgkvLyBTdHJpcCBhbmQgY29sbGFwc2Ugd2hpdGVzcGFjZSBhY2NvcmRpbmcgdG8gSFRNTCBzcGVjDQoJLy8gaHR0cHM6Ly9pbmZyYS5zcGVjLndoYXR3Zy5vcmcvI3N0cmlwLWFuZC1jb2xsYXBzZS1hc2NpaS13aGl0ZXNwYWNlDQoJZnVuY3Rpb24gc3RyaXBBbmRDb2xsYXBzZSggdmFsdWUgKSB7DQoJCXZhciB0b2tlbnMgPSB2YWx1ZS5tYXRjaCggcm5vdGh0bWx3aGl0ZSApIHx8IFtdOw0KCQlyZXR1cm4gdG9rZW5zLmpvaW4oICIgIiApOw0KCX0NCg0KDQpmdW5jdGlvbiBnZXRDbGFzcyggZWxlbSApIHsNCglyZXR1cm4gZWxlbS5nZXRBdHRyaWJ1dGUgJiYgZWxlbS5nZXRBdHRyaWJ1dGUoICJjbGFzcyIgKSB8fCAiIjsNCn0NCg0KZnVuY3Rpb24gY2xhc3Nlc1RvQXJyYXkoIHZhbHVlICkgew0KCWlmICggQXJyYXkuaXNBcnJheSggdmFsdWUgKSApIHsNCgkJcmV0dXJuIHZhbHVlOw0KCX0NCglpZiAoIHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIgKSB7DQoJCXJldHVybiB2YWx1ZS5tYXRjaCggcm5vdGh0bWx3aGl0ZSApIHx8IFtdOw0KCX0NCglyZXR1cm4gW107DQp9DQoNCmpRdWVyeS5mbi5leHRlbmQoIHsNCglhZGRDbGFzczogZnVuY3Rpb24oIHZhbHVlICkgew0KCQl2YXIgY2xhc3NlcywgZWxlbSwgY3VyLCBjdXJWYWx1ZSwgY2xhenosIGosIGZpbmFsVmFsdWUsDQoJCQlpID0gMDsNCg0KCQlpZiAoIGlzRnVuY3Rpb24oIHZhbHVlICkgKSB7DQoJCQlyZXR1cm4gdGhpcy5lYWNoKCBmdW5jdGlvbiggaiApIHsNCgkJCQlqUXVlcnkoIHRoaXMgKS5hZGRDbGFzcyggdmFsdWUuY2FsbCggdGhpcywgaiwgZ2V0Q2xhc3MoIHRoaXMgKSApICk7DQoJCQl9ICk7DQoJCX0NCg0KCQljbGFzc2VzID0gY2xhc3Nlc1RvQXJyYXkoIHZhbHVlICk7DQoNCgkJaWYgKCBjbGFzc2VzLmxlbmd0aCApIHsNCgkJCXdoaWxlICggKCBlbGVtID0gdGhpc1sgaSsrIF0gKSApIHsNCgkJCQljdXJWYWx1ZSA9IGdldENsYXNzKCBlbGVtICk7DQoJCQkJY3VyID0gZWxlbS5ub2RlVHlwZSA9PT0gMSAmJiAoICIgIiArIHN0cmlwQW5kQ29sbGFwc2UoIGN1clZhbHVlICkgKyAiICIgKTsNCg0KCQkJCWlmICggY3VyICkgew0KCQkJCQlqID0gMDsNCgkJCQkJd2hpbGUgKCAoIGNsYXp6ID0gY2xhc3Nlc1sgaisrIF0gKSApIHsNCgkJCQkJCWlmICggY3VyLmluZGV4T2YoICIgIiArIGNsYXp6ICsgIiAiICkgPCAwICkgew0KCQkJCQkJCWN1ciArPSBjbGF6eiArICIgIjsNCgkJCQkJCX0NCgkJCQkJfQ0KDQoJCQkJCS8vIE9ubHkgYXNzaWduIGlmIGRpZmZlcmVudCB0byBhdm9pZCB1bm5lZWRlZCByZW5kZXJpbmcuDQoJCQkJCWZpbmFsVmFsdWUgPSBzdHJpcEFuZENvbGxhcHNlKCBjdXIgKTsNCgkJCQkJaWYgKCBjdXJWYWx1ZSAhPT0gZmluYWxWYWx1ZSApIHsNCgkJCQkJCWVsZW0uc2V0QXR0cmlidXRlKCAiY2xhc3MiLCBmaW5hbFZhbHVlICk7DQoJCQkJCX0NCgkJCQl9DQoJCQl9DQoJCX0NCg0KCQlyZXR1cm4gdGhpczsNCgl9LA0KDQoJcmVtb3ZlQ2xhc3M6IGZ1bmN0aW9uKCB2YWx1ZSApIHsNCgkJdmFyIGNsYXNzZXMsIGVsZW0sIGN1ciwgY3VyVmFsdWUsIGNsYXp6LCBqLCBmaW5hbFZhbHVlLA0KCQkJaSA9IDA7DQoNCgkJaWYgKCBpc0Z1bmN0aW9uKCB2YWx1ZSApICkgew0KCQkJcmV0dXJuIHRoaXMuZWFjaCggZnVuY3Rpb24oIGogKSB7DQoJCQkJalF1ZXJ5KCB0aGlzICkucmVtb3ZlQ2xhc3MoIHZhbHVlLmNhbGwoIHRoaXMsIGosIGdldENsYXNzKCB0aGlzICkgKSApOw0KCQkJfSApOw0KCQl9DQoNCgkJaWYgKCAhYXJndW1lbnRzLmxlbmd0aCApIHsNCgkJCXJldHVybiB0aGlzLmF0dHIoICJjbGFzcyIsICIiICk7DQoJCX0NCg0KCQljbGFzc2VzID0gY2xhc3Nlc1RvQXJyYXkoIHZhbHVlICk7DQoNCgkJaWYgKCBjbGFzc2VzLmxlbmd0aCApIHsNCgkJCXdoaWxlICggKCBlbGVtID0gdGhpc1sgaSsrIF0gKSApIHsNCgkJCQljdXJWYWx1ZSA9IGdldENsYXNzKCBlbGVtICk7DQoNCgkJCQkvLyBUaGlzIGV4cHJlc3Npb24gaXMgaGVyZSBmb3IgYmV0dGVyIGNvbXByZXNzaWJpbGl0eSAoc2VlIGFkZENsYXNzKQ0KCQkJCWN1ciA9IGVsZW0ubm9kZVR5cGUgPT09IDEgJiYgKCAiICIgKyBzdHJpcEFuZENvbGxhcHNlKCBjdXJWYWx1ZSApICsgIiAiICk7DQoNCgkJCQlpZiAoIGN1ciApIHsNCgkJCQkJaiA9IDA7DQoJCQkJCXdoaWxlICggKCBjbGF6eiA9IGNsYXNzZXNbIGorKyBdICkgKSB7DQoNCgkJCQkJCS8vIFJlbW92ZSAqYWxsKiBpbnN0YW5jZXMNCgkJCQkJCXdoaWxlICggY3VyLmluZGV4T2YoICIgIiArIGNsYXp6ICsgIiAiICkgPiAtMSApIHsNCgkJCQkJCQljdXIgPSBjdXIucmVwbGFjZSggIiAiICsgY2xhenogKyAiICIsICIgIiApOw0KCQkJCQkJfQ0KCQkJCQl9DQoNCgkJCQkJLy8gT25seSBhc3NpZ24gaWYgZGlmZmVyZW50IHRvIGF2b2lkIHVubmVlZGVkIHJlbmRlcmluZy4NCgkJCQkJZmluYWxWYWx1ZSA9IHN0cmlwQW5kQ29sbGFwc2UoIGN1ciApOw0KCQkJCQlpZiAoIGN1clZhbHVlICE9PSBmaW5hbFZhbHVlICkgew0KCQkJCQkJZWxlbS5zZXRBdHRyaWJ1dGUoICJjbGFzcyIsIGZpbmFsVmFsdWUgKTsNCgkJCQkJfQ0KCQkJCX0NCgkJCX0NCgkJfQ0KDQoJCXJldHVybiB0aGlzOw0KCX0sDQoNCgl0b2dnbGVDbGFzczogZnVuY3Rpb24oIHZhbHVlLCBzdGF0ZVZhbCApIHsNCgkJdmFyIHR5cGUgPSB0eXBlb2YgdmFsdWUsDQoJCQlpc1ZhbGlkVmFsdWUgPSB0eXBlID09PSAic3RyaW5nIiB8fCBBcnJheS5pc0FycmF5KCB2YWx1ZSApOw0KDQoJCWlmICggdHlwZW9mIHN0YXRlVmFsID09PSAiYm9vbGVhbiIgJiYgaXNWYWxpZFZhbHVlICkgew0KCQkJcmV0dXJuIHN0YXRlVmFsID8gdGhpcy5hZGRDbGFzcyggdmFsdWUgKSA6IHRoaXMucmVtb3ZlQ2xhc3MoIHZhbHVlICk7DQoJCX0NCg0KCQlpZiAoIGlzRnVuY3Rpb24oIHZhbHVlICkgKSB7DQoJCQlyZXR1cm4gdGhpcy5lYWNoKCBmdW5jdGlvbiggaSApIHsNCgkJCQlqUXVlcnkoIHRoaXMgKS50b2dnbGVDbGFzcygNCgkJCQkJdmFsdWUuY2FsbCggdGhpcywgaSwgZ2V0Q2xhc3MoIHRoaXMgKSwgc3RhdGVWYWwgKSwNCgkJCQkJc3RhdGVWYWwNCgkJCQkpOw0KCQkJfSApOw0KCQl9DQoNCgkJcmV0dXJuIHRoaXMuZWFjaCggZnVuY3Rpb24oKSB7DQoJCQl2YXIgY2xhc3NOYW1lLCBpLCBzZWxmLCBjbGFzc05hbWVzOw0KDQoJCQlpZiAoIGlzVmFsaWRWYWx1ZSApIHsNCg0KCQkJCS8vIFRvZ2dsZSBpbmRpdmlkdWFsIGNsYXNzIG5hbWVzDQoJCQkJaSA9IDA7DQoJCQkJc2VsZiA9IGpRdWVyeSggdGhpcyApOw0KCQkJCWNsYXNzTmFtZXMgPSBjbGFzc2VzVG9BcnJheSggdmFsdWUgKTsNCg0KCQkJCXdoaWxlICggKCBjbGFzc05hbWUgPSBjbGFzc05hbWVzWyBpKysgXSApICkgew0KDQoJCQkJCS8vIENoZWNrIGVhY2ggY2xhc3NOYW1lIGdpdmVuLCBzcGFjZSBzZXBhcmF0ZWQgbGlzdA0KCQkJCQlpZiAoIHNlbGYuaGFzQ2xhc3MoIGNsYXNzTmFtZSApICkgew0KCQkJCQkJc2VsZi5yZW1vdmVDbGFzcyggY2xhc3NOYW1lICk7DQoJCQkJCX0gZWxzZSB7DQoJCQkJCQlzZWxmLmFkZENsYXNzKCBjbGFzc05hbWUgKTsNCgkJCQkJfQ0KCQkJCX0NCg0KCQkJLy8gVG9nZ2xlIHdob2xlIGNsYXNzIG5hbWUNCgkJCX0gZWxzZSBpZiAoIHZhbHVlID09PSB1bmRlZmluZWQgfHwgdHlwZSA9PT0gImJvb2xlYW4iICkgew0KCQkJCWNsYXNzTmFtZSA9IGdldENsYXNzKCB0aGlzICk7DQoJCQkJaWYgKCBjbGFzc05hbWUgKSB7DQoNCgkJCQkJLy8gU3RvcmUgY2xhc3NOYW1lIGlmIHNldA0KCQkJCQlkYXRhUHJpdi5zZXQoIHRoaXMsICJfX2NsYXNzTmFtZV9fIiwgY2xhc3NOYW1lICk7DQoJCQkJfQ0KDQoJCQkJLy8gSWYgdGhlIGVsZW1lbnQgaGFzIGEgY2xhc3MgbmFtZSBvciBpZiB3ZSdyZSBwYXNzZWQgYGZhbHNlYCwNCgkJCQkvLyB0aGVuIHJlbW92ZSB0aGUgd2hvbGUgY2xhc3NuYW1lIChpZiB0aGVyZSB3YXMgb25lLCB0aGUgYWJvdmUgc2F2ZWQgaXQpLg0KCQkJCS8vIE90aGVyd2lzZSBicmluZyBiYWNrIHdoYXRldmVyIHdhcyBwcmV2aW91c2x5IHNhdmVkIChpZiBhbnl0aGluZyksDQoJCQkJLy8gZmFsbGluZyBiYWNrIHRvIHRoZSBlbXB0eSBzdHJpbmcgaWYgbm90aGluZyB3YXMgc3RvcmVkLg0KCQkJCWlmICggdGhpcy5zZXRBdHRyaWJ1dGUgKSB7DQoJCQkJCXRoaXMuc2V0QXR0cmlidXRlKCAiY2xhc3MiLA0KCQkJCQkJY2xhc3NOYW1lIHx8IHZhbHVlID09PSBmYWxzZSA/DQoJCQkJCQkJIiIgOg0KCQkJCQkJCWRhdGFQcml2LmdldCggdGhpcywgIl9fY2xhc3NOYW1lX18iICkgfHwgIiINCgkJCQkJKTsNCgkJCQl9DQoJCQl9DQoJCX0gKTsNCgl9LA0KDQoJaGFzQ2xhc3M6IGZ1bmN0aW9uKCBzZWxlY3RvciApIHsNCgkJdmFyIGNsYXNzTmFtZSwgZWxlbSwNCgkJCWkgPSAwOw0KDQoJCWNsYXNzTmFtZSA9ICIgIiArIHNlbGVjdG9yICsgIiAiOw0KCQl3aGlsZSAoICggZWxlbSA9IHRoaXNbIGkrKyBdICkgKSB7DQoJCQlpZiAoIGVsZW0ubm9kZVR5cGUgPT09IDEgJiYNCgkJCQkoICIgIiArIHN0cmlwQW5kQ29sbGFwc2UoIGdldENsYXNzKCBlbGVtICkgKSArICIgIiApLmluZGV4T2YoIGNsYXNzTmFtZSApID4gLTEgKSB7DQoJCQkJcmV0dXJuIHRydWU7DQoJCQl9DQoJCX0NCg0KCQlyZXR1cm4gZmFsc2U7DQoJfQ0KfSApOw0KDQoNCg0KDQp2YXIgcnJldHVybiA9IC9cci9nOw0KDQpqUXVlcnkuZm4uZXh0ZW5kKCB7DQoJdmFsOiBmdW5jdGlvbiggdmFsdWUgKSB7DQoJCXZhciBob29rcywgcmV0LCB2YWx1ZUlzRnVuY3Rpb24sDQoJCQllbGVtID0gdGhpc1sgMCBdOw0KDQoJCWlmICggIWFyZ3VtZW50cy5sZW5ndGggKSB7DQoJCQlpZiAoIGVsZW0gKSB7DQoJCQkJaG9va3MgPSBqUXVlcnkudmFsSG9va3NbIGVsZW0udHlwZSBdIHx8DQoJCQkJCWpRdWVyeS52YWxIb29rc1sgZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpIF07DQoNCgkJCQlpZiAoIGhvb2tzICYmDQoJCQkJCSJnZXQiIGluIGhvb2tzICYmDQoJCQkJCSggcmV0ID0gaG9va3MuZ2V0KCBlbGVtLCAidmFsdWUiICkgKSAhPT0gdW5kZWZpbmVkDQoJCQkJKSB7DQoJCQkJCXJldHVybiByZXQ7DQoJCQkJfQ0KDQoJCQkJcmV0ID0gZWxlbS52YWx1ZTsNCg0KCQkJCS8vIEhhbmRsZSBtb3N0IGNvbW1vbiBzdHJpbmcgY2FzZXMNCgkJCQlpZiAoIHR5cGVvZiByZXQgPT09ICJzdHJpbmciICkgew0KCQkJCQlyZXR1cm4gcmV0LnJlcGxhY2UoIHJyZXR1cm4sICIiICk7DQoJCQkJfQ0KDQoJCQkJLy8gSGFuZGxlIGNhc2VzIHdoZXJlIHZhbHVlIGlzIG51bGwvdW5kZWYgb3IgbnVtYmVyDQoJCQkJcmV0dXJuIHJldCA9PSBudWxsID8gIiIgOiByZXQ7DQoJCQl9DQoNCgkJCXJldHVybjsNCgkJfQ0KDQoJCXZhbHVlSXNGdW5jdGlvbiA9IGlzRnVuY3Rpb24oIHZhbHVlICk7DQoNCgkJcmV0dXJuIHRoaXMuZWFjaCggZnVuY3Rpb24oIGkgKSB7DQoJCQl2YXIgdmFsOw0KDQoJCQlpZiAoIHRoaXMubm9kZVR5cGUgIT09IDEgKSB7DQoJCQkJcmV0dXJuOw0KCQkJfQ0KDQoJCQlpZiAoIHZhbHVlSXNGdW5jdGlvbiApIHsNCgkJCQl2YWwgPSB2YWx1ZS5jYWxsKCB0aGlzLCBpLCBqUXVlcnkoIHRoaXMgKS52YWwoKSApOw0KCQkJfSBlbHNlIHsNCgkJCQl2YWwgPSB2YWx1ZTsNCgkJCX0NCg0KCQkJLy8gVHJlYXQgbnVsbC91bmRlZmluZWQgYXMgIiI7IGNvbnZlcnQgbnVtYmVycyB0byBzdHJpbmcNCgkJCWlmICggdmFsID09IG51bGwgKSB7DQoJCQkJdmFsID0gIiI7DQoNCgkJCX0gZWxzZSBpZiAoIHR5cGVvZiB2YWwgPT09ICJudW1iZXIiICkgew0KCQkJCXZhbCArPSAiIjsNCg0KCQkJfSBlbHNlIGlmICggQXJyYXkuaXNBcnJheSggdmFsICkgKSB7DQoJCQkJdmFsID0galF1ZXJ5Lm1hcCggdmFsLCBmdW5jdGlvbiggdmFsdWUgKSB7DQoJCQkJCXJldHVybiB2YWx1ZSA9PSBudWxsID8gIiIgOiB2YWx1ZSArICIiOw0KCQkJCX0gKTsNCgkJCX0NCg0KCQkJaG9va3MgPSBqUXVlcnkudmFsSG9va3NbIHRoaXMudHlwZSBdIHx8IGpRdWVyeS52YWxIb29rc1sgdGhpcy5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpIF07DQoNCgkJCS8vIElmIHNldCByZXR1cm5zIHVuZGVmaW5lZCwgZmFsbCBiYWNrIHRvIG5vcm1hbCBzZXR0aW5nDQoJCQlpZiAoICFob29rcyB8fCAhKCAic2V0IiBpbiBob29rcyApIHx8IGhvb2tzLnNldCggdGhpcywgdmFsLCAidmFsdWUiICkgPT09IHVuZGVmaW5lZCApIHsNCgkJCQl0aGlzLnZhbHVlID0gdmFsOw0KCQkJfQ0KCQl9ICk7DQoJfQ0KfSApOw0KDQpqUXVlcnkuZXh0ZW5kKCB7DQoJdmFsSG9va3M6IHsNCgkJb3B0aW9uOiB7DQoJCQlnZXQ6IGZ1bmN0aW9uKCBlbGVtICkgew0KDQoJCQkJdmFyIHZhbCA9IGpRdWVyeS5maW5kLmF0dHIoIGVsZW0sICJ2YWx1ZSIgKTsNCgkJCQlyZXR1cm4gdmFsICE9IG51bGwgPw0KCQkJCQl2YWwgOg0KDQoJCQkJCS8vIFN1cHBvcnQ6IElFIDw9MTAgLSAxMSBvbmx5DQoJCQkJCS8vIG9wdGlvbi50ZXh0IHRocm93cyBleGNlcHRpb25zICgjMTQ2ODYsICMxNDg1OCkNCgkJCQkJLy8gU3RyaXAgYW5kIGNvbGxhcHNlIHdoaXRlc3BhY2UNCgkJCQkJLy8gaHR0cHM6Ly9odG1sLnNwZWMud2hhdHdnLm9yZy8jc3RyaXAtYW5kLWNvbGxhcHNlLXdoaXRlc3BhY2UNCgkJCQkJc3RyaXBBbmRDb2xsYXBzZSggalF1ZXJ5LnRleHQoIGVsZW0gKSApOw0KCQkJfQ0KCQl9LA0KCQlzZWxlY3Q6IHsNCgkJCWdldDogZnVuY3Rpb24oIGVsZW0gKSB7DQoJCQkJdmFyIHZhbHVlLCBvcHRpb24sIGksDQoJCQkJCW9wdGlvbnMgPSBlbGVtLm9wdGlvbnMsDQoJCQkJCWluZGV4ID0gZWxlbS5zZWxlY3RlZEluZGV4LA0KCQkJCQlvbmUgPSBlbGVtLnR5cGUgPT09ICJzZWxlY3Qtb25lIiwNCgkJCQkJdmFsdWVzID0gb25lID8gbnVsbCA6IFtdLA0KCQkJCQltYXggPSBvbmUgPyBpbmRleCArIDEgOiBvcHRpb25zLmxlbmd0aDsNCg0KCQkJCWlmICggaW5kZXggPCAwICkgew0KCQkJCQlpID0gbWF4Ow0KDQoJCQkJfSBlbHNlIHsNCgkJCQkJaSA9IG9uZSA/IGluZGV4IDogMDsNCgkJCQl9DQoNCgkJCQkvLyBMb29wIHRocm91Z2ggYWxsIHRoZSBzZWxlY3RlZCBvcHRpb25zDQoJCQkJZm9yICggOyBpIDwgbWF4OyBpKysgKSB7DQoJCQkJCW9wdGlvbiA9IG9wdGlvbnNbIGkgXTsNCg0KCQkJCQkvLyBTdXBwb3J0OiBJRSA8PTkgb25seQ0KCQkJCQkvLyBJRTgtOSBkb2Vzbid0IHVwZGF0ZSBzZWxlY3RlZCBhZnRlciBmb3JtIHJlc2V0ICgjMjU1MSkNCgkJCQkJaWYgKCAoIG9wdGlvbi5zZWxlY3RlZCB8fCBpID09PSBpbmRleCApICYmDQoNCgkJCQkJCQkvLyBEb24ndCByZXR1cm4gb3B0aW9ucyB0aGF0IGFyZSBkaXNhYmxlZCBvciBpbiBhIGRpc2FibGVkIG9wdGdyb3VwDQoJCQkJCQkJIW9wdGlvbi5kaXNhYmxlZCAmJg0KCQkJCQkJCSggIW9wdGlvbi5wYXJlbnROb2RlLmRpc2FibGVkIHx8DQoJCQkJCQkJCSFub2RlTmFtZSggb3B0aW9uLnBhcmVudE5vZGUsICJvcHRncm91cCIgKSApICkgew0KDQoJCQkJCQkvLyBHZXQgdGhlIHNwZWNpZmljIHZhbHVlIGZvciB0aGUgb3B0aW9uDQoJCQkJCQl2YWx1ZSA9IGpRdWVyeSggb3B0aW9uICkudmFsKCk7DQoNCgkJCQkJCS8vIFdlIGRvbid0IG5lZWQgYW4gYXJyYXkgZm9yIG9uZSBzZWxlY3RzDQoJCQkJCQlpZiAoIG9uZSApIHsNCgkJCQkJCQlyZXR1cm4gdmFsdWU7DQoJCQkJCQl9DQoNCgkJCQkJCS8vIE11bHRpLVNlbGVjdHMgcmV0dXJuIGFuIGFycmF5DQoJCQkJCQl2YWx1ZXMucHVzaCggdmFsdWUgKTsNCgkJCQkJfQ0KCQkJCX0NCg0KCQkJCXJldHVybiB2YWx1ZXM7DQoJCQl9LA0KDQoJCQlzZXQ6IGZ1bmN0aW9uKCBlbGVtLCB2YWx1ZSApIHsNCgkJCQl2YXIgb3B0aW9uU2V0LCBvcHRpb24sDQoJCQkJCW9wdGlvbnMgPSBlbGVtLm9wdGlvbnMsDQoJCQkJCXZhbHVlcyA9IGpRdWVyeS5tYWtlQXJyYXkoIHZhbHVlICksDQoJCQkJCWkgPSBvcHRpb25zLmxlbmd0aDsNCg0KCQkJCXdoaWxlICggaS0tICkgew0KCQkJCQlvcHRpb24gPSBvcHRpb25zWyBpIF07DQoNCgkJCQkJLyogZXNsaW50LWRpc2FibGUgbm8tY29uZC1hc3NpZ24gKi8NCg0KCQkJCQlpZiAoIG9wdGlvbi5zZWxlY3RlZCA9DQoJCQkJCQlqUXVlcnkuaW5BcnJheSggalF1ZXJ5LnZhbEhvb2tzLm9wdGlvbi5nZXQoIG9wdGlvbiApLCB2YWx1ZXMgKSA+IC0xDQoJCQkJCSkgew0KCQkJCQkJb3B0aW9uU2V0ID0gdHJ1ZTsNCgkJCQkJfQ0KDQoJCQkJCS8qIGVzbGludC1lbmFibGUgbm8tY29uZC1hc3NpZ24gKi8NCgkJCQl9DQoNCgkJCQkvLyBGb3JjZSBicm93c2VycyB0byBiZWhhdmUgY29uc2lzdGVudGx5IHdoZW4gbm9uLW1hdGNoaW5nIHZhbHVlIGlzIHNldA0KCQkJCWlmICggIW9wdGlvblNldCApIHsNCgkJCQkJZWxlbS5zZWxlY3RlZEluZGV4ID0gLTE7DQoJCQkJfQ0KCQkJCXJldHVybiB2YWx1ZXM7DQoJCQl9DQoJCX0NCgl9DQp9ICk7DQoNCi8vIFJhZGlvcyBhbmQgY2hlY2tib3hlcyBnZXR0ZXIvc2V0dGVyDQpqUXVlcnkuZWFjaCggWyAicmFkaW8iLCAiY2hlY2tib3giIF0sIGZ1bmN0aW9uKCkgew0KCWpRdWVyeS52YWxIb29rc1sgdGhpcyBdID0gew0KCQlzZXQ6IGZ1bmN0aW9uKCBlbGVtLCB2YWx1ZSApIHsNCgkJCWlmICggQXJyYXkuaXNBcnJheSggdmFsdWUgKSApIHsNCgkJCQlyZXR1cm4gKCBlbGVtLmNoZWNrZWQgPSBqUXVlcnkuaW5BcnJheSggalF1ZXJ5KCBlbGVtICkudmFsKCksIHZhbHVlICkgPiAtMSApOw0KCQkJfQ0KCQl9DQoJfTsNCglpZiAoICFzdXBwb3J0LmNoZWNrT24gKSB7DQoJCWpRdWVyeS52YWxIb29rc1sgdGhpcyBdLmdldCA9IGZ1bmN0aW9uKCBlbGVtICkgew0KCQkJcmV0dXJuIGVsZW0uZ2V0QXR0cmlidXRlKCAidmFsdWUiICkgPT09IG51bGwgPyAib24iIDogZWxlbS52YWx1ZTsNCgkJfTsNCgl9DQp9ICk7DQoNCg0KDQoNCi8vIFJldHVybiBqUXVlcnkgZm9yIGF0dHJpYnV0ZXMtb25seSBpbmNsdXNpb24NCg0KDQpzdXBwb3J0LmZvY3VzaW4gPSAib25mb2N1c2luIiBpbiB3aW5kb3c7DQoNCg0KdmFyIHJmb2N1c01vcnBoID0gL14oPzpmb2N1c2luZm9jdXN8Zm9jdXNvdXRibHVyKSQvLA0KCXN0b3BQcm9wYWdhdGlvbkNhbGxiYWNrID0gZnVuY3Rpb24oIGUgKSB7DQoJCWUuc3RvcFByb3BhZ2F0aW9uKCk7DQoJfTsNCg0KalF1ZXJ5LmV4dGVuZCggalF1ZXJ5LmV2ZW50LCB7DQoNCgl0cmlnZ2VyOiBmdW5jdGlvbiggZXZlbnQsIGRhdGEsIGVsZW0sIG9ubHlIYW5kbGVycyApIHsNCg0KCQl2YXIgaSwgY3VyLCB0bXAsIGJ1YmJsZVR5cGUsIG9udHlwZSwgaGFuZGxlLCBzcGVjaWFsLCBsYXN0RWxlbWVudCwNCgkJCWV2ZW50UGF0aCA9IFsgZWxlbSB8fCBkb2N1bWVudCBdLA0KCQkJdHlwZSA9IGhhc093bi5jYWxsKCBldmVudCwgInR5cGUiICkgPyBldmVudC50eXBlIDogZXZlbnQsDQoJCQluYW1lc3BhY2VzID0gaGFzT3duLmNhbGwoIGV2ZW50LCAibmFtZXNwYWNlIiApID8gZXZlbnQubmFtZXNwYWNlLnNwbGl0KCAiLiIgKSA6IFtdOw0KDQoJCWN1ciA9IGxhc3RFbGVtZW50ID0gdG1wID0gZWxlbSA9IGVsZW0gfHwgZG9jdW1lbnQ7DQoNCgkJLy8gRG9uJ3QgZG8gZXZlbnRzIG9uIHRleHQgYW5kIGNvbW1lbnQgbm9kZXMNCgkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAzIHx8IGVsZW0ubm9kZVR5cGUgPT09IDggKSB7DQoJCQlyZXR1cm47DQoJCX0NCg0KCQkvLyBmb2N1cy9ibHVyIG1vcnBocyB0byBmb2N1c2luL291dDsgZW5zdXJlIHdlJ3JlIG5vdCBmaXJpbmcgdGhlbSByaWdodCBub3cNCgkJaWYgKCByZm9jdXNNb3JwaC50ZXN0KCB0eXBlICsgalF1ZXJ5LmV2ZW50LnRyaWdnZXJlZCApICkgew0KCQkJcmV0dXJuOw0KCQl9DQoNCgkJaWYgKCB0eXBlLmluZGV4T2YoICIuIiApID4gLTEgKSB7DQoNCgkJCS8vIE5hbWVzcGFjZWQgdHJpZ2dlcjsgY3JlYXRlIGEgcmVnZXhwIHRvIG1hdGNoIGV2ZW50IHR5cGUgaW4gaGFuZGxlKCkNCgkJCW5hbWVzcGFjZXMgPSB0eXBlLnNwbGl0KCAiLiIgKTsNCgkJCXR5cGUgPSBuYW1lc3BhY2VzLnNoaWZ0KCk7DQoJCQluYW1lc3BhY2VzLnNvcnQoKTsNCgkJfQ0KCQlvbnR5cGUgPSB0eXBlLmluZGV4T2YoICI6IiApIDwgMCAmJiAib24iICsgdHlwZTsNCg0KCQkvLyBDYWxsZXIgY2FuIHBhc3MgaW4gYSBqUXVlcnkuRXZlbnQgb2JqZWN0LCBPYmplY3QsIG9yIGp1c3QgYW4gZXZlbnQgdHlwZSBzdHJpbmcNCgkJZXZlbnQgPSBldmVudFsgalF1ZXJ5LmV4cGFuZG8gXSA/DQoJCQlldmVudCA6DQoJCQluZXcgalF1ZXJ5LkV2ZW50KCB0eXBlLCB0eXBlb2YgZXZlbnQgPT09ICJvYmplY3QiICYmIGV2ZW50ICk7DQoNCgkJLy8gVHJpZ2dlciBiaXRtYXNrOiAmIDEgZm9yIG5hdGl2ZSBoYW5kbGVyczsgJiAyIGZvciBqUXVlcnkgKGFsd2F5cyB0cnVlKQ0KCQlldmVudC5pc1RyaWdnZXIgPSBvbmx5SGFuZGxlcnMgPyAyIDogMzsNCgkJZXZlbnQubmFtZXNwYWNlID0gbmFtZXNwYWNlcy5qb2luKCAiLiIgKTsNCgkJZXZlbnQucm5hbWVzcGFjZSA9IGV2ZW50Lm5hbWVzcGFjZSA/DQoJCQluZXcgUmVnRXhwKCAiKF58XFwuKSIgKyBuYW1lc3BhY2VzLmpvaW4oICJcXC4oPzouKlxcLnwpIiApICsgIihcXC58JCkiICkgOg0KCQkJbnVsbDsNCg0KCQkvLyBDbGVhbiB1cCB0aGUgZXZlbnQgaW4gY2FzZSBpdCBpcyBiZWluZyByZXVzZWQNCgkJZXZlbnQucmVzdWx0ID0gdW5kZWZpbmVkOw0KCQlpZiAoICFldmVudC50YXJnZXQgKSB7DQoJCQlldmVudC50YXJnZXQgPSBlbGVtOw0KCQl9DQoNCgkJLy8gQ2xvbmUgYW55IGluY29taW5nIGRhdGEgYW5kIHByZXBlbmQgdGhlIGV2ZW50LCBjcmVhdGluZyB0aGUgaGFuZGxlciBhcmcgbGlzdA0KCQlkYXRhID0gZGF0YSA9PSBudWxsID8NCgkJCVsgZXZlbnQgXSA6DQoJCQlqUXVlcnkubWFrZUFycmF5KCBkYXRhLCBbIGV2ZW50IF0gKTsNCg0KCQkvLyBBbGxvdyBzcGVjaWFsIGV2ZW50cyB0byBkcmF3IG91dHNpZGUgdGhlIGxpbmVzDQoJCXNwZWNpYWwgPSBqUXVlcnkuZXZlbnQuc3BlY2lhbFsgdHlwZSBdIHx8IHt9Ow0KCQlpZiAoICFvbmx5SGFuZGxlcnMgJiYgc3BlY2lhbC50cmlnZ2VyICYmIHNwZWNpYWwudHJpZ2dlci5hcHBseSggZWxlbSwgZGF0YSApID09PSBmYWxzZSApIHsNCgkJCXJldHVybjsNCgkJfQ0KDQoJCS8vIERldGVybWluZSBldmVudCBwcm9wYWdhdGlvbiBwYXRoIGluIGFkdmFuY2UsIHBlciBXM0MgZXZlbnRzIHNwZWMgKCM5OTUxKQ0KCQkvLyBCdWJibGUgdXAgdG8gZG9jdW1lbnQsIHRoZW4gdG8gd2luZG93OyB3YXRjaCBmb3IgYSBnbG9iYWwgb3duZXJEb2N1bWVudCB2YXIgKCM5NzI0KQ0KCQlpZiAoICFvbmx5SGFuZGxlcnMgJiYgIXNwZWNpYWwubm9CdWJibGUgJiYgIWlzV2luZG93KCBlbGVtICkgKSB7DQoNCgkJCWJ1YmJsZVR5cGUgPSBzcGVjaWFsLmRlbGVnYXRlVHlwZSB8fCB0eXBlOw0KCQkJaWYgKCAhcmZvY3VzTW9ycGgudGVzdCggYnViYmxlVHlwZSArIHR5cGUgKSApIHsNCgkJCQljdXIgPSBjdXIucGFyZW50Tm9kZTsNCgkJCX0NCgkJCWZvciAoIDsgY3VyOyBjdXIgPSBjdXIucGFyZW50Tm9kZSApIHsNCgkJCQlldmVudFBhdGgucHVzaCggY3VyICk7DQoJCQkJdG1wID0gY3VyOw0KCQkJfQ0KDQoJCQkvLyBPbmx5IGFkZCB3aW5kb3cgaWYgd2UgZ290IHRvIGRvY3VtZW50IChlLmcuLCBub3QgcGxhaW4gb2JqIG9yIGRldGFjaGVkIERPTSkNCgkJCWlmICggdG1wID09PSAoIGVsZW0ub3duZXJEb2N1bWVudCB8fCBkb2N1bWVudCApICkgew0KCQkJCWV2ZW50UGF0aC5wdXNoKCB0bXAuZGVmYXVsdFZpZXcgfHwgdG1wLnBhcmVudFdpbmRvdyB8fCB3aW5kb3cgKTsNCgkJCX0NCgkJfQ0KDQoJCS8vIEZpcmUgaGFuZGxlcnMgb24gdGhlIGV2ZW50IHBhdGgNCgkJaSA9IDA7DQoJCXdoaWxlICggKCBjdXIgPSBldmVudFBhdGhbIGkrKyBdICkgJiYgIWV2ZW50LmlzUHJvcGFnYXRpb25TdG9wcGVkKCkgKSB7DQoJCQlsYXN0RWxlbWVudCA9IGN1cjsNCgkJCWV2ZW50LnR5cGUgPSBpID4gMSA/DQoJCQkJYnViYmxlVHlwZSA6DQoJCQkJc3BlY2lhbC5iaW5kVHlwZSB8fCB0eXBlOw0KDQoJCQkvLyBqUXVlcnkgaGFuZGxlcg0KCQkJaGFuZGxlID0gKCBkYXRhUHJpdi5nZXQoIGN1ciwgImV2ZW50cyIgKSB8fCBPYmplY3QuY3JlYXRlKCBudWxsICkgKVsgZXZlbnQudHlwZSBdICYmDQoJCQkJZGF0YVByaXYuZ2V0KCBjdXIsICJoYW5kbGUiICk7DQoJCQlpZiAoIGhhbmRsZSApIHsNCgkJCQloYW5kbGUuYXBwbHkoIGN1ciwgZGF0YSApOw0KCQkJfQ0KDQoJCQkvLyBOYXRpdmUgaGFuZGxlcg0KCQkJaGFuZGxlID0gb250eXBlICYmIGN1clsgb250eXBlIF07DQoJCQlpZiAoIGhhbmRsZSAmJiBoYW5kbGUuYXBwbHkgJiYgYWNjZXB0RGF0YSggY3VyICkgKSB7DQoJCQkJZXZlbnQucmVzdWx0ID0gaGFuZGxlLmFwcGx5KCBjdXIsIGRhdGEgKTsNCgkJCQlpZiAoIGV2ZW50LnJlc3VsdCA9PT0gZmFsc2UgKSB7DQoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7DQoJCQkJfQ0KCQkJfQ0KCQl9DQoJCWV2ZW50LnR5cGUgPSB0eXBlOw0KDQoJCS8vIElmIG5vYm9keSBwcmV2ZW50ZWQgdGhlIGRlZmF1bHQgYWN0aW9uLCBkbyBpdCBub3cNCgkJaWYgKCAhb25seUhhbmRsZXJzICYmICFldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsNCg0KCQkJaWYgKCAoICFzcGVjaWFsLl9kZWZhdWx0IHx8DQoJCQkJc3BlY2lhbC5fZGVmYXVsdC5hcHBseSggZXZlbnRQYXRoLnBvcCgpLCBkYXRhICkgPT09IGZhbHNlICkgJiYNCgkJCQlhY2NlcHREYXRhKCBlbGVtICkgKSB7DQoNCgkJCQkvLyBDYWxsIGEgbmF0aXZlIERPTSBtZXRob2Qgb24gdGhlIHRhcmdldCB3aXRoIHRoZSBzYW1lIG5hbWUgYXMgdGhlIGV2ZW50Lg0KCQkJCS8vIERvbid0IGRvIGRlZmF1bHQgYWN0aW9ucyBvbiB3aW5kb3csIHRoYXQncyB3aGVyZSBnbG9iYWwgdmFyaWFibGVzIGJlICgjNjE3MCkNCgkJCQlpZiAoIG9udHlwZSAmJiBpc0Z1bmN0aW9uKCBlbGVtWyB0eXBlIF0gKSAmJiAhaXNXaW5kb3coIGVsZW0gKSApIHsNCg0KCQkJCQkvLyBEb24ndCByZS10cmlnZ2VyIGFuIG9uRk9PIGV2ZW50IHdoZW4gd2UgY2FsbCBpdHMgRk9PKCkgbWV0aG9kDQoJCQkJCXRtcCA9IGVsZW1bIG9udHlwZSBdOw0KDQoJCQkJCWlmICggdG1wICkgew0KCQkJCQkJZWxlbVsgb250eXBlIF0gPSBudWxsOw0KCQkJCQl9DQoNCgkJCQkJLy8gUHJldmVudCByZS10cmlnZ2VyaW5nIG9mIHRoZSBzYW1lIGV2ZW50LCBzaW5jZSB3ZSBhbHJlYWR5IGJ1YmJsZWQgaXQgYWJvdmUNCgkJCQkJalF1ZXJ5LmV2ZW50LnRyaWdnZXJlZCA9IHR5cGU7DQoNCgkJCQkJaWYgKCBldmVudC5pc1Byb3BhZ2F0aW9uU3RvcHBlZCgpICkgew0KCQkJCQkJbGFzdEVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lciggdHlwZSwgc3RvcFByb3BhZ2F0aW9uQ2FsbGJhY2sgKTsNCgkJCQkJfQ0KDQoJCQkJCWVsZW1bIHR5cGUgXSgpOw0KDQoJCQkJCWlmICggZXZlbnQuaXNQcm9wYWdhdGlvblN0b3BwZWQoKSApIHsNCgkJCQkJCWxhc3RFbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoIHR5cGUsIHN0b3BQcm9wYWdhdGlvbkNhbGxiYWNrICk7DQoJCQkJCX0NCg0KCQkJCQlqUXVlcnkuZXZlbnQudHJpZ2dlcmVkID0gdW5kZWZpbmVkOw0KDQoJCQkJCWlmICggdG1wICkgew0KCQkJCQkJZWxlbVsgb250eXBlIF0gPSB0bXA7DQoJCQkJCX0NCgkJCQl9DQoJCQl9DQoJCX0NCg0KCQlyZXR1cm4gZXZlbnQucmVzdWx0Ow0KCX0sDQoNCgkvLyBQaWdneWJhY2sgb24gYSBkb25vciBldmVudCB0byBzaW11bGF0ZSBhIGRpZmZlcmVudCBvbmUNCgkvLyBVc2VkIG9ubHkgZm9yIGBmb2N1cyhpbiB8IG91dClgIGV2ZW50cw0KCXNpbXVsYXRlOiBmdW5jdGlvbiggdHlwZSwgZWxlbSwgZXZlbnQgKSB7DQoJCXZhciBlID0galF1ZXJ5LmV4dGVuZCgNCgkJCW5ldyBqUXVlcnkuRXZlbnQoKSwNCgkJCWV2ZW50LA0KCQkJew0KCQkJCXR5cGU6IHR5cGUsDQoJCQkJaXNTaW11bGF0ZWQ6IHRydWUNCgkJCX0NCgkJKTsNCg0KCQlqUXVlcnkuZXZlbnQudHJpZ2dlciggZSwgbnVsbCwgZWxlbSApOw0KCX0NCg0KfSApOw0KDQpqUXVlcnkuZm4uZXh0ZW5kKCB7DQoNCgl0cmlnZ2VyOiBmdW5jdGlvbiggdHlwZSwgZGF0YSApIHsNCgkJcmV0dXJuIHRoaXMuZWFjaCggZnVuY3Rpb24oKSB7DQoJCQlqUXVlcnkuZXZlbnQudHJpZ2dlciggdHlwZSwgZGF0YSwgdGhpcyApOw0KCQl9ICk7DQoJfSwNCgl0cmlnZ2VySGFuZGxlcjogZnVuY3Rpb24oIHR5cGUsIGRhdGEgKSB7DQoJCXZhciBlbGVtID0gdGhpc1sgMCBdOw0KCQlpZiAoIGVsZW0gKSB7DQoJCQlyZXR1cm4galF1ZXJ5LmV2ZW50LnRyaWdnZXIoIHR5cGUsIGRhdGEsIGVsZW0sIHRydWUgKTsNCgkJfQ0KCX0NCn0gKTsNCg0KDQovLyBTdXBwb3J0OiBGaXJlZm94IDw9NDQNCi8vIEZpcmVmb3ggZG9lc24ndCBoYXZlIGZvY3VzKGluIHwgb3V0KSBldmVudHMNCi8vIFJlbGF0ZWQgdGlja2V0IC0gaHR0cHM6Ly9idWd6aWxsYS5tb3ppbGxhLm9yZy9zaG93X2J1Zy5jZ2k/aWQ9Njg3Nzg3DQovLw0KLy8gU3VwcG9ydDogQ2hyb21lIDw9NDggLSA0OSwgU2FmYXJpIDw9OS4wIC0gOS4xDQovLyBmb2N1cyhpbiB8IG91dCkgZXZlbnRzIGZpcmUgYWZ0ZXIgZm9jdXMgJiBibHVyIGV2ZW50cywNCi8vIHdoaWNoIGlzIHNwZWMgdmlvbGF0aW9uIC0gaHR0cDovL3d3dy53My5vcmcvVFIvRE9NLUxldmVsLTMtRXZlbnRzLyNldmVudHMtZm9jdXNldmVudC1ldmVudC1vcmRlcg0KLy8gUmVsYXRlZCB0aWNrZXQgLSBodHRwczovL2J1Z3MuY2hyb21pdW0ub3JnL3AvY2hyb21pdW0vaXNzdWVzL2RldGFpbD9pZD00NDk4NTcNCmlmICggIXN1cHBvcnQuZm9jdXNpbiApIHsNCglqUXVlcnkuZWFjaCggeyBmb2N1czogImZvY3VzaW4iLCBibHVyOiAiZm9jdXNvdXQiIH0sIGZ1bmN0aW9uKCBvcmlnLCBmaXggKSB7DQoNCgkJLy8gQXR0YWNoIGEgc2luZ2xlIGNhcHR1cmluZyBoYW5kbGVyIG9uIHRoZSBkb2N1bWVudCB3aGlsZSBzb21lb25lIHdhbnRzIGZvY3VzaW4vZm9jdXNvdXQNCgkJdmFyIGhhbmRsZXIgPSBmdW5jdGlvbiggZXZlbnQgKSB7DQoJCQlqUXVlcnkuZXZlbnQuc2ltdWxhdGUoIGZpeCwgZXZlbnQudGFyZ2V0LCBqUXVlcnkuZXZlbnQuZml4KCBldmVudCApICk7DQoJCX07DQoNCgkJalF1ZXJ5LmV2ZW50LnNwZWNpYWxbIGZpeCBdID0gew0KCQkJc2V0dXA6IGZ1bmN0aW9uKCkgew0KDQoJCQkJLy8gSGFuZGxlOiByZWd1bGFyIG5vZGVzICh2aWEgYHRoaXMub3duZXJEb2N1bWVudGApLCB3aW5kb3cNCgkJCQkvLyAodmlhIGB0aGlzLmRvY3VtZW50YCkgJiBkb2N1bWVudCAodmlhIGB0aGlzYCkuDQoJCQkJdmFyIGRvYyA9IHRoaXMub3duZXJEb2N1bWVudCB8fCB0aGlzLmRvY3VtZW50IHx8IHRoaXMsDQoJCQkJCWF0dGFjaGVzID0gZGF0YVByaXYuYWNjZXNzKCBkb2MsIGZpeCApOw0KDQoJCQkJaWYgKCAhYXR0YWNoZXMgKSB7DQoJCQkJCWRvYy5hZGRFdmVudExpc3RlbmVyKCBvcmlnLCBoYW5kbGVyLCB0cnVlICk7DQoJCQkJfQ0KCQkJCWRhdGFQcml2LmFjY2VzcyggZG9jLCBmaXgsICggYXR0YWNoZXMgfHwgMCApICsgMSApOw0KCQkJfSwNCgkJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsNCgkJCQl2YXIgZG9jID0gdGhpcy5vd25lckRvY3VtZW50IHx8IHRoaXMuZG9jdW1lbnQgfHwgdGhpcywNCgkJCQkJYXR0YWNoZXMgPSBkYXRhUHJpdi5hY2Nlc3MoIGRvYywgZml4ICkgLSAxOw0KDQoJCQkJaWYgKCAhYXR0YWNoZXMgKSB7DQoJCQkJCWRvYy5yZW1vdmVFdmVudExpc3RlbmVyKCBvcmlnLCBoYW5kbGVyLCB0cnVlICk7DQoJCQkJCWRhdGFQcml2LnJlbW92ZSggZG9jLCBmaXggKTsNCg0KCQkJCX0gZWxzZSB7DQoJCQkJCWRhdGFQcml2LmFjY2VzcyggZG9jLCBmaXgsIGF0dGFjaGVzICk7DQoJCQkJfQ0KCQkJfQ0KCQl9Ow0KCX0gKTsNCn0NCnZhciBsb2NhdGlvbiA9IHdpbmRvdy5sb2NhdGlvbjsNCg0KdmFyIG5vbmNlID0geyBndWlkOiBEYXRlLm5vdygpIH07DQoNCnZhciBycXVlcnkgPSAoIC9cPy8gKTsNCg0KDQoNCi8vIENyb3NzLWJyb3dzZXIgeG1sIHBhcnNpbmcNCmpRdWVyeS5wYXJzZVhNTCA9IGZ1bmN0aW9uKCBkYXRhICkgew0KCXZhciB4bWwsIHBhcnNlckVycm9yRWxlbTsNCglpZiAoICFkYXRhIHx8IHR5cGVvZiBkYXRhICE9PSAic3RyaW5nIiApIHsNCgkJcmV0dXJuIG51bGw7DQoJfQ0KDQoJLy8gU3VwcG9ydDogSUUgOSAtIDExIG9ubHkNCgkvLyBJRSB0aHJvd3Mgb24gcGFyc2VGcm9tU3RyaW5nIHdpdGggaW52YWxpZCBpbnB1dC4NCgl0cnkgew0KCQl4bWwgPSAoIG5ldyB3aW5kb3cuRE9NUGFyc2VyKCkgKS5wYXJzZUZyb21TdHJpbmcoIGRhdGEsICJ0ZXh0L3htbCIgKTsNCgl9IGNhdGNoICggZSApIHt9DQoNCglwYXJzZXJFcnJvckVsZW0gPSB4bWwgJiYgeG1sLmdldEVsZW1lbnRzQnlUYWdOYW1lKCAicGFyc2VyZXJyb3IiIClbIDAgXTsNCglpZiAoICF4bWwgfHwgcGFyc2VyRXJyb3JFbGVtICkgew0KCQlqUXVlcnkuZXJyb3IoICJJbnZhbGlkIFhNTDogIiArICgNCgkJCXBhcnNlckVycm9yRWxlbSA/DQoJCQkJalF1ZXJ5Lm1hcCggcGFyc2VyRXJyb3JFbGVtLmNoaWxkTm9kZXMsIGZ1bmN0aW9uKCBlbCApIHsNCgkJCQkJcmV0dXJuIGVsLnRleHRDb250ZW50Ow0KCQkJCX0gKS5qb2luKCAiXG4iICkgOg0KCQkJCWRhdGENCgkJKSApOw0KCX0NCglyZXR1cm4geG1sOw0KfTsNCg0KDQp2YXINCglyYnJhY2tldCA9IC9cW1xdJC8sDQoJckNSTEYgPSAvXHI/XG4vZywNCglyc3VibWl0dGVyVHlwZXMgPSAvXig/OnN1Ym1pdHxidXR0b258aW1hZ2V8cmVzZXR8ZmlsZSkkL2ksDQoJcnN1Ym1pdHRhYmxlID0gL14oPzppbnB1dHxzZWxlY3R8dGV4dGFyZWF8a2V5Z2VuKS9pOw0KDQpmdW5jdGlvbiBidWlsZFBhcmFtcyggcHJlZml4LCBvYmosIHRyYWRpdGlvbmFsLCBhZGQgKSB7DQoJdmFyIG5hbWU7DQoNCglpZiAoIEFycmF5LmlzQXJyYXkoIG9iaiApICkgew0KDQoJCS8vIFNlcmlhbGl6ZSBhcnJheSBpdGVtLg0KCQlqUXVlcnkuZWFjaCggb2JqLCBmdW5jdGlvbiggaSwgdiApIHsNCgkJCWlmICggdHJhZGl0aW9uYWwgfHwgcmJyYWNrZXQudGVzdCggcHJlZml4ICkgKSB7DQoNCgkJCQkvLyBUcmVhdCBlYWNoIGFycmF5IGl0ZW0gYXMgYSBzY2FsYXIuDQoJCQkJYWRkKCBwcmVmaXgsIHYgKTsNCg0KCQkJfSBlbHNlIHsNCg0KCQkJCS8vIEl0ZW0gaXMgbm9uLXNjYWxhciAoYXJyYXkgb3Igb2JqZWN0KSwgZW5jb2RlIGl0cyBudW1lcmljIGluZGV4Lg0KCQkJCWJ1aWxkUGFyYW1zKA0KCQkJCQlwcmVmaXggKyAiWyIgKyAoIHR5cGVvZiB2ID09PSAib2JqZWN0IiAmJiB2ICE9IG51bGwgPyBpIDogIiIgKSArICJdIiwNCgkJCQkJdiwNCgkJCQkJdHJhZGl0aW9uYWwsDQoJCQkJCWFkZA0KCQkJCSk7DQoJCQl9DQoJCX0gKTsNCg0KCX0gZWxzZSBpZiAoICF0cmFkaXRpb25hbCAmJiB0b1R5cGUoIG9iaiApID09PSAib2JqZWN0IiApIHsNCg0KCQkvLyBTZXJpYWxpemUgb2JqZWN0IGl0ZW0uDQoJCWZvciAoIG5hbWUgaW4gb2JqICkgew0KCQkJYnVpbGRQYXJhbXMoIHByZWZpeCArICJbIiArIG5hbWUgKyAiXSIsIG9ialsgbmFtZSBdLCB0cmFkaXRpb25hbCwgYWRkICk7DQoJCX0NCg0KCX0gZWxzZSB7DQoNCgkJLy8gU2VyaWFsaXplIHNjYWxhciBpdGVtLg0KCQlhZGQoIHByZWZpeCwgb2JqICk7DQoJfQ0KfQ0KDQovLyBTZXJpYWxpemUgYW4gYXJyYXkgb2YgZm9ybSBlbGVtZW50cyBvciBhIHNldCBvZg0KLy8ga2V5L3ZhbHVlcyBpbnRvIGEgcXVlcnkgc3RyaW5nDQpqUXVlcnkucGFyYW0gPSBmdW5jdGlvbiggYSwgdHJhZGl0aW9uYWwgKSB7DQoJdmFyIHByZWZpeCwNCgkJcyA9IFtdLA0KCQlhZGQgPSBmdW5jdGlvbigga2V5LCB2YWx1ZU9yRnVuY3Rpb24gKSB7DQoNCgkJCS8vIElmIHZhbHVlIGlzIGEgZnVuY3Rpb24sIGludm9rZSBpdCBhbmQgdXNlIGl0cyByZXR1cm4gdmFsdWUNCgkJCXZhciB2YWx1ZSA9IGlzRnVuY3Rpb24oIHZhbHVlT3JGdW5jdGlvbiApID8NCgkJCQl2YWx1ZU9yRnVuY3Rpb24oKSA6DQoJCQkJdmFsdWVPckZ1bmN0aW9uOw0KDQoJCQlzWyBzLmxlbmd0aCBdID0gZW5jb2RlVVJJQ29tcG9uZW50KCBrZXkgKSArICI9IiArDQoJCQkJZW5jb2RlVVJJQ29tcG9uZW50KCB2YWx1ZSA9PSBudWxsID8gIiIgOiB2YWx1ZSApOw0KCQl9Ow0KDQoJaWYgKCBhID09IG51bGwgKSB7DQoJCXJldHVybiAiIjsNCgl9DQoNCgkvLyBJZiBhbiBhcnJheSB3YXMgcGFzc2VkIGluLCBhc3N1bWUgdGhhdCBpdCBpcyBhbiBhcnJheSBvZiBmb3JtIGVsZW1lbnRzLg0KCWlmICggQXJyYXkuaXNBcnJheSggYSApIHx8ICggYS5qcXVlcnkgJiYgIWpRdWVyeS5pc1BsYWluT2JqZWN0KCBhICkgKSApIHsNCg0KCQkvLyBTZXJpYWxpemUgdGhlIGZvcm0gZWxlbWVudHMNCgkJalF1ZXJ5LmVhY2goIGEsIGZ1bmN0aW9uKCkgew0KCQkJYWRkKCB0aGlzLm5hbWUsIHRoaXMudmFsdWUgKTsNCgkJfSApOw0KDQoJfSBlbHNlIHsNCg0KCQkvLyBJZiB0cmFkaXRpb25hbCwgZW5jb2RlIHRoZSAib2xkIiB3YXkgKHRoZSB3YXkgMS4zLjIgb3Igb2xkZXINCgkJLy8gZGlkIGl0KSwgb3RoZXJ3aXNlIGVuY29kZSBwYXJhbXMgcmVjdXJzaXZlbHkuDQoJCWZvciAoIHByZWZpeCBpbiBhICkgew0KCQkJYnVpbGRQYXJhbXMoIHByZWZpeCwgYVsgcHJlZml4IF0sIHRyYWRpdGlvbmFsLCBhZGQgKTsNCgkJfQ0KCX0NCg0KCS8vIFJldHVybiB0aGUgcmVzdWx0aW5nIHNlcmlhbGl6YXRpb24NCglyZXR1cm4gcy5qb2luKCAiJiIgKTsNCn07DQoNCmpRdWVyeS5mbi5leHRlbmQoIHsNCglzZXJpYWxpemU6IGZ1bmN0aW9uKCkgew0KCQlyZXR1cm4galF1ZXJ5LnBhcmFtKCB0aGlzLnNlcmlhbGl6ZUFycmF5KCkgKTsNCgl9LA0KCXNlcmlhbGl6ZUFycmF5OiBmdW5jdGlvbigpIHsNCgkJcmV0dXJuIHRoaXMubWFwKCBmdW5jdGlvbigpIHsNCg0KCQkJLy8gQ2FuIGFkZCBwcm9wSG9vayBmb3IgImVsZW1lbnRzIiB0byBmaWx0ZXIgb3IgYWRkIGZvcm0gZWxlbWVudHMNCgkJCXZhciBlbGVtZW50cyA9IGpRdWVyeS5wcm9wKCB0aGlzLCAiZWxlbWVudHMiICk7DQoJCQlyZXR1cm4gZWxlbWVudHMgPyBqUXVlcnkubWFrZUFycmF5KCBlbGVtZW50cyApIDogdGhpczsNCgkJfSApLmZpbHRlciggZnVuY3Rpb24oKSB7DQoJCQl2YXIgdHlwZSA9IHRoaXMudHlwZTsNCg0KCQkJLy8gVXNlIC5pcyggIjpkaXNhYmxlZCIgKSBzbyB0aGF0IGZpZWxkc2V0W2Rpc2FibGVkXSB3b3Jrcw0KCQkJcmV0dXJuIHRoaXMubmFtZSAmJiAhalF1ZXJ5KCB0aGlzICkuaXMoICI6ZGlzYWJsZWQiICkgJiYNCgkJCQlyc3VibWl0dGFibGUudGVzdCggdGhpcy5ub2RlTmFtZSApICYmICFyc3VibWl0dGVyVHlwZXMudGVzdCggdHlwZSApICYmDQoJCQkJKCB0aGlzLmNoZWNrZWQgfHwgIXJjaGVja2FibGVUeXBlLnRlc3QoIHR5cGUgKSApOw0KCQl9ICkubWFwKCBmdW5jdGlvbiggX2ksIGVsZW0gKSB7DQoJCQl2YXIgdmFsID0galF1ZXJ5KCB0aGlzICkudmFsKCk7DQoNCgkJCWlmICggdmFsID09IG51bGwgKSB7DQoJCQkJcmV0dXJuIG51bGw7DQoJCQl9DQoNCgkJCWlmICggQXJyYXkuaXNBcnJheSggdmFsICkgKSB7DQoJCQkJcmV0dXJuIGpRdWVyeS5tYXAoIHZhbCwgZnVuY3Rpb24oIHZhbCApIHsNCgkJCQkJcmV0dXJuIHsgbmFtZTogZWxlbS5uYW1lLCB2YWx1ZTogdmFsLnJlcGxhY2UoIHJDUkxGLCAiXHJcbiIgKSB9Ow0KCQkJCX0gKTsNCgkJCX0NCg0KCQkJcmV0dXJuIHsgbmFtZTogZWxlbS5uYW1lLCB2YWx1ZTogdmFsLnJlcGxhY2UoIHJDUkxGLCAiXHJcbiIgKSB9Ow0KCQl9ICkuZ2V0KCk7DQoJfQ0KfSApOw0KDQoNCnZhcg0KCXIyMCA9IC8lMjAvZywNCglyaGFzaCA9IC8jLiokLywNCglyYW50aUNhY2hlID0gLyhbPyZdKV89W14mXSovLA0KCXJoZWFkZXJzID0gL14oLio/KTpbIFx0XSooW15cclxuXSopJC9tZywNCg0KCS8vICM3NjUzLCAjODEyNSwgIzgxNTI6IGxvY2FsIHByb3RvY29sIGRldGVjdGlvbg0KCXJsb2NhbFByb3RvY29sID0gL14oPzphYm91dHxhcHB8YXBwLXN0b3JhZ2V8ListZXh0ZW5zaW9ufGZpbGV8cmVzfHdpZGdldCk6JC8sDQoJcm5vQ29udGVudCA9IC9eKD86R0VUfEhFQUQpJC8sDQoJcnByb3RvY29sID0gL15cL1wvLywNCg0KCS8qIFByZWZpbHRlcnMNCgkgKiAxKSBUaGV5IGFyZSB1c2VmdWwgdG8gaW50cm9kdWNlIGN1c3RvbSBkYXRhVHlwZXMgKHNlZSBhamF4L2pzb25wLmpzIGZvciBhbiBleGFtcGxlKQ0KCSAqIDIpIFRoZXNlIGFyZSBjYWxsZWQ6DQoJICogICAgLSBCRUZPUkUgYXNraW5nIGZvciBhIHRyYW5zcG9ydA0KCSAqICAgIC0gQUZURVIgcGFyYW0gc2VyaWFsaXphdGlvbiAocy5kYXRhIGlzIGEgc3RyaW5nIGlmIHMucHJvY2Vzc0RhdGEgaXMgdHJ1ZSkNCgkgKiAzKSBrZXkgaXMgdGhlIGRhdGFUeXBlDQoJICogNCkgdGhlIGNhdGNoYWxsIHN5bWJvbCAiKiIgY2FuIGJlIHVzZWQNCgkgKiA1KSBleGVjdXRpb24gd2lsbCBzdGFydCB3aXRoIHRyYW5zcG9ydCBkYXRhVHlwZSBhbmQgVEhFTiBjb250aW51ZSBkb3duIHRvICIqIiBpZiBuZWVkZWQNCgkgKi8NCglwcmVmaWx0ZXJzID0ge30sDQoNCgkvKiBUcmFuc3BvcnRzIGJpbmRpbmdzDQoJICogMSkga2V5IGlzIHRoZSBkYXRhVHlwZQ0KCSAqIDIpIHRoZSBjYXRjaGFsbCBzeW1ib2wgIioiIGNhbiBiZSB1c2VkDQoJICogMykgc2VsZWN0aW9uIHdpbGwgc3RhcnQgd2l0aCB0cmFuc3BvcnQgZGF0YVR5cGUgYW5kIFRIRU4gZ28gdG8gIioiIGlmIG5lZWRlZA0KCSAqLw0KCXRyYW5zcG9ydHMgPSB7fSwNCg0KCS8vIEF2b2lkIGNvbW1lbnQtcHJvbG9nIGNoYXIgc2VxdWVuY2UgKCMxMDA5OCk7IG11c3QgYXBwZWFzZSBsaW50IGFuZCBldmFkZSBjb21wcmVzc2lvbg0KCWFsbFR5cGVzID0gIiovIi5jb25jYXQoICIqIiApLA0KDQoJLy8gQW5jaG9yIHRhZyBmb3IgcGFyc2luZyB0aGUgZG9jdW1lbnQgb3JpZ2luDQoJb3JpZ2luQW5jaG9yID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImEiICk7DQoNCm9yaWdpbkFuY2hvci5ocmVmID0gbG9jYXRpb24uaHJlZjsNCg0KLy8gQmFzZSAiY29uc3RydWN0b3IiIGZvciBqUXVlcnkuYWpheFByZWZpbHRlciBhbmQgalF1ZXJ5LmFqYXhUcmFuc3BvcnQNCmZ1bmN0aW9uIGFkZFRvUHJlZmlsdGVyc09yVHJhbnNwb3J0cyggc3RydWN0dXJlICkgew0KDQoJLy8gZGF0YVR5cGVFeHByZXNzaW9uIGlzIG9wdGlvbmFsIGFuZCBkZWZhdWx0cyB0byAiKiINCglyZXR1cm4gZnVuY3Rpb24oIGRhdGFUeXBlRXhwcmVzc2lvbiwgZnVuYyApIHsNCg0KCQlpZiAoIHR5cGVvZiBkYXRhVHlwZUV4cHJlc3Npb24gIT09ICJzdHJpbmciICkgew0KCQkJZnVuYyA9IGRhdGFUeXBlRXhwcmVzc2lvbjsNCgkJCWRhdGFUeXBlRXhwcmVzc2lvbiA9ICIqIjsNCgkJfQ0KDQoJCXZhciBkYXRhVHlwZSwNCgkJCWkgPSAwLA0KCQkJZGF0YVR5cGVzID0gZGF0YVR5cGVFeHByZXNzaW9uLnRvTG93ZXJDYXNlKCkubWF0Y2goIHJub3RodG1sd2hpdGUgKSB8fCBbXTsNCg0KCQlpZiAoIGlzRnVuY3Rpb24oIGZ1bmMgKSApIHsNCg0KCQkJLy8gRm9yIGVhY2ggZGF0YVR5cGUgaW4gdGhlIGRhdGFUeXBlRXhwcmVzc2lvbg0KCQkJd2hpbGUgKCAoIGRhdGFUeXBlID0gZGF0YVR5cGVzWyBpKysgXSApICkgew0KDQoJCQkJLy8gUHJlcGVuZCBpZiByZXF1ZXN0ZWQNCgkJCQlpZiAoIGRhdGFUeXBlWyAwIF0gPT09ICIrIiApIHsNCgkJCQkJZGF0YVR5cGUgPSBkYXRhVHlwZS5zbGljZSggMSApIHx8ICIqIjsNCgkJCQkJKCBzdHJ1Y3R1cmVbIGRhdGFUeXBlIF0gPSBzdHJ1Y3R1cmVbIGRhdGFUeXBlIF0gfHwgW10gKS51bnNoaWZ0KCBmdW5jICk7DQoNCgkJCQkvLyBPdGhlcndpc2UgYXBwZW5kDQoJCQkJfSBlbHNlIHsNCgkJCQkJKCBzdHJ1Y3R1cmVbIGRhdGFUeXBlIF0gPSBzdHJ1Y3R1cmVbIGRhdGFUeXBlIF0gfHwgW10gKS5wdXNoKCBmdW5jICk7DQoJCQkJfQ0KCQkJfQ0KCQl9DQoJfTsNCn0NCg0KLy8gQmFzZSBpbnNwZWN0aW9uIGZ1bmN0aW9uIGZvciBwcmVmaWx0ZXJzIGFuZCB0cmFuc3BvcnRzDQpmdW5jdGlvbiBpbnNwZWN0UHJlZmlsdGVyc09yVHJhbnNwb3J0cyggc3RydWN0dXJlLCBvcHRpb25zLCBvcmlnaW5hbE9wdGlvbnMsIGpxWEhSICkgew0KDQoJdmFyIGluc3BlY3RlZCA9IHt9LA0KCQlzZWVraW5nVHJhbnNwb3J0ID0gKCBzdHJ1Y3R1cmUgPT09IHRyYW5zcG9ydHMgKTsNCg0KCWZ1bmN0aW9uIGluc3BlY3QoIGRhdGFUeXBlICkgew0KCQl2YXIgc2VsZWN0ZWQ7DQoJCWluc3BlY3RlZFsgZGF0YVR5cGUgXSA9IHRydWU7DQoJCWpRdWVyeS5lYWNoKCBzdHJ1Y3R1cmVbIGRhdGFUeXBlIF0gfHwgW10sIGZ1bmN0aW9uKCBfLCBwcmVmaWx0ZXJPckZhY3RvcnkgKSB7DQoJCQl2YXIgZGF0YVR5cGVPclRyYW5zcG9ydCA9IHByZWZpbHRlck9yRmFjdG9yeSggb3B0aW9ucywgb3JpZ2luYWxPcHRpb25zLCBqcVhIUiApOw0KCQkJaWYgKCB0eXBlb2YgZGF0YVR5cGVPclRyYW5zcG9ydCA9PT0gInN0cmluZyIgJiYNCgkJCQkhc2Vla2luZ1RyYW5zcG9ydCAmJiAhaW5zcGVjdGVkWyBkYXRhVHlwZU9yVHJhbnNwb3J0IF0gKSB7DQoNCgkJCQlvcHRpb25zLmRhdGFUeXBlcy51bnNoaWZ0KCBkYXRhVHlwZU9yVHJhbnNwb3J0ICk7DQoJCQkJaW5zcGVjdCggZGF0YVR5cGVPclRyYW5zcG9ydCApOw0KCQkJCXJldHVybiBmYWxzZTsNCgkJCX0gZWxzZSBpZiAoIHNlZWtpbmdUcmFuc3BvcnQgKSB7DQoJCQkJcmV0dXJuICEoIHNlbGVjdGVkID0gZGF0YVR5cGVPclRyYW5zcG9ydCApOw0KCQkJfQ0KCQl9ICk7DQoJCXJldHVybiBzZWxlY3RlZDsNCgl9DQoNCglyZXR1cm4gaW5zcGVjdCggb3B0aW9ucy5kYXRhVHlwZXNbIDAgXSApIHx8ICFpbnNwZWN0ZWRbICIqIiBdICYmIGluc3BlY3QoICIqIiApOw0KfQ0KDQovLyBBIHNwZWNpYWwgZXh0ZW5kIGZvciBhamF4IG9wdGlvbnMNCi8vIHRoYXQgdGFrZXMgImZsYXQiIG9wdGlvbnMgKG5vdCB0byBiZSBkZWVwIGV4dGVuZGVkKQ0KLy8gRml4ZXMgIzk4ODcNCmZ1bmN0aW9uIGFqYXhFeHRlbmQoIHRhcmdldCwgc3JjICkgew0KCXZhciBrZXksIGRlZXAsDQoJCWZsYXRPcHRpb25zID0galF1ZXJ5LmFqYXhTZXR0aW5ncy5mbGF0T3B0aW9ucyB8fCB7fTsNCg0KCWZvciAoIGtleSBpbiBzcmMgKSB7DQoJCWlmICggc3JjWyBrZXkgXSAhPT0gdW5kZWZpbmVkICkgew0KCQkJKCBmbGF0T3B0aW9uc1sga2V5IF0gPyB0YXJnZXQgOiAoIGRlZXAgfHwgKCBkZWVwID0ge30gKSApIClbIGtleSBdID0gc3JjWyBrZXkgXTsNCgkJfQ0KCX0NCglpZiAoIGRlZXAgKSB7DQoJCWpRdWVyeS5leHRlbmQoIHRydWUsIHRhcmdldCwgZGVlcCApOw0KCX0NCg0KCXJldHVybiB0YXJnZXQ7DQp9DQoNCi8qIEhhbmRsZXMgcmVzcG9uc2VzIHRvIGFuIGFqYXggcmVxdWVzdDoNCiAqIC0gZmluZHMgdGhlIHJpZ2h0IGRhdGFUeXBlIChtZWRpYXRlcyBiZXR3ZWVuIGNvbnRlbnQtdHlwZSBhbmQgZXhwZWN0ZWQgZGF0YVR5cGUpDQogKiAtIHJldHVybnMgdGhlIGNvcnJlc3BvbmRpbmcgcmVzcG9uc2UNCiAqLw0KZnVuY3Rpb24gYWpheEhhbmRsZVJlc3BvbnNlcyggcywganFYSFIsIHJlc3BvbnNlcyApIHsNCg0KCXZhciBjdCwgdHlwZSwgZmluYWxEYXRhVHlwZSwgZmlyc3REYXRhVHlwZSwNCgkJY29udGVudHMgPSBzLmNvbnRlbnRzLA0KCQlkYXRhVHlwZXMgPSBzLmRhdGFUeXBlczsNCg0KCS8vIFJlbW92ZSBhdXRvIGRhdGFUeXBlIGFuZCBnZXQgY29udGVudC10eXBlIGluIHRoZSBwcm9jZXNzDQoJd2hpbGUgKCBkYXRhVHlwZXNbIDAgXSA9PT0gIioiICkgew0KCQlkYXRhVHlwZXMuc2hpZnQoKTsNCgkJaWYgKCBjdCA9PT0gdW5kZWZpbmVkICkgew0KCQkJY3QgPSBzLm1pbWVUeXBlIHx8IGpxWEhSLmdldFJlc3BvbnNlSGVhZGVyKCAiQ29udGVudC1UeXBlIiApOw0KCQl9DQoJfQ0KDQoJLy8gQ2hlY2sgaWYgd2UncmUgZGVhbGluZyB3aXRoIGEga25vd24gY29udGVudC10eXBlDQoJaWYgKCBjdCApIHsNCgkJZm9yICggdHlwZSBpbiBjb250ZW50cyApIHsNCgkJCWlmICggY29udGVudHNbIHR5cGUgXSAmJiBjb250ZW50c1sgdHlwZSBdLnRlc3QoIGN0ICkgKSB7DQoJCQkJZGF0YVR5cGVzLnVuc2hpZnQoIHR5cGUgKTsNCgkJCQlicmVhazsNCgkJCX0NCgkJfQ0KCX0NCg0KCS8vIENoZWNrIHRvIHNlZSBpZiB3ZSBoYXZlIGEgcmVzcG9uc2UgZm9yIHRoZSBleHBlY3RlZCBkYXRhVHlwZQ0KCWlmICggZGF0YVR5cGVzWyAwIF0gaW4gcmVzcG9uc2VzICkgew0KCQlmaW5hbERhdGFUeXBlID0gZGF0YVR5cGVzWyAwIF07DQoJfSBlbHNlIHsNCg0KCQkvLyBUcnkgY29udmVydGlibGUgZGF0YVR5cGVzDQoJCWZvciAoIHR5cGUgaW4gcmVzcG9uc2VzICkgew0KCQkJaWYgKCAhZGF0YVR5cGVzWyAwIF0gfHwgcy5jb252ZXJ0ZXJzWyB0eXBlICsgIiAiICsgZGF0YVR5cGVzWyAwIF0gXSApIHsNCgkJCQlmaW5hbERhdGFUeXBlID0gdHlwZTsNCgkJCQlicmVhazsNCgkJCX0NCgkJCWlmICggIWZpcnN0RGF0YVR5cGUgKSB7DQoJCQkJZmlyc3REYXRhVHlwZSA9IHR5cGU7DQoJCQl9DQoJCX0NCg0KCQkvLyBPciBqdXN0IHVzZSBmaXJzdCBvbmUNCgkJZmluYWxEYXRhVHlwZSA9IGZpbmFsRGF0YVR5cGUgfHwgZmlyc3REYXRhVHlwZTsNCgl9DQoNCgkvLyBJZiB3ZSBmb3VuZCBhIGRhdGFUeXBlDQoJLy8gV2UgYWRkIHRoZSBkYXRhVHlwZSB0byB0aGUgbGlzdCBpZiBuZWVkZWQNCgkvLyBhbmQgcmV0dXJuIHRoZSBjb3JyZXNwb25kaW5nIHJlc3BvbnNlDQoJaWYgKCBmaW5hbERhdGFUeXBlICkgew0KCQlpZiAoIGZpbmFsRGF0YVR5cGUgIT09IGRhdGFUeXBlc1sgMCBdICkgew0KCQkJZGF0YVR5cGVzLnVuc2hpZnQoIGZpbmFsRGF0YVR5cGUgKTsNCgkJfQ0KCQlyZXR1cm4gcmVzcG9uc2VzWyBmaW5hbERhdGFUeXBlIF07DQoJfQ0KfQ0KDQovKiBDaGFpbiBjb252ZXJzaW9ucyBnaXZlbiB0aGUgcmVxdWVzdCBhbmQgdGhlIG9yaWdpbmFsIHJlc3BvbnNlDQogKiBBbHNvIHNldHMgdGhlIHJlc3BvbnNlWFhYIGZpZWxkcyBvbiB0aGUganFYSFIgaW5zdGFuY2UNCiAqLw0KZnVuY3Rpb24gYWpheENvbnZlcnQoIHMsIHJlc3BvbnNlLCBqcVhIUiwgaXNTdWNjZXNzICkgew0KCXZhciBjb252MiwgY3VycmVudCwgY29udiwgdG1wLCBwcmV2LA0KCQljb252ZXJ0ZXJzID0ge30sDQoNCgkJLy8gV29yayB3aXRoIGEgY29weSBvZiBkYXRhVHlwZXMgaW4gY2FzZSB3ZSBuZWVkIHRvIG1vZGlmeSBpdCBmb3IgY29udmVyc2lvbg0KCQlkYXRhVHlwZXMgPSBzLmRhdGFUeXBlcy5zbGljZSgpOw0KDQoJLy8gQ3JlYXRlIGNvbnZlcnRlcnMgbWFwIHdpdGggbG93ZXJjYXNlZCBrZXlzDQoJaWYgKCBkYXRhVHlwZXNbIDEgXSApIHsNCgkJZm9yICggY29udiBpbiBzLmNvbnZlcnRlcnMgKSB7DQoJCQljb252ZXJ0ZXJzWyBjb252LnRvTG93ZXJDYXNlKCkgXSA9IHMuY29udmVydGVyc1sgY29udiBdOw0KCQl9DQoJfQ0KDQoJY3VycmVudCA9IGRhdGFUeXBlcy5zaGlmdCgpOw0KDQoJLy8gQ29udmVydCB0byBlYWNoIHNlcXVlbnRpYWwgZGF0YVR5cGUNCgl3aGlsZSAoIGN1cnJlbnQgKSB7DQoNCgkJaWYgKCBzLnJlc3BvbnNlRmllbGRzWyBjdXJyZW50IF0gKSB7DQoJCQlqcVhIUlsgcy5yZXNwb25zZUZpZWxkc1sgY3VycmVudCBdIF0gPSByZXNwb25zZTsNCgkJfQ0KDQoJCS8vIEFwcGx5IHRoZSBkYXRhRmlsdGVyIGlmIHByb3ZpZGVkDQoJCWlmICggIXByZXYgJiYgaXNTdWNjZXNzICYmIHMuZGF0YUZpbHRlciApIHsNCgkJCXJlc3BvbnNlID0gcy5kYXRhRmlsdGVyKCByZXNwb25zZSwgcy5kYXRhVHlwZSApOw0KCQl9DQoNCgkJcHJldiA9IGN1cnJlbnQ7DQoJCWN1cnJlbnQgPSBkYXRhVHlwZXMuc2hpZnQoKTsNCg0KCQlpZiAoIGN1cnJlbnQgKSB7DQoNCgkJCS8vIFRoZXJlJ3Mgb25seSB3b3JrIHRvIGRvIGlmIGN1cnJlbnQgZGF0YVR5cGUgaXMgbm9uLWF1dG8NCgkJCWlmICggY3VycmVudCA9PT0gIioiICkgew0KDQoJCQkJY3VycmVudCA9IHByZXY7DQoNCgkJCS8vIENvbnZlcnQgcmVzcG9uc2UgaWYgcHJldiBkYXRhVHlwZSBpcyBub24tYXV0byBhbmQgZGlmZmVycyBmcm9tIGN1cnJlbnQNCgkJCX0gZWxzZSBpZiAoIHByZXYgIT09ICIqIiAmJiBwcmV2ICE9PSBjdXJyZW50ICkgew0KDQoJCQkJLy8gU2VlayBhIGRpcmVjdCBjb252ZXJ0ZXINCgkJCQljb252ID0gY29udmVydGVyc1sgcHJldiArICIgIiArIGN1cnJlbnQgXSB8fCBjb252ZXJ0ZXJzWyAiKiAiICsgY3VycmVudCBdOw0KDQoJCQkJLy8gSWYgbm9uZSBmb3VuZCwgc2VlayBhIHBhaXINCgkJCQlpZiAoICFjb252ICkgew0KCQkJCQlmb3IgKCBjb252MiBpbiBjb252ZXJ0ZXJzICkgew0KDQoJCQkJCQkvLyBJZiBjb252MiBvdXRwdXRzIGN1cnJlbnQNCgkJCQkJCXRtcCA9IGNvbnYyLnNwbGl0KCAiICIgKTsNCgkJCQkJCWlmICggdG1wWyAxIF0gPT09IGN1cnJlbnQgKSB7DQoNCgkJCQkJCQkvLyBJZiBwcmV2IGNhbiBiZSBjb252ZXJ0ZWQgdG8gYWNjZXB0ZWQgaW5wdXQNCgkJCQkJCQljb252ID0gY29udmVydGVyc1sgcHJldiArICIgIiArIHRtcFsgMCBdIF0gfHwNCgkJCQkJCQkJY29udmVydGVyc1sgIiogIiArIHRtcFsgMCBdIF07DQoJCQkJCQkJaWYgKCBjb252ICkgew0KDQoJCQkJCQkJCS8vIENvbmRlbnNlIGVxdWl2YWxlbmNlIGNvbnZlcnRlcnMNCgkJCQkJCQkJaWYgKCBjb252ID09PSB0cnVlICkgew0KCQkJCQkJCQkJY29udiA9IGNvbnZlcnRlcnNbIGNvbnYyIF07DQoNCgkJCQkJCQkJLy8gT3RoZXJ3aXNlLCBpbnNlcnQgdGhlIGludGVybWVkaWF0ZSBkYXRhVHlwZQ0KCQkJCQkJCQl9IGVsc2UgaWYgKCBjb252ZXJ0ZXJzWyBjb252MiBdICE9PSB0cnVlICkgew0KCQkJCQkJCQkJY3VycmVudCA9IHRtcFsgMCBdOw0KCQkJCQkJCQkJZGF0YVR5cGVzLnVuc2hpZnQoIHRtcFsgMSBdICk7DQoJCQkJCQkJCX0NCgkJCQkJCQkJYnJlYWs7DQoJCQkJCQkJfQ0KCQkJCQkJfQ0KCQkJCQl9DQoJCQkJfQ0KDQoJCQkJLy8gQXBwbHkgY29udmVydGVyIChpZiBub3QgYW4gZXF1aXZhbGVuY2UpDQoJCQkJaWYgKCBjb252ICE9PSB0cnVlICkgew0KDQoJCQkJCS8vIFVubGVzcyBlcnJvcnMgYXJlIGFsbG93ZWQgdG8gYnViYmxlLCBjYXRjaCBhbmQgcmV0dXJuIHRoZW0NCgkJCQkJaWYgKCBjb252ICYmIHMudGhyb3dzICkgew0KCQkJCQkJcmVzcG9uc2UgPSBjb252KCByZXNwb25zZSApOw0KCQkJCQl9IGVsc2Ugew0KCQkJCQkJdHJ5IHsNCgkJCQkJCQlyZXNwb25zZSA9IGNvbnYoIHJlc3BvbnNlICk7DQoJCQkJCQl9IGNhdGNoICggZSApIHsNCgkJCQkJCQlyZXR1cm4gew0KCQkJCQkJCQlzdGF0ZTogInBhcnNlcmVycm9yIiwNCgkJCQkJCQkJZXJyb3I6IGNvbnYgPyBlIDogIk5vIGNvbnZlcnNpb24gZnJvbSAiICsgcHJldiArICIgdG8gIiArIGN1cnJlbnQNCgkJCQkJCQl9Ow0KCQkJCQkJfQ0KCQkJCQl9DQoJCQkJfQ0KCQkJfQ0KCQl9DQoJfQ0KDQoJcmV0dXJuIHsgc3RhdGU6ICJzdWNjZXNzIiwgZGF0YTogcmVzcG9uc2UgfTsNCn0NCg0KalF1ZXJ5LmV4dGVuZCggew0KDQoJLy8gQ291bnRlciBmb3IgaG9sZGluZyB0aGUgbnVtYmVyIG9mIGFjdGl2ZSBxdWVyaWVzDQoJYWN0aXZlOiAwLA0KDQoJLy8gTGFzdC1Nb2RpZmllZCBoZWFkZXIgY2FjaGUgZm9yIG5leHQgcmVxdWVzdA0KCWxhc3RNb2RpZmllZDoge30sDQoJZXRhZzoge30sDQoNCglhamF4U2V0dGluZ3M6IHsNCgkJdXJsOiBsb2NhdGlvbi5ocmVmLA0KCQl0eXBlOiAiR0VUIiwNCgkJaXNMb2NhbDogcmxvY2FsUHJvdG9jb2wudGVzdCggbG9jYXRpb24ucHJvdG9jb2wgKSwNCgkJZ2xvYmFsOiB0cnVlLA0KCQlwcm9jZXNzRGF0YTogdHJ1ZSwNCgkJYXN5bmM6IHRydWUsDQoJCWNvbnRlbnRUeXBlOiAiYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkOyBjaGFyc2V0PVVURi04IiwNCg0KCQkvKg0KCQl0aW1lb3V0OiAwLA0KCQlkYXRhOiBudWxsLA0KCQlkYXRhVHlwZTogbnVsbCwNCgkJdXNlcm5hbWU6IG51bGwsDQoJCXBhc3N3b3JkOiBudWxsLA0KCQljYWNoZTogbnVsbCwNCgkJdGhyb3dzOiBmYWxzZSwNCgkJdHJhZGl0aW9uYWw6IGZhbHNlLA0KCQloZWFkZXJzOiB7fSwNCgkJKi8NCg0KCQlhY2NlcHRzOiB7DQoJCQkiKiI6IGFsbFR5cGVzLA0KCQkJdGV4dDogInRleHQvcGxhaW4iLA0KCQkJaHRtbDogInRleHQvaHRtbCIsDQoJCQl4bWw6ICJhcHBsaWNhdGlvbi94bWwsIHRleHQveG1sIiwNCgkJCWpzb246ICJhcHBsaWNhdGlvbi9qc29uLCB0ZXh0L2phdmFzY3JpcHQiDQoJCX0sDQoNCgkJY29udGVudHM6IHsNCgkJCXhtbDogL1xieG1sXGIvLA0KCQkJaHRtbDogL1xiaHRtbC8sDQoJCQlqc29uOiAvXGJqc29uXGIvDQoJCX0sDQoNCgkJcmVzcG9uc2VGaWVsZHM6IHsNCgkJCXhtbDogInJlc3BvbnNlWE1MIiwNCgkJCXRleHQ6ICJyZXNwb25zZVRleHQiLA0KCQkJanNvbjogInJlc3BvbnNlSlNPTiINCgkJfSwNCg0KCQkvLyBEYXRhIGNvbnZlcnRlcnMNCgkJLy8gS2V5cyBzZXBhcmF0ZSBzb3VyY2UgKG9yIGNhdGNoYWxsICIqIikgYW5kIGRlc3RpbmF0aW9uIHR5cGVzIHdpdGggYSBzaW5nbGUgc3BhY2UNCgkJY29udmVydGVyczogew0KDQoJCQkvLyBDb252ZXJ0IGFueXRoaW5nIHRvIHRleHQNCgkJCSIqIHRleHQiOiBTdHJpbmcsDQoNCgkJCS8vIFRleHQgdG8gaHRtbCAodHJ1ZSA9IG5vIHRyYW5zZm9ybWF0aW9uKQ0KCQkJInRleHQgaHRtbCI6IHRydWUsDQoNCgkJCS8vIEV2YWx1YXRlIHRleHQgYXMgYSBqc29uIGV4cHJlc3Npb24NCgkJCSJ0ZXh0IGpzb24iOiBKU09OLnBhcnNlLA0KDQoJCQkvLyBQYXJzZSB0ZXh0IGFzIHhtbA0KCQkJInRleHQgeG1sIjogalF1ZXJ5LnBhcnNlWE1MDQoJCX0sDQoNCgkJLy8gRm9yIG9wdGlvbnMgdGhhdCBzaG91bGRuJ3QgYmUgZGVlcCBleHRlbmRlZDoNCgkJLy8geW91IGNhbiBhZGQgeW91ciBvd24gY3VzdG9tIG9wdGlvbnMgaGVyZSBpZg0KCQkvLyBhbmQgd2hlbiB5b3UgY3JlYXRlIG9uZSB0aGF0IHNob3VsZG4ndCBiZQ0KCQkvLyBkZWVwIGV4dGVuZGVkIChzZWUgYWpheEV4dGVuZCkNCgkJZmxhdE9wdGlvbnM6IHsNCgkJCXVybDogdHJ1ZSwNCgkJCWNvbnRleHQ6IHRydWUNCgkJfQ0KCX0sDQoNCgkvLyBDcmVhdGVzIGEgZnVsbCBmbGVkZ2VkIHNldHRpbmdzIG9iamVjdCBpbnRvIHRhcmdldA0KCS8vIHdpdGggYm90aCBhamF4U2V0dGluZ3MgYW5kIHNldHRpbmdzIGZpZWxkcy4NCgkvLyBJZiB0YXJnZXQgaXMgb21pdHRlZCwgd3JpdGVzIGludG8gYWpheFNldHRpbmdzLg0KCWFqYXhTZXR1cDogZnVuY3Rpb24oIHRhcmdldCwgc2V0dGluZ3MgKSB7DQoJCXJldHVybiBzZXR0aW5ncyA/DQoNCgkJCS8vIEJ1aWxkaW5nIGEgc2V0dGluZ3Mgb2JqZWN0DQoJCQlhamF4RXh0ZW5kKCBhamF4RXh0ZW5kKCB0YXJnZXQsIGpRdWVyeS5hamF4U2V0dGluZ3MgKSwgc2V0dGluZ3MgKSA6DQoNCgkJCS8vIEV4dGVuZGluZyBhamF4U2V0dGluZ3MNCgkJCWFqYXhFeHRlbmQoIGpRdWVyeS5hamF4U2V0dGluZ3MsIHRhcmdldCApOw0KCX0sDQoNCglhamF4UHJlZmlsdGVyOiBhZGRUb1ByZWZpbHRlcnNPclRyYW5zcG9ydHMoIHByZWZpbHRlcnMgKSwNCglhamF4VHJhbnNwb3J0OiBhZGRUb1ByZWZpbHRlcnNPclRyYW5zcG9ydHMoIHRyYW5zcG9ydHMgKSwNCg0KCS8vIE1haW4gbWV0aG9kDQoJYWpheDogZnVuY3Rpb24oIHVybCwgb3B0aW9ucyApIHsNCg0KCQkvLyBJZiB1cmwgaXMgYW4gb2JqZWN0LCBzaW11bGF0ZSBwcmUtMS41IHNpZ25hdHVyZQ0KCQlpZiAoIHR5cGVvZiB1cmwgPT09ICJvYmplY3QiICkgew0KCQkJb3B0aW9ucyA9IHVybDsNCgkJCXVybCA9IHVuZGVmaW5lZDsNCgkJfQ0KDQoJCS8vIEZvcmNlIG9wdGlvbnMgdG8gYmUgYW4gb2JqZWN0DQoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9Ow0KDQoJCXZhciB0cmFuc3BvcnQsDQoNCgkJCS8vIFVSTCB3aXRob3V0IGFudGktY2FjaGUgcGFyYW0NCgkJCWNhY2hlVVJMLA0KDQoJCQkvLyBSZXNwb25zZSBoZWFkZXJzDQoJCQlyZXNwb25zZUhlYWRlcnNTdHJpbmcsDQoJCQlyZXNwb25zZUhlYWRlcnMsDQoNCgkJCS8vIHRpbWVvdXQgaGFuZGxlDQoJCQl0aW1lb3V0VGltZXIsDQoNCgkJCS8vIFVybCBjbGVhbnVwIHZhcg0KCQkJdXJsQW5jaG9yLA0KDQoJCQkvLyBSZXF1ZXN0IHN0YXRlIChiZWNvbWVzIGZhbHNlIHVwb24gc2VuZCBhbmQgdHJ1ZSB1cG9uIGNvbXBsZXRpb24pDQoJCQljb21wbGV0ZWQsDQoNCgkJCS8vIFRvIGtub3cgaWYgZ2xvYmFsIGV2ZW50cyBhcmUgdG8gYmUgZGlzcGF0Y2hlZA0KCQkJZmlyZUdsb2JhbHMsDQoNCgkJCS8vIExvb3AgdmFyaWFibGUNCgkJCWksDQoNCgkJCS8vIHVuY2FjaGVkIHBhcnQgb2YgdGhlIHVybA0KCQkJdW5jYWNoZWQsDQoNCgkJCS8vIENyZWF0ZSB0aGUgZmluYWwgb3B0aW9ucyBvYmplY3QNCgkJCXMgPSBqUXVlcnkuYWpheFNldHVwKCB7fSwgb3B0aW9ucyApLA0KDQoJCQkvLyBDYWxsYmFja3MgY29udGV4dA0KCQkJY2FsbGJhY2tDb250ZXh0ID0gcy5jb250ZXh0IHx8IHMsDQoNCgkJCS8vIENvbnRleHQgZm9yIGdsb2JhbCBldmVudHMgaXMgY2FsbGJhY2tDb250ZXh0IGlmIGl0IGlzIGEgRE9NIG5vZGUgb3IgalF1ZXJ5IGNvbGxlY3Rpb24NCgkJCWdsb2JhbEV2ZW50Q29udGV4dCA9IHMuY29udGV4dCAmJg0KCQkJCSggY2FsbGJhY2tDb250ZXh0Lm5vZGVUeXBlIHx8IGNhbGxiYWNrQ29udGV4dC5qcXVlcnkgKSA/DQoJCQkJalF1ZXJ5KCBjYWxsYmFja0NvbnRleHQgKSA6DQoJCQkJalF1ZXJ5LmV2ZW50LA0KDQoJCQkvLyBEZWZlcnJlZHMNCgkJCWRlZmVycmVkID0galF1ZXJ5LkRlZmVycmVkKCksDQoJCQljb21wbGV0ZURlZmVycmVkID0galF1ZXJ5LkNhbGxiYWNrcyggIm9uY2UgbWVtb3J5IiApLA0KDQoJCQkvLyBTdGF0dXMtZGVwZW5kZW50IGNhbGxiYWNrcw0KCQkJc3RhdHVzQ29kZSA9IHMuc3RhdHVzQ29kZSB8fCB7fSwNCg0KCQkJLy8gSGVhZGVycyAodGhleSBhcmUgc2VudCBhbGwgYXQgb25jZSkNCgkJCXJlcXVlc3RIZWFkZXJzID0ge30sDQoJCQlyZXF1ZXN0SGVhZGVyc05hbWVzID0ge30sDQoNCgkJCS8vIERlZmF1bHQgYWJvcnQgbWVzc2FnZQ0KCQkJc3RyQWJvcnQgPSAiY2FuY2VsZWQiLA0KDQoJCQkvLyBGYWtlIHhocg0KCQkJanFYSFIgPSB7DQoJCQkJcmVhZHlTdGF0ZTogMCwNCg0KCQkJCS8vIEJ1aWxkcyBoZWFkZXJzIGhhc2h0YWJsZSBpZiBuZWVkZWQNCgkJCQlnZXRSZXNwb25zZUhlYWRlcjogZnVuY3Rpb24oIGtleSApIHsNCgkJCQkJdmFyIG1hdGNoOw0KCQkJCQlpZiAoIGNvbXBsZXRlZCApIHsNCgkJCQkJCWlmICggIXJlc3BvbnNlSGVhZGVycyApIHsNCgkJCQkJCQlyZXNwb25zZUhlYWRlcnMgPSB7fTsNCgkJCQkJCQl3aGlsZSAoICggbWF0Y2ggPSByaGVhZGVycy5leGVjKCByZXNwb25zZUhlYWRlcnNTdHJpbmcgKSApICkgew0KCQkJCQkJCQlyZXNwb25zZUhlYWRlcnNbIG1hdGNoWyAxIF0udG9Mb3dlckNhc2UoKSArICIgIiBdID0NCgkJCQkJCQkJCSggcmVzcG9uc2VIZWFkZXJzWyBtYXRjaFsgMSBdLnRvTG93ZXJDYXNlKCkgKyAiICIgXSB8fCBbXSApDQoJCQkJCQkJCQkJLmNvbmNhdCggbWF0Y2hbIDIgXSApOw0KCQkJCQkJCX0NCgkJCQkJCX0NCgkJCQkJCW1hdGNoID0gcmVzcG9uc2VIZWFkZXJzWyBrZXkudG9Mb3dlckNhc2UoKSArICIgIiBdOw0KCQkJCQl9DQoJCQkJCXJldHVybiBtYXRjaCA9PSBudWxsID8gbnVsbCA6IG1hdGNoLmpvaW4oICIsICIgKTsNCgkJCQl9LA0KDQoJCQkJLy8gUmF3IHN0cmluZw0KCQkJCWdldEFsbFJlc3BvbnNlSGVhZGVyczogZnVuY3Rpb24oKSB7DQoJCQkJCXJldHVybiBjb21wbGV0ZWQgPyByZXNwb25zZUhlYWRlcnNTdHJpbmcgOiBudWxsOw0KCQkJCX0sDQoNCgkJCQkvLyBDYWNoZXMgdGhlIGhlYWRlcg0KCQkJCXNldFJlcXVlc3RIZWFkZXI6IGZ1bmN0aW9uKCBuYW1lLCB2YWx1ZSApIHsNCgkJCQkJaWYgKCBjb21wbGV0ZWQgPT0gbnVsbCApIHsNCgkJCQkJCW5hbWUgPSByZXF1ZXN0SGVhZGVyc05hbWVzWyBuYW1lLnRvTG93ZXJDYXNlKCkgXSA9DQoJCQkJCQkJcmVxdWVzdEhlYWRlcnNOYW1lc1sgbmFtZS50b0xvd2VyQ2FzZSgpIF0gfHwgbmFtZTsNCgkJCQkJCXJlcXVlc3RIZWFkZXJzWyBuYW1lIF0gPSB2YWx1ZTsNCgkJCQkJfQ0KCQkJCQlyZXR1cm4gdGhpczsNCgkJCQl9LA0KDQoJCQkJLy8gT3ZlcnJpZGVzIHJlc3BvbnNlIGNvbnRlbnQtdHlwZSBoZWFkZXINCgkJCQlvdmVycmlkZU1pbWVUeXBlOiBmdW5jdGlvbiggdHlwZSApIHsNCgkJCQkJaWYgKCBjb21wbGV0ZWQgPT0gbnVsbCApIHsNCgkJCQkJCXMubWltZVR5cGUgPSB0eXBlOw0KCQkJCQl9DQoJCQkJCXJldHVybiB0aGlzOw0KCQkJCX0sDQoNCgkJCQkvLyBTdGF0dXMtZGVwZW5kZW50IGNhbGxiYWNrcw0KCQkJCXN0YXR1c0NvZGU6IGZ1bmN0aW9uKCBtYXAgKSB7DQoJCQkJCXZhciBjb2RlOw0KCQkJCQlpZiAoIG1hcCApIHsNCgkJCQkJCWlmICggY29tcGxldGVkICkgew0KDQoJCQkJCQkJLy8gRXhlY3V0ZSB0aGUgYXBwcm9wcmlhdGUgY2FsbGJhY2tzDQoJCQkJCQkJanFYSFIuYWx3YXlzKCBtYXBbIGpxWEhSLnN0YXR1cyBdICk7DQoJCQkJCQl9IGVsc2Ugew0KDQoJCQkJCQkJLy8gTGF6eS1hZGQgdGhlIG5ldyBjYWxsYmFja3MgaW4gYSB3YXkgdGhhdCBwcmVzZXJ2ZXMgb2xkIG9uZXMNCgkJCQkJCQlmb3IgKCBjb2RlIGluIG1hcCApIHsNCgkJCQkJCQkJc3RhdHVzQ29kZVsgY29kZSBdID0gWyBzdGF0dXNDb2RlWyBjb2RlIF0sIG1hcFsgY29kZSBdIF07DQoJCQkJCQkJfQ0KCQkJCQkJfQ0KCQkJCQl9DQoJCQkJCXJldHVybiB0aGlzOw0KCQkJCX0sDQoNCgkJCQkvLyBDYW5jZWwgdGhlIHJlcXVlc3QNCgkJCQlhYm9ydDogZnVuY3Rpb24oIHN0YXR1c1RleHQgKSB7DQoJCQkJCXZhciBmaW5hbFRleHQgPSBzdGF0dXNUZXh0IHx8IHN0ckFib3J0Ow0KCQkJCQlpZiAoIHRyYW5zcG9ydCApIHsNCgkJCQkJCXRyYW5zcG9ydC5hYm9ydCggZmluYWxUZXh0ICk7DQoJCQkJCX0NCgkJCQkJZG9uZSggMCwgZmluYWxUZXh0ICk7DQoJCQkJCXJldHVybiB0aGlzOw0KCQkJCX0NCgkJCX07DQoNCgkJLy8gQXR0YWNoIGRlZmVycmVkcw0KCQlkZWZlcnJlZC5wcm9taXNlKCBqcVhIUiApOw0KDQoJCS8vIEFkZCBwcm90b2NvbCBpZiBub3QgcHJvdmlkZWQgKHByZWZpbHRlcnMgbWlnaHQgZXhwZWN0IGl0KQ0KCQkvLyBIYW5kbGUgZmFsc3kgdXJsIGluIHRoZSBzZXR0aW5ncyBvYmplY3QgKCMxMDA5MzogY29uc2lzdGVuY3kgd2l0aCBvbGQgc2lnbmF0dXJlKQ0KCQkvLyBXZSBhbHNvIHVzZSB0aGUgdXJsIHBhcmFtZXRlciBpZiBhdmFpbGFibGUNCgkJcy51cmwgPSAoICggdXJsIHx8IHMudXJsIHx8IGxvY2F0aW9uLmhyZWYgKSArICIiICkNCgkJCS5yZXBsYWNlKCBycHJvdG9jb2wsIGxvY2F0aW9uLnByb3RvY29sICsgIi8vIiApOw0KDQoJCS8vIEFsaWFzIG1ldGhvZCBvcHRpb24gdG8gdHlwZSBhcyBwZXIgdGlja2V0ICMxMjAwNA0KCQlzLnR5cGUgPSBvcHRpb25zLm1ldGhvZCB8fCBvcHRpb25zLnR5cGUgfHwgcy5tZXRob2QgfHwgcy50eXBlOw0KDQoJCS8vIEV4dHJhY3QgZGF0YVR5cGVzIGxpc3QNCgkJcy5kYXRhVHlwZXMgPSAoIHMuZGF0YVR5cGUgfHwgIioiICkudG9Mb3dlckNhc2UoKS5tYXRjaCggcm5vdGh0bWx3aGl0ZSApIHx8IFsgIiIgXTsNCg0KCQkvLyBBIGNyb3NzLWRvbWFpbiByZXF1ZXN0IGlzIGluIG9yZGVyIHdoZW4gdGhlIG9yaWdpbiBkb2Vzbid0IG1hdGNoIHRoZSBjdXJyZW50IG9yaWdpbi4NCgkJaWYgKCBzLmNyb3NzRG9tYWluID09IG51bGwgKSB7DQoJCQl1cmxBbmNob3IgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiYSIgKTsNCg0KCQkJLy8gU3VwcG9ydDogSUUgPD04IC0gMTEsIEVkZ2UgMTIgLSAxNQ0KCQkJLy8gSUUgdGhyb3dzIGV4Y2VwdGlvbiBvbiBhY2Nlc3NpbmcgdGhlIGhyZWYgcHJvcGVydHkgaWYgdXJsIGlzIG1hbGZvcm1lZCwNCgkJCS8vIGUuZy4gaHR0cDovL2V4YW1wbGUuY29tOjgweC8NCgkJCXRyeSB7DQoJCQkJdXJsQW5jaG9yLmhyZWYgPSBzLnVybDsNCg0KCQkJCS8vIFN1cHBvcnQ6IElFIDw9OCAtIDExIG9ubHkNCgkJCQkvLyBBbmNob3IncyBob3N0IHByb3BlcnR5IGlzbid0IGNvcnJlY3RseSBzZXQgd2hlbiBzLnVybCBpcyByZWxhdGl2ZQ0KCQkJCXVybEFuY2hvci5ocmVmID0gdXJsQW5jaG9yLmhyZWY7DQoJCQkJcy5jcm9zc0RvbWFpbiA9IG9yaWdpbkFuY2hvci5wcm90b2NvbCArICIvLyIgKyBvcmlnaW5BbmNob3IuaG9zdCAhPT0NCgkJCQkJdXJsQW5jaG9yLnByb3RvY29sICsgIi8vIiArIHVybEFuY2hvci5ob3N0Ow0KCQkJfSBjYXRjaCAoIGUgKSB7DQoNCgkJCQkvLyBJZiB0aGVyZSBpcyBhbiBlcnJvciBwYXJzaW5nIHRoZSBVUkwsIGFzc3VtZSBpdCBpcyBjcm9zc0RvbWFpbiwNCgkJCQkvLyBpdCBjYW4gYmUgcmVqZWN0ZWQgYnkgdGhlIHRyYW5zcG9ydCBpZiBpdCBpcyBpbnZhbGlkDQoJCQkJcy5jcm9zc0RvbWFpbiA9IHRydWU7DQoJCQl9DQoJCX0NCg0KCQkvLyBDb252ZXJ0IGRhdGEgaWYgbm90IGFscmVhZHkgYSBzdHJpbmcNCgkJaWYgKCBzLmRhdGEgJiYgcy5wcm9jZXNzRGF0YSAmJiB0eXBlb2Ygcy5kYXRhICE9PSAic3RyaW5nIiApIHsNCgkJCXMuZGF0YSA9IGpRdWVyeS5wYXJhbSggcy5kYXRhLCBzLnRyYWRpdGlvbmFsICk7DQoJCX0NCg0KCQkvLyBBcHBseSBwcmVmaWx0ZXJzDQoJCWluc3BlY3RQcmVmaWx0ZXJzT3JUcmFuc3BvcnRzKCBwcmVmaWx0ZXJzLCBzLCBvcHRpb25zLCBqcVhIUiApOw0KDQoJCS8vIElmIHJlcXVlc3Qgd2FzIGFib3J0ZWQgaW5zaWRlIGEgcHJlZmlsdGVyLCBzdG9wIHRoZXJlDQoJCWlmICggY29tcGxldGVkICkgew0KCQkJcmV0dXJuIGpxWEhSOw0KCQl9DQoNCgkJLy8gV2UgY2FuIGZpcmUgZ2xvYmFsIGV2ZW50cyBhcyBvZiBub3cgaWYgYXNrZWQgdG8NCgkJLy8gRG9uJ3QgZmlyZSBldmVudHMgaWYgalF1ZXJ5LmV2ZW50IGlzIHVuZGVmaW5lZCBpbiBhbiBBTUQtdXNhZ2Ugc2NlbmFyaW8gKCMxNTExOCkNCgkJZmlyZUdsb2JhbHMgPSBqUXVlcnkuZXZlbnQgJiYgcy5nbG9iYWw7DQoNCgkJLy8gV2F0Y2ggZm9yIGEgbmV3IHNldCBvZiByZXF1ZXN0cw0KCQlpZiAoIGZpcmVHbG9iYWxzICYmIGpRdWVyeS5hY3RpdmUrKyA9PT0gMCApIHsNCgkJCWpRdWVyeS5ldmVudC50cmlnZ2VyKCAiYWpheFN0YXJ0IiApOw0KCQl9DQoNCgkJLy8gVXBwZXJjYXNlIHRoZSB0eXBlDQoJCXMudHlwZSA9IHMudHlwZS50b1VwcGVyQ2FzZSgpOw0KDQoJCS8vIERldGVybWluZSBpZiByZXF1ZXN0IGhhcyBjb250ZW50DQoJCXMuaGFzQ29udGVudCA9ICFybm9Db250ZW50LnRlc3QoIHMudHlwZSApOw0KDQoJCS8vIFNhdmUgdGhlIFVSTCBpbiBjYXNlIHdlJ3JlIHRveWluZyB3aXRoIHRoZSBJZi1Nb2RpZmllZC1TaW5jZQ0KCQkvLyBhbmQvb3IgSWYtTm9uZS1NYXRjaCBoZWFkZXIgbGF0ZXIgb24NCgkJLy8gUmVtb3ZlIGhhc2ggdG8gc2ltcGxpZnkgdXJsIG1hbmlwdWxhdGlvbg0KCQljYWNoZVVSTCA9IHMudXJsLnJlcGxhY2UoIHJoYXNoLCAiIiApOw0KDQoJCS8vIE1vcmUgb3B0aW9ucyBoYW5kbGluZyBmb3IgcmVxdWVzdHMgd2l0aCBubyBjb250ZW50DQoJCWlmICggIXMuaGFzQ29udGVudCApIHsNCg0KCQkJLy8gUmVtZW1iZXIgdGhlIGhhc2ggc28gd2UgY2FuIHB1dCBpdCBiYWNrDQoJCQl1bmNhY2hlZCA9IHMudXJsLnNsaWNlKCBjYWNoZVVSTC5sZW5ndGggKTsNCg0KCQkJLy8gSWYgZGF0YSBpcyBhdmFpbGFibGUgYW5kIHNob3VsZCBiZSBwcm9jZXNzZWQsIGFwcGVuZCBkYXRhIHRvIHVybA0KCQkJaWYgKCBzLmRhdGEgJiYgKCBzLnByb2Nlc3NEYXRhIHx8IHR5cGVvZiBzLmRhdGEgPT09ICJzdHJpbmciICkgKSB7DQoJCQkJY2FjaGVVUkwgKz0gKCBycXVlcnkudGVzdCggY2FjaGVVUkwgKSA/ICImIiA6ICI/IiApICsgcy5kYXRhOw0KDQoJCQkJLy8gIzk2ODI6IHJlbW92ZSBkYXRhIHNvIHRoYXQgaXQncyBub3QgdXNlZCBpbiBhbiBldmVudHVhbCByZXRyeQ0KCQkJCWRlbGV0ZSBzLmRhdGE7DQoJCQl9DQoNCgkJCS8vIEFkZCBvciB1cGRhdGUgYW50aS1jYWNoZSBwYXJhbSBpZiBuZWVkZWQNCgkJCWlmICggcy5jYWNoZSA9PT0gZmFsc2UgKSB7DQoJCQkJY2FjaGVVUkwgPSBjYWNoZVVSTC5yZXBsYWNlKCByYW50aUNhY2hlLCAiJDEiICk7DQoJCQkJdW5jYWNoZWQgPSAoIHJxdWVyeS50ZXN0KCBjYWNoZVVSTCApID8gIiYiIDogIj8iICkgKyAiXz0iICsgKCBub25jZS5ndWlkKysgKSArDQoJCQkJCXVuY2FjaGVkOw0KCQkJfQ0KDQoJCQkvLyBQdXQgaGFzaCBhbmQgYW50aS1jYWNoZSBvbiB0aGUgVVJMIHRoYXQgd2lsbCBiZSByZXF1ZXN0ZWQgKGdoLTE3MzIpDQoJCQlzLnVybCA9IGNhY2hlVVJMICsgdW5jYWNoZWQ7DQoNCgkJLy8gQ2hhbmdlICclMjAnIHRvICcrJyBpZiB0aGlzIGlzIGVuY29kZWQgZm9ybSBib2R5IGNvbnRlbnQgKGdoLTI2NTgpDQoJCX0gZWxzZSBpZiAoIHMuZGF0YSAmJiBzLnByb2Nlc3NEYXRhICYmDQoJCQkoIHMuY29udGVudFR5cGUgfHwgIiIgKS5pbmRleE9mKCAiYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkIiApID09PSAwICkgew0KCQkJcy5kYXRhID0gcy5kYXRhLnJlcGxhY2UoIHIyMCwgIisiICk7DQoJCX0NCg0KCQkvLyBTZXQgdGhlIElmLU1vZGlmaWVkLVNpbmNlIGFuZC9vciBJZi1Ob25lLU1hdGNoIGhlYWRlciwgaWYgaW4gaWZNb2RpZmllZCBtb2RlLg0KCQlpZiAoIHMuaWZNb2RpZmllZCApIHsNCgkJCWlmICggalF1ZXJ5Lmxhc3RNb2RpZmllZFsgY2FjaGVVUkwgXSApIHsNCgkJCQlqcVhIUi5zZXRSZXF1ZXN0SGVhZGVyKCAiSWYtTW9kaWZpZWQtU2luY2UiLCBqUXVlcnkubGFzdE1vZGlmaWVkWyBjYWNoZVVSTCBdICk7DQoJCQl9DQoJCQlpZiAoIGpRdWVyeS5ldGFnWyBjYWNoZVVSTCBdICkgew0KCQkJCWpxWEhSLnNldFJlcXVlc3RIZWFkZXIoICJJZi1Ob25lLU1hdGNoIiwgalF1ZXJ5LmV0YWdbIGNhY2hlVVJMIF0gKTsNCgkJCX0NCgkJfQ0KDQoJCS8vIFNldCB0aGUgY29ycmVjdCBoZWFkZXIsIGlmIGRhdGEgaXMgYmVpbmcgc2VudA0KCQlpZiAoIHMuZGF0YSAmJiBzLmhhc0NvbnRlbnQgJiYgcy5jb250ZW50VHlwZSAhPT0gZmFsc2UgfHwgb3B0aW9ucy5jb250ZW50VHlwZSApIHsNCgkJCWpxWEhSLnNldFJlcXVlc3RIZWFkZXIoICJDb250ZW50LVR5cGUiLCBzLmNvbnRlbnRUeXBlICk7DQoJCX0NCg0KCQkvLyBTZXQgdGhlIEFjY2VwdHMgaGVhZGVyIGZvciB0aGUgc2VydmVyLCBkZXBlbmRpbmcgb24gdGhlIGRhdGFUeXBlDQoJCWpxWEhSLnNldFJlcXVlc3RIZWFkZXIoDQoJCQkiQWNjZXB0IiwNCgkJCXMuZGF0YVR5cGVzWyAwIF0gJiYgcy5hY2NlcHRzWyBzLmRhdGFUeXBlc1sgMCBdIF0gPw0KCQkJCXMuYWNjZXB0c1sgcy5kYXRhVHlwZXNbIDAgXSBdICsNCgkJCQkJKCBzLmRhdGFUeXBlc1sgMCBdICE9PSAiKiIgPyAiLCAiICsgYWxsVHlwZXMgKyAiOyBxPTAuMDEiIDogIiIgKSA6DQoJCQkJcy5hY2NlcHRzWyAiKiIgXQ0KCQkpOw0KDQoJCS8vIENoZWNrIGZvciBoZWFkZXJzIG9wdGlvbg0KCQlmb3IgKCBpIGluIHMuaGVhZGVycyApIHsNCgkJCWpxWEhSLnNldFJlcXVlc3RIZWFkZXIoIGksIHMuaGVhZGVyc1sgaSBdICk7DQoJCX0NCg0KCQkvLyBBbGxvdyBjdXN0b20gaGVhZGVycy9taW1ldHlwZXMgYW5kIGVhcmx5IGFib3J0DQoJCWlmICggcy5iZWZvcmVTZW5kICYmDQoJCQkoIHMuYmVmb3JlU2VuZC5jYWxsKCBjYWxsYmFja0NvbnRleHQsIGpxWEhSLCBzICkgPT09IGZhbHNlIHx8IGNvbXBsZXRlZCApICkgew0KDQoJCQkvLyBBYm9ydCBpZiBub3QgZG9uZSBhbHJlYWR5IGFuZCByZXR1cm4NCgkJCXJldHVybiBqcVhIUi5hYm9ydCgpOw0KCQl9DQoNCgkJLy8gQWJvcnRpbmcgaXMgbm8gbG9uZ2VyIGEgY2FuY2VsbGF0aW9uDQoJCXN0ckFib3J0ID0gImFib3J0IjsNCg0KCQkvLyBJbnN0YWxsIGNhbGxiYWNrcyBvbiBkZWZlcnJlZHMNCgkJY29tcGxldGVEZWZlcnJlZC5hZGQoIHMuY29tcGxldGUgKTsNCgkJanFYSFIuZG9uZSggcy5zdWNjZXNzICk7DQoJCWpxWEhSLmZhaWwoIHMuZXJyb3IgKTsNCg0KCQkvLyBHZXQgdHJhbnNwb3J0DQoJCXRyYW5zcG9ydCA9IGluc3BlY3RQcmVmaWx0ZXJzT3JUcmFuc3BvcnRzKCB0cmFuc3BvcnRzLCBzLCBvcHRpb25zLCBqcVhIUiApOw0KDQoJCS8vIElmIG5vIHRyYW5zcG9ydCwgd2UgYXV0by1hYm9ydA0KCQlpZiAoICF0cmFuc3BvcnQgKSB7DQoJCQlkb25lKCAtMSwgIk5vIFRyYW5zcG9ydCIgKTsNCgkJfSBlbHNlIHsNCgkJCWpxWEhSLnJlYWR5U3RhdGUgPSAxOw0KDQoJCQkvLyBTZW5kIGdsb2JhbCBldmVudA0KCQkJaWYgKCBmaXJlR2xvYmFscyApIHsNCgkJCQlnbG9iYWxFdmVudENvbnRleHQudHJpZ2dlciggImFqYXhTZW5kIiwgWyBqcVhIUiwgcyBdICk7DQoJCQl9DQoNCgkJCS8vIElmIHJlcXVlc3Qgd2FzIGFib3J0ZWQgaW5zaWRlIGFqYXhTZW5kLCBzdG9wIHRoZXJlDQoJCQlpZiAoIGNvbXBsZXRlZCApIHsNCgkJCQlyZXR1cm4ganFYSFI7DQoJCQl9DQoNCgkJCS8vIFRpbWVvdXQNCgkJCWlmICggcy5hc3luYyAmJiBzLnRpbWVvdXQgPiAwICkgew0KCQkJCXRpbWVvdXRUaW1lciA9IHdpbmRvdy5zZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsNCgkJCQkJanFYSFIuYWJvcnQoICJ0aW1lb3V0IiApOw0KCQkJCX0sIHMudGltZW91dCApOw0KCQkJfQ0KDQoJCQl0cnkgew0KCQkJCWNvbXBsZXRlZCA9IGZhbHNlOw0KCQkJCXRyYW5zcG9ydC5zZW5kKCByZXF1ZXN0SGVhZGVycywgZG9uZSApOw0KCQkJfSBjYXRjaCAoIGUgKSB7DQoNCgkJCQkvLyBSZXRocm93IHBvc3QtY29tcGxldGlvbiBleGNlcHRpb25zDQoJCQkJaWYgKCBjb21wbGV0ZWQgKSB7DQoJCQkJCXRocm93IGU7DQoJCQkJfQ0KDQoJCQkJLy8gUHJvcGFnYXRlIG90aGVycyBhcyByZXN1bHRzDQoJCQkJZG9uZSggLTEsIGUgKTsNCgkJCX0NCgkJfQ0KDQoJCS8vIENhbGxiYWNrIGZvciB3aGVuIGV2ZXJ5dGhpbmcgaXMgZG9uZQ0KCQlmdW5jdGlvbiBkb25lKCBzdGF0dXMsIG5hdGl2ZVN0YXR1c1RleHQsIHJlc3BvbnNlcywgaGVhZGVycyApIHsNCgkJCXZhciBpc1N1Y2Nlc3MsIHN1Y2Nlc3MsIGVycm9yLCByZXNwb25zZSwgbW9kaWZpZWQsDQoJCQkJc3RhdHVzVGV4dCA9IG5hdGl2ZVN0YXR1c1RleHQ7DQoNCgkJCS8vIElnbm9yZSByZXBlYXQgaW52b2NhdGlvbnMNCgkJCWlmICggY29tcGxldGVkICkgew0KCQkJCXJldHVybjsNCgkJCX0NCg0KCQkJY29tcGxldGVkID0gdHJ1ZTsNCg0KCQkJLy8gQ2xlYXIgdGltZW91dCBpZiBpdCBleGlzdHMNCgkJCWlmICggdGltZW91dFRpbWVyICkgew0KCQkJCXdpbmRvdy5jbGVhclRpbWVvdXQoIHRpbWVvdXRUaW1lciApOw0KCQkJfQ0KDQoJCQkvLyBEZXJlZmVyZW5jZSB0cmFuc3BvcnQgZm9yIGVhcmx5IGdhcmJhZ2UgY29sbGVjdGlvbg0KCQkJLy8gKG5vIG1hdHRlciBob3cgbG9uZyB0aGUganFYSFIgb2JqZWN0IHdpbGwgYmUgdXNlZCkNCgkJCXRyYW5zcG9ydCA9IHVuZGVmaW5lZDsNCg0KCQkJLy8gQ2FjaGUgcmVzcG9uc2UgaGVhZGVycw0KCQkJcmVzcG9uc2VIZWFkZXJzU3RyaW5nID0gaGVhZGVycyB8fCAiIjsNCg0KCQkJLy8gU2V0IHJlYWR5U3RhdGUNCgkJCWpxWEhSLnJlYWR5U3RhdGUgPSBzdGF0dXMgPiAwID8gNCA6IDA7DQoNCgkJCS8vIERldGVybWluZSBpZiBzdWNjZXNzZnVsDQoJCQlpc1N1Y2Nlc3MgPSBzdGF0dXMgPj0gMjAwICYmIHN0YXR1cyA8IDMwMCB8fCBzdGF0dXMgPT09IDMwNDsNCg0KCQkJLy8gR2V0IHJlc3BvbnNlIGRhdGENCgkJCWlmICggcmVzcG9uc2VzICkgew0KCQkJCXJlc3BvbnNlID0gYWpheEhhbmRsZVJlc3BvbnNlcyggcywganFYSFIsIHJlc3BvbnNlcyApOw0KCQkJfQ0KDQoJCQkvLyBVc2UgYSBub29wIGNvbnZlcnRlciBmb3IgbWlzc2luZyBzY3JpcHQgYnV0IG5vdCBpZiBqc29ucA0KCQkJaWYgKCAhaXNTdWNjZXNzICYmDQoJCQkJalF1ZXJ5LmluQXJyYXkoICJzY3JpcHQiLCBzLmRhdGFUeXBlcyApID4gLTEgJiYNCgkJCQlqUXVlcnkuaW5BcnJheSggImpzb24iLCBzLmRhdGFUeXBlcyApIDwgMCApIHsNCgkJCQlzLmNvbnZlcnRlcnNbICJ0ZXh0IHNjcmlwdCIgXSA9IGZ1bmN0aW9uKCkge307DQoJCQl9DQoNCgkJCS8vIENvbnZlcnQgbm8gbWF0dGVyIHdoYXQgKHRoYXQgd2F5IHJlc3BvbnNlWFhYIGZpZWxkcyBhcmUgYWx3YXlzIHNldCkNCgkJCXJlc3BvbnNlID0gYWpheENvbnZlcnQoIHMsIHJlc3BvbnNlLCBqcVhIUiwgaXNTdWNjZXNzICk7DQoNCgkJCS8vIElmIHN1Y2Nlc3NmdWwsIGhhbmRsZSB0eXBlIGNoYWluaW5nDQoJCQlpZiAoIGlzU3VjY2VzcyApIHsNCg0KCQkJCS8vIFNldCB0aGUgSWYtTW9kaWZpZWQtU2luY2UgYW5kL29yIElmLU5vbmUtTWF0Y2ggaGVhZGVyLCBpZiBpbiBpZk1vZGlmaWVkIG1vZGUuDQoJCQkJaWYgKCBzLmlmTW9kaWZpZWQgKSB7DQoJCQkJCW1vZGlmaWVkID0ganFYSFIuZ2V0UmVzcG9uc2VIZWFkZXIoICJMYXN0LU1vZGlmaWVkIiApOw0KCQkJCQlpZiAoIG1vZGlmaWVkICkgew0KCQkJCQkJalF1ZXJ5Lmxhc3RNb2RpZmllZFsgY2FjaGVVUkwgXSA9IG1vZGlmaWVkOw0KCQkJCQl9DQoJCQkJCW1vZGlmaWVkID0ganFYSFIuZ2V0UmVzcG9uc2VIZWFkZXIoICJldGFnIiApOw0KCQkJCQlpZiAoIG1vZGlmaWVkICkgew0KCQkJCQkJalF1ZXJ5LmV0YWdbIGNhY2hlVVJMIF0gPSBtb2RpZmllZDsNCgkJCQkJfQ0KCQkJCX0NCg0KCQkJCS8vIGlmIG5vIGNvbnRlbnQNCgkJCQlpZiAoIHN0YXR1cyA9PT0gMjA0IHx8IHMudHlwZSA9PT0gIkhFQUQiICkgew0KCQkJCQlzdGF0dXNUZXh0ID0gIm5vY29udGVudCI7DQoNCgkJCQkvLyBpZiBub3QgbW9kaWZpZWQNCgkJCQl9IGVsc2UgaWYgKCBzdGF0dXMgPT09IDMwNCApIHsNCgkJCQkJc3RhdHVzVGV4dCA9ICJub3Rtb2RpZmllZCI7DQoNCgkJCQkvLyBJZiB3ZSBoYXZlIGRhdGEsIGxldCdzIGNvbnZlcnQgaXQNCgkJCQl9IGVsc2Ugew0KCQkJCQlzdGF0dXNUZXh0ID0gcmVzcG9uc2Uuc3RhdGU7DQoJCQkJCXN1Y2Nlc3MgPSByZXNwb25zZS5kYXRhOw0KCQkJCQllcnJvciA9IHJlc3BvbnNlLmVycm9yOw0KCQkJCQlpc1N1Y2Nlc3MgPSAhZXJyb3I7DQoJCQkJfQ0KCQkJfSBlbHNlIHsNCg0KCQkJCS8vIEV4dHJhY3QgZXJyb3IgZnJvbSBzdGF0dXNUZXh0IGFuZCBub3JtYWxpemUgZm9yIG5vbi1hYm9ydHMNCgkJCQllcnJvciA9IHN0YXR1c1RleHQ7DQoJCQkJaWYgKCBzdGF0dXMgfHwgIXN0YXR1c1RleHQgKSB7DQoJCQkJCXN0YXR1c1RleHQgPSAiZXJyb3IiOw0KCQkJCQlpZiAoIHN0YXR1cyA8IDAgKSB7DQoJCQkJCQlzdGF0dXMgPSAwOw0KCQkJCQl9DQoJCQkJfQ0KCQkJfQ0KDQoJCQkvLyBTZXQgZGF0YSBmb3IgdGhlIGZha2UgeGhyIG9iamVjdA0KCQkJanFYSFIuc3RhdHVzID0gc3RhdHVzOw0KCQkJanFYSFIuc3RhdHVzVGV4dCA9ICggbmF0aXZlU3RhdHVzVGV4dCB8fCBzdGF0dXNUZXh0ICkgKyAiIjsNCg0KCQkJLy8gU3VjY2Vzcy9FcnJvcg0KCQkJaWYgKCBpc1N1Y2Nlc3MgKSB7DQoJCQkJZGVmZXJyZWQucmVzb2x2ZVdpdGgoIGNhbGxiYWNrQ29udGV4dCwgWyBzdWNjZXNzLCBzdGF0dXNUZXh0LCBqcVhIUiBdICk7DQoJCQl9IGVsc2Ugew0KCQkJCWRlZmVycmVkLnJlamVjdFdpdGgoIGNhbGxiYWNrQ29udGV4dCwgWyBqcVhIUiwgc3RhdHVzVGV4dCwgZXJyb3IgXSApOw0KCQkJfQ0KDQoJCQkvLyBTdGF0dXMtZGVwZW5kZW50IGNhbGxiYWNrcw0KCQkJanFYSFIuc3RhdHVzQ29kZSggc3RhdHVzQ29kZSApOw0KCQkJc3RhdHVzQ29kZSA9IHVuZGVmaW5lZDsNCg0KCQkJaWYgKCBmaXJlR2xvYmFscyApIHsNCgkJCQlnbG9iYWxFdmVudENvbnRleHQudHJpZ2dlciggaXNTdWNjZXNzID8gImFqYXhTdWNjZXNzIiA6ICJhamF4RXJyb3IiLA0KCQkJCQlbIGpxWEhSLCBzLCBpc1N1Y2Nlc3MgPyBzdWNjZXNzIDogZXJyb3IgXSApOw0KCQkJfQ0KDQoJCQkvLyBDb21wbGV0ZQ0KCQkJY29tcGxldGVEZWZlcnJlZC5maXJlV2l0aCggY2FsbGJhY2tDb250ZXh0LCBbIGpxWEhSLCBzdGF0dXNUZXh0IF0gKTsNCg0KCQkJaWYgKCBmaXJlR2xvYmFscyApIHsNCgkJCQlnbG9iYWxFdmVudENvbnRleHQudHJpZ2dlciggImFqYXhDb21wbGV0ZSIsIFsganFYSFIsIHMgXSApOw0KDQoJCQkJLy8gSGFuZGxlIHRoZSBnbG9iYWwgQUpBWCBjb3VudGVyDQoJCQkJaWYgKCAhKCAtLWpRdWVyeS5hY3RpdmUgKSApIHsNCgkJCQkJalF1ZXJ5LmV2ZW50LnRyaWdnZXIoICJhamF4U3RvcCIgKTsNCgkJCQl9DQoJCQl9DQoJCX0NCg0KCQlyZXR1cm4ganFYSFI7DQoJfSwNCg0KCWdldEpTT046IGZ1bmN0aW9uKCB1cmwsIGRhdGEsIGNhbGxiYWNrICkgew0KCQlyZXR1cm4galF1ZXJ5LmdldCggdXJsLCBkYXRhLCBjYWxsYmFjaywgImpzb24iICk7DQoJfSwNCg0KCWdldFNjcmlwdDogZnVuY3Rpb24oIHVybCwgY2FsbGJhY2sgKSB7DQoJCXJldHVybiBqUXVlcnkuZ2V0KCB1cmwsIHVuZGVmaW5lZCwgY2FsbGJhY2ssICJzY3JpcHQiICk7DQoJfQ0KfSApOw0KDQpqUXVlcnkuZWFjaCggWyAiZ2V0IiwgInBvc3QiIF0sIGZ1bmN0aW9uKCBfaSwgbWV0aG9kICkgew0KCWpRdWVyeVsgbWV0aG9kIF0gPSBmdW5jdGlvbiggdXJsLCBkYXRhLCBjYWxsYmFjaywgdHlwZSApIHsNCg0KCQkvLyBTaGlmdCBhcmd1bWVudHMgaWYgZGF0YSBhcmd1bWVudCB3YXMgb21pdHRlZA0KCQlpZiAoIGlzRnVuY3Rpb24oIGRhdGEgKSApIHsNCgkJCXR5cGUgPSB0eXBlIHx8IGNhbGxiYWNrOw0KCQkJY2FsbGJhY2sgPSBkYXRhOw0KCQkJZGF0YSA9IHVuZGVmaW5lZDsNCgkJfQ0KDQoJCS8vIFRoZSB1cmwgY2FuIGJlIGFuIG9wdGlvbnMgb2JqZWN0ICh3aGljaCB0aGVuIG11c3QgaGF2ZSAudXJsKQ0KCQlyZXR1cm4galF1ZXJ5LmFqYXgoIGpRdWVyeS5leHRlbmQoIHsNCgkJCXVybDogdXJsLA0KCQkJdHlwZTogbWV0aG9kLA0KCQkJZGF0YVR5cGU6IHR5cGUsDQoJCQlkYXRhOiBkYXRhLA0KCQkJc3VjY2VzczogY2FsbGJhY2sNCgkJfSwgalF1ZXJ5LmlzUGxhaW5PYmplY3QoIHVybCApICYmIHVybCApICk7DQoJfTsNCn0gKTsNCg0KalF1ZXJ5LmFqYXhQcmVmaWx0ZXIoIGZ1bmN0aW9uKCBzICkgew0KCXZhciBpOw0KCWZvciAoIGkgaW4gcy5oZWFkZXJzICkgew0KCQlpZiAoIGkudG9Mb3dlckNhc2UoKSA9PT0gImNvbnRlbnQtdHlwZSIgKSB7DQoJCQlzLmNvbnRlbnRUeXBlID0gcy5oZWFkZXJzWyBpIF0gfHwgIiI7DQoJCX0NCgl9DQp9ICk7DQoNCg0KalF1ZXJ5Ll9ldmFsVXJsID0gZnVuY3Rpb24oIHVybCwgb3B0aW9ucywgZG9jICkgew0KCXJldHVybiBqUXVlcnkuYWpheCggew0KCQl1cmw6IHVybCwNCg0KCQkvLyBNYWtlIHRoaXMgZXhwbGljaXQsIHNpbmNlIHVzZXIgY2FuIG92ZXJyaWRlIHRoaXMgdGhyb3VnaCBhamF4U2V0dXAgKCMxMTI2NCkNCgkJdHlwZTogIkdFVCIsDQoJCWRhdGFUeXBlOiAic2NyaXB0IiwNCgkJY2FjaGU6IHRydWUsDQoJCWFzeW5jOiBmYWxzZSwNCgkJZ2xvYmFsOiBmYWxzZSwNCg0KCQkvLyBPbmx5IGV2YWx1YXRlIHRoZSByZXNwb25zZSBpZiBpdCBpcyBzdWNjZXNzZnVsIChnaC00MTI2KQ0KCQkvLyBkYXRhRmlsdGVyIGlzIG5vdCBpbnZva2VkIGZvciBmYWlsdXJlIHJlc3BvbnNlcywgc28gdXNpbmcgaXQgaW5zdGVhZA0KCQkvLyBvZiB0aGUgZGVmYXVsdCBjb252ZXJ0ZXIgaXMga2x1ZGd5IGJ1dCBpdCB3b3Jrcy4NCgkJY29udmVydGVyczogew0KCQkJInRleHQgc2NyaXB0IjogZnVuY3Rpb24oKSB7fQ0KCQl9LA0KCQlkYXRhRmlsdGVyOiBmdW5jdGlvbiggcmVzcG9uc2UgKSB7DQoJCQlqUXVlcnkuZ2xvYmFsRXZhbCggcmVzcG9uc2UsIG9wdGlvbnMsIGRvYyApOw0KCQl9DQoJfSApOw0KfTsNCg0KDQpqUXVlcnkuZm4uZXh0ZW5kKCB7DQoJd3JhcEFsbDogZnVuY3Rpb24oIGh0bWwgKSB7DQoJCXZhciB3cmFwOw0KDQoJCWlmICggdGhpc1sgMCBdICkgew0KCQkJaWYgKCBpc0Z1bmN0aW9uKCBodG1sICkgKSB7DQoJCQkJaHRtbCA9IGh0bWwuY2FsbCggdGhpc1sgMCBdICk7DQoJCQl9DQoNCgkJCS8vIFRoZSBlbGVtZW50cyB0byB3cmFwIHRoZSB0YXJnZXQgYXJvdW5kDQoJCQl3cmFwID0galF1ZXJ5KCBodG1sLCB0aGlzWyAwIF0ub3duZXJEb2N1bWVudCApLmVxKCAwICkuY2xvbmUoIHRydWUgKTsNCg0KCQkJaWYgKCB0aGlzWyAwIF0ucGFyZW50Tm9kZSApIHsNCgkJCQl3cmFwLmluc2VydEJlZm9yZSggdGhpc1sgMCBdICk7DQoJCQl9DQoNCgkJCXdyYXAubWFwKCBmdW5jdGlvbigpIHsNCgkJCQl2YXIgZWxlbSA9IHRoaXM7DQoNCgkJCQl3aGlsZSAoIGVsZW0uZmlyc3RFbGVtZW50Q2hpbGQgKSB7DQoJCQkJCWVsZW0gPSBlbGVtLmZpcnN0RWxlbWVudENoaWxkOw0KCQkJCX0NCg0KCQkJCXJldHVybiBlbGVtOw0KCQkJfSApLmFwcGVuZCggdGhpcyApOw0KCQl9DQoNCgkJcmV0dXJuIHRoaXM7DQoJfSwNCg0KCXdyYXBJbm5lcjogZnVuY3Rpb24oIGh0bWwgKSB7DQoJCWlmICggaXNGdW5jdGlvbiggaHRtbCApICkgew0KCQkJcmV0dXJuIHRoaXMuZWFjaCggZnVuY3Rpb24oIGkgKSB7DQoJCQkJalF1ZXJ5KCB0aGlzICkud3JhcElubmVyKCBodG1sLmNhbGwoIHRoaXMsIGkgKSApOw0KCQkJfSApOw0KCQl9DQoNCgkJcmV0dXJuIHRoaXMuZWFjaCggZnVuY3Rpb24oKSB7DQoJCQl2YXIgc2VsZiA9IGpRdWVyeSggdGhpcyApLA0KCQkJCWNvbnRlbnRzID0gc2VsZi5jb250ZW50cygpOw0KDQoJCQlpZiAoIGNvbnRlbnRzLmxlbmd0aCApIHsNCgkJCQljb250ZW50cy53cmFwQWxsKCBodG1sICk7DQoNCgkJCX0gZWxzZSB7DQoJCQkJc2VsZi5hcHBlbmQoIGh0bWwgKTsNCgkJCX0NCgkJfSApOw0KCX0sDQoNCgl3cmFwOiBmdW5jdGlvbiggaHRtbCApIHsNCgkJdmFyIGh0bWxJc0Z1bmN0aW9uID0gaXNGdW5jdGlvbiggaHRtbCApOw0KDQoJCXJldHVybiB0aGlzLmVhY2goIGZ1bmN0aW9uKCBpICkgew0KCQkJalF1ZXJ5KCB0aGlzICkud3JhcEFsbCggaHRtbElzRnVuY3Rpb24gPyBodG1sLmNhbGwoIHRoaXMsIGkgKSA6IGh0bWwgKTsNCgkJfSApOw0KCX0sDQoNCgl1bndyYXA6IGZ1bmN0aW9uKCBzZWxlY3RvciApIHsNCgkJdGhpcy5wYXJlbnQoIHNlbGVjdG9yICkubm90KCAiYm9keSIgKS5lYWNoKCBmdW5jdGlvbigpIHsNCgkJCWpRdWVyeSggdGhpcyApLnJlcGxhY2VXaXRoKCB0aGlzLmNoaWxkTm9kZXMgKTsNCgkJfSApOw0KCQlyZXR1cm4gdGhpczsNCgl9DQp9ICk7DQoNCg0KalF1ZXJ5LmV4cHIucHNldWRvcy5oaWRkZW4gPSBmdW5jdGlvbiggZWxlbSApIHsNCglyZXR1cm4gIWpRdWVyeS5leHByLnBzZXVkb3MudmlzaWJsZSggZWxlbSApOw0KfTsNCmpRdWVyeS5leHByLnBzZXVkb3MudmlzaWJsZSA9IGZ1bmN0aW9uKCBlbGVtICkgew0KCXJldHVybiAhISggZWxlbS5vZmZzZXRXaWR0aCB8fCBlbGVtLm9mZnNldEhlaWdodCB8fCBlbGVtLmdldENsaWVudFJlY3RzKCkubGVuZ3RoICk7DQp9Ow0KDQoNCg0KDQpqUXVlcnkuYWpheFNldHRpbmdzLnhociA9IGZ1bmN0aW9uKCkgew0KCXRyeSB7DQoJCXJldHVybiBuZXcgd2luZG93LlhNTEh0dHBSZXF1ZXN0KCk7DQoJfSBjYXRjaCAoIGUgKSB7fQ0KfTsNCg0KdmFyIHhoclN1Y2Nlc3NTdGF0dXMgPSB7DQoNCgkJLy8gRmlsZSBwcm90b2NvbCBhbHdheXMgeWllbGRzIHN0YXR1cyBjb2RlIDAsIGFzc3VtZSAyMDANCgkJMDogMjAwLA0KDQoJCS8vIFN1cHBvcnQ6IElFIDw9OSBvbmx5DQoJCS8vICMxNDUwOiBzb21ldGltZXMgSUUgcmV0dXJucyAxMjIzIHdoZW4gaXQgc2hvdWxkIGJlIDIwNA0KCQkxMjIzOiAyMDQNCgl9LA0KCXhoclN1cHBvcnRlZCA9IGpRdWVyeS5hamF4U2V0dGluZ3MueGhyKCk7DQoNCnN1cHBvcnQuY29ycyA9ICEheGhyU3VwcG9ydGVkICYmICggIndpdGhDcmVkZW50aWFscyIgaW4geGhyU3VwcG9ydGVkICk7DQpzdXBwb3J0LmFqYXggPSB4aHJTdXBwb3J0ZWQgPSAhIXhoclN1cHBvcnRlZDsNCg0KalF1ZXJ5LmFqYXhUcmFuc3BvcnQoIGZ1bmN0aW9uKCBvcHRpb25zICkgew0KCXZhciBjYWxsYmFjaywgZXJyb3JDYWxsYmFjazsNCg0KCS8vIENyb3NzIGRvbWFpbiBvbmx5IGFsbG93ZWQgaWYgc3VwcG9ydGVkIHRocm91Z2ggWE1MSHR0cFJlcXVlc3QNCglpZiAoIHN1cHBvcnQuY29ycyB8fCB4aHJTdXBwb3J0ZWQgJiYgIW9wdGlvbnMuY3Jvc3NEb21haW4gKSB7DQoJCXJldHVybiB7DQoJCQlzZW5kOiBmdW5jdGlvbiggaGVhZGVycywgY29tcGxldGUgKSB7DQoJCQkJdmFyIGksDQoJCQkJCXhociA9IG9wdGlvbnMueGhyKCk7DQoNCgkJCQl4aHIub3BlbigNCgkJCQkJb3B0aW9ucy50eXBlLA0KCQkJCQlvcHRpb25zLnVybCwNCgkJCQkJb3B0aW9ucy5hc3luYywNCgkJCQkJb3B0aW9ucy51c2VybmFtZSwNCgkJCQkJb3B0aW9ucy5wYXNzd29yZA0KCQkJCSk7DQoNCgkJCQkvLyBBcHBseSBjdXN0b20gZmllbGRzIGlmIHByb3ZpZGVkDQoJCQkJaWYgKCBvcHRpb25zLnhockZpZWxkcyApIHsNCgkJCQkJZm9yICggaSBpbiBvcHRpb25zLnhockZpZWxkcyApIHsNCgkJCQkJCXhoclsgaSBdID0gb3B0aW9ucy54aHJGaWVsZHNbIGkgXTsNCgkJCQkJfQ0KCQkJCX0NCg0KCQkJCS8vIE92ZXJyaWRlIG1pbWUgdHlwZSBpZiBuZWVkZWQNCgkJCQlpZiAoIG9wdGlvbnMubWltZVR5cGUgJiYgeGhyLm92ZXJyaWRlTWltZVR5cGUgKSB7DQoJCQkJCXhoci5vdmVycmlkZU1pbWVUeXBlKCBvcHRpb25zLm1pbWVUeXBlICk7DQoJCQkJfQ0KDQoJCQkJLy8gWC1SZXF1ZXN0ZWQtV2l0aCBoZWFkZXINCgkJCQkvLyBGb3IgY3Jvc3MtZG9tYWluIHJlcXVlc3RzLCBzZWVpbmcgYXMgY29uZGl0aW9ucyBmb3IgYSBwcmVmbGlnaHQgYXJlDQoJCQkJLy8gYWtpbiB0byBhIGppZ3NhdyBwdXp6bGUsIHdlIHNpbXBseSBuZXZlciBzZXQgaXQgdG8gYmUgc3VyZS4NCgkJCQkvLyAoaXQgY2FuIGFsd2F5cyBiZSBzZXQgb24gYSBwZXItcmVxdWVzdCBiYXNpcyBvciBldmVuIHVzaW5nIGFqYXhTZXR1cCkNCgkJCQkvLyBGb3Igc2FtZS1kb21haW4gcmVxdWVzdHMsIHdvbid0IGNoYW5nZSBoZWFkZXIgaWYgYWxyZWFkeSBwcm92aWRlZC4NCgkJCQlpZiAoICFvcHRpb25zLmNyb3NzRG9tYWluICYmICFoZWFkZXJzWyAiWC1SZXF1ZXN0ZWQtV2l0aCIgXSApIHsNCgkJCQkJaGVhZGVyc1sgIlgtUmVxdWVzdGVkLVdpdGgiIF0gPSAiWE1MSHR0cFJlcXVlc3QiOw0KCQkJCX0NCg0KCQkJCS8vIFNldCBoZWFkZXJzDQoJCQkJZm9yICggaSBpbiBoZWFkZXJzICkgew0KCQkJCQl4aHIuc2V0UmVxdWVzdEhlYWRlciggaSwgaGVhZGVyc1sgaSBdICk7DQoJCQkJfQ0KDQoJCQkJLy8gQ2FsbGJhY2sNCgkJCQljYWxsYmFjayA9IGZ1bmN0aW9uKCB0eXBlICkgew0KCQkJCQlyZXR1cm4gZnVuY3Rpb24oKSB7DQoJCQkJCQlpZiAoIGNhbGxiYWNrICkgew0KCQkJCQkJCWNhbGxiYWNrID0gZXJyb3JDYWxsYmFjayA9IHhoci5vbmxvYWQgPQ0KCQkJCQkJCQl4aHIub25lcnJvciA9IHhoci5vbmFib3J0ID0geGhyLm9udGltZW91dCA9DQoJCQkJCQkJCQl4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gbnVsbDsNCg0KCQkJCQkJCWlmICggdHlwZSA9PT0gImFib3J0IiApIHsNCgkJCQkJCQkJeGhyLmFib3J0KCk7DQoJCQkJCQkJfSBlbHNlIGlmICggdHlwZSA9PT0gImVycm9yIiApIHsNCg0KCQkJCQkJCQkvLyBTdXBwb3J0OiBJRSA8PTkgb25seQ0KCQkJCQkJCQkvLyBPbiBhIG1hbnVhbCBuYXRpdmUgYWJvcnQsIElFOSB0aHJvd3MNCgkJCQkJCQkJLy8gZXJyb3JzIG9uIGFueSBwcm9wZXJ0eSBhY2Nlc3MgdGhhdCBpcyBub3QgcmVhZHlTdGF0ZQ0KCQkJCQkJCQlpZiAoIHR5cGVvZiB4aHIuc3RhdHVzICE9PSAibnVtYmVyIiApIHsNCgkJCQkJCQkJCWNvbXBsZXRlKCAwLCAiZXJyb3IiICk7DQoJCQkJCQkJCX0gZWxzZSB7DQoJCQkJCQkJCQljb21wbGV0ZSgNCg0KCQkJCQkJCQkJCS8vIEZpbGU6IHByb3RvY29sIGFsd2F5cyB5aWVsZHMgc3RhdHVzIDA7IHNlZSAjODYwNSwgIzE0MjA3DQoJCQkJCQkJCQkJeGhyLnN0YXR1cywNCgkJCQkJCQkJCQl4aHIuc3RhdHVzVGV4dA0KCQkJCQkJCQkJKTsNCgkJCQkJCQkJfQ0KCQkJCQkJCX0gZWxzZSB7DQoJCQkJCQkJCWNvbXBsZXRlKA0KCQkJCQkJCQkJeGhyU3VjY2Vzc1N0YXR1c1sgeGhyLnN0YXR1cyBdIHx8IHhoci5zdGF0dXMsDQoJCQkJCQkJCQl4aHIuc3RhdHVzVGV4dCwNCg0KCQkJCQkJCQkJLy8gU3VwcG9ydDogSUUgPD05IG9ubHkNCgkJCQkJCQkJCS8vIElFOSBoYXMgbm8gWEhSMiBidXQgdGhyb3dzIG9uIGJpbmFyeSAodHJhYy0xMTQyNikNCgkJCQkJCQkJCS8vIEZvciBYSFIyIG5vbi10ZXh0LCBsZXQgdGhlIGNhbGxlciBoYW5kbGUgaXQgKGdoLTI0OTgpDQoJCQkJCQkJCQkoIHhoci5yZXNwb25zZVR5cGUgfHwgInRleHQiICkgIT09ICJ0ZXh0IiAgfHwNCgkJCQkJCQkJCXR5cGVvZiB4aHIucmVzcG9uc2VUZXh0ICE9PSAic3RyaW5nIiA/DQoJCQkJCQkJCQkJeyBiaW5hcnk6IHhoci5yZXNwb25zZSB9IDoNCgkJCQkJCQkJCQl7IHRleHQ6IHhoci5yZXNwb25zZVRleHQgfSwNCgkJCQkJCQkJCXhoci5nZXRBbGxSZXNwb25zZUhlYWRlcnMoKQ0KCQkJCQkJCQkpOw0KCQkJCQkJCX0NCgkJCQkJCX0NCgkJCQkJfTsNCgkJCQl9Ow0KDQoJCQkJLy8gTGlzdGVuIHRvIGV2ZW50cw0KCQkJCXhoci5vbmxvYWQgPSBjYWxsYmFjaygpOw0KCQkJCWVycm9yQ2FsbGJhY2sgPSB4aHIub25lcnJvciA9IHhoci5vbnRpbWVvdXQgPSBjYWxsYmFjayggImVycm9yIiApOw0KDQoJCQkJLy8gU3VwcG9ydDogSUUgOSBvbmx5DQoJCQkJLy8gVXNlIG9ucmVhZHlzdGF0ZWNoYW5nZSB0byByZXBsYWNlIG9uYWJvcnQNCgkJCQkvLyB0byBoYW5kbGUgdW5jYXVnaHQgYWJvcnRzDQoJCQkJaWYgKCB4aHIub25hYm9ydCAhPT0gdW5kZWZpbmVkICkgew0KCQkJCQl4aHIub25hYm9ydCA9IGVycm9yQ2FsbGJhY2s7DQoJCQkJfSBlbHNlIHsNCgkJCQkJeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uKCkgew0KDQoJCQkJCQkvLyBDaGVjayByZWFkeVN0YXRlIGJlZm9yZSB0aW1lb3V0IGFzIGl0IGNoYW5nZXMNCgkJCQkJCWlmICggeGhyLnJlYWR5U3RhdGUgPT09IDQgKSB7DQoNCgkJCQkJCQkvLyBBbGxvdyBvbmVycm9yIHRvIGJlIGNhbGxlZCBmaXJzdCwNCgkJCQkJCQkvLyBidXQgdGhhdCB3aWxsIG5vdCBoYW5kbGUgYSBuYXRpdmUgYWJvcnQNCgkJCQkJCQkvLyBBbHNvLCBzYXZlIGVycm9yQ2FsbGJhY2sgdG8gYSB2YXJpYWJsZQ0KCQkJCQkJCS8vIGFzIHhoci5vbmVycm9yIGNhbm5vdCBiZSBhY2Nlc3NlZA0KCQkJCQkJCXdpbmRvdy5zZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsNCgkJCQkJCQkJaWYgKCBjYWxsYmFjayApIHsNCgkJCQkJCQkJCWVycm9yQ2FsbGJhY2soKTsNCgkJCQkJCQkJfQ0KCQkJCQkJCX0gKTsNCgkJCQkJCX0NCgkJCQkJfTsNCgkJCQl9DQoNCgkJCQkvLyBDcmVhdGUgdGhlIGFib3J0IGNhbGxiYWNrDQoJCQkJY2FsbGJhY2sgPSBjYWxsYmFjayggImFib3J0IiApOw0KDQoJCQkJdHJ5IHsNCg0KCQkJCQkvLyBEbyBzZW5kIHRoZSByZXF1ZXN0ICh0aGlzIG1heSByYWlzZSBhbiBleGNlcHRpb24pDQoJCQkJCXhoci5zZW5kKCBvcHRpb25zLmhhc0NvbnRlbnQgJiYgb3B0aW9ucy5kYXRhIHx8IG51bGwgKTsNCgkJCQl9IGNhdGNoICggZSApIHsNCg0KCQkJCQkvLyAjMTQ2ODM6IE9ubHkgcmV0aHJvdyBpZiB0aGlzIGhhc24ndCBiZWVuIG5vdGlmaWVkIGFzIGFuIGVycm9yIHlldA0KCQkJCQlpZiAoIGNhbGxiYWNrICkgew0KCQkJCQkJdGhyb3cgZTsNCgkJCQkJfQ0KCQkJCX0NCgkJCX0sDQoNCgkJCWFib3J0OiBmdW5jdGlvbigpIHsNCgkJCQlpZiAoIGNhbGxiYWNrICkgew0KCQkJCQljYWxsYmFjaygpOw0KCQkJCX0NCgkJCX0NCgkJfTsNCgl9DQp9ICk7DQoNCg0KDQoNCi8vIFByZXZlbnQgYXV0by1leGVjdXRpb24gb2Ygc2NyaXB0cyB3aGVuIG5vIGV4cGxpY2l0IGRhdGFUeXBlIHdhcyBwcm92aWRlZCAoU2VlIGdoLTI0MzIpDQpqUXVlcnkuYWpheFByZWZpbHRlciggZnVuY3Rpb24oIHMgKSB7DQoJaWYgKCBzLmNyb3NzRG9tYWluICkgew0KCQlzLmNvbnRlbnRzLnNjcmlwdCA9IGZhbHNlOw0KCX0NCn0gKTsNCg0KLy8gSW5zdGFsbCBzY3JpcHQgZGF0YVR5cGUNCmpRdWVyeS5hamF4U2V0dXAoIHsNCglhY2NlcHRzOiB7DQoJCXNjcmlwdDogInRleHQvamF2YXNjcmlwdCwgYXBwbGljYXRpb24vamF2YXNjcmlwdCwgIiArDQoJCQkiYXBwbGljYXRpb24vZWNtYXNjcmlwdCwgYXBwbGljYXRpb24veC1lY21hc2NyaXB0Ig0KCX0sDQoJY29udGVudHM6IHsNCgkJc2NyaXB0OiAvXGIoPzpqYXZhfGVjbWEpc2NyaXB0XGIvDQoJfSwNCgljb252ZXJ0ZXJzOiB7DQoJCSJ0ZXh0IHNjcmlwdCI6IGZ1bmN0aW9uKCB0ZXh0ICkgew0KCQkJalF1ZXJ5Lmdsb2JhbEV2YWwoIHRleHQgKTsNCgkJCXJldHVybiB0ZXh0Ow0KCQl9DQoJfQ0KfSApOw0KDQovLyBIYW5kbGUgY2FjaGUncyBzcGVjaWFsIGNhc2UgYW5kIGNyb3NzRG9tYWluDQpqUXVlcnkuYWpheFByZWZpbHRlciggInNjcmlwdCIsIGZ1bmN0aW9uKCBzICkgew0KCWlmICggcy5jYWNoZSA9PT0gdW5kZWZpbmVkICkgew0KCQlzLmNhY2hlID0gZmFsc2U7DQoJfQ0KCWlmICggcy5jcm9zc0RvbWFpbiApIHsNCgkJcy50eXBlID0gIkdFVCI7DQoJfQ0KfSApOw0KDQovLyBCaW5kIHNjcmlwdCB0YWcgaGFjayB0cmFuc3BvcnQNCmpRdWVyeS5hamF4VHJhbnNwb3J0KCAic2NyaXB0IiwgZnVuY3Rpb24oIHMgKSB7DQoNCgkvLyBUaGlzIHRyYW5zcG9ydCBvbmx5IGRlYWxzIHdpdGggY3Jvc3MgZG9tYWluIG9yIGZvcmNlZC1ieS1hdHRycyByZXF1ZXN0cw0KCWlmICggcy5jcm9zc0RvbWFpbiB8fCBzLnNjcmlwdEF0dHJzICkgew0KCQl2YXIgc2NyaXB0LCBjYWxsYmFjazsNCgkJcmV0dXJuIHsNCgkJCXNlbmQ6IGZ1bmN0aW9uKCBfLCBjb21wbGV0ZSApIHsNCgkJCQlzY3JpcHQgPSBqUXVlcnkoICI8c2NyaXB0PiIgKQ0KCQkJCQkuYXR0ciggcy5zY3JpcHRBdHRycyB8fCB7fSApDQoJCQkJCS5wcm9wKCB7IGNoYXJzZXQ6IHMuc2NyaXB0Q2hhcnNldCwgc3JjOiBzLnVybCB9ICkNCgkJCQkJLm9uKCAibG9hZCBlcnJvciIsIGNhbGxiYWNrID0gZnVuY3Rpb24oIGV2dCApIHsNCgkJCQkJCXNjcmlwdC5yZW1vdmUoKTsNCgkJCQkJCWNhbGxiYWNrID0gbnVsbDsNCgkJCQkJCWlmICggZXZ0ICkgew0KCQkJCQkJCWNvbXBsZXRlKCBldnQudHlwZSA9PT0gImVycm9yIiA/IDQwNCA6IDIwMCwgZXZ0LnR5cGUgKTsNCgkJCQkJCX0NCgkJCQkJfSApOw0KDQoJCQkJLy8gVXNlIG5hdGl2ZSBET00gbWFuaXB1bGF0aW9uIHRvIGF2b2lkIG91ciBkb21NYW5pcCBBSkFYIHRyaWNrZXJ5DQoJCQkJZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZCggc2NyaXB0WyAwIF0gKTsNCgkJCX0sDQoJCQlhYm9ydDogZnVuY3Rpb24oKSB7DQoJCQkJaWYgKCBjYWxsYmFjayApIHsNCgkJCQkJY2FsbGJhY2soKTsNCgkJCQl9DQoJCQl9DQoJCX07DQoJfQ0KfSApOw0KDQoNCg0KDQp2YXIgb2xkQ2FsbGJhY2tzID0gW10sDQoJcmpzb25wID0gLyg9KVw/KD89JnwkKXxcP1w/LzsNCg0KLy8gRGVmYXVsdCBqc29ucCBzZXR0aW5ncw0KalF1ZXJ5LmFqYXhTZXR1cCggew0KCWpzb25wOiAiY2FsbGJhY2siLA0KCWpzb25wQ2FsbGJhY2s6IGZ1bmN0aW9uKCkgew0KCQl2YXIgY2FsbGJhY2sgPSBvbGRDYWxsYmFja3MucG9wKCkgfHwgKCBqUXVlcnkuZXhwYW5kbyArICJfIiArICggbm9uY2UuZ3VpZCsrICkgKTsNCgkJdGhpc1sgY2FsbGJhY2sgXSA9IHRydWU7DQoJCXJldHVybiBjYWxsYmFjazsNCgl9DQp9ICk7DQoNCi8vIERldGVjdCwgbm9ybWFsaXplIG9wdGlvbnMgYW5kIGluc3RhbGwgY2FsbGJhY2tzIGZvciBqc29ucCByZXF1ZXN0cw0KalF1ZXJ5LmFqYXhQcmVmaWx0ZXIoICJqc29uIGpzb25wIiwgZnVuY3Rpb24oIHMsIG9yaWdpbmFsU2V0dGluZ3MsIGpxWEhSICkgew0KDQoJdmFyIGNhbGxiYWNrTmFtZSwgb3ZlcndyaXR0ZW4sIHJlc3BvbnNlQ29udGFpbmVyLA0KCQlqc29uUHJvcCA9IHMuanNvbnAgIT09IGZhbHNlICYmICggcmpzb25wLnRlc3QoIHMudXJsICkgPw0KCQkJInVybCIgOg0KCQkJdHlwZW9mIHMuZGF0YSA9PT0gInN0cmluZyIgJiYNCgkJCQkoIHMuY29udGVudFR5cGUgfHwgIiIgKQ0KCQkJCQkuaW5kZXhPZiggImFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCIgKSA9PT0gMCAmJg0KCQkJCXJqc29ucC50ZXN0KCBzLmRhdGEgKSAmJiAiZGF0YSINCgkJKTsNCg0KCS8vIEhhbmRsZSBpZmYgdGhlIGV4cGVjdGVkIGRhdGEgdHlwZSBpcyAianNvbnAiIG9yIHdlIGhhdmUgYSBwYXJhbWV0ZXIgdG8gc2V0DQoJaWYgKCBqc29uUHJvcCB8fCBzLmRhdGFUeXBlc1sgMCBdID09PSAianNvbnAiICkgew0KDQoJCS8vIEdldCBjYWxsYmFjayBuYW1lLCByZW1lbWJlcmluZyBwcmVleGlzdGluZyB2YWx1ZSBhc3NvY2lhdGVkIHdpdGggaXQNCgkJY2FsbGJhY2tOYW1lID0gcy5qc29ucENhbGxiYWNrID0gaXNGdW5jdGlvbiggcy5qc29ucENhbGxiYWNrICkgPw0KCQkJcy5qc29ucENhbGxiYWNrKCkgOg0KCQkJcy5qc29ucENhbGxiYWNrOw0KDQoJCS8vIEluc2VydCBjYWxsYmFjayBpbnRvIHVybCBvciBmb3JtIGRhdGENCgkJaWYgKCBqc29uUHJvcCApIHsNCgkJCXNbIGpzb25Qcm9wIF0gPSBzWyBqc29uUHJvcCBdLnJlcGxhY2UoIHJqc29ucCwgIiQxIiArIGNhbGxiYWNrTmFtZSApOw0KCQl9IGVsc2UgaWYgKCBzLmpzb25wICE9PSBmYWxzZSApIHsNCgkJCXMudXJsICs9ICggcnF1ZXJ5LnRlc3QoIHMudXJsICkgPyAiJiIgOiAiPyIgKSArIHMuanNvbnAgKyAiPSIgKyBjYWxsYmFja05hbWU7DQoJCX0NCg0KCQkvLyBVc2UgZGF0YSBjb252ZXJ0ZXIgdG8gcmV0cmlldmUganNvbiBhZnRlciBzY3JpcHQgZXhlY3V0aW9uDQoJCXMuY29udmVydGVyc1sgInNjcmlwdCBqc29uIiBdID0gZnVuY3Rpb24oKSB7DQoJCQlpZiAoICFyZXNwb25zZUNvbnRhaW5lciApIHsNCgkJCQlqUXVlcnkuZXJyb3IoIGNhbGxiYWNrTmFtZSArICIgd2FzIG5vdCBjYWxsZWQiICk7DQoJCQl9DQoJCQlyZXR1cm4gcmVzcG9uc2VDb250YWluZXJbIDAgXTsNCgkJfTsNCg0KCQkvLyBGb3JjZSBqc29uIGRhdGFUeXBlDQoJCXMuZGF0YVR5cGVzWyAwIF0gPSAianNvbiI7DQoNCgkJLy8gSW5zdGFsbCBjYWxsYmFjaw0KCQlvdmVyd3JpdHRlbiA9IHdpbmRvd1sgY2FsbGJhY2tOYW1lIF07DQoJCXdpbmRvd1sgY2FsbGJhY2tOYW1lIF0gPSBmdW5jdGlvbigpIHsNCgkJCXJlc3BvbnNlQ29udGFpbmVyID0gYXJndW1lbnRzOw0KCQl9Ow0KDQoJCS8vIENsZWFuLXVwIGZ1bmN0aW9uIChmaXJlcyBhZnRlciBjb252ZXJ0ZXJzKQ0KCQlqcVhIUi5hbHdheXMoIGZ1bmN0aW9uKCkgew0KDQoJCQkvLyBJZiBwcmV2aW91cyB2YWx1ZSBkaWRuJ3QgZXhpc3QgLSByZW1vdmUgaXQNCgkJCWlmICggb3ZlcndyaXR0ZW4gPT09IHVuZGVmaW5lZCApIHsNCgkJCQlqUXVlcnkoIHdpbmRvdyApLnJlbW92ZVByb3AoIGNhbGxiYWNrTmFtZSApOw0KDQoJCQkvLyBPdGhlcndpc2UgcmVzdG9yZSBwcmVleGlzdGluZyB2YWx1ZQ0KCQkJfSBlbHNlIHsNCgkJCQl3aW5kb3dbIGNhbGxiYWNrTmFtZSBdID0gb3ZlcndyaXR0ZW47DQoJCQl9DQoNCgkJCS8vIFNhdmUgYmFjayBhcyBmcmVlDQoJCQlpZiAoIHNbIGNhbGxiYWNrTmFtZSBdICkgew0KDQoJCQkJLy8gTWFrZSBzdXJlIHRoYXQgcmUtdXNpbmcgdGhlIG9wdGlvbnMgZG9lc24ndCBzY3JldyB0aGluZ3MgYXJvdW5kDQoJCQkJcy5qc29ucENhbGxiYWNrID0gb3JpZ2luYWxTZXR0aW5ncy5qc29ucENhbGxiYWNrOw0KDQoJCQkJLy8gU2F2ZSB0aGUgY2FsbGJhY2sgbmFtZSBmb3IgZnV0dXJlIHVzZQ0KCQkJCW9sZENhbGxiYWNrcy5wdXNoKCBjYWxsYmFja05hbWUgKTsNCgkJCX0NCg0KCQkJLy8gQ2FsbCBpZiBpdCB3YXMgYSBmdW5jdGlvbiBhbmQgd2UgaGF2ZSBhIHJlc3BvbnNlDQoJCQlpZiAoIHJlc3BvbnNlQ29udGFpbmVyICYmIGlzRnVuY3Rpb24oIG92ZXJ3cml0dGVuICkgKSB7DQoJCQkJb3ZlcndyaXR0ZW4oIHJlc3BvbnNlQ29udGFpbmVyWyAwIF0gKTsNCgkJCX0NCg0KCQkJcmVzcG9uc2VDb250YWluZXIgPSBvdmVyd3JpdHRlbiA9IHVuZGVmaW5lZDsNCgkJfSApOw0KDQoJCS8vIERlbGVnYXRlIHRvIHNjcmlwdA0KCQlyZXR1cm4gInNjcmlwdCI7DQoJfQ0KfSApOw0KDQoNCg0KDQovLyBTdXBwb3J0OiBTYWZhcmkgOCBvbmx5DQovLyBJbiBTYWZhcmkgOCBkb2N1bWVudHMgY3JlYXRlZCB2aWEgZG9jdW1lbnQuaW1wbGVtZW50YXRpb24uY3JlYXRlSFRNTERvY3VtZW50DQovLyBjb2xsYXBzZSBzaWJsaW5nIGZvcm1zOiB0aGUgc2Vjb25kIG9uZSBiZWNvbWVzIGEgY2hpbGQgb2YgdGhlIGZpcnN0IG9uZS4NCi8vIEJlY2F1c2Ugb2YgdGhhdCwgdGhpcyBzZWN1cml0eSBtZWFzdXJlIGhhcyB0byBiZSBkaXNhYmxlZCBpbiBTYWZhcmkgOC4NCi8vIGh0dHBzOi8vYnVncy53ZWJraXQub3JnL3Nob3dfYnVnLmNnaT9pZD0xMzczMzcNCnN1cHBvcnQuY3JlYXRlSFRNTERvY3VtZW50ID0gKCBmdW5jdGlvbigpIHsNCgl2YXIgYm9keSA9IGRvY3VtZW50LmltcGxlbWVudGF0aW9uLmNyZWF0ZUhUTUxEb2N1bWVudCggIiIgKS5ib2R5Ow0KCWJvZHkuaW5uZXJIVE1MID0gIjxmb3JtPjwvZm9ybT48Zm9ybT48L2Zvcm0+IjsNCglyZXR1cm4gYm9keS5jaGlsZE5vZGVzLmxlbmd0aCA9PT0gMjsNCn0gKSgpOw0KDQoNCi8vIEFyZ3VtZW50ICJkYXRhIiBzaG91bGQgYmUgc3RyaW5nIG9mIGh0bWwNCi8vIGNvbnRleHQgKG9wdGlvbmFsKTogSWYgc3BlY2lmaWVkLCB0aGUgZnJhZ21lbnQgd2lsbCBiZSBjcmVhdGVkIGluIHRoaXMgY29udGV4dCwNCi8vIGRlZmF1bHRzIHRvIGRvY3VtZW50DQovLyBrZWVwU2NyaXB0cyAob3B0aW9uYWwpOiBJZiB0cnVlLCB3aWxsIGluY2x1ZGUgc2NyaXB0cyBwYXNzZWQgaW4gdGhlIGh0bWwgc3RyaW5nDQpqUXVlcnkucGFyc2VIVE1MID0gZnVuY3Rpb24oIGRhdGEsIGNvbnRleHQsIGtlZXBTY3JpcHRzICkgew0KCWlmICggdHlwZW9mIGRhdGEgIT09ICJzdHJpbmciICkgew0KCQlyZXR1cm4gW107DQoJfQ0KCWlmICggdHlwZW9mIGNvbnRleHQgPT09ICJib29sZWFuIiApIHsNCgkJa2VlcFNjcmlwdHMgPSBjb250ZXh0Ow0KCQljb250ZXh0ID0gZmFsc2U7DQoJfQ0KDQoJdmFyIGJhc2UsIHBhcnNlZCwgc2NyaXB0czsNCg0KCWlmICggIWNvbnRleHQgKSB7DQoNCgkJLy8gU3RvcCBzY3JpcHRzIG9yIGlubGluZSBldmVudCBoYW5kbGVycyBmcm9tIGJlaW5nIGV4ZWN1dGVkIGltbWVkaWF0ZWx5DQoJCS8vIGJ5IHVzaW5nIGRvY3VtZW50LmltcGxlbWVudGF0aW9uDQoJCWlmICggc3VwcG9ydC5jcmVhdGVIVE1MRG9jdW1lbnQgKSB7DQoJCQljb250ZXh0ID0gZG9jdW1lbnQuaW1wbGVtZW50YXRpb24uY3JlYXRlSFRNTERvY3VtZW50KCAiIiApOw0KDQoJCQkvLyBTZXQgdGhlIGJhc2UgaHJlZiBmb3IgdGhlIGNyZWF0ZWQgZG9jdW1lbnQNCgkJCS8vIHNvIGFueSBwYXJzZWQgZWxlbWVudHMgd2l0aCBVUkxzDQoJCQkvLyBhcmUgYmFzZWQgb24gdGhlIGRvY3VtZW50J3MgVVJMIChnaC0yOTY1KQ0KCQkJYmFzZSA9IGNvbnRleHQuY3JlYXRlRWxlbWVudCggImJhc2UiICk7DQoJCQliYXNlLmhyZWYgPSBkb2N1bWVudC5sb2NhdGlvbi5ocmVmOw0KCQkJY29udGV4dC5oZWFkLmFwcGVuZENoaWxkKCBiYXNlICk7DQoJCX0gZWxzZSB7DQoJCQljb250ZXh0ID0gZG9jdW1lbnQ7DQoJCX0NCgl9DQoNCglwYXJzZWQgPSByc2luZ2xlVGFnLmV4ZWMoIGRhdGEgKTsNCglzY3JpcHRzID0gIWtlZXBTY3JpcHRzICYmIFtdOw0KDQoJLy8gU2luZ2xlIHRhZw0KCWlmICggcGFyc2VkICkgew0KCQlyZXR1cm4gWyBjb250ZXh0LmNyZWF0ZUVsZW1lbnQoIHBhcnNlZFsgMSBdICkgXTsNCgl9DQoNCglwYXJzZWQgPSBidWlsZEZyYWdtZW50KCBbIGRhdGEgXSwgY29udGV4dCwgc2NyaXB0cyApOw0KDQoJaWYgKCBzY3JpcHRzICYmIHNjcmlwdHMubGVuZ3RoICkgew0KCQlqUXVlcnkoIHNjcmlwdHMgKS5yZW1vdmUoKTsNCgl9DQoNCglyZXR1cm4galF1ZXJ5Lm1lcmdlKCBbXSwgcGFyc2VkLmNoaWxkTm9kZXMgKTsNCn07DQoNCg0KLyoqDQogKiBMb2FkIGEgdXJsIGludG8gYSBwYWdlDQogKi8NCmpRdWVyeS5mbi5sb2FkID0gZnVuY3Rpb24oIHVybCwgcGFyYW1zLCBjYWxsYmFjayApIHsNCgl2YXIgc2VsZWN0b3IsIHR5cGUsIHJlc3BvbnNlLA0KCQlzZWxmID0gdGhpcywNCgkJb2ZmID0gdXJsLmluZGV4T2YoICIgIiApOw0KDQoJaWYgKCBvZmYgPiAtMSApIHsNCgkJc2VsZWN0b3IgPSBzdHJpcEFuZENvbGxhcHNlKCB1cmwuc2xpY2UoIG9mZiApICk7DQoJCXVybCA9IHVybC5zbGljZSggMCwgb2ZmICk7DQoJfQ0KDQoJLy8gSWYgaXQncyBhIGZ1bmN0aW9uDQoJaWYgKCBpc0Z1bmN0aW9uKCBwYXJhbXMgKSApIHsNCg0KCQkvLyBXZSBhc3N1bWUgdGhhdCBpdCdzIHRoZSBjYWxsYmFjaw0KCQljYWxsYmFjayA9IHBhcmFtczsNCgkJcGFyYW1zID0gdW5kZWZpbmVkOw0KDQoJLy8gT3RoZXJ3aXNlLCBidWlsZCBhIHBhcmFtIHN0cmluZw0KCX0gZWxzZSBpZiAoIHBhcmFtcyAmJiB0eXBlb2YgcGFyYW1zID09PSAib2JqZWN0IiApIHsNCgkJdHlwZSA9ICJQT1NUIjsNCgl9DQoNCgkvLyBJZiB3ZSBoYXZlIGVsZW1lbnRzIHRvIG1vZGlmeSwgbWFrZSB0aGUgcmVxdWVzdA0KCWlmICggc2VsZi5sZW5ndGggPiAwICkgew0KCQlqUXVlcnkuYWpheCggew0KCQkJdXJsOiB1cmwsDQoNCgkJCS8vIElmICJ0eXBlIiB2YXJpYWJsZSBpcyB1bmRlZmluZWQsIHRoZW4gIkdFVCIgbWV0aG9kIHdpbGwgYmUgdXNlZC4NCgkJCS8vIE1ha2UgdmFsdWUgb2YgdGhpcyBmaWVsZCBleHBsaWNpdCBzaW5jZQ0KCQkJLy8gdXNlciBjYW4gb3ZlcnJpZGUgaXQgdGhyb3VnaCBhamF4U2V0dXAgbWV0aG9kDQoJCQl0eXBlOiB0eXBlIHx8ICJHRVQiLA0KCQkJZGF0YVR5cGU6ICJodG1sIiwNCgkJCWRhdGE6IHBhcmFtcw0KCQl9ICkuZG9uZSggZnVuY3Rpb24oIHJlc3BvbnNlVGV4dCApIHsNCg0KCQkJLy8gU2F2ZSByZXNwb25zZSBmb3IgdXNlIGluIGNvbXBsZXRlIGNhbGxiYWNrDQoJCQlyZXNwb25zZSA9IGFyZ3VtZW50czsNCg0KCQkJc2VsZi5odG1sKCBzZWxlY3RvciA/DQoNCgkJCQkvLyBJZiBhIHNlbGVjdG9yIHdhcyBzcGVjaWZpZWQsIGxvY2F0ZSB0aGUgcmlnaHQgZWxlbWVudHMgaW4gYSBkdW1teSBkaXYNCgkJCQkvLyBFeGNsdWRlIHNjcmlwdHMgdG8gYXZvaWQgSUUgJ1Blcm1pc3Npb24gRGVuaWVkJyBlcnJvcnMNCgkJCQlqUXVlcnkoICI8ZGl2PiIgKS5hcHBlbmQoIGpRdWVyeS5wYXJzZUhUTUwoIHJlc3BvbnNlVGV4dCApICkuZmluZCggc2VsZWN0b3IgKSA6DQoNCgkJCQkvLyBPdGhlcndpc2UgdXNlIHRoZSBmdWxsIHJlc3VsdA0KCQkJCXJlc3BvbnNlVGV4dCApOw0KDQoJCS8vIElmIHRoZSByZXF1ZXN0IHN1Y2NlZWRzLCB0aGlzIGZ1bmN0aW9uIGdldHMgImRhdGEiLCAic3RhdHVzIiwgImpxWEhSIg0KCQkvLyBidXQgdGhleSBhcmUgaWdub3JlZCBiZWNhdXNlIHJlc3BvbnNlIHdhcyBzZXQgYWJvdmUuDQoJCS8vIElmIGl0IGZhaWxzLCB0aGlzIGZ1bmN0aW9uIGdldHMgImpxWEhSIiwgInN0YXR1cyIsICJlcnJvciINCgkJfSApLmFsd2F5cyggY2FsbGJhY2sgJiYgZnVuY3Rpb24oIGpxWEhSLCBzdGF0dXMgKSB7DQoJCQlzZWxmLmVhY2goIGZ1bmN0aW9uKCkgew0KCQkJCWNhbGxiYWNrLmFwcGx5KCB0aGlzLCByZXNwb25zZSB8fCBbIGpxWEhSLnJlc3BvbnNlVGV4dCwgc3RhdHVzLCBqcVhIUiBdICk7DQoJCQl9ICk7DQoJCX0gKTsNCgl9DQoNCglyZXR1cm4gdGhpczsNCn07DQoNCg0KDQoNCmpRdWVyeS5leHByLnBzZXVkb3MuYW5pbWF0ZWQgPSBmdW5jdGlvbiggZWxlbSApIHsNCglyZXR1cm4galF1ZXJ5LmdyZXAoIGpRdWVyeS50aW1lcnMsIGZ1bmN0aW9uKCBmbiApIHsNCgkJcmV0dXJuIGVsZW0gPT09IGZuLmVsZW07DQoJfSApLmxlbmd0aDsNCn07DQoNCg0KDQoNCmpRdWVyeS5vZmZzZXQgPSB7DQoJc2V0T2Zmc2V0OiBmdW5jdGlvbiggZWxlbSwgb3B0aW9ucywgaSApIHsNCgkJdmFyIGN1clBvc2l0aW9uLCBjdXJMZWZ0LCBjdXJDU1NUb3AsIGN1clRvcCwgY3VyT2Zmc2V0LCBjdXJDU1NMZWZ0LCBjYWxjdWxhdGVQb3NpdGlvbiwNCgkJCXBvc2l0aW9uID0galF1ZXJ5LmNzcyggZWxlbSwgInBvc2l0aW9uIiApLA0KCQkJY3VyRWxlbSA9IGpRdWVyeSggZWxlbSApLA0KCQkJcHJvcHMgPSB7fTsNCg0KCQkvLyBTZXQgcG9zaXRpb24gZmlyc3QsIGluLWNhc2UgdG9wL2xlZnQgYXJlIHNldCBldmVuIG9uIHN0YXRpYyBlbGVtDQoJCWlmICggcG9zaXRpb24gPT09ICJzdGF0aWMiICkgew0KCQkJZWxlbS5zdHlsZS5wb3NpdGlvbiA9ICJyZWxhdGl2ZSI7DQoJCX0NCg0KCQljdXJPZmZzZXQgPSBjdXJFbGVtLm9mZnNldCgpOw0KCQljdXJDU1NUb3AgPSBqUXVlcnkuY3NzKCBlbGVtLCAidG9wIiApOw0KCQljdXJDU1NMZWZ0ID0galF1ZXJ5LmNzcyggZWxlbSwgImxlZnQiICk7DQoJCWNhbGN1bGF0ZVBvc2l0aW9uID0gKCBwb3NpdGlvbiA9PT0gImFic29sdXRlIiB8fCBwb3NpdGlvbiA9PT0gImZpeGVkIiApICYmDQoJCQkoIGN1ckNTU1RvcCArIGN1ckNTU0xlZnQgKS5pbmRleE9mKCAiYXV0byIgKSA+IC0xOw0KDQoJCS8vIE5lZWQgdG8gYmUgYWJsZSB0byBjYWxjdWxhdGUgcG9zaXRpb24gaWYgZWl0aGVyDQoJCS8vIHRvcCBvciBsZWZ0IGlzIGF1dG8gYW5kIHBvc2l0aW9uIGlzIGVpdGhlciBhYnNvbHV0ZSBvciBmaXhlZA0KCQlpZiAoIGNhbGN1bGF0ZVBvc2l0aW9uICkgew0KCQkJY3VyUG9zaXRpb24gPSBjdXJFbGVtLnBvc2l0aW9uKCk7DQoJCQljdXJUb3AgPSBjdXJQb3NpdGlvbi50b3A7DQoJCQljdXJMZWZ0ID0gY3VyUG9zaXRpb24ubGVmdDsNCg0KCQl9IGVsc2Ugew0KCQkJY3VyVG9wID0gcGFyc2VGbG9hdCggY3VyQ1NTVG9wICkgfHwgMDsNCgkJCWN1ckxlZnQgPSBwYXJzZUZsb2F0KCBjdXJDU1NMZWZ0ICkgfHwgMDsNCgkJfQ0KDQoJCWlmICggaXNGdW5jdGlvbiggb3B0aW9ucyApICkgew0KDQoJCQkvLyBVc2UgalF1ZXJ5LmV4dGVuZCBoZXJlIHRvIGFsbG93IG1vZGlmaWNhdGlvbiBvZiBjb29yZGluYXRlcyBhcmd1bWVudCAoZ2gtMTg0OCkNCgkJCW9wdGlvbnMgPSBvcHRpb25zLmNhbGwoIGVsZW0sIGksIGpRdWVyeS5leHRlbmQoIHt9LCBjdXJPZmZzZXQgKSApOw0KCQl9DQoNCgkJaWYgKCBvcHRpb25zLnRvcCAhPSBudWxsICkgew0KCQkJcHJvcHMudG9wID0gKCBvcHRpb25zLnRvcCAtIGN1ck9mZnNldC50b3AgKSArIGN1clRvcDsNCgkJfQ0KCQlpZiAoIG9wdGlvbnMubGVmdCAhPSBudWxsICkgew0KCQkJcHJvcHMubGVmdCA9ICggb3B0aW9ucy5sZWZ0IC0gY3VyT2Zmc2V0LmxlZnQgKSArIGN1ckxlZnQ7DQoJCX0NCg0KCQlpZiAoICJ1c2luZyIgaW4gb3B0aW9ucyApIHsNCgkJCW9wdGlvbnMudXNpbmcuY2FsbCggZWxlbSwgcHJvcHMgKTsNCg0KCQl9IGVsc2Ugew0KCQkJY3VyRWxlbS5jc3MoIHByb3BzICk7DQoJCX0NCgl9DQp9Ow0KDQpqUXVlcnkuZm4uZXh0ZW5kKCB7DQoNCgkvLyBvZmZzZXQoKSByZWxhdGVzIGFuIGVsZW1lbnQncyBib3JkZXIgYm94IHRvIHRoZSBkb2N1bWVudCBvcmlnaW4NCglvZmZzZXQ6IGZ1bmN0aW9uKCBvcHRpb25zICkgew0KDQoJCS8vIFByZXNlcnZlIGNoYWluaW5nIGZvciBzZXR0ZXINCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoICkgew0KCQkJcmV0dXJuIG9wdGlvbnMgPT09IHVuZGVmaW5lZCA/DQoJCQkJdGhpcyA6DQoJCQkJdGhpcy5lYWNoKCBmdW5jdGlvbiggaSApIHsNCgkJCQkJalF1ZXJ5Lm9mZnNldC5zZXRPZmZzZXQoIHRoaXMsIG9wdGlvbnMsIGkgKTsNCgkJCQl9ICk7DQoJCX0NCg0KCQl2YXIgcmVjdCwgd2luLA0KCQkJZWxlbSA9IHRoaXNbIDAgXTsNCg0KCQlpZiAoICFlbGVtICkgew0KCQkJcmV0dXJuOw0KCQl9DQoNCgkJLy8gUmV0dXJuIHplcm9zIGZvciBkaXNjb25uZWN0ZWQgYW5kIGhpZGRlbiAoZGlzcGxheTogbm9uZSkgZWxlbWVudHMgKGdoLTIzMTApDQoJCS8vIFN1cHBvcnQ6IElFIDw9MTEgb25seQ0KCQkvLyBSdW5uaW5nIGdldEJvdW5kaW5nQ2xpZW50UmVjdCBvbiBhDQoJCS8vIGRpc2Nvbm5lY3RlZCBub2RlIGluIElFIHRocm93cyBhbiBlcnJvcg0KCQlpZiAoICFlbGVtLmdldENsaWVudFJlY3RzKCkubGVuZ3RoICkgew0KCQkJcmV0dXJuIHsgdG9wOiAwLCBsZWZ0OiAwIH07DQoJCX0NCg0KCQkvLyBHZXQgZG9jdW1lbnQtcmVsYXRpdmUgcG9zaXRpb24gYnkgYWRkaW5nIHZpZXdwb3J0IHNjcm9sbCB0byB2aWV3cG9ydC1yZWxhdGl2ZSBnQkNSDQoJCXJlY3QgPSBlbGVtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOw0KCQl3aW4gPSBlbGVtLm93bmVyRG9jdW1lbnQuZGVmYXVsdFZpZXc7DQoJCXJldHVybiB7DQoJCQl0b3A6IHJlY3QudG9wICsgd2luLnBhZ2VZT2Zmc2V0LA0KCQkJbGVmdDogcmVjdC5sZWZ0ICsgd2luLnBhZ2VYT2Zmc2V0DQoJCX07DQoJfSwNCg0KCS8vIHBvc2l0aW9uKCkgcmVsYXRlcyBhbiBlbGVtZW50J3MgbWFyZ2luIGJveCB0byBpdHMgb2Zmc2V0IHBhcmVudCdzIHBhZGRpbmcgYm94DQoJLy8gVGhpcyBjb3JyZXNwb25kcyB0byB0aGUgYmVoYXZpb3Igb2YgQ1NTIGFic29sdXRlIHBvc2l0aW9uaW5nDQoJcG9zaXRpb246IGZ1bmN0aW9uKCkgew0KCQlpZiAoICF0aGlzWyAwIF0gKSB7DQoJCQlyZXR1cm47DQoJCX0NCg0KCQl2YXIgb2Zmc2V0UGFyZW50LCBvZmZzZXQsIGRvYywNCgkJCWVsZW0gPSB0aGlzWyAwIF0sDQoJCQlwYXJlbnRPZmZzZXQgPSB7IHRvcDogMCwgbGVmdDogMCB9Ow0KDQoJCS8vIHBvc2l0aW9uOmZpeGVkIGVsZW1lbnRzIGFyZSBvZmZzZXQgZnJvbSB0aGUgdmlld3BvcnQsIHdoaWNoIGl0c2VsZiBhbHdheXMgaGFzIHplcm8gb2Zmc2V0DQoJCWlmICggalF1ZXJ5LmNzcyggZWxlbSwgInBvc2l0aW9uIiApID09PSAiZml4ZWQiICkgew0KDQoJCQkvLyBBc3N1bWUgcG9zaXRpb246Zml4ZWQgaW1wbGllcyBhdmFpbGFiaWxpdHkgb2YgZ2V0Qm91bmRpbmdDbGllbnRSZWN0DQoJCQlvZmZzZXQgPSBlbGVtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOw0KDQoJCX0gZWxzZSB7DQoJCQlvZmZzZXQgPSB0aGlzLm9mZnNldCgpOw0KDQoJCQkvLyBBY2NvdW50IGZvciB0aGUgKnJlYWwqIG9mZnNldCBwYXJlbnQsIHdoaWNoIGNhbiBiZSB0aGUgZG9jdW1lbnQgb3IgaXRzIHJvb3QgZWxlbWVudA0KCQkJLy8gd2hlbiBhIHN0YXRpY2FsbHkgcG9zaXRpb25lZCBlbGVtZW50IGlzIGlkZW50aWZpZWQNCgkJCWRvYyA9IGVsZW0ub3duZXJEb2N1bWVudDsNCgkJCW9mZnNldFBhcmVudCA9IGVsZW0ub2Zmc2V0UGFyZW50IHx8IGRvYy5kb2N1bWVudEVsZW1lbnQ7DQoJCQl3aGlsZSAoIG9mZnNldFBhcmVudCAmJg0KCQkJCSggb2Zmc2V0UGFyZW50ID09PSBkb2MuYm9keSB8fCBvZmZzZXRQYXJlbnQgPT09IGRvYy5kb2N1bWVudEVsZW1lbnQgKSAmJg0KCQkJCWpRdWVyeS5jc3MoIG9mZnNldFBhcmVudCwgInBvc2l0aW9uIiApID09PSAic3RhdGljIiApIHsNCg0KCQkJCW9mZnNldFBhcmVudCA9IG9mZnNldFBhcmVudC5wYXJlbnROb2RlOw0KCQkJfQ0KCQkJaWYgKCBvZmZzZXRQYXJlbnQgJiYgb2Zmc2V0UGFyZW50ICE9PSBlbGVtICYmIG9mZnNldFBhcmVudC5ub2RlVHlwZSA9PT0gMSApIHsNCg0KCQkJCS8vIEluY29ycG9yYXRlIGJvcmRlcnMgaW50byBpdHMgb2Zmc2V0LCBzaW5jZSB0aGV5IGFyZSBvdXRzaWRlIGl0cyBjb250ZW50IG9yaWdpbg0KCQkJCXBhcmVudE9mZnNldCA9IGpRdWVyeSggb2Zmc2V0UGFyZW50ICkub2Zmc2V0KCk7DQoJCQkJcGFyZW50T2Zmc2V0LnRvcCArPSBqUXVlcnkuY3NzKCBvZmZzZXRQYXJlbnQsICJib3JkZXJUb3BXaWR0aCIsIHRydWUgKTsNCgkJCQlwYXJlbnRPZmZzZXQubGVmdCArPSBqUXVlcnkuY3NzKCBvZmZzZXRQYXJlbnQsICJib3JkZXJMZWZ0V2lkdGgiLCB0cnVlICk7DQoJCQl9DQoJCX0NCg0KCQkvLyBTdWJ0cmFjdCBwYXJlbnQgb2Zmc2V0cyBhbmQgZWxlbWVudCBtYXJnaW5zDQoJCXJldHVybiB7DQoJCQl0b3A6IG9mZnNldC50b3AgLSBwYXJlbnRPZmZzZXQudG9wIC0galF1ZXJ5LmNzcyggZWxlbSwgIm1hcmdpblRvcCIsIHRydWUgKSwNCgkJCWxlZnQ6IG9mZnNldC5sZWZ0IC0gcGFyZW50T2Zmc2V0LmxlZnQgLSBqUXVlcnkuY3NzKCBlbGVtLCAibWFyZ2luTGVmdCIsIHRydWUgKQ0KCQl9Ow0KCX0sDQoNCgkvLyBUaGlzIG1ldGhvZCB3aWxsIHJldHVybiBkb2N1bWVudEVsZW1lbnQgaW4gdGhlIGZvbGxvd2luZyBjYXNlczoNCgkvLyAxKSBGb3IgdGhlIGVsZW1lbnQgaW5zaWRlIHRoZSBpZnJhbWUgd2l0aG91dCBvZmZzZXRQYXJlbnQsIHRoaXMgbWV0aG9kIHdpbGwgcmV0dXJuDQoJLy8gICAgZG9jdW1lbnRFbGVtZW50IG9mIHRoZSBwYXJlbnQgd2luZG93DQoJLy8gMikgRm9yIHRoZSBoaWRkZW4gb3IgZGV0YWNoZWQgZWxlbWVudA0KCS8vIDMpIEZvciBib2R5IG9yIGh0bWwgZWxlbWVudCwgaS5lLiBpbiBjYXNlIG9mIHRoZSBodG1sIG5vZGUgLSBpdCB3aWxsIHJldHVybiBpdHNlbGYNCgkvLw0KCS8vIGJ1dCB0aG9zZSBleGNlcHRpb25zIHdlcmUgbmV2ZXIgcHJlc2VudGVkIGFzIGEgcmVhbCBsaWZlIHVzZS1jYXNlcw0KCS8vIGFuZCBtaWdodCBiZSBjb25zaWRlcmVkIGFzIG1vcmUgcHJlZmVyYWJsZSByZXN1bHRzLg0KCS8vDQoJLy8gVGhpcyBsb2dpYywgaG93ZXZlciwgaXMgbm90IGd1YXJhbnRlZWQgYW5kIGNhbiBjaGFuZ2UgYXQgYW55IHBvaW50IGluIHRoZSBmdXR1cmUNCglvZmZzZXRQYXJlbnQ6IGZ1bmN0aW9uKCkgew0KCQlyZXR1cm4gdGhpcy5tYXAoIGZ1bmN0aW9uKCkgew0KCQkJdmFyIG9mZnNldFBhcmVudCA9IHRoaXMub2Zmc2V0UGFyZW50Ow0KDQoJCQl3aGlsZSAoIG9mZnNldFBhcmVudCAmJiBqUXVlcnkuY3NzKCBvZmZzZXRQYXJlbnQsICJwb3NpdGlvbiIgKSA9PT0gInN0YXRpYyIgKSB7DQoJCQkJb2Zmc2V0UGFyZW50ID0gb2Zmc2V0UGFyZW50Lm9mZnNldFBhcmVudDsNCgkJCX0NCg0KCQkJcmV0dXJuIG9mZnNldFBhcmVudCB8fCBkb2N1bWVudEVsZW1lbnQ7DQoJCX0gKTsNCgl9DQp9ICk7DQoNCi8vIENyZWF0ZSBzY3JvbGxMZWZ0IGFuZCBzY3JvbGxUb3AgbWV0aG9kcw0KalF1ZXJ5LmVhY2goIHsgc2Nyb2xsTGVmdDogInBhZ2VYT2Zmc2V0Iiwgc2Nyb2xsVG9wOiAicGFnZVlPZmZzZXQiIH0sIGZ1bmN0aW9uKCBtZXRob2QsIHByb3AgKSB7DQoJdmFyIHRvcCA9ICJwYWdlWU9mZnNldCIgPT09IHByb3A7DQoNCglqUXVlcnkuZm5bIG1ldGhvZCBdID0gZnVuY3Rpb24oIHZhbCApIHsNCgkJcmV0dXJuIGFjY2VzcyggdGhpcywgZnVuY3Rpb24oIGVsZW0sIG1ldGhvZCwgdmFsICkgew0KDQoJCQkvLyBDb2FsZXNjZSBkb2N1bWVudHMgYW5kIHdpbmRvd3MNCgkJCXZhciB3aW47DQoJCQlpZiAoIGlzV2luZG93KCBlbGVtICkgKSB7DQoJCQkJd2luID0gZWxlbTsNCgkJCX0gZWxzZSBpZiAoIGVsZW0ubm9kZVR5cGUgPT09IDkgKSB7DQoJCQkJd2luID0gZWxlbS5kZWZhdWx0VmlldzsNCgkJCX0NCg0KCQkJaWYgKCB2YWwgPT09IHVuZGVmaW5lZCApIHsNCgkJCQlyZXR1cm4gd2luID8gd2luWyBwcm9wIF0gOiBlbGVtWyBtZXRob2QgXTsNCgkJCX0NCg0KCQkJaWYgKCB3aW4gKSB7DQoJCQkJd2luLnNjcm9sbFRvKA0KCQkJCQkhdG9wID8gdmFsIDogd2luLnBhZ2VYT2Zmc2V0LA0KCQkJCQl0b3AgPyB2YWwgOiB3aW4ucGFnZVlPZmZzZXQNCgkJCQkpOw0KDQoJCQl9IGVsc2Ugew0KCQkJCWVsZW1bIG1ldGhvZCBdID0gdmFsOw0KCQkJfQ0KCQl9LCBtZXRob2QsIHZhbCwgYXJndW1lbnRzLmxlbmd0aCApOw0KCX07DQp9ICk7DQoNCi8vIFN1cHBvcnQ6IFNhZmFyaSA8PTcgLSA5LjEsIENocm9tZSA8PTM3IC0gNDkNCi8vIEFkZCB0aGUgdG9wL2xlZnQgY3NzSG9va3MgdXNpbmcgalF1ZXJ5LmZuLnBvc2l0aW9uDQovLyBXZWJraXQgYnVnOiBodHRwczovL2J1Z3Mud2Via2l0Lm9yZy9zaG93X2J1Zy5jZ2k/aWQ9MjkwODQNCi8vIEJsaW5rIGJ1ZzogaHR0cHM6Ly9idWdzLmNocm9taXVtLm9yZy9wL2Nocm9taXVtL2lzc3Vlcy9kZXRhaWw/aWQ9NTg5MzQ3DQovLyBnZXRDb21wdXRlZFN0eWxlIHJldHVybnMgcGVyY2VudCB3aGVuIHNwZWNpZmllZCBmb3IgdG9wL2xlZnQvYm90dG9tL3JpZ2h0Ow0KLy8gcmF0aGVyIHRoYW4gbWFrZSB0aGUgY3NzIG1vZHVsZSBkZXBlbmQgb24gdGhlIG9mZnNldCBtb2R1bGUsIGp1c3QgY2hlY2sgZm9yIGl0IGhlcmUNCmpRdWVyeS5lYWNoKCBbICJ0b3AiLCAibGVmdCIgXSwgZnVuY3Rpb24oIF9pLCBwcm9wICkgew0KCWpRdWVyeS5jc3NIb29rc1sgcHJvcCBdID0gYWRkR2V0SG9va0lmKCBzdXBwb3J0LnBpeGVsUG9zaXRpb24sDQoJCWZ1bmN0aW9uKCBlbGVtLCBjb21wdXRlZCApIHsNCgkJCWlmICggY29tcHV0ZWQgKSB7DQoJCQkJY29tcHV0ZWQgPSBjdXJDU1MoIGVsZW0sIHByb3AgKTsNCg0KCQkJCS8vIElmIGN1ckNTUyByZXR1cm5zIHBlcmNlbnRhZ2UsIGZhbGxiYWNrIHRvIG9mZnNldA0KCQkJCXJldHVybiBybnVtbm9ucHgudGVzdCggY29tcHV0ZWQgKSA/DQoJCQkJCWpRdWVyeSggZWxlbSApLnBvc2l0aW9uKClbIHByb3AgXSArICJweCIgOg0KCQkJCQljb21wdXRlZDsNCgkJCX0NCgkJfQ0KCSk7DQp9ICk7DQoNCg0KLy8gQ3JlYXRlIGlubmVySGVpZ2h0LCBpbm5lcldpZHRoLCBoZWlnaHQsIHdpZHRoLCBvdXRlckhlaWdodCBhbmQgb3V0ZXJXaWR0aCBtZXRob2RzDQpqUXVlcnkuZWFjaCggeyBIZWlnaHQ6ICJoZWlnaHQiLCBXaWR0aDogIndpZHRoIiB9LCBmdW5jdGlvbiggbmFtZSwgdHlwZSApIHsNCglqUXVlcnkuZWFjaCggew0KCQlwYWRkaW5nOiAiaW5uZXIiICsgbmFtZSwNCgkJY29udGVudDogdHlwZSwNCgkJIiI6ICJvdXRlciIgKyBuYW1lDQoJfSwgZnVuY3Rpb24oIGRlZmF1bHRFeHRyYSwgZnVuY05hbWUgKSB7DQoNCgkJLy8gTWFyZ2luIGlzIG9ubHkgZm9yIG91dGVySGVpZ2h0LCBvdXRlcldpZHRoDQoJCWpRdWVyeS5mblsgZnVuY05hbWUgXSA9IGZ1bmN0aW9uKCBtYXJnaW4sIHZhbHVlICkgew0KCQkJdmFyIGNoYWluYWJsZSA9IGFyZ3VtZW50cy5sZW5ndGggJiYgKCBkZWZhdWx0RXh0cmEgfHwgdHlwZW9mIG1hcmdpbiAhPT0gImJvb2xlYW4iICksDQoJCQkJZXh0cmEgPSBkZWZhdWx0RXh0cmEgfHwgKCBtYXJnaW4gPT09IHRydWUgfHwgdmFsdWUgPT09IHRydWUgPyAibWFyZ2luIiA6ICJib3JkZXIiICk7DQoNCgkJCXJldHVybiBhY2Nlc3MoIHRoaXMsIGZ1bmN0aW9uKCBlbGVtLCB0eXBlLCB2YWx1ZSApIHsNCgkJCQl2YXIgZG9jOw0KDQoJCQkJaWYgKCBpc1dpbmRvdyggZWxlbSApICkgew0KDQoJCQkJCS8vICQoIHdpbmRvdyApLm91dGVyV2lkdGgvSGVpZ2h0IHJldHVybiB3L2ggaW5jbHVkaW5nIHNjcm9sbGJhcnMgKGdoLTE3MjkpDQoJCQkJCXJldHVybiBmdW5jTmFtZS5pbmRleE9mKCAib3V0ZXIiICkgPT09IDAgPw0KCQkJCQkJZWxlbVsgImlubmVyIiArIG5hbWUgXSA6DQoJCQkJCQllbGVtLmRvY3VtZW50LmRvY3VtZW50RWxlbWVudFsgImNsaWVudCIgKyBuYW1lIF07DQoJCQkJfQ0KDQoJCQkJLy8gR2V0IGRvY3VtZW50IHdpZHRoIG9yIGhlaWdodA0KCQkJCWlmICggZWxlbS5ub2RlVHlwZSA9PT0gOSApIHsNCgkJCQkJZG9jID0gZWxlbS5kb2N1bWVudEVsZW1lbnQ7DQoNCgkJCQkJLy8gRWl0aGVyIHNjcm9sbFtXaWR0aC9IZWlnaHRdIG9yIG9mZnNldFtXaWR0aC9IZWlnaHRdIG9yIGNsaWVudFtXaWR0aC9IZWlnaHRdLA0KCQkJCQkvLyB3aGljaGV2ZXIgaXMgZ3JlYXRlc3QNCgkJCQkJcmV0dXJuIE1hdGgubWF4KA0KCQkJCQkJZWxlbS5ib2R5WyAic2Nyb2xsIiArIG5hbWUgXSwgZG9jWyAic2Nyb2xsIiArIG5hbWUgXSwNCgkJCQkJCWVsZW0uYm9keVsgIm9mZnNldCIgKyBuYW1lIF0sIGRvY1sgIm9mZnNldCIgKyBuYW1lIF0sDQoJCQkJCQlkb2NbICJjbGllbnQiICsgbmFtZSBdDQoJCQkJCSk7DQoJCQkJfQ0KDQoJCQkJcmV0dXJuIHZhbHVlID09PSB1bmRlZmluZWQgPw0KDQoJCQkJCS8vIEdldCB3aWR0aCBvciBoZWlnaHQgb24gdGhlIGVsZW1lbnQsIHJlcXVlc3RpbmcgYnV0IG5vdCBmb3JjaW5nIHBhcnNlRmxvYXQNCgkJCQkJalF1ZXJ5LmNzcyggZWxlbSwgdHlwZSwgZXh0cmEgKSA6DQoNCgkJCQkJLy8gU2V0IHdpZHRoIG9yIGhlaWdodCBvbiB0aGUgZWxlbWVudA0KCQkJCQlqUXVlcnkuc3R5bGUoIGVsZW0sIHR5cGUsIHZhbHVlLCBleHRyYSApOw0KCQkJfSwgdHlwZSwgY2hhaW5hYmxlID8gbWFyZ2luIDogdW5kZWZpbmVkLCBjaGFpbmFibGUgKTsNCgkJfTsNCgl9ICk7DQp9ICk7DQoNCg0KalF1ZXJ5LmVhY2goIFsNCgkiYWpheFN0YXJ0IiwNCgkiYWpheFN0b3AiLA0KCSJhamF4Q29tcGxldGUiLA0KCSJhamF4RXJyb3IiLA0KCSJhamF4U3VjY2VzcyIsDQoJImFqYXhTZW5kIg0KXSwgZnVuY3Rpb24oIF9pLCB0eXBlICkgew0KCWpRdWVyeS5mblsgdHlwZSBdID0gZnVuY3Rpb24oIGZuICkgew0KCQlyZXR1cm4gdGhpcy5vbiggdHlwZSwgZm4gKTsNCgl9Ow0KfSApOw0KDQoNCg0KDQpqUXVlcnkuZm4uZXh0ZW5kKCB7DQoNCgliaW5kOiBmdW5jdGlvbiggdHlwZXMsIGRhdGEsIGZuICkgew0KCQlyZXR1cm4gdGhpcy5vbiggdHlwZXMsIG51bGwsIGRhdGEsIGZuICk7DQoJfSwNCgl1bmJpbmQ6IGZ1bmN0aW9uKCB0eXBlcywgZm4gKSB7DQoJCXJldHVybiB0aGlzLm9mZiggdHlwZXMsIG51bGwsIGZuICk7DQoJfSwNCg0KCWRlbGVnYXRlOiBmdW5jdGlvbiggc2VsZWN0b3IsIHR5cGVzLCBkYXRhLCBmbiApIHsNCgkJcmV0dXJuIHRoaXMub24oIHR5cGVzLCBzZWxlY3RvciwgZGF0YSwgZm4gKTsNCgl9LA0KCXVuZGVsZWdhdGU6IGZ1bmN0aW9uKCBzZWxlY3RvciwgdHlwZXMsIGZuICkgew0KDQoJCS8vICggbmFtZXNwYWNlICkgb3IgKCBzZWxlY3RvciwgdHlwZXMgWywgZm5dICkNCgkJcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPT09IDEgPw0KCQkJdGhpcy5vZmYoIHNlbGVjdG9yLCAiKioiICkgOg0KCQkJdGhpcy5vZmYoIHR5cGVzLCBzZWxlY3RvciB8fCAiKioiLCBmbiApOw0KCX0sDQoNCglob3ZlcjogZnVuY3Rpb24oIGZuT3ZlciwgZm5PdXQgKSB7DQoJCXJldHVybiB0aGlzLm1vdXNlZW50ZXIoIGZuT3ZlciApLm1vdXNlbGVhdmUoIGZuT3V0IHx8IGZuT3ZlciApOw0KCX0NCn0gKTsNCg0KalF1ZXJ5LmVhY2goDQoJKCAiYmx1ciBmb2N1cyBmb2N1c2luIGZvY3Vzb3V0IHJlc2l6ZSBzY3JvbGwgY2xpY2sgZGJsY2xpY2sgIiArDQoJIm1vdXNlZG93biBtb3VzZXVwIG1vdXNlbW92ZSBtb3VzZW92ZXIgbW91c2VvdXQgbW91c2VlbnRlciBtb3VzZWxlYXZlICIgKw0KCSJjaGFuZ2Ugc2VsZWN0IHN1Ym1pdCBrZXlkb3duIGtleXByZXNzIGtleXVwIGNvbnRleHRtZW51IiApLnNwbGl0KCAiICIgKSwNCglmdW5jdGlvbiggX2ksIG5hbWUgKSB7DQoNCgkJLy8gSGFuZGxlIGV2ZW50IGJpbmRpbmcNCgkJalF1ZXJ5LmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggZGF0YSwgZm4gKSB7DQoJCQlyZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA+IDAgPw0KCQkJCXRoaXMub24oIG5hbWUsIG51bGwsIGRhdGEsIGZuICkgOg0KCQkJCXRoaXMudHJpZ2dlciggbmFtZSApOw0KCQl9Ow0KCX0NCik7DQoNCg0KDQoNCi8vIFN1cHBvcnQ6IEFuZHJvaWQgPD00LjAgb25seQ0KLy8gTWFrZSBzdXJlIHdlIHRyaW0gQk9NIGFuZCBOQlNQDQp2YXIgcnRyaW0gPSAvXltcc1x1RkVGRlx4QTBdK3xbXHNcdUZFRkZceEEwXSskL2c7DQoNCi8vIEJpbmQgYSBmdW5jdGlvbiB0byBhIGNvbnRleHQsIG9wdGlvbmFsbHkgcGFydGlhbGx5IGFwcGx5aW5nIGFueQ0KLy8gYXJndW1lbnRzLg0KLy8galF1ZXJ5LnByb3h5IGlzIGRlcHJlY2F0ZWQgdG8gcHJvbW90ZSBzdGFuZGFyZHMgKHNwZWNpZmljYWxseSBGdW5jdGlvbiNiaW5kKQ0KLy8gSG93ZXZlciwgaXQgaXMgbm90IHNsYXRlZCBmb3IgcmVtb3ZhbCBhbnkgdGltZSBzb29uDQpqUXVlcnkucHJveHkgPSBmdW5jdGlvbiggZm4sIGNvbnRleHQgKSB7DQoJdmFyIHRtcCwgYXJncywgcHJveHk7DQoNCglpZiAoIHR5cGVvZiBjb250ZXh0ID09PSAic3RyaW5nIiApIHsNCgkJdG1wID0gZm5bIGNvbnRleHQgXTsNCgkJY29udGV4dCA9IGZuOw0KCQlmbiA9IHRtcDsNCgl9DQoNCgkvLyBRdWljayBjaGVjayB0byBkZXRlcm1pbmUgaWYgdGFyZ2V0IGlzIGNhbGxhYmxlLCBpbiB0aGUgc3BlYw0KCS8vIHRoaXMgdGhyb3dzIGEgVHlwZUVycm9yLCBidXQgd2Ugd2lsbCBqdXN0IHJldHVybiB1bmRlZmluZWQuDQoJaWYgKCAhaXNGdW5jdGlvbiggZm4gKSApIHsNCgkJcmV0dXJuIHVuZGVmaW5lZDsNCgl9DQoNCgkvLyBTaW11bGF0ZWQgYmluZA0KCWFyZ3MgPSBzbGljZS5jYWxsKCBhcmd1bWVudHMsIDIgKTsNCglwcm94eSA9IGZ1bmN0aW9uKCkgew0KCQlyZXR1cm4gZm4uYXBwbHkoIGNvbnRleHQgfHwgdGhpcywgYXJncy5jb25jYXQoIHNsaWNlLmNhbGwoIGFyZ3VtZW50cyApICkgKTsNCgl9Ow0KDQoJLy8gU2V0IHRoZSBndWlkIG9mIHVuaXF1ZSBoYW5kbGVyIHRvIHRoZSBzYW1lIG9mIG9yaWdpbmFsIGhhbmRsZXIsIHNvIGl0IGNhbiBiZSByZW1vdmVkDQoJcHJveHkuZ3VpZCA9IGZuLmd1aWQgPSBmbi5ndWlkIHx8IGpRdWVyeS5ndWlkKys7DQoNCglyZXR1cm4gcHJveHk7DQp9Ow0KDQpqUXVlcnkuaG9sZFJlYWR5ID0gZnVuY3Rpb24oIGhvbGQgKSB7DQoJaWYgKCBob2xkICkgew0KCQlqUXVlcnkucmVhZHlXYWl0Kys7DQoJfSBlbHNlIHsNCgkJalF1ZXJ5LnJlYWR5KCB0cnVlICk7DQoJfQ0KfTsNCmpRdWVyeS5pc0FycmF5ID0gQXJyYXkuaXNBcnJheTsNCmpRdWVyeS5wYXJzZUpTT04gPSBKU09OLnBhcnNlOw0KalF1ZXJ5Lm5vZGVOYW1lID0gbm9kZU5hbWU7DQpqUXVlcnkuaXNGdW5jdGlvbiA9IGlzRnVuY3Rpb247DQpqUXVlcnkuaXNXaW5kb3cgPSBpc1dpbmRvdzsNCmpRdWVyeS5jYW1lbENhc2UgPSBjYW1lbENhc2U7DQpqUXVlcnkudHlwZSA9IHRvVHlwZTsNCg0KalF1ZXJ5Lm5vdyA9IERhdGUubm93Ow0KDQpqUXVlcnkuaXNOdW1lcmljID0gZnVuY3Rpb24oIG9iaiApIHsNCg0KCS8vIEFzIG9mIGpRdWVyeSAzLjAsIGlzTnVtZXJpYyBpcyBsaW1pdGVkIHRvDQoJLy8gc3RyaW5ncyBhbmQgbnVtYmVycyAocHJpbWl0aXZlcyBvciBvYmplY3RzKQ0KCS8vIHRoYXQgY2FuIGJlIGNvZXJjZWQgdG8gZmluaXRlIG51bWJlcnMgKGdoLTI2NjIpDQoJdmFyIHR5cGUgPSBqUXVlcnkudHlwZSggb2JqICk7DQoJcmV0dXJuICggdHlwZSA9PT0gIm51bWJlciIgfHwgdHlwZSA9PT0gInN0cmluZyIgKSAmJg0KDQoJCS8vIHBhcnNlRmxvYXQgTmFOcyBudW1lcmljLWNhc3QgZmFsc2UgcG9zaXRpdmVzICgiIikNCgkJLy8gLi4uYnV0IG1pc2ludGVycHJldHMgbGVhZGluZy1udW1iZXIgc3RyaW5ncywgcGFydGljdWxhcmx5IGhleCBsaXRlcmFscyAoIjB4Li4uIikNCgkJLy8gc3VidHJhY3Rpb24gZm9yY2VzIGluZmluaXRpZXMgdG8gTmFODQoJCSFpc05hTiggb2JqIC0gcGFyc2VGbG9hdCggb2JqICkgKTsNCn07DQoNCmpRdWVyeS50cmltID0gZnVuY3Rpb24oIHRleHQgKSB7DQoJcmV0dXJuIHRleHQgPT0gbnVsbCA/DQoJCSIiIDoNCgkJKCB0ZXh0ICsgIiIgKS5yZXBsYWNlKCBydHJpbSwgIiIgKTsNCn07DQoNCg0KDQovLyBSZWdpc3RlciBhcyBhIG5hbWVkIEFNRCBtb2R1bGUsIHNpbmNlIGpRdWVyeSBjYW4gYmUgY29uY2F0ZW5hdGVkIHdpdGggb3RoZXINCi8vIGZpbGVzIHRoYXQgbWF5IHVzZSBkZWZpbmUsIGJ1dCBub3QgdmlhIGEgcHJvcGVyIGNvbmNhdGVuYXRpb24gc2NyaXB0IHRoYXQNCi8vIHVuZGVyc3RhbmRzIGFub255bW91cyBBTUQgbW9kdWxlcy4gQSBuYW1lZCBBTUQgaXMgc2FmZXN0IGFuZCBtb3N0IHJvYnVzdA0KLy8gd2F5IHRvIHJlZ2lzdGVyLiBMb3dlcmNhc2UganF1ZXJ5IGlzIHVzZWQgYmVjYXVzZSBBTUQgbW9kdWxlIG5hbWVzIGFyZQ0KLy8gZGVyaXZlZCBmcm9tIGZpbGUgbmFtZXMsIGFuZCBqUXVlcnkgaXMgbm9ybWFsbHkgZGVsaXZlcmVkIGluIGEgbG93ZXJjYXNlDQovLyBmaWxlIG5hbWUuIERvIHRoaXMgYWZ0ZXIgY3JlYXRpbmcgdGhlIGdsb2JhbCBzbyB0aGF0IGlmIGFuIEFNRCBtb2R1bGUgd2FudHMNCi8vIHRvIGNhbGwgbm9Db25mbGljdCB0byBoaWRlIHRoaXMgdmVyc2lvbiBvZiBqUXVlcnksIGl0IHdpbGwgd29yay4NCg0KLy8gTm90ZSB0aGF0IGZvciBtYXhpbXVtIHBvcnRhYmlsaXR5LCBsaWJyYXJpZXMgdGhhdCBhcmUgbm90IGpRdWVyeSBzaG91bGQNCi8vIGRlY2xhcmUgdGhlbXNlbHZlcyBhcyBhbm9ueW1vdXMgbW9kdWxlcywgYW5kIGF2b2lkIHNldHRpbmcgYSBnbG9iYWwgaWYgYW4NCi8vIEFNRCBsb2FkZXIgaXMgcHJlc2VudC4galF1ZXJ5IGlzIGEgc3BlY2lhbCBjYXNlLiBGb3IgbW9yZSBpbmZvcm1hdGlvbiwgc2VlDQovLyBodHRwczovL2dpdGh1Yi5jb20vanJidXJrZS9yZXF1aXJlanMvd2lraS9VcGRhdGluZy1leGlzdGluZy1saWJyYXJpZXMjd2lraS1hbm9uDQoNCmlmICggdHlwZW9mIGRlZmluZSA9PT0gImZ1bmN0aW9uIiAmJiBkZWZpbmUuYW1kICkgew0KCWRlZmluZSggImpxdWVyeSIsIFtdLCBmdW5jdGlvbigpIHsNCgkJcmV0dXJuIGpRdWVyeTsNCgl9ICk7DQp9DQoNCg0KDQoNCnZhcg0KDQoJLy8gTWFwIG92ZXIgalF1ZXJ5IGluIGNhc2Ugb2Ygb3ZlcndyaXRlDQoJX2pRdWVyeSA9IHdpbmRvdy5qUXVlcnksDQoNCgkvLyBNYXAgb3ZlciB0aGUgJCBpbiBjYXNlIG9mIG92ZXJ3cml0ZQ0KCV8kID0gd2luZG93LiQ7DQoNCmpRdWVyeS5ub0NvbmZsaWN0ID0gZnVuY3Rpb24oIGRlZXAgKSB7DQoJaWYgKCB3aW5kb3cuJCA9PT0galF1ZXJ5ICkgew0KCQl3aW5kb3cuJCA9IF8kOw0KCX0NCg0KCWlmICggZGVlcCAmJiB3aW5kb3cualF1ZXJ5ID09PSBqUXVlcnkgKSB7DQoJCXdpbmRvdy5qUXVlcnkgPSBfalF1ZXJ5Ow0KCX0NCg0KCXJldHVybiBqUXVlcnk7DQp9Ow0KDQovLyBFeHBvc2UgalF1ZXJ5IGFuZCAkIGlkZW50aWZpZXJzLCBldmVuIGluIEFNRA0KLy8gKCM3MTAyI2NvbW1lbnQ6MTAsIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5L3B1bGwvNTU3KQ0KLy8gYW5kIENvbW1vbkpTIGZvciBicm93c2VyIGVtdWxhdG9ycyAoIzEzNTY2KQ0KaWYgKCB0eXBlb2Ygbm9HbG9iYWwgPT09ICJ1bmRlZmluZWQiICkgew0KCXdpbmRvdy5qUXVlcnkgPSB3aW5kb3cuJCA9IGpRdWVyeTsNCn0NCg0KDQoNCg0KcmV0dXJuIGpRdWVyeTsNCn0gKTs=
- ID: "6954b7c7-2487-423f-8600-436cb3b6dc0e"
  Hint: Size
  Value: 299459
- ID: "6f47a0a5-9c94-4b48-abeb-42d38def6054"
  Hint: Mime Type
  Value: "application/x-javascript"
- ID: "c06867fe-9a43-4c7d-b739-48780492d06f"
  Hint: Extension
  Value: js
Languages:
- Language: en
  Versions:
  - Version: 1
    Fields:
    - ID: "25bed78c-4957-4165-998a-ca1b52f67497"
      Hint: __Created
      Value: 20211222T165753Z
    - ID: "52807595-0f8f-4b20-8d2a-cb71d28c6103"
      Hint: __Owner
      Value: |
        sitecore\jeetendra
    - ID: "5dd74568-4d4b-44c1-b513-0af5f4cda34f"
      Hint: __Created by
      Value: |
        sitecore\jeetendra
    - ID: "8cdc337e-a112-42fb-bbb4-4143751e123f"
      Hint: __Revision
      Value: "2c55b246-653d-4465-850f-5cb29ecb650f"
    - ID: "badd9cf9-53e0-4d0c-bcc0-2d784c282f6a"
      Hint: __Updated by
      Value: |
        sitecore\jeetendra
    - ID: "d9cf14b1-fa16-4ba6-9288-e8a174d4d522"
      Hint: __Updated
      Value: 20220106T064536Z
- Language: "fr-FR"
  Versions:
  - Version: 1
    Fields:
    - ID: "25bed78c-4957-4165-998a-ca1b52f67497"
      Hint: __Created
      Value: 20211222T165753Z
    - ID: "52807595-0f8f-4b20-8d2a-cb71d28c6103"
      Hint: __Owner
      Value: |
        sitecore\jeetendra
    - ID: "5dd74568-4d4b-44c1-b513-0af5f4cda34f"
      Hint: __Created by
      Value: |
        sitecore\jeetendra
    - ID: "8cdc337e-a112-42fb-bbb4-4143751e123f"
      Hint: __Revision
      Value: "796848ae-1334-4900-82ad-98cd8f05afd6"
    - ID: "badd9cf9-53e0-4d0c-bcc0-2d784c282f6a"
      Hint: __Updated by
      Value: |
        sitecore\jeetendra
    - ID: "d9cf14b1-fa16-4ba6-9288-e8a174d4d522"
      Hint: __Updated
      Value: 20211222T165753Z
